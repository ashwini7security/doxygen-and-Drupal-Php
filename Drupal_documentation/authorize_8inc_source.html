<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Shopcart: includes/authorize.inc Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Shopcart
   &#160;<span id="projectnumber">version2.0</span>
   </div>
   <div id="projectbrief">Shoppingcart</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_5b89693129504707d608c5412e7b88d4.html">includes</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">authorize.inc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="authorize_8inc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00017"></a><a class="code" href="group__forms_gac54653dcbe434c2a6519e228874bba30.html#gac54653dcbe434c2a6519e228874bba30">00017</a> <span class="keyword">function</span> <a class="code" href="group__forms_gac54653dcbe434c2a6519e228874bba30.html#gac54653dcbe434c2a6519e228874bba30" title="Form constructor for the file transfer authorization form.">authorize_filetransfer_form</a>($form, &amp;$form_state) {
<a name="l00018"></a>00018   global $base_url, $is_https;
<a name="l00019"></a>00019   $form = array();
<a name="l00020"></a>00020 
<a name="l00021"></a>00021   <span class="comment">// If possible, we want to post this form securely via https.</span>
<a name="l00022"></a>00022   $form[<span class="stringliteral">&#39;#https&#39;</span>] = TRUE;
<a name="l00023"></a>00023 
<a name="l00024"></a>00024   <span class="comment">// CSS we depend on lives in modules/system/maintenance.css, which is loaded</span>
<a name="l00025"></a>00025   <span class="comment">// via the default maintenance theme.</span>
<a name="l00026"></a>00026   $form[<span class="stringliteral">&#39;#attached&#39;</span>][<span class="stringliteral">&#39;js&#39;</span>][] = $base_url . <span class="stringliteral">&#39;/misc/authorize.js&#39;</span>;
<a name="l00027"></a>00027 
<a name="l00028"></a>00028   <span class="comment">// Get all the available ways to transfer files.</span>
<a name="l00029"></a>00029   <span class="keywordflow">if</span> (empty($_SESSION[<span class="stringliteral">&#39;authorize_filetransfer_info&#39;</span>])) {
<a name="l00030"></a>00030     <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Unable to continue, no available methods of file transfer&#39;</span>), <span class="stringliteral">&#39;error&#39;</span>);
<a name="l00031"></a>00031     <span class="keywordflow">return</span> array();
<a name="l00032"></a>00032   }
<a name="l00033"></a>00033   $available_backends = $_SESSION[<span class="stringliteral">&#39;authorize_filetransfer_info&#39;</span>];
<a name="l00034"></a>00034 
<a name="l00035"></a>00035   <span class="keywordflow">if</span> (!$is_https) {
<a name="l00036"></a>00036     $form[<span class="stringliteral">&#39;information&#39;</span>][<span class="stringliteral">&#39;https_warning&#39;</span>] = array(
<a name="l00037"></a>00037       <span class="stringliteral">&#39;#prefix&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;div class=&quot;messages error&quot;&gt;&#39;</span>,
<a name="l00038"></a>00038       <span class="stringliteral">&#39;#markup&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;WARNING: You are not using an encrypted connection, so your password will be sent in plain text. &lt;a href=&quot;@https-link&quot;&gt;Learn more&lt;/a&gt;.&#39;</span>, array(<span class="stringliteral">&#39;@https-link&#39;</span> =&gt; <span class="stringliteral">&#39;http://drupal.org/https-information&#39;</span>)),
<a name="l00039"></a>00039       <span class="stringliteral">&#39;#suffix&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>,
<a name="l00040"></a>00040     );
<a name="l00041"></a>00041   }
<a name="l00042"></a>00042 
<a name="l00043"></a>00043   <span class="comment">// Decide on a default backend.</span>
<a name="l00044"></a>00044   <span class="keywordflow">if</span> (isset($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;connection_settings&#39;</span>][<span class="stringliteral">&#39;authorize_filetransfer_default&#39;</span>])) {
<a name="l00045"></a>00045     $authorize_filetransfer_default = $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;connection_settings&#39;</span>][<span class="stringliteral">&#39;authorize_filetransfer_default&#39;</span>];
<a name="l00046"></a>00046   }
<a name="l00047"></a>00047   elseif ($authorize_filetransfer_default = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;authorize_filetransfer_default&#39;</span>, NULL));
<a name="l00048"></a>00048   <span class="keywordflow">else</span> {
<a name="l00049"></a>00049     $authorize_filetransfer_default = key($available_backends);
<a name="l00050"></a>00050   }
<a name="l00051"></a>00051 
<a name="l00052"></a>00052   $form[<span class="stringliteral">&#39;information&#39;</span>][<span class="stringliteral">&#39;main_header&#39;</span>] = array(
<a name="l00053"></a>00053     <span class="stringliteral">&#39;#prefix&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;h3&gt;&#39;</span>,
<a name="l00054"></a>00054     <span class="stringliteral">&#39;#markup&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;To continue, provide your server connection details&#39;</span>),
<a name="l00055"></a>00055     <span class="stringliteral">&#39;#suffix&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;/h3&gt;&#39;</span>,
<a name="l00056"></a>00056   );
<a name="l00057"></a>00057 
<a name="l00058"></a>00058   $form[<span class="stringliteral">&#39;connection_settings&#39;</span>][<span class="stringliteral">&#39;#tree&#39;</span>] = TRUE;
<a name="l00059"></a>00059   $form[<span class="stringliteral">&#39;connection_settings&#39;</span>][<span class="stringliteral">&#39;authorize_filetransfer_default&#39;</span>] = array(
<a name="l00060"></a>00060     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;select&#39;</span>,
<a name="l00061"></a>00061     <span class="stringliteral">&#39;#title&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Connection method&#39;</span>),
<a name="l00062"></a>00062     <span class="stringliteral">&#39;#default_value&#39;</span> =&gt; $authorize_filetransfer_default,
<a name="l00063"></a>00063     <span class="stringliteral">&#39;#weight&#39;</span> =&gt; -10,
<a name="l00064"></a>00064   );
<a name="l00065"></a>00065 
<a name="l00066"></a>00066   <span class="comment">/*</span>
<a name="l00067"></a>00067 <span class="comment">   * Here we create two submit buttons. For a JS enabled client, they will</span>
<a name="l00068"></a>00068 <span class="comment">   * only ever see submit_process. However, if a client doesn&#39;t have JS</span>
<a name="l00069"></a>00069 <span class="comment">   * enabled, they will see submit_connection on the first form (when picking</span>
<a name="l00070"></a>00070 <span class="comment">   * what filetransfer type to use, and submit_process on the second one (which</span>
<a name="l00071"></a>00071 <span class="comment">   * leads to the actual operation).</span>
<a name="l00072"></a>00072 <span class="comment">   */</span>
<a name="l00073"></a>00073   $form[<span class="stringliteral">&#39;submit_connection&#39;</span>] = array(
<a name="l00074"></a>00074     <span class="stringliteral">&#39;#prefix&#39;</span> =&gt; <span class="stringliteral">&quot;&lt;br style=&#39;clear:both&#39;/&gt;&quot;</span>,
<a name="l00075"></a>00075     <span class="stringliteral">&#39;#name&#39;</span> =&gt; <span class="stringliteral">&#39;enter_connection_settings&#39;</span>,
<a name="l00076"></a>00076     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;submit&#39;</span>,
<a name="l00077"></a>00077     <span class="stringliteral">&#39;#value&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Enter connection settings&#39;</span>),
<a name="l00078"></a>00078     <span class="stringliteral">&#39;#weight&#39;</span> =&gt; 100,
<a name="l00079"></a>00079   );
<a name="l00080"></a>00080 
<a name="l00081"></a>00081   $form[<span class="stringliteral">&#39;submit_process&#39;</span>] = array(
<a name="l00082"></a>00082     <span class="stringliteral">&#39;#name&#39;</span> =&gt; <span class="stringliteral">&#39;process_updates&#39;</span>,
<a name="l00083"></a>00083     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;submit&#39;</span>,
<a name="l00084"></a>00084     <span class="stringliteral">&#39;#value&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Continue&#39;</span>),
<a name="l00085"></a>00085     <span class="stringliteral">&#39;#weight&#39;</span> =&gt; 100,
<a name="l00086"></a>00086     <span class="stringliteral">&#39;#attributes&#39;</span> =&gt; array(<span class="stringliteral">&#39;style&#39;</span> =&gt; <span class="stringliteral">&#39;display:none&#39;</span>),
<a name="l00087"></a>00087   );
<a name="l00088"></a>00088 
<a name="l00089"></a>00089   <span class="comment">// Build a container for each connection type.</span>
<a name="l00090"></a>00090   <span class="keywordflow">foreach</span> ($available_backends as $name =&gt; $backend) {
<a name="l00091"></a>00091     $form[<span class="stringliteral">&#39;connection_settings&#39;</span>][<span class="stringliteral">&#39;authorize_filetransfer_default&#39;</span>][<span class="stringliteral">&#39;#options&#39;</span>][$name] = $backend[<span class="stringliteral">&#39;title&#39;</span>];
<a name="l00092"></a>00092     $form[<span class="stringliteral">&#39;connection_settings&#39;</span>][$name] = array(
<a name="l00093"></a>00093       <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;container&#39;</span>,
<a name="l00094"></a>00094       <span class="stringliteral">&#39;#attributes&#39;</span> =&gt; array(<span class="stringliteral">&#39;class&#39;</span> =&gt; array(<span class="stringliteral">&quot;filetransfer-$name&quot;</span>, <span class="stringliteral">&#39;filetransfer&#39;</span>)),
<a name="l00095"></a>00095     );
<a name="l00096"></a>00096     <span class="comment">// We can&#39;t use #prefix on the container itself since then the header won&#39;t</span>
<a name="l00097"></a>00097     <span class="comment">// be hidden and shown when the containers are being manipulated via JS.</span>
<a name="l00098"></a>00098     $form[<span class="stringliteral">&#39;connection_settings&#39;</span>][$name][<span class="stringliteral">&#39;header&#39;</span>] = array(
<a name="l00099"></a>00099       <span class="stringliteral">&#39;#markup&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;h4&gt;&#39;</span> . <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;@backend connection settings&#39;</span>, array(<span class="stringliteral">&#39;@backend&#39;</span> =&gt; $backend[<span class="stringliteral">&#39;title&#39;</span>])) . <span class="stringliteral">&#39;&lt;/h4&gt;&#39;</span>,
<a name="l00100"></a>00100     );
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     $form[<span class="stringliteral">&#39;connection_settings&#39;</span>][$name] += <a class="code" href="authorize_8inc_a63baffa11d7909bf853b5966fd558a88.html#a63baffa11d7909bf853b5966fd558a88" title="Generates the Form API array for a given connection backend&#39;s settings.">_authorize_filetransfer_connection_settings</a>($name);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104     <span class="comment">// Start non-JS code.</span>
<a name="l00105"></a>00105     <span class="keywordflow">if</span> (isset($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;connection_settings&#39;</span>][<span class="stringliteral">&#39;authorize_filetransfer_default&#39;</span>]) &amp;&amp; $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;connection_settings&#39;</span>][<span class="stringliteral">&#39;authorize_filetransfer_default&#39;</span>] == $name) {
<a name="l00106"></a>00106 
<a name="l00107"></a>00107       <span class="comment">// If the user switches from JS to non-JS, Drupal (and Batch API) will</span>
<a name="l00108"></a>00108       <span class="comment">// barf. This is a known bug: http://drupal.org/node/229825.</span>
<a name="l00109"></a>00109       setcookie(<span class="stringliteral">&#39;has_js&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, time() - 3600, <span class="charliteral">&#39;/&#39;</span>);
<a name="l00110"></a>00110       unset($_COOKIE[<span class="stringliteral">&#39;has_js&#39;</span>]);
<a name="l00111"></a>00111 
<a name="l00112"></a>00112       <span class="comment">// Change the submit button to the submit_process one.</span>
<a name="l00113"></a>00113       $form[<span class="stringliteral">&#39;submit_process&#39;</span>][<span class="stringliteral">&#39;#attributes&#39;</span>] = array();
<a name="l00114"></a>00114       unset($form[<span class="stringliteral">&#39;submit_connection&#39;</span>]);
<a name="l00115"></a>00115 
<a name="l00116"></a>00116       <span class="comment">// Activate the proper filetransfer settings form.</span>
<a name="l00117"></a>00117       $form[<span class="stringliteral">&#39;connection_settings&#39;</span>][$name][<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;style&#39;</span>] = <span class="stringliteral">&#39;display:block&#39;</span>;
<a name="l00118"></a>00118       <span class="comment">// Disable the select box.</span>
<a name="l00119"></a>00119       $form[<span class="stringliteral">&#39;connection_settings&#39;</span>][<span class="stringliteral">&#39;authorize_filetransfer_default&#39;</span>][<span class="stringliteral">&#39;#disabled&#39;</span>] = TRUE;
<a name="l00120"></a>00120 
<a name="l00121"></a>00121       <span class="comment">// Create a button for changing the type of connection.</span>
<a name="l00122"></a>00122       $form[<span class="stringliteral">&#39;connection_settings&#39;</span>][<span class="stringliteral">&#39;change_connection_type&#39;</span>] = array(
<a name="l00123"></a>00123         <span class="stringliteral">&#39;#name&#39;</span> =&gt; <span class="stringliteral">&#39;change_connection_type&#39;</span>,
<a name="l00124"></a>00124         <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;submit&#39;</span>,
<a name="l00125"></a>00125         <span class="stringliteral">&#39;#value&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Change connection type&#39;</span>),
<a name="l00126"></a>00126         <span class="stringliteral">&#39;#weight&#39;</span> =&gt; -5,
<a name="l00127"></a>00127         <span class="stringliteral">&#39;#attributes&#39;</span> =&gt; array(<span class="stringliteral">&#39;class&#39;</span> =&gt; array(<span class="stringliteral">&#39;filetransfer-change-connection-type&#39;</span>)),
<a name="l00128"></a>00128       );
<a name="l00129"></a>00129     }
<a name="l00130"></a>00130     <span class="comment">// End non-JS code.</span>
<a name="l00131"></a>00131   }
<a name="l00132"></a>00132   <span class="keywordflow">return</span> $form;
<a name="l00133"></a>00133 }
<a name="l00134"></a>00134 
<a name="l00146"></a><a class="code" href="authorize_8inc_a63baffa11d7909bf853b5966fd558a88.html#a63baffa11d7909bf853b5966fd558a88">00146</a> <span class="keyword">function</span> <a class="code" href="authorize_8inc_a63baffa11d7909bf853b5966fd558a88.html#a63baffa11d7909bf853b5966fd558a88" title="Generates the Form API array for a given connection backend&#39;s settings.">_authorize_filetransfer_connection_settings</a>($backend) {
<a name="l00147"></a>00147   $defaults = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;authorize_filetransfer_connection_settings_&#39;</span> . $backend, array());
<a name="l00148"></a>00148   $form = array();
<a name="l00149"></a>00149 
<a name="l00150"></a>00150   <span class="comment">// Create an instance of the file transfer class to get its settings form.</span>
<a name="l00151"></a>00151   $filetransfer = <a class="code" href="authorize_8inc_ae58f98088f7095a210ee0421586a9f7f.html#ae58f98088f7095a210ee0421586a9f7f" title="Gets a FileTransfer class for a specific transfer method and settings.">authorize_get_filetransfer</a>($backend);
<a name="l00152"></a>00152   <span class="keywordflow">if</span> ($filetransfer) {
<a name="l00153"></a>00153     $form = $filetransfer-&gt;getSettingsForm();
<a name="l00154"></a>00154   }
<a name="l00155"></a>00155   <span class="comment">// Fill in the defaults based on the saved settings, if any.</span>
<a name="l00156"></a>00156   <a class="code" href="authorize_8inc_a094fe7ec2c912ecbf8057ae67a1f7e89.html#a094fe7ec2c912ecbf8057ae67a1f7e89" title="Sets the default settings on a file transfer connection form recursively.">_authorize_filetransfer_connection_settings_set_defaults</a>($form, NULL, $defaults);
<a name="l00157"></a>00157   <span class="keywordflow">return</span> $form;
<a name="l00158"></a>00158 }
<a name="l00159"></a>00159 
<a name="l00176"></a><a class="code" href="authorize_8inc_a094fe7ec2c912ecbf8057ae67a1f7e89.html#a094fe7ec2c912ecbf8057ae67a1f7e89">00176</a> <span class="keyword">function</span> <a class="code" href="authorize_8inc_a094fe7ec2c912ecbf8057ae67a1f7e89.html#a094fe7ec2c912ecbf8057ae67a1f7e89" title="Sets the default settings on a file transfer connection form recursively.">_authorize_filetransfer_connection_settings_set_defaults</a>(&amp;$element, $key, array $defaults) {
<a name="l00177"></a>00177   <span class="comment">// If we&#39;re operating on a form element which isn&#39;t a fieldset, and we have</span>
<a name="l00178"></a>00178   <span class="comment">// a default setting saved, stash it in #default_value.</span>
<a name="l00179"></a>00179   <span class="keywordflow">if</span> (!empty($key) &amp;&amp; isset($defaults[$key]) &amp;&amp; isset($element[<span class="stringliteral">&#39;#type&#39;</span>]) &amp;&amp; $element[<span class="stringliteral">&#39;#type&#39;</span>] != <span class="stringliteral">&#39;fieldset&#39;</span>) {
<a name="l00180"></a>00180     $element[<span class="stringliteral">&#39;#default_value&#39;</span>] = $defaults[$key];
<a name="l00181"></a>00181   }
<a name="l00182"></a>00182   <span class="comment">// Now, we walk through all the child elements, and recursively invoke</span>
<a name="l00183"></a>00183   <span class="comment">// ourself on each one. Since the $defaults settings array can be nested</span>
<a name="l00184"></a>00184   <span class="comment">// (because of #tree, any values inside fieldsets will be nested), if</span>
<a name="l00185"></a>00185   <span class="comment">// there&#39;s a subarray of settings for the form key we&#39;re currently</span>
<a name="l00186"></a>00186   <span class="comment">// processing, pass in that subarray to the recursive call. Otherwise, just</span>
<a name="l00187"></a>00187   <span class="comment">// pass on the whole $defaults array.</span>
<a name="l00188"></a>00188   <span class="keywordflow">foreach</span> (<a class="code" href="common_8inc_ad38ed83e102f4f8c6c47e416543969bc.html#ad38ed83e102f4f8c6c47e416543969bc" title="Identifies the children of an element array, optionally sorted by weight.">element_children</a>($element) as $child_key) {
<a name="l00189"></a>00189     <a class="code" href="authorize_8inc_a094fe7ec2c912ecbf8057ae67a1f7e89.html#a094fe7ec2c912ecbf8057ae67a1f7e89" title="Sets the default settings on a file transfer connection form recursively.">_authorize_filetransfer_connection_settings_set_defaults</a>($element[$child_key], $child_key, ((isset($defaults[$key]) &amp;&amp; is_array($defaults[$key])) ? $defaults[$key] : $defaults));
<a name="l00190"></a>00190   }
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00199"></a><a class="code" href="authorize_8inc_a06e85bbdcebdfe243002736d6e0e7493.html#a06e85bbdcebdfe243002736d6e0e7493">00199</a> <span class="keyword">function</span> <a class="code" href="authorize_8inc_a06e85bbdcebdfe243002736d6e0e7493.html#a06e85bbdcebdfe243002736d6e0e7493" title="Form validation handler for authorize_filetransfer_form().">authorize_filetransfer_form_validate</a>($form, &amp;$form_state) {
<a name="l00200"></a>00200   <span class="comment">// Only validate the form if we have collected all of the user input and are</span>
<a name="l00201"></a>00201   <span class="comment">// ready to proceed with updating or installing.</span>
<a name="l00202"></a>00202   <span class="keywordflow">if</span> ($form_state[<span class="stringliteral">&#39;triggering_element&#39;</span>][<span class="stringliteral">&#39;#name&#39;</span>] != <span class="stringliteral">&#39;process_updates&#39;</span>) {
<a name="l00203"></a>00203     <span class="keywordflow">return</span>;
<a name="l00204"></a>00204   }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206   <span class="keywordflow">if</span> (isset($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;connection_settings&#39;</span>])) {
<a name="l00207"></a>00207     $backend = $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;connection_settings&#39;</span>][<span class="stringliteral">&#39;authorize_filetransfer_default&#39;</span>];
<a name="l00208"></a>00208     $filetransfer = <a class="code" href="authorize_8inc_ae58f98088f7095a210ee0421586a9f7f.html#ae58f98088f7095a210ee0421586a9f7f" title="Gets a FileTransfer class for a specific transfer method and settings.">authorize_get_filetransfer</a>($backend, $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;connection_settings&#39;</span>][$backend]);
<a name="l00209"></a>00209     <span class="keywordflow">try</span> {
<a name="l00210"></a>00210       <span class="keywordflow">if</span> (!$filetransfer) {
<a name="l00211"></a>00211         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Error, this type of connection protocol (%backend) does not exist.&#39;</span>, array(<span class="stringliteral">&#39;%backend&#39;</span> =&gt; $backend)));
<a name="l00212"></a>00212       }
<a name="l00213"></a>00213       $filetransfer-&gt;connect();
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215     <span class="keywordflow">catch</span> (<a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a> $e) {
<a name="l00216"></a>00216       <span class="comment">// The format of this error message is similar to that used on the</span>
<a name="l00217"></a>00217       <span class="comment">// database connection form in the installer.</span>
<a name="l00218"></a>00218       <a class="code" href="group__form__api_ga6f4ecbec42e905390e521b393417f97f.html#ga6f4ecbec42e905390e521b393417f97f" title="Files an error against a form element.">form_set_error</a>(<span class="stringliteral">&#39;connection_settings&#39;</span>, <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Failed to connect to the server. The server reports the following message: !message For more help installing or updating code on your server, see the &lt;a href=&quot;@handbook_url&quot;&gt;handbook&lt;/a&gt;.&#39;</span>, array(
<a name="l00219"></a>00219         <span class="stringliteral">&#39;!message&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;p class=&quot;error&quot;&gt;&#39;</span> . $e-&gt;getMessage()  . <span class="stringliteral">&#39;&lt;/p&gt;&#39;</span>,
<a name="l00220"></a>00220         <span class="stringliteral">&#39;@handbook_url&#39;</span> =&gt; <span class="stringliteral">&#39;http://drupal.org/documentation/install/modules-themes&#39;</span>,
<a name="l00221"></a>00221       )));
<a name="l00222"></a>00222     }
<a name="l00223"></a>00223   }
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00232"></a><a class="code" href="authorize_8inc_a228779582880d83c95a9bf56fae2e37c.html#a228779582880d83c95a9bf56fae2e37c">00232</a> <span class="keyword">function</span> <a class="code" href="authorize_8inc_a228779582880d83c95a9bf56fae2e37c.html#a228779582880d83c95a9bf56fae2e37c" title="Form submission handler for authorize_filetransfer_form().">authorize_filetransfer_form_submit</a>($form, &amp;$form_state) {
<a name="l00233"></a>00233   global $base_url;
<a name="l00234"></a>00234   <span class="keywordflow">switch</span> ($form_state[<span class="stringliteral">&#39;triggering_element&#39;</span>][<span class="stringliteral">&#39;#name&#39;</span>]) {
<a name="l00235"></a>00235     <span class="keywordflow">case</span> <span class="stringliteral">&#39;process_updates&#39;</span>:
<a name="l00236"></a>00236 
<a name="l00237"></a>00237       <span class="comment">// Save the connection settings to the DB.</span>
<a name="l00238"></a>00238       $filetransfer_backend = $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;connection_settings&#39;</span>][<span class="stringliteral">&#39;authorize_filetransfer_default&#39;</span>];
<a name="l00239"></a>00239 
<a name="l00240"></a>00240       <span class="comment">// If the database is available then try to save our settings. We have</span>
<a name="l00241"></a>00241       <span class="comment">// to make sure it is available since this code could potentially (will</span>
<a name="l00242"></a>00242       <span class="comment">// likely) be called during the installation process, before the</span>
<a name="l00243"></a>00243       <span class="comment">// database is set up.</span>
<a name="l00244"></a>00244       <span class="keywordflow">try</span> {
<a name="l00245"></a>00245         $connection_settings = array();
<a name="l00246"></a>00246         <span class="keywordflow">foreach</span> ($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;connection_settings&#39;</span>][$filetransfer_backend] as $key =&gt; $value) {
<a name="l00247"></a>00247           <span class="comment">// We do *not* want to store passwords in the database, unless the</span>
<a name="l00248"></a>00248           <span class="comment">// backend explicitly says so via the magic #filetransfer_save form</span>
<a name="l00249"></a>00249           <span class="comment">// property. Otherwise, we store everything that&#39;s not explicitly</span>
<a name="l00250"></a>00250           <span class="comment">// marked with #filetransfer_save set to FALSE.</span>
<a name="l00251"></a>00251           <span class="keywordflow">if</span> (!isset($form[<span class="stringliteral">&#39;connection_settings&#39;</span>][$filetransfer_backend][$key][<span class="stringliteral">&#39;#filetransfer_save&#39;</span>])) {
<a name="l00252"></a>00252             <span class="keywordflow">if</span> ($form[<span class="stringliteral">&#39;connection_settings&#39;</span>][$filetransfer_backend][$key][<span class="stringliteral">&#39;#type&#39;</span>] != <span class="stringliteral">&#39;password&#39;</span>) {
<a name="l00253"></a>00253               $connection_settings[$key] = $value;
<a name="l00254"></a>00254             }
<a name="l00255"></a>00255           }
<a name="l00256"></a>00256           <span class="comment">// The attribute is defined, so only save if set to TRUE.</span>
<a name="l00257"></a>00257           elseif ($form[<span class="stringliteral">&#39;connection_settings&#39;</span>][$filetransfer_backend][$key][<span class="stringliteral">&#39;#filetransfer_save&#39;</span>]) {
<a name="l00258"></a>00258             $connection_settings[$key] = $value;
<a name="l00259"></a>00259           }
<a name="l00260"></a>00260         }
<a name="l00261"></a>00261         <span class="comment">// Set this one as the default authorize method.</span>
<a name="l00262"></a>00262         <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;authorize_filetransfer_default&#39;</span>, $filetransfer_backend);
<a name="l00263"></a>00263         <span class="comment">// Save the connection settings minus the password.</span>
<a name="l00264"></a>00264         <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;authorize_filetransfer_connection_settings_&#39;</span> . $filetransfer_backend, $connection_settings);
<a name="l00265"></a>00265 
<a name="l00266"></a>00266         $filetransfer = <a class="code" href="authorize_8inc_ae58f98088f7095a210ee0421586a9f7f.html#ae58f98088f7095a210ee0421586a9f7f" title="Gets a FileTransfer class for a specific transfer method and settings.">authorize_get_filetransfer</a>($filetransfer_backend, $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;connection_settings&#39;</span>][$filetransfer_backend]);
<a name="l00267"></a>00267 
<a name="l00268"></a>00268         <span class="comment">// Now run the operation.</span>
<a name="l00269"></a>00269         <a class="code" href="authorize_8inc_aba5420b65b60431a0f845b7e09934ecd.html#aba5420b65b60431a0f845b7e09934ecd" title="Runs the operation specified in $_SESSION[&#39;authorize_operation&#39;].">authorize_run_operation</a>($filetransfer);
<a name="l00270"></a>00270       }
<a name="l00271"></a>00271       <span class="keywordflow">catch</span> (<a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a> $e) {
<a name="l00272"></a>00272         <span class="comment">// If there is no database available, we don&#39;t care and just skip</span>
<a name="l00273"></a>00273         <span class="comment">// this part entirely.</span>
<a name="l00274"></a>00274       }
<a name="l00275"></a>00275 
<a name="l00276"></a>00276       <span class="keywordflow">break</span>;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278     <span class="keywordflow">case</span> <span class="stringliteral">&#39;enter_connection_settings&#39;</span>:
<a name="l00279"></a>00279       $form_state[<span class="stringliteral">&#39;rebuild&#39;</span>] = TRUE;
<a name="l00280"></a>00280       <span class="keywordflow">break</span>;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="keywordflow">case</span> <span class="stringliteral">&#39;change_connection_type&#39;</span>:
<a name="l00283"></a>00283       $form_state[<span class="stringliteral">&#39;rebuild&#39;</span>] = TRUE;
<a name="l00284"></a>00284       unset($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;connection_settings&#39;</span>][<span class="stringliteral">&#39;authorize_filetransfer_default&#39;</span>]);
<a name="l00285"></a>00285       <span class="keywordflow">break</span>;
<a name="l00286"></a>00286   }
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00295"></a><a class="code" href="authorize_8inc_aba5420b65b60431a0f845b7e09934ecd.html#aba5420b65b60431a0f845b7e09934ecd">00295</a> <span class="keyword">function</span> <a class="code" href="authorize_8inc_aba5420b65b60431a0f845b7e09934ecd.html#aba5420b65b60431a0f845b7e09934ecd" title="Runs the operation specified in $_SESSION[&#39;authorize_operation&#39;].">authorize_run_operation</a>($filetransfer) {
<a name="l00296"></a>00296   $operation = $_SESSION[<span class="stringliteral">&#39;authorize_operation&#39;</span>];
<a name="l00297"></a>00297   unset($_SESSION[<span class="stringliteral">&#39;authorize_operation&#39;</span>]);
<a name="l00298"></a>00298 
<a name="l00299"></a>00299   <span class="keywordflow">if</span> (!empty($operation[<span class="stringliteral">&#39;page_title&#39;</span>])) {
<a name="l00300"></a>00300     <a class="code" href="bootstrap_8inc_a1994d49eb621df71fe1306e13b7e4910.html#a1994d49eb621df71fe1306e13b7e4910" title="Sets the title of the current page.">drupal_set_title</a>($operation[<span class="stringliteral">&#39;page_title&#39;</span>]);
<a name="l00301"></a>00301   }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="charliteral">&#39;/&#39;</span> . $operation[<span class="stringliteral">&#39;file&#39;</span>];
<a name="l00304"></a>00304   call_user_func_array($operation[<span class="stringliteral">&#39;callback&#39;</span>], array_merge(array($filetransfer), $operation[<span class="stringliteral">&#39;arguments&#39;</span>]));
<a name="l00305"></a>00305 }
<a name="l00306"></a>00306 
<a name="l00319"></a><a class="code" href="authorize_8inc_ae58f98088f7095a210ee0421586a9f7f.html#ae58f98088f7095a210ee0421586a9f7f">00319</a> <span class="keyword">function</span> <a class="code" href="authorize_8inc_ae58f98088f7095a210ee0421586a9f7f.html#ae58f98088f7095a210ee0421586a9f7f" title="Gets a FileTransfer class for a specific transfer method and settings.">authorize_get_filetransfer</a>($backend, $settings = array()) {
<a name="l00320"></a>00320   $filetransfer = FALSE;
<a name="l00321"></a>00321   <span class="keywordflow">if</span> (!empty($_SESSION[<span class="stringliteral">&#39;authorize_filetransfer_info&#39;</span>][$backend])) {
<a name="l00322"></a>00322     $backend_info = $_SESSION[<span class="stringliteral">&#39;authorize_filetransfer_info&#39;</span>][$backend];
<a name="l00323"></a>00323     <span class="keywordflow">if</span> (!empty($backend_info[<span class="stringliteral">&#39;file&#39;</span>])) {
<a name="l00324"></a>00324       $file = $backend_info[<span class="stringliteral">&#39;file path&#39;</span>] . <span class="charliteral">&#39;/&#39;</span> . $backend_info[<span class="stringliteral">&#39;file&#39;</span>];
<a name="l00325"></a>00325       require_once $file;
<a name="l00326"></a>00326     }
<a name="l00327"></a>00327     <span class="keywordflow">if</span> (class_exists($backend_info[<span class="stringliteral">&#39;class&#39;</span>])) {
<a name="l00328"></a>00328       <span class="comment">// PHP 5.2 doesn&#39;t support $class::factory() syntax, so we have to</span>
<a name="l00329"></a>00329       <span class="comment">// use call_user_func_array() until we can require PHP 5.3.</span>
<a name="l00330"></a>00330       $filetransfer = call_user_func_array(array($backend_info[<span class="stringliteral">&#39;class&#39;</span>], <span class="stringliteral">&#39;factory&#39;</span>), array(<a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a>, $settings));
<a name="l00331"></a>00331     }
<a name="l00332"></a>00332   }
<a name="l00333"></a>00333   <span class="keywordflow">return</span> $filetransfer;
<a name="l00334"></a>00334 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Thu Nov 22 2012 16:46:13 for Shopcart by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>

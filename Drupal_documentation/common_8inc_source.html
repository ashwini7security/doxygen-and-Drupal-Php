<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Shopcart: includes/common.inc Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Shopcart
   &#160;<span id="projectnumber">version2.0</span>
   </div>
   <div id="projectbrief">Shoppingcart</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_5b89693129504707d608c5412e7b88d4.html">includes</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">common.inc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="common_8inc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00045"></a><a class="code" href="common_8inc_a7d54df6ca81759341e08f451d4f6c8cd.html#a7d54df6ca81759341e08f451d4f6c8cd">00045</a> define(<span class="stringliteral">&#39;SAVED_NEW&#39;</span>, 1);
<a name="l00046"></a>00046 
<a name="l00050"></a><a class="code" href="common_8inc_a7daf0b68ef3b54562e9999ef017e28cb.html#a7daf0b68ef3b54562e9999ef017e28cb">00050</a> define(<span class="stringliteral">&#39;SAVED_UPDATED&#39;</span>, 2);
<a name="l00051"></a>00051 
<a name="l00055"></a><a class="code" href="common_8inc_a38f401ae5a8d3c2f0a06307fa001fff5.html#a38f401ae5a8d3c2f0a06307fa001fff5">00055</a> define(<span class="stringliteral">&#39;SAVED_DELETED&#39;</span>, 3);
<a name="l00056"></a>00056 
<a name="l00060"></a><a class="code" href="common_8inc_a4dcd70075399bbddb625fd93fa479e7f.html#a4dcd70075399bbddb625fd93fa479e7f">00060</a> define(<span class="stringliteral">&#39;CSS_SYSTEM&#39;</span>, -100);
<a name="l00061"></a>00061 
<a name="l00065"></a><a class="code" href="common_8inc_a6b8a843e5b9b3501472dc6efef34f36b.html#a6b8a843e5b9b3501472dc6efef34f36b">00065</a> define(<span class="stringliteral">&#39;CSS_DEFAULT&#39;</span>, 0);
<a name="l00066"></a>00066 
<a name="l00070"></a><a class="code" href="common_8inc_ad9e230079d79c5c4affbd4ce0b64b7d7.html#ad9e230079d79c5c4affbd4ce0b64b7d7">00070</a> define(<span class="stringliteral">&#39;CSS_THEME&#39;</span>, 100);
<a name="l00071"></a>00071 
<a name="l00075"></a><a class="code" href="common_8inc_a7efeab296e4345588b1279ec758e52b3.html#a7efeab296e4345588b1279ec758e52b3">00075</a> define(<span class="stringliteral">&#39;JS_LIBRARY&#39;</span>, -100);
<a name="l00076"></a>00076 
<a name="l00080"></a><a class="code" href="common_8inc_ade8dfc1503d597ba5ea4af975b0d8811.html#ade8dfc1503d597ba5ea4af975b0d8811">00080</a> define(<span class="stringliteral">&#39;JS_DEFAULT&#39;</span>, 0);
<a name="l00081"></a>00081 
<a name="l00085"></a><a class="code" href="common_8inc_a8d0998ffbec2cf7f8c2da3a80185fad2.html#a8d0998ffbec2cf7f8c2da3a80185fad2">00085</a> define(<span class="stringliteral">&#39;JS_THEME&#39;</span>, 100);
<a name="l00086"></a>00086 
<a name="l00092"></a><a class="code" href="common_8inc_a6b31bedd18943284b5b0c76022309167.html#a6b31bedd18943284b5b0c76022309167">00092</a> define(<span class="stringliteral">&#39;HTTP_REQUEST_TIMEOUT&#39;</span>, -1);
<a name="l00093"></a>00093 
<a name="l00121"></a><a class="code" href="common_8inc_a49931c05c761ec8deb074dde3eb6649c.html#a49931c05c761ec8deb074dde3eb6649c">00121</a> define(<span class="stringliteral">&#39;DRUPAL_NO_CACHE&#39;</span>, -1);
<a name="l00122"></a>00122 
<a name="l00130"></a><a class="code" href="common_8inc_aca17d982799dd205caa54b00e700db42.html#aca17d982799dd205caa54b00e700db42">00130</a> define(<span class="stringliteral">&#39;DRUPAL_CACHE_CUSTOM&#39;</span>, -2);
<a name="l00131"></a>00131 
<a name="l00138"></a><a class="code" href="common_8inc_a43d498e9607c4cdeb88d89341e0b3c3c.html#a43d498e9607c4cdeb88d89341e0b3c3c">00138</a> define(<span class="stringliteral">&#39;DRUPAL_CACHE_PER_ROLE&#39;</span>, 0x0001);
<a name="l00139"></a>00139 
<a name="l00146"></a><a class="code" href="common_8inc_aa50d399158badf0cda6ecbc3ff6707e9.html#aa50d399158badf0cda6ecbc3ff6707e9">00146</a> define(<span class="stringliteral">&#39;DRUPAL_CACHE_PER_USER&#39;</span>, 0x0002);
<a name="l00147"></a>00147 
<a name="l00151"></a><a class="code" href="common_8inc_af5ec7d2a686e7bf3be4cb308bdbe81cc.html#af5ec7d2a686e7bf3be4cb308bdbe81cc">00151</a> define(<span class="stringliteral">&#39;DRUPAL_CACHE_PER_PAGE&#39;</span>, 0x0004);
<a name="l00152"></a>00152 
<a name="l00156"></a><a class="code" href="common_8inc_ae81ef75e407d08488a85f2b396292ce2.html#ae81ef75e407d08488a85f2b396292ce2">00156</a> define(<span class="stringliteral">&#39;DRUPAL_CACHE_GLOBAL&#39;</span>, 0x0008);
<a name="l00157"></a>00157 
<a name="l00166"></a><a class="code" href="common_8inc_a868829276154d107ebf8a692a6ff7efa.html#a868829276154d107ebf8a692a6ff7efa">00166</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a868829276154d107ebf8a692a6ff7efa.html#a868829276154d107ebf8a692a6ff7efa" title="Adds content to a specified region.">drupal_add_region_content</a>($region = NULL, $data = NULL) {
<a name="l00167"></a>00167   <span class="keyword">static</span> $content = array();
<a name="l00168"></a>00168 
<a name="l00169"></a>00169   <span class="keywordflow">if</span> (isset($region) &amp;&amp; isset($data)) {
<a name="l00170"></a>00170     $content[$region][] = $data;
<a name="l00171"></a>00171   }
<a name="l00172"></a>00172   <span class="keywordflow">return</span> $content;
<a name="l00173"></a>00173 }
<a name="l00174"></a>00174 
<a name="l00184"></a><a class="code" href="common_8inc_a3e5f6ebc1abb928bf1634b6813f46dca.html#a3e5f6ebc1abb928bf1634b6813f46dca">00184</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a3e5f6ebc1abb928bf1634b6813f46dca.html#a3e5f6ebc1abb928bf1634b6813f46dca" title="Gets assigned content for a given region.">drupal_get_region_content</a>($region = NULL, $delimiter = <span class="charliteral">&#39; &#39;</span>) {
<a name="l00185"></a>00185   $content = <a class="code" href="common_8inc_a868829276154d107ebf8a692a6ff7efa.html#a868829276154d107ebf8a692a6ff7efa" title="Adds content to a specified region.">drupal_add_region_content</a>();
<a name="l00186"></a>00186   <span class="keywordflow">if</span> (isset($region)) {
<a name="l00187"></a>00187     <span class="keywordflow">if</span> (isset($content[$region]) &amp;&amp; is_array($content[$region])) {
<a name="l00188"></a>00188       <span class="keywordflow">return</span> implode($delimiter, $content[$region]);
<a name="l00189"></a>00189     }
<a name="l00190"></a>00190   }
<a name="l00191"></a>00191   <span class="keywordflow">else</span> {
<a name="l00192"></a>00192     <span class="keywordflow">foreach</span> (array_keys($content) as $region) {
<a name="l00193"></a>00193       <span class="keywordflow">if</span> (is_array($content[$region])) {
<a name="l00194"></a>00194         $content[$region] = implode($delimiter, $content[$region]);
<a name="l00195"></a>00195       }
<a name="l00196"></a>00196     }
<a name="l00197"></a>00197     <span class="keywordflow">return</span> $content;
<a name="l00198"></a>00198   }
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00213"></a><a class="code" href="common_8inc_a4128f0023ccec2d1a9a40987f0131d83.html#a4128f0023ccec2d1a9a40987f0131d83">00213</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a4128f0023ccec2d1a9a40987f0131d83.html#a4128f0023ccec2d1a9a40987f0131d83" title="Gets the name of the currently active install profile.">drupal_get_profile</a>() {
<a name="l00214"></a>00214   global $install_state;
<a name="l00215"></a>00215 
<a name="l00216"></a>00216   <span class="keywordflow">if</span> (isset($install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>])) {
<a name="l00217"></a>00217     $profile = $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>];
<a name="l00218"></a>00218   }
<a name="l00219"></a>00219   <span class="keywordflow">else</span> {
<a name="l00220"></a>00220     $profile = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;install_profile&#39;</span>, <span class="stringliteral">&#39;standard&#39;</span>);
<a name="l00221"></a>00221   }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223   <span class="keywordflow">return</span> $profile;
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00226"></a>00226 
<a name="l00234"></a><a class="code" href="common_8inc_a666113d06fa6ea461aff580e5c511eb0.html#a666113d06fa6ea461aff580e5c511eb0">00234</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a666113d06fa6ea461aff580e5c511eb0.html#a666113d06fa6ea461aff580e5c511eb0" title="Sets the breadcrumb trail for the current page.">drupal_set_breadcrumb</a>($breadcrumb = NULL) {
<a name="l00235"></a>00235   $stored_breadcrumb = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__);
<a name="l00236"></a>00236 
<a name="l00237"></a>00237   <span class="keywordflow">if</span> (isset($breadcrumb)) {
<a name="l00238"></a>00238     $stored_breadcrumb = $breadcrumb;
<a name="l00239"></a>00239   }
<a name="l00240"></a>00240   <span class="keywordflow">return</span> $stored_breadcrumb;
<a name="l00241"></a>00241 }
<a name="l00242"></a>00242 
<a name="l00246"></a><a class="code" href="common_8inc_af1e9626192d1d2e5e63b370e88c03c7c.html#af1e9626192d1d2e5e63b370e88c03c7c">00246</a> <span class="keyword">function</span> <a class="code" href="common_8inc_af1e9626192d1d2e5e63b370e88c03c7c.html#af1e9626192d1d2e5e63b370e88c03c7c" title="Gets the breadcrumb trail for the current page.">drupal_get_breadcrumb</a>() {
<a name="l00247"></a>00247   $breadcrumb = <a class="code" href="common_8inc_a666113d06fa6ea461aff580e5c511eb0.html#a666113d06fa6ea461aff580e5c511eb0" title="Sets the breadcrumb trail for the current page.">drupal_set_breadcrumb</a>();
<a name="l00248"></a>00248 
<a name="l00249"></a>00249   <span class="keywordflow">if</span> (!isset($breadcrumb)) {
<a name="l00250"></a>00250     $breadcrumb = <a class="code" href="group__menu_ga009731c4b3e736ebb620ba90e7f04207.html#ga009731c4b3e736ebb620ba90e7f04207" title="Get the breadcrumb for the current page, as determined by the active trail.">menu_get_active_breadcrumb</a>();
<a name="l00251"></a>00251   }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253   <span class="keywordflow">return</span> $breadcrumb;
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00260"></a><a class="code" href="common_8inc_aa9c5659618a108b2b031a4fd3438a420.html#aa9c5659618a108b2b031a4fd3438a420">00260</a> <span class="keyword">function</span> <a class="code" href="common_8inc_aa9c5659618a108b2b031a4fd3438a420.html#aa9c5659618a108b2b031a4fd3438a420" title="Returns a string containing RDF namespace declarations for use in XML and XHTML output.">drupal_get_rdf_namespaces</a>() {
<a name="l00261"></a>00261   $xml_rdf_namespaces = array();
<a name="l00262"></a>00262 
<a name="l00263"></a>00263   <span class="comment">// Serializes the RDF namespaces in XML namespace syntax.</span>
<a name="l00264"></a>00264   <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;rdf_get_namespaces&#39;</span>)) {
<a name="l00265"></a>00265     <span class="keywordflow">foreach</span> (rdf_get_namespaces() as $prefix =&gt; $uri) {
<a name="l00266"></a>00266       $xml_rdf_namespaces[] = <span class="stringliteral">&#39;xmlns:&#39;</span> . $prefix . <span class="stringliteral">&#39;=&quot;&#39;</span> . $uri . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l00267"></a>00267     }
<a name="l00268"></a>00268   }
<a name="l00269"></a>00269   <span class="keywordflow">return</span> count($xml_rdf_namespaces) ? <span class="stringliteral">&quot;\n  &quot;</span> . implode(<span class="stringliteral">&quot;\n  &quot;</span>, $xml_rdf_namespaces) : <span class="stringliteral">&#39;&#39;</span>;
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00290"></a><a class="code" href="common_8inc_a39eab16a83904b845fccc922a0c5c2cf.html#a39eab16a83904b845fccc922a0c5c2cf">00290</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a39eab16a83904b845fccc922a0c5c2cf.html#a39eab16a83904b845fccc922a0c5c2cf" title="Adds output to the HEAD tag of the HTML page.">drupal_add_html_head</a>($data = NULL, $key = NULL) {
<a name="l00291"></a>00291   $stored_head = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__);
<a name="l00292"></a>00292 
<a name="l00293"></a>00293   <span class="keywordflow">if</span> (!isset($stored_head)) {
<a name="l00294"></a>00294     <span class="comment">// Make sure the defaults, including Content-Type, come first.</span>
<a name="l00295"></a>00295     $stored_head = <a class="code" href="common_8inc_a140ce21f40afe048c44f2726045d9692.html#a140ce21f40afe048c44f2726045d9692" title="Returns elements that are always displayed in the HEAD tag of the HTML page.">_drupal_default_html_head</a>();
<a name="l00296"></a>00296   }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298   <span class="keywordflow">if</span> (isset($data) &amp;&amp; isset($key)) {
<a name="l00299"></a>00299     <span class="keywordflow">if</span> (!isset($data[<span class="stringliteral">&#39;#type&#39;</span>])) {
<a name="l00300"></a>00300       $data[<span class="stringliteral">&#39;#type&#39;</span>] = <span class="stringliteral">&#39;html_tag&#39;</span>;
<a name="l00301"></a>00301     }
<a name="l00302"></a>00302     $stored_head[$key] = $data;
<a name="l00303"></a>00303   }
<a name="l00304"></a>00304   <span class="keywordflow">return</span> $stored_head;
<a name="l00305"></a>00305 }
<a name="l00306"></a>00306 
<a name="l00310"></a><a class="code" href="common_8inc_a140ce21f40afe048c44f2726045d9692.html#a140ce21f40afe048c44f2726045d9692">00310</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a140ce21f40afe048c44f2726045d9692.html#a140ce21f40afe048c44f2726045d9692" title="Returns elements that are always displayed in the HEAD tag of the HTML page.">_drupal_default_html_head</a>() {
<a name="l00311"></a>00311   <span class="comment">// Add default elements. Make sure the Content-Type comes first because the</span>
<a name="l00312"></a>00312   <span class="comment">// IE browser may be vulnerable to XSS via encoding attacks from any content</span>
<a name="l00313"></a>00313   <span class="comment">// that comes before this META tag, such as a TITLE tag.</span>
<a name="l00314"></a>00314   $elements[<span class="stringliteral">&#39;system_meta_content_type&#39;</span>] = array(
<a name="l00315"></a>00315     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;html_tag&#39;</span>,
<a name="l00316"></a>00316     <span class="stringliteral">&#39;#tag&#39;</span> =&gt; <span class="stringliteral">&#39;meta&#39;</span>,
<a name="l00317"></a>00317     <span class="stringliteral">&#39;#attributes&#39;</span> =&gt; array(
<a name="l00318"></a>00318       <span class="stringliteral">&#39;http-equiv&#39;</span> =&gt; <span class="stringliteral">&#39;Content-Type&#39;</span>,
<a name="l00319"></a>00319       <span class="stringliteral">&#39;content&#39;</span> =&gt; <span class="stringliteral">&#39;text/html; charset=utf-8&#39;</span>,
<a name="l00320"></a>00320     ),
<a name="l00321"></a>00321     <span class="comment">// Security: This always has to be output first.</span>
<a name="l00322"></a>00322     <span class="stringliteral">&#39;#weight&#39;</span> =&gt; -1000,
<a name="l00323"></a>00323   );
<a name="l00324"></a>00324   <span class="comment">// Show Drupal and the major version number in the META GENERATOR tag.</span>
<a name="l00325"></a>00325   <span class="comment">// Get the major version.</span>
<a name="l00326"></a>00326   list($version, ) = explode(<span class="charliteral">&#39;.&#39;</span>, <a class="code" href="bootstrap_8inc_ae48ea820d6b3acc7353b763034c772af.html#ae48ea820d6b3acc7353b763034c772af" title="The current system version.">VERSION</a>);
<a name="l00327"></a>00327   $elements[<span class="stringliteral">&#39;system_meta_generator&#39;</span>] = array(
<a name="l00328"></a>00328     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;html_tag&#39;</span>,
<a name="l00329"></a>00329     <span class="stringliteral">&#39;#tag&#39;</span> =&gt; <span class="stringliteral">&#39;meta&#39;</span>,
<a name="l00330"></a>00330     <span class="stringliteral">&#39;#attributes&#39;</span> =&gt; array(
<a name="l00331"></a>00331       <span class="stringliteral">&#39;name&#39;</span> =&gt; <span class="stringliteral">&#39;Generator&#39;</span>,
<a name="l00332"></a>00332       <span class="stringliteral">&#39;content&#39;</span> =&gt; <span class="stringliteral">&#39;Drupal &#39;</span> . $version . <span class="stringliteral">&#39; (http://drupal.org)&#39;</span>,
<a name="l00333"></a>00333     ),
<a name="l00334"></a>00334   );
<a name="l00335"></a>00335   <span class="comment">// Also send the generator in the HTTP header.</span>
<a name="l00336"></a>00336   $elements[<span class="stringliteral">&#39;system_meta_generator&#39;</span>][<span class="stringliteral">&#39;#attached&#39;</span>][<span class="stringliteral">&#39;drupal_add_http_header&#39;</span>][] = array(<span class="stringliteral">&#39;X-Generator&#39;</span>, $elements[<span class="stringliteral">&#39;system_meta_generator&#39;</span>][<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;content&#39;</span>]);
<a name="l00337"></a>00337   <span class="keywordflow">return</span> $elements;
<a name="l00338"></a>00338 }
<a name="l00339"></a>00339 
<a name="l00343"></a><a class="code" href="common_8inc_acdee011d76859a5a9280209df1175188.html#acdee011d76859a5a9280209df1175188">00343</a> <span class="keyword">function</span> <a class="code" href="common_8inc_acdee011d76859a5a9280209df1175188.html#acdee011d76859a5a9280209df1175188" title="Retrieves output to be displayed in the HEAD tag of the HTML page.">drupal_get_html_head</a>() {
<a name="l00344"></a>00344   $elements = <a class="code" href="common_8inc_a39eab16a83904b845fccc922a0c5c2cf.html#a39eab16a83904b845fccc922a0c5c2cf" title="Adds output to the HEAD tag of the HTML page.">drupal_add_html_head</a>();
<a name="l00345"></a>00345   <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;html_head&#39;</span>, $elements);
<a name="l00346"></a>00346   <span class="keywordflow">return</span> <a class="code" href="common_8inc_a05798b44e8d6c496d4bee5cc32fa7851.html#a05798b44e8d6c496d4bee5cc32fa7851" title="Renders HTML given a structured array tree.">drupal_render</a>($elements);
<a name="l00347"></a>00347 }
<a name="l00348"></a>00348 
<a name="l00359"></a><a class="code" href="common_8inc_a42e1c8001e2609cb73a2f54f59e1020c.html#a42e1c8001e2609cb73a2f54f59e1020c">00359</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a42e1c8001e2609cb73a2f54f59e1020c.html#a42e1c8001e2609cb73a2f54f59e1020c" title="Adds a feed URL for the current page.">drupal_add_feed</a>($url = NULL, $title = <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00360"></a>00360   $stored_feed_links = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__, array());
<a name="l00361"></a>00361 
<a name="l00362"></a>00362   <span class="keywordflow">if</span> (isset($url)) {
<a name="l00363"></a>00363     $stored_feed_links[$url] = <a class="code" href="theme_8inc_a7c25609a935874541a19657affd30fff.html#a7c25609a935874541a19657affd30fff" title="Generates themed output.">theme</a>(<span class="stringliteral">&#39;feed_icon&#39;</span>, array(<span class="stringliteral">&#39;url&#39;</span> =&gt; $url, <span class="stringliteral">&#39;title&#39;</span> =&gt; $title));
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <a class="code" href="common_8inc_aad501b017775a67b155fe5e441f1ad9d.html#aad501b017775a67b155fe5e441f1ad9d" title="Adds a LINK tag with a distinct &#39;rel&#39; attribute to the page&#39;s HEAD.">drupal_add_html_head_link</a>(array(
<a name="l00366"></a>00366       <span class="stringliteral">&#39;rel&#39;</span> =&gt; <span class="stringliteral">&#39;alternate&#39;</span>,
<a name="l00367"></a>00367       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;application/rss+xml&#39;</span>,
<a name="l00368"></a>00368       <span class="stringliteral">&#39;title&#39;</span> =&gt; $title,
<a name="l00369"></a>00369       <span class="comment">// Force the URL to be absolute, for consistency with other &lt;link&gt; tags</span>
<a name="l00370"></a>00370       <span class="comment">// output by Drupal.</span>
<a name="l00371"></a>00371       <span class="stringliteral">&#39;href&#39;</span> =&gt; <a class="code" href="common_8inc_a43b2a0594431556db49df980801d8807.html#a43b2a0594431556db49df980801d8807" title="End of &quot;defgroup format&quot;.">url</a>($url, array(<span class="stringliteral">&#39;absolute&#39;</span> =&gt; TRUE)),
<a name="l00372"></a>00372     ));
<a name="l00373"></a>00373   }
<a name="l00374"></a>00374   <span class="keywordflow">return</span> $stored_feed_links;
<a name="l00375"></a>00375 }
<a name="l00376"></a>00376 
<a name="l00383"></a><a class="code" href="common_8inc_ac7df9703641369003434d49cf917c16e.html#ac7df9703641369003434d49cf917c16e">00383</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ac7df9703641369003434d49cf917c16e.html#ac7df9703641369003434d49cf917c16e" title="Gets the feed URLs for the current page.">drupal_get_feeds</a>($delimiter = <span class="stringliteral">&quot;\n&quot;</span>) {
<a name="l00384"></a>00384   $feeds = <a class="code" href="common_8inc_a42e1c8001e2609cb73a2f54f59e1020c.html#a42e1c8001e2609cb73a2f54f59e1020c" title="Adds a feed URL for the current page.">drupal_add_feed</a>();
<a name="l00385"></a>00385   <span class="keywordflow">return</span> implode($feeds, $delimiter);
<a name="l00386"></a>00386 }
<a name="l00387"></a>00387 
<a name="l00408"></a><a class="code" href="group__http__handling_ga2e632373cf469e513c0b6b7095f0e4dd.html#ga2e632373cf469e513c0b6b7095f0e4dd">00408</a> <span class="keyword">function</span> <a class="code" href="group__http__handling_ga2e632373cf469e513c0b6b7095f0e4dd.html#ga2e632373cf469e513c0b6b7095f0e4dd" title="Processes a URL query parameter array to remove unwanted elements.">drupal_get_query_parameters</a>(array $query = NULL, array $exclude = array(<span class="charliteral">&#39;q&#39;</span>), $parent = <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00409"></a>00409   <span class="comment">// Set defaults, if none given.</span>
<a name="l00410"></a>00410   <span class="keywordflow">if</span> (!isset($query)) {
<a name="l00411"></a>00411     $query = $_GET;
<a name="l00412"></a>00412   }
<a name="l00413"></a>00413   <span class="comment">// If $exclude is empty, there is nothing to filter.</span>
<a name="l00414"></a>00414   <span class="keywordflow">if</span> (empty($exclude)) {
<a name="l00415"></a>00415     <span class="keywordflow">return</span> $query;
<a name="l00416"></a>00416   }
<a name="l00417"></a>00417   elseif (!$parent) {
<a name="l00418"></a>00418     $exclude = array_flip($exclude);
<a name="l00419"></a>00419   }
<a name="l00420"></a>00420 
<a name="l00421"></a>00421   $params = array();
<a name="l00422"></a>00422   <span class="keywordflow">foreach</span> ($query as $key =&gt; $value) {
<a name="l00423"></a>00423     $string_key = ($parent ? $parent . <span class="charliteral">&#39;[&#39;</span> . $key . <span class="charliteral">&#39;]&#39;</span> : $key);
<a name="l00424"></a>00424     <span class="keywordflow">if</span> (isset($exclude[$string_key])) {
<a name="l00425"></a>00425       <span class="keywordflow">continue</span>;
<a name="l00426"></a>00426     }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     <span class="keywordflow">if</span> (is_array($value)) {
<a name="l00429"></a>00429       $params[$key] = <a class="code" href="group__http__handling_ga2e632373cf469e513c0b6b7095f0e4dd.html#ga2e632373cf469e513c0b6b7095f0e4dd" title="Processes a URL query parameter array to remove unwanted elements.">drupal_get_query_parameters</a>($value, $exclude, $string_key);
<a name="l00430"></a>00430     }
<a name="l00431"></a>00431     <span class="keywordflow">else</span> {
<a name="l00432"></a>00432       $params[$key] = $value;
<a name="l00433"></a>00433     }
<a name="l00434"></a>00434   }
<a name="l00435"></a>00435 
<a name="l00436"></a>00436   <span class="keywordflow">return</span> $params;
<a name="l00437"></a>00437 }
<a name="l00438"></a>00438 
<a name="l00448"></a><a class="code" href="group__http__handling_ga0ef58c019ee4bf4e1166e876f9721c12.html#ga0ef58c019ee4bf4e1166e876f9721c12">00448</a> <span class="keyword">function</span> <a class="code" href="group__http__handling_ga0ef58c019ee4bf4e1166e876f9721c12.html#ga0ef58c019ee4bf4e1166e876f9721c12" title="Splits a URL-encoded query string into an array.">drupal_get_query_array</a>($query) {
<a name="l00449"></a>00449   $result = array();
<a name="l00450"></a>00450   <span class="keywordflow">if</span> (!empty($query)) {
<a name="l00451"></a>00451     <span class="keywordflow">foreach</span> (explode(<span class="charliteral">&#39;&amp;&#39;</span>, $query) as $param) {
<a name="l00452"></a>00452       $param = explode(<span class="charliteral">&#39;=&#39;</span>, $param);
<a name="l00453"></a>00453       $result[$param[0]] = isset($param[1]) ? rawurldecode($param[1]) : <span class="stringliteral">&#39;&#39;</span>;
<a name="l00454"></a>00454     }
<a name="l00455"></a>00455   }
<a name="l00456"></a>00456   <span class="keywordflow">return</span> $result;
<a name="l00457"></a>00457 }
<a name="l00458"></a>00458 
<a name="l00477"></a><a class="code" href="group__php__wrappers_gada763092b76d70856870eb3afa2ad265.html#gada763092b76d70856870eb3afa2ad265">00477</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_gada763092b76d70856870eb3afa2ad265.html#gada763092b76d70856870eb3afa2ad265" title="Parses an array into a valid, rawurlencoded query string.">drupal_http_build_query</a>(array $query, $parent = <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00478"></a>00478   $params = array();
<a name="l00479"></a>00479 
<a name="l00480"></a>00480   <span class="keywordflow">foreach</span> ($query as $key =&gt; $value) {
<a name="l00481"></a>00481     $key = ($parent ? $parent . <span class="charliteral">&#39;[&#39;</span> . rawurlencode($key) . <span class="charliteral">&#39;]&#39;</span> : rawurlencode($key));
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     <span class="comment">// Recurse into children.</span>
<a name="l00484"></a>00484     <span class="keywordflow">if</span> (is_array($value)) {
<a name="l00485"></a>00485       $params[] = <a class="code" href="group__php__wrappers_gada763092b76d70856870eb3afa2ad265.html#gada763092b76d70856870eb3afa2ad265" title="Parses an array into a valid, rawurlencoded query string.">drupal_http_build_query</a>($value, $key);
<a name="l00486"></a>00486     }
<a name="l00487"></a>00487     <span class="comment">// If a query parameter value is NULL, only append its key.</span>
<a name="l00488"></a>00488     elseif (!isset($value)) {
<a name="l00489"></a>00489       $params[] = $key;
<a name="l00490"></a>00490     }
<a name="l00491"></a>00491     <span class="keywordflow">else</span> {
<a name="l00492"></a>00492       <span class="comment">// For better readability of paths in query strings, we decode slashes.</span>
<a name="l00493"></a>00493       $params[] = $key . <span class="charliteral">&#39;=&#39;</span> . str_replace(<span class="stringliteral">&#39;%2F&#39;</span>, <span class="charliteral">&#39;/&#39;</span>, rawurlencode($value));
<a name="l00494"></a>00494     }
<a name="l00495"></a>00495   }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497   <span class="keywordflow">return</span> implode(<span class="charliteral">&#39;&amp;&#39;</span>, $params);
<a name="l00498"></a>00498 }
<a name="l00499"></a>00499 
<a name="l00510"></a><a class="code" href="group__http__handling_ga0c95c16e75ac4df882686daccc1f8ac5.html#ga0c95c16e75ac4df882686daccc1f8ac5">00510</a> <span class="keyword">function</span> <a class="code" href="group__http__handling_ga0c95c16e75ac4df882686daccc1f8ac5.html#ga0c95c16e75ac4df882686daccc1f8ac5" title="Prepares a &#39;destination&#39; URL query parameter for use with drupal_goto().">drupal_get_destination</a>() {
<a name="l00511"></a>00511   $destination = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__);
<a name="l00512"></a>00512 
<a name="l00513"></a>00513   <span class="keywordflow">if</span> (isset($destination)) {
<a name="l00514"></a>00514     <span class="keywordflow">return</span> $destination;
<a name="l00515"></a>00515   }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517   <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;destination&#39;</span>])) {
<a name="l00518"></a>00518     $destination = array(<span class="stringliteral">&#39;destination&#39;</span> =&gt; $_GET[<span class="stringliteral">&#39;destination&#39;</span>]);
<a name="l00519"></a>00519   }
<a name="l00520"></a>00520   <span class="keywordflow">else</span> {
<a name="l00521"></a>00521     $path = $_GET[<span class="charliteral">&#39;q&#39;</span>];
<a name="l00522"></a>00522     $query = <a class="code" href="group__php__wrappers_gada763092b76d70856870eb3afa2ad265.html#gada763092b76d70856870eb3afa2ad265" title="Parses an array into a valid, rawurlencoded query string.">drupal_http_build_query</a>(<a class="code" href="group__http__handling_ga2e632373cf469e513c0b6b7095f0e4dd.html#ga2e632373cf469e513c0b6b7095f0e4dd" title="Processes a URL query parameter array to remove unwanted elements.">drupal_get_query_parameters</a>());
<a name="l00523"></a>00523     <span class="keywordflow">if</span> ($query != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00524"></a>00524       $path .= <span class="charliteral">&#39;?&#39;</span> . $query;
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526     $destination = array(<span class="stringliteral">&#39;destination&#39;</span> =&gt; $path);
<a name="l00527"></a>00527   }
<a name="l00528"></a>00528   <span class="keywordflow">return</span> $destination;
<a name="l00529"></a>00529 }
<a name="l00530"></a>00530 
<a name="l00565"></a><a class="code" href="group__php__wrappers_ga77e7930986edc614b20850a0a281609d.html#ga77e7930986edc614b20850a0a281609d">00565</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_ga77e7930986edc614b20850a0a281609d.html#ga77e7930986edc614b20850a0a281609d" title="Parses a system URL string into an associative array suitable for url().">drupal_parse_url</a>($url) {
<a name="l00566"></a>00566   $options = array(
<a name="l00567"></a>00567     <span class="stringliteral">&#39;path&#39;</span> =&gt; NULL,
<a name="l00568"></a>00568     <span class="stringliteral">&#39;query&#39;</span> =&gt; array(),
<a name="l00569"></a>00569     <span class="stringliteral">&#39;fragment&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00570"></a>00570   );
<a name="l00571"></a>00571 
<a name="l00572"></a>00572   <span class="comment">// External URLs: not using parse_url() here, so we do not have to rebuild</span>
<a name="l00573"></a>00573   <span class="comment">// the scheme, host, and path without having any use for it.</span>
<a name="l00574"></a>00574   <span class="keywordflow">if</span> (strpos($url, <span class="stringliteral">&#39;://&#39;</span>) !== FALSE) {
<a name="l00575"></a>00575     <span class="comment">// Split off everything before the query string into &#39;path&#39;.</span>
<a name="l00576"></a>00576     $parts = explode(<span class="charliteral">&#39;?&#39;</span>, $url);
<a name="l00577"></a>00577     $options[<span class="stringliteral">&#39;path&#39;</span>] = $parts[0];
<a name="l00578"></a>00578     <span class="comment">// If there is a query string, transform it into keyed query parameters.</span>
<a name="l00579"></a>00579     <span class="keywordflow">if</span> (isset($parts[1])) {
<a name="l00580"></a>00580       $query_parts = explode(<span class="charliteral">&#39;#&#39;</span>, $parts[1]);
<a name="l00581"></a>00581       parse_str($query_parts[0], $options[<span class="stringliteral">&#39;query&#39;</span>]);
<a name="l00582"></a>00582       <span class="comment">// Take over the fragment, if there is any.</span>
<a name="l00583"></a>00583       <span class="keywordflow">if</span> (isset($query_parts[1])) {
<a name="l00584"></a>00584         $options[<span class="stringliteral">&#39;fragment&#39;</span>] = $query_parts[1];
<a name="l00585"></a>00585       }
<a name="l00586"></a>00586     }
<a name="l00587"></a>00587   }
<a name="l00588"></a>00588   <span class="comment">// Internal URLs.</span>
<a name="l00589"></a>00589   <span class="keywordflow">else</span> {
<a name="l00590"></a>00590     <span class="comment">// parse_url() does not support relative URLs, so make it absolute. E.g. the</span>
<a name="l00591"></a>00591     <span class="comment">// relative URL &quot;foo/bar:1&quot; isn&#39;t properly parsed.</span>
<a name="l00592"></a>00592     $parts = parse_url(<span class="stringliteral">&#39;http://example.com/&#39;</span> . $url);
<a name="l00593"></a>00593     <span class="comment">// Strip the leading slash that was just added.</span>
<a name="l00594"></a>00594     $options[<span class="stringliteral">&#39;path&#39;</span>] = substr($parts[<span class="stringliteral">&#39;path&#39;</span>], 1);
<a name="l00595"></a>00595     <span class="keywordflow">if</span> (isset($parts[<span class="stringliteral">&#39;query&#39;</span>])) {
<a name="l00596"></a>00596       parse_str($parts[<span class="stringliteral">&#39;query&#39;</span>], $options[<span class="stringliteral">&#39;query&#39;</span>]);
<a name="l00597"></a>00597     }
<a name="l00598"></a>00598     <span class="keywordflow">if</span> (isset($parts[<span class="stringliteral">&#39;fragment&#39;</span>])) {
<a name="l00599"></a>00599       $options[<span class="stringliteral">&#39;fragment&#39;</span>] = $parts[<span class="stringliteral">&#39;fragment&#39;</span>];
<a name="l00600"></a>00600     }
<a name="l00601"></a>00601   }
<a name="l00602"></a>00602   <span class="comment">// The &#39;q&#39; parameter contains the path of the current page if clean URLs are</span>
<a name="l00603"></a>00603   <span class="comment">// disabled. It overrides the &#39;path&#39; of the URL when present, even if clean</span>
<a name="l00604"></a>00604   <span class="comment">// URLs are enabled, due to how Apache rewriting rules work.</span>
<a name="l00605"></a>00605   <span class="keywordflow">if</span> (isset($options[<span class="stringliteral">&#39;query&#39;</span>][<span class="charliteral">&#39;q&#39;</span>])) {
<a name="l00606"></a>00606     $options[<span class="stringliteral">&#39;path&#39;</span>] = $options[<span class="stringliteral">&#39;query&#39;</span>][<span class="charliteral">&#39;q&#39;</span>];
<a name="l00607"></a>00607     unset($options[<span class="stringliteral">&#39;query&#39;</span>][<span class="charliteral">&#39;q&#39;</span>]);
<a name="l00608"></a>00608   }
<a name="l00609"></a>00609 
<a name="l00610"></a>00610   <span class="keywordflow">return</span> $options;
<a name="l00611"></a>00611 }
<a name="l00612"></a>00612 
<a name="l00624"></a><a class="code" href="group__http__handling_gab333a51385bd4e339c464943553a6670.html#gab333a51385bd4e339c464943553a6670">00624</a> <span class="keyword">function</span> <a class="code" href="group__http__handling_gab333a51385bd4e339c464943553a6670.html#gab333a51385bd4e339c464943553a6670" title="Encodes a Drupal path for use in a URL.">drupal_encode_path</a>($path) {
<a name="l00625"></a>00625   <span class="keywordflow">return</span> str_replace(<span class="stringliteral">&#39;%2F&#39;</span>, <span class="charliteral">&#39;/&#39;</span>, rawurlencode($path));
<a name="l00626"></a>00626 }
<a name="l00627"></a>00627 
<a name="l00671"></a><a class="code" href="group__http__handling_ga5b68d7a934713d1d623b2b32a732235d.html#ga5b68d7a934713d1d623b2b32a732235d">00671</a> <span class="keyword">function</span> <a class="code" href="group__http__handling_ga5b68d7a934713d1d623b2b32a732235d.html#ga5b68d7a934713d1d623b2b32a732235d" title="Sends the user to a different Drupal page.">drupal_goto</a>($path = <span class="stringliteral">&#39;&#39;</span>, array $options = array(), $http_response_code = 302) {
<a name="l00672"></a>00672   <span class="comment">// A destination in $_GET always overrides the function arguments.</span>
<a name="l00673"></a>00673   <span class="comment">// We do not allow absolute URLs to be passed via $_GET, as this can be an attack vector.</span>
<a name="l00674"></a>00674   <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;destination&#39;</span>]) &amp;&amp; !<a class="code" href="common_8inc_a64a2003ba42a719fc38a046a3507ad56.html#a64a2003ba42a719fc38a046a3507ad56" title="Returns TRUE if a path is external to Drupal (e.g.">url_is_external</a>($_GET[<span class="stringliteral">&#39;destination&#39;</span>])) {
<a name="l00675"></a>00675     $destination = <a class="code" href="group__php__wrappers_ga77e7930986edc614b20850a0a281609d.html#ga77e7930986edc614b20850a0a281609d" title="Parses a system URL string into an associative array suitable for url().">drupal_parse_url</a>($_GET[<span class="stringliteral">&#39;destination&#39;</span>]);
<a name="l00676"></a>00676     $path = $destination[<span class="stringliteral">&#39;path&#39;</span>];
<a name="l00677"></a>00677     $options[<span class="stringliteral">&#39;query&#39;</span>] = $destination[<span class="stringliteral">&#39;query&#39;</span>];
<a name="l00678"></a>00678     $options[<span class="stringliteral">&#39;fragment&#39;</span>] = $destination[<span class="stringliteral">&#39;fragment&#39;</span>];
<a name="l00679"></a>00679   }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681   <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;drupal_goto&#39;</span>, $path, $options, $http_response_code);
<a name="l00682"></a>00682 
<a name="l00683"></a>00683   <span class="comment">// The &#39;Location&#39; HTTP header must be absolute.</span>
<a name="l00684"></a>00684   $options[<span class="stringliteral">&#39;absolute&#39;</span>] = TRUE;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686   $url = <a class="code" href="common_8inc_a43b2a0594431556db49df980801d8807.html#a43b2a0594431556db49df980801d8807" title="End of &quot;defgroup format&quot;.">url</a>($path, $options);
<a name="l00687"></a>00687 
<a name="l00688"></a>00688   header(<span class="stringliteral">&#39;Location: &#39;</span> . $url, TRUE, $http_response_code);
<a name="l00689"></a>00689 
<a name="l00690"></a>00690   <span class="comment">// The &quot;Location&quot; header sends a redirect status code to the HTTP daemon. In</span>
<a name="l00691"></a>00691   <span class="comment">// some cases this can be wrong, so we make sure none of the code below the</span>
<a name="l00692"></a>00692   <span class="comment">// drupal_goto() call gets executed upon redirection.</span>
<a name="l00693"></a>00693   <a class="code" href="common_8inc_abe82fff35edd9a4da0d3fe4ef1a95614.html#abe82fff35edd9a4da0d3fe4ef1a95614" title="Performs end-of-request tasks.">drupal_exit</a>($url);
<a name="l00694"></a>00694 }
<a name="l00695"></a>00695 
<a name="l00704"></a><a class="code" href="group__http__handling_gafc3a1915f45be2ac8666778eef0e9758.html#gafc3a1915f45be2ac8666778eef0e9758">00704</a> <span class="keyword">function</span> <a class="code" href="group__http__handling_gafc3a1915f45be2ac8666778eef0e9758.html#gafc3a1915f45be2ac8666778eef0e9758" title="Delivers a &quot;site is under maintenance&quot; message to the browser.">drupal_site_offline</a>() {
<a name="l00705"></a>00705   <a class="code" href="common_8inc_a1537b4ccc064fb7d8106effcac8caac3.html#a1537b4ccc064fb7d8106effcac8caac3" title="Delivers a page callback result to the browser in the appropriate format.">drupal_deliver_page</a>(<a class="code" href="group__menu__status__codes_gad6222551ed027f4f367e11b11935cff9.html#gad6222551ed027f4f367e11b11935cff9" title="Internal menu status code -- Menu item inaccessible because site is offline.">MENU_SITE_OFFLINE</a>);
<a name="l00706"></a>00706 }
<a name="l00707"></a>00707 
<a name="l00716"></a><a class="code" href="group__http__handling_ga52b08cd98e1756326c1bd5b56c39a884.html#ga52b08cd98e1756326c1bd5b56c39a884">00716</a> <span class="keyword">function</span> <a class="code" href="group__http__handling_ga52b08cd98e1756326c1bd5b56c39a884.html#ga52b08cd98e1756326c1bd5b56c39a884" title="Delivers a &quot;page not found&quot; error to the browser.">drupal_not_found</a>() {
<a name="l00717"></a>00717   <a class="code" href="common_8inc_a1537b4ccc064fb7d8106effcac8caac3.html#a1537b4ccc064fb7d8106effcac8caac3" title="Delivers a page callback result to the browser in the appropriate format.">drupal_deliver_page</a>(<a class="code" href="group__menu__status__codes_ga67a38f79c8ab91fb6230daaaad6176f4.html#ga67a38f79c8ab91fb6230daaaad6176f4" title="Internal menu status code -- Menu item was not found.">MENU_NOT_FOUND</a>);
<a name="l00718"></a>00718 }
<a name="l00719"></a>00719 
<a name="l00729"></a><a class="code" href="group__http__handling_ga0bbff371f9373002e71f2e1347fcf481.html#ga0bbff371f9373002e71f2e1347fcf481">00729</a> <span class="keyword">function</span> <a class="code" href="group__http__handling_ga0bbff371f9373002e71f2e1347fcf481.html#ga0bbff371f9373002e71f2e1347fcf481" title="Delivers an &quot;access denied&quot; error to the browser.">drupal_access_denied</a>() {
<a name="l00730"></a>00730   <a class="code" href="common_8inc_a1537b4ccc064fb7d8106effcac8caac3.html#a1537b4ccc064fb7d8106effcac8caac3" title="Delivers a page callback result to the browser in the appropriate format.">drupal_deliver_page</a>(<a class="code" href="group__menu__status__codes_ga87e8c6c6b42f3399cbe817d4d19cd892.html#ga87e8c6c6b42f3399cbe817d4d19cd892" title="Internal menu status code -- Menu item access is denied.">MENU_ACCESS_DENIED</a>);
<a name="l00731"></a>00731 }
<a name="l00732"></a>00732 
<a name="l00772"></a><a class="code" href="group__http__handling_gaad3affacd718b960300dcdddefa518aa.html#gaad3affacd718b960300dcdddefa518aa">00772</a> <span class="keyword">function</span> <a class="code" href="group__http__handling_gaad3affacd718b960300dcdddefa518aa.html#gaad3affacd718b960300dcdddefa518aa" title="Performs an HTTP request.">drupal_http_request</a>($url, array $options = array()) {
<a name="l00773"></a>00773   $result = <span class="keyword">new</span> stdClass();
<a name="l00774"></a>00774 
<a name="l00775"></a>00775   <span class="comment">// Parse the URL and make sure we can handle the schema.</span>
<a name="l00776"></a>00776   $uri = @parse_url($url);
<a name="l00777"></a>00777 
<a name="l00778"></a>00778   <span class="keywordflow">if</span> ($uri == FALSE) {
<a name="l00779"></a>00779     $result-&gt;error = <span class="stringliteral">&#39;unable to parse URL&#39;</span>;
<a name="l00780"></a>00780     $result-&gt;code = -1001;
<a name="l00781"></a>00781     <span class="keywordflow">return</span> $result;
<a name="l00782"></a>00782   }
<a name="l00783"></a>00783 
<a name="l00784"></a>00784   <span class="keywordflow">if</span> (!isset($uri[<span class="stringliteral">&#39;scheme&#39;</span>])) {
<a name="l00785"></a>00785     $result-&gt;error = <span class="stringliteral">&#39;missing schema&#39;</span>;
<a name="l00786"></a>00786     $result-&gt;code = -1002;
<a name="l00787"></a>00787     <span class="keywordflow">return</span> $result;
<a name="l00788"></a>00788   }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790   <a class="code" href="bootstrap_8inc_a0aaa023d3c72be50ab4ac3f7e1c989c0.html#a0aaa023d3c72be50ab4ac3f7e1c989c0" title="Starts the timer with the specified name.">timer_start</a>(__FUNCTION__);
<a name="l00791"></a>00791 
<a name="l00792"></a>00792   <span class="comment">// Merge the default options.</span>
<a name="l00793"></a>00793   $options += array(
<a name="l00794"></a>00794     <span class="stringliteral">&#39;headers&#39;</span> =&gt; array(),
<a name="l00795"></a>00795     <span class="stringliteral">&#39;method&#39;</span> =&gt; <span class="stringliteral">&#39;GET&#39;</span>,
<a name="l00796"></a>00796     <span class="stringliteral">&#39;data&#39;</span> =&gt; NULL,
<a name="l00797"></a>00797     <span class="stringliteral">&#39;max_redirects&#39;</span> =&gt; 3,
<a name="l00798"></a>00798     <span class="stringliteral">&#39;timeout&#39;</span> =&gt; 30.0,
<a name="l00799"></a>00799     <span class="stringliteral">&#39;context&#39;</span> =&gt; NULL,
<a name="l00800"></a>00800   );
<a name="l00801"></a>00801   <span class="comment">// stream_socket_client() requires timeout to be a float.</span>
<a name="l00802"></a>00802   $options[<span class="stringliteral">&#39;timeout&#39;</span>] = (float) $options[<span class="stringliteral">&#39;timeout&#39;</span>];
<a name="l00803"></a>00803 
<a name="l00804"></a>00804   <span class="keywordflow">switch</span> ($uri[<span class="stringliteral">&#39;scheme&#39;</span>]) {
<a name="l00805"></a>00805     <span class="keywordflow">case</span> <span class="stringliteral">&#39;http&#39;</span>:
<a name="l00806"></a>00806     <span class="keywordflow">case</span> <span class="stringliteral">&#39;feed&#39;</span>:
<a name="l00807"></a>00807       $port = isset($uri[<span class="stringliteral">&#39;port&#39;</span>]) ? $uri[<span class="stringliteral">&#39;port&#39;</span>] : 80;
<a name="l00808"></a>00808       $socket = <span class="stringliteral">&#39;tcp://&#39;</span> . $uri[<span class="stringliteral">&#39;host&#39;</span>] . <span class="charliteral">&#39;:&#39;</span> . $port;
<a name="l00809"></a>00809       <span class="comment">// RFC 2616: &quot;non-standard ports MUST, default ports MAY be included&quot;.</span>
<a name="l00810"></a>00810       <span class="comment">// We don&#39;t add the standard port to prevent from breaking rewrite rules</span>
<a name="l00811"></a>00811       <span class="comment">// checking the host that do not take into account the port number.</span>
<a name="l00812"></a>00812       $options[<span class="stringliteral">&#39;headers&#39;</span>][<span class="stringliteral">&#39;Host&#39;</span>] = $uri[<span class="stringliteral">&#39;host&#39;</span>] . ($port != 80 ? <span class="charliteral">&#39;:&#39;</span> . $port : <span class="stringliteral">&#39;&#39;</span>);
<a name="l00813"></a>00813       <span class="keywordflow">break</span>;
<a name="l00814"></a>00814     <span class="keywordflow">case</span> <span class="stringliteral">&#39;https&#39;</span>:
<a name="l00815"></a>00815       <span class="comment">// Note: Only works when PHP is compiled with OpenSSL support.</span>
<a name="l00816"></a>00816       $port = isset($uri[<span class="stringliteral">&#39;port&#39;</span>]) ? $uri[<span class="stringliteral">&#39;port&#39;</span>] : 443;
<a name="l00817"></a>00817       $socket = <span class="stringliteral">&#39;ssl://&#39;</span> . $uri[<span class="stringliteral">&#39;host&#39;</span>] . <span class="charliteral">&#39;:&#39;</span> . $port;
<a name="l00818"></a>00818       $options[<span class="stringliteral">&#39;headers&#39;</span>][<span class="stringliteral">&#39;Host&#39;</span>] = $uri[<span class="stringliteral">&#39;host&#39;</span>] . ($port != 443 ? <span class="charliteral">&#39;:&#39;</span> . $port : <span class="stringliteral">&#39;&#39;</span>);
<a name="l00819"></a>00819       <span class="keywordflow">break</span>;
<a name="l00820"></a>00820     <span class="keywordflow">default</span>:
<a name="l00821"></a>00821       $result-&gt;error = <span class="stringliteral">&#39;invalid schema &#39;</span> . $uri[<span class="stringliteral">&#39;scheme&#39;</span>];
<a name="l00822"></a>00822       $result-&gt;code = -1003;
<a name="l00823"></a>00823       <span class="keywordflow">return</span> $result;
<a name="l00824"></a>00824   }
<a name="l00825"></a>00825 
<a name="l00826"></a>00826   <span class="keywordflow">if</span> (empty($options[<span class="stringliteral">&#39;context&#39;</span>])) {
<a name="l00827"></a>00827     $fp = @stream_socket_client($socket, $errno, $errstr, $options[<span class="stringliteral">&#39;timeout&#39;</span>]);
<a name="l00828"></a>00828   }
<a name="l00829"></a>00829   <span class="keywordflow">else</span> {
<a name="l00830"></a>00830     <span class="comment">// Create a stream with context. Allows verification of a SSL certificate.</span>
<a name="l00831"></a>00831     $fp = @stream_socket_client($socket, $errno, $errstr, $options[<span class="stringliteral">&#39;timeout&#39;</span>], STREAM_CLIENT_CONNECT, $options[<span class="stringliteral">&#39;context&#39;</span>]);
<a name="l00832"></a>00832   }
<a name="l00833"></a>00833 
<a name="l00834"></a>00834   <span class="comment">// Make sure the socket opened properly.</span>
<a name="l00835"></a>00835   <span class="keywordflow">if</span> (!$fp) {
<a name="l00836"></a>00836     <span class="comment">// When a network error occurs, we use a negative number so it does not</span>
<a name="l00837"></a>00837     <span class="comment">// clash with the HTTP status codes.</span>
<a name="l00838"></a>00838     $result-&gt;code = -$errno;
<a name="l00839"></a>00839     $result-&gt;error = trim($errstr) ? trim($errstr) : <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Error opening socket @socket&#39;</span>, array(<span class="stringliteral">&#39;@socket&#39;</span> =&gt; $socket));
<a name="l00840"></a>00840 
<a name="l00841"></a>00841     <span class="comment">// Mark that this request failed. This will trigger a check of the web</span>
<a name="l00842"></a>00842     <span class="comment">// server&#39;s ability to make outgoing HTTP requests the next time that</span>
<a name="l00843"></a>00843     <span class="comment">// requirements checking is performed.</span>
<a name="l00844"></a>00844     <span class="comment">// See system_requirements().</span>
<a name="l00845"></a>00845     <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;drupal_http_request_fails&#39;</span>, TRUE);
<a name="l00846"></a>00846 
<a name="l00847"></a>00847     <span class="keywordflow">return</span> $result;
<a name="l00848"></a>00848   }
<a name="l00849"></a>00849 
<a name="l00850"></a>00850   <span class="comment">// Construct the path to act on.</span>
<a name="l00851"></a>00851   $path = isset($uri[<span class="stringliteral">&#39;path&#39;</span>]) ? $uri[<span class="stringliteral">&#39;path&#39;</span>] : <span class="charliteral">&#39;/&#39;</span>;
<a name="l00852"></a>00852   <span class="keywordflow">if</span> (isset($uri[<span class="stringliteral">&#39;query&#39;</span>])) {
<a name="l00853"></a>00853     $path .= <span class="charliteral">&#39;?&#39;</span> . $uri[<span class="stringliteral">&#39;query&#39;</span>];
<a name="l00854"></a>00854   }
<a name="l00855"></a>00855 
<a name="l00856"></a>00856   <span class="comment">// Merge the default headers.</span>
<a name="l00857"></a>00857   $options[<span class="stringliteral">&#39;headers&#39;</span>] += array(
<a name="l00858"></a>00858     <span class="stringliteral">&#39;User-Agent&#39;</span> =&gt; <span class="stringliteral">&#39;Drupal (+http://drupal.org/)&#39;</span>,
<a name="l00859"></a>00859   );
<a name="l00860"></a>00860 
<a name="l00861"></a>00861   <span class="comment">// Only add Content-Length if we actually have any content or if it is a POST</span>
<a name="l00862"></a>00862   <span class="comment">// or PUT request. Some non-standard servers get confused by Content-Length in</span>
<a name="l00863"></a>00863   <span class="comment">// at least HEAD/GET requests, and Squid always requires Content-Length in</span>
<a name="l00864"></a>00864   <span class="comment">// POST/PUT requests.</span>
<a name="l00865"></a>00865   $content_length = strlen($options[<span class="stringliteral">&#39;data&#39;</span>]);
<a name="l00866"></a>00866   <span class="keywordflow">if</span> ($content_length &gt; 0 || $options[<span class="stringliteral">&#39;method&#39;</span>] == <span class="stringliteral">&#39;POST&#39;</span> || $options[<span class="stringliteral">&#39;method&#39;</span>] == <span class="stringliteral">&#39;PUT&#39;</span>) {
<a name="l00867"></a>00867     $options[<span class="stringliteral">&#39;headers&#39;</span>][<span class="stringliteral">&#39;Content-Length&#39;</span>] = $content_length;
<a name="l00868"></a>00868   }
<a name="l00869"></a>00869 
<a name="l00870"></a>00870   <span class="comment">// If the server URL has a user then attempt to use basic authentication.</span>
<a name="l00871"></a>00871   <span class="keywordflow">if</span> (isset($uri[<span class="stringliteral">&#39;user&#39;</span>])) {
<a name="l00872"></a>00872     $options[<span class="stringliteral">&#39;headers&#39;</span>][<span class="stringliteral">&#39;Authorization&#39;</span>] = <span class="stringliteral">&#39;Basic &#39;</span> . base64_encode($uri[<span class="stringliteral">&#39;user&#39;</span>] . (isset($uri[<span class="stringliteral">&#39;pass&#39;</span>]) ? <span class="charliteral">&#39;:&#39;</span> . $uri[<span class="stringliteral">&#39;pass&#39;</span>] : <span class="stringliteral">&#39;&#39;</span>));
<a name="l00873"></a>00873   }
<a name="l00874"></a>00874 
<a name="l00875"></a>00875   <span class="comment">// If the database prefix is being used by SimpleTest to run the tests in a copied</span>
<a name="l00876"></a>00876   <span class="comment">// database then set the user-agent header to the database prefix so that any</span>
<a name="l00877"></a>00877   <span class="comment">// calls to other Drupal pages will run the SimpleTest prefixed database. The</span>
<a name="l00878"></a>00878   <span class="comment">// user-agent is used to ensure that multiple testing sessions running at the</span>
<a name="l00879"></a>00879   <span class="comment">// same time won&#39;t interfere with each other as they would if the database</span>
<a name="l00880"></a>00880   <span class="comment">// prefix were stored statically in a file or database variable.</span>
<a name="l00881"></a>00881   $test_info = &amp;$GLOBALS[<span class="stringliteral">&#39;drupal_test_info&#39;</span>];
<a name="l00882"></a>00882   <span class="keywordflow">if</span> (!empty($test_info[<span class="stringliteral">&#39;test_run_id&#39;</span>])) {
<a name="l00883"></a>00883     $options[<span class="stringliteral">&#39;headers&#39;</span>][<span class="stringliteral">&#39;User-Agent&#39;</span>] = <a class="code" href="bootstrap_8inc_a58a494e2753af5f55a59dae53ceab3ac.html#a58a494e2753af5f55a59dae53ceab3ac" title="Generates a user agent string with a HMAC and timestamp for simpletest.">drupal_generate_test_ua</a>($test_info[<span class="stringliteral">&#39;test_run_id&#39;</span>]);
<a name="l00884"></a>00884   }
<a name="l00885"></a>00885 
<a name="l00886"></a>00886   $request = $options[<span class="stringliteral">&#39;method&#39;</span>] . <span class="charliteral">&#39; &#39;</span> . $path . <span class="stringliteral">&quot; HTTP/1.0\r\n&quot;</span>;
<a name="l00887"></a>00887   <span class="keywordflow">foreach</span> ($options[<span class="stringliteral">&#39;headers&#39;</span>] as $name =&gt; $value) {
<a name="l00888"></a>00888     $request .= $name . <span class="stringliteral">&#39;: &#39;</span> . trim($value) . <span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l00889"></a>00889   }
<a name="l00890"></a>00890   $request .= <span class="stringliteral">&quot;\r\n&quot;</span> . $options[<span class="stringliteral">&#39;data&#39;</span>];
<a name="l00891"></a>00891   $result-&gt;request = $request;
<a name="l00892"></a>00892   <span class="comment">// Calculate how much time is left of the original timeout value.</span>
<a name="l00893"></a>00893   $timeout = $options[<span class="stringliteral">&#39;timeout&#39;</span>] - <a class="code" href="bootstrap_8inc_ad093007ebd04feb2a1394ff5774eb6d4.html#ad093007ebd04feb2a1394ff5774eb6d4" title="Reads the current timer value without stopping the timer.">timer_read</a>(__FUNCTION__) / 1000;
<a name="l00894"></a>00894   <span class="keywordflow">if</span> ($timeout &gt; 0) {
<a name="l00895"></a>00895     stream_set_timeout($fp, floor($timeout), floor(1000000 * fmod($timeout, 1)));
<a name="l00896"></a>00896     fwrite($fp, $request);
<a name="l00897"></a>00897   }
<a name="l00898"></a>00898 
<a name="l00899"></a>00899   <span class="comment">// Fetch response. Due to PHP bugs like http://bugs.php.net/bug.php?id=43782</span>
<a name="l00900"></a>00900   <span class="comment">// and http://bugs.php.net/bug.php?id=46049 we can&#39;t rely on feof(), but</span>
<a name="l00901"></a>00901   <span class="comment">// instead must invoke stream_get_meta_data() each iteration.</span>
<a name="l00902"></a>00902   $info = stream_get_meta_data($fp);
<a name="l00903"></a>00903   $alive = !$info[<span class="stringliteral">&#39;eof&#39;</span>] &amp;&amp; !$info[<span class="stringliteral">&#39;timed_out&#39;</span>];
<a name="l00904"></a>00904   $response = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00905"></a>00905 
<a name="l00906"></a>00906   <span class="keywordflow">while</span> ($alive) {
<a name="l00907"></a>00907     <span class="comment">// Calculate how much time is left of the original timeout value.</span>
<a name="l00908"></a>00908     $timeout = $options[<span class="stringliteral">&#39;timeout&#39;</span>] - <a class="code" href="bootstrap_8inc_ad093007ebd04feb2a1394ff5774eb6d4.html#ad093007ebd04feb2a1394ff5774eb6d4" title="Reads the current timer value without stopping the timer.">timer_read</a>(__FUNCTION__) / 1000;
<a name="l00909"></a>00909     <span class="keywordflow">if</span> ($timeout &lt;= 0) {
<a name="l00910"></a>00910       $info[<span class="stringliteral">&#39;timed_out&#39;</span>] = TRUE;
<a name="l00911"></a>00911       <span class="keywordflow">break</span>;
<a name="l00912"></a>00912     }
<a name="l00913"></a>00913     stream_set_timeout($fp, floor($timeout), floor(1000000 * fmod($timeout, 1)));
<a name="l00914"></a>00914     $chunk = fread($fp, 1024);
<a name="l00915"></a>00915     $response .= $chunk;
<a name="l00916"></a>00916     $info = stream_get_meta_data($fp);
<a name="l00917"></a>00917     $alive = !$info[<span class="stringliteral">&#39;eof&#39;</span>] &amp;&amp; !$info[<span class="stringliteral">&#39;timed_out&#39;</span>] &amp;&amp; $chunk;
<a name="l00918"></a>00918   }
<a name="l00919"></a>00919   fclose($fp);
<a name="l00920"></a>00920 
<a name="l00921"></a>00921   <span class="keywordflow">if</span> ($info[<span class="stringliteral">&#39;timed_out&#39;</span>]) {
<a name="l00922"></a>00922     $result-&gt;code = <a class="code" href="common_8inc_a6b31bedd18943284b5b0c76022309167.html#a6b31bedd18943284b5b0c76022309167" title="Error code indicating that the request exceeded the specified timeout.">HTTP_REQUEST_TIMEOUT</a>;
<a name="l00923"></a>00923     $result-&gt;error = <span class="stringliteral">&#39;request timed out&#39;</span>;
<a name="l00924"></a>00924     <span class="keywordflow">return</span> $result;
<a name="l00925"></a>00925   }
<a name="l00926"></a>00926   <span class="comment">// Parse response headers from the response body.</span>
<a name="l00927"></a>00927   <span class="comment">// Be tolerant of malformed HTTP responses that separate header and body with</span>
<a name="l00928"></a>00928   <span class="comment">// \n\n or \r\r instead of \r\n\r\n.</span>
<a name="l00929"></a>00929   list($response, $result-&gt;data) = preg_split(<span class="stringliteral">&quot;/\r\n\r\n|\n\n|\r\r/&quot;</span>, $response, 2);
<a name="l00930"></a>00930   $response = preg_split(<span class="stringliteral">&quot;/\r\n|\n|\r/&quot;</span>, $response);
<a name="l00931"></a>00931 
<a name="l00932"></a>00932   <span class="comment">// Parse the response status line.</span>
<a name="l00933"></a>00933   list($protocol, $code, $status_message) = explode(<span class="charliteral">&#39; &#39;</span>, trim(array_shift($response)), 3);
<a name="l00934"></a>00934   $result-&gt;protocol = $protocol;
<a name="l00935"></a>00935   $result-&gt;status_message = $status_message;
<a name="l00936"></a>00936 
<a name="l00937"></a>00937   $result-&gt;headers = array();
<a name="l00938"></a>00938 
<a name="l00939"></a>00939   <span class="comment">// Parse the response headers.</span>
<a name="l00940"></a>00940   <span class="keywordflow">while</span> ($line = trim(array_shift($response))) {
<a name="l00941"></a>00941     list($name, $value) = explode(<span class="charliteral">&#39;:&#39;</span>, $line, 2);
<a name="l00942"></a>00942     $name = strtolower($name);
<a name="l00943"></a>00943     <span class="keywordflow">if</span> (isset($result-&gt;headers[$name]) &amp;&amp; $name == <span class="stringliteral">&#39;set-cookie&#39;</span>) {
<a name="l00944"></a>00944       <span class="comment">// RFC 2109: the Set-Cookie response header comprises the token Set-</span>
<a name="l00945"></a>00945       <span class="comment">// Cookie:, followed by a comma-separated list of one or more cookies.</span>
<a name="l00946"></a>00946       $result-&gt;headers[$name] .= <span class="charliteral">&#39;,&#39;</span> . trim($value);
<a name="l00947"></a>00947     }
<a name="l00948"></a>00948     <span class="keywordflow">else</span> {
<a name="l00949"></a>00949       $result-&gt;headers[$name] = trim($value);
<a name="l00950"></a>00950     }
<a name="l00951"></a>00951   }
<a name="l00952"></a>00952 
<a name="l00953"></a>00953   $responses = array(
<a name="l00954"></a>00954     100 =&gt; <span class="stringliteral">&#39;Continue&#39;</span>,
<a name="l00955"></a>00955     101 =&gt; <span class="stringliteral">&#39;Switching Protocols&#39;</span>,
<a name="l00956"></a>00956     200 =&gt; <span class="stringliteral">&#39;OK&#39;</span>,
<a name="l00957"></a>00957     201 =&gt; <span class="stringliteral">&#39;Created&#39;</span>,
<a name="l00958"></a>00958     202 =&gt; <span class="stringliteral">&#39;Accepted&#39;</span>,
<a name="l00959"></a>00959     203 =&gt; <span class="stringliteral">&#39;Non-Authoritative Information&#39;</span>,
<a name="l00960"></a>00960     204 =&gt; <span class="stringliteral">&#39;No Content&#39;</span>,
<a name="l00961"></a>00961     205 =&gt; <span class="stringliteral">&#39;Reset Content&#39;</span>,
<a name="l00962"></a>00962     206 =&gt; <span class="stringliteral">&#39;Partial Content&#39;</span>,
<a name="l00963"></a>00963     300 =&gt; <span class="stringliteral">&#39;Multiple Choices&#39;</span>,
<a name="l00964"></a>00964     301 =&gt; <span class="stringliteral">&#39;Moved Permanently&#39;</span>,
<a name="l00965"></a>00965     302 =&gt; <span class="stringliteral">&#39;Found&#39;</span>,
<a name="l00966"></a>00966     303 =&gt; <span class="stringliteral">&#39;See Other&#39;</span>,
<a name="l00967"></a>00967     304 =&gt; <span class="stringliteral">&#39;Not Modified&#39;</span>,
<a name="l00968"></a>00968     305 =&gt; <span class="stringliteral">&#39;Use Proxy&#39;</span>,
<a name="l00969"></a>00969     307 =&gt; <span class="stringliteral">&#39;Temporary Redirect&#39;</span>,
<a name="l00970"></a>00970     400 =&gt; <span class="stringliteral">&#39;Bad Request&#39;</span>,
<a name="l00971"></a>00971     401 =&gt; <span class="stringliteral">&#39;Unauthorized&#39;</span>,
<a name="l00972"></a>00972     402 =&gt; <span class="stringliteral">&#39;Payment Required&#39;</span>,
<a name="l00973"></a>00973     403 =&gt; <span class="stringliteral">&#39;Forbidden&#39;</span>,
<a name="l00974"></a>00974     404 =&gt; <span class="stringliteral">&#39;Not Found&#39;</span>,
<a name="l00975"></a>00975     405 =&gt; <span class="stringliteral">&#39;Method Not Allowed&#39;</span>,
<a name="l00976"></a>00976     406 =&gt; <span class="stringliteral">&#39;Not Acceptable&#39;</span>,
<a name="l00977"></a>00977     407 =&gt; <span class="stringliteral">&#39;Proxy Authentication Required&#39;</span>,
<a name="l00978"></a>00978     408 =&gt; <span class="stringliteral">&#39;Request Time-out&#39;</span>,
<a name="l00979"></a>00979     409 =&gt; <span class="stringliteral">&#39;Conflict&#39;</span>,
<a name="l00980"></a>00980     410 =&gt; <span class="stringliteral">&#39;Gone&#39;</span>,
<a name="l00981"></a>00981     411 =&gt; <span class="stringliteral">&#39;Length Required&#39;</span>,
<a name="l00982"></a>00982     412 =&gt; <span class="stringliteral">&#39;Precondition Failed&#39;</span>,
<a name="l00983"></a>00983     413 =&gt; <span class="stringliteral">&#39;Request Entity Too Large&#39;</span>,
<a name="l00984"></a>00984     414 =&gt; <span class="stringliteral">&#39;Request-URI Too Large&#39;</span>,
<a name="l00985"></a>00985     415 =&gt; <span class="stringliteral">&#39;Unsupported Media Type&#39;</span>,
<a name="l00986"></a>00986     416 =&gt; <span class="stringliteral">&#39;Requested range not satisfiable&#39;</span>,
<a name="l00987"></a>00987     417 =&gt; <span class="stringliteral">&#39;Expectation Failed&#39;</span>,
<a name="l00988"></a>00988     500 =&gt; <span class="stringliteral">&#39;Internal Server Error&#39;</span>,
<a name="l00989"></a>00989     501 =&gt; <span class="stringliteral">&#39;Not Implemented&#39;</span>,
<a name="l00990"></a>00990     502 =&gt; <span class="stringliteral">&#39;Bad Gateway&#39;</span>,
<a name="l00991"></a>00991     503 =&gt; <span class="stringliteral">&#39;Service Unavailable&#39;</span>,
<a name="l00992"></a>00992     504 =&gt; <span class="stringliteral">&#39;Gateway Time-out&#39;</span>,
<a name="l00993"></a>00993     505 =&gt; <span class="stringliteral">&#39;HTTP Version not supported&#39;</span>,
<a name="l00994"></a>00994   );
<a name="l00995"></a>00995   <span class="comment">// RFC 2616 states that all unknown HTTP codes must be treated the same as the</span>
<a name="l00996"></a>00996   <span class="comment">// base code in their class.</span>
<a name="l00997"></a>00997   <span class="keywordflow">if</span> (!isset($responses[$code])) {
<a name="l00998"></a>00998     $code = floor($code / 100) * 100;
<a name="l00999"></a>00999   }
<a name="l01000"></a>01000   $result-&gt;code = $code;
<a name="l01001"></a>01001 
<a name="l01002"></a>01002   <span class="keywordflow">switch</span> ($code) {
<a name="l01003"></a>01003     <span class="keywordflow">case</span> 200: <span class="comment">// OK</span>
<a name="l01004"></a>01004     <span class="keywordflow">case</span> 304: <span class="comment">// Not modified</span>
<a name="l01005"></a>01005       <span class="keywordflow">break</span>;
<a name="l01006"></a>01006     <span class="keywordflow">case</span> 301: <span class="comment">// Moved permanently</span>
<a name="l01007"></a>01007     <span class="keywordflow">case</span> 302: <span class="comment">// Moved temporarily</span>
<a name="l01008"></a>01008     <span class="keywordflow">case</span> 307: <span class="comment">// Moved temporarily</span>
<a name="l01009"></a>01009       $location = $result-&gt;headers[<span class="stringliteral">&#39;location&#39;</span>];
<a name="l01010"></a>01010       $options[<span class="stringliteral">&#39;timeout&#39;</span>] -= <a class="code" href="bootstrap_8inc_ad093007ebd04feb2a1394ff5774eb6d4.html#ad093007ebd04feb2a1394ff5774eb6d4" title="Reads the current timer value without stopping the timer.">timer_read</a>(__FUNCTION__) / 1000;
<a name="l01011"></a>01011       <span class="keywordflow">if</span> ($options[<span class="stringliteral">&#39;timeout&#39;</span>] &lt;= 0) {
<a name="l01012"></a>01012         $result-&gt;code = <a class="code" href="common_8inc_a6b31bedd18943284b5b0c76022309167.html#a6b31bedd18943284b5b0c76022309167" title="Error code indicating that the request exceeded the specified timeout.">HTTP_REQUEST_TIMEOUT</a>;
<a name="l01013"></a>01013         $result-&gt;error = <span class="stringliteral">&#39;request timed out&#39;</span>;
<a name="l01014"></a>01014       }
<a name="l01015"></a>01015       elseif ($options[<span class="stringliteral">&#39;max_redirects&#39;</span>]) {
<a name="l01016"></a>01016         <span class="comment">// Redirect to the new location.</span>
<a name="l01017"></a>01017         $options[<span class="stringliteral">&#39;max_redirects&#39;</span>]--;
<a name="l01018"></a>01018         $result = <a class="code" href="group__http__handling_gaad3affacd718b960300dcdddefa518aa.html#gaad3affacd718b960300dcdddefa518aa" title="Performs an HTTP request.">drupal_http_request</a>($location, $options);
<a name="l01019"></a>01019         $result-&gt;redirect_code = $code;
<a name="l01020"></a>01020       }
<a name="l01021"></a>01021       <span class="keywordflow">if</span> (!isset($result-&gt;redirect_url)) {
<a name="l01022"></a>01022         $result-&gt;redirect_url = $location;
<a name="l01023"></a>01023       }
<a name="l01024"></a>01024       <span class="keywordflow">break</span>;
<a name="l01025"></a>01025     <span class="keywordflow">default</span>:
<a name="l01026"></a>01026       $result-&gt;error = $status_message;
<a name="l01027"></a>01027   }
<a name="l01028"></a>01028 
<a name="l01029"></a>01029   <span class="keywordflow">return</span> $result;
<a name="l01030"></a>01030 }
<a name="l01043"></a><a class="code" href="common_8inc_a4060ad61de80e6b8931ce8ad3c3aaebc.html#a4060ad61de80e6b8931ce8ad3c3aaebc">01043</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a4060ad61de80e6b8931ce8ad3c3aaebc.html#a4060ad61de80e6b8931ce8ad3c3aaebc" title="End of &quot;HTTP handling&quot;.">_fix_gpc_magic</a>(&amp;$item) {
<a name="l01044"></a>01044   <span class="keywordflow">if</span> (is_array($item)) {
<a name="l01045"></a>01045     array_walk($item, <span class="stringliteral">&#39;_fix_gpc_magic&#39;</span>);
<a name="l01046"></a>01046   }
<a name="l01047"></a>01047   <span class="keywordflow">else</span> {
<a name="l01048"></a>01048     $item = stripslashes($item);
<a name="l01049"></a>01049   }
<a name="l01050"></a>01050 }
<a name="l01051"></a>01051 
<a name="l01067"></a><a class="code" href="common_8inc_aca820a7438df9d2244148e4b8895291e.html#aca820a7438df9d2244148e4b8895291e">01067</a> <span class="keyword">function</span> <a class="code" href="common_8inc_aca820a7438df9d2244148e4b8895291e.html#aca820a7438df9d2244148e4b8895291e" title="Strips slashes from $_FILES items.">_fix_gpc_magic_files</a>(&amp;$item, $key) {
<a name="l01068"></a>01068   <span class="keywordflow">if</span> ($key != <span class="stringliteral">&#39;tmp_name&#39;</span>) {
<a name="l01069"></a>01069     <span class="keywordflow">if</span> (is_array($item)) {
<a name="l01070"></a>01070       array_walk($item, <span class="stringliteral">&#39;_fix_gpc_magic_files&#39;</span>);
<a name="l01071"></a>01071     }
<a name="l01072"></a>01072     <span class="keywordflow">else</span> {
<a name="l01073"></a>01073       $item = stripslashes($item);
<a name="l01074"></a>01074     }
<a name="l01075"></a>01075   }
<a name="l01076"></a>01076 }
<a name="l01077"></a>01077 
<a name="l01084"></a><a class="code" href="common_8inc_abefb935bf3c61840ba9ad50adb13f766.html#abefb935bf3c61840ba9ad50adb13f766">01084</a> <span class="keyword">function</span> <a class="code" href="common_8inc_abefb935bf3c61840ba9ad50adb13f766.html#abefb935bf3c61840ba9ad50adb13f766" title="Fixes double-escaping caused by &quot;magic quotes&quot; in some PHP installations.">fix_gpc_magic</a>() {
<a name="l01085"></a>01085   <span class="keyword">static</span> $fixed = FALSE;
<a name="l01086"></a>01086   <span class="keywordflow">if</span> (!$fixed &amp;&amp; ini_get(<span class="stringliteral">&#39;magic_quotes_gpc&#39;</span>)) {
<a name="l01087"></a>01087     array_walk($_GET, <span class="stringliteral">&#39;_fix_gpc_magic&#39;</span>);
<a name="l01088"></a>01088     array_walk($_POST, <span class="stringliteral">&#39;_fix_gpc_magic&#39;</span>);
<a name="l01089"></a>01089     array_walk($_COOKIE, <span class="stringliteral">&#39;_fix_gpc_magic&#39;</span>);
<a name="l01090"></a>01090     array_walk($_REQUEST, <span class="stringliteral">&#39;_fix_gpc_magic&#39;</span>);
<a name="l01091"></a>01091     array_walk($_FILES, <span class="stringliteral">&#39;_fix_gpc_magic_files&#39;</span>);
<a name="l01092"></a>01092   }
<a name="l01093"></a>01093   $fixed = TRUE;
<a name="l01094"></a>01094 }
<a name="l01095"></a>01095 
<a name="l01113"></a><a class="code" href="group__validation_ga486c51f034746a76618602e1e76fa718.html#ga486c51f034746a76618602e1e76fa718">01113</a> <span class="keyword">function</span> <a class="code" href="group__validation_ga486c51f034746a76618602e1e76fa718.html#ga486c51f034746a76618602e1e76fa718" title="Verifies the syntax of the given e-mail address.">valid_email_address</a>($mail) {
<a name="l01114"></a>01114   <span class="keywordflow">return</span> (<span class="keywordtype">bool</span>)filter_var($mail, FILTER_VALIDATE_EMAIL);
<a name="l01115"></a>01115 }
<a name="l01116"></a>01116 
<a name="l01131"></a><a class="code" href="group__validation_gae9221d1759a8d5a2ba2db93ae3a6feff.html#gae9221d1759a8d5a2ba2db93ae3a6feff">01131</a> <span class="keyword">function</span> <a class="code" href="group__validation_gae9221d1759a8d5a2ba2db93ae3a6feff.html#gae9221d1759a8d5a2ba2db93ae3a6feff" title="Verifies the syntax of the given URL.">valid_url</a>($url, $absolute = FALSE) {
<a name="l01132"></a>01132   <span class="keywordflow">if</span> ($absolute) {
<a name="l01133"></a>01133     <span class="keywordflow">return</span> (<span class="keywordtype">bool</span>)preg_match(<span class="stringliteral">&quot;</span>
<a name="l01134"></a>01134 <span class="stringliteral">      /^                                                      # Start at the beginning of the text</span>
<a name="l01135"></a>01135 <span class="stringliteral">      (?:ftp|https?|feed):\/\/                                # Look for ftp, http, https or feed schemes</span>
<a name="l01136"></a>01136 <span class="stringliteral">      (?:                                                     # Userinfo (optional) which is typically</span>
<a name="l01137"></a>01137 <span class="stringliteral">        (?:(?:[\w\.\-\+!$&amp;&#39;\(\)*\+,;=]|%[0-9a-f]{2})+:)*      # a username or a username and password</span>
<a name="l01138"></a>01138 <span class="stringliteral">        (?:[\w\.\-\+%!$&amp;&#39;\(\)*\+,;=]|%[0-9a-f]{2})+@          # combination</span>
<a name="l01139"></a>01139 <span class="stringliteral">      )?</span>
<a name="l01140"></a>01140 <span class="stringliteral">      (?:</span>
<a name="l01141"></a>01141 <span class="stringliteral">        (?:[a-z0-9\-\.]|%[0-9a-f]{2})+                        # A domain name or a IPv4 address</span>
<a name="l01142"></a>01142 <span class="stringliteral">        |(?:\[(?:[0-9a-f]{0,4}:)*(?:[0-9a-f]{0,4})\])         # or a well formed IPv6 address</span>
<a name="l01143"></a>01143 <span class="stringliteral">      )</span>
<a name="l01144"></a>01144 <span class="stringliteral">      (?::[0-9]+)?                                            # Server port number (optional)</span>
<a name="l01145"></a>01145 <span class="stringliteral">      (?:[\/|\?]</span>
<a name="l01146"></a>01146 <span class="stringliteral">        (?:[\w#!:\.\?\+=&amp;@$&#39;~*,;\/\(\)\[\]\-]|%[0-9a-f]{2})   # The path and query (optional)</span>
<a name="l01147"></a>01147 <span class="stringliteral">      *)?</span>
<a name="l01148"></a>01148 <span class="stringliteral">    $/xi&quot;</span>, $url);
<a name="l01149"></a>01149   }
<a name="l01150"></a>01150   <span class="keywordflow">else</span> {
<a name="l01151"></a>01151     <span class="keywordflow">return</span> (<span class="keywordtype">bool</span>)preg_match(<span class="stringliteral">&quot;/^(?:[\w#!:\.\?\+=&amp;@$&#39;~*,;\/\(\)\[\]\-]|%[0-9a-f]{2})+$/i&quot;</span>, $url);
<a name="l01152"></a>01152   }
<a name="l01153"></a>01153 }
<a name="l01154"></a>01154 
<a name="l01172"></a><a class="code" href="common_8inc_adb073363e7ad9091fc5f378988e4d019.html#adb073363e7ad9091fc5f378988e4d019">01172</a> <span class="keyword">function</span> <a class="code" href="common_8inc_adb073363e7ad9091fc5f378988e4d019.html#adb073363e7ad9091fc5f378988e4d019" title="End of &quot;defgroup validation&quot;.">flood_register_event</a>($name, $window = 3600, $identifier = NULL) {
<a name="l01173"></a>01173   <span class="keywordflow">if</span> (!isset($identifier)) {
<a name="l01174"></a>01174     $identifier = <a class="code" href="bootstrap_8inc_aec2f772317b4fb79cc696412c2e455c3.html#aec2f772317b4fb79cc696412c2e455c3" title="Returns the IP address of the client machine.">ip_address</a>();
<a name="l01175"></a>01175   }
<a name="l01176"></a>01176   <a class="code" href="group__database_gaadfbffaf30ff5eb14f1bd88619351345.html#gaadfbffaf30ff5eb14f1bd88619351345" title="Returns a new InsertQuery object for the active database.">db_insert</a>(<span class="stringliteral">&#39;flood&#39;</span>)
<a name="l01177"></a>01177     -&gt;fields(array(
<a name="l01178"></a>01178       <span class="stringliteral">&#39;event&#39;</span> =&gt; $name,
<a name="l01179"></a>01179       <span class="stringliteral">&#39;identifier&#39;</span> =&gt; $identifier,
<a name="l01180"></a>01180       <span class="stringliteral">&#39;timestamp&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a>,
<a name="l01181"></a>01181       <span class="stringliteral">&#39;expiration&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a> + $window,
<a name="l01182"></a>01182     ))
<a name="l01183"></a>01183     -&gt;execute();
<a name="l01184"></a>01184 }
<a name="l01185"></a>01185 
<a name="l01194"></a><a class="code" href="common_8inc_acf1b82b44af425575c6b1137e9b1e65a.html#acf1b82b44af425575c6b1137e9b1e65a">01194</a> <span class="keyword">function</span> <a class="code" href="common_8inc_acf1b82b44af425575c6b1137e9b1e65a.html#acf1b82b44af425575c6b1137e9b1e65a" title="Makes the flood control mechanism forget an event for the current visitor.">flood_clear_event</a>($name, $identifier = NULL) {
<a name="l01195"></a>01195   <span class="keywordflow">if</span> (!isset($identifier)) {
<a name="l01196"></a>01196     $identifier = <a class="code" href="bootstrap_8inc_aec2f772317b4fb79cc696412c2e455c3.html#aec2f772317b4fb79cc696412c2e455c3" title="Returns the IP address of the client machine.">ip_address</a>();
<a name="l01197"></a>01197   }
<a name="l01198"></a>01198   <a class="code" href="group__database_ga72f0ccecc0ba181de16c6e3451150f2c.html#ga72f0ccecc0ba181de16c6e3451150f2c" title="Returns a new DeleteQuery object for the active database.">db_delete</a>(<span class="stringliteral">&#39;flood&#39;</span>)
<a name="l01199"></a>01199     -&gt;condition(<span class="stringliteral">&#39;event&#39;</span>, $name)
<a name="l01200"></a>01200     -&gt;condition(<span class="stringliteral">&#39;identifier&#39;</span>, $identifier)
<a name="l01201"></a>01201     -&gt;execute();
<a name="l01202"></a>01202 }
<a name="l01203"></a>01203 
<a name="l01225"></a><a class="code" href="common_8inc_a4c6d4ab47d558e42ac08f5fbf90f2d6f.html#a4c6d4ab47d558e42ac08f5fbf90f2d6f">01225</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a4c6d4ab47d558e42ac08f5fbf90f2d6f.html#a4c6d4ab47d558e42ac08f5fbf90f2d6f" title="Checks whether a user is allowed to proceed with the specified event.">flood_is_allowed</a>($name, $threshold, $window = 3600, $identifier = NULL) {
<a name="l01226"></a>01226   <span class="keywordflow">if</span> (!isset($identifier)) {
<a name="l01227"></a>01227     $identifier = <a class="code" href="bootstrap_8inc_aec2f772317b4fb79cc696412c2e455c3.html#aec2f772317b4fb79cc696412c2e455c3" title="Returns the IP address of the client machine.">ip_address</a>();
<a name="l01228"></a>01228   }
<a name="l01229"></a>01229   $number = <a class="code" href="group__database_gafa3b6cb2b2f61479cc63a4150c62da9b.html#gafa3b6cb2b2f61479cc63a4150c62da9b" title="The following utility functions are simply convenience wrappers.">db_query</a>(<span class="stringliteral">&quot;SELECT COUNT(*) FROM {flood} WHERE event = :event AND identifier = :identifier AND timestamp &gt; :timestamp&quot;</span>, array(
<a name="l01230"></a>01230     <span class="stringliteral">&#39;:event&#39;</span> =&gt; $name,
<a name="l01231"></a>01231     <span class="stringliteral">&#39;:identifier&#39;</span> =&gt; $identifier,
<a name="l01232"></a>01232     <span class="stringliteral">&#39;:timestamp&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a> - $window))
<a name="l01233"></a>01233     -&gt;fetchField();
<a name="l01234"></a>01234   <span class="keywordflow">return</span> ($number &lt; $threshold);
<a name="l01235"></a>01235 }
<a name="l01236"></a>01236 
<a name="l01267"></a><a class="code" href="group__sanitization_ga46ff2822d576a77317f9045d65317b4f.html#ga46ff2822d576a77317f9045d65317b4f">01267</a> <span class="keyword">function</span> <a class="code" href="group__sanitization_ga46ff2822d576a77317f9045d65317b4f.html#ga46ff2822d576a77317f9045d65317b4f" title="Strips dangerous protocols (e.g.">drupal_strip_dangerous_protocols</a>($uri) {
<a name="l01268"></a>01268   <span class="keyword">static</span> $allowed_protocols;
<a name="l01269"></a>01269 
<a name="l01270"></a>01270   <span class="keywordflow">if</span> (!isset($allowed_protocols)) {
<a name="l01271"></a>01271     $allowed_protocols = array_flip(<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;filter_allowed_protocols&#39;</span>, array(<span class="stringliteral">&#39;ftp&#39;</span>, <span class="stringliteral">&#39;http&#39;</span>, <span class="stringliteral">&#39;https&#39;</span>, <span class="stringliteral">&#39;irc&#39;</span>, <span class="stringliteral">&#39;mailto&#39;</span>, <span class="stringliteral">&#39;news&#39;</span>, <span class="stringliteral">&#39;nntp&#39;</span>, <span class="stringliteral">&#39;rtsp&#39;</span>, <span class="stringliteral">&#39;sftp&#39;</span>, <span class="stringliteral">&#39;ssh&#39;</span>, <span class="stringliteral">&#39;tel&#39;</span>, <span class="stringliteral">&#39;telnet&#39;</span>, <span class="stringliteral">&#39;webcal&#39;</span>)));
<a name="l01272"></a>01272   }
<a name="l01273"></a>01273 
<a name="l01274"></a>01274   <span class="comment">// Iteratively remove any invalid protocol found.</span>
<a name="l01275"></a>01275   <span class="keywordflow">do</span> {
<a name="l01276"></a>01276     $before = $uri;
<a name="l01277"></a>01277     $colonpos = strpos($uri, <span class="charliteral">&#39;:&#39;</span>);
<a name="l01278"></a>01278     <span class="keywordflow">if</span> ($colonpos &gt; 0) {
<a name="l01279"></a>01279       <span class="comment">// We found a colon, possibly a protocol. Verify.</span>
<a name="l01280"></a>01280       $protocol = substr($uri, 0, $colonpos);
<a name="l01281"></a>01281       <span class="comment">// If a colon is preceded by a slash, question mark or hash, it cannot</span>
<a name="l01282"></a>01282       <span class="comment">// possibly be part of the URL scheme. This must be a relative URL, which</span>
<a name="l01283"></a>01283       <span class="comment">// inherits the (safe) protocol of the base document.</span>
<a name="l01284"></a>01284       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;![/?#]!&#39;</span>, $protocol)) {
<a name="l01285"></a>01285         <span class="keywordflow">break</span>;
<a name="l01286"></a>01286       }
<a name="l01287"></a>01287       <span class="comment">// Check if this is a disallowed protocol. Per RFC2616, section 3.2.3</span>
<a name="l01288"></a>01288       <span class="comment">// (URI Comparison) scheme comparison must be case-insensitive.</span>
<a name="l01289"></a>01289       <span class="keywordflow">if</span> (!isset($allowed_protocols[strtolower($protocol)])) {
<a name="l01290"></a>01290         $uri = substr($uri, $colonpos + 1);
<a name="l01291"></a>01291       }
<a name="l01292"></a>01292     }
<a name="l01293"></a>01293   } <span class="keywordflow">while</span> ($before != $uri);
<a name="l01294"></a>01294 
<a name="l01295"></a>01295   <span class="keywordflow">return</span> $uri;
<a name="l01296"></a>01296 }
<a name="l01297"></a>01297 
<a name="l01314"></a><a class="code" href="group__sanitization_gac024315b69035ef05c33674838707919.html#gac024315b69035ef05c33674838707919">01314</a> <span class="keyword">function</span> <a class="code" href="group__sanitization_gac024315b69035ef05c33674838707919.html#gac024315b69035ef05c33674838707919" title="Strips dangerous protocols from a URI and encodes it for output to HTML.">check_url</a>($uri) {
<a name="l01315"></a>01315   <span class="keywordflow">return</span> <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>(<a class="code" href="group__sanitization_ga46ff2822d576a77317f9045d65317b4f.html#ga46ff2822d576a77317f9045d65317b4f" title="Strips dangerous protocols (e.g.">drupal_strip_dangerous_protocols</a>($uri));
<a name="l01316"></a>01316 }
<a name="l01317"></a>01317 
<a name="l01328"></a><a class="code" href="group__sanitization_ga97dcceb77b76539219af2a85eacbe18d.html#ga97dcceb77b76539219af2a85eacbe18d">01328</a> <span class="keyword">function</span> <a class="code" href="group__sanitization_ga97dcceb77b76539219af2a85eacbe18d.html#ga97dcceb77b76539219af2a85eacbe18d" title="Applies a very permissive XSS/HTML filter for admin-only use.">filter_xss_admin</a>($string) {
<a name="l01329"></a>01329   <span class="keywordflow">return</span> <a class="code" href="group__sanitization_ga8864a29ffa8de5c9f8dc9e417060660d.html#ga8864a29ffa8de5c9f8dc9e417060660d" title="Filters HTML to prevent cross-site-scripting (XSS) vulnerabilities.">filter_xss</a>($string, array(<span class="charliteral">&#39;a&#39;</span>, <span class="stringliteral">&#39;abbr&#39;</span>, <span class="stringliteral">&#39;acronym&#39;</span>, <span class="stringliteral">&#39;address&#39;</span>, <span class="stringliteral">&#39;article&#39;</span>, <span class="stringliteral">&#39;aside&#39;</span>, <span class="charliteral">&#39;b&#39;</span>, <span class="stringliteral">&#39;bdi&#39;</span>, <span class="stringliteral">&#39;bdo&#39;</span>, <span class="stringliteral">&#39;big&#39;</span>, <span class="stringliteral">&#39;blockquote&#39;</span>, <span class="stringliteral">&#39;br&#39;</span>, <span class="stringliteral">&#39;caption&#39;</span>, <span class="stringliteral">&#39;cite&#39;</span>, <span class="stringliteral">&#39;code&#39;</span>, <span class="stringliteral">&#39;col&#39;</span>, <span class="stringliteral">&#39;colgroup&#39;</span>, <span class="stringliteral">&#39;command&#39;</span>, <span class="stringliteral">&#39;dd&#39;</span>, <span class="stringliteral">&#39;del&#39;</span>, <span class="stringliteral">&#39;details&#39;</span>, <span class="stringliteral">&#39;dfn&#39;</span>, <span class="stringliteral">&#39;div&#39;</span>, <span class="stringliteral">&#39;dl&#39;</span>, <span class="stringliteral">&#39;dt&#39;</span>, <span class="stringliteral">&#39;em&#39;</span>, <span class="stringliteral">&#39;figcaption&#39;</span>, <span class="stringliteral">&#39;figure&#39;</span>, <span class="stringliteral">&#39;footer&#39;</span>, <span class="stringliteral">&#39;h1&#39;</span>, <span class="stringliteral">&#39;h2&#39;</span>, <span class="stringliteral">&#39;h3&#39;</span>, <span class="stringliteral">&#39;h4&#39;</span>, <span class="stringliteral">&#39;h5&#39;</span>, <span class="stringliteral">&#39;h6&#39;</span>, <span class="stringliteral">&#39;header&#39;</span>, <span class="stringliteral">&#39;hgroup&#39;</span>, <span class="stringliteral">&#39;hr&#39;</span>, <span class="charliteral">&#39;i&#39;</span>, <span class="stringliteral">&#39;img&#39;</span>, <span class="stringliteral">&#39;ins&#39;</span>, <span class="stringliteral">&#39;kbd&#39;</span>, <span class="stringliteral">&#39;li&#39;</span>, <span class="stringliteral">&#39;mark&#39;</span>, <span class="stringliteral">&#39;menu&#39;</span>, <span class="stringliteral">&#39;meter&#39;</span>, <span class="stringliteral">&#39;nav&#39;</span>, <span class="stringliteral">&#39;ol&#39;</span>, <span class="stringliteral">&#39;output&#39;</span>, <span class="charliteral">&#39;p&#39;</span>, <span class="stringliteral">&#39;pre&#39;</span>, <span class="stringliteral">&#39;progress&#39;</span>, <span class="charliteral">&#39;q&#39;</span>, <span class="stringliteral">&#39;rp&#39;</span>, <span class="stringliteral">&#39;rt&#39;</span>, <span class="stringliteral">&#39;ruby&#39;</span>, <span class="charliteral">&#39;s&#39;</span>, <span class="stringliteral">&#39;samp&#39;</span>, <span class="stringliteral">&#39;section&#39;</span>, <span class="stringliteral">&#39;small&#39;</span>, <span class="stringliteral">&#39;span&#39;</span>, <span class="stringliteral">&#39;strong&#39;</span>, <span class="stringliteral">&#39;sub&#39;</span>, <span class="stringliteral">&#39;summary&#39;</span>, <span class="stringliteral">&#39;sup&#39;</span>, <span class="stringliteral">&#39;table&#39;</span>, <span class="stringliteral">&#39;tbody&#39;</span>, <span class="stringliteral">&#39;td&#39;</span>, <span class="stringliteral">&#39;tfoot&#39;</span>, <span class="stringliteral">&#39;th&#39;</span>, <span class="stringliteral">&#39;thead&#39;</span>, <span class="stringliteral">&#39;time&#39;</span>, <span class="stringliteral">&#39;tr&#39;</span>, <span class="stringliteral">&#39;tt&#39;</span>, <span class="charliteral">&#39;u&#39;</span>, <span class="stringliteral">&#39;ul&#39;</span>, <span class="stringliteral">&#39;var&#39;</span>, <span class="stringliteral">&#39;wbr&#39;</span>));
<a name="l01330"></a>01330 }
<a name="l01331"></a>01331 
<a name="l01358"></a><a class="code" href="group__sanitization_ga8864a29ffa8de5c9f8dc9e417060660d.html#ga8864a29ffa8de5c9f8dc9e417060660d">01358</a> <span class="keyword">function</span> <a class="code" href="group__sanitization_ga8864a29ffa8de5c9f8dc9e417060660d.html#ga8864a29ffa8de5c9f8dc9e417060660d" title="Filters HTML to prevent cross-site-scripting (XSS) vulnerabilities.">filter_xss</a>($string, $allowed_tags = array(<span class="charliteral">&#39;a&#39;</span>, <span class="stringliteral">&#39;em&#39;</span>, <span class="stringliteral">&#39;strong&#39;</span>, <span class="stringliteral">&#39;cite&#39;</span>, <span class="stringliteral">&#39;blockquote&#39;</span>, <span class="stringliteral">&#39;code&#39;</span>, <span class="stringliteral">&#39;ul&#39;</span>, <span class="stringliteral">&#39;ol&#39;</span>, <span class="stringliteral">&#39;li&#39;</span>, <span class="stringliteral">&#39;dl&#39;</span>, <span class="stringliteral">&#39;dt&#39;</span>, <span class="stringliteral">&#39;dd&#39;</span>)) {
<a name="l01359"></a>01359   <span class="comment">// Only operate on valid UTF-8 strings. This is necessary to prevent cross</span>
<a name="l01360"></a>01360   <span class="comment">// site scripting issues on Internet Explorer 6.</span>
<a name="l01361"></a>01361   <span class="keywordflow">if</span> (!<a class="code" href="bootstrap_8inc_abf62947a33393477301b0070b1ff0c7a.html#abf62947a33393477301b0070b1ff0c7a" title="Checks whether a string is valid UTF-8.">drupal_validate_utf8</a>($string)) {
<a name="l01362"></a>01362     <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l01363"></a>01363   }
<a name="l01364"></a>01364   <span class="comment">// Store the text format.</span>
<a name="l01365"></a>01365   <a class="code" href="group__sanitization_ga1cc6cca885f021adcf11970b8ec4c846.html#ga1cc6cca885f021adcf11970b8ec4c846" title="Processes an HTML tag.">_filter_xss_split</a>($allowed_tags, TRUE);
<a name="l01366"></a>01366   <span class="comment">// Remove NULL characters (ignored by some browsers).</span>
<a name="l01367"></a>01367   $string = str_replace(chr(0), <span class="stringliteral">&#39;&#39;</span>, $string);
<a name="l01368"></a>01368   <span class="comment">// Remove Netscape 4 JS entities.</span>
<a name="l01369"></a>01369   $string = preg_replace(<span class="stringliteral">&#39;%&amp;\s*\{[^}]*(\}\s*;?|$)%&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $string);
<a name="l01370"></a>01370 
<a name="l01371"></a>01371   <span class="comment">// Defuse all HTML entities.</span>
<a name="l01372"></a>01372   $string = str_replace(<span class="charliteral">&#39;&amp;&#39;</span>, <span class="stringliteral">&#39;&amp;amp;&#39;</span>, $string);
<a name="l01373"></a>01373   <span class="comment">// Change back only well-formed entities in our whitelist:</span>
<a name="l01374"></a>01374   <span class="comment">// Decimal numeric entities.</span>
<a name="l01375"></a>01375   $string = preg_replace(<span class="stringliteral">&#39;/&amp;amp;#([0-9]+;)/&#39;</span>, <span class="stringliteral">&#39;&amp;#\1&#39;</span>, $string);
<a name="l01376"></a>01376   <span class="comment">// Hexadecimal numeric entities.</span>
<a name="l01377"></a>01377   $string = preg_replace(<span class="stringliteral">&#39;/&amp;amp;#[Xx]0*((?:[0-9A-Fa-f]{2})+;)/&#39;</span>, <span class="stringliteral">&#39;&amp;#x\1&#39;</span>, $string);
<a name="l01378"></a>01378   <span class="comment">// Named entities.</span>
<a name="l01379"></a>01379   $string = preg_replace(<span class="stringliteral">&#39;/&amp;amp;([A-Za-z][A-Za-z0-9]*;)/&#39;</span>, <span class="stringliteral">&#39;&amp;\1&#39;</span>, $string);
<a name="l01380"></a>01380 
<a name="l01381"></a>01381   <span class="keywordflow">return</span> preg_replace_callback(<span class="stringliteral">&#39;%</span>
<a name="l01382"></a>01382 <span class="stringliteral">    (</span>
<a name="l01383"></a>01383 <span class="stringliteral">    &lt;(?=[^a-zA-Z!/])  # a lone &lt;</span>
<a name="l01384"></a>01384 <span class="stringliteral">    |                 # or</span>
<a name="l01385"></a>01385 <span class="stringliteral">    &lt;!--.*?--&gt;        # a comment</span>
<a name="l01386"></a>01386 <span class="stringliteral">    |                 # or</span>
<a name="l01387"></a>01387 <span class="stringliteral">    &lt;[^&gt;]*(&gt;|$)       # a string that starts with a &lt;, up until the &gt; or the end of the string</span>
<a name="l01388"></a>01388 <span class="stringliteral">    |                 # or</span>
<a name="l01389"></a>01389 <span class="stringliteral">    &gt;                 # just a &gt;</span>
<a name="l01390"></a>01390 <span class="stringliteral">    )%x&#39;</span>, <span class="stringliteral">&#39;_filter_xss_split&#39;</span>, $string);
<a name="l01391"></a>01391 }
<a name="l01392"></a>01392 
<a name="l01407"></a><a class="code" href="group__sanitization_ga1cc6cca885f021adcf11970b8ec4c846.html#ga1cc6cca885f021adcf11970b8ec4c846">01407</a> <span class="keyword">function</span> <a class="code" href="group__sanitization_ga1cc6cca885f021adcf11970b8ec4c846.html#ga1cc6cca885f021adcf11970b8ec4c846" title="Processes an HTML tag.">_filter_xss_split</a>($m, $store = FALSE) {
<a name="l01408"></a>01408   <span class="keyword">static</span> $allowed_html;
<a name="l01409"></a>01409 
<a name="l01410"></a>01410   <span class="keywordflow">if</span> ($store) {
<a name="l01411"></a>01411     $allowed_html = array_flip($m);
<a name="l01412"></a>01412     <span class="keywordflow">return</span>;
<a name="l01413"></a>01413   }
<a name="l01414"></a>01414 
<a name="l01415"></a>01415   $string = $m[1];
<a name="l01416"></a>01416 
<a name="l01417"></a>01417   <span class="keywordflow">if</span> (substr($string, 0, 1) != <span class="charliteral">&#39;&lt;&#39;</span>) {
<a name="l01418"></a>01418     <span class="comment">// We matched a lone &quot;&gt;&quot; character.</span>
<a name="l01419"></a>01419     <span class="keywordflow">return</span> <span class="stringliteral">&#39;&amp;gt;&#39;</span>;
<a name="l01420"></a>01420   }
<a name="l01421"></a>01421   elseif (strlen($string) == 1) {
<a name="l01422"></a>01422     <span class="comment">// We matched a lone &quot;&lt;&quot; character.</span>
<a name="l01423"></a>01423     <span class="keywordflow">return</span> <span class="stringliteral">&#39;&amp;lt;&#39;</span>;
<a name="l01424"></a>01424   }
<a name="l01425"></a>01425 
<a name="l01426"></a>01426   <span class="keywordflow">if</span> (!preg_match(<span class="stringliteral">&#39;%^&lt;\s*(/\s*)?([a-zA-Z0-9]+)([^&gt;]*)&gt;?|(&lt;!--.*?--&gt;)$%&#39;</span>, $string, $matches)) {
<a name="l01427"></a>01427     <span class="comment">// Seriously malformed.</span>
<a name="l01428"></a>01428     <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l01429"></a>01429   }
<a name="l01430"></a>01430 
<a name="l01431"></a>01431   $slash = trim($matches[1]);
<a name="l01432"></a>01432   $elem = &amp;$matches[2];
<a name="l01433"></a>01433   $attrlist = &amp;$matches[3];
<a name="l01434"></a>01434   $comment = &amp;$matches[4];
<a name="l01435"></a>01435 
<a name="l01436"></a>01436   <span class="keywordflow">if</span> ($comment) {
<a name="l01437"></a>01437     $elem = <span class="stringliteral">&#39;!--&#39;</span>;
<a name="l01438"></a>01438   }
<a name="l01439"></a>01439 
<a name="l01440"></a>01440   <span class="keywordflow">if</span> (!isset($allowed_html[strtolower($elem)])) {
<a name="l01441"></a>01441     <span class="comment">// Disallowed HTML element.</span>
<a name="l01442"></a>01442     <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l01443"></a>01443   }
<a name="l01444"></a>01444 
<a name="l01445"></a>01445   <span class="keywordflow">if</span> ($comment) {
<a name="l01446"></a>01446     <span class="keywordflow">return</span> $comment;
<a name="l01447"></a>01447   }
<a name="l01448"></a>01448 
<a name="l01449"></a>01449   <span class="keywordflow">if</span> ($slash != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l01450"></a>01450     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;/$elem&gt;&quot;</span>;
<a name="l01451"></a>01451   }
<a name="l01452"></a>01452 
<a name="l01453"></a>01453   <span class="comment">// Is there a closing XHTML slash at the end of the attributes?</span>
<a name="l01454"></a>01454   $attrlist = preg_replace(<span class="stringliteral">&#39;%(\s?)/\s*$%&#39;</span>, <span class="charliteral">&#39;\1&#39;</span>, $attrlist, -1, $count);
<a name="l01455"></a>01455   $xhtml_slash = $count ? <span class="stringliteral">&#39; /&#39;</span> : <span class="stringliteral">&#39;&#39;</span>;
<a name="l01456"></a>01456 
<a name="l01457"></a>01457   <span class="comment">// Clean up attributes.</span>
<a name="l01458"></a>01458   $attr2 = implode(<span class="charliteral">&#39; &#39;</span>, <a class="code" href="group__sanitization_ga3c24df8bdf07aa972dd82aa2ab35858f.html#ga3c24df8bdf07aa972dd82aa2ab35858f" title="Processes a string of HTML attributes.">_filter_xss_attributes</a>($attrlist));
<a name="l01459"></a>01459   $attr2 = preg_replace(<span class="stringliteral">&#39;/[&lt;&gt;]/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $attr2);
<a name="l01460"></a>01460   $attr2 = strlen($attr2) ? <span class="charliteral">&#39; &#39;</span> . $attr2 : <span class="stringliteral">&#39;&#39;</span>;
<a name="l01461"></a>01461 
<a name="l01462"></a>01462   <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;$elem$attr2$xhtml_slash&gt;&quot;</span>;
<a name="l01463"></a>01463 }
<a name="l01464"></a>01464 
<a name="l01471"></a><a class="code" href="group__sanitization_ga3c24df8bdf07aa972dd82aa2ab35858f.html#ga3c24df8bdf07aa972dd82aa2ab35858f">01471</a> <span class="keyword">function</span> <a class="code" href="group__sanitization_ga3c24df8bdf07aa972dd82aa2ab35858f.html#ga3c24df8bdf07aa972dd82aa2ab35858f" title="Processes a string of HTML attributes.">_filter_xss_attributes</a>($attr) {
<a name="l01472"></a>01472   $attrarr = array();
<a name="l01473"></a>01473   $mode = 0;
<a name="l01474"></a>01474   $attrname = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01475"></a>01475 
<a name="l01476"></a>01476   <span class="keywordflow">while</span> (strlen($attr) != 0) {
<a name="l01477"></a>01477     <span class="comment">// Was the last operation successful?</span>
<a name="l01478"></a>01478     $working = 0;
<a name="l01479"></a>01479 
<a name="l01480"></a>01480     <span class="keywordflow">switch</span> ($mode) {
<a name="l01481"></a>01481       <span class="keywordflow">case</span> 0:
<a name="l01482"></a>01482         <span class="comment">// Attribute name, href for instance.</span>
<a name="l01483"></a>01483         <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^([-a-zA-Z]+)/&#39;</span>, $attr, $match)) {
<a name="l01484"></a>01484           $attrname = strtolower($match[1]);
<a name="l01485"></a>01485           $skip = ($attrname == <span class="stringliteral">&#39;style&#39;</span> || substr($attrname, 0, 2) == <span class="stringliteral">&#39;on&#39;</span>);
<a name="l01486"></a>01486           $working = $mode = 1;
<a name="l01487"></a>01487           $attr = preg_replace(<span class="stringliteral">&#39;/^[-a-zA-Z]+/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $attr);
<a name="l01488"></a>01488         }
<a name="l01489"></a>01489         <span class="keywordflow">break</span>;
<a name="l01490"></a>01490 
<a name="l01491"></a>01491       <span class="keywordflow">case</span> 1:
<a name="l01492"></a>01492         <span class="comment">// Equals sign or valueless (&quot;selected&quot;).</span>
<a name="l01493"></a>01493         <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^\s*=\s*/&#39;</span>, $attr)) {
<a name="l01494"></a>01494           $working = 1; $mode = 2;
<a name="l01495"></a>01495           $attr = preg_replace(<span class="stringliteral">&#39;/^\s*=\s*/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $attr);
<a name="l01496"></a>01496           <span class="keywordflow">break</span>;
<a name="l01497"></a>01497         }
<a name="l01498"></a>01498 
<a name="l01499"></a>01499         <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^\s+/&#39;</span>, $attr)) {
<a name="l01500"></a>01500           $working = 1; $mode = 0;
<a name="l01501"></a>01501           <span class="keywordflow">if</span> (!$skip) {
<a name="l01502"></a>01502             $attrarr[] = $attrname;
<a name="l01503"></a>01503           }
<a name="l01504"></a>01504           $attr = preg_replace(<span class="stringliteral">&#39;/^\s+/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $attr);
<a name="l01505"></a>01505         }
<a name="l01506"></a>01506         <span class="keywordflow">break</span>;
<a name="l01507"></a>01507 
<a name="l01508"></a>01508       <span class="keywordflow">case</span> 2:
<a name="l01509"></a>01509         <span class="comment">// Attribute value, a URL after href= for instance.</span>
<a name="l01510"></a>01510         <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^&quot;([^&quot;]*)&quot;(\s+|$)/&#39;</span>, $attr, $match)) {
<a name="l01511"></a>01511           $thisval = <a class="code" href="group__sanitization_ga81affabdadf9d999874d5a69316ec8c8.html#ga81affabdadf9d999874d5a69316ec8c8" title="Processes an HTML attribute value and strips dangerous protocols from URLs.">filter_xss_bad_protocol</a>($match[1]);
<a name="l01512"></a>01512 
<a name="l01513"></a>01513           <span class="keywordflow">if</span> (!$skip) {
<a name="l01514"></a>01514             $attrarr[] = <span class="stringliteral">&quot;$attrname=\&quot;$thisval\&quot;&quot;</span>;
<a name="l01515"></a>01515           }
<a name="l01516"></a>01516           $working = 1;
<a name="l01517"></a>01517           $mode = 0;
<a name="l01518"></a>01518           $attr = preg_replace(<span class="stringliteral">&#39;/^&quot;[^&quot;]*&quot;(\s+|$)/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $attr);
<a name="l01519"></a>01519           <span class="keywordflow">break</span>;
<a name="l01520"></a>01520         }
<a name="l01521"></a>01521 
<a name="l01522"></a>01522         <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&quot;/^&#39;([^&#39;]*)&#39;(\s+|$)/&quot;</span>, $attr, $match)) {
<a name="l01523"></a>01523           $thisval = <a class="code" href="group__sanitization_ga81affabdadf9d999874d5a69316ec8c8.html#ga81affabdadf9d999874d5a69316ec8c8" title="Processes an HTML attribute value and strips dangerous protocols from URLs.">filter_xss_bad_protocol</a>($match[1]);
<a name="l01524"></a>01524 
<a name="l01525"></a>01525           <span class="keywordflow">if</span> (!$skip) {
<a name="l01526"></a>01526             $attrarr[] = <span class="stringliteral">&quot;$attrname=&#39;$thisval&#39;&quot;</span>;
<a name="l01527"></a>01527           }
<a name="l01528"></a>01528           $working = 1; $mode = 0;
<a name="l01529"></a>01529           $attr = preg_replace(<span class="stringliteral">&quot;/^&#39;[^&#39;]*&#39;(\s+|$)/&quot;</span>, <span class="stringliteral">&#39;&#39;</span>, $attr);
<a name="l01530"></a>01530           <span class="keywordflow">break</span>;
<a name="l01531"></a>01531         }
<a name="l01532"></a>01532 
<a name="l01533"></a>01533         <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&quot;%^([^\s\&quot;&#39;]+)(\s+|$)%&quot;</span>, $attr, $match)) {
<a name="l01534"></a>01534           $thisval = <a class="code" href="group__sanitization_ga81affabdadf9d999874d5a69316ec8c8.html#ga81affabdadf9d999874d5a69316ec8c8" title="Processes an HTML attribute value and strips dangerous protocols from URLs.">filter_xss_bad_protocol</a>($match[1]);
<a name="l01535"></a>01535 
<a name="l01536"></a>01536           <span class="keywordflow">if</span> (!$skip) {
<a name="l01537"></a>01537             $attrarr[] = <span class="stringliteral">&quot;$attrname=\&quot;$thisval\&quot;&quot;</span>;
<a name="l01538"></a>01538           }
<a name="l01539"></a>01539           $working = 1; $mode = 0;
<a name="l01540"></a>01540           $attr = preg_replace(<span class="stringliteral">&quot;%^[^\s\&quot;&#39;]+(\s+|$)%&quot;</span>, <span class="stringliteral">&#39;&#39;</span>, $attr);
<a name="l01541"></a>01541         }
<a name="l01542"></a>01542         <span class="keywordflow">break</span>;
<a name="l01543"></a>01543     }
<a name="l01544"></a>01544 
<a name="l01545"></a>01545     <span class="keywordflow">if</span> ($working == 0) {
<a name="l01546"></a>01546       <span class="comment">// Not well formed; remove and try again.</span>
<a name="l01547"></a>01547       $attr = preg_replace(<span class="stringliteral">&#39;/</span>
<a name="l01548"></a>01548 <span class="stringliteral">        ^</span>
<a name="l01549"></a>01549 <span class="stringliteral">        (</span>
<a name="l01550"></a>01550 <span class="stringliteral">        &quot;[^&quot;]*(&quot;|$)     # - a string that starts with a double quote, up until the next double quote or the end of the string</span>
<a name="l01551"></a>01551 <span class="stringliteral">        |               # or</span>
<a name="l01552"></a>01552 <span class="stringliteral">        \&#39;[^\&#39;]*(\&#39;|$)| # - a string that starts with a quote, up until the next quote or the end of the string</span>
<a name="l01553"></a>01553 <span class="stringliteral">        |               # or</span>
<a name="l01554"></a>01554 <span class="stringliteral">        \S              # - a non-whitespace character</span>
<a name="l01555"></a>01555 <span class="stringliteral">        )*              # any number of the above three</span>
<a name="l01556"></a>01556 <span class="stringliteral">        \s*             # any number of whitespaces</span>
<a name="l01557"></a>01557 <span class="stringliteral">        /x&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $attr);
<a name="l01558"></a>01558       $mode = 0;
<a name="l01559"></a>01559     }
<a name="l01560"></a>01560   }
<a name="l01561"></a>01561 
<a name="l01562"></a>01562   <span class="comment">// The attribute list ends with a valueless attribute like &quot;selected&quot;.</span>
<a name="l01563"></a>01563   <span class="keywordflow">if</span> ($mode == 1 &amp;&amp; !$skip) {
<a name="l01564"></a>01564     $attrarr[] = $attrname;
<a name="l01565"></a>01565   }
<a name="l01566"></a>01566   <span class="keywordflow">return</span> $attrarr;
<a name="l01567"></a>01567 }
<a name="l01568"></a>01568 
<a name="l01583"></a><a class="code" href="group__sanitization_ga81affabdadf9d999874d5a69316ec8c8.html#ga81affabdadf9d999874d5a69316ec8c8">01583</a> <span class="keyword">function</span> <a class="code" href="group__sanitization_ga81affabdadf9d999874d5a69316ec8c8.html#ga81affabdadf9d999874d5a69316ec8c8" title="Processes an HTML attribute value and strips dangerous protocols from URLs.">filter_xss_bad_protocol</a>($string, $decode = TRUE) {
<a name="l01584"></a>01584   <span class="comment">// Get the plain text representation of the attribute value (i.e. its meaning).</span>
<a name="l01585"></a>01585   <span class="comment">// @todo Remove the $decode parameter in Drupal 8, and always assume an HTML</span>
<a name="l01586"></a>01586   <span class="comment">//   string that needs decoding.</span>
<a name="l01587"></a>01587   <span class="keywordflow">if</span> ($decode) {
<a name="l01588"></a>01588     <span class="keywordflow">if</span> (!function_exists(<span class="stringliteral">&#39;decode_entities&#39;</span>)) {
<a name="l01589"></a>01589       require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/unicode.inc&#39;</span>;
<a name="l01590"></a>01590     }
<a name="l01591"></a>01591 
<a name="l01592"></a>01592     $string = <a class="code" href="unicode_8inc_ac16f5ce77c68cec0acc3d0e193e5229c.html#ac16f5ce77c68cec0acc3d0e193e5229c" title="Decodes all HTML entities (including numerical ones) to regular UTF-8 bytes.">decode_entities</a>($string);
<a name="l01593"></a>01593   }
<a name="l01594"></a>01594   <span class="keywordflow">return</span> <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>(<a class="code" href="group__sanitization_ga46ff2822d576a77317f9045d65317b4f.html#ga46ff2822d576a77317f9045d65317b4f" title="Strips dangerous protocols (e.g.">drupal_strip_dangerous_protocols</a>($string));
<a name="l01595"></a>01595 }
<a name="l01596"></a>01596 
<a name="l01612"></a><a class="code" href="group__format_ga44992b971aed4a6a5b8457678f57de50.html#ga44992b971aed4a6a5b8457678f57de50">01612</a> <span class="keyword">function</span> <a class="code" href="group__format_ga44992b971aed4a6a5b8457678f57de50.html#ga44992b971aed4a6a5b8457678f57de50" title="Formats an RSS channel.">format_rss_channel</a>($title, $link, $description, $items, $langcode = NULL, $args = array()) {
<a name="l01613"></a>01613   global $language_content;
<a name="l01614"></a>01614   $langcode = $langcode ? $langcode : $language_content-&gt;language;
<a name="l01615"></a>01615 
<a name="l01616"></a>01616   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> = <span class="stringliteral">&quot;&lt;channel&gt;\n&quot;</span>;
<a name="l01617"></a>01617   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39; &lt;title&gt;&#39;</span> . <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>($title) . <span class="stringliteral">&quot;&lt;/title&gt;\n&quot;</span>;
<a name="l01618"></a>01618   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39; &lt;link&gt;&#39;</span> . <a class="code" href="group__sanitization_gac024315b69035ef05c33674838707919.html#gac024315b69035ef05c33674838707919" title="Strips dangerous protocols from a URI and encodes it for output to HTML.">check_url</a>($link) . <span class="stringliteral">&quot;&lt;/link&gt;\n&quot;</span>;
<a name="l01619"></a>01619 
<a name="l01620"></a>01620   <span class="comment">// The RSS 2.0 &quot;spec&quot; doesn&#39;t indicate HTML can be used in the description.</span>
<a name="l01621"></a>01621   <span class="comment">// We strip all HTML tags, but need to prevent double encoding from properly</span>
<a name="l01622"></a>01622   <span class="comment">// escaped source data (such as &amp;amp becoming &amp;amp;amp;).</span>
<a name="l01623"></a>01623   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39; &lt;description&gt;&#39;</span> . <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>(<a class="code" href="unicode_8inc_ac16f5ce77c68cec0acc3d0e193e5229c.html#ac16f5ce77c68cec0acc3d0e193e5229c" title="Decodes all HTML entities (including numerical ones) to regular UTF-8 bytes.">decode_entities</a>(strip_tags($description))) . <span class="stringliteral">&quot;&lt;/description&gt;\n&quot;</span>;
<a name="l01624"></a>01624   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39; &lt;language&gt;&#39;</span> . <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>($langcode) . <span class="stringliteral">&quot;&lt;/language&gt;\n&quot;</span>;
<a name="l01625"></a>01625   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <a class="code" href="group__format_gafb344c648e6b63c35950d2889430e4c7.html#gafb344c648e6b63c35950d2889430e4c7" title="Formats XML elements.">format_xml_elements</a>($args);
<a name="l01626"></a>01626   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= $items;
<a name="l01627"></a>01627   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&quot;&lt;/channel&gt;\n&quot;</span>;
<a name="l01628"></a>01628 
<a name="l01629"></a>01629   <span class="keywordflow">return</span> <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>;
<a name="l01630"></a>01630 }
<a name="l01631"></a>01631 
<a name="l01637"></a><a class="code" href="group__format_ga4ecc9b876a9eaa65abb24ef513b217ad.html#ga4ecc9b876a9eaa65abb24ef513b217ad">01637</a> <span class="keyword">function</span> <a class="code" href="group__format_ga4ecc9b876a9eaa65abb24ef513b217ad.html#ga4ecc9b876a9eaa65abb24ef513b217ad" title="Formats a single RSS item.">format_rss_item</a>($title, $link, $description, $args = array()) {
<a name="l01638"></a>01638   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> = <span class="stringliteral">&quot;&lt;item&gt;\n&quot;</span>;
<a name="l01639"></a>01639   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39; &lt;title&gt;&#39;</span> . <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>($title) . <span class="stringliteral">&quot;&lt;/title&gt;\n&quot;</span>;
<a name="l01640"></a>01640   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39; &lt;link&gt;&#39;</span> . <a class="code" href="group__sanitization_gac024315b69035ef05c33674838707919.html#gac024315b69035ef05c33674838707919" title="Strips dangerous protocols from a URI and encodes it for output to HTML.">check_url</a>($link) . <span class="stringliteral">&quot;&lt;/link&gt;\n&quot;</span>;
<a name="l01641"></a>01641   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39; &lt;description&gt;&#39;</span> . <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>($description) . <span class="stringliteral">&quot;&lt;/description&gt;\n&quot;</span>;
<a name="l01642"></a>01642   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <a class="code" href="group__format_gafb344c648e6b63c35950d2889430e4c7.html#gafb344c648e6b63c35950d2889430e4c7" title="Formats XML elements.">format_xml_elements</a>($args);
<a name="l01643"></a>01643   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&quot;&lt;/item&gt;\n&quot;</span>;
<a name="l01644"></a>01644 
<a name="l01645"></a>01645   <span class="keywordflow">return</span> <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>;
<a name="l01646"></a>01646 }
<a name="l01647"></a>01647 
<a name="l01662"></a><a class="code" href="group__format_gafb344c648e6b63c35950d2889430e4c7.html#gafb344c648e6b63c35950d2889430e4c7">01662</a> <span class="keyword">function</span> <a class="code" href="group__format_gafb344c648e6b63c35950d2889430e4c7.html#gafb344c648e6b63c35950d2889430e4c7" title="Formats XML elements.">format_xml_elements</a>($array) {
<a name="l01663"></a>01663   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01664"></a>01664   <span class="keywordflow">foreach</span> ($array as $key =&gt; $value) {
<a name="l01665"></a>01665     <span class="keywordflow">if</span> (is_numeric($key)) {
<a name="l01666"></a>01666       <span class="keywordflow">if</span> ($value[<span class="stringliteral">&#39;key&#39;</span>]) {
<a name="l01667"></a>01667         <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39; &lt;&#39;</span> . $value[<span class="stringliteral">&#39;key&#39;</span>];
<a name="l01668"></a>01668         <span class="keywordflow">if</span> (isset($value[<span class="stringliteral">&#39;attributes&#39;</span>]) &amp;&amp; is_array($value[<span class="stringliteral">&#39;attributes&#39;</span>])) {
<a name="l01669"></a>01669           <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <a class="code" href="group__sanitization_gacf11629fb3d1ebf200863e2d15380b4a.html#gacf11629fb3d1ebf200863e2d15380b4a" title="Converts an associative array to an XML/HTML tag attribute string.">drupal_attributes</a>($value[<span class="stringliteral">&#39;attributes&#39;</span>]);
<a name="l01670"></a>01670         }
<a name="l01671"></a>01671 
<a name="l01672"></a>01672         <span class="keywordflow">if</span> (isset($value[<span class="stringliteral">&#39;value&#39;</span>]) &amp;&amp; $value[<span class="stringliteral">&#39;value&#39;</span>] != <span class="stringliteral">&#39;&#39;</span>) {
<a name="l01673"></a>01673           <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="charliteral">&#39;&gt;&#39;</span> . (is_array($value[<span class="stringliteral">&#39;value&#39;</span>]) ? <a class="code" href="group__format_gafb344c648e6b63c35950d2889430e4c7.html#gafb344c648e6b63c35950d2889430e4c7" title="Formats XML elements.">format_xml_elements</a>($value[<span class="stringliteral">&#39;value&#39;</span>]) : <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>($value[<span class="stringliteral">&#39;value&#39;</span>])) . <span class="stringliteral">&#39;&lt;/&#39;</span> . $value[<span class="stringliteral">&#39;key&#39;</span>] . <span class="stringliteral">&quot;&gt;\n&quot;</span>;
<a name="l01674"></a>01674         }
<a name="l01675"></a>01675         <span class="keywordflow">else</span> {
<a name="l01676"></a>01676           <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&quot; /&gt;\n&quot;</span>;
<a name="l01677"></a>01677         }
<a name="l01678"></a>01678       }
<a name="l01679"></a>01679     }
<a name="l01680"></a>01680     <span class="keywordflow">else</span> {
<a name="l01681"></a>01681       <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39; &lt;&#39;</span> . $key . <span class="charliteral">&#39;&gt;&#39;</span> . (is_array($value) ? <a class="code" href="group__format_gafb344c648e6b63c35950d2889430e4c7.html#gafb344c648e6b63c35950d2889430e4c7" title="Formats XML elements.">format_xml_elements</a>($value) : <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>($value)) . <span class="stringliteral">&quot;&lt;/$key&gt;\n&quot;</span>;
<a name="l01682"></a>01682     }
<a name="l01683"></a>01683   }
<a name="l01684"></a>01684   <span class="keywordflow">return</span> <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>;
<a name="l01685"></a>01685 }
<a name="l01686"></a>01686 
<a name="l01732"></a><a class="code" href="group__format_ga215a60b10cd70858e7a268eaf04cbed7.html#ga215a60b10cd70858e7a268eaf04cbed7">01732</a> <span class="keyword">function</span> <a class="code" href="group__format_ga215a60b10cd70858e7a268eaf04cbed7.html#ga215a60b10cd70858e7a268eaf04cbed7" title="Formats a string containing a count of items.">format_plural</a>($count, $singular, $plural, array $args = array(), array $options = array()) {
<a name="l01733"></a>01733   $args[<span class="stringliteral">&#39;@count&#39;</span>] = $count;
<a name="l01734"></a>01734   <span class="keywordflow">if</span> ($count == 1) {
<a name="l01735"></a>01735     <span class="keywordflow">return</span> <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>($singular, $args, $options);
<a name="l01736"></a>01736   }
<a name="l01737"></a>01737 
<a name="l01738"></a>01738   <span class="comment">// Get the plural index through the gettext formula.</span>
<a name="l01739"></a>01739   $index = (function_exists(<span class="stringliteral">&#39;locale_get_plural&#39;</span>)) ? locale_get_plural($count, isset($options[<span class="stringliteral">&#39;langcode&#39;</span>]) ? $options[<span class="stringliteral">&#39;langcode&#39;</span>] : NULL) : -1;
<a name="l01740"></a>01740   <span class="comment">// If the index cannot be computed, use the plural as a fallback (which</span>
<a name="l01741"></a>01741   <span class="comment">// allows for most flexiblity with the replaceable @count value).</span>
<a name="l01742"></a>01742   <span class="keywordflow">if</span> ($index &lt; 0) {
<a name="l01743"></a>01743     <span class="keywordflow">return</span> <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>($plural, $args, $options);
<a name="l01744"></a>01744   }
<a name="l01745"></a>01745   <span class="keywordflow">else</span> {
<a name="l01746"></a>01746     <span class="keywordflow">switch</span> ($index) {
<a name="l01747"></a>01747       <span class="keywordflow">case</span> <span class="stringliteral">&quot;0&quot;</span>:
<a name="l01748"></a>01748         <span class="keywordflow">return</span> <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>($singular, $args, $options);
<a name="l01749"></a>01749       <span class="keywordflow">case</span> <span class="stringliteral">&quot;1&quot;</span>:
<a name="l01750"></a>01750         <span class="keywordflow">return</span> <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>($plural, $args, $options);
<a name="l01751"></a>01751       <span class="keywordflow">default</span>:
<a name="l01752"></a>01752         unset($args[<span class="stringliteral">&#39;@count&#39;</span>]);
<a name="l01753"></a>01753         $args[<span class="stringliteral">&#39;@count[&#39;</span> . $index . <span class="charliteral">&#39;]&#39;</span>] = $count;
<a name="l01754"></a>01754         <span class="keywordflow">return</span> <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(strtr($plural, array(<span class="stringliteral">&#39;@count&#39;</span> =&gt; <span class="stringliteral">&#39;@count[&#39;</span> . $index . <span class="charliteral">&#39;]&#39;</span>)), $args, $options);
<a name="l01755"></a>01755     }
<a name="l01756"></a>01756   }
<a name="l01757"></a>01757 }
<a name="l01758"></a>01758 
<a name="l01769"></a><a class="code" href="group__format_ga08382023ada29bae2a6a94f22196b066.html#ga08382023ada29bae2a6a94f22196b066">01769</a> <span class="keyword">function</span> <a class="code" href="group__format_ga08382023ada29bae2a6a94f22196b066.html#ga08382023ada29bae2a6a94f22196b066" title="Parses a given byte count.">parse_size</a>($size) {
<a name="l01770"></a>01770   $unit = preg_replace(<span class="stringliteral">&#39;/[^bkmgtpezy]/i&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $size); <span class="comment">// Remove the non-unit characters from the size.</span>
<a name="l01771"></a>01771   $size = preg_replace(<span class="stringliteral">&#39;/[^0-9\.]/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $size); <span class="comment">// Remove the non-numeric characters from the size.</span>
<a name="l01772"></a>01772   <span class="keywordflow">if</span> ($unit) {
<a name="l01773"></a>01773     <span class="comment">// Find the position of the unit in the ordered string which is the power of magnitude to multiply a kilobyte by.</span>
<a name="l01774"></a>01774     <span class="keywordflow">return</span> round($size * pow(<a class="code" href="bootstrap_8inc_ab6865363d0c783dee8dccbda9849de9f.html#ab6865363d0c783dee8dccbda9849de9f" title="The number of bytes in a kilobyte.">DRUPAL_KILOBYTE</a>, stripos(<span class="stringliteral">&#39;bkmgtpezy&#39;</span>, $unit[0])));
<a name="l01775"></a>01775   }
<a name="l01776"></a>01776   <span class="keywordflow">else</span> {
<a name="l01777"></a>01777     <span class="keywordflow">return</span> round($size);
<a name="l01778"></a>01778   }
<a name="l01779"></a>01779 }
<a name="l01780"></a>01780 
<a name="l01793"></a><a class="code" href="group__format_ga2a0075e7646fa2f399286272faa2956e.html#ga2a0075e7646fa2f399286272faa2956e">01793</a> <span class="keyword">function</span> <a class="code" href="group__format_ga2a0075e7646fa2f399286272faa2956e.html#ga2a0075e7646fa2f399286272faa2956e" title="Generates a string representation for the given byte count.">format_size</a>($size, $langcode = NULL) {
<a name="l01794"></a>01794   <span class="keywordflow">if</span> ($size &lt; <a class="code" href="bootstrap_8inc_ab6865363d0c783dee8dccbda9849de9f.html#ab6865363d0c783dee8dccbda9849de9f" title="The number of bytes in a kilobyte.">DRUPAL_KILOBYTE</a>) {
<a name="l01795"></a>01795     <span class="keywordflow">return</span> <a class="code" href="group__format_ga215a60b10cd70858e7a268eaf04cbed7.html#ga215a60b10cd70858e7a268eaf04cbed7" title="Formats a string containing a count of items.">format_plural</a>($size, <span class="stringliteral">&#39;1 byte&#39;</span>, <span class="stringliteral">&#39;@count bytes&#39;</span>, array(), array(<span class="stringliteral">&#39;langcode&#39;</span> =&gt; $langcode));
<a name="l01796"></a>01796   }
<a name="l01797"></a>01797   <span class="keywordflow">else</span> {
<a name="l01798"></a>01798     $size = $size / <a class="code" href="bootstrap_8inc_ab6865363d0c783dee8dccbda9849de9f.html#ab6865363d0c783dee8dccbda9849de9f" title="The number of bytes in a kilobyte.">DRUPAL_KILOBYTE</a>; <span class="comment">// Convert bytes to kilobytes.</span>
<a name="l01799"></a>01799     $units = array(
<a name="l01800"></a>01800       <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;@size KB&#39;</span>, array(), array(<span class="stringliteral">&#39;langcode&#39;</span> =&gt; $langcode)),
<a name="l01801"></a>01801       <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;@size MB&#39;</span>, array(), array(<span class="stringliteral">&#39;langcode&#39;</span> =&gt; $langcode)),
<a name="l01802"></a>01802       <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;@size GB&#39;</span>, array(), array(<span class="stringliteral">&#39;langcode&#39;</span> =&gt; $langcode)),
<a name="l01803"></a>01803       <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;@size TB&#39;</span>, array(), array(<span class="stringliteral">&#39;langcode&#39;</span> =&gt; $langcode)),
<a name="l01804"></a>01804       <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;@size PB&#39;</span>, array(), array(<span class="stringliteral">&#39;langcode&#39;</span> =&gt; $langcode)),
<a name="l01805"></a>01805       <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;@size EB&#39;</span>, array(), array(<span class="stringliteral">&#39;langcode&#39;</span> =&gt; $langcode)),
<a name="l01806"></a>01806       <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;@size ZB&#39;</span>, array(), array(<span class="stringliteral">&#39;langcode&#39;</span> =&gt; $langcode)),
<a name="l01807"></a>01807       <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;@size YB&#39;</span>, array(), array(<span class="stringliteral">&#39;langcode&#39;</span> =&gt; $langcode)),
<a name="l01808"></a>01808     );
<a name="l01809"></a>01809     <span class="keywordflow">foreach</span> ($units as $unit) {
<a name="l01810"></a>01810       <span class="keywordflow">if</span> (round($size, 2) &gt;= <a class="code" href="bootstrap_8inc_ab6865363d0c783dee8dccbda9849de9f.html#ab6865363d0c783dee8dccbda9849de9f" title="The number of bytes in a kilobyte.">DRUPAL_KILOBYTE</a>) {
<a name="l01811"></a>01811         $size = $size / <a class="code" href="bootstrap_8inc_ab6865363d0c783dee8dccbda9849de9f.html#ab6865363d0c783dee8dccbda9849de9f" title="The number of bytes in a kilobyte.">DRUPAL_KILOBYTE</a>;
<a name="l01812"></a>01812       }
<a name="l01813"></a>01813       <span class="keywordflow">else</span> {
<a name="l01814"></a>01814         <span class="keywordflow">break</span>;
<a name="l01815"></a>01815       }
<a name="l01816"></a>01816     }
<a name="l01817"></a>01817     <span class="keywordflow">return</span> str_replace(<span class="stringliteral">&#39;@size&#39;</span>, round($size, 2), $unit);
<a name="l01818"></a>01818   }
<a name="l01819"></a>01819 }
<a name="l01820"></a>01820 
<a name="l01835"></a><a class="code" href="group__format_ga0615263857988e35c25d84c59a9733a4.html#ga0615263857988e35c25d84c59a9733a4">01835</a> <span class="keyword">function</span> <a class="code" href="group__format_ga0615263857988e35c25d84c59a9733a4.html#ga0615263857988e35c25d84c59a9733a4" title="Formats a time interval with the requested granularity.">format_interval</a>($interval, $granularity = 2, $langcode = NULL) {
<a name="l01836"></a>01836   $units = array(
<a name="l01837"></a>01837     <span class="stringliteral">&#39;1 year|@count years&#39;</span> =&gt; 31536000,
<a name="l01838"></a>01838     <span class="stringliteral">&#39;1 month|@count months&#39;</span> =&gt; 2592000,
<a name="l01839"></a>01839     <span class="stringliteral">&#39;1 week|@count weeks&#39;</span> =&gt; 604800,
<a name="l01840"></a>01840     <span class="stringliteral">&#39;1 day|@count days&#39;</span> =&gt; 86400,
<a name="l01841"></a>01841     <span class="stringliteral">&#39;1 hour|@count hours&#39;</span> =&gt; 3600,
<a name="l01842"></a>01842     <span class="stringliteral">&#39;1 min|@count min&#39;</span> =&gt; 60,
<a name="l01843"></a>01843     <span class="stringliteral">&#39;1 sec|@count sec&#39;</span> =&gt; 1
<a name="l01844"></a>01844   );
<a name="l01845"></a>01845   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01846"></a>01846   <span class="keywordflow">foreach</span> ($units as $key =&gt; $value) {
<a name="l01847"></a>01847     $key = explode(<span class="charliteral">&#39;|&#39;</span>, $key);
<a name="l01848"></a>01848     <span class="keywordflow">if</span> ($interval &gt;= $value) {
<a name="l01849"></a>01849       <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= (<a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> ? <span class="charliteral">&#39; &#39;</span> : <span class="stringliteral">&#39;&#39;</span>) . <a class="code" href="group__format_ga215a60b10cd70858e7a268eaf04cbed7.html#ga215a60b10cd70858e7a268eaf04cbed7" title="Formats a string containing a count of items.">format_plural</a>(floor($interval / $value), $key[0], $key[1], array(), array(<span class="stringliteral">&#39;langcode&#39;</span> =&gt; $langcode));
<a name="l01850"></a>01850       $interval %= $value;
<a name="l01851"></a>01851       $granularity--;
<a name="l01852"></a>01852     }
<a name="l01853"></a>01853 
<a name="l01854"></a>01854     <span class="keywordflow">if</span> ($granularity == 0) {
<a name="l01855"></a>01855       <span class="keywordflow">break</span>;
<a name="l01856"></a>01856     }
<a name="l01857"></a>01857   }
<a name="l01858"></a>01858   <span class="keywordflow">return</span> <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> ? <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> : <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;0 sec&#39;</span>, array(), array(<span class="stringliteral">&#39;langcode&#39;</span> =&gt; $langcode));
<a name="l01859"></a>01859 }
<a name="l01860"></a>01860 
<a name="l01889"></a><a class="code" href="group__format_ga40553742a67f9c79c4669b9053fe202c.html#ga40553742a67f9c79c4669b9053fe202c">01889</a> <span class="keyword">function</span> <a class="code" href="group__format_ga40553742a67f9c79c4669b9053fe202c.html#ga40553742a67f9c79c4669b9053fe202c" title="Formats a date, using a date type or a custom date format string.">format_date</a>($timestamp, $type = <span class="stringliteral">&#39;medium&#39;</span>, $format = <span class="stringliteral">&#39;&#39;</span>, $timezone = NULL, $langcode = NULL) {
<a name="l01890"></a>01890   <span class="comment">// Use the advanced drupal_static() pattern, since this is called very often.</span>
<a name="l01891"></a>01891   <span class="keyword">static</span> $drupal_static_fast;
<a name="l01892"></a>01892   <span class="keywordflow">if</span> (!isset($drupal_static_fast)) {
<a name="l01893"></a>01893     $drupal_static_fast[<span class="stringliteral">&#39;timezones&#39;</span>] = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__);
<a name="l01894"></a>01894   }
<a name="l01895"></a>01895   $timezones = &amp;$drupal_static_fast[<span class="stringliteral">&#39;timezones&#39;</span>];
<a name="l01896"></a>01896 
<a name="l01897"></a>01897   <span class="keywordflow">if</span> (!isset($timezone)) {
<a name="l01898"></a>01898     $timezone = date_default_timezone_get();
<a name="l01899"></a>01899   }
<a name="l01900"></a>01900   <span class="comment">// Store DateTimeZone objects in an array rather than repeatedly</span>
<a name="l01901"></a>01901   <span class="comment">// constructing identical objects over the life of a request.</span>
<a name="l01902"></a>01902   <span class="keywordflow">if</span> (!isset($timezones[$timezone])) {
<a name="l01903"></a>01903     $timezones[$timezone] = timezone_open($timezone);
<a name="l01904"></a>01904   }
<a name="l01905"></a>01905 
<a name="l01906"></a>01906   <span class="comment">// Use the default langcode if none is set.</span>
<a name="l01907"></a>01907   global $language;
<a name="l01908"></a>01908   <span class="keywordflow">if</span> (empty($langcode)) {
<a name="l01909"></a>01909     $langcode = isset($language-&gt;language) ? $language-&gt;language : <span class="stringliteral">&#39;en&#39;</span>;
<a name="l01910"></a>01910   }
<a name="l01911"></a>01911 
<a name="l01912"></a>01912   <span class="keywordflow">switch</span> ($type) {
<a name="l01913"></a>01913     <span class="keywordflow">case</span> <span class="stringliteral">&#39;short&#39;</span>:
<a name="l01914"></a>01914       $format = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;date_format_short&#39;</span>, <span class="stringliteral">&#39;m/d/Y - H:i&#39;</span>);
<a name="l01915"></a>01915       <span class="keywordflow">break</span>;
<a name="l01916"></a>01916 
<a name="l01917"></a>01917     <span class="keywordflow">case</span> <span class="stringliteral">&#39;long&#39;</span>:
<a name="l01918"></a>01918       $format = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;date_format_long&#39;</span>, <span class="stringliteral">&#39;l, F j, Y - H:i&#39;</span>);
<a name="l01919"></a>01919       <span class="keywordflow">break</span>;
<a name="l01920"></a>01920 
<a name="l01921"></a>01921     <span class="keywordflow">case</span> <span class="stringliteral">&#39;custom&#39;</span>:
<a name="l01922"></a>01922       <span class="comment">// No change to format.</span>
<a name="l01923"></a>01923       <span class="keywordflow">break</span>;
<a name="l01924"></a>01924 
<a name="l01925"></a>01925     <span class="keywordflow">case</span> <span class="stringliteral">&#39;medium&#39;</span>:
<a name="l01926"></a>01926     <span class="keywordflow">default</span>:
<a name="l01927"></a>01927       <span class="comment">// Retrieve the format of the custom $type passed.</span>
<a name="l01928"></a>01928       <span class="keywordflow">if</span> ($type != <span class="stringliteral">&#39;medium&#39;</span>) {
<a name="l01929"></a>01929         $format = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;date_format_&#39;</span> . $type, <span class="stringliteral">&#39;&#39;</span>);
<a name="l01930"></a>01930       }
<a name="l01931"></a>01931       <span class="comment">// Fall back to &#39;medium&#39;.</span>
<a name="l01932"></a>01932       <span class="keywordflow">if</span> ($format === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l01933"></a>01933         $format = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;date_format_medium&#39;</span>, <span class="stringliteral">&#39;D, m/d/Y - H:i&#39;</span>);
<a name="l01934"></a>01934       }
<a name="l01935"></a>01935       <span class="keywordflow">break</span>;
<a name="l01936"></a>01936   }
<a name="l01937"></a>01937 
<a name="l01938"></a>01938   <span class="comment">// Create a DateTime object from the timestamp.</span>
<a name="l01939"></a>01939   $date_time = date_create(<span class="charliteral">&#39;@&#39;</span> . $timestamp);
<a name="l01940"></a>01940   <span class="comment">// Set the time zone for the DateTime object.</span>
<a name="l01941"></a>01941   date_timezone_set($date_time, $timezones[$timezone]);
<a name="l01942"></a>01942 
<a name="l01943"></a>01943   <span class="comment">// Encode markers that should be translated. &#39;A&#39; becomes &#39;\xEF\AA\xFF&#39;.</span>
<a name="l01944"></a>01944   <span class="comment">// xEF and xFF are invalid UTF-8 sequences, and we assume they are not in the</span>
<a name="l01945"></a>01945   <span class="comment">// input string.</span>
<a name="l01946"></a>01946   <span class="comment">// Paired backslashes are isolated to prevent errors in read-ahead evaluation.</span>
<a name="l01947"></a>01947   <span class="comment">// The read-ahead expression ensures that A matches, but not \A.</span>
<a name="l01948"></a>01948   $format = preg_replace(array(<span class="stringliteral">&#39;/\\\\\\\\/&#39;</span>, <span class="stringliteral">&#39;/(?&lt;!\\\\)([AaeDlMTF])/&#39;</span>), array(<span class="stringliteral">&quot;\xEF\\\\\\\\\xFF&quot;</span>, <span class="stringliteral">&quot;\xEF\\\\\$1\$1\xFF&quot;</span>), $format);
<a name="l01949"></a>01949 
<a name="l01950"></a>01950   <span class="comment">// Call date_format().</span>
<a name="l01951"></a>01951   $format = date_format($date_time, $format);
<a name="l01952"></a>01952 
<a name="l01953"></a>01953   <span class="comment">// Pass the langcode to _format_date_callback().</span>
<a name="l01954"></a>01954   <a class="code" href="group__format_gafbd5625a63c5da6e62dd6a53a314dfcd.html#gafbd5625a63c5da6e62dd6a53a314dfcd" title="Translates a formatted date string.">_format_date_callback</a>(NULL, $langcode);
<a name="l01955"></a>01955 
<a name="l01956"></a>01956   <span class="comment">// Translate the marked sequences.</span>
<a name="l01957"></a>01957   <span class="keywordflow">return</span> preg_replace_callback(<span class="stringliteral">&#39;/\xEF([AaeDlMTF]?)(.*?)\xFF/&#39;</span>, <span class="stringliteral">&#39;_format_date_callback&#39;</span>, $format);
<a name="l01958"></a>01958 }
<a name="l01959"></a>01959 
<a name="l01971"></a><a class="code" href="group__format_gabb13004721c9ab696704c968887d9d79.html#gabb13004721c9ab696704c968887d9d79">01971</a> <span class="keyword">function</span> <a class="code" href="group__format_gabb13004721c9ab696704c968887d9d79.html#gabb13004721c9ab696704c968887d9d79" title="Returns an ISO8601 formatted date based on the given date.">date_iso8601</a>($date) {
<a name="l01972"></a>01972   <span class="comment">// The DATE_ISO8601 constant cannot be used here because it does not match</span>
<a name="l01973"></a>01973   <span class="comment">// date(&#39;c&#39;) and produces invalid RDF markup.</span>
<a name="l01974"></a>01974   <span class="keywordflow">return</span> date(<span class="charliteral">&#39;c&#39;</span>, $date);
<a name="l01975"></a>01975 }
<a name="l01976"></a>01976 
<a name="l01982"></a><a class="code" href="group__format_gafbd5625a63c5da6e62dd6a53a314dfcd.html#gafbd5625a63c5da6e62dd6a53a314dfcd">01982</a> <span class="keyword">function</span> <a class="code" href="group__format_gafbd5625a63c5da6e62dd6a53a314dfcd.html#gafbd5625a63c5da6e62dd6a53a314dfcd" title="Translates a formatted date string.">_format_date_callback</a>(array $matches = NULL, $new_langcode = NULL) {
<a name="l01983"></a>01983   <span class="comment">// We cache translations to avoid redundant and rather costly calls to t().</span>
<a name="l01984"></a>01984   <span class="keyword">static</span> $cache, $langcode;
<a name="l01985"></a>01985 
<a name="l01986"></a>01986   <span class="keywordflow">if</span> (!isset($matches)) {
<a name="l01987"></a>01987     $langcode = $new_langcode;
<a name="l01988"></a>01988     <span class="keywordflow">return</span>;
<a name="l01989"></a>01989   }
<a name="l01990"></a>01990 
<a name="l01991"></a>01991   $code = $matches[1];
<a name="l01992"></a>01992   $string = $matches[2];
<a name="l01993"></a>01993 
<a name="l01994"></a>01994   <span class="keywordflow">if</span> (!isset($cache[$langcode][$code][$string])) {
<a name="l01995"></a>01995     $options = array(
<a name="l01996"></a>01996       <span class="stringliteral">&#39;langcode&#39;</span> =&gt; $langcode,
<a name="l01997"></a>01997     );
<a name="l01998"></a>01998 
<a name="l01999"></a>01999     <span class="keywordflow">if</span> ($code == <span class="charliteral">&#39;F&#39;</span>) {
<a name="l02000"></a>02000       $options[<span class="stringliteral">&#39;context&#39;</span>] = <span class="stringliteral">&#39;Long month name&#39;</span>;
<a name="l02001"></a>02001     }
<a name="l02002"></a>02002 
<a name="l02003"></a>02003     <span class="keywordflow">if</span> ($code == <span class="stringliteral">&#39;&#39;</span>) {
<a name="l02004"></a>02004       $cache[$langcode][$code][$string] = $string;
<a name="l02005"></a>02005     }
<a name="l02006"></a>02006     <span class="keywordflow">else</span> {
<a name="l02007"></a>02007       $cache[$langcode][$code][$string] = <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>($string, array(), $options);
<a name="l02008"></a>02008     }
<a name="l02009"></a>02009   }
<a name="l02010"></a>02010   <span class="keywordflow">return</span> $cache[$langcode][$code][$string];
<a name="l02011"></a>02011 }
<a name="l02012"></a>02012 
<a name="l02030"></a><a class="code" href="group__format_ga7124a026ecfacc51c57a75fcc083f136.html#ga7124a026ecfacc51c57a75fcc083f136">02030</a> <span class="keyword">function</span> <a class="code" href="group__format_ga7124a026ecfacc51c57a75fcc083f136.html#ga7124a026ecfacc51c57a75fcc083f136" title="Format a username.">format_username</a>($account) {
<a name="l02031"></a>02031   $name = !empty($account-&gt;name) ? $account-&gt;name : <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;anonymous&#39;</span>, <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Anonymous&#39;</span>));
<a name="l02032"></a>02032   <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;username&#39;</span>, $name, $account);
<a name="l02033"></a>02033   <span class="keywordflow">return</span> $name;
<a name="l02034"></a>02034 }
<a name="l02035"></a>02035 
<a name="l02105"></a><a class="code" href="common_8inc_a43b2a0594431556db49df980801d8807.html#a43b2a0594431556db49df980801d8807">02105</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a43b2a0594431556db49df980801d8807.html#a43b2a0594431556db49df980801d8807" title="End of &quot;defgroup format&quot;.">url</a>($path = NULL, array $options = array()) {
<a name="l02106"></a>02106   <span class="comment">// Merge in defaults.</span>
<a name="l02107"></a>02107   $options += array(
<a name="l02108"></a>02108     <span class="stringliteral">&#39;fragment&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l02109"></a>02109     <span class="stringliteral">&#39;query&#39;</span> =&gt; array(),
<a name="l02110"></a>02110     <span class="stringliteral">&#39;absolute&#39;</span> =&gt; FALSE,
<a name="l02111"></a>02111     <span class="stringliteral">&#39;alias&#39;</span> =&gt; FALSE,
<a name="l02112"></a>02112     <span class="stringliteral">&#39;prefix&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>
<a name="l02113"></a>02113   );
<a name="l02114"></a>02114 
<a name="l02115"></a>02115   <span class="keywordflow">if</span> (!isset($options[<span class="stringliteral">&#39;external&#39;</span>])) {
<a name="l02116"></a>02116     <span class="comment">// Return an external link if $path contains an allowed absolute URL. Only</span>
<a name="l02117"></a>02117     <span class="comment">// call the slow drupal_strip_dangerous_protocols() if $path contains a &#39;:&#39;</span>
<a name="l02118"></a>02118     <span class="comment">// before any / ? or #. Note: we could use url_is_external($path) here, but</span>
<a name="l02119"></a>02119     <span class="comment">// that would require another function call, and performance inside url() is</span>
<a name="l02120"></a>02120     <span class="comment">// critical.</span>
<a name="l02121"></a>02121     $colonpos = strpos($path, <span class="charliteral">&#39;:&#39;</span>);
<a name="l02122"></a>02122     $options[<span class="stringliteral">&#39;external&#39;</span>] = ($colonpos !== FALSE &amp;&amp; !preg_match(<span class="stringliteral">&#39;![/?#]!&#39;</span>, substr($path, 0, $colonpos)) &amp;&amp; <a class="code" href="group__sanitization_ga46ff2822d576a77317f9045d65317b4f.html#ga46ff2822d576a77317f9045d65317b4f" title="Strips dangerous protocols (e.g.">drupal_strip_dangerous_protocols</a>($path) == $path);
<a name="l02123"></a>02123   }
<a name="l02124"></a>02124 
<a name="l02125"></a>02125   <span class="comment">// Preserve the original path before altering or aliasing.</span>
<a name="l02126"></a>02126   $original_path = $path;
<a name="l02127"></a>02127 
<a name="l02128"></a>02128   <span class="comment">// Allow other modules to alter the outbound URL and options.</span>
<a name="l02129"></a>02129   <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;url_outbound&#39;</span>, $path, $options, $original_path);
<a name="l02130"></a>02130 
<a name="l02131"></a>02131   <span class="keywordflow">if</span> (isset($options[<span class="stringliteral">&#39;fragment&#39;</span>]) &amp;&amp; $options[<span class="stringliteral">&#39;fragment&#39;</span>] !== <span class="stringliteral">&#39;&#39;</span>) {
<a name="l02132"></a>02132     $options[<span class="stringliteral">&#39;fragment&#39;</span>] = <span class="charliteral">&#39;#&#39;</span> . $options[<span class="stringliteral">&#39;fragment&#39;</span>];
<a name="l02133"></a>02133   }
<a name="l02134"></a>02134 
<a name="l02135"></a>02135   <span class="keywordflow">if</span> ($options[<span class="stringliteral">&#39;external&#39;</span>]) {
<a name="l02136"></a>02136     <span class="comment">// Split off the fragment.</span>
<a name="l02137"></a>02137     <span class="keywordflow">if</span> (strpos($path, <span class="charliteral">&#39;#&#39;</span>) !== FALSE) {
<a name="l02138"></a>02138       list($path, $old_fragment) = explode(<span class="charliteral">&#39;#&#39;</span>, $path, 2);
<a name="l02139"></a>02139       <span class="comment">// If $options contains no fragment, take it over from the path.</span>
<a name="l02140"></a>02140       <span class="keywordflow">if</span> (isset($old_fragment) &amp;&amp; !$options[<span class="stringliteral">&#39;fragment&#39;</span>]) {
<a name="l02141"></a>02141         $options[<span class="stringliteral">&#39;fragment&#39;</span>] = <span class="charliteral">&#39;#&#39;</span> . $old_fragment;
<a name="l02142"></a>02142       }
<a name="l02143"></a>02143     }
<a name="l02144"></a>02144     <span class="comment">// Append the query.</span>
<a name="l02145"></a>02145     <span class="keywordflow">if</span> ($options[<span class="stringliteral">&#39;query&#39;</span>]) {
<a name="l02146"></a>02146       $path .= (strpos($path, <span class="charliteral">&#39;?&#39;</span>) !== FALSE ? <span class="charliteral">&#39;&amp;&#39;</span> : <span class="charliteral">&#39;?&#39;</span>) . <a class="code" href="group__php__wrappers_gada763092b76d70856870eb3afa2ad265.html#gada763092b76d70856870eb3afa2ad265" title="Parses an array into a valid, rawurlencoded query string.">drupal_http_build_query</a>($options[<span class="stringliteral">&#39;query&#39;</span>]);
<a name="l02147"></a>02147     }
<a name="l02148"></a>02148     <span class="keywordflow">if</span> (isset($options[<span class="stringliteral">&#39;https&#39;</span>]) &amp;&amp; <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;https&#39;</span>, FALSE)) {
<a name="l02149"></a>02149       <span class="keywordflow">if</span> ($options[<span class="stringliteral">&#39;https&#39;</span>] === TRUE) {
<a name="l02150"></a>02150         $path = str_replace(<span class="stringliteral">&#39;http://&#39;</span>, <span class="stringliteral">&#39;https://&#39;</span>, $path);
<a name="l02151"></a>02151       }
<a name="l02152"></a>02152       elseif ($options[<span class="stringliteral">&#39;https&#39;</span>] === FALSE) {
<a name="l02153"></a>02153         $path = str_replace(<span class="stringliteral">&#39;https://&#39;</span>, <span class="stringliteral">&#39;http://&#39;</span>, $path);
<a name="l02154"></a>02154       }
<a name="l02155"></a>02155     }
<a name="l02156"></a>02156     <span class="comment">// Reassemble.</span>
<a name="l02157"></a>02157     <span class="keywordflow">return</span> $path . $options[<span class="stringliteral">&#39;fragment&#39;</span>];
<a name="l02158"></a>02158   }
<a name="l02159"></a>02159 
<a name="l02160"></a>02160   global $base_url, $base_secure_url, $base_insecure_url;
<a name="l02161"></a>02161 
<a name="l02162"></a>02162   <span class="comment">// The base_url might be rewritten from the language rewrite in domain mode.</span>
<a name="l02163"></a>02163   <span class="keywordflow">if</span> (!isset($options[<span class="stringliteral">&#39;base_url&#39;</span>])) {
<a name="l02164"></a>02164     <span class="keywordflow">if</span> (isset($options[<span class="stringliteral">&#39;https&#39;</span>]) &amp;&amp; <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;https&#39;</span>, FALSE)) {
<a name="l02165"></a>02165       <span class="keywordflow">if</span> ($options[<span class="stringliteral">&#39;https&#39;</span>] === TRUE) {
<a name="l02166"></a>02166         $options[<span class="stringliteral">&#39;base_url&#39;</span>] = $base_secure_url;
<a name="l02167"></a>02167         $options[<span class="stringliteral">&#39;absolute&#39;</span>] = TRUE;
<a name="l02168"></a>02168       }
<a name="l02169"></a>02169       elseif ($options[<span class="stringliteral">&#39;https&#39;</span>] === FALSE) {
<a name="l02170"></a>02170         $options[<span class="stringliteral">&#39;base_url&#39;</span>] = $base_insecure_url;
<a name="l02171"></a>02171         $options[<span class="stringliteral">&#39;absolute&#39;</span>] = TRUE;
<a name="l02172"></a>02172       }
<a name="l02173"></a>02173     }
<a name="l02174"></a>02174     <span class="keywordflow">else</span> {
<a name="l02175"></a>02175       $options[<span class="stringliteral">&#39;base_url&#39;</span>] = $base_url;
<a name="l02176"></a>02176     }
<a name="l02177"></a>02177   }
<a name="l02178"></a>02178 
<a name="l02179"></a>02179   <span class="comment">// The special path &#39;&lt;front&gt;&#39; links to the default front page.</span>
<a name="l02180"></a>02180   <span class="keywordflow">if</span> ($path == <span class="stringliteral">&#39;&lt;front&gt;&#39;</span>) {
<a name="l02181"></a>02181     $path = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02182"></a>02182   }
<a name="l02183"></a>02183   elseif (!empty($path) &amp;&amp; !$options[<span class="stringliteral">&#39;alias&#39;</span>]) {
<a name="l02184"></a>02184     $language = isset($options[<span class="stringliteral">&#39;language&#39;</span>]) &amp;&amp; isset($options[<span class="stringliteral">&#39;language&#39;</span>]-&gt;language) ? $options[<span class="stringliteral">&#39;language&#39;</span>]-&gt;language : <span class="stringliteral">&#39;&#39;</span>;
<a name="l02185"></a>02185     $alias = <a class="code" href="path_8inc_a889ab7f9eebf37ac353abc264a290131.html#a889ab7f9eebf37ac353abc264a290131" title="Given an internal Drupal path, return the alias set by the administrator.">drupal_get_path_alias</a>($original_path, $language);
<a name="l02186"></a>02186     <span class="keywordflow">if</span> ($alias != $original_path) {
<a name="l02187"></a>02187       $path = $alias;
<a name="l02188"></a>02188     }
<a name="l02189"></a>02189   }
<a name="l02190"></a>02190 
<a name="l02191"></a>02191   $base = $options[<span class="stringliteral">&#39;absolute&#39;</span>] ? $options[<span class="stringliteral">&#39;base_url&#39;</span>] . <span class="charliteral">&#39;/&#39;</span> : <a class="code" href="common_8inc_ae227697e9c239f09fd7e36f71afde771.html#ae227697e9c239f09fd7e36f71afde771" title="Returns the base URL path (i.e., directory) of the Drupal installation.">base_path</a>();
<a name="l02192"></a>02192   $prefix = empty($path) ? rtrim($options[<span class="stringliteral">&#39;prefix&#39;</span>], <span class="charliteral">&#39;/&#39;</span>) : $options[<span class="stringliteral">&#39;prefix&#39;</span>];
<a name="l02193"></a>02193 
<a name="l02194"></a>02194   <span class="comment">// With Clean URLs.</span>
<a name="l02195"></a>02195   <span class="keywordflow">if</span> (!empty($GLOBALS[<span class="stringliteral">&#39;conf&#39;</span>][<span class="stringliteral">&#39;clean_url&#39;</span>])) {
<a name="l02196"></a>02196     $path = <a class="code" href="group__http__handling_gab333a51385bd4e339c464943553a6670.html#gab333a51385bd4e339c464943553a6670" title="Encodes a Drupal path for use in a URL.">drupal_encode_path</a>($prefix . $path);
<a name="l02197"></a>02197     <span class="keywordflow">if</span> ($options[<span class="stringliteral">&#39;query&#39;</span>]) {
<a name="l02198"></a>02198       <span class="keywordflow">return</span> $base . $path . <span class="charliteral">&#39;?&#39;</span> . <a class="code" href="group__php__wrappers_gada763092b76d70856870eb3afa2ad265.html#gada763092b76d70856870eb3afa2ad265" title="Parses an array into a valid, rawurlencoded query string.">drupal_http_build_query</a>($options[<span class="stringliteral">&#39;query&#39;</span>]) . $options[<span class="stringliteral">&#39;fragment&#39;</span>];
<a name="l02199"></a>02199     }
<a name="l02200"></a>02200     <span class="keywordflow">else</span> {
<a name="l02201"></a>02201       <span class="keywordflow">return</span> $base . $path . $options[<span class="stringliteral">&#39;fragment&#39;</span>];
<a name="l02202"></a>02202     }
<a name="l02203"></a>02203   }
<a name="l02204"></a>02204   <span class="comment">// Without Clean URLs.</span>
<a name="l02205"></a>02205   <span class="keywordflow">else</span> {
<a name="l02206"></a>02206     $path = $prefix . $path;
<a name="l02207"></a>02207     $query = array();
<a name="l02208"></a>02208     <span class="keywordflow">if</span> (!empty($path)) {
<a name="l02209"></a>02209       $query[<span class="charliteral">&#39;q&#39;</span>] = $path;
<a name="l02210"></a>02210     }
<a name="l02211"></a>02211     <span class="keywordflow">if</span> ($options[<span class="stringliteral">&#39;query&#39;</span>]) {
<a name="l02212"></a>02212       <span class="comment">// We do not use array_merge() here to prevent overriding $path via query</span>
<a name="l02213"></a>02213       <span class="comment">// parameters.</span>
<a name="l02214"></a>02214       $query += $options[<span class="stringliteral">&#39;query&#39;</span>];
<a name="l02215"></a>02215     }
<a name="l02216"></a>02216     $query = $query ? (<span class="charliteral">&#39;?&#39;</span> . <a class="code" href="group__php__wrappers_gada763092b76d70856870eb3afa2ad265.html#gada763092b76d70856870eb3afa2ad265" title="Parses an array into a valid, rawurlencoded query string.">drupal_http_build_query</a>($query)) : <span class="stringliteral">&#39;&#39;</span>;
<a name="l02217"></a>02217     $script = isset($options[<span class="stringliteral">&#39;script&#39;</span>]) ? $options[<span class="stringliteral">&#39;script&#39;</span>] : <span class="stringliteral">&#39;&#39;</span>;
<a name="l02218"></a>02218     <span class="keywordflow">return</span> $base . $script . $query . $options[<span class="stringliteral">&#39;fragment&#39;</span>];
<a name="l02219"></a>02219   }
<a name="l02220"></a>02220 }
<a name="l02221"></a>02221 
<a name="l02235"></a><a class="code" href="common_8inc_a64a2003ba42a719fc38a046a3507ad56.html#a64a2003ba42a719fc38a046a3507ad56">02235</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a64a2003ba42a719fc38a046a3507ad56.html#a64a2003ba42a719fc38a046a3507ad56" title="Returns TRUE if a path is external to Drupal (e.g.">url_is_external</a>($path) {
<a name="l02236"></a>02236   $colonpos = strpos($path, <span class="charliteral">&#39;:&#39;</span>);
<a name="l02237"></a>02237   <span class="comment">// Avoid calling drupal_strip_dangerous_protocols() if there is any</span>
<a name="l02238"></a>02238   <span class="comment">// slash (/), hash (#) or question_mark (?) before the colon (:)</span>
<a name="l02239"></a>02239   <span class="comment">// occurrence - if any - as this would clearly mean it is not a URL.</span>
<a name="l02240"></a>02240   <span class="keywordflow">return</span> $colonpos !== FALSE &amp;&amp; !preg_match(<span class="stringliteral">&#39;![/?#]!&#39;</span>, substr($path, 0, $colonpos)) &amp;&amp; <a class="code" href="group__sanitization_ga46ff2822d576a77317f9045d65317b4f.html#ga46ff2822d576a77317f9045d65317b4f" title="Strips dangerous protocols (e.g.">drupal_strip_dangerous_protocols</a>($path) == $path;
<a name="l02241"></a>02241 }
<a name="l02242"></a>02242 
<a name="l02255"></a><a class="code" href="common_8inc_a70f1ffdd840f920428c2a709f26125dc.html#a70f1ffdd840f920428c2a709f26125dc">02255</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a70f1ffdd840f920428c2a709f26125dc.html#a70f1ffdd840f920428c2a709f26125dc" title="Formats an attribute string for an HTTP header.">drupal_http_header_attributes</a>(array $attributes = array()) {
<a name="l02256"></a>02256   <span class="keywordflow">foreach</span> ($attributes as $attribute =&gt; &amp;$data) {
<a name="l02257"></a>02257     <span class="keywordflow">if</span> (is_array($data)) {
<a name="l02258"></a>02258       $data = implode(<span class="charliteral">&#39; &#39;</span>, $data);
<a name="l02259"></a>02259     }
<a name="l02260"></a>02260     $data = $attribute . <span class="stringliteral">&#39;=&quot;&#39;</span> . $data . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02261"></a>02261   }
<a name="l02262"></a>02262   <span class="keywordflow">return</span> $attributes ? <span class="charliteral">&#39; &#39;</span> . implode(<span class="stringliteral">&#39;; &#39;</span>, $attributes) : <span class="stringliteral">&#39;&#39;</span>;
<a name="l02263"></a>02263 }
<a name="l02264"></a>02264 
<a name="l02301"></a><a class="code" href="group__sanitization_gacf11629fb3d1ebf200863e2d15380b4a.html#gacf11629fb3d1ebf200863e2d15380b4a">02301</a> <span class="keyword">function</span> <a class="code" href="group__sanitization_gacf11629fb3d1ebf200863e2d15380b4a.html#gacf11629fb3d1ebf200863e2d15380b4a" title="Converts an associative array to an XML/HTML tag attribute string.">drupal_attributes</a>(array $attributes = array()) {
<a name="l02302"></a>02302   <span class="keywordflow">foreach</span> ($attributes as $attribute =&gt; &amp;$data) {
<a name="l02303"></a>02303     $data = implode(<span class="charliteral">&#39; &#39;</span>, (array) $data);
<a name="l02304"></a>02304     $data = $attribute . <span class="stringliteral">&#39;=&quot;&#39;</span> . <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>($data) . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l02305"></a>02305   }
<a name="l02306"></a>02306   <span class="keywordflow">return</span> $attributes ? <span class="charliteral">&#39; &#39;</span> . implode(<span class="charliteral">&#39; &#39;</span>, $attributes) : <span class="stringliteral">&#39;&#39;</span>;
<a name="l02307"></a>02307 }
<a name="l02308"></a>02308 
<a name="l02345"></a><a class="code" href="common_8inc_ad3b36c06dc46250b8d22b8d0d2e7bd97.html#ad3b36c06dc46250b8d22b8d0d2e7bd97">02345</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ad3b36c06dc46250b8d22b8d0d2e7bd97.html#ad3b36c06dc46250b8d22b8d0d2e7bd97" title="Formats an internal or external URL link as an HTML anchor tag.">l</a>($text, $path, array $options = array()) {
<a name="l02346"></a>02346   global $language_url;
<a name="l02347"></a>02347   <span class="keyword">static</span> $use_theme = NULL;
<a name="l02348"></a>02348 
<a name="l02349"></a>02349   <span class="comment">// Merge in defaults.</span>
<a name="l02350"></a>02350   $options += array(
<a name="l02351"></a>02351     <span class="stringliteral">&#39;attributes&#39;</span> =&gt; array(),
<a name="l02352"></a>02352     <span class="stringliteral">&#39;html&#39;</span> =&gt; FALSE,
<a name="l02353"></a>02353   );
<a name="l02354"></a>02354 
<a name="l02355"></a>02355   <span class="comment">// Append active class.</span>
<a name="l02356"></a>02356   <span class="keywordflow">if</span> (($path == $_GET[<span class="charliteral">&#39;q&#39;</span>] || ($path == <span class="stringliteral">&#39;&lt;front&gt;&#39;</span> &amp;&amp; <a class="code" href="path_8inc_a657eb4770879ad6f0dc19bfad2cd4a6d.html#a657eb4770879ad6f0dc19bfad2cd4a6d" title="Check if the current page is the front page.">drupal_is_front_page</a>())) &amp;&amp;
<a name="l02357"></a>02357       (empty($options[<span class="stringliteral">&#39;language&#39;</span>]) || $options[<span class="stringliteral">&#39;language&#39;</span>]-&gt;language == $language_url-&gt;language)) {
<a name="l02358"></a>02358     $options[<span class="stringliteral">&#39;attributes&#39;</span>][<span class="stringliteral">&#39;class&#39;</span>][] = <span class="stringliteral">&#39;active&#39;</span>;
<a name="l02359"></a>02359   }
<a name="l02360"></a>02360 
<a name="l02361"></a>02361   <span class="comment">// Remove all HTML and PHP tags from a tooltip. For best performance, we act only</span>
<a name="l02362"></a>02362   <span class="comment">// if a quick strpos() pre-check gave a suspicion (because strip_tags() is expensive).</span>
<a name="l02363"></a>02363   <span class="keywordflow">if</span> (isset($options[<span class="stringliteral">&#39;attributes&#39;</span>][<span class="stringliteral">&#39;title&#39;</span>]) &amp;&amp; strpos($options[<span class="stringliteral">&#39;attributes&#39;</span>][<span class="stringliteral">&#39;title&#39;</span>], <span class="charliteral">&#39;&lt;&#39;</span>) !== FALSE) {
<a name="l02364"></a>02364     $options[<span class="stringliteral">&#39;attributes&#39;</span>][<span class="stringliteral">&#39;title&#39;</span>] = strip_tags($options[<span class="stringliteral">&#39;attributes&#39;</span>][<span class="stringliteral">&#39;title&#39;</span>]);
<a name="l02365"></a>02365   }
<a name="l02366"></a>02366 
<a name="l02367"></a>02367   <span class="comment">// Determine if rendering of the link is to be done with a theme function</span>
<a name="l02368"></a>02368   <span class="comment">// or the inline default. Inline is faster, but if the theme system has been</span>
<a name="l02369"></a>02369   <span class="comment">// loaded and a module or theme implements a preprocess or process function</span>
<a name="l02370"></a>02370   <span class="comment">// or overrides the theme_link() function, then invoke theme(). Preliminary</span>
<a name="l02371"></a>02371   <span class="comment">// benchmarks indicate that invoking theme() can slow down the l() function</span>
<a name="l02372"></a>02372   <span class="comment">// by 20% or more, and that some of the link-heavy Drupal pages spend more</span>
<a name="l02373"></a>02373   <span class="comment">// than 10% of the total page request time in the l() function.</span>
<a name="l02374"></a>02374   <span class="keywordflow">if</span> (!isset($use_theme) &amp;&amp; function_exists(<span class="stringliteral">&#39;theme&#39;</span>)) {
<a name="l02375"></a>02375     <span class="comment">// Allow edge cases to prevent theme initialization and force inline link</span>
<a name="l02376"></a>02376     <span class="comment">// rendering.</span>
<a name="l02377"></a>02377     <span class="keywordflow">if</span> (<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;theme_link&#39;</span>, TRUE)) {
<a name="l02378"></a>02378       <a class="code" href="theme_8inc_a9e48961b3be3ca78f434b047fbb8463f.html#a9e48961b3be3ca78f434b047fbb8463f" title="Initialize the theme system by loading the theme.">drupal_theme_initialize</a>();
<a name="l02379"></a>02379       $registry = <a class="code" href="theme_8inc_ae532c57b7a0288c1a359da1e2a70a0b1.html#ae532c57b7a0288c1a359da1e2a70a0b1" title="Get the theme registry.">theme_get_registry</a>(FALSE);
<a name="l02380"></a>02380       <span class="comment">// We don&#39;t want to duplicate functionality that&#39;s in theme(), so any</span>
<a name="l02381"></a>02381       <span class="comment">// hint of a module or theme doing anything at all special with the &#39;link&#39;</span>
<a name="l02382"></a>02382       <span class="comment">// theme hook should simply result in theme() being called. This includes</span>
<a name="l02383"></a>02383       <span class="comment">// the overriding of theme_link() with an alternate function or template,</span>
<a name="l02384"></a>02384       <span class="comment">// the presence of preprocess or process functions, or the presence of</span>
<a name="l02385"></a>02385       <span class="comment">// include files.</span>
<a name="l02386"></a>02386       $use_theme = !isset($registry[<span class="stringliteral">&#39;link&#39;</span>][<span class="stringliteral">&#39;function&#39;</span>]) || ($registry[<span class="stringliteral">&#39;link&#39;</span>][<span class="stringliteral">&#39;function&#39;</span>] != <span class="stringliteral">&#39;theme_link&#39;</span>);
<a name="l02387"></a>02387       $use_theme = $use_theme || !empty($registry[<span class="stringliteral">&#39;link&#39;</span>][<span class="stringliteral">&#39;preprocess functions&#39;</span>]) || !empty($registry[<span class="stringliteral">&#39;link&#39;</span>][<span class="stringliteral">&#39;process functions&#39;</span>]) || !empty($registry[<span class="stringliteral">&#39;link&#39;</span>][<span class="stringliteral">&#39;includes&#39;</span>]);
<a name="l02388"></a>02388     }
<a name="l02389"></a>02389     <span class="keywordflow">else</span> {
<a name="l02390"></a>02390       $use_theme = FALSE;
<a name="l02391"></a>02391     }
<a name="l02392"></a>02392   }
<a name="l02393"></a>02393   <span class="keywordflow">if</span> ($use_theme) {
<a name="l02394"></a>02394     <span class="keywordflow">return</span> <a class="code" href="theme_8inc_a7c25609a935874541a19657affd30fff.html#a7c25609a935874541a19657affd30fff" title="Generates themed output.">theme</a>(<span class="stringliteral">&#39;link&#39;</span>, array(<span class="stringliteral">&#39;text&#39;</span> =&gt; $text, <span class="stringliteral">&#39;path&#39;</span> =&gt; $path, <span class="stringliteral">&#39;options&#39;</span> =&gt; $options));
<a name="l02395"></a>02395   }
<a name="l02396"></a>02396   <span class="comment">// The result of url() is a plain-text URL. Because we are using it here</span>
<a name="l02397"></a>02397   <span class="comment">// in an HTML argument context, we need to encode it properly.</span>
<a name="l02398"></a>02398   <span class="keywordflow">return</span> <span class="stringliteral">&#39;&lt;a href=&quot;&#39;</span> . <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>(<a class="code" href="common_8inc_a43b2a0594431556db49df980801d8807.html#a43b2a0594431556db49df980801d8807" title="End of &quot;defgroup format&quot;.">url</a>($path, $options)) . <span class="charliteral">&#39;&quot;&#39;</span> . <a class="code" href="group__sanitization_gacf11629fb3d1ebf200863e2d15380b4a.html#gacf11629fb3d1ebf200863e2d15380b4a" title="Converts an associative array to an XML/HTML tag attribute string.">drupal_attributes</a>($options[<span class="stringliteral">&#39;attributes&#39;</span>]) . <span class="charliteral">&#39;&gt;&#39;</span> . ($options[<span class="stringliteral">&#39;html&#39;</span>] ? $text : <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>($text)) . <span class="stringliteral">&#39;&lt;/a&gt;&#39;</span>;
<a name="l02399"></a>02399 }
<a name="l02400"></a>02400 
<a name="l02467"></a><a class="code" href="common_8inc_a1537b4ccc064fb7d8106effcac8caac3.html#a1537b4ccc064fb7d8106effcac8caac3">02467</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a1537b4ccc064fb7d8106effcac8caac3.html#a1537b4ccc064fb7d8106effcac8caac3" title="Delivers a page callback result to the browser in the appropriate format.">drupal_deliver_page</a>($page_callback_result, $default_delivery_callback = NULL) {
<a name="l02468"></a>02468   <span class="keywordflow">if</span> (!isset($default_delivery_callback) &amp;&amp; ($router_item = <a class="code" href="group__menu_ga855b1ca6ef9e44eb6107a2b9d0f581df.html#ga855b1ca6ef9e44eb6107a2b9d0f581df" title="Get a router item.">menu_get_item</a>())) {
<a name="l02469"></a>02469     $default_delivery_callback = $router_item[<span class="stringliteral">&#39;delivery_callback&#39;</span>];
<a name="l02470"></a>02470   }
<a name="l02471"></a>02471   $delivery_callback = !empty($default_delivery_callback) ? $default_delivery_callback : <span class="stringliteral">&#39;drupal_deliver_html_page&#39;</span>;
<a name="l02472"></a>02472   <span class="comment">// Give modules a chance to alter the delivery callback used, based on</span>
<a name="l02473"></a>02473   <span class="comment">// request-time context (e.g., HTTP request headers).</span>
<a name="l02474"></a>02474   <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;page_delivery_callback&#39;</span>, $delivery_callback);
<a name="l02475"></a>02475   <span class="keywordflow">if</span> (function_exists($delivery_callback)) {
<a name="l02476"></a>02476     $delivery_callback($page_callback_result);
<a name="l02477"></a>02477   }
<a name="l02478"></a>02478   <span class="keywordflow">else</span> {
<a name="l02479"></a>02479     <span class="comment">// If a delivery callback is specified, but doesn&#39;t exist as a function,</span>
<a name="l02480"></a>02480     <span class="comment">// something is wrong, but don&#39;t print anything, since it&#39;s not known</span>
<a name="l02481"></a>02481     <span class="comment">// what format the response needs to be in.</span>
<a name="l02482"></a>02482     <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;delivery callback not found&#39;</span>, <span class="stringliteral">&#39;callback %callback not found: %q.&#39;</span>, array(<span class="stringliteral">&#39;%callback&#39;</span> =&gt; $delivery_callback, <span class="stringliteral">&#39;%q&#39;</span> =&gt; $_GET[<span class="charliteral">&#39;q&#39;</span>]), <a class="code" href="group__logging__severity__levels_ga174c9df2936096e11986fcf184d48576.html#ga174c9df2936096e11986fcf184d48576" title="Log message severity -- Error conditions.">WATCHDOG_ERROR</a>);
<a name="l02483"></a>02483   }
<a name="l02484"></a>02484 }
<a name="l02485"></a>02485 
<a name="l02498"></a><a class="code" href="common_8inc_a05ab0d6e81d6cbe2a6b9f645b9e710ec.html#a05ab0d6e81d6cbe2a6b9f645b9e710ec">02498</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a05ab0d6e81d6cbe2a6b9f645b9e710ec.html#a05ab0d6e81d6cbe2a6b9f645b9e710ec" title="Packages and sends the result of a page callback to the browser as HTML.">drupal_deliver_html_page</a>($page_callback_result) {
<a name="l02499"></a>02499   <span class="comment">// Emit the correct charset HTTP header, but not if the page callback</span>
<a name="l02500"></a>02500   <span class="comment">// result is NULL, since that likely indicates that it printed something</span>
<a name="l02501"></a>02501   <span class="comment">// in which case, no further headers may be sent, and not if code running</span>
<a name="l02502"></a>02502   <span class="comment">// for this page request has already set the content type header.</span>
<a name="l02503"></a>02503   <span class="keywordflow">if</span> (isset($page_callback_result) &amp;&amp; is_null(<a class="code" href="bootstrap_8inc_a159cce492ef9bed6e8a1dd33227fd11e.html#a159cce492ef9bed6e8a1dd33227fd11e" title="Gets the HTTP response headers for the current page.">drupal_get_http_header</a>(<span class="stringliteral">&#39;Content-Type&#39;</span>))) {
<a name="l02504"></a>02504     <a class="code" href="bootstrap_8inc_ad4ff2b2cf5a2fb632c2c869bc1a5a70f.html#ad4ff2b2cf5a2fb632c2c869bc1a5a70f" title="Sets an HTTP response header for the current page.">drupal_add_http_header</a>(<span class="stringliteral">&#39;Content-Type&#39;</span>, <span class="stringliteral">&#39;text/html; charset=utf-8&#39;</span>);
<a name="l02505"></a>02505   }
<a name="l02506"></a>02506 
<a name="l02507"></a>02507   <span class="comment">// Send appropriate HTTP-Header for browsers and search engines.</span>
<a name="l02508"></a>02508   global $language;
<a name="l02509"></a>02509   <a class="code" href="bootstrap_8inc_ad4ff2b2cf5a2fb632c2c869bc1a5a70f.html#ad4ff2b2cf5a2fb632c2c869bc1a5a70f" title="Sets an HTTP response header for the current page.">drupal_add_http_header</a>(<span class="stringliteral">&#39;Content-Language&#39;</span>, $language-&gt;language);
<a name="l02510"></a>02510 
<a name="l02511"></a>02511   <span class="comment">// Menu status constants are integers; page content is a string or array.</span>
<a name="l02512"></a>02512   <span class="keywordflow">if</span> (is_int($page_callback_result)) {
<a name="l02513"></a>02513     <span class="comment">// @todo: Break these up into separate functions?</span>
<a name="l02514"></a>02514     <span class="keywordflow">switch</span> ($page_callback_result) {
<a name="l02515"></a>02515       <span class="keywordflow">case</span> <a class="code" href="group__menu__status__codes_ga67a38f79c8ab91fb6230daaaad6176f4.html#ga67a38f79c8ab91fb6230daaaad6176f4" title="Internal menu status code -- Menu item was not found.">MENU_NOT_FOUND</a>:
<a name="l02516"></a>02516         <span class="comment">// Print a 404 page.</span>
<a name="l02517"></a>02517         <a class="code" href="bootstrap_8inc_ad4ff2b2cf5a2fb632c2c869bc1a5a70f.html#ad4ff2b2cf5a2fb632c2c869bc1a5a70f" title="Sets an HTTP response header for the current page.">drupal_add_http_header</a>(<span class="stringliteral">&#39;Status&#39;</span>, <span class="stringliteral">&#39;404 Not Found&#39;</span>);
<a name="l02518"></a>02518 
<a name="l02519"></a>02519         <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;page not found&#39;</span>, <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>($_GET[<span class="charliteral">&#39;q&#39;</span>]), NULL, <a class="code" href="group__logging__severity__levels_ga5361f835e10b39b553ee73c1b9414bf1.html#ga5361f835e10b39b553ee73c1b9414bf1" title="Log message severity -- Warning conditions.">WATCHDOG_WARNING</a>);
<a name="l02520"></a>02520 
<a name="l02521"></a>02521         <span class="comment">// Check for and return a fast 404 page if configured.</span>
<a name="l02522"></a>02522         <a class="code" href="bootstrap_8inc_a1b7e5fe865e978d10be87d3eb57e42f7.html#a1b7e5fe865e978d10be87d3eb57e42f7" title="Returns a simple 404 Not Found page.">drupal_fast_404</a>();
<a name="l02523"></a>02523 
<a name="l02524"></a>02524         <span class="comment">// Keep old path for reference, and to allow forms to redirect to it.</span>
<a name="l02525"></a>02525         <span class="keywordflow">if</span> (!isset($_GET[<span class="stringliteral">&#39;destination&#39;</span>])) {
<a name="l02526"></a>02526           $_GET[<span class="stringliteral">&#39;destination&#39;</span>] = $_GET[<span class="charliteral">&#39;q&#39;</span>];
<a name="l02527"></a>02527         }
<a name="l02528"></a>02528 
<a name="l02529"></a>02529         $path = <a class="code" href="path_8inc_a59781811cbcdef4c64ccd1d55e1ae9f8.html#a59781811cbcdef4c64ccd1d55e1ae9f8" title="Given a path alias, return the internal path it represents.">drupal_get_normal_path</a>(<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;site_404&#39;</span>, <span class="stringliteral">&#39;&#39;</span>));
<a name="l02530"></a>02530         <span class="keywordflow">if</span> ($path &amp;&amp; $path != $_GET[<span class="charliteral">&#39;q&#39;</span>]) {
<a name="l02531"></a>02531           <span class="comment">// Custom 404 handler. Set the active item in case there are tabs to</span>
<a name="l02532"></a>02532           <span class="comment">// display, or other dependencies on the path.</span>
<a name="l02533"></a>02533           <a class="code" href="group__menu_gacdd22102c2ba6545645ae34be563d1d4.html#gacdd22102c2ba6545645ae34be563d1d4" title="Set the active path, which determines which page is loaded.">menu_set_active_item</a>($path);
<a name="l02534"></a>02534           $return = <a class="code" href="group__menu_gae33bae24fcac6126aa272d1c437f947c.html#gae33bae24fcac6126aa272d1c437f947c" title="Execute the page callback associated with the current path.">menu_execute_active_handler</a>($path, FALSE);
<a name="l02535"></a>02535         }
<a name="l02536"></a>02536 
<a name="l02537"></a>02537         <span class="keywordflow">if</span> (empty($return) || $return == <a class="code" href="group__menu__status__codes_ga67a38f79c8ab91fb6230daaaad6176f4.html#ga67a38f79c8ab91fb6230daaaad6176f4" title="Internal menu status code -- Menu item was not found.">MENU_NOT_FOUND</a> || $return == <a class="code" href="group__menu__status__codes_ga87e8c6c6b42f3399cbe817d4d19cd892.html#ga87e8c6c6b42f3399cbe817d4d19cd892" title="Internal menu status code -- Menu item access is denied.">MENU_ACCESS_DENIED</a>) {
<a name="l02538"></a>02538           <span class="comment">// Standard 404 handler.</span>
<a name="l02539"></a>02539           <a class="code" href="bootstrap_8inc_a1994d49eb621df71fe1306e13b7e4910.html#a1994d49eb621df71fe1306e13b7e4910" title="Sets the title of the current page.">drupal_set_title</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Page not found&#39;</span>));
<a name="l02540"></a>02540           $return = <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The requested page &quot;@path&quot; could not be found.&#39;</span>, array(<span class="stringliteral">&#39;@path&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a80b52d5331d840440b5e3dfe82dd7ea2.html#a80b52d5331d840440b5e3dfe82dd7ea2" title="Returns the equivalent of Apache&#39;s $_SERVER[&#39;REQUEST_URI&#39;] variable.">request_uri</a>()));
<a name="l02541"></a>02541         }
<a name="l02542"></a>02542 
<a name="l02543"></a>02543         <a class="code" href="common_8inc_a87c72c30529e99da7d4b25b6c1e00b1d.html#a87c72c30529e99da7d4b25b6c1e00b1d" title="Sets the main page content value for later use.">drupal_set_page_content</a>($return);
<a name="l02544"></a>02544         $page = <a class="code" href="common_8inc_a5745b4e27c2946a902d49c0923f46739.html#a5745b4e27c2946a902d49c0923f46739" title="Retrieves the default properties for the defined element type.">element_info</a>(<span class="stringliteral">&#39;page&#39;</span>);
<a name="l02545"></a>02545         print <a class="code" href="common_8inc_ad85d021b660f070849ed7c215d9758fe.html#ad85d021b660f070849ed7c215d9758fe" title="Renders the page, including all theming.">drupal_render_page</a>($page);
<a name="l02546"></a>02546         <span class="keywordflow">break</span>;
<a name="l02547"></a>02547 
<a name="l02548"></a>02548       <span class="keywordflow">case</span> <a class="code" href="group__menu__status__codes_ga87e8c6c6b42f3399cbe817d4d19cd892.html#ga87e8c6c6b42f3399cbe817d4d19cd892" title="Internal menu status code -- Menu item access is denied.">MENU_ACCESS_DENIED</a>:
<a name="l02549"></a>02549         <span class="comment">// Print a 403 page.</span>
<a name="l02550"></a>02550         <a class="code" href="bootstrap_8inc_ad4ff2b2cf5a2fb632c2c869bc1a5a70f.html#ad4ff2b2cf5a2fb632c2c869bc1a5a70f" title="Sets an HTTP response header for the current page.">drupal_add_http_header</a>(<span class="stringliteral">&#39;Status&#39;</span>, <span class="stringliteral">&#39;403 Forbidden&#39;</span>);
<a name="l02551"></a>02551         <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;access denied&#39;</span>, <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>($_GET[<span class="charliteral">&#39;q&#39;</span>]), NULL, <a class="code" href="group__logging__severity__levels_ga5361f835e10b39b553ee73c1b9414bf1.html#ga5361f835e10b39b553ee73c1b9414bf1" title="Log message severity -- Warning conditions.">WATCHDOG_WARNING</a>);
<a name="l02552"></a>02552 
<a name="l02553"></a>02553         <span class="comment">// Keep old path for reference, and to allow forms to redirect to it.</span>
<a name="l02554"></a>02554         <span class="keywordflow">if</span> (!isset($_GET[<span class="stringliteral">&#39;destination&#39;</span>])) {
<a name="l02555"></a>02555           $_GET[<span class="stringliteral">&#39;destination&#39;</span>] = $_GET[<span class="charliteral">&#39;q&#39;</span>];
<a name="l02556"></a>02556         }
<a name="l02557"></a>02557 
<a name="l02558"></a>02558         $path = <a class="code" href="path_8inc_a59781811cbcdef4c64ccd1d55e1ae9f8.html#a59781811cbcdef4c64ccd1d55e1ae9f8" title="Given a path alias, return the internal path it represents.">drupal_get_normal_path</a>(<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;site_403&#39;</span>, <span class="stringliteral">&#39;&#39;</span>));
<a name="l02559"></a>02559         <span class="keywordflow">if</span> ($path &amp;&amp; $path != $_GET[<span class="charliteral">&#39;q&#39;</span>]) {
<a name="l02560"></a>02560           <span class="comment">// Custom 403 handler. Set the active item in case there are tabs to</span>
<a name="l02561"></a>02561           <span class="comment">// display or other dependencies on the path.</span>
<a name="l02562"></a>02562           <a class="code" href="group__menu_gacdd22102c2ba6545645ae34be563d1d4.html#gacdd22102c2ba6545645ae34be563d1d4" title="Set the active path, which determines which page is loaded.">menu_set_active_item</a>($path);
<a name="l02563"></a>02563           $return = <a class="code" href="group__menu_gae33bae24fcac6126aa272d1c437f947c.html#gae33bae24fcac6126aa272d1c437f947c" title="Execute the page callback associated with the current path.">menu_execute_active_handler</a>($path, FALSE);
<a name="l02564"></a>02564         }
<a name="l02565"></a>02565 
<a name="l02566"></a>02566         <span class="keywordflow">if</span> (empty($return) || $return == <a class="code" href="group__menu__status__codes_ga67a38f79c8ab91fb6230daaaad6176f4.html#ga67a38f79c8ab91fb6230daaaad6176f4" title="Internal menu status code -- Menu item was not found.">MENU_NOT_FOUND</a> || $return == <a class="code" href="group__menu__status__codes_ga87e8c6c6b42f3399cbe817d4d19cd892.html#ga87e8c6c6b42f3399cbe817d4d19cd892" title="Internal menu status code -- Menu item access is denied.">MENU_ACCESS_DENIED</a>) {
<a name="l02567"></a>02567           <span class="comment">// Standard 403 handler.</span>
<a name="l02568"></a>02568           <a class="code" href="bootstrap_8inc_a1994d49eb621df71fe1306e13b7e4910.html#a1994d49eb621df71fe1306e13b7e4910" title="Sets the title of the current page.">drupal_set_title</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Access denied&#39;</span>));
<a name="l02569"></a>02569           $return = <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;You are not authorized to access this page.&#39;</span>);
<a name="l02570"></a>02570         }
<a name="l02571"></a>02571 
<a name="l02572"></a>02572         print <a class="code" href="common_8inc_ad85d021b660f070849ed7c215d9758fe.html#ad85d021b660f070849ed7c215d9758fe" title="Renders the page, including all theming.">drupal_render_page</a>($return);
<a name="l02573"></a>02573         <span class="keywordflow">break</span>;
<a name="l02574"></a>02574 
<a name="l02575"></a>02575       <span class="keywordflow">case</span> <a class="code" href="group__menu__status__codes_gad6222551ed027f4f367e11b11935cff9.html#gad6222551ed027f4f367e11b11935cff9" title="Internal menu status code -- Menu item inaccessible because site is offline.">MENU_SITE_OFFLINE</a>:
<a name="l02576"></a>02576         <span class="comment">// Print a 503 page.</span>
<a name="l02577"></a>02577         <a class="code" href="bootstrap_8inc_a861d3f7c553fe62829f6c0f2e4fe89e6.html#a861d3f7c553fe62829f6c0f2e4fe89e6" title="Enables use of the theme system without requiring database access.">drupal_maintenance_theme</a>();
<a name="l02578"></a>02578         <a class="code" href="bootstrap_8inc_ad4ff2b2cf5a2fb632c2c869bc1a5a70f.html#ad4ff2b2cf5a2fb632c2c869bc1a5a70f" title="Sets an HTTP response header for the current page.">drupal_add_http_header</a>(<span class="stringliteral">&#39;Status&#39;</span>, <span class="stringliteral">&#39;503 Service unavailable&#39;</span>);
<a name="l02579"></a>02579         <a class="code" href="bootstrap_8inc_a1994d49eb621df71fe1306e13b7e4910.html#a1994d49eb621df71fe1306e13b7e4910" title="Sets the title of the current page.">drupal_set_title</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Site under maintenance&#39;</span>));
<a name="l02580"></a>02580         print <a class="code" href="theme_8inc_a7c25609a935874541a19657affd30fff.html#a7c25609a935874541a19657affd30fff" title="Generates themed output.">theme</a>(<span class="stringliteral">&#39;maintenance_page&#39;</span>, array(<span class="stringliteral">&#39;content&#39;</span> =&gt; <a class="code" href="group__sanitization_ga97dcceb77b76539219af2a85eacbe18d.html#ga97dcceb77b76539219af2a85eacbe18d" title="Applies a very permissive XSS/HTML filter for admin-only use.">filter_xss_admin</a>(<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;maintenance_mode_message&#39;</span>,
<a name="l02581"></a>02581           <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;@site is currently under maintenance. We should be back shortly. Thank you for your patience.&#39;</span>, array(<span class="stringliteral">&#39;@site&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;site_name&#39;</span>, <span class="stringliteral">&#39;Drupal&#39;</span>)))))));
<a name="l02582"></a>02582         <span class="keywordflow">break</span>;
<a name="l02583"></a>02583     }
<a name="l02584"></a>02584   }
<a name="l02585"></a>02585   elseif (isset($page_callback_result)) {
<a name="l02586"></a>02586     <span class="comment">// Print anything besides a menu constant, assuming it&#39;s not NULL or</span>
<a name="l02587"></a>02587     <span class="comment">// undefined.</span>
<a name="l02588"></a>02588     print <a class="code" href="common_8inc_ad85d021b660f070849ed7c215d9758fe.html#ad85d021b660f070849ed7c215d9758fe" title="Renders the page, including all theming.">drupal_render_page</a>($page_callback_result);
<a name="l02589"></a>02589   }
<a name="l02590"></a>02590 
<a name="l02591"></a>02591   <span class="comment">// Perform end-of-request tasks.</span>
<a name="l02592"></a>02592   <a class="code" href="common_8inc_a64bc7d539a74e850935d73968788abd3.html#a64bc7d539a74e850935d73968788abd3" title="Performs end-of-request tasks.">drupal_page_footer</a>();
<a name="l02593"></a>02593 }
<a name="l02594"></a>02594 
<a name="l02601"></a><a class="code" href="common_8inc_a64bc7d539a74e850935d73968788abd3.html#a64bc7d539a74e850935d73968788abd3">02601</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a64bc7d539a74e850935d73968788abd3.html#a64bc7d539a74e850935d73968788abd3" title="Performs end-of-request tasks.">drupal_page_footer</a>() {
<a name="l02602"></a>02602   global $user;
<a name="l02603"></a>02603 
<a name="l02604"></a>02604   <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;exit&#39;</span>);
<a name="l02605"></a>02605 
<a name="l02606"></a>02606   <span class="comment">// Commit the user session, if needed.</span>
<a name="l02607"></a>02607   <a class="code" href="session_8inc_ad6c0ee8cae83649ccfbc7f2eef268377.html#ad6c0ee8cae83649ccfbc7f2eef268377" title="Commits the current session, if necessary.">drupal_session_commit</a>();
<a name="l02608"></a>02608 
<a name="l02609"></a>02609   <span class="keywordflow">if</span> (<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;cache&#39;</span>, 0) &amp;&amp; ($cache = <a class="code" href="common_8inc_ac46363381db03a8d6a2663d031d8ce07.html#ac46363381db03a8d6a2663d031d8ce07" title="Stores the current page in the cache.">drupal_page_set_cache</a>())) {
<a name="l02610"></a>02610     <a class="code" href="bootstrap_8inc_ae09cf8051ec110fd6ce67f4a3b77a3fb.html#ae09cf8051ec110fd6ce67f4a3b77a3fb" title="Sets HTTP headers in preparation for a cached page response.">drupal_serve_page_from_cache</a>($cache);
<a name="l02611"></a>02611   }
<a name="l02612"></a>02612   <span class="keywordflow">else</span> {
<a name="l02613"></a>02613     ob_flush();
<a name="l02614"></a>02614   }
<a name="l02615"></a>02615 
<a name="l02616"></a>02616   <a class="code" href="group__registry_gac399c501a8a90c383ea9a901a3a45ed6.html#gac399c501a8a90c383ea9a901a3a45ed6" title="Checks for a resource in the registry.">_registry_check_code</a>(<a class="code" href="bootstrap_8inc_ab6acafa683cd17da2d120b9faf3e04c2.html#ab6acafa683cd17da2d120b9faf3e04c2" title="Signals that the registry lookup cache should be written to storage.">REGISTRY_WRITE_LOOKUP_CACHE</a>);
<a name="l02617"></a>02617   <a class="code" href="path_8inc_a60e3f93b8388973df3e4f98788fd5388.html#a60e3f93b8388973df3e4f98788fd5388" title="Cache system paths for a page.">drupal_cache_system_paths</a>();
<a name="l02618"></a>02618   <a class="code" href="group__hooks_ga993e46e78bf9dfb0e940c0dcccf5e33d.html#ga993e46e78bf9dfb0e940c0dcccf5e33d" title="Writes the hook implementation cache.">module_implements_write_cache</a>();
<a name="l02619"></a>02619   system_run_automated_cron();
<a name="l02620"></a>02620 }
<a name="l02621"></a>02621 
<a name="l02634"></a><a class="code" href="common_8inc_abe82fff35edd9a4da0d3fe4ef1a95614.html#abe82fff35edd9a4da0d3fe4ef1a95614">02634</a> <span class="keyword">function</span> <a class="code" href="common_8inc_abe82fff35edd9a4da0d3fe4ef1a95614.html#abe82fff35edd9a4da0d3fe4ef1a95614" title="Performs end-of-request tasks.">drupal_exit</a>($destination = NULL) {
<a name="l02635"></a>02635   <span class="keywordflow">if</span> (<a class="code" href="bootstrap_8inc_aef1090e39844ccfc688f9b93fd048d8d.html#aef1090e39844ccfc688f9b93fd048d8d" title="Returns the current bootstrap phase for this Drupal process.">drupal_get_bootstrap_phase</a>() == <a class="code" href="bootstrap_8inc_a2c8ac509af1924cf2fa7420a22e1b048.html#a2c8ac509af1924cf2fa7420a22e1b048" title="Final bootstrap phase: Drupal is fully loaded; validate and fix input data.">DRUPAL_BOOTSTRAP_FULL</a>) {
<a name="l02636"></a>02636     <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;MAINTENANCE_MODE&#39;</span>) || <a class="code" href="authorize_8php_a5bf6dfe9ba7ee16c648e3932aa76535d.html#a5bf6dfe9ba7ee16c648e3932aa76535d" title="Global flag to identify update.php and authorize.php runs, and so avoid various unwanted operations...">MAINTENANCE_MODE</a> != <span class="stringliteral">&#39;update&#39;</span>) {
<a name="l02637"></a>02637       <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;exit&#39;</span>, $destination);
<a name="l02638"></a>02638     }
<a name="l02639"></a>02639     <a class="code" href="session_8inc_ad6c0ee8cae83649ccfbc7f2eef268377.html#ad6c0ee8cae83649ccfbc7f2eef268377" title="Commits the current session, if necessary.">drupal_session_commit</a>();
<a name="l02640"></a>02640   }
<a name="l02641"></a>02641   exit;
<a name="l02642"></a>02642 }
<a name="l02643"></a>02643 
<a name="l02661"></a><a class="code" href="common_8inc_a72b55fe42aa726cc506660138abd3307.html#a72b55fe42aa726cc506660138abd3307">02661</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a72b55fe42aa726cc506660138abd3307.html#a72b55fe42aa726cc506660138abd3307" title="Forms an associative array from a linear array.">drupal_map_assoc</a>($array, $function = NULL) {
<a name="l02662"></a>02662   <span class="comment">// array_combine() fails with empty arrays:</span>
<a name="l02663"></a>02663   <span class="comment">// http://bugs.php.net/bug.php?id=34857.</span>
<a name="l02664"></a>02664   $array = !empty($array) ? array_combine($array, $array) : array();
<a name="l02665"></a>02665   <span class="keywordflow">if</span> (is_callable($function)) {
<a name="l02666"></a>02666     $array = array_map($function, $array);
<a name="l02667"></a>02667   }
<a name="l02668"></a>02668   <span class="keywordflow">return</span> $array;
<a name="l02669"></a>02669 }
<a name="l02670"></a>02670 
<a name="l02699"></a><a class="code" href="group__php__wrappers_ga0507eefd9cd1db602b2184d0fae35097.html#ga0507eefd9cd1db602b2184d0fae35097">02699</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_ga0507eefd9cd1db602b2184d0fae35097.html#ga0507eefd9cd1db602b2184d0fae35097" title="Attempts to set the PHP maximum execution time.">drupal_set_time_limit</a>($time_limit) {
<a name="l02700"></a>02700   <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;set_time_limit&#39;</span>)) {
<a name="l02701"></a>02701     @set_time_limit($time_limit);
<a name="l02702"></a>02702   }
<a name="l02703"></a>02703 }
<a name="l02704"></a>02704 
<a name="l02716"></a><a class="code" href="common_8inc_ae3bbe8f97bf07bb0eaf4580c98f9bf94.html#ae3bbe8f97bf07bb0eaf4580c98f9bf94">02716</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ae3bbe8f97bf07bb0eaf4580c98f9bf94.html#ae3bbe8f97bf07bb0eaf4580c98f9bf94" title="Returns the path to a system item (module, theme, etc.).">drupal_get_path</a>($type, $name) {
<a name="l02717"></a>02717   <span class="keywordflow">return</span> dirname(<a class="code" href="bootstrap_8inc_ae2af73b6b16cc9d723e931748aa6c853.html#ae2af73b6b16cc9d723e931748aa6c853" title="Returns and optionally sets the filename for a system resource.">drupal_get_filename</a>($type, $name));
<a name="l02718"></a>02718 }
<a name="l02719"></a>02719 
<a name="l02730"></a><a class="code" href="common_8inc_ae227697e9c239f09fd7e36f71afde771.html#ae227697e9c239f09fd7e36f71afde771">02730</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ae227697e9c239f09fd7e36f71afde771.html#ae227697e9c239f09fd7e36f71afde771" title="Returns the base URL path (i.e., directory) of the Drupal installation.">base_path</a>() {
<a name="l02731"></a>02731   <span class="keywordflow">return</span> $GLOBALS[<span class="stringliteral">&#39;base_path&#39;</span>];
<a name="l02732"></a>02732 }
<a name="l02733"></a>02733 
<a name="l02747"></a><a class="code" href="common_8inc_aad501b017775a67b155fe5e441f1ad9d.html#aad501b017775a67b155fe5e441f1ad9d">02747</a> <span class="keyword">function</span> <a class="code" href="common_8inc_aad501b017775a67b155fe5e441f1ad9d.html#aad501b017775a67b155fe5e441f1ad9d" title="Adds a LINK tag with a distinct &#39;rel&#39; attribute to the page&#39;s HEAD.">drupal_add_html_head_link</a>($attributes, $header = FALSE) {
<a name="l02748"></a>02748   $element = array(
<a name="l02749"></a>02749     <span class="stringliteral">&#39;#tag&#39;</span> =&gt; <span class="stringliteral">&#39;link&#39;</span>,
<a name="l02750"></a>02750     <span class="stringliteral">&#39;#attributes&#39;</span> =&gt; $attributes,
<a name="l02751"></a>02751   );
<a name="l02752"></a>02752   $href = $attributes[<span class="stringliteral">&#39;href&#39;</span>];
<a name="l02753"></a>02753 
<a name="l02754"></a>02754   <span class="keywordflow">if</span> ($header) {
<a name="l02755"></a>02755     <span class="comment">// Also add a HTTP header &quot;Link:&quot;.</span>
<a name="l02756"></a>02756     $href = <span class="charliteral">&#39;&lt;&#39;</span> . <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>($attributes[<span class="stringliteral">&#39;href&#39;</span>]) . <span class="stringliteral">&#39;&gt;;&#39;</span>;
<a name="l02757"></a>02757     unset($attributes[<span class="stringliteral">&#39;href&#39;</span>]);
<a name="l02758"></a>02758     $element[<span class="stringliteral">&#39;#attached&#39;</span>][<span class="stringliteral">&#39;drupal_add_http_header&#39;</span>][] = array(<span class="stringliteral">&#39;Link&#39;</span>,  $href . <a class="code" href="common_8inc_a70f1ffdd840f920428c2a709f26125dc.html#a70f1ffdd840f920428c2a709f26125dc" title="Formats an attribute string for an HTTP header.">drupal_http_header_attributes</a>($attributes), TRUE);
<a name="l02759"></a>02759   }
<a name="l02760"></a>02760 
<a name="l02761"></a>02761   <a class="code" href="common_8inc_a39eab16a83904b845fccc922a0c5c2cf.html#a39eab16a83904b845fccc922a0c5c2cf" title="Adds output to the HEAD tag of the HTML page.">drupal_add_html_head</a>($element, <span class="stringliteral">&#39;drupal_add_html_head_link:&#39;</span> . $attributes[<span class="stringliteral">&#39;rel&#39;</span>] . <span class="charliteral">&#39;:&#39;</span> . $href);
<a name="l02762"></a>02762 }
<a name="l02763"></a>02763 
<a name="l02880"></a><a class="code" href="common_8inc_a2c5bb2667efb44b02f1a105c0bfdebe5.html#a2c5bb2667efb44b02f1a105c0bfdebe5">02880</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a2c5bb2667efb44b02f1a105c0bfdebe5.html#a2c5bb2667efb44b02f1a105c0bfdebe5" title="Adds a cascading stylesheet to the stylesheet queue.">drupal_add_css</a>($data = NULL, $options = NULL) {
<a name="l02881"></a>02881   $css = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__, array());
<a name="l02882"></a>02882 
<a name="l02883"></a>02883   <span class="comment">// Construct the options, taking the defaults into consideration.</span>
<a name="l02884"></a>02884   <span class="keywordflow">if</span> (isset($options)) {
<a name="l02885"></a>02885     <span class="keywordflow">if</span> (!is_array($options)) {
<a name="l02886"></a>02886       $options = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; $options);
<a name="l02887"></a>02887     }
<a name="l02888"></a>02888   }
<a name="l02889"></a>02889   <span class="keywordflow">else</span> {
<a name="l02890"></a>02890     $options = array();
<a name="l02891"></a>02891   }
<a name="l02892"></a>02892 
<a name="l02893"></a>02893   <span class="comment">// Create an array of CSS files for each media type first, since each type needs to be served</span>
<a name="l02894"></a>02894   <span class="comment">// to the browser differently.</span>
<a name="l02895"></a>02895   <span class="keywordflow">if</span> (isset($data)) {
<a name="l02896"></a>02896     $options += array(
<a name="l02897"></a>02897       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;file&#39;</span>,
<a name="l02898"></a>02898       <span class="stringliteral">&#39;group&#39;</span> =&gt; <a class="code" href="common_8inc_a6b8a843e5b9b3501472dc6efef34f36b.html#a6b8a843e5b9b3501472dc6efef34f36b" title="The default group for module CSS files added to the page.">CSS_DEFAULT</a>,
<a name="l02899"></a>02899       <span class="stringliteral">&#39;weight&#39;</span> =&gt; 0,
<a name="l02900"></a>02900       <span class="stringliteral">&#39;every_page&#39;</span> =&gt; FALSE,
<a name="l02901"></a>02901       <span class="stringliteral">&#39;media&#39;</span> =&gt; <span class="stringliteral">&#39;all&#39;</span>,
<a name="l02902"></a>02902       <span class="stringliteral">&#39;preprocess&#39;</span> =&gt; TRUE,
<a name="l02903"></a>02903       <span class="stringliteral">&#39;data&#39;</span> =&gt; $data,
<a name="l02904"></a>02904       <span class="stringliteral">&#39;browsers&#39;</span> =&gt; array(),
<a name="l02905"></a>02905     );
<a name="l02906"></a>02906     $options[<span class="stringliteral">&#39;browsers&#39;</span>] += array(
<a name="l02907"></a>02907       <span class="stringliteral">&#39;IE&#39;</span> =&gt; TRUE,
<a name="l02908"></a>02908       <span class="stringliteral">&#39;!IE&#39;</span> =&gt; TRUE,
<a name="l02909"></a>02909     );
<a name="l02910"></a>02910 
<a name="l02911"></a>02911     <span class="comment">// Files with a query string cannot be preprocessed.</span>
<a name="l02912"></a>02912     <span class="keywordflow">if</span> ($options[<span class="stringliteral">&#39;type&#39;</span>] === <span class="stringliteral">&#39;file&#39;</span> &amp;&amp; $options[<span class="stringliteral">&#39;preprocess&#39;</span>] &amp;&amp; strpos($options[<span class="stringliteral">&#39;data&#39;</span>], <span class="charliteral">&#39;?&#39;</span>) !== FALSE) {
<a name="l02913"></a>02913       $options[<span class="stringliteral">&#39;preprocess&#39;</span>] = FALSE;
<a name="l02914"></a>02914     }
<a name="l02915"></a>02915 
<a name="l02916"></a>02916     <span class="comment">// Always add a tiny value to the weight, to conserve the insertion order.</span>
<a name="l02917"></a>02917     $options[<span class="stringliteral">&#39;weight&#39;</span>] += count($css) / 1000;
<a name="l02918"></a>02918 
<a name="l02919"></a>02919     <span class="comment">// Add the data to the CSS array depending on the type.</span>
<a name="l02920"></a>02920     <span class="keywordflow">switch</span> ($options[<span class="stringliteral">&#39;type&#39;</span>]) {
<a name="l02921"></a>02921       <span class="keywordflow">case</span> <span class="stringliteral">&#39;inline&#39;</span>:
<a name="l02922"></a>02922         <span class="comment">// For inline stylesheets, we don&#39;t want to use the $data as the array</span>
<a name="l02923"></a>02923         <span class="comment">// key as $data could be a very long string of CSS.</span>
<a name="l02924"></a>02924         $css[] = $options;
<a name="l02925"></a>02925         <span class="keywordflow">break</span>;
<a name="l02926"></a>02926       <span class="keywordflow">default</span>:
<a name="l02927"></a>02927         <span class="comment">// Local and external files must keep their name as the associative key</span>
<a name="l02928"></a>02928         <span class="comment">// so the same CSS file is not be added twice.</span>
<a name="l02929"></a>02929         $css[$data] = $options;
<a name="l02930"></a>02930     }
<a name="l02931"></a>02931   }
<a name="l02932"></a>02932 
<a name="l02933"></a>02933   <span class="keywordflow">return</span> $css;
<a name="l02934"></a>02934 }
<a name="l02935"></a>02935 
<a name="l02965"></a><a class="code" href="common_8inc_a2e308371f339fbb54967045ccbe4e88c.html#a2e308371f339fbb54967045ccbe4e88c">02965</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a2e308371f339fbb54967045ccbe4e88c.html#a2e308371f339fbb54967045ccbe4e88c" title="Returns a themed representation of all stylesheets to attach to the page.">drupal_get_css</a>($css = NULL, $skip_alter = FALSE) {
<a name="l02966"></a>02966   <span class="keywordflow">if</span> (!isset($css)) {
<a name="l02967"></a>02967     $css = <a class="code" href="common_8inc_a2c5bb2667efb44b02f1a105c0bfdebe5.html#a2c5bb2667efb44b02f1a105c0bfdebe5" title="Adds a cascading stylesheet to the stylesheet queue.">drupal_add_css</a>();
<a name="l02968"></a>02968   }
<a name="l02969"></a>02969 
<a name="l02970"></a>02970   <span class="comment">// Allow modules and themes to alter the CSS items.</span>
<a name="l02971"></a>02971   <span class="keywordflow">if</span> (!$skip_alter) {
<a name="l02972"></a>02972     <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;css&#39;</span>, $css);
<a name="l02973"></a>02973   }
<a name="l02974"></a>02974 
<a name="l02975"></a>02975   <span class="comment">// Sort CSS items, so that they appear in the correct order.</span>
<a name="l02976"></a>02976   uasort($css, <span class="stringliteral">&#39;drupal_sort_css_js&#39;</span>);
<a name="l02977"></a>02977 
<a name="l02978"></a>02978   <span class="comment">// Provide the page with information about the individual CSS files used,</span>
<a name="l02979"></a>02979   <span class="comment">// information not otherwise available when CSS aggregation is enabled. The</span>
<a name="l02980"></a>02980   <span class="comment">// setting is attached later in this function, but is set here, so that CSS</span>
<a name="l02981"></a>02981   <span class="comment">// files removed below are still considered &quot;used&quot; and prevented from being</span>
<a name="l02982"></a>02982   <span class="comment">// added in a later AJAX request.</span>
<a name="l02983"></a>02983   <span class="comment">// Skip if no files were added to the page or jQuery.extend() will overwrite</span>
<a name="l02984"></a>02984   <span class="comment">// the Drupal.settings.ajaxPageState.css object with an empty array.</span>
<a name="l02985"></a>02985   <span class="keywordflow">if</span> (!empty($css)) {
<a name="l02986"></a>02986     <span class="comment">// Cast the array to an object to be on the safe side even if not empty.</span>
<a name="l02987"></a>02987     $setting[<span class="stringliteral">&#39;ajaxPageState&#39;</span>][<span class="stringliteral">&#39;css&#39;</span>] = (object) array_fill_keys(array_keys($css), 1);
<a name="l02988"></a>02988   }
<a name="l02989"></a>02989 
<a name="l02990"></a>02990   <span class="comment">// Remove the overridden CSS files. Later CSS files override former ones.</span>
<a name="l02991"></a>02991   $previous_item = array();
<a name="l02992"></a>02992   <span class="keywordflow">foreach</span> ($css as $key =&gt; $item) {
<a name="l02993"></a>02993     <span class="keywordflow">if</span> ($item[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;file&#39;</span>) {
<a name="l02994"></a>02994       <span class="comment">// If defined, force a unique basename for this file.</span>
<a name="l02995"></a>02995       $basename = isset($item[<span class="stringliteral">&#39;basename&#39;</span>]) ? $item[<span class="stringliteral">&#39;basename&#39;</span>] : <a class="code" href="group__php__wrappers_ga0125d5e205f50be86146a8df58c2bc5f.html#ga0125d5e205f50be86146a8df58c2bc5f" title="Gets the filename from a given path.">drupal_basename</a>($item[<span class="stringliteral">&#39;data&#39;</span>]);
<a name="l02996"></a>02996       <span class="keywordflow">if</span> (isset($previous_item[$basename])) {
<a name="l02997"></a>02997         <span class="comment">// Remove the previous item that shared the same base name.</span>
<a name="l02998"></a>02998         unset($css[$previous_item[$basename]]);
<a name="l02999"></a>02999       }
<a name="l03000"></a>03000       $previous_item[$basename] = $key;
<a name="l03001"></a>03001     }
<a name="l03002"></a>03002   }
<a name="l03003"></a>03003 
<a name="l03004"></a>03004   <span class="comment">// Render the HTML needed to load the CSS.</span>
<a name="l03005"></a>03005   $styles = array(
<a name="l03006"></a>03006     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;styles&#39;</span>,
<a name="l03007"></a>03007     <span class="stringliteral">&#39;#items&#39;</span> =&gt; $css,
<a name="l03008"></a>03008   );
<a name="l03009"></a>03009 
<a name="l03010"></a>03010   <span class="keywordflow">if</span> (!empty($setting)) {
<a name="l03011"></a>03011     $styles[<span class="stringliteral">&#39;#attached&#39;</span>][<span class="stringliteral">&#39;js&#39;</span>][] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;setting&#39;</span>, <span class="stringliteral">&#39;data&#39;</span> =&gt; $setting);
<a name="l03012"></a>03012   }
<a name="l03013"></a>03013 
<a name="l03014"></a>03014   <span class="keywordflow">return</span> <a class="code" href="common_8inc_a05798b44e8d6c496d4bee5cc32fa7851.html#a05798b44e8d6c496d4bee5cc32fa7851" title="Renders HTML given a structured array tree.">drupal_render</a>($styles);
<a name="l03015"></a>03015 }
<a name="l03016"></a>03016 
<a name="l03037"></a><a class="code" href="common_8inc_abfb324a21b713b33d4e3b0eeed5343f3.html#abfb324a21b713b33d4e3b0eeed5343f3">03037</a> <span class="keyword">function</span> <a class="code" href="common_8inc_abfb324a21b713b33d4e3b0eeed5343f3.html#abfb324a21b713b33d4e3b0eeed5343f3" title="Sorts CSS and JavaScript resources.">drupal_sort_css_js</a>($a, $b) {
<a name="l03038"></a>03038   <span class="comment">// First order by group, so that, for example, all items in the CSS_SYSTEM</span>
<a name="l03039"></a>03039   <span class="comment">// group appear before items in the CSS_DEFAULT group, which appear before</span>
<a name="l03040"></a>03040   <span class="comment">// all items in the CSS_THEME group. Modules may create additional groups by</span>
<a name="l03041"></a>03041   <span class="comment">// defining their own constants.</span>
<a name="l03042"></a>03042   <span class="keywordflow">if</span> ($a[<span class="stringliteral">&#39;group&#39;</span>] &lt; $b[<span class="stringliteral">&#39;group&#39;</span>]) {
<a name="l03043"></a>03043     <span class="keywordflow">return</span> -1;
<a name="l03044"></a>03044   }
<a name="l03045"></a>03045   elseif ($a[<span class="stringliteral">&#39;group&#39;</span>] &gt; $b[<span class="stringliteral">&#39;group&#39;</span>]) {
<a name="l03046"></a>03046     <span class="keywordflow">return</span> 1;
<a name="l03047"></a>03047   }
<a name="l03048"></a>03048   <span class="comment">// Within a group, order all infrequently needed, page-specific files after</span>
<a name="l03049"></a>03049   <span class="comment">// common files needed throughout the website. Separating this way allows for</span>
<a name="l03050"></a>03050   <span class="comment">// the aggregate file generated for all of the common files to be reused</span>
<a name="l03051"></a>03051   <span class="comment">// across a site visit without being cut by a page using a less common file.</span>
<a name="l03052"></a>03052   elseif ($a[<span class="stringliteral">&#39;every_page&#39;</span>] &amp;&amp; !$b[<span class="stringliteral">&#39;every_page&#39;</span>]) {
<a name="l03053"></a>03053     <span class="keywordflow">return</span> -1;
<a name="l03054"></a>03054   }
<a name="l03055"></a>03055   elseif (!$a[<span class="stringliteral">&#39;every_page&#39;</span>] &amp;&amp; $b[<span class="stringliteral">&#39;every_page&#39;</span>]) {
<a name="l03056"></a>03056     <span class="keywordflow">return</span> 1;
<a name="l03057"></a>03057   }
<a name="l03058"></a>03058   <span class="comment">// Finally, order by weight.</span>
<a name="l03059"></a>03059   elseif ($a[<span class="stringliteral">&#39;weight&#39;</span>] &lt; $b[<span class="stringliteral">&#39;weight&#39;</span>]) {
<a name="l03060"></a>03060     <span class="keywordflow">return</span> -1;
<a name="l03061"></a>03061   }
<a name="l03062"></a>03062   elseif ($a[<span class="stringliteral">&#39;weight&#39;</span>] &gt; $b[<span class="stringliteral">&#39;weight&#39;</span>]) {
<a name="l03063"></a>03063     <span class="keywordflow">return</span> 1;
<a name="l03064"></a>03064   }
<a name="l03065"></a>03065   <span class="keywordflow">else</span> {
<a name="l03066"></a>03066     <span class="keywordflow">return</span> 0;
<a name="l03067"></a>03067   }
<a name="l03068"></a>03068 }
<a name="l03069"></a>03069 
<a name="l03104"></a><a class="code" href="common_8inc_a2d63a3ab0ae5c285f4546304a4775ae3.html#a2d63a3ab0ae5c285f4546304a4775ae3">03104</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a2d63a3ab0ae5c285f4546304a4775ae3.html#a2d63a3ab0ae5c285f4546304a4775ae3" title="Default callback to group CSS items.">drupal_group_css</a>($css) {
<a name="l03105"></a>03105   $groups = array();
<a name="l03106"></a>03106   <span class="comment">// If a group can contain multiple items, we track the information that must</span>
<a name="l03107"></a>03107   <span class="comment">// be the same for each item in the group, so that when we iterate the next</span>
<a name="l03108"></a>03108   <span class="comment">// item, we can determine if it can be put into the current group, or if a</span>
<a name="l03109"></a>03109   <span class="comment">// new group needs to be made for it.</span>
<a name="l03110"></a>03110   $current_group_keys = NULL;
<a name="l03111"></a>03111   <span class="comment">// When creating a new group, we pre-increment $i, so by initializing it to</span>
<a name="l03112"></a>03112   <span class="comment">// -1, the first group will have index 0.</span>
<a name="l03113"></a>03113   $i = -1;
<a name="l03114"></a>03114   <span class="keywordflow">foreach</span> ($css as $item) {
<a name="l03115"></a>03115     <span class="comment">// The browsers for which the CSS item needs to be loaded is part of the</span>
<a name="l03116"></a>03116     <span class="comment">// information that determines when a new group is needed, but the order of</span>
<a name="l03117"></a>03117     <span class="comment">// keys in the array doesn&#39;t matter, and we don&#39;t want a new group if all</span>
<a name="l03118"></a>03118     <span class="comment">// that&#39;s different is that order.</span>
<a name="l03119"></a>03119     ksort($item[<span class="stringliteral">&#39;browsers&#39;</span>]);
<a name="l03120"></a>03120 
<a name="l03121"></a>03121     <span class="comment">// If the item can be grouped with other items, set $group_keys to an array</span>
<a name="l03122"></a>03122     <span class="comment">// of information that must be the same for all items in its group. If the</span>
<a name="l03123"></a>03123     <span class="comment">// item can&#39;t be grouped with other items, set $group_keys to FALSE. We</span>
<a name="l03124"></a>03124     <span class="comment">// put items into a group that can be aggregated together: whether they will</span>
<a name="l03125"></a>03125     <span class="comment">// be aggregated is up to the _drupal_css_aggregate() function or an</span>
<a name="l03126"></a>03126     <span class="comment">// override of that function specified in hook_css_alter(), but regardless</span>
<a name="l03127"></a>03127     <span class="comment">// of the details of that function, a group represents items that can be</span>
<a name="l03128"></a>03128     <span class="comment">// aggregated. Since a group may be rendered with a single HTML tag, all</span>
<a name="l03129"></a>03129     <span class="comment">// items in the group must share the same information that would need to be</span>
<a name="l03130"></a>03130     <span class="comment">// part of that HTML tag.</span>
<a name="l03131"></a>03131     <span class="keywordflow">switch</span> ($item[<span class="stringliteral">&#39;type&#39;</span>]) {
<a name="l03132"></a>03132       <span class="keywordflow">case</span> <span class="stringliteral">&#39;file&#39;</span>:
<a name="l03133"></a>03133         <span class="comment">// Group file items if their &#39;preprocess&#39; flag is TRUE.</span>
<a name="l03134"></a>03134         <span class="comment">// Help ensure maximum reuse of aggregate files by only grouping</span>
<a name="l03135"></a>03135         <span class="comment">// together items that share the same &#39;group&#39; value and &#39;every_page&#39;</span>
<a name="l03136"></a>03136         <span class="comment">// flag. See drupal_add_css() for details about that.</span>
<a name="l03137"></a>03137         $group_keys = $item[<span class="stringliteral">&#39;preprocess&#39;</span>] ? array($item[<span class="stringliteral">&#39;type&#39;</span>], $item[<span class="stringliteral">&#39;group&#39;</span>], $item[<span class="stringliteral">&#39;every_page&#39;</span>], $item[<span class="stringliteral">&#39;media&#39;</span>], $item[<span class="stringliteral">&#39;browsers&#39;</span>]) : FALSE;
<a name="l03138"></a>03138         <span class="keywordflow">break</span>;
<a name="l03139"></a>03139       <span class="keywordflow">case</span> <span class="stringliteral">&#39;inline&#39;</span>:
<a name="l03140"></a>03140         <span class="comment">// Always group inline items.</span>
<a name="l03141"></a>03141         $group_keys = array($item[<span class="stringliteral">&#39;type&#39;</span>], $item[<span class="stringliteral">&#39;media&#39;</span>], $item[<span class="stringliteral">&#39;browsers&#39;</span>]);
<a name="l03142"></a>03142         <span class="keywordflow">break</span>;
<a name="l03143"></a>03143       <span class="keywordflow">case</span> <span class="stringliteral">&#39;external&#39;</span>:
<a name="l03144"></a>03144         <span class="comment">// Do not group external items.</span>
<a name="l03145"></a>03145         $group_keys = FALSE;
<a name="l03146"></a>03146         <span class="keywordflow">break</span>;
<a name="l03147"></a>03147     }
<a name="l03148"></a>03148 
<a name="l03149"></a>03149     <span class="comment">// If the group keys don&#39;t match the most recent group we&#39;re working with,</span>
<a name="l03150"></a>03150     <span class="comment">// then a new group must be made.</span>
<a name="l03151"></a>03151     <span class="keywordflow">if</span> ($group_keys !== $current_group_keys) {
<a name="l03152"></a>03152       $i++;
<a name="l03153"></a>03153       <span class="comment">// Initialize the new group with the same properties as the first item</span>
<a name="l03154"></a>03154       <span class="comment">// being placed into it. The item&#39;s &#39;data&#39; and &#39;weight&#39; properties are</span>
<a name="l03155"></a>03155       <span class="comment">// unique to the item and should not be carried over to the group.</span>
<a name="l03156"></a>03156       $groups[$i] = $item;
<a name="l03157"></a>03157       unset($groups[$i][<span class="stringliteral">&#39;data&#39;</span>], $groups[$i][<span class="stringliteral">&#39;weight&#39;</span>]);
<a name="l03158"></a>03158       $groups[$i][<span class="stringliteral">&#39;items&#39;</span>] = array();
<a name="l03159"></a>03159       $current_group_keys = $group_keys ? $group_keys : NULL;
<a name="l03160"></a>03160     }
<a name="l03161"></a>03161 
<a name="l03162"></a>03162     <span class="comment">// Add the item to the current group.</span>
<a name="l03163"></a>03163     $groups[$i][<span class="stringliteral">&#39;items&#39;</span>][] = $item;
<a name="l03164"></a>03164   }
<a name="l03165"></a>03165   <span class="keywordflow">return</span> $groups;
<a name="l03166"></a>03166 }
<a name="l03167"></a>03167 
<a name="l03187"></a><a class="code" href="common_8inc_a7d2aaae18c944ab87b16de225927e330.html#a7d2aaae18c944ab87b16de225927e330">03187</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a7d2aaae18c944ab87b16de225927e330.html#a7d2aaae18c944ab87b16de225927e330" title="Default callback to aggregate CSS files and inline content.">drupal_aggregate_css</a>(&amp;$css_groups) {
<a name="l03188"></a>03188   $preprocess_css = (<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;preprocess_css&#39;</span>, FALSE) &amp;&amp; (!defined(<span class="stringliteral">&#39;MAINTENANCE_MODE&#39;</span>) || <a class="code" href="authorize_8php_a5bf6dfe9ba7ee16c648e3932aa76535d.html#a5bf6dfe9ba7ee16c648e3932aa76535d" title="Global flag to identify update.php and authorize.php runs, and so avoid various unwanted operations...">MAINTENANCE_MODE</a> != <span class="stringliteral">&#39;update&#39;</span>));
<a name="l03189"></a>03189 
<a name="l03190"></a>03190   <span class="comment">// For each group that needs aggregation, aggregate its items.</span>
<a name="l03191"></a>03191   <span class="keywordflow">foreach</span> ($css_groups as $key =&gt; $group) {
<a name="l03192"></a>03192     <span class="keywordflow">switch</span> ($group[<span class="stringliteral">&#39;type&#39;</span>]) {
<a name="l03193"></a>03193       <span class="comment">// If a file group can be aggregated into a single file, do so, and set</span>
<a name="l03194"></a>03194       <span class="comment">// the group&#39;s data property to the file path of the aggregate file.</span>
<a name="l03195"></a>03195       <span class="keywordflow">case</span> <span class="stringliteral">&#39;file&#39;</span>:
<a name="l03196"></a>03196         <span class="keywordflow">if</span> ($group[<span class="stringliteral">&#39;preprocess&#39;</span>] &amp;&amp; $preprocess_css) {
<a name="l03197"></a>03197           $css_groups[$key][<span class="stringliteral">&#39;data&#39;</span>] = <a class="code" href="common_8inc_af375d76404efdf4468a7157f71c910ee.html#af375d76404efdf4468a7157f71c910ee" title="Aggregates and optimizes CSS files into a cache file in the files directory.">drupal_build_css_cache</a>($group[<span class="stringliteral">&#39;items&#39;</span>]);
<a name="l03198"></a>03198         }
<a name="l03199"></a>03199         <span class="keywordflow">break</span>;
<a name="l03200"></a>03200       <span class="comment">// Aggregate all inline CSS content into the group&#39;s data property.</span>
<a name="l03201"></a>03201       <span class="keywordflow">case</span> <span class="stringliteral">&#39;inline&#39;</span>:
<a name="l03202"></a>03202         $css_groups[$key][<span class="stringliteral">&#39;data&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03203"></a>03203         <span class="keywordflow">foreach</span> ($group[<span class="stringliteral">&#39;items&#39;</span>] as $item) {
<a name="l03204"></a>03204           $css_groups[$key][<span class="stringliteral">&#39;data&#39;</span>] .= <a class="code" href="common_8inc_a3103cf0e37656ce026267e14260d9ea6.html#a3103cf0e37656ce026267e14260d9ea6" title="Processes the contents of a stylesheet for aggregation.">drupal_load_stylesheet_content</a>($item[<span class="stringliteral">&#39;data&#39;</span>], $item[<span class="stringliteral">&#39;preprocess&#39;</span>]);
<a name="l03205"></a>03205         }
<a name="l03206"></a>03206         <span class="keywordflow">break</span>;
<a name="l03207"></a>03207     }
<a name="l03208"></a>03208   }
<a name="l03209"></a>03209 }
<a name="l03210"></a>03210 
<a name="l03272"></a><a class="code" href="common_8inc_a4b3889176f5132daa3f56a861d19aa95.html#a4b3889176f5132daa3f56a861d19aa95">03272</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a4b3889176f5132daa3f56a861d19aa95.html#a4b3889176f5132daa3f56a861d19aa95" title="#pre_render callback to add the elements needed for CSS tags to be rendered.">drupal_pre_render_styles</a>($elements) {
<a name="l03273"></a>03273   <span class="comment">// Group and aggregate the items.</span>
<a name="l03274"></a>03274   <span class="keywordflow">if</span> (isset($elements[<span class="stringliteral">&#39;#group_callback&#39;</span>])) {
<a name="l03275"></a>03275     $elements[<span class="stringliteral">&#39;#groups&#39;</span>] = $elements[<span class="stringliteral">&#39;#group_callback&#39;</span>]($elements[<span class="stringliteral">&#39;#items&#39;</span>]);
<a name="l03276"></a>03276   }
<a name="l03277"></a>03277   <span class="keywordflow">if</span> (isset($elements[<span class="stringliteral">&#39;#aggregate_callback&#39;</span>])) {
<a name="l03278"></a>03278     $elements[<span class="stringliteral">&#39;#aggregate_callback&#39;</span>]($elements[<span class="stringliteral">&#39;#groups&#39;</span>]);
<a name="l03279"></a>03279   }
<a name="l03280"></a>03280 
<a name="l03281"></a>03281   <span class="comment">// A dummy query-string is added to filenames, to gain control over</span>
<a name="l03282"></a>03282   <span class="comment">// browser-caching. The string changes on every update or full cache</span>
<a name="l03283"></a>03283   <span class="comment">// flush, forcing browsers to load a new copy of the files, as the</span>
<a name="l03284"></a>03284   <span class="comment">// URL changed.</span>
<a name="l03285"></a>03285   $query_string = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;css_js_query_string&#39;</span>, <span class="charliteral">&#39;0&#39;</span>);
<a name="l03286"></a>03286 
<a name="l03287"></a>03287   <span class="comment">// For inline CSS to validate as XHTML, all CSS containing XHTML needs to be</span>
<a name="l03288"></a>03288   <span class="comment">// wrapped in CDATA. To make that backwards compatible with HTML 4, we need to</span>
<a name="l03289"></a>03289   <span class="comment">// comment out the CDATA-tag.</span>
<a name="l03290"></a>03290   $embed_prefix = <span class="stringliteral">&quot;\n&lt;!--/*--&gt;&lt;![CDATA[/*&gt;&lt;!--*/\n&quot;</span>;
<a name="l03291"></a>03291   $embed_suffix = <span class="stringliteral">&quot;\n/*]]&gt;*/--&gt;\n&quot;</span>;
<a name="l03292"></a>03292 
<a name="l03293"></a>03293   <span class="comment">// Defaults for LINK and STYLE elements.</span>
<a name="l03294"></a>03294   $link_element_defaults = array(
<a name="l03295"></a>03295     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;html_tag&#39;</span>,
<a name="l03296"></a>03296     <span class="stringliteral">&#39;#tag&#39;</span> =&gt; <span class="stringliteral">&#39;link&#39;</span>,
<a name="l03297"></a>03297     <span class="stringliteral">&#39;#attributes&#39;</span> =&gt; array(
<a name="l03298"></a>03298       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;text/css&#39;</span>,
<a name="l03299"></a>03299       <span class="stringliteral">&#39;rel&#39;</span> =&gt; <span class="stringliteral">&#39;stylesheet&#39;</span>,
<a name="l03300"></a>03300     ),
<a name="l03301"></a>03301   );
<a name="l03302"></a>03302   $style_element_defaults = array(
<a name="l03303"></a>03303     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;html_tag&#39;</span>,
<a name="l03304"></a>03304     <span class="stringliteral">&#39;#tag&#39;</span> =&gt; <span class="stringliteral">&#39;style&#39;</span>,
<a name="l03305"></a>03305     <span class="stringliteral">&#39;#attributes&#39;</span> =&gt; array(
<a name="l03306"></a>03306       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;text/css&#39;</span>,
<a name="l03307"></a>03307     ),
<a name="l03308"></a>03308   );
<a name="l03309"></a>03309 
<a name="l03310"></a>03310   <span class="comment">// Loop through each group.</span>
<a name="l03311"></a>03311   <span class="keywordflow">foreach</span> ($elements[<span class="stringliteral">&#39;#groups&#39;</span>] as $group) {
<a name="l03312"></a>03312     <span class="keywordflow">switch</span> ($group[<span class="stringliteral">&#39;type&#39;</span>]) {
<a name="l03313"></a>03313       <span class="comment">// For file items, there are three possibilites.</span>
<a name="l03314"></a>03314       <span class="comment">// - The group has been aggregated: in this case, output a LINK tag for</span>
<a name="l03315"></a>03315       <span class="comment">//   the aggregate file.</span>
<a name="l03316"></a>03316       <span class="comment">// - The group can be aggregated but has not been (most likely because</span>
<a name="l03317"></a>03317       <span class="comment">//   the site administrator disabled the site-wide setting): in this case,</span>
<a name="l03318"></a>03318       <span class="comment">//   output as few STYLE tags for the group as possible, using @import</span>
<a name="l03319"></a>03319       <span class="comment">//   statement for each file in the group. This enables us to stay within</span>
<a name="l03320"></a>03320       <span class="comment">//   IE&#39;s limit of 31 total CSS inclusion tags.</span>
<a name="l03321"></a>03321       <span class="comment">// - The group contains items not eligible for aggregation (their</span>
<a name="l03322"></a>03322       <span class="comment">//   &#39;preprocess&#39; flag has been set to FALSE): in this case, output a LINK</span>
<a name="l03323"></a>03323       <span class="comment">//   tag for each file.</span>
<a name="l03324"></a>03324       <span class="keywordflow">case</span> <span class="stringliteral">&#39;file&#39;</span>:
<a name="l03325"></a>03325         <span class="comment">// The group has been aggregated into a single file: output a LINK tag</span>
<a name="l03326"></a>03326         <span class="comment">// for the aggregate file.</span>
<a name="l03327"></a>03327         <span class="keywordflow">if</span> (isset($group[<span class="stringliteral">&#39;data&#39;</span>])) {
<a name="l03328"></a>03328           $element = $link_element_defaults;
<a name="l03329"></a>03329           $element[<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;href&#39;</span>] = <a class="code" href="group__file_gaee57f47d60bda90961a2e19d580d4908.html#gaee57f47d60bda90961a2e19d580d4908" title="Creates a web-accessible URL for a stream to an external or local file.">file_create_url</a>($group[<span class="stringliteral">&#39;data&#39;</span>]);
<a name="l03330"></a>03330           $element[<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;media&#39;</span>] = $group[<span class="stringliteral">&#39;media&#39;</span>];
<a name="l03331"></a>03331           $element[<span class="stringliteral">&#39;#browsers&#39;</span>] = $group[<span class="stringliteral">&#39;browsers&#39;</span>];
<a name="l03332"></a>03332           $elements[] = $element;
<a name="l03333"></a>03333         }
<a name="l03334"></a>03334         <span class="comment">// The group can be aggregated, but hasn&#39;t been: combine multiple items</span>
<a name="l03335"></a>03335         <span class="comment">// into as few STYLE tags as possible.</span>
<a name="l03336"></a>03336         elseif ($group[<span class="stringliteral">&#39;preprocess&#39;</span>]) {
<a name="l03337"></a>03337           $import = array();
<a name="l03338"></a>03338           <span class="keywordflow">foreach</span> ($group[<span class="stringliteral">&#39;items&#39;</span>] as $item) {
<a name="l03339"></a>03339             <span class="comment">// A theme&#39;s .info file may have an entry for a file that doesn&#39;t</span>
<a name="l03340"></a>03340             <span class="comment">// exist as a way of overriding a module or base theme CSS file from</span>
<a name="l03341"></a>03341             <span class="comment">// being added to the page. Normally, file_exists() calls that need</span>
<a name="l03342"></a>03342             <span class="comment">// to run for every page request should be minimized, but this one</span>
<a name="l03343"></a>03343             <span class="comment">// is okay, because it only runs when CSS aggregation is disabled.</span>
<a name="l03344"></a>03344             <span class="comment">// On a server under heavy enough load that file_exists() calls need</span>
<a name="l03345"></a>03345             <span class="comment">// to be minimized, CSS aggregation should be enabled, in which case</span>
<a name="l03346"></a>03346             <span class="comment">// this code is not run. When aggregation is enabled,</span>
<a name="l03347"></a>03347             <span class="comment">// drupal_load_stylesheet() checks file_exists(), but only when</span>
<a name="l03348"></a>03348             <span class="comment">// building the aggregate file, which is then reused for many page</span>
<a name="l03349"></a>03349             <span class="comment">// requests.</span>
<a name="l03350"></a>03350             <span class="keywordflow">if</span> (file_exists($item[<span class="stringliteral">&#39;data&#39;</span>])) {
<a name="l03351"></a>03351               <span class="comment">// The dummy query string needs to be added to the URL to control</span>
<a name="l03352"></a>03352               <span class="comment">// browser-caching. IE7 does not support a media type on the</span>
<a name="l03353"></a>03353               <span class="comment">// @import statement, so we instead specify the media for the</span>
<a name="l03354"></a>03354               <span class="comment">// group on the STYLE tag.</span>
<a name="l03355"></a>03355               $import[] = <span class="stringliteral">&#39;@import url(&quot;&#39;</span> . <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>(<a class="code" href="group__file_gaee57f47d60bda90961a2e19d580d4908.html#gaee57f47d60bda90961a2e19d580d4908" title="Creates a web-accessible URL for a stream to an external or local file.">file_create_url</a>($item[<span class="stringliteral">&#39;data&#39;</span>]) . <span class="charliteral">&#39;?&#39;</span> . $query_string) . <span class="stringliteral">&#39;&quot;);&#39;</span>;
<a name="l03356"></a>03356             }
<a name="l03357"></a>03357           }
<a name="l03358"></a>03358           <span class="comment">// In addition to IE&#39;s limit of 31 total CSS inclusion tags, it also</span>
<a name="l03359"></a>03359           <span class="comment">// has a limit of 31 @import statements per STYLE tag.</span>
<a name="l03360"></a>03360           <span class="keywordflow">while</span> (!empty($import)) {
<a name="l03361"></a>03361             $import_batch = array_slice($import, 0, 31);
<a name="l03362"></a>03362             $import = array_slice($import, 31);
<a name="l03363"></a>03363             $element = $style_element_defaults;
<a name="l03364"></a>03364             $element[<span class="stringliteral">&#39;#value&#39;</span>] = implode(<span class="stringliteral">&quot;\n&quot;</span>, $import_batch);
<a name="l03365"></a>03365             $element[<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;media&#39;</span>] = $group[<span class="stringliteral">&#39;media&#39;</span>];
<a name="l03366"></a>03366             $element[<span class="stringliteral">&#39;#browsers&#39;</span>] = $group[<span class="stringliteral">&#39;browsers&#39;</span>];
<a name="l03367"></a>03367             $elements[] = $element;
<a name="l03368"></a>03368           }
<a name="l03369"></a>03369         }
<a name="l03370"></a>03370         <span class="comment">// The group contains items ineligible for aggregation: output a LINK</span>
<a name="l03371"></a>03371         <span class="comment">// tag for each file.</span>
<a name="l03372"></a>03372         <span class="keywordflow">else</span> {
<a name="l03373"></a>03373           <span class="keywordflow">foreach</span> ($group[<span class="stringliteral">&#39;items&#39;</span>] as $item) {
<a name="l03374"></a>03374             $element = $link_element_defaults;
<a name="l03375"></a>03375             <span class="comment">// We do not check file_exists() here, because this code runs for</span>
<a name="l03376"></a>03376             <span class="comment">// files whose &#39;preprocess&#39; is set to FALSE, and therefore, even</span>
<a name="l03377"></a>03377             <span class="comment">// when aggregation is enabled, and we want to avoid needlessly</span>
<a name="l03378"></a>03378             <span class="comment">// taxing a server that may be under heavy load. The file_exists()</span>
<a name="l03379"></a>03379             <span class="comment">// performed above for files whose &#39;preprocess&#39; is TRUE is done for</span>
<a name="l03380"></a>03380             <span class="comment">// the benefit of theme .info files, but code that deals with files</span>
<a name="l03381"></a>03381             <span class="comment">// whose &#39;preprocess&#39; is FALSE is responsible for ensuring the file</span>
<a name="l03382"></a>03382             <span class="comment">// exists.</span>
<a name="l03383"></a>03383             <span class="comment">// The dummy query string needs to be added to the URL to control</span>
<a name="l03384"></a>03384             <span class="comment">// browser-caching.</span>
<a name="l03385"></a>03385             $query_string_separator = (strpos($item[<span class="stringliteral">&#39;data&#39;</span>], <span class="charliteral">&#39;?&#39;</span>) !== FALSE) ? <span class="charliteral">&#39;&amp;&#39;</span> : <span class="charliteral">&#39;?&#39;</span>;
<a name="l03386"></a>03386             $element[<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;href&#39;</span>] = <a class="code" href="group__file_gaee57f47d60bda90961a2e19d580d4908.html#gaee57f47d60bda90961a2e19d580d4908" title="Creates a web-accessible URL for a stream to an external or local file.">file_create_url</a>($item[<span class="stringliteral">&#39;data&#39;</span>]) . $query_string_separator . $query_string;
<a name="l03387"></a>03387             $element[<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;media&#39;</span>] = $item[<span class="stringliteral">&#39;media&#39;</span>];
<a name="l03388"></a>03388             $element[<span class="stringliteral">&#39;#browsers&#39;</span>] = $group[<span class="stringliteral">&#39;browsers&#39;</span>];
<a name="l03389"></a>03389             $elements[] = $element;
<a name="l03390"></a>03390           }
<a name="l03391"></a>03391         }
<a name="l03392"></a>03392         <span class="keywordflow">break</span>;
<a name="l03393"></a>03393       <span class="comment">// For inline content, the &#39;data&#39; property contains the CSS content. If</span>
<a name="l03394"></a>03394       <span class="comment">// the group&#39;s &#39;data&#39; property is set, then output it in a single STYLE</span>
<a name="l03395"></a>03395       <span class="comment">// tag. Otherwise, output a separate STYLE tag for each item.</span>
<a name="l03396"></a>03396       <span class="keywordflow">case</span> <span class="stringliteral">&#39;inline&#39;</span>:
<a name="l03397"></a>03397         <span class="keywordflow">if</span> (isset($group[<span class="stringliteral">&#39;data&#39;</span>])) {
<a name="l03398"></a>03398           $element = $style_element_defaults;
<a name="l03399"></a>03399           $element[<span class="stringliteral">&#39;#value&#39;</span>] = $group[<span class="stringliteral">&#39;data&#39;</span>];
<a name="l03400"></a>03400           $element[<span class="stringliteral">&#39;#value_prefix&#39;</span>] = $embed_prefix;
<a name="l03401"></a>03401           $element[<span class="stringliteral">&#39;#value_suffix&#39;</span>] = $embed_suffix;
<a name="l03402"></a>03402           $element[<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;media&#39;</span>] = $group[<span class="stringliteral">&#39;media&#39;</span>];
<a name="l03403"></a>03403           $element[<span class="stringliteral">&#39;#browsers&#39;</span>] = $group[<span class="stringliteral">&#39;browsers&#39;</span>];
<a name="l03404"></a>03404           $elements[] = $element;
<a name="l03405"></a>03405         }
<a name="l03406"></a>03406         <span class="keywordflow">else</span> {
<a name="l03407"></a>03407           <span class="keywordflow">foreach</span> ($group[<span class="stringliteral">&#39;items&#39;</span>] as $item) {
<a name="l03408"></a>03408             $element = $style_element_defaults;
<a name="l03409"></a>03409             $element[<span class="stringliteral">&#39;#value&#39;</span>] = $item[<span class="stringliteral">&#39;data&#39;</span>];
<a name="l03410"></a>03410             $element[<span class="stringliteral">&#39;#value_prefix&#39;</span>] = $embed_prefix;
<a name="l03411"></a>03411             $element[<span class="stringliteral">&#39;#value_suffix&#39;</span>] = $embed_suffix;
<a name="l03412"></a>03412             $element[<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;media&#39;</span>] = $item[<span class="stringliteral">&#39;media&#39;</span>];
<a name="l03413"></a>03413             $element[<span class="stringliteral">&#39;#browsers&#39;</span>] = $group[<span class="stringliteral">&#39;browsers&#39;</span>];
<a name="l03414"></a>03414             $elements[] = $element;
<a name="l03415"></a>03415           }
<a name="l03416"></a>03416         }
<a name="l03417"></a>03417         <span class="keywordflow">break</span>;
<a name="l03418"></a>03418       <span class="comment">// Output a LINK tag for each external item. The item&#39;s &#39;data&#39; property</span>
<a name="l03419"></a>03419       <span class="comment">// contains the full URL.</span>
<a name="l03420"></a>03420       <span class="keywordflow">case</span> <span class="stringliteral">&#39;external&#39;</span>:
<a name="l03421"></a>03421         <span class="keywordflow">foreach</span> ($group[<span class="stringliteral">&#39;items&#39;</span>] as $item) {
<a name="l03422"></a>03422           $element = $link_element_defaults;
<a name="l03423"></a>03423           $element[<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;href&#39;</span>] = $item[<span class="stringliteral">&#39;data&#39;</span>];
<a name="l03424"></a>03424           $element[<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;media&#39;</span>] = $item[<span class="stringliteral">&#39;media&#39;</span>];
<a name="l03425"></a>03425           $element[<span class="stringliteral">&#39;#browsers&#39;</span>] = $group[<span class="stringliteral">&#39;browsers&#39;</span>];
<a name="l03426"></a>03426           $elements[] = $element;
<a name="l03427"></a>03427         }
<a name="l03428"></a>03428         <span class="keywordflow">break</span>;
<a name="l03429"></a>03429     }
<a name="l03430"></a>03430   }
<a name="l03431"></a>03431 
<a name="l03432"></a>03432   <span class="keywordflow">return</span> $elements;
<a name="l03433"></a>03433 }
<a name="l03434"></a>03434 
<a name="l03459"></a><a class="code" href="common_8inc_af375d76404efdf4468a7157f71c910ee.html#af375d76404efdf4468a7157f71c910ee">03459</a> <span class="keyword">function</span> <a class="code" href="common_8inc_af375d76404efdf4468a7157f71c910ee.html#af375d76404efdf4468a7157f71c910ee" title="Aggregates and optimizes CSS files into a cache file in the files directory.">drupal_build_css_cache</a>($css) {
<a name="l03460"></a>03460   $data = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03461"></a>03461   $uri = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03462"></a>03462   $map = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;drupal_css_cache_files&#39;</span>, array());
<a name="l03463"></a>03463   <span class="comment">// Create a new array so that only the file names are used to create the hash.</span>
<a name="l03464"></a>03464   <span class="comment">// This prevents new aggregates from being created unnecessarily.</span>
<a name="l03465"></a>03465   $css_data = array();
<a name="l03466"></a>03466   <span class="keywordflow">foreach</span> ($css as $css_file) {
<a name="l03467"></a>03467     $css_data[] = $css_file[<span class="stringliteral">&#39;data&#39;</span>];
<a name="l03468"></a>03468   }
<a name="l03469"></a>03469   $key = hash(<span class="stringliteral">&#39;sha256&#39;</span>, serialize($css_data));
<a name="l03470"></a>03470   <span class="keywordflow">if</span> (isset($map[$key])) {
<a name="l03471"></a>03471     $uri = $map[$key];
<a name="l03472"></a>03472   }
<a name="l03473"></a>03473 
<a name="l03474"></a>03474   <span class="keywordflow">if</span> (empty($uri) || !file_exists($uri)) {
<a name="l03475"></a>03475     <span class="comment">// Build aggregate CSS file.</span>
<a name="l03476"></a>03476     <span class="keywordflow">foreach</span> ($css as $stylesheet) {
<a name="l03477"></a>03477       <span class="comment">// Only &#39;file&#39; stylesheets can be aggregated.</span>
<a name="l03478"></a>03478       <span class="keywordflow">if</span> ($stylesheet[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;file&#39;</span>) {
<a name="l03479"></a>03479         $contents = <a class="code" href="common_8inc_a9c43f07915b6da92d97792c2b968a4cd.html#a9c43f07915b6da92d97792c2b968a4cd" title="Loads the stylesheet and resolves all  commands.">drupal_load_stylesheet</a>($stylesheet[<span class="stringliteral">&#39;data&#39;</span>], TRUE);
<a name="l03480"></a>03480 
<a name="l03481"></a>03481         <span class="comment">// Build the base URL of this CSS file: start with the full URL.</span>
<a name="l03482"></a>03482         $css_base_url = <a class="code" href="group__file_gaee57f47d60bda90961a2e19d580d4908.html#gaee57f47d60bda90961a2e19d580d4908" title="Creates a web-accessible URL for a stream to an external or local file.">file_create_url</a>($stylesheet[<span class="stringliteral">&#39;data&#39;</span>]);
<a name="l03483"></a>03483         <span class="comment">// Move to the parent.</span>
<a name="l03484"></a>03484         $css_base_url = substr($css_base_url, 0, strrpos($css_base_url, <span class="charliteral">&#39;/&#39;</span>));
<a name="l03485"></a>03485         <span class="comment">// Simplify to a relative URL if the stylesheet URL starts with the</span>
<a name="l03486"></a>03486         <span class="comment">// base URL of the website.</span>
<a name="l03487"></a>03487         <span class="keywordflow">if</span> (substr($css_base_url, 0, strlen($GLOBALS[<span class="stringliteral">&#39;base_root&#39;</span>])) == $GLOBALS[<span class="stringliteral">&#39;base_root&#39;</span>]) {
<a name="l03488"></a>03488           $css_base_url = substr($css_base_url, strlen($GLOBALS[<span class="stringliteral">&#39;base_root&#39;</span>]));
<a name="l03489"></a>03489         }
<a name="l03490"></a>03490 
<a name="l03491"></a>03491         <a class="code" href="common_8inc_af634d8ae0731015c73e039895890b42b.html#af634d8ae0731015c73e039895890b42b" title="Prefixes all paths within a CSS file for drupal_build_css_cache().">_drupal_build_css_path</a>(NULL, $css_base_url . <span class="charliteral">&#39;/&#39;</span>);
<a name="l03492"></a>03492         <span class="comment">// Anchor all paths in the CSS with its base URL, ignoring external and absolute paths.</span>
<a name="l03493"></a>03493         $data .= preg_replace_callback(<span class="stringliteral">&#39;/url\(\s*[\&#39;&quot;]?(?![a-z]+:|\/+)([^\&#39;&quot;)]+)[\&#39;&quot;]?\s*\)/i&#39;</span>, <span class="stringliteral">&#39;_drupal_build_css_path&#39;</span>, $contents);
<a name="l03494"></a>03494       }
<a name="l03495"></a>03495     }
<a name="l03496"></a>03496 
<a name="l03497"></a>03497     <span class="comment">// Per the W3C specification at http://www.w3.org/TR/REC-CSS2/cascade.html#at-import,</span>
<a name="l03498"></a>03498     <span class="comment">// @import rules must proceed any other style, so we move those to the top.</span>
<a name="l03499"></a>03499     $regexp = <span class="stringliteral">&#39;/@import[^;]+;/i&#39;</span>;
<a name="l03500"></a>03500     preg_match_all($regexp, $data, $matches);
<a name="l03501"></a>03501     $data = preg_replace($regexp, <span class="stringliteral">&#39;&#39;</span>, $data);
<a name="l03502"></a>03502     $data = implode(<span class="stringliteral">&#39;&#39;</span>, $matches[0]) . $data;
<a name="l03503"></a>03503 
<a name="l03504"></a>03504     <span class="comment">// Prefix filename to prevent blocking by firewalls which reject files</span>
<a name="l03505"></a>03505     <span class="comment">// starting with &quot;ad*&quot;.</span>
<a name="l03506"></a>03506     $filename = <span class="stringliteral">&#39;css_&#39;</span> . <a class="code" href="bootstrap_8inc_afaa1b21aee7b2e06ee3f868065fdbcc1.html#afaa1b21aee7b2e06ee3f868065fdbcc1" title="Calculates a base-64 encoded, URL-safe sha-256 hash.">drupal_hash_base64</a>($data) . <span class="stringliteral">&#39;.css&#39;</span>;
<a name="l03507"></a>03507     <span class="comment">// Create the css/ within the files folder.</span>
<a name="l03508"></a>03508     $csspath = <span class="stringliteral">&#39;public://css&#39;</span>;
<a name="l03509"></a>03509     $uri = $csspath . <span class="charliteral">&#39;/&#39;</span> . $filename;
<a name="l03510"></a>03510     <span class="comment">// Create the CSS file.</span>
<a name="l03511"></a>03511     <a class="code" href="group__file_ga738f89421a4f4c228676de817e5e485c.html#ga738f89421a4f4c228676de817e5e485c" title="Checks that the directory exists and is writable.">file_prepare_directory</a>($csspath, <a class="code" href="group__file_ga851cbf30c0a6d31a1733590cf80c39e5.html#ga851cbf30c0a6d31a1733590cf80c39e5" title="Flag used by file_prepare_directory() -- create directory if not present.">FILE_CREATE_DIRECTORY</a>);
<a name="l03512"></a>03512     <span class="keywordflow">if</span> (!file_exists($uri) &amp;&amp; !<a class="code" href="group__file_gac2d047d4471ec93803f584cda01a557c.html#gac2d047d4471ec93803f584cda01a557c" title="Saves a string to the specified destination without invoking file API.">file_unmanaged_save_data</a>($data, $uri, <a class="code" href="group__file_ga54c3c90d9cb7857114326cb5114e7159.html#ga54c3c90d9cb7857114326cb5114e7159" title="Flag for dealing with existing files: Replace the existing file.">FILE_EXISTS_REPLACE</a>)) {
<a name="l03513"></a>03513       <span class="keywordflow">return</span> FALSE;
<a name="l03514"></a>03514     }
<a name="l03515"></a>03515     <span class="comment">// If CSS gzip compression is enabled, clean URLs are enabled (which means</span>
<a name="l03516"></a>03516     <span class="comment">// that rewrite rules are working) and the zlib extension is available then</span>
<a name="l03517"></a>03517     <span class="comment">// create a gzipped version of this file. This file is served conditionally</span>
<a name="l03518"></a>03518     <span class="comment">// to browsers that accept gzip using .htaccess rules.</span>
<a name="l03519"></a>03519     <span class="keywordflow">if</span> (<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;css_gzip_compression&#39;</span>, TRUE) &amp;&amp; <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;clean_url&#39;</span>, 0) &amp;&amp; extension_loaded(<span class="stringliteral">&#39;zlib&#39;</span>)) {
<a name="l03520"></a>03520       <span class="keywordflow">if</span> (!file_exists($uri . <span class="stringliteral">&#39;.gz&#39;</span>) &amp;&amp; !<a class="code" href="group__file_gac2d047d4471ec93803f584cda01a557c.html#gac2d047d4471ec93803f584cda01a557c" title="Saves a string to the specified destination without invoking file API.">file_unmanaged_save_data</a>(gzencode($data, 9, FORCE_GZIP), $uri . <span class="stringliteral">&#39;.gz&#39;</span>, <a class="code" href="group__file_ga54c3c90d9cb7857114326cb5114e7159.html#ga54c3c90d9cb7857114326cb5114e7159" title="Flag for dealing with existing files: Replace the existing file.">FILE_EXISTS_REPLACE</a>)) {
<a name="l03521"></a>03521         <span class="keywordflow">return</span> FALSE;
<a name="l03522"></a>03522       }
<a name="l03523"></a>03523     }
<a name="l03524"></a>03524     <span class="comment">// Save the updated map.</span>
<a name="l03525"></a>03525     $map[$key] = $uri;
<a name="l03526"></a>03526     <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;drupal_css_cache_files&#39;</span>, $map);
<a name="l03527"></a>03527   }
<a name="l03528"></a>03528   <span class="keywordflow">return</span> $uri;
<a name="l03529"></a>03529 }
<a name="l03530"></a>03530 
<a name="l03534"></a><a class="code" href="common_8inc_af634d8ae0731015c73e039895890b42b.html#af634d8ae0731015c73e039895890b42b">03534</a> <span class="keyword">function</span> <a class="code" href="common_8inc_af634d8ae0731015c73e039895890b42b.html#af634d8ae0731015c73e039895890b42b" title="Prefixes all paths within a CSS file for drupal_build_css_cache().">_drupal_build_css_path</a>($matches, $base = NULL) {
<a name="l03535"></a>03535   $_base = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__);
<a name="l03536"></a>03536   <span class="comment">// Store base path for preg_replace_callback.</span>
<a name="l03537"></a>03537   <span class="keywordflow">if</span> (isset($base)) {
<a name="l03538"></a>03538     $_base = $base;
<a name="l03539"></a>03539   }
<a name="l03540"></a>03540 
<a name="l03541"></a>03541   <span class="comment">// Prefix with base and remove &#39;../&#39; segments where possible.</span>
<a name="l03542"></a>03542   $path = $_base . $matches[1];
<a name="l03543"></a>03543   $last = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03544"></a>03544   <span class="keywordflow">while</span> ($path != $last) {
<a name="l03545"></a>03545     $last = $path;
<a name="l03546"></a>03546     $path = preg_replace(<span class="stringliteral">&#39;`(^|/)(?!\.\./)([^/]+)/\.\./`&#39;</span>, <span class="stringliteral">&#39;$1&#39;</span>, $path);
<a name="l03547"></a>03547   }
<a name="l03548"></a>03548   <span class="keywordflow">return</span> <span class="stringliteral">&#39;url(&#39;</span> . $path . <span class="charliteral">&#39;)&#39;</span>;
<a name="l03549"></a>03549 }
<a name="l03550"></a>03550 
<a name="l03572"></a><a class="code" href="common_8inc_a9c43f07915b6da92d97792c2b968a4cd.html#a9c43f07915b6da92d97792c2b968a4cd">03572</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a9c43f07915b6da92d97792c2b968a4cd.html#a9c43f07915b6da92d97792c2b968a4cd" title="Loads the stylesheet and resolves all  commands.">drupal_load_stylesheet</a>($file, $optimize = NULL, $reset_basepath = TRUE) {
<a name="l03573"></a>03573   <span class="comment">// These statics are not cache variables, so we don&#39;t use drupal_static().</span>
<a name="l03574"></a>03574   <span class="keyword">static</span> $_optimize, $basepath;
<a name="l03575"></a>03575   <span class="keywordflow">if</span> ($reset_basepath) {
<a name="l03576"></a>03576     $basepath = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03577"></a>03577   }
<a name="l03578"></a>03578   <span class="comment">// Store the value of $optimize for preg_replace_callback with nested</span>
<a name="l03579"></a>03579   <span class="comment">// @import loops.</span>
<a name="l03580"></a>03580   <span class="keywordflow">if</span> (isset($optimize)) {
<a name="l03581"></a>03581     $_optimize = $optimize;
<a name="l03582"></a>03582   }
<a name="l03583"></a>03583 
<a name="l03584"></a>03584   <span class="comment">// Stylesheets are relative one to each other. Start by adding a base path</span>
<a name="l03585"></a>03585   <span class="comment">// prefix provided by the parent stylesheet (if necessary).</span>
<a name="l03586"></a>03586   <span class="keywordflow">if</span> ($basepath &amp;&amp; !<a class="code" href="group__file_gaa98f967fe1033030e7e5262adda85463.html#gaa98f967fe1033030e7e5262adda85463" title="Returns the scheme of a URI (e.g.">file_uri_scheme</a>($file)) {
<a name="l03587"></a>03587     $file = $basepath . <span class="charliteral">&#39;/&#39;</span> . $file;
<a name="l03588"></a>03588   }
<a name="l03589"></a>03589   $basepath = dirname($file);
<a name="l03590"></a>03590 
<a name="l03591"></a>03591   <span class="comment">// Load the CSS stylesheet. We suppress errors because themes may specify</span>
<a name="l03592"></a>03592   <span class="comment">// stylesheets in their .info file that don&#39;t exist in the theme&#39;s path,</span>
<a name="l03593"></a>03593   <span class="comment">// but are merely there to disable certain module CSS files.</span>
<a name="l03594"></a>03594   <span class="keywordflow">if</span> ($contents = @file_get_contents($file)) {
<a name="l03595"></a>03595     <span class="comment">// Return the processed stylesheet.</span>
<a name="l03596"></a>03596     <span class="keywordflow">return</span> <a class="code" href="common_8inc_a3103cf0e37656ce026267e14260d9ea6.html#a3103cf0e37656ce026267e14260d9ea6" title="Processes the contents of a stylesheet for aggregation.">drupal_load_stylesheet_content</a>($contents, $_optimize);
<a name="l03597"></a>03597   }
<a name="l03598"></a>03598 
<a name="l03599"></a>03599   <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l03600"></a>03600 }
<a name="l03601"></a>03601 
<a name="l03614"></a><a class="code" href="common_8inc_a3103cf0e37656ce026267e14260d9ea6.html#a3103cf0e37656ce026267e14260d9ea6">03614</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a3103cf0e37656ce026267e14260d9ea6.html#a3103cf0e37656ce026267e14260d9ea6" title="Processes the contents of a stylesheet for aggregation.">drupal_load_stylesheet_content</a>($contents, $optimize = FALSE) {
<a name="l03615"></a>03615   <span class="comment">// Remove multiple charset declarations for standards compliance (and fixing Safari problems).</span>
<a name="l03616"></a>03616   $contents = preg_replace(<span class="stringliteral">&#39;/^@charset\s+[\&#39;&quot;](\S*)\b[\&#39;&quot;];/i&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $contents);
<a name="l03617"></a>03617 
<a name="l03618"></a>03618   <span class="keywordflow">if</span> ($optimize) {
<a name="l03619"></a>03619     <span class="comment">// Perform some safe CSS optimizations.</span>
<a name="l03620"></a>03620     <span class="comment">// Regexp to match comment blocks.</span>
<a name="l03621"></a>03621     $comment     = <span class="stringliteral">&#39;/\*[^*]*\*+(?:[^/*][^*]*\*+)*/&#39;</span>;
<a name="l03622"></a>03622     <span class="comment">// Regexp to match double quoted strings.</span>
<a name="l03623"></a>03623     $double_quot = <span class="stringliteral">&#39;&quot;[^&quot;\\\\]*(?:\\\\.[^&quot;\\\\]*)*&quot;&#39;</span>;
<a name="l03624"></a>03624     <span class="comment">// Regexp to match single quoted strings.</span>
<a name="l03625"></a>03625     $single_quot = <span class="stringliteral">&quot;&#39;[^&#39;\\\\]*(?:\\\\.[^&#39;\\\\]*)*&#39;&quot;</span>;
<a name="l03626"></a>03626     <span class="comment">// Strip all comment blocks, but keep double/single quoted strings.</span>
<a name="l03627"></a>03627     $contents = preg_replace(
<a name="l03628"></a>03628       <span class="stringliteral">&quot;&lt;($double_quot|$single_quot)|$comment&gt;Ss&quot;</span>,
<a name="l03629"></a>03629       <span class="stringliteral">&quot;$1&quot;</span>,
<a name="l03630"></a>03630       $contents
<a name="l03631"></a>03631     );
<a name="l03632"></a>03632     <span class="comment">// Remove certain whitespace.</span>
<a name="l03633"></a>03633     <span class="comment">// There are different conditions for removing leading and trailing</span>
<a name="l03634"></a>03634     <span class="comment">// whitespace.</span>
<a name="l03635"></a>03635     <span class="comment">// @see http://php.net/manual/en/regexp.reference.subpatterns.php</span>
<a name="l03636"></a>03636     $contents = preg_replace(<span class="stringliteral">&#39;&lt;</span>
<a name="l03637"></a>03637 <span class="stringliteral">      # Strip leading and trailing whitespace.</span>
<a name="l03638"></a>03638 <span class="stringliteral">        \s*([@{};,])\s*</span>
<a name="l03639"></a>03639 <span class="stringliteral">      # Strip only leading whitespace from:</span>
<a name="l03640"></a>03640 <span class="stringliteral">      # - Closing parenthesis: Retain &quot;@media (bar) and foo&quot;.</span>
<a name="l03641"></a>03641 <span class="stringliteral">      | \s+([\)])</span>
<a name="l03642"></a>03642 <span class="stringliteral">      # Strip only trailing whitespace from:</span>
<a name="l03643"></a>03643 <span class="stringliteral">      # - Opening parenthesis: Retain &quot;@media (bar) and foo&quot;.</span>
<a name="l03644"></a>03644 <span class="stringliteral">      # - Colon: Retain :pseudo-selectors.</span>
<a name="l03645"></a>03645 <span class="stringliteral">      | ([\(:])\s+</span>
<a name="l03646"></a>03646 <span class="stringliteral">    &gt;xS&#39;</span>,
<a name="l03647"></a>03647       <span class="comment">// Only one of the three capturing groups will match, so its reference</span>
<a name="l03648"></a>03648       <span class="comment">// will contain the wanted value and the references for the</span>
<a name="l03649"></a>03649       <span class="comment">// two non-matching groups will be replaced with empty strings.</span>
<a name="l03650"></a>03650       <span class="stringliteral">&#39;$1$2$3&#39;</span>,
<a name="l03651"></a>03651       $contents
<a name="l03652"></a>03652     );
<a name="l03653"></a>03653     <span class="comment">// End the file with a new line.</span>
<a name="l03654"></a>03654     $contents = trim($contents);
<a name="l03655"></a>03655     $contents .= <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l03656"></a>03656   }
<a name="l03657"></a>03657 
<a name="l03658"></a>03658   <span class="comment">// Replaces @import commands with the actual stylesheet content.</span>
<a name="l03659"></a>03659   <span class="comment">// This happens recursively but omits external files.</span>
<a name="l03660"></a>03660   $contents = preg_replace_callback(<span class="stringliteral">&#39;/@import\s*(?:url\(\s*)?[\&#39;&quot;]?(?![a-z]+:)([^\&#39;&quot;\()]+)[\&#39;&quot;]?\s*\)?\s*;/&#39;</span>, <span class="stringliteral">&#39;_drupal_load_stylesheet&#39;</span>, $contents);
<a name="l03661"></a>03661   <span class="keywordflow">return</span> $contents;
<a name="l03662"></a>03662 }
<a name="l03663"></a>03663 
<a name="l03670"></a><a class="code" href="common_8inc_a79a5c2b6f50963f2e185b6c34d6bd10e.html#a79a5c2b6f50963f2e185b6c34d6bd10e">03670</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a79a5c2b6f50963f2e185b6c34d6bd10e.html#a79a5c2b6f50963f2e185b6c34d6bd10e" title="Loads stylesheets recursively and returns contents with corrected paths.">_drupal_load_stylesheet</a>($matches) {
<a name="l03671"></a>03671   $filename = $matches[1];
<a name="l03672"></a>03672   <span class="comment">// Load the imported stylesheet and replace @import commands in there as well.</span>
<a name="l03673"></a>03673   $file = <a class="code" href="common_8inc_a9c43f07915b6da92d97792c2b968a4cd.html#a9c43f07915b6da92d97792c2b968a4cd" title="Loads the stylesheet and resolves all  commands.">drupal_load_stylesheet</a>($filename, NULL, FALSE);
<a name="l03674"></a>03674 
<a name="l03675"></a>03675   <span class="comment">// Determine the file&#39;s directory.</span>
<a name="l03676"></a>03676   $directory = dirname($filename);
<a name="l03677"></a>03677   <span class="comment">// If the file is in the current directory, make sure &#39;.&#39; doesn&#39;t appear in</span>
<a name="l03678"></a>03678   <span class="comment">// the url() path.</span>
<a name="l03679"></a>03679   $directory = $directory == <span class="charliteral">&#39;.&#39;</span> ? <span class="stringliteral">&#39;&#39;</span> : $directory .<span class="charliteral">&#39;/&#39;</span>;
<a name="l03680"></a>03680 
<a name="l03681"></a>03681   <span class="comment">// Alter all internal url() paths. Leave external paths alone. We don&#39;t need</span>
<a name="l03682"></a>03682   <span class="comment">// to normalize absolute paths here (i.e. remove folder/... segments) because</span>
<a name="l03683"></a>03683   <span class="comment">// that will be done later.</span>
<a name="l03684"></a>03684   <span class="keywordflow">return</span> preg_replace(<span class="stringliteral">&#39;/url\(\s*([\&#39;&quot;]?)(?![a-z]+:|\/+)/i&#39;</span>, <span class="stringliteral">&#39;url(\1&#39;</span>. $directory, $file);
<a name="l03685"></a>03685 }
<a name="l03686"></a>03686 
<a name="l03690"></a><a class="code" href="common_8inc_ae89dbd2b41a6623be2ed704d039a5c7c.html#ae89dbd2b41a6623be2ed704d039a5c7c">03690</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ae89dbd2b41a6623be2ed704d039a5c7c.html#ae89dbd2b41a6623be2ed704d039a5c7c" title="Deletes old cached CSS files.">drupal_clear_css_cache</a>() {
<a name="l03691"></a>03691   <a class="code" href="bootstrap_8inc_a7850bff5f313f85335f418e6d87606b1.html#a7850bff5f313f85335f418e6d87606b1" title="Unsets a persistent variable.">variable_del</a>(<span class="stringliteral">&#39;drupal_css_cache_files&#39;</span>);
<a name="l03692"></a>03692   <a class="code" href="group__file_ga363e988787ffa45bff69ff051eed0615.html#ga363e988787ffa45bff69ff051eed0615" title="Finds all files that match a given mask in a given directory.">file_scan_directory</a>(<span class="stringliteral">&#39;public://css&#39;</span>, <span class="stringliteral">&#39;/.*/&#39;</span>, array(<span class="stringliteral">&#39;callback&#39;</span> =&gt; <span class="stringliteral">&#39;drupal_delete_file_if_stale&#39;</span>));
<a name="l03693"></a>03693 }
<a name="l03694"></a>03694 
<a name="l03698"></a><a class="code" href="common_8inc_af70ef23972aa97b49877d5269c8f321c.html#af70ef23972aa97b49877d5269c8f321c">03698</a> <span class="keyword">function</span> <a class="code" href="common_8inc_af70ef23972aa97b49877d5269c8f321c.html#af70ef23972aa97b49877d5269c8f321c" title="Callback to delete files modified more than a set time ago.">drupal_delete_file_if_stale</a>($uri) {
<a name="l03699"></a>03699   <span class="comment">// Default stale file threshold is 30 days.</span>
<a name="l03700"></a>03700   <span class="keywordflow">if</span> (<a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a> - filemtime($uri) &gt; <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;drupal_stale_file_threshold&#39;</span>, 2592000)) {
<a name="l03701"></a>03701     <a class="code" href="group__file_ga336a7e83da1397131e665d1c6e97fc83.html#ga336a7e83da1397131e665d1c6e97fc83" title="Deletes a file without database changes or hook invocations.">file_unmanaged_delete</a>($uri);
<a name="l03702"></a>03702   }
<a name="l03703"></a>03703 }
<a name="l03704"></a>03704 
<a name="l03719"></a><a class="code" href="common_8inc_a71bc20ece521646a633b65868a441d26.html#a71bc20ece521646a633b65868a441d26">03719</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a71bc20ece521646a633b65868a441d26.html#a71bc20ece521646a633b65868a441d26" title="Prepares a string for use as a CSS identifier (element, class, or ID name).">drupal_clean_css_identifier</a>($identifier, $filter = array(<span class="charliteral">&#39; &#39;</span> =&gt; <span class="charliteral">&#39;-&#39;</span>, <span class="charliteral">&#39;_&#39;</span> =&gt; <span class="charliteral">&#39;-&#39;</span>, <span class="charliteral">&#39;/&#39;</span> =&gt; <span class="charliteral">&#39;-&#39;</span>, <span class="charliteral">&#39;[&#39;</span> =&gt; <span class="charliteral">&#39;-&#39;</span>, <span class="charliteral">&#39;]&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>)) {
<a name="l03720"></a>03720   <span class="comment">// By default, we filter using Drupal&#39;s coding standards.</span>
<a name="l03721"></a>03721   $identifier = strtr($identifier, $filter);
<a name="l03722"></a>03722 
<a name="l03723"></a>03723   <span class="comment">// Valid characters in a CSS identifier are:</span>
<a name="l03724"></a>03724   <span class="comment">// - the hyphen (U+002D)</span>
<a name="l03725"></a>03725   <span class="comment">// - a-z (U+0030 - U+0039)</span>
<a name="l03726"></a>03726   <span class="comment">// - A-Z (U+0041 - U+005A)</span>
<a name="l03727"></a>03727   <span class="comment">// - the underscore (U+005F)</span>
<a name="l03728"></a>03728   <span class="comment">// - 0-9 (U+0061 - U+007A)</span>
<a name="l03729"></a>03729   <span class="comment">// - ISO 10646 characters U+00A1 and higher</span>
<a name="l03730"></a>03730   <span class="comment">// We strip out any character not in the above list.</span>
<a name="l03731"></a>03731   $identifier = preg_replace(<span class="stringliteral">&#39;/[^\x{002D}\x{0030}-\x{0039}\x{0041}-\x{005A}\x{005F}\x{0061}-\x{007A}\x{00A1}-\x{FFFF}]/u&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $identifier);
<a name="l03732"></a>03732 
<a name="l03733"></a>03733   <span class="keywordflow">return</span> $identifier;
<a name="l03734"></a>03734 }
<a name="l03735"></a>03735 
<a name="l03748"></a><a class="code" href="common_8inc_aba9dd2b04e8c797c0f0edc9098cbbd48.html#aba9dd2b04e8c797c0f0edc9098cbbd48">03748</a> <span class="keyword">function</span> <a class="code" href="common_8inc_aba9dd2b04e8c797c0f0edc9098cbbd48.html#aba9dd2b04e8c797c0f0edc9098cbbd48" title="Prepares a string for use as a valid class name.">drupal_html_class</a>($class) {
<a name="l03749"></a>03749   <span class="keywordflow">return</span> <a class="code" href="common_8inc_a71bc20ece521646a633b65868a441d26.html#a71bc20ece521646a633b65868a441d26" title="Prepares a string for use as a CSS identifier (element, class, or ID name).">drupal_clean_css_identifier</a>(<a class="code" href="group__php__wrappers_gad97b9d0b7d26db7c62671e9ddce98f8f.html#gad97b9d0b7d26db7c62671e9ddce98f8f" title="Lowercase a UTF-8 string.">drupal_strtolower</a>($class));
<a name="l03750"></a>03750 }
<a name="l03751"></a>03751 
<a name="l03779"></a><a class="code" href="common_8inc_accaa7f3e2e401747b19be982c9f90323.html#accaa7f3e2e401747b19be982c9f90323">03779</a> <span class="keyword">function</span> <a class="code" href="common_8inc_accaa7f3e2e401747b19be982c9f90323.html#accaa7f3e2e401747b19be982c9f90323" title="Prepares a string for use as a valid HTML ID and guarantees uniqueness.">drupal_html_id</a>($id) {
<a name="l03780"></a>03780   <span class="comment">// If this is an Ajax request, then content returned by this page request will</span>
<a name="l03781"></a>03781   <span class="comment">// be merged with content already on the base page. The HTML IDs must be</span>
<a name="l03782"></a>03782   <span class="comment">// unique for the fully merged content. Therefore, initialize $seen_ids to</span>
<a name="l03783"></a>03783   <span class="comment">// take into account IDs that are already in use on the base page.</span>
<a name="l03784"></a>03784   $seen_ids_init = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__ . <span class="stringliteral">&#39;:init&#39;</span>);
<a name="l03785"></a>03785   <span class="keywordflow">if</span> (!isset($seen_ids_init)) {
<a name="l03786"></a>03786     <span class="comment">// Ideally, Drupal would provide an API to persist state information about</span>
<a name="l03787"></a>03787     <span class="comment">// prior page requests in the database, and we&#39;d be able to add this</span>
<a name="l03788"></a>03788     <span class="comment">// function&#39;s $seen_ids static variable to that state information in order</span>
<a name="l03789"></a>03789     <span class="comment">// to have it properly initialized for this page request. However, no such</span>
<a name="l03790"></a>03790     <span class="comment">// page state API exists, so instead, ajax.js adds all of the in-use HTML</span>
<a name="l03791"></a>03791     <span class="comment">// IDs to the POST data of Ajax submissions. Direct use of $_POST is</span>
<a name="l03792"></a>03792     <span class="comment">// normally not recommended as it could open up security risks, but because</span>
<a name="l03793"></a>03793     <span class="comment">// the raw POST data is cast to a number before being returned by this</span>
<a name="l03794"></a>03794     <span class="comment">// function, this usage is safe.</span>
<a name="l03795"></a>03795     <span class="keywordflow">if</span> (empty($_POST[<span class="stringliteral">&#39;ajax_html_ids&#39;</span>])) {
<a name="l03796"></a>03796       $seen_ids_init = array();
<a name="l03797"></a>03797     }
<a name="l03798"></a>03798     <span class="keywordflow">else</span> {
<a name="l03799"></a>03799       <span class="comment">// This function ensures uniqueness by appending a counter to the base id</span>
<a name="l03800"></a>03800       <span class="comment">// requested by the calling function after the first occurrence of that</span>
<a name="l03801"></a>03801       <span class="comment">// requested id. $_POST[&#39;ajax_html_ids&#39;] contains the ids as they were</span>
<a name="l03802"></a>03802       <span class="comment">// returned by this function, potentially with the appended counter, so</span>
<a name="l03803"></a>03803       <span class="comment">// we parse that to reconstruct the $seen_ids array.</span>
<a name="l03804"></a>03804       <span class="keywordflow">foreach</span> ($_POST[<span class="stringliteral">&#39;ajax_html_ids&#39;</span>] as $seen_id) {
<a name="l03805"></a>03805         <span class="comment">// We rely on &#39;--&#39; being used solely for separating a base id from the</span>
<a name="l03806"></a>03806         <span class="comment">// counter, which this function ensures when returning an id.</span>
<a name="l03807"></a>03807         $parts = explode(<span class="stringliteral">&#39;--&#39;</span>, $seen_id, 2);
<a name="l03808"></a>03808         <span class="keywordflow">if</span> (!empty($parts[1]) &amp;&amp; is_numeric($parts[1])) {
<a name="l03809"></a>03809           list($seen_id, $i) = $parts;
<a name="l03810"></a>03810         }
<a name="l03811"></a>03811         <span class="keywordflow">else</span> {
<a name="l03812"></a>03812           $i = 1;
<a name="l03813"></a>03813         }
<a name="l03814"></a>03814         <span class="keywordflow">if</span> (!isset($seen_ids_init[$seen_id]) || ($i &gt; $seen_ids_init[$seen_id])) {
<a name="l03815"></a>03815           $seen_ids_init[$seen_id] = $i;
<a name="l03816"></a>03816         }
<a name="l03817"></a>03817       }
<a name="l03818"></a>03818     }
<a name="l03819"></a>03819   }
<a name="l03820"></a>03820   $seen_ids = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__, $seen_ids_init);
<a name="l03821"></a>03821 
<a name="l03822"></a>03822   $id = strtr(<a class="code" href="group__php__wrappers_gad97b9d0b7d26db7c62671e9ddce98f8f.html#gad97b9d0b7d26db7c62671e9ddce98f8f" title="Lowercase a UTF-8 string.">drupal_strtolower</a>($id), array(<span class="charliteral">&#39; &#39;</span> =&gt; <span class="charliteral">&#39;-&#39;</span>, <span class="charliteral">&#39;_&#39;</span> =&gt; <span class="charliteral">&#39;-&#39;</span>, <span class="charliteral">&#39;[&#39;</span> =&gt; <span class="charliteral">&#39;-&#39;</span>, <span class="charliteral">&#39;]&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>));
<a name="l03823"></a>03823 
<a name="l03824"></a>03824   <span class="comment">// As defined in http://www.w3.org/TR/html4/types.html#type-name, HTML IDs can</span>
<a name="l03825"></a>03825   <span class="comment">// only contain letters, digits ([0-9]), hyphens (&quot;-&quot;), underscores (&quot;_&quot;),</span>
<a name="l03826"></a>03826   <span class="comment">// colons (&quot;:&quot;), and periods (&quot;.&quot;). We strip out any character not in that</span>
<a name="l03827"></a>03827   <span class="comment">// list. Note that the CSS spec doesn&#39;t allow colons or periods in identifiers</span>
<a name="l03828"></a>03828   <span class="comment">// (http://www.w3.org/TR/CSS21/syndata.html#characters), so we strip those two</span>
<a name="l03829"></a>03829   <span class="comment">// characters as well.</span>
<a name="l03830"></a>03830   $id = preg_replace(<span class="stringliteral">&#39;/[^A-Za-z0-9\-_]/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $id);
<a name="l03831"></a>03831 
<a name="l03832"></a>03832   <span class="comment">// Removing multiple consecutive hyphens.</span>
<a name="l03833"></a>03833   $id = preg_replace(<span class="stringliteral">&#39;/\-+/&#39;</span>, <span class="charliteral">&#39;-&#39;</span>, $id);
<a name="l03834"></a>03834   <span class="comment">// Ensure IDs are unique by appending a counter after the first occurrence.</span>
<a name="l03835"></a>03835   <span class="comment">// The counter needs to be appended with a delimiter that does not exist in</span>
<a name="l03836"></a>03836   <span class="comment">// the base ID. Requiring a unique delimiter helps ensure that we really do</span>
<a name="l03837"></a>03837   <span class="comment">// return unique IDs and also helps us re-create the $seen_ids array during</span>
<a name="l03838"></a>03838   <span class="comment">// Ajax requests.</span>
<a name="l03839"></a>03839   <span class="keywordflow">if</span> (isset($seen_ids[$id])) {
<a name="l03840"></a>03840     $id = $id . <span class="stringliteral">&#39;--&#39;</span> . ++$seen_ids[$id];
<a name="l03841"></a>03841   }
<a name="l03842"></a>03842   <span class="keywordflow">else</span> {
<a name="l03843"></a>03843     $seen_ids[$id] = 1;
<a name="l03844"></a>03844   }
<a name="l03845"></a>03845 
<a name="l03846"></a>03846   <span class="keywordflow">return</span> $id;
<a name="l03847"></a>03847 }
<a name="l03848"></a>03848 
<a name="l03867"></a><a class="code" href="common_8inc_a601489210268565d75adb9af61643e6c.html#a601489210268565d75adb9af61643e6c">03867</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a601489210268565d75adb9af61643e6c.html#a601489210268565d75adb9af61643e6c" title="Provides a standard HTML class name that identifies a page region.">drupal_region_class</a>($region) {
<a name="l03868"></a>03868   <span class="keywordflow">return</span> <a class="code" href="common_8inc_aba9dd2b04e8c797c0f0edc9098cbbd48.html#aba9dd2b04e8c797c0f0edc9098cbbd48" title="Prepares a string for use as a valid class name.">drupal_html_class</a>(<span class="stringliteral">&quot;region-$region&quot;</span>);
<a name="l03869"></a>03869 }
<a name="l03870"></a>03870 
<a name="l04018"></a><a class="code" href="common_8inc_a623370a2c3c2de0390dab078d17dca02.html#a623370a2c3c2de0390dab078d17dca02">04018</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a623370a2c3c2de0390dab078d17dca02.html#a623370a2c3c2de0390dab078d17dca02" title="Adds a JavaScript file, setting, or inline code to the page.">drupal_add_js</a>($data = NULL, $options = NULL) {
<a name="l04019"></a>04019   $javascript = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__, array());
<a name="l04020"></a>04020 
<a name="l04021"></a>04021   <span class="comment">// Construct the options, taking the defaults into consideration.</span>
<a name="l04022"></a>04022   <span class="keywordflow">if</span> (isset($options)) {
<a name="l04023"></a>04023     <span class="keywordflow">if</span> (!is_array($options)) {
<a name="l04024"></a>04024       $options = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; $options);
<a name="l04025"></a>04025     }
<a name="l04026"></a>04026   }
<a name="l04027"></a>04027   <span class="keywordflow">else</span> {
<a name="l04028"></a>04028     $options = array();
<a name="l04029"></a>04029   }
<a name="l04030"></a>04030   $options += <a class="code" href="common_8inc_a55203a07884e02b18a3be2a630c3fab3.html#a55203a07884e02b18a3be2a630c3fab3" title="Constructs an array of the defaults that are used for JavaScript items.">drupal_js_defaults</a>($data);
<a name="l04031"></a>04031 
<a name="l04032"></a>04032   <span class="comment">// Preprocess can only be set if caching is enabled.</span>
<a name="l04033"></a>04033   $options[<span class="stringliteral">&#39;preprocess&#39;</span>] = $options[<span class="stringliteral">&#39;cache&#39;</span>] ? $options[<span class="stringliteral">&#39;preprocess&#39;</span>] : FALSE;
<a name="l04034"></a>04034 
<a name="l04035"></a>04035   <span class="comment">// Tweak the weight so that files of the same weight are included in the</span>
<a name="l04036"></a>04036   <span class="comment">// order of the calls to drupal_add_js().</span>
<a name="l04037"></a>04037   $options[<span class="stringliteral">&#39;weight&#39;</span>] += count($javascript) / 1000;
<a name="l04038"></a>04038 
<a name="l04039"></a>04039   <span class="keywordflow">if</span> (isset($data)) {
<a name="l04040"></a>04040     <span class="comment">// Add jquery.js and drupal.js, as well as the basePath setting, the</span>
<a name="l04041"></a>04041     <span class="comment">// first time a JavaScript file is added.</span>
<a name="l04042"></a>04042     <span class="keywordflow">if</span> (empty($javascript)) {
<a name="l04043"></a>04043       <span class="comment">// url() generates the prefix using hook_url_outbound_alter(). Instead of</span>
<a name="l04044"></a>04044       <span class="comment">// running the hook_url_outbound_alter() again here, extract the prefix</span>
<a name="l04045"></a>04045       <span class="comment">// from url().</span>
<a name="l04046"></a>04046       <a class="code" href="common_8inc_a43b2a0594431556db49df980801d8807.html#a43b2a0594431556db49df980801d8807" title="End of &quot;defgroup format&quot;.">url</a>(<span class="stringliteral">&#39;&#39;</span>, array(<span class="stringliteral">&#39;prefix&#39;</span> =&gt; &amp;$prefix));
<a name="l04047"></a>04047       $javascript = array(
<a name="l04048"></a>04048         <span class="stringliteral">&#39;settings&#39;</span> =&gt; array(
<a name="l04049"></a>04049           <span class="stringliteral">&#39;data&#39;</span> =&gt; array(
<a name="l04050"></a>04050             array(<span class="stringliteral">&#39;basePath&#39;</span> =&gt; <a class="code" href="common_8inc_ae227697e9c239f09fd7e36f71afde771.html#ae227697e9c239f09fd7e36f71afde771" title="Returns the base URL path (i.e., directory) of the Drupal installation.">base_path</a>()),
<a name="l04051"></a>04051             array(<span class="stringliteral">&#39;pathPrefix&#39;</span> =&gt; empty($prefix) ? <span class="stringliteral">&#39;&#39;</span> : $prefix),
<a name="l04052"></a>04052           ),
<a name="l04053"></a>04053           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;setting&#39;</span>,
<a name="l04054"></a>04054           <span class="stringliteral">&#39;scope&#39;</span> =&gt; <span class="stringliteral">&#39;header&#39;</span>,
<a name="l04055"></a>04055           <span class="stringliteral">&#39;group&#39;</span> =&gt; <a class="code" href="common_8inc_a7efeab296e4345588b1279ec758e52b3.html#a7efeab296e4345588b1279ec758e52b3" title="The default group for JavaScript and jQuery libraries added to the page.">JS_LIBRARY</a>,
<a name="l04056"></a>04056           <span class="stringliteral">&#39;every_page&#39;</span> =&gt; TRUE,
<a name="l04057"></a>04057           <span class="stringliteral">&#39;weight&#39;</span> =&gt; 0,
<a name="l04058"></a>04058         ),
<a name="l04059"></a>04059         <span class="stringliteral">&#39;misc/drupal.js&#39;</span> =&gt; array(
<a name="l04060"></a>04060           <span class="stringliteral">&#39;data&#39;</span> =&gt; <span class="stringliteral">&#39;misc/drupal.js&#39;</span>,
<a name="l04061"></a>04061           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;file&#39;</span>,
<a name="l04062"></a>04062           <span class="stringliteral">&#39;scope&#39;</span> =&gt; <span class="stringliteral">&#39;header&#39;</span>,
<a name="l04063"></a>04063           <span class="stringliteral">&#39;group&#39;</span> =&gt; <a class="code" href="common_8inc_a7efeab296e4345588b1279ec758e52b3.html#a7efeab296e4345588b1279ec758e52b3" title="The default group for JavaScript and jQuery libraries added to the page.">JS_LIBRARY</a>,
<a name="l04064"></a>04064           <span class="stringliteral">&#39;every_page&#39;</span> =&gt; TRUE,
<a name="l04065"></a>04065           <span class="stringliteral">&#39;weight&#39;</span> =&gt; -1,
<a name="l04066"></a>04066           <span class="stringliteral">&#39;preprocess&#39;</span> =&gt; TRUE,
<a name="l04067"></a>04067           <span class="stringliteral">&#39;cache&#39;</span> =&gt; TRUE,
<a name="l04068"></a>04068           <span class="stringliteral">&#39;defer&#39;</span> =&gt; FALSE,
<a name="l04069"></a>04069         ),
<a name="l04070"></a>04070       );
<a name="l04071"></a>04071       <span class="comment">// Register all required libraries.</span>
<a name="l04072"></a>04072       <a class="code" href="common_8inc_a10d0b7349429391743b9ffc49b48908a.html#a10d0b7349429391743b9ffc49b48908a" title="Adds multiple JavaScript or CSS files at the same time.">drupal_add_library</a>(<span class="stringliteral">&#39;system&#39;</span>, <span class="stringliteral">&#39;jquery&#39;</span>, TRUE);
<a name="l04073"></a>04073       <a class="code" href="common_8inc_a10d0b7349429391743b9ffc49b48908a.html#a10d0b7349429391743b9ffc49b48908a" title="Adds multiple JavaScript or CSS files at the same time.">drupal_add_library</a>(<span class="stringliteral">&#39;system&#39;</span>, <span class="stringliteral">&#39;jquery.once&#39;</span>, TRUE);
<a name="l04074"></a>04074     }
<a name="l04075"></a>04075 
<a name="l04076"></a>04076     <span class="keywordflow">switch</span> ($options[<span class="stringliteral">&#39;type&#39;</span>]) {
<a name="l04077"></a>04077       <span class="keywordflow">case</span> <span class="stringliteral">&#39;setting&#39;</span>:
<a name="l04078"></a>04078         <span class="comment">// All JavaScript settings are placed in the header of the page with</span>
<a name="l04079"></a>04079         <span class="comment">// the library weight so that inline scripts appear afterwards.</span>
<a name="l04080"></a>04080         $javascript[<span class="stringliteral">&#39;settings&#39;</span>][<span class="stringliteral">&#39;data&#39;</span>][] = $data;
<a name="l04081"></a>04081         <span class="keywordflow">break</span>;
<a name="l04082"></a>04082 
<a name="l04083"></a>04083       <span class="keywordflow">case</span> <span class="stringliteral">&#39;inline&#39;</span>:
<a name="l04084"></a>04084         $javascript[] = $options;
<a name="l04085"></a>04085         <span class="keywordflow">break</span>;
<a name="l04086"></a>04086 
<a name="l04087"></a>04087       <span class="keywordflow">default</span>: <span class="comment">// &#39;file&#39; and &#39;external&#39;</span>
<a name="l04088"></a>04088         <span class="comment">// Local and external files must keep their name as the associative key</span>
<a name="l04089"></a>04089         <span class="comment">// so the same JavaScript file is not added twice.</span>
<a name="l04090"></a>04090         $javascript[$options[<span class="stringliteral">&#39;data&#39;</span>]] = $options;
<a name="l04091"></a>04091     }
<a name="l04092"></a>04092   }
<a name="l04093"></a>04093   <span class="keywordflow">return</span> $javascript;
<a name="l04094"></a>04094 }
<a name="l04095"></a>04095 
<a name="l04105"></a><a class="code" href="common_8inc_a55203a07884e02b18a3be2a630c3fab3.html#a55203a07884e02b18a3be2a630c3fab3">04105</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a55203a07884e02b18a3be2a630c3fab3.html#a55203a07884e02b18a3be2a630c3fab3" title="Constructs an array of the defaults that are used for JavaScript items.">drupal_js_defaults</a>($data = NULL) {
<a name="l04106"></a>04106   <span class="keywordflow">return</span> array(
<a name="l04107"></a>04107     <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;file&#39;</span>,
<a name="l04108"></a>04108     <span class="stringliteral">&#39;group&#39;</span> =&gt; <a class="code" href="common_8inc_ade8dfc1503d597ba5ea4af975b0d8811.html#ade8dfc1503d597ba5ea4af975b0d8811" title="The default group for module JavaScript code added to the page.">JS_DEFAULT</a>,
<a name="l04109"></a>04109     <span class="stringliteral">&#39;every_page&#39;</span> =&gt; FALSE,
<a name="l04110"></a>04110     <span class="stringliteral">&#39;weight&#39;</span> =&gt; 0,
<a name="l04111"></a>04111     <span class="stringliteral">&#39;scope&#39;</span> =&gt; <span class="stringliteral">&#39;header&#39;</span>,
<a name="l04112"></a>04112     <span class="stringliteral">&#39;cache&#39;</span> =&gt; TRUE,
<a name="l04113"></a>04113     <span class="stringliteral">&#39;defer&#39;</span> =&gt; FALSE,
<a name="l04114"></a>04114     <span class="stringliteral">&#39;preprocess&#39;</span> =&gt; TRUE,
<a name="l04115"></a>04115     <span class="stringliteral">&#39;version&#39;</span> =&gt; NULL,
<a name="l04116"></a>04116     <span class="stringliteral">&#39;data&#39;</span> =&gt; $data,
<a name="l04117"></a>04117   );
<a name="l04118"></a>04118 }
<a name="l04119"></a>04119 
<a name="l04153"></a><a class="code" href="common_8inc_ac4d279ffd40eae67ace8459cd3e6e3b5.html#ac4d279ffd40eae67ace8459cd3e6e3b5">04153</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ac4d279ffd40eae67ace8459cd3e6e3b5.html#ac4d279ffd40eae67ace8459cd3e6e3b5" title="Returns a themed presentation of all JavaScript code for the current page.">drupal_get_js</a>($scope = <span class="stringliteral">&#39;header&#39;</span>, $javascript = NULL, $skip_alter = FALSE) {
<a name="l04154"></a>04154   <span class="keywordflow">if</span> (!isset($javascript)) {
<a name="l04155"></a>04155     $javascript = <a class="code" href="common_8inc_a623370a2c3c2de0390dab078d17dca02.html#a623370a2c3c2de0390dab078d17dca02" title="Adds a JavaScript file, setting, or inline code to the page.">drupal_add_js</a>();
<a name="l04156"></a>04156   }
<a name="l04157"></a>04157   <span class="keywordflow">if</span> (empty($javascript)) {
<a name="l04158"></a>04158     <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l04159"></a>04159   }
<a name="l04160"></a>04160 
<a name="l04161"></a>04161   <span class="comment">// Allow modules to alter the JavaScript.</span>
<a name="l04162"></a>04162   <span class="keywordflow">if</span> (!$skip_alter) {
<a name="l04163"></a>04163     <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;js&#39;</span>, $javascript);
<a name="l04164"></a>04164   }
<a name="l04165"></a>04165 
<a name="l04166"></a>04166   <span class="comment">// Filter out elements of the given scope.</span>
<a name="l04167"></a>04167   $items = array();
<a name="l04168"></a>04168   <span class="keywordflow">foreach</span> ($javascript as $key =&gt; $item) {
<a name="l04169"></a>04169     <span class="keywordflow">if</span> ($item[<span class="stringliteral">&#39;scope&#39;</span>] == $scope) {
<a name="l04170"></a>04170       $items[$key] = $item;
<a name="l04171"></a>04171     }
<a name="l04172"></a>04172   }
<a name="l04173"></a>04173 
<a name="l04174"></a>04174   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04175"></a>04175   <span class="comment">// The index counter is used to keep aggregated and non-aggregated files in</span>
<a name="l04176"></a>04176   <span class="comment">// order by weight.</span>
<a name="l04177"></a>04177   $index = 1;
<a name="l04178"></a>04178   $processed = array();
<a name="l04179"></a>04179   $files = array();
<a name="l04180"></a>04180   $preprocess_js = (<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;preprocess_js&#39;</span>, FALSE) &amp;&amp; (!defined(<span class="stringliteral">&#39;MAINTENANCE_MODE&#39;</span>) || <a class="code" href="authorize_8php_a5bf6dfe9ba7ee16c648e3932aa76535d.html#a5bf6dfe9ba7ee16c648e3932aa76535d" title="Global flag to identify update.php and authorize.php runs, and so avoid various unwanted operations...">MAINTENANCE_MODE</a> != <span class="stringliteral">&#39;update&#39;</span>));
<a name="l04181"></a>04181 
<a name="l04182"></a>04182   <span class="comment">// A dummy query-string is added to filenames, to gain control over</span>
<a name="l04183"></a>04183   <span class="comment">// browser-caching. The string changes on every update or full cache</span>
<a name="l04184"></a>04184   <span class="comment">// flush, forcing browsers to load a new copy of the files, as the</span>
<a name="l04185"></a>04185   <span class="comment">// URL changed. Files that should not be cached (see drupal_add_js())</span>
<a name="l04186"></a>04186   <span class="comment">// get REQUEST_TIME as query-string instead, to enforce reload on every</span>
<a name="l04187"></a>04187   <span class="comment">// page request.</span>
<a name="l04188"></a>04188   $default_query_string = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;css_js_query_string&#39;</span>, <span class="charliteral">&#39;0&#39;</span>);
<a name="l04189"></a>04189 
<a name="l04190"></a>04190   <span class="comment">// For inline JavaScript to validate as XHTML, all JavaScript containing</span>
<a name="l04191"></a>04191   <span class="comment">// XHTML needs to be wrapped in CDATA. To make that backwards compatible</span>
<a name="l04192"></a>04192   <span class="comment">// with HTML 4, we need to comment out the CDATA-tag.</span>
<a name="l04193"></a>04193   $embed_prefix = <span class="stringliteral">&quot;\n&lt;!--//--&gt;&lt;![CDATA[//&gt;&lt;!--\n&quot;</span>;
<a name="l04194"></a>04194   $embed_suffix = <span class="stringliteral">&quot;\n//--&gt;&lt;!]]&gt;\n&quot;</span>;
<a name="l04195"></a>04195 
<a name="l04196"></a>04196   <span class="comment">// Since JavaScript may look for arguments in the URL and act on them, some</span>
<a name="l04197"></a>04197   <span class="comment">// third-party code might require the use of a different query string.</span>
<a name="l04198"></a>04198   $js_version_string = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;drupal_js_version_query_string&#39;</span>, <span class="stringliteral">&#39;v=&#39;</span>);
<a name="l04199"></a>04199 
<a name="l04200"></a>04200   <span class="comment">// Sort the JavaScript so that it appears in the correct order.</span>
<a name="l04201"></a>04201   uasort($items, <span class="stringliteral">&#39;drupal_sort_css_js&#39;</span>);
<a name="l04202"></a>04202 
<a name="l04203"></a>04203   <span class="comment">// Provide the page with information about the individual JavaScript files</span>
<a name="l04204"></a>04204   <span class="comment">// used, information not otherwise available when aggregation is enabled.</span>
<a name="l04205"></a>04205   $setting[<span class="stringliteral">&#39;ajaxPageState&#39;</span>][<span class="stringliteral">&#39;js&#39;</span>] = array_fill_keys(array_keys($items), 1);
<a name="l04206"></a>04206   unset($setting[<span class="stringliteral">&#39;ajaxPageState&#39;</span>][<span class="stringliteral">&#39;js&#39;</span>][<span class="stringliteral">&#39;settings&#39;</span>]);
<a name="l04207"></a>04207   <a class="code" href="common_8inc_a623370a2c3c2de0390dab078d17dca02.html#a623370a2c3c2de0390dab078d17dca02" title="Adds a JavaScript file, setting, or inline code to the page.">drupal_add_js</a>($setting, <span class="stringliteral">&#39;setting&#39;</span>);
<a name="l04208"></a>04208 
<a name="l04209"></a>04209   <span class="comment">// If we&#39;re outputting the header scope, then this might be the final time</span>
<a name="l04210"></a>04210   <span class="comment">// that drupal_get_js() is running, so add the setting to this output as well</span>
<a name="l04211"></a>04211   <span class="comment">// as to the drupal_add_js() cache. If $items[&#39;settings&#39;] doesn&#39;t exist, it&#39;s</span>
<a name="l04212"></a>04212   <span class="comment">// because drupal_get_js() was intentionally passed a $javascript argument</span>
<a name="l04213"></a>04213   <span class="comment">// stripped off settings, potentially in order to override how settings get</span>
<a name="l04214"></a>04214   <span class="comment">// output, so in this case, do not add the setting to this output.</span>
<a name="l04215"></a>04215   <span class="keywordflow">if</span> ($scope == <span class="stringliteral">&#39;header&#39;</span> &amp;&amp; isset($items[<span class="stringliteral">&#39;settings&#39;</span>])) {
<a name="l04216"></a>04216     $items[<span class="stringliteral">&#39;settings&#39;</span>][<span class="stringliteral">&#39;data&#39;</span>][] = $setting;
<a name="l04217"></a>04217   }
<a name="l04218"></a>04218 
<a name="l04219"></a>04219   <span class="comment">// Loop through the JavaScript to construct the rendered output.</span>
<a name="l04220"></a>04220   $element = array(
<a name="l04221"></a>04221     <span class="stringliteral">&#39;#tag&#39;</span> =&gt; <span class="stringliteral">&#39;script&#39;</span>,
<a name="l04222"></a>04222     <span class="stringliteral">&#39;#value&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l04223"></a>04223     <span class="stringliteral">&#39;#attributes&#39;</span> =&gt; array(
<a name="l04224"></a>04224       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;text/javascript&#39;</span>,
<a name="l04225"></a>04225     ),
<a name="l04226"></a>04226   );
<a name="l04227"></a>04227   <span class="keywordflow">foreach</span> ($items as $item) {
<a name="l04228"></a>04228     $query_string =  empty($item[<span class="stringliteral">&#39;version&#39;</span>]) ? $default_query_string : $js_version_string . $item[<span class="stringliteral">&#39;version&#39;</span>];
<a name="l04229"></a>04229 
<a name="l04230"></a>04230     <span class="keywordflow">switch</span> ($item[<span class="stringliteral">&#39;type&#39;</span>]) {
<a name="l04231"></a>04231       <span class="keywordflow">case</span> <span class="stringliteral">&#39;setting&#39;</span>:
<a name="l04232"></a>04232         $js_element = $element;
<a name="l04233"></a>04233         $js_element[<span class="stringliteral">&#39;#value_prefix&#39;</span>] = $embed_prefix;
<a name="l04234"></a>04234         $js_element[<span class="stringliteral">&#39;#value&#39;</span>] = <span class="stringliteral">&#39;jQuery.extend(Drupal.settings, &#39;</span> . <a class="code" href="group__php__wrappers_gaf09c80fb758b9f3657772e26817e37b9.html#gaf09c80fb758b9f3657772e26817e37b9" title="Converts a PHP variable into its JavaScript equivalent.">drupal_json_encode</a>(<a class="code" href="bootstrap_8inc_a1167ab45bbb945a5e6fd806b536eef70.html#a1167ab45bbb945a5e6fd806b536eef70" title="Merges multiple arrays, recursively, and returns the merged array.">drupal_array_merge_deep_array</a>($item[<span class="stringliteral">&#39;data&#39;</span>])) . <span class="stringliteral">&quot;);&quot;</span>;
<a name="l04235"></a>04235         $js_element[<span class="stringliteral">&#39;#value_suffix&#39;</span>] = $embed_suffix;
<a name="l04236"></a>04236         <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <a class="code" href="theme_8inc_a7c25609a935874541a19657affd30fff.html#a7c25609a935874541a19657affd30fff" title="Generates themed output.">theme</a>(<span class="stringliteral">&#39;html_tag&#39;</span>, array(<span class="stringliteral">&#39;element&#39;</span> =&gt; $js_element));
<a name="l04237"></a>04237         <span class="keywordflow">break</span>;
<a name="l04238"></a>04238 
<a name="l04239"></a>04239       <span class="keywordflow">case</span> <span class="stringliteral">&#39;inline&#39;</span>:
<a name="l04240"></a>04240         $js_element = $element;
<a name="l04241"></a>04241         <span class="keywordflow">if</span> ($item[<span class="stringliteral">&#39;defer&#39;</span>]) {
<a name="l04242"></a>04242           $js_element[<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;defer&#39;</span>] = <span class="stringliteral">&#39;defer&#39;</span>;
<a name="l04243"></a>04243         }
<a name="l04244"></a>04244         $js_element[<span class="stringliteral">&#39;#value_prefix&#39;</span>] = $embed_prefix;
<a name="l04245"></a>04245         $js_element[<span class="stringliteral">&#39;#value&#39;</span>] = $item[<span class="stringliteral">&#39;data&#39;</span>];
<a name="l04246"></a>04246         $js_element[<span class="stringliteral">&#39;#value_suffix&#39;</span>] = $embed_suffix;
<a name="l04247"></a>04247         $processed[$index++] = <a class="code" href="theme_8inc_a7c25609a935874541a19657affd30fff.html#a7c25609a935874541a19657affd30fff" title="Generates themed output.">theme</a>(<span class="stringliteral">&#39;html_tag&#39;</span>, array(<span class="stringliteral">&#39;element&#39;</span> =&gt; $js_element));
<a name="l04248"></a>04248         <span class="keywordflow">break</span>;
<a name="l04249"></a>04249 
<a name="l04250"></a>04250       <span class="keywordflow">case</span> <span class="stringliteral">&#39;file&#39;</span>:
<a name="l04251"></a>04251         $js_element = $element;
<a name="l04252"></a>04252         <span class="keywordflow">if</span> (!$item[<span class="stringliteral">&#39;preprocess&#39;</span>] || !$preprocess_js) {
<a name="l04253"></a>04253           <span class="keywordflow">if</span> ($item[<span class="stringliteral">&#39;defer&#39;</span>]) {
<a name="l04254"></a>04254             $js_element[<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;defer&#39;</span>] = <span class="stringliteral">&#39;defer&#39;</span>;
<a name="l04255"></a>04255           }
<a name="l04256"></a>04256           $query_string_separator = (strpos($item[<span class="stringliteral">&#39;data&#39;</span>], <span class="charliteral">&#39;?&#39;</span>) !== FALSE) ? <span class="charliteral">&#39;&amp;&#39;</span> : <span class="charliteral">&#39;?&#39;</span>;
<a name="l04257"></a>04257           $js_element[<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;src&#39;</span>] = <a class="code" href="group__file_gaee57f47d60bda90961a2e19d580d4908.html#gaee57f47d60bda90961a2e19d580d4908" title="Creates a web-accessible URL for a stream to an external or local file.">file_create_url</a>($item[<span class="stringliteral">&#39;data&#39;</span>]) . $query_string_separator . ($item[<span class="stringliteral">&#39;cache&#39;</span>] ? $query_string : <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a>);
<a name="l04258"></a>04258           $processed[$index++] = <a class="code" href="theme_8inc_a7c25609a935874541a19657affd30fff.html#a7c25609a935874541a19657affd30fff" title="Generates themed output.">theme</a>(<span class="stringliteral">&#39;html_tag&#39;</span>, array(<span class="stringliteral">&#39;element&#39;</span> =&gt; $js_element));
<a name="l04259"></a>04259         }
<a name="l04260"></a>04260         <span class="keywordflow">else</span> {
<a name="l04261"></a>04261           <span class="comment">// By increasing the index for each aggregated file, we maintain</span>
<a name="l04262"></a>04262           <span class="comment">// the relative ordering of JS by weight. We also set the key such</span>
<a name="l04263"></a>04263           <span class="comment">// that groups are split by items sharing the same &#39;group&#39; value and</span>
<a name="l04264"></a>04264           <span class="comment">// &#39;every_page&#39; flag. While this potentially results in more aggregate</span>
<a name="l04265"></a>04265           <span class="comment">// files, it helps make each one more reusable across a site visit,</span>
<a name="l04266"></a>04266           <span class="comment">// leading to better front-end performance of a website as a whole.</span>
<a name="l04267"></a>04267           <span class="comment">// See drupal_add_js() for details.</span>
<a name="l04268"></a>04268           $key = <span class="stringliteral">&#39;aggregate_&#39;</span> . $item[<span class="stringliteral">&#39;group&#39;</span>] . <span class="charliteral">&#39;_&#39;</span> . $item[<span class="stringliteral">&#39;every_page&#39;</span>] . <span class="charliteral">&#39;_&#39;</span> . $index;
<a name="l04269"></a>04269           $processed[$key] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04270"></a>04270           $files[$key][$item[<span class="stringliteral">&#39;data&#39;</span>]] = $item;
<a name="l04271"></a>04271         }
<a name="l04272"></a>04272         <span class="keywordflow">break</span>;
<a name="l04273"></a>04273 
<a name="l04274"></a>04274       <span class="keywordflow">case</span> <span class="stringliteral">&#39;external&#39;</span>:
<a name="l04275"></a>04275         $js_element = $element;
<a name="l04276"></a>04276         <span class="comment">// Preprocessing for external JavaScript files is ignored.</span>
<a name="l04277"></a>04277         <span class="keywordflow">if</span> ($item[<span class="stringliteral">&#39;defer&#39;</span>]) {
<a name="l04278"></a>04278           $js_element[<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;defer&#39;</span>] = <span class="stringliteral">&#39;defer&#39;</span>;
<a name="l04279"></a>04279         }
<a name="l04280"></a>04280         $js_element[<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;src&#39;</span>] = $item[<span class="stringliteral">&#39;data&#39;</span>];
<a name="l04281"></a>04281         $processed[$index++] = <a class="code" href="theme_8inc_a7c25609a935874541a19657affd30fff.html#a7c25609a935874541a19657affd30fff" title="Generates themed output.">theme</a>(<span class="stringliteral">&#39;html_tag&#39;</span>, array(<span class="stringliteral">&#39;element&#39;</span> =&gt; $js_element));
<a name="l04282"></a>04282         <span class="keywordflow">break</span>;
<a name="l04283"></a>04283     }
<a name="l04284"></a>04284   }
<a name="l04285"></a>04285 
<a name="l04286"></a>04286   <span class="comment">// Aggregate any remaining JS files that haven&#39;t already been output.</span>
<a name="l04287"></a>04287   <span class="keywordflow">if</span> ($preprocess_js &amp;&amp; count($files) &gt; 0) {
<a name="l04288"></a>04288     <span class="keywordflow">foreach</span> ($files as $key =&gt; $file_set) {
<a name="l04289"></a>04289       $uri = <a class="code" href="common_8inc_a1e1e39db4d513a984d7d76ba8cd68a9b.html#a1e1e39db4d513a984d7d76ba8cd68a9b" title="Aggregates JavaScript files into a cache file in the files directory.">drupal_build_js_cache</a>($file_set);
<a name="l04290"></a>04290       <span class="comment">// Only include the file if was written successfully. Errors are logged</span>
<a name="l04291"></a>04291       <span class="comment">// using watchdog.</span>
<a name="l04292"></a>04292       <span class="keywordflow">if</span> ($uri) {
<a name="l04293"></a>04293         $preprocess_file = <a class="code" href="group__file_gaee57f47d60bda90961a2e19d580d4908.html#gaee57f47d60bda90961a2e19d580d4908" title="Creates a web-accessible URL for a stream to an external or local file.">file_create_url</a>($uri);
<a name="l04294"></a>04294         $js_element = $element;
<a name="l04295"></a>04295         $js_element[<span class="stringliteral">&#39;#attributes&#39;</span>][<span class="stringliteral">&#39;src&#39;</span>] = $preprocess_file;
<a name="l04296"></a>04296         $processed[$key] = <a class="code" href="theme_8inc_a7c25609a935874541a19657affd30fff.html#a7c25609a935874541a19657affd30fff" title="Generates themed output.">theme</a>(<span class="stringliteral">&#39;html_tag&#39;</span>, array(<span class="stringliteral">&#39;element&#39;</span> =&gt; $js_element));
<a name="l04297"></a>04297       }
<a name="l04298"></a>04298     }
<a name="l04299"></a>04299   }
<a name="l04300"></a>04300 
<a name="l04301"></a>04301   <span class="comment">// Keep the order of JS files consistent as some are preprocessed and others are not.</span>
<a name="l04302"></a>04302   <span class="comment">// Make sure any inline or JS setting variables appear last after libraries have loaded.</span>
<a name="l04303"></a>04303   <span class="keywordflow">return</span> implode(<span class="stringliteral">&#39;&#39;</span>, $processed) . <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>;
<a name="l04304"></a>04304 }
<a name="l04305"></a>04305 
<a name="l04362"></a><a class="code" href="common_8inc_a31e3a25219e1d3a2f74670694b30dee6.html#a31e3a25219e1d3a2f74670694b30dee6">04362</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a31e3a25219e1d3a2f74670694b30dee6.html#a31e3a25219e1d3a2f74670694b30dee6" title="Adds attachments to a render() structure.">drupal_process_attached</a>($elements, $group = <a class="code" href="common_8inc_ade8dfc1503d597ba5ea4af975b0d8811.html#ade8dfc1503d597ba5ea4af975b0d8811" title="The default group for module JavaScript code added to the page.">JS_DEFAULT</a>, $dependency_check = FALSE, $every_page = NULL) {
<a name="l04363"></a>04363   <span class="comment">// Add defaults to the special attached structures that should be processed differently.</span>
<a name="l04364"></a>04364   $elements[<span class="stringliteral">&#39;#attached&#39;</span>] += array(
<a name="l04365"></a>04365     <span class="stringliteral">&#39;library&#39;</span> =&gt; array(),
<a name="l04366"></a>04366     <span class="stringliteral">&#39;js&#39;</span> =&gt; array(),
<a name="l04367"></a>04367     <span class="stringliteral">&#39;css&#39;</span> =&gt; array(),
<a name="l04368"></a>04368   );
<a name="l04369"></a>04369 
<a name="l04370"></a>04370   <span class="comment">// Add the libraries first.</span>
<a name="l04371"></a>04371   $success = TRUE;
<a name="l04372"></a>04372   <span class="keywordflow">foreach</span> ($elements[<span class="stringliteral">&#39;#attached&#39;</span>][<span class="stringliteral">&#39;library&#39;</span>] as $library) {
<a name="l04373"></a>04373     <span class="keywordflow">if</span> (<a class="code" href="common_8inc_a10d0b7349429391743b9ffc49b48908a.html#a10d0b7349429391743b9ffc49b48908a" title="Adds multiple JavaScript or CSS files at the same time.">drupal_add_library</a>($library[0], $library[1], $every_page) === FALSE) {
<a name="l04374"></a>04374       $success = FALSE;
<a name="l04375"></a>04375       <span class="comment">// Exit if the dependency is missing.</span>
<a name="l04376"></a>04376       <span class="keywordflow">if</span> ($dependency_check) {
<a name="l04377"></a>04377         <span class="keywordflow">return</span> $success;
<a name="l04378"></a>04378       }
<a name="l04379"></a>04379     }
<a name="l04380"></a>04380   }
<a name="l04381"></a>04381   unset($elements[<span class="stringliteral">&#39;#attached&#39;</span>][<span class="stringliteral">&#39;library&#39;</span>]);
<a name="l04382"></a>04382 
<a name="l04383"></a>04383   <span class="comment">// Add both the JavaScript and the CSS.</span>
<a name="l04384"></a>04384   <span class="comment">// The parameters for drupal_add_js() and drupal_add_css() require special</span>
<a name="l04385"></a>04385   <span class="comment">// handling.</span>
<a name="l04386"></a>04386   <span class="keywordflow">foreach</span> (array(<span class="stringliteral">&#39;js&#39;</span>, <span class="stringliteral">&#39;css&#39;</span>) as $type) {
<a name="l04387"></a>04387     <span class="keywordflow">foreach</span> ($elements[<span class="stringliteral">&#39;#attached&#39;</span>][$type] as $data =&gt; $options) {
<a name="l04388"></a>04388       <span class="comment">// If the value is not an array, it&#39;s a filename and passed as first</span>
<a name="l04389"></a>04389       <span class="comment">// (and only) argument.</span>
<a name="l04390"></a>04390       <span class="keywordflow">if</span> (!is_array($options)) {
<a name="l04391"></a>04391         $data = $options;
<a name="l04392"></a>04392         $options = NULL;
<a name="l04393"></a>04393       }
<a name="l04394"></a>04394       <span class="comment">// In some cases, the first parameter ($data) is an array. Arrays can&#39;t be</span>
<a name="l04395"></a>04395       <span class="comment">// passed as keys in PHP, so we have to get $data from the value array.</span>
<a name="l04396"></a>04396       <span class="keywordflow">if</span> (is_numeric($data)) {
<a name="l04397"></a>04397         $data = $options[<span class="stringliteral">&#39;data&#39;</span>];
<a name="l04398"></a>04398         unset($options[<span class="stringliteral">&#39;data&#39;</span>]);
<a name="l04399"></a>04399       }
<a name="l04400"></a>04400       <span class="comment">// Apply the default group if it isn&#39;t explicitly given.</span>
<a name="l04401"></a>04401       <span class="keywordflow">if</span> (!isset($options[<span class="stringliteral">&#39;group&#39;</span>])) {
<a name="l04402"></a>04402         $options[<span class="stringliteral">&#39;group&#39;</span>] = $group;
<a name="l04403"></a>04403       }
<a name="l04404"></a>04404       <span class="comment">// Set the every_page flag if one was passed.</span>
<a name="l04405"></a>04405       <span class="keywordflow">if</span> (isset($every_page)) {
<a name="l04406"></a>04406         $options[<span class="stringliteral">&#39;every_page&#39;</span>] = $every_page;
<a name="l04407"></a>04407       }
<a name="l04408"></a>04408       call_user_func(<span class="stringliteral">&#39;drupal_add_&#39;</span> . $type, $data, $options);
<a name="l04409"></a>04409     }
<a name="l04410"></a>04410     unset($elements[<span class="stringliteral">&#39;#attached&#39;</span>][$type]);
<a name="l04411"></a>04411   }
<a name="l04412"></a>04412 
<a name="l04413"></a>04413   <span class="comment">// Add additional types of attachments specified in the render() structure.</span>
<a name="l04414"></a>04414   <span class="comment">// Libraries, JavaScript and CSS have been added already, as they require</span>
<a name="l04415"></a>04415   <span class="comment">// special handling.</span>
<a name="l04416"></a>04416   <span class="keywordflow">foreach</span> ($elements[<span class="stringliteral">&#39;#attached&#39;</span>] as $callback =&gt; $options) {
<a name="l04417"></a>04417     <span class="keywordflow">if</span> (function_exists($callback)) {
<a name="l04418"></a>04418       <span class="keywordflow">foreach</span> ($elements[<span class="stringliteral">&#39;#attached&#39;</span>][$callback] as $args) {
<a name="l04419"></a>04419         call_user_func_array($callback, $args);
<a name="l04420"></a>04420       }
<a name="l04421"></a>04421     }
<a name="l04422"></a>04422   }
<a name="l04423"></a>04423 
<a name="l04424"></a>04424   <span class="keywordflow">return</span> $success;
<a name="l04425"></a>04425 }
<a name="l04426"></a>04426 
<a name="l04550"></a><a class="code" href="common_8inc_a335ef221d12db75393875deed0622ea1.html#a335ef221d12db75393875deed0622ea1">04550</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a335ef221d12db75393875deed0622ea1.html#a335ef221d12db75393875deed0622ea1" title="Adds JavaScript to change the state of an element based on another element.">drupal_process_states</a>(&amp;$elements) {
<a name="l04551"></a>04551   $elements[<span class="stringliteral">&#39;#attached&#39;</span>][<span class="stringliteral">&#39;library&#39;</span>][] = array(<span class="stringliteral">&#39;system&#39;</span>, <span class="stringliteral">&#39;drupal.states&#39;</span>);
<a name="l04552"></a>04552   $elements[<span class="stringliteral">&#39;#attached&#39;</span>][<span class="stringliteral">&#39;js&#39;</span>][] = array(
<a name="l04553"></a>04553     <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;setting&#39;</span>,
<a name="l04554"></a>04554     <span class="stringliteral">&#39;data&#39;</span> =&gt; array(<span class="stringliteral">&#39;states&#39;</span> =&gt; array(<span class="charliteral">&#39;#&#39;</span> . $elements[<span class="stringliteral">&#39;#id&#39;</span>] =&gt; $elements[<span class="stringliteral">&#39;#states&#39;</span>])),
<a name="l04555"></a>04555   );
<a name="l04556"></a>04556 }
<a name="l04557"></a>04557 
<a name="l04584"></a><a class="code" href="common_8inc_a10d0b7349429391743b9ffc49b48908a.html#a10d0b7349429391743b9ffc49b48908a">04584</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a10d0b7349429391743b9ffc49b48908a.html#a10d0b7349429391743b9ffc49b48908a" title="Adds multiple JavaScript or CSS files at the same time.">drupal_add_library</a>($module, $name, $every_page = NULL) {
<a name="l04585"></a>04585   $added = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__, array());
<a name="l04586"></a>04586 
<a name="l04587"></a>04587   <span class="comment">// Only process the library if it exists and it was not added already.</span>
<a name="l04588"></a>04588   <span class="keywordflow">if</span> (!isset($added[$module][$name])) {
<a name="l04589"></a>04589     <span class="keywordflow">if</span> ($library = <a class="code" href="common_8inc_aa535ac5edd443308d3b2812caf1a1b85.html#aa535ac5edd443308d3b2812caf1a1b85" title="Retrieves information for a JavaScript/CSS library.">drupal_get_library</a>($module, $name)) {
<a name="l04590"></a>04590       <span class="comment">// Add all components within the library.</span>
<a name="l04591"></a>04591       $elements[<span class="stringliteral">&#39;#attached&#39;</span>] = array(
<a name="l04592"></a>04592         <span class="stringliteral">&#39;library&#39;</span> =&gt; $library[<span class="stringliteral">&#39;dependencies&#39;</span>],
<a name="l04593"></a>04593         <span class="stringliteral">&#39;js&#39;</span> =&gt; $library[<span class="stringliteral">&#39;js&#39;</span>],
<a name="l04594"></a>04594         <span class="stringliteral">&#39;css&#39;</span> =&gt; $library[<span class="stringliteral">&#39;css&#39;</span>],
<a name="l04595"></a>04595       );
<a name="l04596"></a>04596       $added[$module][$name] = <a class="code" href="common_8inc_a31e3a25219e1d3a2f74670694b30dee6.html#a31e3a25219e1d3a2f74670694b30dee6" title="Adds attachments to a render() structure.">drupal_process_attached</a>($elements, <a class="code" href="common_8inc_a7efeab296e4345588b1279ec758e52b3.html#a7efeab296e4345588b1279ec758e52b3" title="The default group for JavaScript and jQuery libraries added to the page.">JS_LIBRARY</a>, TRUE, $every_page);
<a name="l04597"></a>04597     }
<a name="l04598"></a>04598     <span class="keywordflow">else</span> {
<a name="l04599"></a>04599       <span class="comment">// Requested library does not exist.</span>
<a name="l04600"></a>04600       $added[$module][$name] = FALSE;
<a name="l04601"></a>04601     }
<a name="l04602"></a>04602   }
<a name="l04603"></a>04603 
<a name="l04604"></a>04604   <span class="keywordflow">return</span> $added[$module][$name];
<a name="l04605"></a>04605 }
<a name="l04606"></a>04606 
<a name="l04638"></a><a class="code" href="common_8inc_aa535ac5edd443308d3b2812caf1a1b85.html#aa535ac5edd443308d3b2812caf1a1b85">04638</a> <span class="keyword">function</span> <a class="code" href="common_8inc_aa535ac5edd443308d3b2812caf1a1b85.html#aa535ac5edd443308d3b2812caf1a1b85" title="Retrieves information for a JavaScript/CSS library.">drupal_get_library</a>($module, $name = NULL) {
<a name="l04639"></a>04639   $libraries = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__, array());
<a name="l04640"></a>04640 
<a name="l04641"></a>04641   <span class="keywordflow">if</span> (!isset($libraries[$module])) {
<a name="l04642"></a>04642     <span class="comment">// Retrieve all libraries associated with the module.</span>
<a name="l04643"></a>04643     $module_libraries = <a class="code" href="group__hooks_ga7547905cff161d057f9e71088ec67f05.html#ga7547905cff161d057f9e71088ec67f05" title="Invoke a hook in a particular module.">module_invoke</a>($module, <span class="stringliteral">&#39;library&#39;</span>);
<a name="l04644"></a>04644     <span class="keywordflow">if</span> (empty($module_libraries)) {
<a name="l04645"></a>04645       $module_libraries = array();
<a name="l04646"></a>04646     }
<a name="l04647"></a>04647     <span class="comment">// Allow modules to alter the module&#39;s registered libraries.</span>
<a name="l04648"></a>04648     <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;library&#39;</span>, $module_libraries, $module);
<a name="l04649"></a>04649 
<a name="l04650"></a>04650     <span class="keywordflow">foreach</span> ($module_libraries as $key =&gt; $data) {
<a name="l04651"></a>04651       <span class="keywordflow">if</span> (is_array($data)) {
<a name="l04652"></a>04652         <span class="comment">// Add default elements to allow for easier processing.</span>
<a name="l04653"></a>04653         $module_libraries[$key] += array(<span class="stringliteral">&#39;dependencies&#39;</span> =&gt; array(), <span class="stringliteral">&#39;js&#39;</span> =&gt; array(), <span class="stringliteral">&#39;css&#39;</span> =&gt; array());
<a name="l04654"></a>04654         <span class="keywordflow">foreach</span> ($module_libraries[$key][<span class="stringliteral">&#39;js&#39;</span>] as $file =&gt; $options) {
<a name="l04655"></a>04655           $module_libraries[$key][<span class="stringliteral">&#39;js&#39;</span>][$file][<span class="stringliteral">&#39;version&#39;</span>] = $module_libraries[$key][<span class="stringliteral">&#39;version&#39;</span>];
<a name="l04656"></a>04656         }
<a name="l04657"></a>04657       }
<a name="l04658"></a>04658     }
<a name="l04659"></a>04659     $libraries[$module] = $module_libraries;
<a name="l04660"></a>04660   }
<a name="l04661"></a>04661   <span class="keywordflow">if</span> (isset($name)) {
<a name="l04662"></a>04662     <span class="keywordflow">if</span> (!isset($libraries[$module][$name])) {
<a name="l04663"></a>04663       $libraries[$module][$name] = FALSE;
<a name="l04664"></a>04664     }
<a name="l04665"></a>04665     <span class="keywordflow">return</span> $libraries[$module][$name];
<a name="l04666"></a>04666   }
<a name="l04667"></a>04667   <span class="keywordflow">return</span> $libraries[$module];
<a name="l04668"></a>04668 }
<a name="l04669"></a>04669 
<a name="l04777"></a><a class="code" href="common_8inc_ab905af5d90a84b5d48f3a517992875f5.html#ab905af5d90a84b5d48f3a517992875f5">04777</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ab905af5d90a84b5d48f3a517992875f5.html#ab905af5d90a84b5d48f3a517992875f5" title="Assists in adding the tableDrag JavaScript behavior to a themed table.">drupal_add_tabledrag</a>($table_id, $action, $relationship, $group, $subgroup = NULL, $source = NULL, $hidden = TRUE, $limit = 0) {
<a name="l04778"></a>04778   $js_added = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__, FALSE);
<a name="l04779"></a>04779   <span class="keywordflow">if</span> (!$js_added) {
<a name="l04780"></a>04780     <span class="comment">// Add the table drag JavaScript to the page before the module JavaScript</span>
<a name="l04781"></a>04781     <span class="comment">// to ensure that table drag behaviors are registered before any module</span>
<a name="l04782"></a>04782     <span class="comment">// uses it.</span>
<a name="l04783"></a>04783     <a class="code" href="common_8inc_a10d0b7349429391743b9ffc49b48908a.html#a10d0b7349429391743b9ffc49b48908a" title="Adds multiple JavaScript or CSS files at the same time.">drupal_add_library</a>(<span class="stringliteral">&#39;system&#39;</span>, <span class="stringliteral">&#39;jquery.cookie&#39;</span>);
<a name="l04784"></a>04784     <a class="code" href="common_8inc_a623370a2c3c2de0390dab078d17dca02.html#a623370a2c3c2de0390dab078d17dca02" title="Adds a JavaScript file, setting, or inline code to the page.">drupal_add_js</a>(<span class="stringliteral">&#39;misc/tabledrag.js&#39;</span>, array(<span class="stringliteral">&#39;weight&#39;</span> =&gt; -1));
<a name="l04785"></a>04785     $js_added = TRUE;
<a name="l04786"></a>04786   }
<a name="l04787"></a>04787 
<a name="l04788"></a>04788   <span class="comment">// If a subgroup or source isn&#39;t set, assume it is the same as the group.</span>
<a name="l04789"></a>04789   $target = isset($subgroup) ? $subgroup : $group;
<a name="l04790"></a>04790   $source = isset($source) ? $source : $target;
<a name="l04791"></a>04791   $settings[<span class="stringliteral">&#39;tableDrag&#39;</span>][$table_id][$group][] = array(
<a name="l04792"></a>04792     <span class="stringliteral">&#39;target&#39;</span> =&gt; $target,
<a name="l04793"></a>04793     <span class="stringliteral">&#39;source&#39;</span> =&gt; $source,
<a name="l04794"></a>04794     <span class="stringliteral">&#39;relationship&#39;</span> =&gt; $relationship,
<a name="l04795"></a>04795     <span class="stringliteral">&#39;action&#39;</span> =&gt; $action,
<a name="l04796"></a>04796     <span class="stringliteral">&#39;hidden&#39;</span> =&gt; $hidden,
<a name="l04797"></a>04797     <span class="stringliteral">&#39;limit&#39;</span> =&gt; $limit,
<a name="l04798"></a>04798   );
<a name="l04799"></a>04799   <a class="code" href="common_8inc_a623370a2c3c2de0390dab078d17dca02.html#a623370a2c3c2de0390dab078d17dca02" title="Adds a JavaScript file, setting, or inline code to the page.">drupal_add_js</a>($settings, <span class="stringliteral">&#39;setting&#39;</span>);
<a name="l04800"></a>04800 }
<a name="l04801"></a>04801 
<a name="l04826"></a><a class="code" href="common_8inc_a1e1e39db4d513a984d7d76ba8cd68a9b.html#a1e1e39db4d513a984d7d76ba8cd68a9b">04826</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a1e1e39db4d513a984d7d76ba8cd68a9b.html#a1e1e39db4d513a984d7d76ba8cd68a9b" title="Aggregates JavaScript files into a cache file in the files directory.">drupal_build_js_cache</a>($files) {
<a name="l04827"></a>04827   $contents = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04828"></a>04828   $uri = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04829"></a>04829   $map = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;drupal_js_cache_files&#39;</span>, array());
<a name="l04830"></a>04830   <span class="comment">// Create a new array so that only the file names are used to create the hash.</span>
<a name="l04831"></a>04831   <span class="comment">// This prevents new aggregates from being created unnecessarily.</span>
<a name="l04832"></a>04832   $js_data = array();
<a name="l04833"></a>04833   <span class="keywordflow">foreach</span> ($files as $file) {
<a name="l04834"></a>04834     $js_data[] = $file[<span class="stringliteral">&#39;data&#39;</span>];
<a name="l04835"></a>04835   }
<a name="l04836"></a>04836   $key = hash(<span class="stringliteral">&#39;sha256&#39;</span>, serialize($js_data));
<a name="l04837"></a>04837   <span class="keywordflow">if</span> (isset($map[$key])) {
<a name="l04838"></a>04838     $uri = $map[$key];
<a name="l04839"></a>04839   }
<a name="l04840"></a>04840 
<a name="l04841"></a>04841   <span class="keywordflow">if</span> (empty($uri) || !file_exists($uri)) {
<a name="l04842"></a>04842     <span class="comment">// Build aggregate JS file.</span>
<a name="l04843"></a>04843     <span class="keywordflow">foreach</span> ($files as $path =&gt; $info) {
<a name="l04844"></a>04844       <span class="keywordflow">if</span> ($info[<span class="stringliteral">&#39;preprocess&#39;</span>]) {
<a name="l04845"></a>04845         <span class="comment">// Append a &#39;;&#39; and a newline after each JS file to prevent them from running together.</span>
<a name="l04846"></a>04846         $contents .= file_get_contents($path) . <span class="stringliteral">&quot;;\n&quot;</span>;
<a name="l04847"></a>04847       }
<a name="l04848"></a>04848     }
<a name="l04849"></a>04849     <span class="comment">// Prefix filename to prevent blocking by firewalls which reject files</span>
<a name="l04850"></a>04850     <span class="comment">// starting with &quot;ad*&quot;.</span>
<a name="l04851"></a>04851     $filename = <span class="stringliteral">&#39;js_&#39;</span> . <a class="code" href="bootstrap_8inc_afaa1b21aee7b2e06ee3f868065fdbcc1.html#afaa1b21aee7b2e06ee3f868065fdbcc1" title="Calculates a base-64 encoded, URL-safe sha-256 hash.">drupal_hash_base64</a>($contents) . <span class="stringliteral">&#39;.js&#39;</span>;
<a name="l04852"></a>04852     <span class="comment">// Create the js/ within the files folder.</span>
<a name="l04853"></a>04853     $jspath = <span class="stringliteral">&#39;public://js&#39;</span>;
<a name="l04854"></a>04854     $uri = $jspath . <span class="charliteral">&#39;/&#39;</span> . $filename;
<a name="l04855"></a>04855     <span class="comment">// Create the JS file.</span>
<a name="l04856"></a>04856     <a class="code" href="group__file_ga738f89421a4f4c228676de817e5e485c.html#ga738f89421a4f4c228676de817e5e485c" title="Checks that the directory exists and is writable.">file_prepare_directory</a>($jspath, <a class="code" href="group__file_ga851cbf30c0a6d31a1733590cf80c39e5.html#ga851cbf30c0a6d31a1733590cf80c39e5" title="Flag used by file_prepare_directory() -- create directory if not present.">FILE_CREATE_DIRECTORY</a>);
<a name="l04857"></a>04857     <span class="keywordflow">if</span> (!file_exists($uri) &amp;&amp; !<a class="code" href="group__file_gac2d047d4471ec93803f584cda01a557c.html#gac2d047d4471ec93803f584cda01a557c" title="Saves a string to the specified destination without invoking file API.">file_unmanaged_save_data</a>($contents, $uri, <a class="code" href="group__file_ga54c3c90d9cb7857114326cb5114e7159.html#ga54c3c90d9cb7857114326cb5114e7159" title="Flag for dealing with existing files: Replace the existing file.">FILE_EXISTS_REPLACE</a>)) {
<a name="l04858"></a>04858       <span class="keywordflow">return</span> FALSE;
<a name="l04859"></a>04859     }
<a name="l04860"></a>04860     <span class="comment">// If JS gzip compression is enabled, clean URLs are enabled (which means</span>
<a name="l04861"></a>04861     <span class="comment">// that rewrite rules are working) and the zlib extension is available then</span>
<a name="l04862"></a>04862     <span class="comment">// create a gzipped version of this file. This file is served conditionally</span>
<a name="l04863"></a>04863     <span class="comment">// to browsers that accept gzip using .htaccess rules.</span>
<a name="l04864"></a>04864     <span class="keywordflow">if</span> (<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;js_gzip_compression&#39;</span>, TRUE) &amp;&amp; <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;clean_url&#39;</span>, 0) &amp;&amp; extension_loaded(<span class="stringliteral">&#39;zlib&#39;</span>)) {
<a name="l04865"></a>04865       <span class="keywordflow">if</span> (!file_exists($uri . <span class="stringliteral">&#39;.gz&#39;</span>) &amp;&amp; !<a class="code" href="group__file_gac2d047d4471ec93803f584cda01a557c.html#gac2d047d4471ec93803f584cda01a557c" title="Saves a string to the specified destination without invoking file API.">file_unmanaged_save_data</a>(gzencode($contents, 9, FORCE_GZIP), $uri . <span class="stringliteral">&#39;.gz&#39;</span>, <a class="code" href="group__file_ga54c3c90d9cb7857114326cb5114e7159.html#ga54c3c90d9cb7857114326cb5114e7159" title="Flag for dealing with existing files: Replace the existing file.">FILE_EXISTS_REPLACE</a>)) {
<a name="l04866"></a>04866         <span class="keywordflow">return</span> FALSE;
<a name="l04867"></a>04867       }
<a name="l04868"></a>04868     }
<a name="l04869"></a>04869     $map[$key] = $uri;
<a name="l04870"></a>04870     <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;drupal_js_cache_files&#39;</span>, $map);
<a name="l04871"></a>04871   }
<a name="l04872"></a>04872   <span class="keywordflow">return</span> $uri;
<a name="l04873"></a>04873 }
<a name="l04874"></a>04874 
<a name="l04878"></a><a class="code" href="common_8inc_ac05e083cb7cb02084601f8d2103b0405.html#ac05e083cb7cb02084601f8d2103b0405">04878</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ac05e083cb7cb02084601f8d2103b0405.html#ac05e083cb7cb02084601f8d2103b0405" title="Deletes old cached JavaScript files and variables.">drupal_clear_js_cache</a>() {
<a name="l04879"></a>04879   <a class="code" href="bootstrap_8inc_a7850bff5f313f85335f418e6d87606b1.html#a7850bff5f313f85335f418e6d87606b1" title="Unsets a persistent variable.">variable_del</a>(<span class="stringliteral">&#39;javascript_parsed&#39;</span>);
<a name="l04880"></a>04880   <a class="code" href="bootstrap_8inc_a7850bff5f313f85335f418e6d87606b1.html#a7850bff5f313f85335f418e6d87606b1" title="Unsets a persistent variable.">variable_del</a>(<span class="stringliteral">&#39;drupal_js_cache_files&#39;</span>);
<a name="l04881"></a>04881   <a class="code" href="group__file_ga363e988787ffa45bff69ff051eed0615.html#ga363e988787ffa45bff69ff051eed0615" title="Finds all files that match a given mask in a given directory.">file_scan_directory</a>(<span class="stringliteral">&#39;public://js&#39;</span>, <span class="stringliteral">&#39;/.*/&#39;</span>, array(<span class="stringliteral">&#39;callback&#39;</span> =&gt; <span class="stringliteral">&#39;drupal_delete_file_if_stale&#39;</span>));
<a name="l04882"></a>04882 }
<a name="l04883"></a>04883 
<a name="l04893"></a><a class="code" href="group__php__wrappers_gaf09c80fb758b9f3657772e26817e37b9.html#gaf09c80fb758b9f3657772e26817e37b9">04893</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_gaf09c80fb758b9f3657772e26817e37b9.html#gaf09c80fb758b9f3657772e26817e37b9" title="Converts a PHP variable into its JavaScript equivalent.">drupal_json_encode</a>($var) {
<a name="l04894"></a>04894   <span class="comment">// The PHP version cannot change within a request.</span>
<a name="l04895"></a>04895   <span class="keyword">static</span> $php530;
<a name="l04896"></a>04896 
<a name="l04897"></a>04897   <span class="keywordflow">if</span> (!isset($php530)) {
<a name="l04898"></a>04898     $php530 = version_compare(PHP_VERSION, <span class="stringliteral">&#39;5.3.0&#39;</span>, <span class="stringliteral">&#39;&gt;=&#39;</span>);
<a name="l04899"></a>04899   }
<a name="l04900"></a>04900 
<a name="l04901"></a>04901   <span class="keywordflow">if</span> ($php530) {
<a name="l04902"></a>04902     <span class="comment">// Encode &lt;, &gt;, &#39;, &amp;, and &quot; using the json_encode() options parameter.</span>
<a name="l04903"></a>04903     <span class="keywordflow">return</span> json_encode($var, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_AMP | JSON_HEX_QUOT);
<a name="l04904"></a>04904   }
<a name="l04905"></a>04905 
<a name="l04906"></a>04906   <span class="comment">// json_encode() escapes &lt;, &gt;, &#39;, &amp;, and &quot; using its options parameter, but</span>
<a name="l04907"></a>04907   <span class="comment">// does not support this parameter prior to PHP 5.3.0.  Use a helper instead.</span>
<a name="l04908"></a>04908   include_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/json-encode.inc&#39;</span>;
<a name="l04909"></a>04909   <span class="keywordflow">return</span> <a class="code" href="json-encode_8inc_a96f15d8dc7b543c3f7568ed07f592ff3.html#a96f15d8dc7b543c3f7568ed07f592ff3" title="Encodes a PHP variable to HTML-safe JSON for PHP versions below 5.3.0.">drupal_json_encode_helper</a>($var);
<a name="l04910"></a>04910 }
<a name="l04911"></a>04911 
<a name="l04918"></a><a class="code" href="group__php__wrappers_gae065f2a8115ef999b74d765c8e7f35ff.html#gae065f2a8115ef999b74d765c8e7f35ff">04918</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_gae065f2a8115ef999b74d765c8e7f35ff.html#gae065f2a8115ef999b74d765c8e7f35ff" title="Converts an HTML-safe JSON string into its PHP equivalent.">drupal_json_decode</a>($var) {
<a name="l04919"></a>04919   <span class="keywordflow">return</span> json_decode($var, TRUE);
<a name="l04920"></a>04920 }
<a name="l04921"></a>04921 
<a name="l04931"></a><a class="code" href="common_8inc_a27dfc2976ed1a73d926838793dc06e1e.html#a27dfc2976ed1a73d926838793dc06e1e">04931</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a27dfc2976ed1a73d926838793dc06e1e.html#a27dfc2976ed1a73d926838793dc06e1e" title="Returns data in JSON format.">drupal_json_output</a>($var = NULL) {
<a name="l04932"></a>04932   <span class="comment">// We are returning JSON, so tell the browser.</span>
<a name="l04933"></a>04933   <a class="code" href="bootstrap_8inc_ad4ff2b2cf5a2fb632c2c869bc1a5a70f.html#ad4ff2b2cf5a2fb632c2c869bc1a5a70f" title="Sets an HTTP response header for the current page.">drupal_add_http_header</a>(<span class="stringliteral">&#39;Content-Type&#39;</span>, <span class="stringliteral">&#39;application/json&#39;</span>);
<a name="l04934"></a>04934 
<a name="l04935"></a>04935   <span class="keywordflow">if</span> (isset($var)) {
<a name="l04936"></a>04936     echo <a class="code" href="group__php__wrappers_gaf09c80fb758b9f3657772e26817e37b9.html#gaf09c80fb758b9f3657772e26817e37b9" title="Converts a PHP variable into its JavaScript equivalent.">drupal_json_encode</a>($var);
<a name="l04937"></a>04937   }
<a name="l04938"></a>04938 }
<a name="l04939"></a>04939 
<a name="l04946"></a><a class="code" href="common_8inc_a832314334940cc1578689241d665d7e8.html#a832314334940cc1578689241d665d7e8">04946</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a832314334940cc1578689241d665d7e8.html#a832314334940cc1578689241d665d7e8" title="Gets a salt useful for hardening against SQL injection.">drupal_get_hash_salt</a>() {
<a name="l04947"></a>04947   global <a class="code" href="default_8settings_8php_a75c981b07486dd3b07d5f122702dd87e.html#a75c981b07486dd3b07d5f122702dd87e" title="Salt for one-time login links and cancel links, form tokens, etc.">$drupal_hash_salt</a>, <a class="code" href="default_8settings_8php_a97cde67402a68697692531e8b067f86f.html#a97cde67402a68697692531e8b067f86f" title="Database settings:">$databases</a>;
<a name="l04948"></a>04948   <span class="comment">// If the $drupal_hash_salt variable is empty, a hash of the serialized</span>
<a name="l04949"></a>04949   <span class="comment">// database credentials is used as a fallback salt.</span>
<a name="l04950"></a>04950   <span class="keywordflow">return</span> empty($drupal_hash_salt) ? hash(<span class="stringliteral">&#39;sha256&#39;</span>, serialize($databases)) : <a class="code" href="default_8settings_8php_a75c981b07486dd3b07d5f122702dd87e.html#a75c981b07486dd3b07d5f122702dd87e" title="Salt for one-time login links and cancel links, form tokens, etc.">$drupal_hash_salt</a>;
<a name="l04951"></a>04951 }
<a name="l04952"></a>04952 
<a name="l04959"></a><a class="code" href="common_8inc_a73373e2d357d0e624c209efe27515af6.html#a73373e2d357d0e624c209efe27515af6">04959</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a73373e2d357d0e624c209efe27515af6.html#a73373e2d357d0e624c209efe27515af6" title="Ensures the private key variable used to generate tokens is set.">drupal_get_private_key</a>() {
<a name="l04960"></a>04960   <span class="keywordflow">if</span> (!($key = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;drupal_private_key&#39;</span>, 0))) {
<a name="l04961"></a>04961     $key = <a class="code" href="bootstrap_8inc_afaa1b21aee7b2e06ee3f868065fdbcc1.html#afaa1b21aee7b2e06ee3f868065fdbcc1" title="Calculates a base-64 encoded, URL-safe sha-256 hash.">drupal_hash_base64</a>(<a class="code" href="bootstrap_8inc_a6eb7796c83ea744f818faa2a02f19953.html#a6eb7796c83ea744f818faa2a02f19953" title="Returns a string of highly randomized bytes (over the full 8-bit range).">drupal_random_bytes</a>(55));
<a name="l04962"></a>04962     <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;drupal_private_key&#39;</span>, $key);
<a name="l04963"></a>04963   }
<a name="l04964"></a>04964   <span class="keywordflow">return</span> $key;
<a name="l04965"></a>04965 }
<a name="l04966"></a>04966 
<a name="l04973"></a><a class="code" href="common_8inc_a16989177d9fa05df9b45e8797ce04994.html#a16989177d9fa05df9b45e8797ce04994">04973</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a16989177d9fa05df9b45e8797ce04994.html#a16989177d9fa05df9b45e8797ce04994" title="Generates a token based on $value, the user session, and the private key.">drupal_get_token</a>($value = <span class="stringliteral">&#39;&#39;</span>) {
<a name="l04974"></a>04974   <span class="keywordflow">return</span> <a class="code" href="bootstrap_8inc_a677ac93b9fcba24a3ffeb02e08ca8e9a.html#a677ac93b9fcba24a3ffeb02e08ca8e9a" title="Calculates a base-64 encoded, URL-safe sha-256 hmac.">drupal_hmac_base64</a>($value, session_id() . <a class="code" href="common_8inc_a73373e2d357d0e624c209efe27515af6.html#a73373e2d357d0e624c209efe27515af6" title="Ensures the private key variable used to generate tokens is set.">drupal_get_private_key</a>() . <a class="code" href="common_8inc_a832314334940cc1578689241d665d7e8.html#a832314334940cc1578689241d665d7e8" title="Gets a salt useful for hardening against SQL injection.">drupal_get_hash_salt</a>());
<a name="l04975"></a>04975 }
<a name="l04976"></a>04976 
<a name="l04991"></a><a class="code" href="common_8inc_a343a6ad44cfc1007b618b245f9366be8.html#a343a6ad44cfc1007b618b245f9366be8">04991</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a343a6ad44cfc1007b618b245f9366be8.html#a343a6ad44cfc1007b618b245f9366be8" title="Validates a token based on $value, the user session, and the private key.">drupal_valid_token</a>($token, $value = <span class="stringliteral">&#39;&#39;</span>, $skip_anonymous = FALSE) {
<a name="l04992"></a>04992   global $user;
<a name="l04993"></a>04993   <span class="keywordflow">return</span> (($skip_anonymous &amp;&amp; $user-&gt;uid == 0) || ($token == <a class="code" href="common_8inc_a16989177d9fa05df9b45e8797ce04994.html#a16989177d9fa05df9b45e8797ce04994" title="Generates a token based on $value, the user session, and the private key.">drupal_get_token</a>($value)));
<a name="l04994"></a>04994 }
<a name="l04995"></a>04995 
<a name="l04996"></a><a class="code" href="common_8inc_ab7818b78cd7ba93b8b7522324bddb72d.html#ab7818b78cd7ba93b8b7522324bddb72d">04996</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ab7818b78cd7ba93b8b7522324bddb72d.html#ab7818b78cd7ba93b8b7522324bddb72d">_drupal_bootstrap_full</a>() {
<a name="l04997"></a>04997   <span class="keyword">static</span> $called = FALSE;
<a name="l04998"></a>04998 
<a name="l04999"></a>04999   <span class="keywordflow">if</span> ($called) {
<a name="l05000"></a>05000     <span class="keywordflow">return</span>;
<a name="l05001"></a>05001   }
<a name="l05002"></a>05002   $called = TRUE;
<a name="l05003"></a>05003   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="charliteral">&#39;/&#39;</span> . <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;path_inc&#39;</span>, <span class="stringliteral">&#39;includes/path.inc&#39;</span>);
<a name="l05004"></a>05004   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/theme.inc&#39;</span>;
<a name="l05005"></a>05005   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/pager.inc&#39;</span>;
<a name="l05006"></a>05006   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="charliteral">&#39;/&#39;</span> . <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;menu_inc&#39;</span>, <span class="stringliteral">&#39;includes/menu.inc&#39;</span>);
<a name="l05007"></a>05007   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/tablesort.inc&#39;</span>;
<a name="l05008"></a>05008   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/file.inc&#39;</span>;
<a name="l05009"></a>05009   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/unicode.inc&#39;</span>;
<a name="l05010"></a>05010   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/image.inc&#39;</span>;
<a name="l05011"></a>05011   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/form.inc&#39;</span>;
<a name="l05012"></a>05012   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/mail.inc&#39;</span>;
<a name="l05013"></a>05013   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/actions.inc&#39;</span>;
<a name="l05014"></a>05014   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/ajax.inc&#39;</span>;
<a name="l05015"></a>05015   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/token.inc&#39;</span>;
<a name="l05016"></a>05016   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/errors.inc&#39;</span>;
<a name="l05017"></a>05017 
<a name="l05018"></a>05018   <span class="comment">// Detect string handling method</span>
<a name="l05019"></a>05019   <a class="code" href="unicode_8inc_a20a41302a4e02b802bd51c57935cef3a.html#a20a41302a4e02b802bd51c57935cef3a" title="Wrapper around _unicode_check().">unicode_check</a>();
<a name="l05020"></a>05020   <span class="comment">// Undo magic quotes</span>
<a name="l05021"></a>05021   <a class="code" href="common_8inc_abefb935bf3c61840ba9ad50adb13f766.html#abefb935bf3c61840ba9ad50adb13f766" title="Fixes double-escaping caused by &quot;magic quotes&quot; in some PHP installations.">fix_gpc_magic</a>();
<a name="l05022"></a>05022   <span class="comment">// Load all enabled modules</span>
<a name="l05023"></a>05023   <a class="code" href="module_8inc_a76db4bd7c4962f254d6cc9bed5f0e1f6.html#a76db4bd7c4962f254d6cc9bed5f0e1f6" title="Load all the modules that have been enabled in the system table.">module_load_all</a>();
<a name="l05024"></a>05024   <span class="comment">// Make sure all stream wrappers are registered.</span>
<a name="l05025"></a>05025   <a class="code" href="group__file_ga0cd34cfd1bacb36b8ff82d01fb9a6f79.html#ga0cd34cfd1bacb36b8ff82d01fb9a6f79" title="Provides Drupal stream wrapper registry.">file_get_stream_wrappers</a>();
<a name="l05026"></a>05026 
<a name="l05027"></a>05027   $test_info = &amp;$GLOBALS[<span class="stringliteral">&#39;drupal_test_info&#39;</span>];
<a name="l05028"></a>05028   <span class="keywordflow">if</span> (!empty($test_info[<span class="stringliteral">&#39;in_child_site&#39;</span>])) {
<a name="l05029"></a>05029     <span class="comment">// Running inside the simpletest child site, log fatal errors to test</span>
<a name="l05030"></a>05030     <span class="comment">// specific file directory.</span>
<a name="l05031"></a>05031     ini_set(<span class="stringliteral">&#39;log_errors&#39;</span>, 1);
<a name="l05032"></a>05032     ini_set(<span class="stringliteral">&#39;error_log&#39;</span>, <span class="stringliteral">&#39;public://error.log&#39;</span>);
<a name="l05033"></a>05033   }
<a name="l05034"></a>05034 
<a name="l05035"></a>05035   <span class="comment">// Initialize $_GET[&#39;q&#39;] prior to invoking hook_init().</span>
<a name="l05036"></a>05036   <a class="code" href="path_8inc_ad19e2051aeae309fbf3be8bd072e6fed.html#ad19e2051aeae309fbf3be8bd072e6fed" title="Initialize the $_GET[&#39;q&#39;] variable to the proper normal path.">drupal_path_initialize</a>();
<a name="l05037"></a>05037 
<a name="l05038"></a>05038   <span class="comment">// Let all modules take action before the menu system handles the request.</span>
<a name="l05039"></a>05039   <span class="comment">// We do not want this while running update.php.</span>
<a name="l05040"></a>05040   <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;MAINTENANCE_MODE&#39;</span>) || <a class="code" href="authorize_8php_a5bf6dfe9ba7ee16c648e3932aa76535d.html#a5bf6dfe9ba7ee16c648e3932aa76535d" title="Global flag to identify update.php and authorize.php runs, and so avoid various unwanted operations...">MAINTENANCE_MODE</a> != <span class="stringliteral">&#39;update&#39;</span>) {
<a name="l05041"></a>05041     <span class="comment">// Prior to invoking hook_init(), initialize the theme (potentially a custom</span>
<a name="l05042"></a>05042     <span class="comment">// one for this page), so that:</span>
<a name="l05043"></a>05043     <span class="comment">// - Modules with hook_init() implementations that call theme() or</span>
<a name="l05044"></a>05044     <span class="comment">//   theme_get_registry() don&#39;t initialize the incorrect theme.</span>
<a name="l05045"></a>05045     <span class="comment">// - The theme can have hook_*_alter() implementations affect page building</span>
<a name="l05046"></a>05046     <span class="comment">//   (e.g., hook_form_alter(), hook_node_view_alter(), hook_page_alter()),</span>
<a name="l05047"></a>05047     <span class="comment">//   ahead of when rendering starts.</span>
<a name="l05048"></a>05048     <a class="code" href="group__menu_ga2545be84d84b98f84857bea11f7961fb.html#ga2545be84d84b98f84857bea11f7961fb" title="Sets a custom theme for the current page, if there is one.">menu_set_custom_theme</a>();
<a name="l05049"></a>05049     <a class="code" href="theme_8inc_a9e48961b3be3ca78f434b047fbb8463f.html#a9e48961b3be3ca78f434b047fbb8463f" title="Initialize the theme system by loading the theme.">drupal_theme_initialize</a>();
<a name="l05050"></a>05050     <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;init&#39;</span>);
<a name="l05051"></a>05051   }
<a name="l05052"></a>05052 }
<a name="l05053"></a>05053 
<a name="l05067"></a><a class="code" href="common_8inc_ac46363381db03a8d6a2663d031d8ce07.html#ac46363381db03a8d6a2663d031d8ce07">05067</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ac46363381db03a8d6a2663d031d8ce07.html#ac46363381db03a8d6a2663d031d8ce07" title="Stores the current page in the cache.">drupal_page_set_cache</a>() {
<a name="l05068"></a>05068   global $base_root;
<a name="l05069"></a>05069 
<a name="l05070"></a>05070   <span class="keywordflow">if</span> (<a class="code" href="bootstrap_8inc_a7972b6ea362a180e975d1d531a18996a.html#a7972b6ea362a180e975d1d531a18996a" title="Determines the cacheability of the current page.">drupal_page_is_cacheable</a>()) {
<a name="l05071"></a>05071     $cache = (object) array(
<a name="l05072"></a>05072       <span class="stringliteral">&#39;cid&#39;</span> =&gt; $base_root . <a class="code" href="bootstrap_8inc_a80b52d5331d840440b5e3dfe82dd7ea2.html#a80b52d5331d840440b5e3dfe82dd7ea2" title="Returns the equivalent of Apache&#39;s $_SERVER[&#39;REQUEST_URI&#39;] variable.">request_uri</a>(),
<a name="l05073"></a>05073       <span class="stringliteral">&#39;data&#39;</span> =&gt; array(
<a name="l05074"></a>05074         <span class="stringliteral">&#39;path&#39;</span> =&gt; $_GET[<span class="charliteral">&#39;q&#39;</span>],
<a name="l05075"></a>05075         <span class="stringliteral">&#39;body&#39;</span> =&gt; ob_get_clean(),
<a name="l05076"></a>05076         <span class="stringliteral">&#39;title&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a88f660bf675e572de22a8469841bbd08.html#a88f660bf675e572de22a8469841bbd08" title="Gets the title of the current page.">drupal_get_title</a>(),
<a name="l05077"></a>05077         <span class="stringliteral">&#39;headers&#39;</span> =&gt; array(),
<a name="l05078"></a>05078       ),
<a name="l05079"></a>05079       <span class="stringliteral">&#39;expire&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a1f2558e91eb9f33d14168bb8dfd99690.html#a1f2558e91eb9f33d14168bb8dfd99690" title="Indicates that the item should be removed at the next general cache wipe.">CACHE_TEMPORARY</a>,
<a name="l05080"></a>05080       <span class="stringliteral">&#39;created&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a>,
<a name="l05081"></a>05081     );
<a name="l05082"></a>05082 
<a name="l05083"></a>05083     <span class="comment">// Restore preferred header names based on the lower-case names returned</span>
<a name="l05084"></a>05084     <span class="comment">// by drupal_get_http_header().</span>
<a name="l05085"></a>05085     $header_names = <a class="code" href="bootstrap_8inc_a5a8f423c6c77a609be5dc291e52470fb.html#a5a8f423c6c77a609be5dc291e52470fb" title="Sets the preferred name for the HTTP header.">_drupal_set_preferred_header_name</a>();
<a name="l05086"></a>05086     <span class="keywordflow">foreach</span> (<a class="code" href="bootstrap_8inc_a159cce492ef9bed6e8a1dd33227fd11e.html#a159cce492ef9bed6e8a1dd33227fd11e" title="Gets the HTTP response headers for the current page.">drupal_get_http_header</a>() as $name_lower =&gt; $value) {
<a name="l05087"></a>05087       $cache-&gt;data[<span class="stringliteral">&#39;headers&#39;</span>][$header_names[$name_lower]] = $value;
<a name="l05088"></a>05088       <span class="keywordflow">if</span> ($name_lower == <span class="stringliteral">&#39;expires&#39;</span>) {
<a name="l05089"></a>05089         <span class="comment">// Use the actual timestamp from an Expires header if available.</span>
<a name="l05090"></a>05090         $cache-&gt;expire = strtotime($value);
<a name="l05091"></a>05091       }
<a name="l05092"></a>05092     }
<a name="l05093"></a>05093 
<a name="l05094"></a>05094     <span class="keywordflow">if</span> ($cache-&gt;data[<span class="stringliteral">&#39;body&#39;</span>]) {
<a name="l05095"></a>05095       <span class="keywordflow">if</span> (<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;page_compression&#39;</span>, TRUE) &amp;&amp; extension_loaded(<span class="stringliteral">&#39;zlib&#39;</span>)) {
<a name="l05096"></a>05096         $cache-&gt;data[<span class="stringliteral">&#39;body&#39;</span>] = gzencode($cache-&gt;data[<span class="stringliteral">&#39;body&#39;</span>], 9, FORCE_GZIP);
<a name="l05097"></a>05097       }
<a name="l05098"></a>05098       <a class="code" href="cache_8inc_a48081f36334909f561ef4f538fa640d2.html#a48081f36334909f561ef4f538fa640d2" title="Stores data in the persistent cache.">cache_set</a>($cache-&gt;cid, $cache-&gt;data, <span class="stringliteral">&#39;cache_page&#39;</span>, $cache-&gt;expire);
<a name="l05099"></a>05099     }
<a name="l05100"></a>05100     <span class="keywordflow">return</span> $cache;
<a name="l05101"></a>05101   }
<a name="l05102"></a>05102 }
<a name="l05103"></a>05103 
<a name="l05112"></a><a class="code" href="common_8inc_a1d4a4362b30215023a7120b627a9fd4f.html#a1d4a4362b30215023a7120b627a9fd4f">05112</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a1d4a4362b30215023a7120b627a9fd4f.html#a1d4a4362b30215023a7120b627a9fd4f" title="Executes a cron run when called.">drupal_cron_run</a>() {
<a name="l05113"></a>05113   <span class="comment">// Allow execution to continue even if the request gets canceled.</span>
<a name="l05114"></a>05114   @ignore_user_abort(TRUE);
<a name="l05115"></a>05115 
<a name="l05116"></a>05116   <span class="comment">// Prevent session information from being saved while cron is running.</span>
<a name="l05117"></a>05117   <a class="code" href="session_8inc_a2e1c6443b96a7018027383ca39585ce7.html#a2e1c6443b96a7018027383ca39585ce7" title="Determines whether to save session data of the current request.">drupal_save_session</a>(FALSE);
<a name="l05118"></a>05118 
<a name="l05119"></a>05119   <span class="comment">// Force the current user to anonymous to ensure consistent permissions on</span>
<a name="l05120"></a>05120   <span class="comment">// cron runs.</span>
<a name="l05121"></a>05121   $original_user = $GLOBALS[<span class="stringliteral">&#39;user&#39;</span>];
<a name="l05122"></a>05122   $GLOBALS[<span class="stringliteral">&#39;user&#39;</span>] = <a class="code" href="bootstrap_8inc_a9ad783f833f89bccb8ca03e960e3d33d.html#a9ad783f833f89bccb8ca03e960e3d33d" title="Generates a default anonymous $user object.">drupal_anonymous_user</a>();
<a name="l05123"></a>05123 
<a name="l05124"></a>05124   <span class="comment">// Try to allocate enough time to run all the hook_cron implementations.</span>
<a name="l05125"></a>05125   <a class="code" href="group__php__wrappers_ga0507eefd9cd1db602b2184d0fae35097.html#ga0507eefd9cd1db602b2184d0fae35097" title="Attempts to set the PHP maximum execution time.">drupal_set_time_limit</a>(240);
<a name="l05126"></a>05126 
<a name="l05127"></a>05127   $return = FALSE;
<a name="l05128"></a>05128   <span class="comment">// Grab the defined cron queues.</span>
<a name="l05129"></a>05129   $queues = <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;cron_queue_info&#39;</span>);
<a name="l05130"></a>05130   <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;cron_queue_info&#39;</span>, $queues);
<a name="l05131"></a>05131 
<a name="l05132"></a>05132   <span class="comment">// Try to acquire cron lock.</span>
<a name="l05133"></a>05133   <span class="keywordflow">if</span> (!<a class="code" href="group__lock_gac67a4b1061491f7a869646f47b66e998.html#gac67a4b1061491f7a869646f47b66e998" title="Acquire (or renew) a lock, but do not block if it fails.">lock_acquire</a>(<span class="stringliteral">&#39;cron&#39;</span>, 240.0)) {
<a name="l05134"></a>05134     <span class="comment">// Cron is still running normally.</span>
<a name="l05135"></a>05135     <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;cron&#39;</span>, <span class="stringliteral">&#39;Attempting to re-run cron while it is already running.&#39;</span>, array(), <a class="code" href="group__logging__severity__levels_ga5361f835e10b39b553ee73c1b9414bf1.html#ga5361f835e10b39b553ee73c1b9414bf1" title="Log message severity -- Warning conditions.">WATCHDOG_WARNING</a>);
<a name="l05136"></a>05136   }
<a name="l05137"></a>05137   <span class="keywordflow">else</span> {
<a name="l05138"></a>05138     <span class="comment">// Make sure every queue exists. There is no harm in trying to recreate an</span>
<a name="l05139"></a>05139     <span class="comment">// existing queue.</span>
<a name="l05140"></a>05140     <span class="keywordflow">foreach</span> ($queues as $queue_name =&gt; $info) {
<a name="l05141"></a>05141       DrupalQueue::get($queue_name)-&gt;createQueue();
<a name="l05142"></a>05142     }
<a name="l05143"></a>05143     <span class="comment">// Register shutdown callback.</span>
<a name="l05144"></a>05144     <a class="code" href="group__php__wrappers_gac7eaf11b49995f7f539f5c830a65b34f.html#gac7eaf11b49995f7f539f5c830a65b34f" title="Registers a function for execution on shutdown.">drupal_register_shutdown_function</a>(<span class="stringliteral">&#39;drupal_cron_cleanup&#39;</span>);
<a name="l05145"></a>05145 
<a name="l05146"></a>05146     <span class="comment">// Iterate through the modules calling their cron handlers (if any):</span>
<a name="l05147"></a>05147     <span class="keywordflow">foreach</span> (<a class="code" href="group__hooks_ga9191200072f2a641829e9d3c2759561f.html#ga9191200072f2a641829e9d3c2759561f" title="Determine which modules are implementing a hook.">module_implements</a>(<span class="stringliteral">&#39;cron&#39;</span>) as $module) {
<a name="l05148"></a>05148       <span class="comment">// Do not let an exception thrown by one module disturb another.</span>
<a name="l05149"></a>05149       <span class="keywordflow">try</span> {
<a name="l05150"></a>05150         <a class="code" href="group__hooks_ga7547905cff161d057f9e71088ec67f05.html#ga7547905cff161d057f9e71088ec67f05" title="Invoke a hook in a particular module.">module_invoke</a>($module, <span class="stringliteral">&#39;cron&#39;</span>);
<a name="l05151"></a>05151       }
<a name="l05152"></a>05152       <span class="keywordflow">catch</span> (<a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a> $e) {
<a name="l05153"></a>05153         <a class="code" href="bootstrap_8inc_aba38f35647efce6b4099dc59131e216b.html#aba38f35647efce6b4099dc59131e216b" title="Logs an exception.">watchdog_exception</a>(<span class="stringliteral">&#39;cron&#39;</span>, $e);
<a name="l05154"></a>05154       }
<a name="l05155"></a>05155     }
<a name="l05156"></a>05156 
<a name="l05157"></a>05157     <span class="comment">// Record cron time.</span>
<a name="l05158"></a>05158     <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;cron_last&#39;</span>, <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a>);
<a name="l05159"></a>05159     <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;cron&#39;</span>, <span class="stringliteral">&#39;Cron run completed.&#39;</span>, array(), <a class="code" href="group__logging__severity__levels_ga757a33416683e8c44636a8799f60b477.html#ga757a33416683e8c44636a8799f60b477" title="Log message severity -- Normal but significant conditions.">WATCHDOG_NOTICE</a>);
<a name="l05160"></a>05160 
<a name="l05161"></a>05161     <span class="comment">// Release cron lock.</span>
<a name="l05162"></a>05162     <a class="code" href="group__lock_ga73e1456861f9aff1a506a650f43aceb0.html#ga73e1456861f9aff1a506a650f43aceb0" title="Release a lock previously acquired by lock_acquire().">lock_release</a>(<span class="stringliteral">&#39;cron&#39;</span>);
<a name="l05163"></a>05163 
<a name="l05164"></a>05164     <span class="comment">// Return TRUE so other functions can check if it did run successfully</span>
<a name="l05165"></a>05165     $return = TRUE;
<a name="l05166"></a>05166   }
<a name="l05167"></a>05167 
<a name="l05168"></a>05168   <span class="keywordflow">foreach</span> ($queues as $queue_name =&gt; $info) {
<a name="l05169"></a>05169     $function = $info[<span class="stringliteral">&#39;worker callback&#39;</span>];
<a name="l05170"></a>05170     $end = time() + (isset($info[<span class="stringliteral">&#39;time&#39;</span>]) ? $info[<span class="stringliteral">&#39;time&#39;</span>] : 15);
<a name="l05171"></a>05171     $queue = DrupalQueue::get($queue_name);
<a name="l05172"></a>05172     <span class="keywordflow">while</span> (time() &lt; $end &amp;&amp; ($item = $queue-&gt;claimItem())) {
<a name="l05173"></a>05173       $function($item-&gt;data);
<a name="l05174"></a>05174       $queue-&gt;deleteItem($item);
<a name="l05175"></a>05175     }
<a name="l05176"></a>05176   }
<a name="l05177"></a>05177   <span class="comment">// Restore the user.</span>
<a name="l05178"></a>05178   $GLOBALS[<span class="stringliteral">&#39;user&#39;</span>] = $original_user;
<a name="l05179"></a>05179   <a class="code" href="session_8inc_a2e1c6443b96a7018027383ca39585ce7.html#a2e1c6443b96a7018027383ca39585ce7" title="Determines whether to save session data of the current request.">drupal_save_session</a>(TRUE);
<a name="l05180"></a>05180 
<a name="l05181"></a>05181   <span class="keywordflow">return</span> $return;
<a name="l05182"></a>05182 }
<a name="l05183"></a>05183 
<a name="l05190"></a><a class="code" href="common_8inc_a9067aaeb503fb9f994d98728130390a2.html#a9067aaeb503fb9f994d98728130390a2">05190</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a9067aaeb503fb9f994d98728130390a2.html#a9067aaeb503fb9f994d98728130390a2" title="Shutdown function: Performs cron cleanup.">drupal_cron_cleanup</a>() {
<a name="l05191"></a>05191   <span class="comment">// See if the semaphore is still locked.</span>
<a name="l05192"></a>05192   <span class="keywordflow">if</span> (<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;cron_semaphore&#39;</span>, FALSE)) {
<a name="l05193"></a>05193     <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;cron&#39;</span>, <span class="stringliteral">&#39;Cron run exceeded the time limit and was aborted.&#39;</span>, array(), <a class="code" href="group__logging__severity__levels_ga5361f835e10b39b553ee73c1b9414bf1.html#ga5361f835e10b39b553ee73c1b9414bf1" title="Log message severity -- Warning conditions.">WATCHDOG_WARNING</a>);
<a name="l05194"></a>05194 
<a name="l05195"></a>05195     <span class="comment">// Release cron semaphore.</span>
<a name="l05196"></a>05196     <a class="code" href="bootstrap_8inc_a7850bff5f313f85335f418e6d87606b1.html#a7850bff5f313f85335f418e6d87606b1" title="Unsets a persistent variable.">variable_del</a>(<span class="stringliteral">&#39;cron_semaphore&#39;</span>);
<a name="l05197"></a>05197   }
<a name="l05198"></a>05198 }
<a name="l05199"></a>05199 
<a name="l05248"></a><a class="code" href="common_8inc_a60d1237b23d4e84a59656003596add4b.html#a60d1237b23d4e84a59656003596add4b">05248</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a60d1237b23d4e84a59656003596add4b.html#a60d1237b23d4e84a59656003596add4b" title="Returns information about system object files (modules, themes, etc.).">drupal_system_listing</a>($mask, $directory, $key = <span class="stringliteral">&#39;name&#39;</span>, $min_depth = 1) {
<a name="l05249"></a>05249   $config = <a class="code" href="bootstrap_8inc_acef612ef19c49f6259531f0bee5c26cc.html#acef612ef19c49f6259531f0bee5c26cc" title="Finds the appropriate configuration directory.">conf_path</a>();
<a name="l05250"></a>05250 
<a name="l05251"></a>05251   $searchdir = array($directory);
<a name="l05252"></a>05252   $files = array();
<a name="l05253"></a>05253 
<a name="l05254"></a>05254   <span class="comment">// The &#39;profiles&#39; directory contains pristine collections of modules and</span>
<a name="l05255"></a>05255   <span class="comment">// themes as organized by a distribution. It is pristine in the same way</span>
<a name="l05256"></a>05256   <span class="comment">// that /modules is pristine for core; users should avoid changing anything</span>
<a name="l05257"></a>05257   <span class="comment">// there in favor of sites/all or sites/&lt;domain&gt; directories.</span>
<a name="l05258"></a>05258   $profiles = array();
<a name="l05259"></a>05259   $profile = <a class="code" href="common_8inc_a4128f0023ccec2d1a9a40987f0131d83.html#a4128f0023ccec2d1a9a40987f0131d83" title="Gets the name of the currently active install profile.">drupal_get_profile</a>();
<a name="l05260"></a>05260   <span class="comment">// For SimpleTest to be able to test modules packaged together with a</span>
<a name="l05261"></a>05261   <span class="comment">// distribution we need to include the profile of the parent site (in which</span>
<a name="l05262"></a>05262   <span class="comment">// test runs are triggered).</span>
<a name="l05263"></a>05263   <span class="keywordflow">if</span> (<a class="code" href="bootstrap_8inc_abdfb3ad2d4e0a21b9319296b2f4e25e2.html#abdfb3ad2d4e0a21b9319296b2f4e25e2" title="Returns the test prefix if this is an internal request from SimpleTest.">drupal_valid_test_ua</a>()) {
<a name="l05264"></a>05264     $testing_profile = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;simpletest_parent_profile&#39;</span>, FALSE);
<a name="l05265"></a>05265     <span class="keywordflow">if</span> ($testing_profile &amp;&amp; $testing_profile != $profile) {
<a name="l05266"></a>05266       $profiles[] = $testing_profile;
<a name="l05267"></a>05267     }
<a name="l05268"></a>05268   }
<a name="l05269"></a>05269   <span class="comment">// In case both profile directories contain the same extension, the actual</span>
<a name="l05270"></a>05270   <span class="comment">// profile always has precedence.</span>
<a name="l05271"></a>05271   $profiles[] = $profile;
<a name="l05272"></a>05272   <span class="keywordflow">foreach</span> ($profiles as $profile) {
<a name="l05273"></a>05273     <span class="keywordflow">if</span> (file_exists(<span class="stringliteral">&quot;profiles/$profile/$directory&quot;</span>)) {
<a name="l05274"></a>05274       $searchdir[] = <span class="stringliteral">&quot;profiles/$profile/$directory&quot;</span>;
<a name="l05275"></a>05275     }
<a name="l05276"></a>05276   }
<a name="l05277"></a>05277 
<a name="l05278"></a>05278   <span class="comment">// Always search sites/all/* as well as the global directories.</span>
<a name="l05279"></a>05279   $searchdir[] = <span class="stringliteral">&#39;sites/all/&#39;</span> . $directory;
<a name="l05280"></a>05280 
<a name="l05281"></a>05281   <span class="keywordflow">if</span> (file_exists(<span class="stringliteral">&quot;$config/$directory&quot;</span>)) {
<a name="l05282"></a>05282     $searchdir[] = <span class="stringliteral">&quot;$config/$directory&quot;</span>;
<a name="l05283"></a>05283   }
<a name="l05284"></a>05284 
<a name="l05285"></a>05285   <span class="comment">// Get current list of items.</span>
<a name="l05286"></a>05286   <span class="keywordflow">if</span> (!function_exists(<span class="stringliteral">&#39;file_scan_directory&#39;</span>)) {
<a name="l05287"></a>05287     require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/file.inc&#39;</span>;
<a name="l05288"></a>05288   }
<a name="l05289"></a>05289   <span class="keywordflow">foreach</span> ($searchdir as $dir) {
<a name="l05290"></a>05290     $files_to_add = <a class="code" href="group__file_ga363e988787ffa45bff69ff051eed0615.html#ga363e988787ffa45bff69ff051eed0615" title="Finds all files that match a given mask in a given directory.">file_scan_directory</a>($dir, $mask, array(<span class="stringliteral">&#39;key&#39;</span> =&gt; $key, <span class="stringliteral">&#39;min_depth&#39;</span> =&gt; $min_depth));
<a name="l05291"></a>05291 
<a name="l05292"></a>05292     <span class="comment">// Duplicate files found in later search directories take precedence over</span>
<a name="l05293"></a>05293     <span class="comment">// earlier ones, so we want them to overwrite keys in our resulting</span>
<a name="l05294"></a>05294     <span class="comment">// $files array.</span>
<a name="l05295"></a>05295     <span class="comment">// The exception to this is if the later file is from a module or theme not</span>
<a name="l05296"></a>05296     <span class="comment">// compatible with Drupal core. This may occur during upgrades of Drupal</span>
<a name="l05297"></a>05297     <span class="comment">// core when new modules exist in core while older contrib modules with the</span>
<a name="l05298"></a>05298     <span class="comment">// same name exist in a directory such as sites/all/modules/.</span>
<a name="l05299"></a>05299     <span class="keywordflow">foreach</span> (array_intersect_key($files_to_add, $files) as $file_key =&gt; $file) {
<a name="l05300"></a>05300       <span class="comment">// If it has no info file, then we just behave liberally and accept the</span>
<a name="l05301"></a>05301       <span class="comment">// new resource on the list for merging.</span>
<a name="l05302"></a>05302       <span class="keywordflow">if</span> (file_exists($info_file = dirname($file-&gt;uri) . <span class="charliteral">&#39;/&#39;</span> . $file-&gt;name . <span class="stringliteral">&#39;.info&#39;</span>)) {
<a name="l05303"></a>05303         <span class="comment">// Get the .info file for the module or theme this file belongs to.</span>
<a name="l05304"></a>05304         $info = <a class="code" href="common_8inc_a277955232059631211fcfde533ea89d6.html#a277955232059631211fcfde533ea89d6" title="End of &quot;addtogroup schemaapi&quot;.">drupal_parse_info_file</a>($info_file);
<a name="l05305"></a>05305 
<a name="l05306"></a>05306         <span class="comment">// If the module or theme is incompatible with Drupal core, remove it</span>
<a name="l05307"></a>05307         <span class="comment">// from the array for the current search directory, so it is not</span>
<a name="l05308"></a>05308         <span class="comment">// overwritten when merged with the $files array.</span>
<a name="l05309"></a>05309         <span class="keywordflow">if</span> (isset($info[<span class="stringliteral">&#39;core&#39;</span>]) &amp;&amp; $info[<span class="stringliteral">&#39;core&#39;</span>] != <a class="code" href="bootstrap_8inc_a4f0dd177a6291b9d7fc1b5ae033b5eaf.html#a4f0dd177a6291b9d7fc1b5ae033b5eaf" title="Core API compatibility.">DRUPAL_CORE_COMPATIBILITY</a>) {
<a name="l05310"></a>05310           unset($files_to_add[$file_key]);
<a name="l05311"></a>05311         }
<a name="l05312"></a>05312       }
<a name="l05313"></a>05313     }
<a name="l05314"></a>05314     $files = array_merge($files, $files_to_add);
<a name="l05315"></a>05315   }
<a name="l05316"></a>05316 
<a name="l05317"></a>05317   <span class="keywordflow">return</span> $files;
<a name="l05318"></a>05318 }
<a name="l05319"></a>05319 
<a name="l05334"></a><a class="code" href="common_8inc_a87c72c30529e99da7d4b25b6c1e00b1d.html#a87c72c30529e99da7d4b25b6c1e00b1d">05334</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a87c72c30529e99da7d4b25b6c1e00b1d.html#a87c72c30529e99da7d4b25b6c1e00b1d" title="Sets the main page content value for later use.">drupal_set_page_content</a>($content = NULL) {
<a name="l05335"></a>05335   $content_block = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__, NULL);
<a name="l05336"></a>05336   $main_content_display = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(<span class="stringliteral">&#39;system_main_content_added&#39;</span>, FALSE);
<a name="l05337"></a>05337 
<a name="l05338"></a>05338   <span class="keywordflow">if</span> (!empty($content)) {
<a name="l05339"></a>05339     $content_block = (is_array($content) ? $content : array(<span class="stringliteral">&#39;main&#39;</span> =&gt; array(<span class="stringliteral">&#39;#markup&#39;</span> =&gt; $content)));
<a name="l05340"></a>05340   }
<a name="l05341"></a>05341   <span class="keywordflow">else</span> {
<a name="l05342"></a>05342     <span class="comment">// Indicate that the main content has been requested. We assume that</span>
<a name="l05343"></a>05343     <span class="comment">// the module requesting the content will be adding it to the page.</span>
<a name="l05344"></a>05344     <span class="comment">// A module can indicate that it does not handle the content by setting</span>
<a name="l05345"></a>05345     <span class="comment">// the static variable back to FALSE after calling this function.</span>
<a name="l05346"></a>05346     $main_content_display = TRUE;
<a name="l05347"></a>05347     <span class="keywordflow">return</span> $content_block;
<a name="l05348"></a>05348   }
<a name="l05349"></a>05349 }
<a name="l05350"></a>05350 
<a name="l05380"></a><a class="code" href="common_8inc_a796bc999f4924685425e38cfb0a916ef.html#a796bc999f4924685425e38cfb0a916ef">05380</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a796bc999f4924685425e38cfb0a916ef.html#a796bc999f4924685425e38cfb0a916ef" title="#pre_render callback to render #browsers into #prefix and #suffix.">drupal_pre_render_conditional_comments</a>($elements) {
<a name="l05381"></a>05381   $browsers = isset($elements[<span class="stringliteral">&#39;#browsers&#39;</span>]) ? $elements[<span class="stringliteral">&#39;#browsers&#39;</span>] : array();
<a name="l05382"></a>05382   $browsers += array(
<a name="l05383"></a>05383     <span class="stringliteral">&#39;IE&#39;</span> =&gt; TRUE,
<a name="l05384"></a>05384     <span class="stringliteral">&#39;!IE&#39;</span> =&gt; TRUE,
<a name="l05385"></a>05385   );
<a name="l05386"></a>05386 
<a name="l05387"></a>05387   <span class="comment">// If rendering in all browsers, no need for conditional comments.</span>
<a name="l05388"></a>05388   <span class="keywordflow">if</span> ($browsers[<span class="stringliteral">&#39;IE&#39;</span>] === TRUE &amp;&amp; $browsers[<span class="stringliteral">&#39;!IE&#39;</span>]) {
<a name="l05389"></a>05389     <span class="keywordflow">return</span> $elements;
<a name="l05390"></a>05390   }
<a name="l05391"></a>05391 
<a name="l05392"></a>05392   <span class="comment">// Determine the conditional comment expression for Internet Explorer to</span>
<a name="l05393"></a>05393   <span class="comment">// evaluate.</span>
<a name="l05394"></a>05394   <span class="keywordflow">if</span> ($browsers[<span class="stringliteral">&#39;IE&#39;</span>] === TRUE) {
<a name="l05395"></a>05395     $expression = <span class="stringliteral">&#39;IE&#39;</span>;
<a name="l05396"></a>05396   }
<a name="l05397"></a>05397   elseif ($browsers[<span class="stringliteral">&#39;IE&#39;</span>] === FALSE) {
<a name="l05398"></a>05398     $expression = <span class="stringliteral">&#39;!IE&#39;</span>;
<a name="l05399"></a>05399   }
<a name="l05400"></a>05400   <span class="keywordflow">else</span> {
<a name="l05401"></a>05401     $expression = $browsers[<span class="stringliteral">&#39;IE&#39;</span>];
<a name="l05402"></a>05402   }
<a name="l05403"></a>05403 
<a name="l05404"></a>05404   <span class="comment">// Wrap the element&#39;s potentially existing #prefix and #suffix properties with</span>
<a name="l05405"></a>05405   <span class="comment">// conditional comment markup. The conditional comment expression is evaluated</span>
<a name="l05406"></a>05406   <span class="comment">// by Internet Explorer only. To control the rendering by other browsers,</span>
<a name="l05407"></a>05407   <span class="comment">// either the &quot;downlevel-hidden&quot; or &quot;downlevel-revealed&quot; technique must be</span>
<a name="l05408"></a>05408   <span class="comment">// used. See http://en.wikipedia.org/wiki/Conditional_comment for details.</span>
<a name="l05409"></a>05409   $elements += array(
<a name="l05410"></a>05410     <span class="stringliteral">&#39;#prefix&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l05411"></a>05411     <span class="stringliteral">&#39;#suffix&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l05412"></a>05412   );
<a name="l05413"></a>05413   <span class="keywordflow">if</span> (!$browsers[<span class="stringliteral">&#39;!IE&#39;</span>]) {
<a name="l05414"></a>05414     <span class="comment">// &quot;downlevel-hidden&quot;.</span>
<a name="l05415"></a>05415     $elements[<span class="stringliteral">&#39;#prefix&#39;</span>] = <span class="stringliteral">&quot;\n&lt;!--[if $expression]&gt;\n&quot;</span> . $elements[<span class="stringliteral">&#39;#prefix&#39;</span>];
<a name="l05416"></a>05416     $elements[<span class="stringliteral">&#39;#suffix&#39;</span>] .= <span class="stringliteral">&quot;&lt;![endif]--&gt;\n&quot;</span>;
<a name="l05417"></a>05417   }
<a name="l05418"></a>05418   <span class="keywordflow">else</span> {
<a name="l05419"></a>05419     <span class="comment">// &quot;downlevel-revealed&quot;.</span>
<a name="l05420"></a>05420     $elements[<span class="stringliteral">&#39;#prefix&#39;</span>] = <span class="stringliteral">&quot;\n&lt;!--[if $expression]&gt;&lt;!--&gt;\n&quot;</span> . $elements[<span class="stringliteral">&#39;#prefix&#39;</span>];
<a name="l05421"></a>05421     $elements[<span class="stringliteral">&#39;#suffix&#39;</span>] .= <span class="stringliteral">&quot;&lt;!--&lt;![endif]--&gt;\n&quot;</span>;
<a name="l05422"></a>05422   }
<a name="l05423"></a>05423 
<a name="l05424"></a>05424   <span class="keywordflow">return</span> $elements;
<a name="l05425"></a>05425 }
<a name="l05426"></a>05426 
<a name="l05441"></a><a class="code" href="common_8inc_a58664756a8b7d1e1d3765a54057c6d8b.html#a58664756a8b7d1e1d3765a54057c6d8b">05441</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a58664756a8b7d1e1d3765a54057c6d8b.html#a58664756a8b7d1e1d3765a54057c6d8b" title="#pre_render callback to render a link into #markup.">drupal_pre_render_link</a>($element) {
<a name="l05442"></a>05442   <span class="comment">// By default, link options to pass to l() are normally set in #options.</span>
<a name="l05443"></a>05443   $element += array(<span class="stringliteral">&#39;#options&#39;</span> =&gt; array());
<a name="l05444"></a>05444   <span class="comment">// However, within the scope of renderable elements, #attributes is a valid</span>
<a name="l05445"></a>05445   <span class="comment">// way to specify attributes, too. Take them into account, but do not override</span>
<a name="l05446"></a>05446   <span class="comment">// attributes from #options.</span>
<a name="l05447"></a>05447   <span class="keywordflow">if</span> (isset($element[<span class="stringliteral">&#39;#attributes&#39;</span>])) {
<a name="l05448"></a>05448     $element[<span class="stringliteral">&#39;#options&#39;</span>] += array(<span class="stringliteral">&#39;attributes&#39;</span> =&gt; array());
<a name="l05449"></a>05449     $element[<span class="stringliteral">&#39;#options&#39;</span>][<span class="stringliteral">&#39;attributes&#39;</span>] += $element[<span class="stringliteral">&#39;#attributes&#39;</span>];
<a name="l05450"></a>05450   }
<a name="l05451"></a>05451 
<a name="l05452"></a>05452   <span class="comment">// This #pre_render callback can be invoked from inside or outside of a Form</span>
<a name="l05453"></a>05453   <span class="comment">// API context, and depending on that, a HTML ID may be already set in</span>
<a name="l05454"></a>05454   <span class="comment">// different locations. #options should have precedence over Form API&#39;s #id.</span>
<a name="l05455"></a>05455   <span class="comment">// #attributes have been taken over into #options above already.</span>
<a name="l05456"></a>05456   <span class="keywordflow">if</span> (isset($element[<span class="stringliteral">&#39;#options&#39;</span>][<span class="stringliteral">&#39;attributes&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>])) {
<a name="l05457"></a>05457     $element[<span class="stringliteral">&#39;#id&#39;</span>] = $element[<span class="stringliteral">&#39;#options&#39;</span>][<span class="stringliteral">&#39;attributes&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>];
<a name="l05458"></a>05458   }
<a name="l05459"></a>05459   elseif (isset($element[<span class="stringliteral">&#39;#id&#39;</span>])) {
<a name="l05460"></a>05460     $element[<span class="stringliteral">&#39;#options&#39;</span>][<span class="stringliteral">&#39;attributes&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>] = $element[<span class="stringliteral">&#39;#id&#39;</span>];
<a name="l05461"></a>05461   }
<a name="l05462"></a>05462 
<a name="l05463"></a>05463   <span class="comment">// Conditionally invoke ajax_pre_render_element(), if #ajax is set.</span>
<a name="l05464"></a>05464   <span class="keywordflow">if</span> (isset($element[<span class="stringliteral">&#39;#ajax&#39;</span>]) &amp;&amp; !isset($element[<span class="stringliteral">&#39;#ajax_processed&#39;</span>])) {
<a name="l05465"></a>05465     <span class="comment">// If no HTML ID was found above, automatically create one.</span>
<a name="l05466"></a>05466     <span class="keywordflow">if</span> (!isset($element[<span class="stringliteral">&#39;#id&#39;</span>])) {
<a name="l05467"></a>05467       $element[<span class="stringliteral">&#39;#id&#39;</span>] = $element[<span class="stringliteral">&#39;#options&#39;</span>][<span class="stringliteral">&#39;attributes&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>] = <a class="code" href="common_8inc_accaa7f3e2e401747b19be982c9f90323.html#accaa7f3e2e401747b19be982c9f90323" title="Prepares a string for use as a valid HTML ID and guarantees uniqueness.">drupal_html_id</a>(<span class="stringliteral">&#39;ajax-link&#39;</span>);
<a name="l05468"></a>05468     }
<a name="l05469"></a>05469     <span class="comment">// If #ajax[&#39;path] was not specified, use the href as Ajax request URL.</span>
<a name="l05470"></a>05470     <span class="keywordflow">if</span> (!isset($element[<span class="stringliteral">&#39;#ajax&#39;</span>][<span class="stringliteral">&#39;path&#39;</span>])) {
<a name="l05471"></a>05471       $element[<span class="stringliteral">&#39;#ajax&#39;</span>][<span class="stringliteral">&#39;path&#39;</span>] = $element[<span class="stringliteral">&#39;#href&#39;</span>];
<a name="l05472"></a>05472       $element[<span class="stringliteral">&#39;#ajax&#39;</span>][<span class="stringliteral">&#39;options&#39;</span>] = $element[<span class="stringliteral">&#39;#options&#39;</span>];
<a name="l05473"></a>05473     }
<a name="l05474"></a>05474     $element = <a class="code" href="group__ajax_ga028d2f2b6b3875d91ea6cc88b19f237b.html#ga028d2f2b6b3875d91ea6cc88b19f237b" title="Adds Ajax information about an element to communicate with JavaScript.">ajax_pre_render_element</a>($element);
<a name="l05475"></a>05475   }
<a name="l05476"></a>05476 
<a name="l05477"></a>05477   $element[<span class="stringliteral">&#39;#markup&#39;</span>] = <a class="code" href="common_8inc_ad3b36c06dc46250b8d22b8d0d2e7bd97.html#ad3b36c06dc46250b8d22b8d0d2e7bd97" title="Formats an internal or external URL link as an HTML anchor tag.">l</a>($element[<span class="stringliteral">&#39;#title&#39;</span>], $element[<span class="stringliteral">&#39;#href&#39;</span>], $element[<span class="stringliteral">&#39;#options&#39;</span>]);
<a name="l05478"></a>05478   <span class="keywordflow">return</span> $element;
<a name="l05479"></a>05479 }
<a name="l05480"></a>05480 
<a name="l05556"></a><a class="code" href="common_8inc_a678780979d6d69c92710d392004411ff.html#a678780979d6d69c92710d392004411ff">05556</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a678780979d6d69c92710d392004411ff.html#a678780979d6d69c92710d392004411ff" title="#pre_render callback that collects child links into a single array.">drupal_pre_render_links</a>($element) {
<a name="l05557"></a>05557   $element += array(<span class="stringliteral">&#39;#links&#39;</span> =&gt; array());
<a name="l05558"></a>05558   <span class="keywordflow">foreach</span> (<a class="code" href="common_8inc_ad38ed83e102f4f8c6c47e416543969bc.html#ad38ed83e102f4f8c6c47e416543969bc" title="Identifies the children of an element array, optionally sorted by weight.">element_children</a>($element) as $key) {
<a name="l05559"></a>05559     $child = &amp;$element[$key];
<a name="l05560"></a>05560     <span class="comment">// If the child has links which have not been printed yet and the user has</span>
<a name="l05561"></a>05561     <span class="comment">// access to it, merge its links in to the parent.</span>
<a name="l05562"></a>05562     <span class="keywordflow">if</span> (isset($child[<span class="stringliteral">&#39;#links&#39;</span>]) &amp;&amp; empty($child[<span class="stringliteral">&#39;#printed&#39;</span>]) &amp;&amp; (!isset($child[<span class="stringliteral">&#39;#access&#39;</span>]) || $child[<span class="stringliteral">&#39;#access&#39;</span>])) {
<a name="l05563"></a>05563       $element[<span class="stringliteral">&#39;#links&#39;</span>] += $child[<span class="stringliteral">&#39;#links&#39;</span>];
<a name="l05564"></a>05564       <span class="comment">// Mark the child as having been printed already (so that its links</span>
<a name="l05565"></a>05565       <span class="comment">// cannot be mistakenly rendered twice).</span>
<a name="l05566"></a>05566       $child[<span class="stringliteral">&#39;#printed&#39;</span>] = TRUE;
<a name="l05567"></a>05567     }
<a name="l05568"></a>05568   }
<a name="l05569"></a>05569   <span class="keywordflow">return</span> $element;
<a name="l05570"></a>05570 }
<a name="l05571"></a>05571 
<a name="l05588"></a><a class="code" href="common_8inc_a3367ec9635e712d363e2363d16558128.html#a3367ec9635e712d363e2363d16558128">05588</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a3367ec9635e712d363e2363d16558128.html#a3367ec9635e712d363e2363d16558128" title="#pre_render callback to append contents in #markup to #children.">drupal_pre_render_markup</a>($elements) {
<a name="l05589"></a>05589   $elements[<span class="stringliteral">&#39;#children&#39;</span>] = $elements[<span class="stringliteral">&#39;#markup&#39;</span>];
<a name="l05590"></a>05590   <span class="keywordflow">return</span> $elements;
<a name="l05591"></a>05591 }
<a name="l05592"></a>05592 
<a name="l05607"></a><a class="code" href="common_8inc_ad85d021b660f070849ed7c215d9758fe.html#ad85d021b660f070849ed7c215d9758fe">05607</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ad85d021b660f070849ed7c215d9758fe.html#ad85d021b660f070849ed7c215d9758fe" title="Renders the page, including all theming.">drupal_render_page</a>($page) {
<a name="l05608"></a>05608   $main_content_display = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(<span class="stringliteral">&#39;system_main_content_added&#39;</span>, FALSE);
<a name="l05609"></a>05609 
<a name="l05610"></a>05610   <span class="comment">// Allow menu callbacks to return strings or arbitrary arrays to render.</span>
<a name="l05611"></a>05611   <span class="comment">// If the array returned is not of #type page directly, we need to fill</span>
<a name="l05612"></a>05612   <span class="comment">// in the page with defaults.</span>
<a name="l05613"></a>05613   <span class="keywordflow">if</span> (is_string($page) || (is_array($page) &amp;&amp; (!isset($page[<span class="stringliteral">&#39;#type&#39;</span>]) || ($page[<span class="stringliteral">&#39;#type&#39;</span>] != <span class="stringliteral">&#39;page&#39;</span>)))) {
<a name="l05614"></a>05614     <a class="code" href="common_8inc_a87c72c30529e99da7d4b25b6c1e00b1d.html#a87c72c30529e99da7d4b25b6c1e00b1d" title="Sets the main page content value for later use.">drupal_set_page_content</a>($page);
<a name="l05615"></a>05615     $page = <a class="code" href="common_8inc_a5745b4e27c2946a902d49c0923f46739.html#a5745b4e27c2946a902d49c0923f46739" title="Retrieves the default properties for the defined element type.">element_info</a>(<span class="stringliteral">&#39;page&#39;</span>);
<a name="l05616"></a>05616   }
<a name="l05617"></a>05617 
<a name="l05618"></a>05618   <span class="comment">// Modules can add elements to $page as needed in hook_page_build().</span>
<a name="l05619"></a>05619   <span class="keywordflow">foreach</span> (<a class="code" href="group__hooks_ga9191200072f2a641829e9d3c2759561f.html#ga9191200072f2a641829e9d3c2759561f" title="Determine which modules are implementing a hook.">module_implements</a>(<span class="stringliteral">&#39;page_build&#39;</span>) as $module) {
<a name="l05620"></a>05620     $function = $module . <span class="stringliteral">&#39;_page_build&#39;</span>;
<a name="l05621"></a>05621     $function($page);
<a name="l05622"></a>05622   }
<a name="l05623"></a>05623   <span class="comment">// Modules alter the $page as needed. Blocks are populated into regions like</span>
<a name="l05624"></a>05624   <span class="comment">// &#39;sidebar_first&#39;, &#39;footer&#39;, etc.</span>
<a name="l05625"></a>05625   <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;page&#39;</span>, $page);
<a name="l05626"></a>05626 
<a name="l05627"></a>05627   <span class="comment">// If no module has taken care of the main content, add it to the page now.</span>
<a name="l05628"></a>05628   <span class="comment">// This allows the site to still be usable even if no modules that</span>
<a name="l05629"></a>05629   <span class="comment">// control page regions (for example, the Block module) are enabled.</span>
<a name="l05630"></a>05630   <span class="keywordflow">if</span> (!$main_content_display) {
<a name="l05631"></a>05631     $page[<span class="stringliteral">&#39;content&#39;</span>][<span class="stringliteral">&#39;system_main&#39;</span>] = <a class="code" href="common_8inc_a87c72c30529e99da7d4b25b6c1e00b1d.html#a87c72c30529e99da7d4b25b6c1e00b1d" title="Sets the main page content value for later use.">drupal_set_page_content</a>();
<a name="l05632"></a>05632   }
<a name="l05633"></a>05633 
<a name="l05634"></a>05634   <span class="keywordflow">return</span> <a class="code" href="common_8inc_a05798b44e8d6c496d4bee5cc32fa7851.html#a05798b44e8d6c496d4bee5cc32fa7851" title="Renders HTML given a structured array tree.">drupal_render</a>($page);
<a name="l05635"></a>05635 }
<a name="l05636"></a>05636 
<a name="l05714"></a><a class="code" href="common_8inc_a05798b44e8d6c496d4bee5cc32fa7851.html#a05798b44e8d6c496d4bee5cc32fa7851">05714</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a05798b44e8d6c496d4bee5cc32fa7851.html#a05798b44e8d6c496d4bee5cc32fa7851" title="Renders HTML given a structured array tree.">drupal_render</a>(&amp;$elements) {
<a name="l05715"></a>05715   <span class="comment">// Early-return nothing if user does not have access.</span>
<a name="l05716"></a>05716   <span class="keywordflow">if</span> (empty($elements) || (isset($elements[<span class="stringliteral">&#39;#access&#39;</span>]) &amp;&amp; !$elements[<span class="stringliteral">&#39;#access&#39;</span>])) {
<a name="l05717"></a>05717     <span class="keywordflow">return</span>;
<a name="l05718"></a>05718   }
<a name="l05719"></a>05719 
<a name="l05720"></a>05720   <span class="comment">// Do not print elements twice.</span>
<a name="l05721"></a>05721   <span class="keywordflow">if</span> (!empty($elements[<span class="stringliteral">&#39;#printed&#39;</span>])) {
<a name="l05722"></a>05722     <span class="keywordflow">return</span>;
<a name="l05723"></a>05723   }
<a name="l05724"></a>05724 
<a name="l05725"></a>05725   <span class="comment">// Try to fetch the element&#39;s markup from cache and return.</span>
<a name="l05726"></a>05726   <span class="keywordflow">if</span> (isset($elements[<span class="stringliteral">&#39;#cache&#39;</span>])) {
<a name="l05727"></a>05727     $cached_output = <a class="code" href="common_8inc_a8726783745547f4686cea624be0b0562.html#a8726783745547f4686cea624be0b0562" title="Gets the rendered output of a renderable element from the cache.">drupal_render_cache_get</a>($elements);
<a name="l05728"></a>05728     <span class="keywordflow">if</span> ($cached_output !== FALSE) {
<a name="l05729"></a>05729       <span class="keywordflow">return</span> $cached_output;
<a name="l05730"></a>05730     }
<a name="l05731"></a>05731   }
<a name="l05732"></a>05732 
<a name="l05733"></a>05733   <span class="comment">// If #markup is set, ensure #type is set. This allows to specify just #markup</span>
<a name="l05734"></a>05734   <span class="comment">// on an element without setting #type.</span>
<a name="l05735"></a>05735   <span class="keywordflow">if</span> (isset($elements[<span class="stringliteral">&#39;#markup&#39;</span>]) &amp;&amp; !isset($elements[<span class="stringliteral">&#39;#type&#39;</span>])) {
<a name="l05736"></a>05736     $elements[<span class="stringliteral">&#39;#type&#39;</span>] = <span class="stringliteral">&#39;markup&#39;</span>;
<a name="l05737"></a>05737   }
<a name="l05738"></a>05738 
<a name="l05739"></a>05739   <span class="comment">// If the default values for this element have not been loaded yet, populate</span>
<a name="l05740"></a>05740   <span class="comment">// them.</span>
<a name="l05741"></a>05741   <span class="keywordflow">if</span> (isset($elements[<span class="stringliteral">&#39;#type&#39;</span>]) &amp;&amp; empty($elements[<span class="stringliteral">&#39;#defaults_loaded&#39;</span>])) {
<a name="l05742"></a>05742     $elements += <a class="code" href="common_8inc_a5745b4e27c2946a902d49c0923f46739.html#a5745b4e27c2946a902d49c0923f46739" title="Retrieves the default properties for the defined element type.">element_info</a>($elements[<span class="stringliteral">&#39;#type&#39;</span>]);
<a name="l05743"></a>05743   }
<a name="l05744"></a>05744 
<a name="l05745"></a>05745   <span class="comment">// Make any final changes to the element before it is rendered. This means</span>
<a name="l05746"></a>05746   <span class="comment">// that the $element or the children can be altered or corrected before the</span>
<a name="l05747"></a>05747   <span class="comment">// element is rendered into the final text.</span>
<a name="l05748"></a>05748   <span class="keywordflow">if</span> (isset($elements[<span class="stringliteral">&#39;#pre_render&#39;</span>])) {
<a name="l05749"></a>05749     <span class="keywordflow">foreach</span> ($elements[<span class="stringliteral">&#39;#pre_render&#39;</span>] as $function) {
<a name="l05750"></a>05750       <span class="keywordflow">if</span> (function_exists($function)) {
<a name="l05751"></a>05751         $elements = $function($elements);
<a name="l05752"></a>05752       }
<a name="l05753"></a>05753     }
<a name="l05754"></a>05754   }
<a name="l05755"></a>05755 
<a name="l05756"></a>05756   <span class="comment">// Allow #pre_render to abort rendering.</span>
<a name="l05757"></a>05757   <span class="keywordflow">if</span> (!empty($elements[<span class="stringliteral">&#39;#printed&#39;</span>])) {
<a name="l05758"></a>05758     <span class="keywordflow">return</span>;
<a name="l05759"></a>05759   }
<a name="l05760"></a>05760 
<a name="l05761"></a>05761   <span class="comment">// Get the children of the element, sorted by weight.</span>
<a name="l05762"></a>05762   $children = <a class="code" href="common_8inc_ad38ed83e102f4f8c6c47e416543969bc.html#ad38ed83e102f4f8c6c47e416543969bc" title="Identifies the children of an element array, optionally sorted by weight.">element_children</a>($elements, TRUE);
<a name="l05763"></a>05763 
<a name="l05764"></a>05764   <span class="comment">// Initialize this element&#39;s #children, unless a #pre_render callback already</span>
<a name="l05765"></a>05765   <span class="comment">// preset #children.</span>
<a name="l05766"></a>05766   <span class="keywordflow">if</span> (!isset($elements[<span class="stringliteral">&#39;#children&#39;</span>])) {
<a name="l05767"></a>05767     $elements[<span class="stringliteral">&#39;#children&#39;</span>] = <span class="stringliteral">&#39;&#39;</span>;
<a name="l05768"></a>05768   }
<a name="l05769"></a>05769   <span class="comment">// Call the element&#39;s #theme function if it is set. Then any children of the</span>
<a name="l05770"></a>05770   <span class="comment">// element have to be rendered there.</span>
<a name="l05771"></a>05771   <span class="keywordflow">if</span> (isset($elements[<span class="stringliteral">&#39;#theme&#39;</span>])) {
<a name="l05772"></a>05772     $elements[<span class="stringliteral">&#39;#children&#39;</span>] = <a class="code" href="theme_8inc_a7c25609a935874541a19657affd30fff.html#a7c25609a935874541a19657affd30fff" title="Generates themed output.">theme</a>($elements[<span class="stringliteral">&#39;#theme&#39;</span>], $elements);
<a name="l05773"></a>05773   }
<a name="l05774"></a>05774   <span class="comment">// If #theme was not set and the element has children, render them now.</span>
<a name="l05775"></a>05775   <span class="comment">// This is the same process as drupal_render_children() but is inlined</span>
<a name="l05776"></a>05776   <span class="comment">// for speed.</span>
<a name="l05777"></a>05777   <span class="keywordflow">if</span> ($elements[<span class="stringliteral">&#39;#children&#39;</span>] == <span class="stringliteral">&#39;&#39;</span>) {
<a name="l05778"></a>05778     <span class="keywordflow">foreach</span> ($children as $key) {
<a name="l05779"></a>05779       $elements[<span class="stringliteral">&#39;#children&#39;</span>] .= <a class="code" href="common_8inc_a05798b44e8d6c496d4bee5cc32fa7851.html#a05798b44e8d6c496d4bee5cc32fa7851" title="Renders HTML given a structured array tree.">drupal_render</a>($elements[$key]);
<a name="l05780"></a>05780     }
<a name="l05781"></a>05781   }
<a name="l05782"></a>05782 
<a name="l05783"></a>05783   <span class="comment">// Let the theme functions in #theme_wrappers add markup around the rendered</span>
<a name="l05784"></a>05784   <span class="comment">// children.</span>
<a name="l05785"></a>05785   <span class="keywordflow">if</span> (isset($elements[<span class="stringliteral">&#39;#theme_wrappers&#39;</span>])) {
<a name="l05786"></a>05786     <span class="keywordflow">foreach</span> ($elements[<span class="stringliteral">&#39;#theme_wrappers&#39;</span>] as $theme_wrapper) {
<a name="l05787"></a>05787       $elements[<span class="stringliteral">&#39;#children&#39;</span>] = <a class="code" href="theme_8inc_a7c25609a935874541a19657affd30fff.html#a7c25609a935874541a19657affd30fff" title="Generates themed output.">theme</a>($theme_wrapper, $elements);
<a name="l05788"></a>05788     }
<a name="l05789"></a>05789   }
<a name="l05790"></a>05790 
<a name="l05791"></a>05791   <span class="comment">// Filter the outputted content and make any last changes before the</span>
<a name="l05792"></a>05792   <span class="comment">// content is sent to the browser. The changes are made on $content</span>
<a name="l05793"></a>05793   <span class="comment">// which allows the output&#39;ed text to be filtered.</span>
<a name="l05794"></a>05794   <span class="keywordflow">if</span> (isset($elements[<span class="stringliteral">&#39;#post_render&#39;</span>])) {
<a name="l05795"></a>05795     <span class="keywordflow">foreach</span> ($elements[<span class="stringliteral">&#39;#post_render&#39;</span>] as $function) {
<a name="l05796"></a>05796       <span class="keywordflow">if</span> (function_exists($function)) {
<a name="l05797"></a>05797         $elements[<span class="stringliteral">&#39;#children&#39;</span>] = $function($elements[<span class="stringliteral">&#39;#children&#39;</span>], $elements);
<a name="l05798"></a>05798       }
<a name="l05799"></a>05799     }
<a name="l05800"></a>05800   }
<a name="l05801"></a>05801 
<a name="l05802"></a>05802   <span class="comment">// Add any JavaScript state information associated with the element.</span>
<a name="l05803"></a>05803   <span class="keywordflow">if</span> (!empty($elements[<span class="stringliteral">&#39;#states&#39;</span>])) {
<a name="l05804"></a>05804     <a class="code" href="common_8inc_a335ef221d12db75393875deed0622ea1.html#a335ef221d12db75393875deed0622ea1" title="Adds JavaScript to change the state of an element based on another element.">drupal_process_states</a>($elements);
<a name="l05805"></a>05805   }
<a name="l05806"></a>05806 
<a name="l05807"></a>05807   <span class="comment">// Add additional libraries, CSS, JavaScript an other custom</span>
<a name="l05808"></a>05808   <span class="comment">// attached data associated with this element.</span>
<a name="l05809"></a>05809   <span class="keywordflow">if</span> (!empty($elements[<span class="stringliteral">&#39;#attached&#39;</span>])) {
<a name="l05810"></a>05810     <a class="code" href="common_8inc_a31e3a25219e1d3a2f74670694b30dee6.html#a31e3a25219e1d3a2f74670694b30dee6" title="Adds attachments to a render() structure.">drupal_process_attached</a>($elements);
<a name="l05811"></a>05811   }
<a name="l05812"></a>05812 
<a name="l05813"></a>05813   $prefix = isset($elements[<span class="stringliteral">&#39;#prefix&#39;</span>]) ? $elements[<span class="stringliteral">&#39;#prefix&#39;</span>] : <span class="stringliteral">&#39;&#39;</span>;
<a name="l05814"></a>05814   $suffix = isset($elements[<span class="stringliteral">&#39;#suffix&#39;</span>]) ? $elements[<span class="stringliteral">&#39;#suffix&#39;</span>] : <span class="stringliteral">&#39;&#39;</span>;
<a name="l05815"></a>05815   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> = $prefix . $elements[<span class="stringliteral">&#39;#children&#39;</span>] . $suffix;
<a name="l05816"></a>05816 
<a name="l05817"></a>05817   <span class="comment">// Cache the processed element if #cache is set.</span>
<a name="l05818"></a>05818   <span class="keywordflow">if</span> (isset($elements[<span class="stringliteral">&#39;#cache&#39;</span>])) {
<a name="l05819"></a>05819     <a class="code" href="common_8inc_aee3169994180319d0fe2b1738825c54c.html#aee3169994180319d0fe2b1738825c54c" title="Caches the rendered output of a renderable element.">drupal_render_cache_set</a>(<a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>, $elements);
<a name="l05820"></a>05820   }
<a name="l05821"></a>05821 
<a name="l05822"></a>05822   $elements[<span class="stringliteral">&#39;#printed&#39;</span>] = TRUE;
<a name="l05823"></a>05823   <span class="keywordflow">return</span> <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>;
<a name="l05824"></a>05824 }
<a name="l05825"></a>05825 
<a name="l05838"></a><a class="code" href="common_8inc_aa0cac24bf2aa19237fd012fea704b8ac.html#aa0cac24bf2aa19237fd012fea704b8ac">05838</a> <span class="keyword">function</span> <a class="code" href="common_8inc_aa0cac24bf2aa19237fd012fea704b8ac.html#aa0cac24bf2aa19237fd012fea704b8ac" title="Renders children of an element and concatenates them.">drupal_render_children</a>(&amp;$element, $children_keys = NULL) {
<a name="l05839"></a>05839   <span class="keywordflow">if</span> ($children_keys === NULL) {
<a name="l05840"></a>05840     $children_keys = <a class="code" href="common_8inc_ad38ed83e102f4f8c6c47e416543969bc.html#ad38ed83e102f4f8c6c47e416543969bc" title="Identifies the children of an element array, optionally sorted by weight.">element_children</a>($element);
<a name="l05841"></a>05841   }
<a name="l05842"></a>05842   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> = <span class="stringliteral">&#39;&#39;</span>;
<a name="l05843"></a>05843   <span class="keywordflow">foreach</span> ($children_keys as $key) {
<a name="l05844"></a>05844     <span class="keywordflow">if</span> (!empty($element[$key])) {
<a name="l05845"></a>05845       <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <a class="code" href="common_8inc_a05798b44e8d6c496d4bee5cc32fa7851.html#a05798b44e8d6c496d4bee5cc32fa7851" title="Renders HTML given a structured array tree.">drupal_render</a>($element[$key]);
<a name="l05846"></a>05846     }
<a name="l05847"></a>05847   }
<a name="l05848"></a>05848   <span class="keywordflow">return</span> <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>;
<a name="l05849"></a>05849 }
<a name="l05850"></a>05850 
<a name="l05868"></a><a class="code" href="common_8inc_a5f4b2009c1caf78549203cec9b324305.html#a5f4b2009c1caf78549203cec9b324305">05868</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a5f4b2009c1caf78549203cec9b324305.html#a5f4b2009c1caf78549203cec9b324305" title="Renders an element.">render</a>(&amp;$element) {
<a name="l05869"></a>05869   <span class="keywordflow">if</span> (is_array($element)) {
<a name="l05870"></a>05870     <a class="code" href="common_8inc_a5118f0601a3243a2d651369892b6cd47.html#a5118f0601a3243a2d651369892b6cd47" title="Shows a hidden element for later rendering.">show</a>($element);
<a name="l05871"></a>05871     <span class="keywordflow">return</span> <a class="code" href="common_8inc_a05798b44e8d6c496d4bee5cc32fa7851.html#a05798b44e8d6c496d4bee5cc32fa7851" title="Renders HTML given a structured array tree.">drupal_render</a>($element);
<a name="l05872"></a>05872   }
<a name="l05873"></a>05873   <span class="keywordflow">else</span> {
<a name="l05874"></a>05874     <span class="comment">// Safe-guard for inappropriate use of render() on flat variables: return</span>
<a name="l05875"></a>05875     <span class="comment">// the variable as-is.</span>
<a name="l05876"></a>05876     <span class="keywordflow">return</span> $element;
<a name="l05877"></a>05877   }
<a name="l05878"></a>05878 }
<a name="l05879"></a>05879 
<a name="l05901"></a><a class="code" href="common_8inc_aa57f04b6e1f5cdc3ed30abf98fd0fd3f.html#aa57f04b6e1f5cdc3ed30abf98fd0fd3f">05901</a> <span class="keyword">function</span> <a class="code" href="common_8inc_aa57f04b6e1f5cdc3ed30abf98fd0fd3f.html#aa57f04b6e1f5cdc3ed30abf98fd0fd3f" title="Hides an element from later rendering.">hide</a>(&amp;$element) {
<a name="l05902"></a>05902   $element[<span class="stringliteral">&#39;#printed&#39;</span>] = TRUE;
<a name="l05903"></a>05903   <span class="keywordflow">return</span> $element;
<a name="l05904"></a>05904 }
<a name="l05905"></a>05905 
<a name="l05930"></a><a class="code" href="common_8inc_a5118f0601a3243a2d651369892b6cd47.html#a5118f0601a3243a2d651369892b6cd47">05930</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a5118f0601a3243a2d651369892b6cd47.html#a5118f0601a3243a2d651369892b6cd47" title="Shows a hidden element for later rendering.">show</a>(&amp;$element) {
<a name="l05931"></a>05931   $element[<span class="stringliteral">&#39;#printed&#39;</span>] = FALSE;
<a name="l05932"></a>05932   <span class="keywordflow">return</span> $element;
<a name="l05933"></a>05933 }
<a name="l05934"></a>05934 
<a name="l05948"></a><a class="code" href="common_8inc_a8726783745547f4686cea624be0b0562.html#a8726783745547f4686cea624be0b0562">05948</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a8726783745547f4686cea624be0b0562.html#a8726783745547f4686cea624be0b0562" title="Gets the rendered output of a renderable element from the cache.">drupal_render_cache_get</a>($elements) {
<a name="l05949"></a>05949   <span class="keywordflow">if</span> (!in_array($_SERVER[<span class="stringliteral">&#39;REQUEST_METHOD&#39;</span>], array(<span class="stringliteral">&#39;GET&#39;</span>, <span class="stringliteral">&#39;HEAD&#39;</span>)) || !$cid = <a class="code" href="common_8inc_a28d419376079fb2c1f790d4af72451ec.html#a28d419376079fb2c1f790d4af72451ec" title="Creates the cache ID for a renderable element.">drupal_render_cid_create</a>($elements)) {
<a name="l05950"></a>05950     <span class="keywordflow">return</span> FALSE;
<a name="l05951"></a>05951   }
<a name="l05952"></a>05952   $bin = isset($elements[<span class="stringliteral">&#39;#cache&#39;</span>][<span class="stringliteral">&#39;bin&#39;</span>]) ? $elements[<span class="stringliteral">&#39;#cache&#39;</span>][<span class="stringliteral">&#39;bin&#39;</span>] : <span class="stringliteral">&#39;cache&#39;</span>;
<a name="l05953"></a>05953 
<a name="l05954"></a>05954   <span class="keywordflow">if</span> (!empty($cid) &amp;&amp; $cache = <a class="code" href="cache_8inc_a9d873815c28909b61c3a6188b383f8a3.html#a9d873815c28909b61c3a6188b383f8a3" title="Returns data from the persistent cache.">cache_get</a>($cid, $bin)) {
<a name="l05955"></a>05955     <span class="comment">// Add additional libraries, JavaScript, CSS and other data attached</span>
<a name="l05956"></a>05956     <span class="comment">// to this element.</span>
<a name="l05957"></a>05957     <span class="keywordflow">if</span> (isset($cache-&gt;data[<span class="stringliteral">&#39;#attached&#39;</span>])) {
<a name="l05958"></a>05958       <a class="code" href="common_8inc_a31e3a25219e1d3a2f74670694b30dee6.html#a31e3a25219e1d3a2f74670694b30dee6" title="Adds attachments to a render() structure.">drupal_process_attached</a>($cache-&gt;data);
<a name="l05959"></a>05959     }
<a name="l05960"></a>05960     <span class="comment">// Return the rendered output.</span>
<a name="l05961"></a>05961     <span class="keywordflow">return</span> $cache-&gt;data[<span class="stringliteral">&#39;#markup&#39;</span>];
<a name="l05962"></a>05962   }
<a name="l05963"></a>05963   <span class="keywordflow">return</span> FALSE;
<a name="l05964"></a>05964 }
<a name="l05965"></a>05965 
<a name="l05979"></a><a class="code" href="common_8inc_aee3169994180319d0fe2b1738825c54c.html#aee3169994180319d0fe2b1738825c54c">05979</a> <span class="keyword">function</span> <a class="code" href="common_8inc_aee3169994180319d0fe2b1738825c54c.html#aee3169994180319d0fe2b1738825c54c" title="Caches the rendered output of a renderable element.">drupal_render_cache_set</a>(&amp;$markup, $elements) {
<a name="l05980"></a>05980   <span class="comment">// Create the cache ID for the element.</span>
<a name="l05981"></a>05981   <span class="keywordflow">if</span> (!in_array($_SERVER[<span class="stringliteral">&#39;REQUEST_METHOD&#39;</span>], array(<span class="stringliteral">&#39;GET&#39;</span>, <span class="stringliteral">&#39;HEAD&#39;</span>)) || !$cid = <a class="code" href="common_8inc_a28d419376079fb2c1f790d4af72451ec.html#a28d419376079fb2c1f790d4af72451ec" title="Creates the cache ID for a renderable element.">drupal_render_cid_create</a>($elements)) {
<a name="l05982"></a>05982     <span class="keywordflow">return</span> FALSE;
<a name="l05983"></a>05983   }
<a name="l05984"></a>05984 
<a name="l05985"></a>05985   <span class="comment">// Cache implementations are allowed to modify the markup, to support</span>
<a name="l05986"></a>05986   <span class="comment">// replacing markup with edge-side include commands. The supporting cache</span>
<a name="l05987"></a>05987   <span class="comment">// backend will store the markup in some other key (like</span>
<a name="l05988"></a>05988   <span class="comment">// $data[&#39;#real-value&#39;]) and return an include command instead. When the</span>
<a name="l05989"></a>05989   <span class="comment">// ESI command is executed by the content accelerator, the real value can</span>
<a name="l05990"></a>05990   <span class="comment">// be retrieved and used.</span>
<a name="l05991"></a>05991   $data[<span class="stringliteral">&#39;#markup&#39;</span>] = &amp;$markup;
<a name="l05992"></a>05992   <span class="comment">// Persist attached data associated with this element.</span>
<a name="l05993"></a>05993   $attached = <a class="code" href="common_8inc_a3a65448a9382c58f1767b8b01f27dae6.html#a3a65448a9382c58f1767b8b01f27dae6" title="Collects #attached for an element and its children into a single array.">drupal_render_collect_attached</a>($elements, TRUE);
<a name="l05994"></a>05994   <span class="keywordflow">if</span> ($attached) {
<a name="l05995"></a>05995     $data[<span class="stringliteral">&#39;#attached&#39;</span>] = $attached;
<a name="l05996"></a>05996   }
<a name="l05997"></a>05997   $bin = isset($elements[<span class="stringliteral">&#39;#cache&#39;</span>][<span class="stringliteral">&#39;bin&#39;</span>]) ? $elements[<span class="stringliteral">&#39;#cache&#39;</span>][<span class="stringliteral">&#39;bin&#39;</span>] : <span class="stringliteral">&#39;cache&#39;</span>;
<a name="l05998"></a>05998   $expire = isset($elements[<span class="stringliteral">&#39;#cache&#39;</span>][<span class="stringliteral">&#39;expire&#39;</span>]) ? $elements[<span class="stringliteral">&#39;#cache&#39;</span>][<span class="stringliteral">&#39;expire&#39;</span>] : <a class="code" href="bootstrap_8inc_ad987330fff5fa7c75800762ddedf300c.html#ad987330fff5fa7c75800762ddedf300c" title="Indicates that the item should never be removed unless explicitly selected.">CACHE_PERMANENT</a>;
<a name="l05999"></a>05999   <a class="code" href="cache_8inc_a48081f36334909f561ef4f538fa640d2.html#a48081f36334909f561ef4f538fa640d2" title="Stores data in the persistent cache.">cache_set</a>($cid, $data, $bin, $expire);
<a name="l06000"></a>06000 }
<a name="l06001"></a>06001 
<a name="l06018"></a><a class="code" href="common_8inc_a3a65448a9382c58f1767b8b01f27dae6.html#a3a65448a9382c58f1767b8b01f27dae6">06018</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a3a65448a9382c58f1767b8b01f27dae6.html#a3a65448a9382c58f1767b8b01f27dae6" title="Collects #attached for an element and its children into a single array.">drupal_render_collect_attached</a>($elements, $return = FALSE) {
<a name="l06019"></a>06019   $attached = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__, array());
<a name="l06020"></a>06020 
<a name="l06021"></a>06021   <span class="comment">// Collect all #attached for this element.</span>
<a name="l06022"></a>06022   <span class="keywordflow">if</span> (isset($elements[<span class="stringliteral">&#39;#attached&#39;</span>])) {
<a name="l06023"></a>06023     <span class="keywordflow">foreach</span> ($elements[<span class="stringliteral">&#39;#attached&#39;</span>] as $key =&gt; $value) {
<a name="l06024"></a>06024       <span class="keywordflow">if</span> (!isset($attached[$key])) {
<a name="l06025"></a>06025         $attached[$key] = array();
<a name="l06026"></a>06026       }
<a name="l06027"></a>06027       $attached[$key] = array_merge($attached[$key], $value);
<a name="l06028"></a>06028     }
<a name="l06029"></a>06029   }
<a name="l06030"></a>06030   <span class="keywordflow">if</span> ($children = <a class="code" href="common_8inc_ad38ed83e102f4f8c6c47e416543969bc.html#ad38ed83e102f4f8c6c47e416543969bc" title="Identifies the children of an element array, optionally sorted by weight.">element_children</a>($elements)) {
<a name="l06031"></a>06031     <span class="keywordflow">foreach</span> ($children as $child) {
<a name="l06032"></a>06032       <a class="code" href="common_8inc_a3a65448a9382c58f1767b8b01f27dae6.html#a3a65448a9382c58f1767b8b01f27dae6" title="Collects #attached for an element and its children into a single array.">drupal_render_collect_attached</a>($elements[$child]);
<a name="l06033"></a>06033     }
<a name="l06034"></a>06034   }
<a name="l06035"></a>06035 
<a name="l06036"></a>06036   <span class="comment">// If this was the first call to the function, return all attached elements</span>
<a name="l06037"></a>06037   <span class="comment">// and reset the static cache.</span>
<a name="l06038"></a>06038   <span class="keywordflow">if</span> ($return) {
<a name="l06039"></a>06039     $return = $attached;
<a name="l06040"></a>06040     $attached = array();
<a name="l06041"></a>06041     <span class="keywordflow">return</span> $return;
<a name="l06042"></a>06042   }
<a name="l06043"></a>06043 }
<a name="l06044"></a>06044 
<a name="l06072"></a><a class="code" href="common_8inc_a7ad6a849e842a3c78e25cdd127e5ed0f.html#a7ad6a849e842a3c78e25cdd127e5ed0f">06072</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a7ad6a849e842a3c78e25cdd127e5ed0f.html#a7ad6a849e842a3c78e25cdd127e5ed0f" title="Prepares an element for caching based on a query.">drupal_render_cache_by_query</a>($query, $function, $expire = <a class="code" href="bootstrap_8inc_a1f2558e91eb9f33d14168bb8dfd99690.html#a1f2558e91eb9f33d14168bb8dfd99690" title="Indicates that the item should be removed at the next general cache wipe.">CACHE_TEMPORARY</a>, $granularity = NULL) {
<a name="l06073"></a>06073   $cache_keys = array_merge(array($function), <a class="code" href="common_8inc_ae2cdc2f17d6e9fe1bbc162b40e94bd5d.html#ae2cdc2f17d6e9fe1bbc162b40e94bd5d" title="Returns cache ID parts for building a cache ID.">drupal_render_cid_parts</a>($granularity));
<a name="l06074"></a>06074   $query-&gt;preExecute();
<a name="l06075"></a>06075   $cache_keys[] = hash(<span class="stringliteral">&#39;sha256&#39;</span>, serialize(array((<span class="keywordtype">string</span>) $query, $query-&gt;getArguments())));
<a name="l06076"></a>06076   <span class="keywordflow">return</span> array(
<a name="l06077"></a>06077     <span class="stringliteral">&#39;#query&#39;</span> =&gt; $query,
<a name="l06078"></a>06078     <span class="stringliteral">&#39;#pre_render&#39;</span> =&gt; array($function . <span class="stringliteral">&#39;_pre_render&#39;</span>),
<a name="l06079"></a>06079     <span class="stringliteral">&#39;#cache&#39;</span> =&gt; array(
<a name="l06080"></a>06080       <span class="stringliteral">&#39;keys&#39;</span> =&gt; $cache_keys,
<a name="l06081"></a>06081       <span class="stringliteral">&#39;expire&#39;</span> =&gt; $expire,
<a name="l06082"></a>06082     ),
<a name="l06083"></a>06083   );
<a name="l06084"></a>06084 }
<a name="l06085"></a>06085 
<a name="l06102"></a><a class="code" href="common_8inc_ae2cdc2f17d6e9fe1bbc162b40e94bd5d.html#ae2cdc2f17d6e9fe1bbc162b40e94bd5d">06102</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ae2cdc2f17d6e9fe1bbc162b40e94bd5d.html#ae2cdc2f17d6e9fe1bbc162b40e94bd5d" title="Returns cache ID parts for building a cache ID.">drupal_render_cid_parts</a>($granularity = NULL) {
<a name="l06103"></a>06103   global $theme, $base_root, $user;
<a name="l06104"></a>06104 
<a name="l06105"></a>06105   $cid_parts[] = $theme;
<a name="l06106"></a>06106   <span class="comment">// If Locale is enabled but we have only one language we do not need it as cid</span>
<a name="l06107"></a>06107   <span class="comment">// part.</span>
<a name="l06108"></a>06108   <span class="keywordflow">if</span> (<a class="code" href="bootstrap_8inc_ae1a2f0f465079ac3f1767b8c14553582.html#ae1a2f0f465079ac3f1767b8c14553582" title="Returns TRUE if there is more than one language enabled.">drupal_multilingual</a>()) {
<a name="l06109"></a>06109     <span class="keywordflow">foreach</span> (<a class="code" href="language_8inc_aa05284e85de23a8a8ab54adbd8548cb4.html#aa05284e85de23a8a8ab54adbd8548cb4" title="Return only the configurable language types.">language_types_configurable</a>() as $language_type) {
<a name="l06110"></a>06110       $cid_parts[] = $GLOBALS[$language_type]-&gt;language;
<a name="l06111"></a>06111     }
<a name="l06112"></a>06112   }
<a name="l06113"></a>06113 
<a name="l06114"></a>06114   <span class="keywordflow">if</span> (!empty($granularity)) {
<a name="l06115"></a>06115     <span class="comment">// &#39;PER_ROLE&#39; and &#39;PER_USER&#39; are mutually exclusive. &#39;PER_USER&#39; can be a</span>
<a name="l06116"></a>06116     <span class="comment">// resource drag for sites with many users, so when a module is being</span>
<a name="l06117"></a>06117     <span class="comment">// equivocal, we favor the less expensive &#39;PER_ROLE&#39; pattern.</span>
<a name="l06118"></a>06118     <span class="keywordflow">if</span> ($granularity &amp; <a class="code" href="common_8inc_a43d498e9607c4cdeb88d89341e0b3c3c.html#a43d498e9607c4cdeb88d89341e0b3c3c" title="The block or element can change depending on the user&#39;s roles.">DRUPAL_CACHE_PER_ROLE</a>) {
<a name="l06119"></a>06119       $cid_parts[] = <span class="stringliteral">&#39;r.&#39;</span> . implode(<span class="charliteral">&#39;,&#39;</span>, array_keys($user-&gt;roles));
<a name="l06120"></a>06120     }
<a name="l06121"></a>06121     elseif ($granularity &amp; <a class="code" href="common_8inc_aa50d399158badf0cda6ecbc3ff6707e9.html#aa50d399158badf0cda6ecbc3ff6707e9" title="The block or element can change depending on the user.">DRUPAL_CACHE_PER_USER</a>) {
<a name="l06122"></a>06122       $cid_parts[] = <span class="stringliteral">&quot;u.$user-&gt;uid&quot;</span>;
<a name="l06123"></a>06123     }
<a name="l06124"></a>06124 
<a name="l06125"></a>06125     <span class="keywordflow">if</span> ($granularity &amp; <a class="code" href="common_8inc_af5ec7d2a686e7bf3be4cb308bdbe81cc.html#af5ec7d2a686e7bf3be4cb308bdbe81cc" title="The block or element can change depending on the page being viewed.">DRUPAL_CACHE_PER_PAGE</a>) {
<a name="l06126"></a>06126       $cid_parts[] = $base_root . <a class="code" href="bootstrap_8inc_a80b52d5331d840440b5e3dfe82dd7ea2.html#a80b52d5331d840440b5e3dfe82dd7ea2" title="Returns the equivalent of Apache&#39;s $_SERVER[&#39;REQUEST_URI&#39;] variable.">request_uri</a>();
<a name="l06127"></a>06127     }
<a name="l06128"></a>06128   }
<a name="l06129"></a>06129 
<a name="l06130"></a>06130   <span class="keywordflow">return</span> $cid_parts;
<a name="l06131"></a>06131 }
<a name="l06132"></a>06132 
<a name="l06146"></a><a class="code" href="common_8inc_a28d419376079fb2c1f790d4af72451ec.html#a28d419376079fb2c1f790d4af72451ec">06146</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a28d419376079fb2c1f790d4af72451ec.html#a28d419376079fb2c1f790d4af72451ec" title="Creates the cache ID for a renderable element.">drupal_render_cid_create</a>($elements) {
<a name="l06147"></a>06147   <span class="keywordflow">if</span> (isset($elements[<span class="stringliteral">&#39;#cache&#39;</span>][<span class="stringliteral">&#39;cid&#39;</span>])) {
<a name="l06148"></a>06148     <span class="keywordflow">return</span> $elements[<span class="stringliteral">&#39;#cache&#39;</span>][<span class="stringliteral">&#39;cid&#39;</span>];
<a name="l06149"></a>06149   }
<a name="l06150"></a>06150   elseif (isset($elements[<span class="stringliteral">&#39;#cache&#39;</span>][<span class="stringliteral">&#39;keys&#39;</span>])) {
<a name="l06151"></a>06151     $granularity = isset($elements[<span class="stringliteral">&#39;#cache&#39;</span>][<span class="stringliteral">&#39;granularity&#39;</span>]) ? $elements[<span class="stringliteral">&#39;#cache&#39;</span>][<span class="stringliteral">&#39;granularity&#39;</span>] : NULL;
<a name="l06152"></a>06152     <span class="comment">// Merge in additional cache ID parts based provided by drupal_render_cid_parts().</span>
<a name="l06153"></a>06153     $cid_parts = array_merge($elements[<span class="stringliteral">&#39;#cache&#39;</span>][<span class="stringliteral">&#39;keys&#39;</span>], <a class="code" href="common_8inc_ae2cdc2f17d6e9fe1bbc162b40e94bd5d.html#ae2cdc2f17d6e9fe1bbc162b40e94bd5d" title="Returns cache ID parts for building a cache ID.">drupal_render_cid_parts</a>($granularity));
<a name="l06154"></a>06154     <span class="keywordflow">return</span> implode(<span class="charliteral">&#39;:&#39;</span>, $cid_parts);
<a name="l06155"></a>06155   }
<a name="l06156"></a>06156   <span class="keywordflow">return</span> FALSE;
<a name="l06157"></a>06157 }
<a name="l06158"></a>06158 
<a name="l06162"></a><a class="code" href="common_8inc_a61f0cc62072ab44aa349478fb7219c74.html#a61f0cc62072ab44aa349478fb7219c74">06162</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a61f0cc62072ab44aa349478fb7219c74.html#a61f0cc62072ab44aa349478fb7219c74" title="Function used by uasort to sort structured arrays by weight.">element_sort</a>($a, $b) {
<a name="l06163"></a>06163   $a_weight = (is_array($a) &amp;&amp; isset($a[<span class="stringliteral">&#39;#weight&#39;</span>])) ? $a[<span class="stringliteral">&#39;#weight&#39;</span>] : 0;
<a name="l06164"></a>06164   $b_weight = (is_array($b) &amp;&amp; isset($b[<span class="stringliteral">&#39;#weight&#39;</span>])) ? $b[<span class="stringliteral">&#39;#weight&#39;</span>] : 0;
<a name="l06165"></a>06165   <span class="keywordflow">if</span> ($a_weight == $b_weight) {
<a name="l06166"></a>06166     <span class="keywordflow">return</span> 0;
<a name="l06167"></a>06167   }
<a name="l06168"></a>06168   <span class="keywordflow">return</span> ($a_weight &lt; $b_weight) ? -1 : 1;
<a name="l06169"></a>06169 }
<a name="l06170"></a>06170 
<a name="l06174"></a><a class="code" href="common_8inc_af8b5e243059cba2c266cad6c94712190.html#af8b5e243059cba2c266cad6c94712190">06174</a> <span class="keyword">function</span> <a class="code" href="common_8inc_af8b5e243059cba2c266cad6c94712190.html#af8b5e243059cba2c266cad6c94712190" title="Array sorting callback; sorts elements by title.">element_sort_by_title</a>($a, $b) {
<a name="l06175"></a>06175   $a_title = (is_array($a) &amp;&amp; isset($a[<span class="stringliteral">&#39;#title&#39;</span>])) ? $a[<span class="stringliteral">&#39;#title&#39;</span>] : <span class="stringliteral">&#39;&#39;</span>;
<a name="l06176"></a>06176   $b_title = (is_array($b) &amp;&amp; isset($b[<span class="stringliteral">&#39;#title&#39;</span>])) ? $b[<span class="stringliteral">&#39;#title&#39;</span>] : <span class="stringliteral">&#39;&#39;</span>;
<a name="l06177"></a>06177   <span class="keywordflow">return</span> strnatcasecmp($a_title, $b_title);
<a name="l06178"></a>06178 }
<a name="l06179"></a>06179 
<a name="l06186"></a><a class="code" href="common_8inc_a5745b4e27c2946a902d49c0923f46739.html#a5745b4e27c2946a902d49c0923f46739">06186</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a5745b4e27c2946a902d49c0923f46739.html#a5745b4e27c2946a902d49c0923f46739" title="Retrieves the default properties for the defined element type.">element_info</a>($type) {
<a name="l06187"></a>06187   <span class="comment">// Use the advanced drupal_static() pattern, since this is called very often.</span>
<a name="l06188"></a>06188   <span class="keyword">static</span> $drupal_static_fast;
<a name="l06189"></a>06189   <span class="keywordflow">if</span> (!isset($drupal_static_fast)) {
<a name="l06190"></a>06190     $drupal_static_fast[<span class="stringliteral">&#39;cache&#39;</span>] = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__);
<a name="l06191"></a>06191   }
<a name="l06192"></a>06192   $cache = &amp;$drupal_static_fast[<span class="stringliteral">&#39;cache&#39;</span>];
<a name="l06193"></a>06193 
<a name="l06194"></a>06194   <span class="keywordflow">if</span> (!isset($cache)) {
<a name="l06195"></a>06195     $cache = <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;element_info&#39;</span>);
<a name="l06196"></a>06196     <span class="keywordflow">foreach</span> ($cache as $element_type =&gt; $info) {
<a name="l06197"></a>06197       $cache[$element_type][<span class="stringliteral">&#39;#type&#39;</span>] = $element_type;
<a name="l06198"></a>06198     }
<a name="l06199"></a>06199     <span class="comment">// Allow modules to alter the element type defaults.</span>
<a name="l06200"></a>06200     <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;element_info&#39;</span>, $cache);
<a name="l06201"></a>06201   }
<a name="l06202"></a>06202 
<a name="l06203"></a>06203   <span class="keywordflow">return</span> isset($cache[$type]) ? $cache[$type] : array();
<a name="l06204"></a>06204 }
<a name="l06205"></a>06205 
<a name="l06217"></a><a class="code" href="common_8inc_a0fbfab66764cb42fdd2f76609c91f5e7.html#a0fbfab66764cb42fdd2f76609c91f5e7">06217</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a0fbfab66764cb42fdd2f76609c91f5e7.html#a0fbfab66764cb42fdd2f76609c91f5e7" title="Retrieves a single property for the defined element type.">element_info_property</a>($type, $property_name, $default = NULL) {
<a name="l06218"></a>06218   <span class="keywordflow">return</span> (($info = <a class="code" href="common_8inc_a5745b4e27c2946a902d49c0923f46739.html#a5745b4e27c2946a902d49c0923f46739" title="Retrieves the default properties for the defined element type.">element_info</a>($type)) &amp;&amp; array_key_exists($property_name, $info)) ? $info[$property_name] : $default;
<a name="l06219"></a>06219 }
<a name="l06220"></a>06220 
<a name="l06236"></a><a class="code" href="common_8inc_ab998a16150fa137f79c86d197e809fb8.html#ab998a16150fa137f79c86d197e809fb8">06236</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ab998a16150fa137f79c86d197e809fb8.html#ab998a16150fa137f79c86d197e809fb8" title="Sorts a structured array by the &#39;weight&#39; element.">drupal_sort_weight</a>($a, $b) {
<a name="l06237"></a>06237   $a_weight = (is_array($a) &amp;&amp; isset($a[<span class="stringliteral">&#39;weight&#39;</span>])) ? $a[<span class="stringliteral">&#39;weight&#39;</span>] : 0;
<a name="l06238"></a>06238   $b_weight = (is_array($b) &amp;&amp; isset($b[<span class="stringliteral">&#39;weight&#39;</span>])) ? $b[<span class="stringliteral">&#39;weight&#39;</span>] : 0;
<a name="l06239"></a>06239   <span class="keywordflow">if</span> ($a_weight == $b_weight) {
<a name="l06240"></a>06240     <span class="keywordflow">return</span> 0;
<a name="l06241"></a>06241   }
<a name="l06242"></a>06242   <span class="keywordflow">return</span> ($a_weight &lt; $b_weight) ? -1 : 1;
<a name="l06243"></a>06243 }
<a name="l06244"></a>06244 
<a name="l06248"></a><a class="code" href="common_8inc_a3978e07c67adb7db3b9728c54d1ef67b.html#a3978e07c67adb7db3b9728c54d1ef67b">06248</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a3978e07c67adb7db3b9728c54d1ef67b.html#a3978e07c67adb7db3b9728c54d1ef67b" title="Array sorting callback; sorts elements by &#39;title&#39; key.">drupal_sort_title</a>($a, $b) {
<a name="l06249"></a>06249   <span class="keywordflow">if</span> (!isset($b[<span class="stringliteral">&#39;title&#39;</span>])) {
<a name="l06250"></a>06250     <span class="keywordflow">return</span> -1;
<a name="l06251"></a>06251   }
<a name="l06252"></a>06252   <span class="keywordflow">if</span> (!isset($a[<span class="stringliteral">&#39;title&#39;</span>])) {
<a name="l06253"></a>06253     <span class="keywordflow">return</span> 1;
<a name="l06254"></a>06254   }
<a name="l06255"></a>06255   <span class="keywordflow">return</span> strcasecmp($a[<span class="stringliteral">&#39;title&#39;</span>], $b[<span class="stringliteral">&#39;title&#39;</span>]);
<a name="l06256"></a>06256 }
<a name="l06257"></a>06257 
<a name="l06261"></a><a class="code" href="common_8inc_a7a93c74e138f24e5f7e672972644f1c3.html#a7a93c74e138f24e5f7e672972644f1c3">06261</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a7a93c74e138f24e5f7e672972644f1c3.html#a7a93c74e138f24e5f7e672972644f1c3" title="Checks if the key is a property.">element_property</a>($key) {
<a name="l06262"></a>06262   <span class="keywordflow">return</span> $key[0] == <span class="charliteral">&#39;#&#39;</span>;
<a name="l06263"></a>06263 }
<a name="l06264"></a>06264 
<a name="l06268"></a><a class="code" href="common_8inc_a4ae6d339b27757556fe914f9d78d91e5.html#a4ae6d339b27757556fe914f9d78d91e5">06268</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a4ae6d339b27757556fe914f9d78d91e5.html#a4ae6d339b27757556fe914f9d78d91e5" title="Gets properties of a structured array element (keys beginning with &#39;#&#39;).">element_properties</a>($element) {
<a name="l06269"></a>06269   <span class="keywordflow">return</span> array_filter(array_keys((array) $element), <span class="stringliteral">&#39;element_property&#39;</span>);
<a name="l06270"></a>06270 }
<a name="l06271"></a>06271 
<a name="l06275"></a><a class="code" href="common_8inc_a3063341f48382cc5ecce25eb1eaa7a0d.html#a3063341f48382cc5ecce25eb1eaa7a0d">06275</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a3063341f48382cc5ecce25eb1eaa7a0d.html#a3063341f48382cc5ecce25eb1eaa7a0d" title="Checks if the key is a child.">element_child</a>($key) {
<a name="l06276"></a>06276   <span class="keywordflow">return</span> !isset($key[0]) || $key[0] != <span class="charliteral">&#39;#&#39;</span>;
<a name="l06277"></a>06277 }
<a name="l06278"></a>06278 
<a name="l06293"></a><a class="code" href="common_8inc_ad38ed83e102f4f8c6c47e416543969bc.html#ad38ed83e102f4f8c6c47e416543969bc">06293</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ad38ed83e102f4f8c6c47e416543969bc.html#ad38ed83e102f4f8c6c47e416543969bc" title="Identifies the children of an element array, optionally sorted by weight.">element_children</a>(&amp;$elements, $sort = FALSE) {
<a name="l06294"></a>06294   <span class="comment">// Do not attempt to sort elements which have already been sorted.</span>
<a name="l06295"></a>06295   $sort = isset($elements[<span class="stringliteral">&#39;#sorted&#39;</span>]) ? !$elements[<span class="stringliteral">&#39;#sorted&#39;</span>] : $sort;
<a name="l06296"></a>06296 
<a name="l06297"></a>06297   <span class="comment">// Filter out properties from the element, leaving only children.</span>
<a name="l06298"></a>06298   $children = array();
<a name="l06299"></a>06299   $sortable = FALSE;
<a name="l06300"></a>06300   <span class="keywordflow">foreach</span> ($elements as $key =&gt; $value) {
<a name="l06301"></a>06301     <span class="keywordflow">if</span> ($key === <span class="stringliteral">&#39;&#39;</span> || $key[0] !== <span class="charliteral">&#39;#&#39;</span>) {
<a name="l06302"></a>06302       $children[$key] = $value;
<a name="l06303"></a>06303       <span class="keywordflow">if</span> (is_array($value) &amp;&amp; isset($value[<span class="stringliteral">&#39;#weight&#39;</span>])) {
<a name="l06304"></a>06304         $sortable = TRUE;
<a name="l06305"></a>06305       }
<a name="l06306"></a>06306     }
<a name="l06307"></a>06307   }
<a name="l06308"></a>06308   <span class="comment">// Sort the children if necessary.</span>
<a name="l06309"></a>06309   <span class="keywordflow">if</span> ($sort &amp;&amp; $sortable) {
<a name="l06310"></a>06310     uasort($children, <span class="stringliteral">&#39;element_sort&#39;</span>);
<a name="l06311"></a>06311     <span class="comment">// Put the sorted children back into $elements in the correct order, to</span>
<a name="l06312"></a>06312     <span class="comment">// preserve sorting if the same element is passed through</span>
<a name="l06313"></a>06313     <span class="comment">// element_children() twice.</span>
<a name="l06314"></a>06314     <span class="keywordflow">foreach</span> ($children as $key =&gt; $child) {
<a name="l06315"></a>06315       unset($elements[$key]);
<a name="l06316"></a>06316       $elements[$key] = $child;
<a name="l06317"></a>06317     }
<a name="l06318"></a>06318     $elements[<span class="stringliteral">&#39;#sorted&#39;</span>] = TRUE;
<a name="l06319"></a>06319   }
<a name="l06320"></a>06320 
<a name="l06321"></a>06321   <span class="keywordflow">return</span> array_keys($children);
<a name="l06322"></a>06322 }
<a name="l06323"></a>06323 
<a name="l06333"></a><a class="code" href="common_8inc_a16b95f134528bd21d59f2a9ece2b7d2f.html#a16b95f134528bd21d59f2a9ece2b7d2f">06333</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a16b95f134528bd21d59f2a9ece2b7d2f.html#a16b95f134528bd21d59f2a9ece2b7d2f" title="Returns the visible children of an element.">element_get_visible_children</a>(array $elements) {
<a name="l06334"></a>06334   $visible_children = array();
<a name="l06335"></a>06335 
<a name="l06336"></a>06336   <span class="keywordflow">foreach</span> (<a class="code" href="common_8inc_ad38ed83e102f4f8c6c47e416543969bc.html#ad38ed83e102f4f8c6c47e416543969bc" title="Identifies the children of an element array, optionally sorted by weight.">element_children</a>($elements) as $key) {
<a name="l06337"></a>06337     $child = $elements[$key];
<a name="l06338"></a>06338 
<a name="l06339"></a>06339     <span class="comment">// Skip un-accessible children.</span>
<a name="l06340"></a>06340     <span class="keywordflow">if</span> (isset($child[<span class="stringliteral">&#39;#access&#39;</span>]) &amp;&amp; !$child[<span class="stringliteral">&#39;#access&#39;</span>]) {
<a name="l06341"></a>06341       <span class="keywordflow">continue</span>;
<a name="l06342"></a>06342     }
<a name="l06343"></a>06343 
<a name="l06344"></a>06344     <span class="comment">// Skip value and hidden elements, since they are not rendered.</span>
<a name="l06345"></a>06345     <span class="keywordflow">if</span> (isset($child[<span class="stringliteral">&#39;#type&#39;</span>]) &amp;&amp; in_array($child[<span class="stringliteral">&#39;#type&#39;</span>], array(<span class="stringliteral">&#39;value&#39;</span>, <span class="stringliteral">&#39;hidden&#39;</span>))) {
<a name="l06346"></a>06346       <span class="keywordflow">continue</span>;
<a name="l06347"></a>06347     }
<a name="l06348"></a>06348 
<a name="l06349"></a>06349     $visible_children[$key] = $child;
<a name="l06350"></a>06350   }
<a name="l06351"></a>06351 
<a name="l06352"></a>06352   <span class="keywordflow">return</span> array_keys($visible_children);
<a name="l06353"></a>06353 }
<a name="l06354"></a>06354 
<a name="l06367"></a><a class="code" href="common_8inc_a117d5915f8fe2b93e65d662bcf69cba5.html#a117d5915f8fe2b93e65d662bcf69cba5">06367</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a117d5915f8fe2b93e65d662bcf69cba5.html#a117d5915f8fe2b93e65d662bcf69cba5" title="Sets HTML attributes based on element properties.">element_set_attributes</a>(array &amp;$element, array $map) {
<a name="l06368"></a>06368   <span class="keywordflow">foreach</span> ($map as $property =&gt; $attribute) {
<a name="l06369"></a>06369     <span class="comment">// If the key is numeric, the attribute name needs to be taken over.</span>
<a name="l06370"></a>06370     <span class="keywordflow">if</span> (is_int($property)) {
<a name="l06371"></a>06371       $property = <span class="charliteral">&#39;#&#39;</span> . $attribute;
<a name="l06372"></a>06372     }
<a name="l06373"></a>06373     <span class="comment">// Do not overwrite already existing attributes.</span>
<a name="l06374"></a>06374     <span class="keywordflow">if</span> (isset($element[$property]) &amp;&amp; !isset($element[<span class="stringliteral">&#39;#attributes&#39;</span>][$attribute])) {
<a name="l06375"></a>06375       $element[<span class="stringliteral">&#39;#attributes&#39;</span>][$attribute] = $element[$property];
<a name="l06376"></a>06376     }
<a name="l06377"></a>06377   }
<a name="l06378"></a>06378 }
<a name="l06379"></a>06379 
<a name="l06440"></a><a class="code" href="common_8inc_a8a4f31053469df300ce2812a57992c5b.html#a8a4f31053469df300ce2812a57992c5b">06440</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a8a4f31053469df300ce2812a57992c5b.html#a8a4f31053469df300ce2812a57992c5b" title="Sets a value in a nested array with variable depth.">drupal_array_set_nested_value</a>(array &amp;$array, array $parents, $value, $force = FALSE) {
<a name="l06441"></a>06441   $ref = &amp;$array;
<a name="l06442"></a>06442   <span class="keywordflow">foreach</span> ($parents as $parent) {
<a name="l06443"></a>06443     <span class="comment">// PHP auto-creates container arrays and NULL entries without error if $ref</span>
<a name="l06444"></a>06444     <span class="comment">// is NULL, but throws an error if $ref is set, but not an array.</span>
<a name="l06445"></a>06445     <span class="keywordflow">if</span> ($force &amp;&amp; isset($ref) &amp;&amp; !is_array($ref)) {
<a name="l06446"></a>06446       $ref = array();
<a name="l06447"></a>06447     }
<a name="l06448"></a>06448     $ref = &amp;$ref[$parent];
<a name="l06449"></a>06449   }
<a name="l06450"></a>06450   $ref = $value;
<a name="l06451"></a>06451 }
<a name="l06452"></a>06452 
<a name="l06508"></a><a class="code" href="common_8inc_ab749143c8baa3aea4bae4ce125982d5f.html#ab749143c8baa3aea4bae4ce125982d5f">06508</a> <span class="keyword">function</span> &amp;<a class="code" href="common_8inc_ab749143c8baa3aea4bae4ce125982d5f.html#ab749143c8baa3aea4bae4ce125982d5f" title="Retrieves a value from a nested array with variable depth.">drupal_array_get_nested_value</a>(array &amp;$array, array $parents, &amp;$key_exists = NULL) {
<a name="l06509"></a>06509   $ref = &amp;$array;
<a name="l06510"></a>06510   <span class="keywordflow">foreach</span> ($parents as $parent) {
<a name="l06511"></a>06511     <span class="keywordflow">if</span> (is_array($ref) &amp;&amp; array_key_exists($parent, $ref)) {
<a name="l06512"></a>06512       $ref = &amp;$ref[$parent];
<a name="l06513"></a>06513     }
<a name="l06514"></a>06514     <span class="keywordflow">else</span> {
<a name="l06515"></a>06515       $key_exists = FALSE;
<a name="l06516"></a>06516       $null = NULL;
<a name="l06517"></a>06517       <span class="keywordflow">return</span> $null;
<a name="l06518"></a>06518     }
<a name="l06519"></a>06519   }
<a name="l06520"></a>06520   $key_exists = TRUE;
<a name="l06521"></a>06521   <span class="keywordflow">return</span> $ref;
<a name="l06522"></a>06522 }
<a name="l06523"></a>06523 
<a name="l06552"></a><a class="code" href="common_8inc_a362d9c34bb8625f88e640906d457c0b4.html#a362d9c34bb8625f88e640906d457c0b4">06552</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a362d9c34bb8625f88e640906d457c0b4.html#a362d9c34bb8625f88e640906d457c0b4" title="Determines whether a nested array contains the requested keys.">drupal_array_nested_key_exists</a>(array $array, array $parents) {
<a name="l06553"></a>06553   <span class="comment">// Although this function is similar to PHP&#39;s array_key_exists(), its</span>
<a name="l06554"></a>06554   <span class="comment">// arguments should be consistent with drupal_array_get_nested_value().</span>
<a name="l06555"></a>06555   $key_exists = NULL;
<a name="l06556"></a>06556   <a class="code" href="common_8inc_ab749143c8baa3aea4bae4ce125982d5f.html#ab749143c8baa3aea4bae4ce125982d5f" title="Retrieves a value from a nested array with variable depth.">drupal_array_get_nested_value</a>($array, $parents, $key_exists);
<a name="l06557"></a>06557   <span class="keywordflow">return</span> $key_exists;
<a name="l06558"></a>06558 }
<a name="l06559"></a>06559 
<a name="l06563"></a><a class="code" href="common_8inc_a1263ef82e0da5b85f8203783ed164872.html#a1263ef82e0da5b85f8203783ed164872">06563</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a1263ef82e0da5b85f8203783ed164872.html#a1263ef82e0da5b85f8203783ed164872" title="Provides theme registration for themes across .inc files.">drupal_common_theme</a>() {
<a name="l06564"></a>06564   <span class="keywordflow">return</span> array(
<a name="l06565"></a>06565     <span class="comment">// From theme.inc.</span>
<a name="l06566"></a>06566     <span class="stringliteral">&#39;html&#39;</span> =&gt; array(
<a name="l06567"></a>06567       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;page&#39;</span>,
<a name="l06568"></a>06568       <span class="stringliteral">&#39;template&#39;</span> =&gt; <span class="stringliteral">&#39;html&#39;</span>,
<a name="l06569"></a>06569     ),
<a name="l06570"></a>06570     <span class="stringliteral">&#39;page&#39;</span> =&gt; array(
<a name="l06571"></a>06571       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;page&#39;</span>,
<a name="l06572"></a>06572       <span class="stringliteral">&#39;template&#39;</span> =&gt; <span class="stringliteral">&#39;page&#39;</span>,
<a name="l06573"></a>06573     ),
<a name="l06574"></a>06574     <span class="stringliteral">&#39;region&#39;</span> =&gt; array(
<a name="l06575"></a>06575       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;elements&#39;</span>,
<a name="l06576"></a>06576       <span class="stringliteral">&#39;template&#39;</span> =&gt; <span class="stringliteral">&#39;region&#39;</span>,
<a name="l06577"></a>06577     ),
<a name="l06578"></a>06578     <span class="stringliteral">&#39;status_messages&#39;</span> =&gt; array(
<a name="l06579"></a>06579       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;display&#39;</span> =&gt; NULL),
<a name="l06580"></a>06580     ),
<a name="l06581"></a>06581     <span class="stringliteral">&#39;link&#39;</span> =&gt; array(
<a name="l06582"></a>06582       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;text&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;path&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;options&#39;</span> =&gt; array()),
<a name="l06583"></a>06583     ),
<a name="l06584"></a>06584     <span class="stringliteral">&#39;links&#39;</span> =&gt; array(
<a name="l06585"></a>06585       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;links&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;attributes&#39;</span> =&gt; array(<span class="stringliteral">&#39;class&#39;</span> =&gt; array(<span class="stringliteral">&#39;links&#39;</span>)), <span class="stringliteral">&#39;heading&#39;</span> =&gt; array()),
<a name="l06586"></a>06586     ),
<a name="l06587"></a>06587     <span class="stringliteral">&#39;image&#39;</span> =&gt; array(
<a name="l06588"></a>06588       <span class="comment">// HTML 4 and XHTML 1.0 always require an alt attribute. The HTML 5 draft</span>
<a name="l06589"></a>06589       <span class="comment">// allows the alt attribute to be omitted in some cases. Therefore,</span>
<a name="l06590"></a>06590       <span class="comment">// default the alt attribute to an empty string, but allow code calling</span>
<a name="l06591"></a>06591       <span class="comment">// theme(&#39;image&#39;) to pass explicit NULL for it to be omitted. Usually,</span>
<a name="l06592"></a>06592       <span class="comment">// neither omission nor an empty string satisfies accessibility</span>
<a name="l06593"></a>06593       <span class="comment">// requirements, so it is strongly encouraged for code calling</span>
<a name="l06594"></a>06594       <span class="comment">// theme(&#39;image&#39;) to pass a meaningful value for the alt variable.</span>
<a name="l06595"></a>06595       <span class="comment">// - http://www.w3.org/TR/REC-html40/struct/objects.html#h-13.8</span>
<a name="l06596"></a>06596       <span class="comment">// - http://www.w3.org/TR/xhtml1/dtds.html</span>
<a name="l06597"></a>06597       <span class="comment">// - http://dev.w3.org/html5/spec/Overview.html#alt</span>
<a name="l06598"></a>06598       <span class="comment">// The title attribute is optional in all cases, so it is omitted by</span>
<a name="l06599"></a>06599       <span class="comment">// default.</span>
<a name="l06600"></a>06600       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;path&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;width&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;height&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;alt&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;title&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;attributes&#39;</span> =&gt; array()),
<a name="l06601"></a>06601     ),
<a name="l06602"></a>06602     <span class="stringliteral">&#39;breadcrumb&#39;</span> =&gt; array(
<a name="l06603"></a>06603       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;breadcrumb&#39;</span> =&gt; NULL),
<a name="l06604"></a>06604     ),
<a name="l06605"></a>06605     <span class="stringliteral">&#39;help&#39;</span> =&gt; array(
<a name="l06606"></a>06606       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(),
<a name="l06607"></a>06607     ),
<a name="l06608"></a>06608     <span class="stringliteral">&#39;table&#39;</span> =&gt; array(
<a name="l06609"></a>06609       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;header&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;rows&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;attributes&#39;</span> =&gt; array(), <span class="stringliteral">&#39;caption&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;colgroups&#39;</span> =&gt; array(), <span class="stringliteral">&#39;sticky&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;empty&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>),
<a name="l06610"></a>06610     ),
<a name="l06611"></a>06611     <span class="stringliteral">&#39;tablesort_indicator&#39;</span> =&gt; array(
<a name="l06612"></a>06612       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;style&#39;</span> =&gt; NULL),
<a name="l06613"></a>06613     ),
<a name="l06614"></a>06614     <span class="stringliteral">&#39;mark&#39;</span> =&gt; array(
<a name="l06615"></a>06615       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <a class="code" href="group__content__flags_ga44d42cbfa50b553ad2439e19478d0d3d.html#ga44d42cbfa50b553ad2439e19478d0d3d" title="Mark content as being new.">MARK_NEW</a>),
<a name="l06616"></a>06616     ),
<a name="l06617"></a>06617     <span class="stringliteral">&#39;item_list&#39;</span> =&gt; array(
<a name="l06618"></a>06618       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;items&#39;</span> =&gt; array(), <span class="stringliteral">&#39;title&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;ul&#39;</span>, <span class="stringliteral">&#39;attributes&#39;</span> =&gt; array()),
<a name="l06619"></a>06619     ),
<a name="l06620"></a>06620     <span class="stringliteral">&#39;more_help_link&#39;</span> =&gt; array(
<a name="l06621"></a>06621       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;url&#39;</span> =&gt; NULL),
<a name="l06622"></a>06622     ),
<a name="l06623"></a>06623     <span class="stringliteral">&#39;feed_icon&#39;</span> =&gt; array(
<a name="l06624"></a>06624       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;url&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;title&#39;</span> =&gt; NULL),
<a name="l06625"></a>06625     ),
<a name="l06626"></a>06626     <span class="stringliteral">&#39;more_link&#39;</span> =&gt; array(
<a name="l06627"></a>06627       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;url&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;title&#39;</span> =&gt; NULL)
<a name="l06628"></a>06628     ),
<a name="l06629"></a>06629     <span class="stringliteral">&#39;username&#39;</span> =&gt; array(
<a name="l06630"></a>06630       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;account&#39;</span> =&gt; NULL),
<a name="l06631"></a>06631     ),
<a name="l06632"></a>06632     <span class="stringliteral">&#39;progress_bar&#39;</span> =&gt; array(
<a name="l06633"></a>06633       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;percent&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;message&#39;</span> =&gt; NULL),
<a name="l06634"></a>06634     ),
<a name="l06635"></a>06635     <span class="stringliteral">&#39;indentation&#39;</span> =&gt; array(
<a name="l06636"></a>06636       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;size&#39;</span> =&gt; 1),
<a name="l06637"></a>06637     ),
<a name="l06638"></a>06638     <span class="stringliteral">&#39;html_tag&#39;</span> =&gt; array(
<a name="l06639"></a>06639       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06640"></a>06640     ),
<a name="l06641"></a>06641     <span class="comment">// From theme.maintenance.inc.</span>
<a name="l06642"></a>06642     <span class="stringliteral">&#39;maintenance_page&#39;</span> =&gt; array(
<a name="l06643"></a>06643       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;content&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;show_messages&#39;</span> =&gt; TRUE),
<a name="l06644"></a>06644       <span class="stringliteral">&#39;template&#39;</span> =&gt; <span class="stringliteral">&#39;maintenance-page&#39;</span>,
<a name="l06645"></a>06645     ),
<a name="l06646"></a>06646     <span class="stringliteral">&#39;update_page&#39;</span> =&gt; array(
<a name="l06647"></a>06647       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;content&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;show_messages&#39;</span> =&gt; TRUE),
<a name="l06648"></a>06648     ),
<a name="l06649"></a>06649     <span class="stringliteral">&#39;install_page&#39;</span> =&gt; array(
<a name="l06650"></a>06650       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;content&#39;</span> =&gt; NULL),
<a name="l06651"></a>06651     ),
<a name="l06652"></a>06652     <span class="stringliteral">&#39;task_list&#39;</span> =&gt; array(
<a name="l06653"></a>06653       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;items&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;active&#39;</span> =&gt; NULL),
<a name="l06654"></a>06654     ),
<a name="l06655"></a>06655     <span class="stringliteral">&#39;authorize_message&#39;</span> =&gt; array(
<a name="l06656"></a>06656       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;message&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;success&#39;</span> =&gt; TRUE),
<a name="l06657"></a>06657     ),
<a name="l06658"></a>06658     <span class="stringliteral">&#39;authorize_report&#39;</span> =&gt; array(
<a name="l06659"></a>06659       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;messages&#39;</span> =&gt; array()),
<a name="l06660"></a>06660     ),
<a name="l06661"></a>06661     <span class="comment">// From pager.inc.</span>
<a name="l06662"></a>06662     <span class="stringliteral">&#39;pager&#39;</span> =&gt; array(
<a name="l06663"></a>06663       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;tags&#39;</span> =&gt; array(), <span class="stringliteral">&#39;element&#39;</span> =&gt; 0, <span class="stringliteral">&#39;parameters&#39;</span> =&gt; array(), <span class="stringliteral">&#39;quantity&#39;</span> =&gt; 9),
<a name="l06664"></a>06664     ),
<a name="l06665"></a>06665     <span class="stringliteral">&#39;pager_first&#39;</span> =&gt; array(
<a name="l06666"></a>06666       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;text&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;element&#39;</span> =&gt; 0, <span class="stringliteral">&#39;parameters&#39;</span> =&gt; array()),
<a name="l06667"></a>06667     ),
<a name="l06668"></a>06668     <span class="stringliteral">&#39;pager_previous&#39;</span> =&gt; array(
<a name="l06669"></a>06669       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;text&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;element&#39;</span> =&gt; 0, <span class="stringliteral">&#39;interval&#39;</span> =&gt; 1, <span class="stringliteral">&#39;parameters&#39;</span> =&gt; array()),
<a name="l06670"></a>06670     ),
<a name="l06671"></a>06671     <span class="stringliteral">&#39;pager_next&#39;</span> =&gt; array(
<a name="l06672"></a>06672       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;text&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;element&#39;</span> =&gt; 0, <span class="stringliteral">&#39;interval&#39;</span> =&gt; 1, <span class="stringliteral">&#39;parameters&#39;</span> =&gt; array()),
<a name="l06673"></a>06673     ),
<a name="l06674"></a>06674     <span class="stringliteral">&#39;pager_last&#39;</span> =&gt; array(
<a name="l06675"></a>06675       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;text&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;element&#39;</span> =&gt; 0, <span class="stringliteral">&#39;parameters&#39;</span> =&gt; array()),
<a name="l06676"></a>06676     ),
<a name="l06677"></a>06677     <span class="stringliteral">&#39;pager_link&#39;</span> =&gt; array(
<a name="l06678"></a>06678       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;text&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;page_new&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;element&#39;</span> =&gt; NULL, <span class="stringliteral">&#39;parameters&#39;</span> =&gt; array(), <span class="stringliteral">&#39;attributes&#39;</span> =&gt; array()),
<a name="l06679"></a>06679     ),
<a name="l06680"></a>06680     <span class="comment">// From menu.inc.</span>
<a name="l06681"></a>06681     <span class="stringliteral">&#39;menu_link&#39;</span> =&gt; array(
<a name="l06682"></a>06682       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06683"></a>06683     ),
<a name="l06684"></a>06684     <span class="stringliteral">&#39;menu_tree&#39;</span> =&gt; array(
<a name="l06685"></a>06685       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;tree&#39;</span>,
<a name="l06686"></a>06686     ),
<a name="l06687"></a>06687     <span class="stringliteral">&#39;menu_local_task&#39;</span> =&gt; array(
<a name="l06688"></a>06688       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06689"></a>06689     ),
<a name="l06690"></a>06690     <span class="stringliteral">&#39;menu_local_action&#39;</span> =&gt; array(
<a name="l06691"></a>06691       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06692"></a>06692     ),
<a name="l06693"></a>06693     <span class="stringliteral">&#39;menu_local_tasks&#39;</span> =&gt; array(
<a name="l06694"></a>06694       <span class="stringliteral">&#39;variables&#39;</span> =&gt; array(<span class="stringliteral">&#39;primary&#39;</span> =&gt; array(), <span class="stringliteral">&#39;secondary&#39;</span> =&gt; array()),
<a name="l06695"></a>06695     ),
<a name="l06696"></a>06696     <span class="comment">// From form.inc.</span>
<a name="l06697"></a>06697     <span class="stringliteral">&#39;select&#39;</span> =&gt; array(
<a name="l06698"></a>06698       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06699"></a>06699     ),
<a name="l06700"></a>06700     <span class="stringliteral">&#39;fieldset&#39;</span> =&gt; array(
<a name="l06701"></a>06701       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06702"></a>06702     ),
<a name="l06703"></a>06703     <span class="stringliteral">&#39;radio&#39;</span> =&gt; array(
<a name="l06704"></a>06704       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06705"></a>06705     ),
<a name="l06706"></a>06706     <span class="stringliteral">&#39;radios&#39;</span> =&gt; array(
<a name="l06707"></a>06707       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06708"></a>06708     ),
<a name="l06709"></a>06709     <span class="stringliteral">&#39;date&#39;</span> =&gt; array(
<a name="l06710"></a>06710       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06711"></a>06711     ),
<a name="l06712"></a>06712     <span class="stringliteral">&#39;exposed_filters&#39;</span> =&gt; array(
<a name="l06713"></a>06713       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;form&#39;</span>,
<a name="l06714"></a>06714     ),
<a name="l06715"></a>06715     <span class="stringliteral">&#39;checkbox&#39;</span> =&gt; array(
<a name="l06716"></a>06716       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06717"></a>06717     ),
<a name="l06718"></a>06718     <span class="stringliteral">&#39;checkboxes&#39;</span> =&gt; array(
<a name="l06719"></a>06719       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06720"></a>06720     ),
<a name="l06721"></a>06721     <span class="stringliteral">&#39;button&#39;</span> =&gt; array(
<a name="l06722"></a>06722       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06723"></a>06723     ),
<a name="l06724"></a>06724     <span class="stringliteral">&#39;image_button&#39;</span> =&gt; array(
<a name="l06725"></a>06725       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06726"></a>06726     ),
<a name="l06727"></a>06727     <span class="stringliteral">&#39;hidden&#39;</span> =&gt; array(
<a name="l06728"></a>06728       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06729"></a>06729     ),
<a name="l06730"></a>06730     <span class="stringliteral">&#39;textfield&#39;</span> =&gt; array(
<a name="l06731"></a>06731       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06732"></a>06732     ),
<a name="l06733"></a>06733     <span class="stringliteral">&#39;form&#39;</span> =&gt; array(
<a name="l06734"></a>06734       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06735"></a>06735     ),
<a name="l06736"></a>06736     <span class="stringliteral">&#39;textarea&#39;</span> =&gt; array(
<a name="l06737"></a>06737       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06738"></a>06738     ),
<a name="l06739"></a>06739     <span class="stringliteral">&#39;password&#39;</span> =&gt; array(
<a name="l06740"></a>06740       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06741"></a>06741     ),
<a name="l06742"></a>06742     <span class="stringliteral">&#39;file&#39;</span> =&gt; array(
<a name="l06743"></a>06743       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06744"></a>06744     ),
<a name="l06745"></a>06745     <span class="stringliteral">&#39;tableselect&#39;</span> =&gt; array(
<a name="l06746"></a>06746       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06747"></a>06747     ),
<a name="l06748"></a>06748     <span class="stringliteral">&#39;form_element&#39;</span> =&gt; array(
<a name="l06749"></a>06749       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06750"></a>06750     ),
<a name="l06751"></a>06751     <span class="stringliteral">&#39;form_required_marker&#39;</span> =&gt; array(
<a name="l06752"></a>06752       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06753"></a>06753     ),
<a name="l06754"></a>06754     <span class="stringliteral">&#39;form_element_label&#39;</span> =&gt; array(
<a name="l06755"></a>06755       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06756"></a>06756     ),
<a name="l06757"></a>06757     <span class="stringliteral">&#39;vertical_tabs&#39;</span> =&gt; array(
<a name="l06758"></a>06758       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06759"></a>06759     ),
<a name="l06760"></a>06760     <span class="stringliteral">&#39;container&#39;</span> =&gt; array(
<a name="l06761"></a>06761       <span class="stringliteral">&#39;render element&#39;</span> =&gt; <span class="stringliteral">&#39;element&#39;</span>,
<a name="l06762"></a>06762     ),
<a name="l06763"></a>06763   );
<a name="l06764"></a>06764 }
<a name="l06765"></a>06765 
<a name="l06781"></a><a class="code" href="group__schemaapi_ga9706b8d6ecdac10302d83bd50935a698.html#ga9706b8d6ecdac10302d83bd50935a698">06781</a> <span class="keyword">function</span> <a class="code" href="group__schemaapi_ga9706b8d6ecdac10302d83bd50935a698.html#ga9706b8d6ecdac10302d83bd50935a698" title="Creates all tables defined in a module&#39;s hook_schema().">drupal_install_schema</a>($module) {
<a name="l06782"></a>06782   $schema = <a class="code" href="group__schemaapi_gaecb0d63f03b96dd1426298804e091d3b.html#gaecb0d63f03b96dd1426298804e091d3b" title="Returns the unprocessed and unaltered version of a module&#39;s schema.">drupal_get_schema_unprocessed</a>($module);
<a name="l06783"></a>06783   <a class="code" href="group__schemaapi_gad4ce891e1e944b1d6eee7253448a0178.html#gad4ce891e1e944b1d6eee7253448a0178" title="Fills in required default values for table definitions from hook_schema().">_drupal_schema_initialize</a>($schema, $module, FALSE);
<a name="l06784"></a>06784 
<a name="l06785"></a>06785   <span class="keywordflow">foreach</span> ($schema as $name =&gt; $table) {
<a name="l06786"></a>06786     <a class="code" href="group__schemaapi_gaf3a8307693d6b28374665c72531b429f.html#gaf3a8307693d6b28374665c72531b429f" title="Creates a new table from a Drupal table definition.">db_create_table</a>($name, $table);
<a name="l06787"></a>06787   }
<a name="l06788"></a>06788 }
<a name="l06789"></a>06789 
<a name="l06805"></a><a class="code" href="group__schemaapi_ga0688b6627af9dc05f2618f81489c3db0.html#ga0688b6627af9dc05f2618f81489c3db0">06805</a> <span class="keyword">function</span> <a class="code" href="group__schemaapi_ga0688b6627af9dc05f2618f81489c3db0.html#ga0688b6627af9dc05f2618f81489c3db0" title="Removes all tables defined in a module&#39;s hook_schema().">drupal_uninstall_schema</a>($module) {
<a name="l06806"></a>06806   $schema = <a class="code" href="group__schemaapi_gaecb0d63f03b96dd1426298804e091d3b.html#gaecb0d63f03b96dd1426298804e091d3b" title="Returns the unprocessed and unaltered version of a module&#39;s schema.">drupal_get_schema_unprocessed</a>($module);
<a name="l06807"></a>06807   <a class="code" href="group__schemaapi_gad4ce891e1e944b1d6eee7253448a0178.html#gad4ce891e1e944b1d6eee7253448a0178" title="Fills in required default values for table definitions from hook_schema().">_drupal_schema_initialize</a>($schema, $module, FALSE);
<a name="l06808"></a>06808 
<a name="l06809"></a>06809   <span class="keywordflow">foreach</span> ($schema as $table) {
<a name="l06810"></a>06810     <span class="keywordflow">if</span> (<a class="code" href="group__schemaapi_ga78809300cee80db034832825aed55b70.html#ga78809300cee80db034832825aed55b70" title="Checks if a table exists.">db_table_exists</a>($table[<span class="stringliteral">&#39;name&#39;</span>])) {
<a name="l06811"></a>06811       <a class="code" href="group__schemaapi_ga5d744ae7a6fe2c9eaa1c7bd350a071d3.html#ga5d744ae7a6fe2c9eaa1c7bd350a071d3" title="Drops a table.">db_drop_table</a>($table[<span class="stringliteral">&#39;name&#39;</span>]);
<a name="l06812"></a>06812     }
<a name="l06813"></a>06813   }
<a name="l06814"></a>06814 }
<a name="l06815"></a>06815 
<a name="l06840"></a><a class="code" href="group__schemaapi_gaecb0d63f03b96dd1426298804e091d3b.html#gaecb0d63f03b96dd1426298804e091d3b">06840</a> <span class="keyword">function</span> <a class="code" href="group__schemaapi_gaecb0d63f03b96dd1426298804e091d3b.html#gaecb0d63f03b96dd1426298804e091d3b" title="Returns the unprocessed and unaltered version of a module&#39;s schema.">drupal_get_schema_unprocessed</a>($module, $table = NULL) {
<a name="l06841"></a>06841   <span class="comment">// Load the .install file to get hook_schema.</span>
<a name="l06842"></a>06842   <a class="code" href="module_8inc_a77a6101f363c066eafbe29b26af5bfd3.html#a77a6101f363c066eafbe29b26af5bfd3" title="Load a module&#39;s installation hooks.">module_load_install</a>($module);
<a name="l06843"></a>06843   $schema = <a class="code" href="group__hooks_ga7547905cff161d057f9e71088ec67f05.html#ga7547905cff161d057f9e71088ec67f05" title="Invoke a hook in a particular module.">module_invoke</a>($module, <span class="stringliteral">&#39;schema&#39;</span>);
<a name="l06844"></a>06844 
<a name="l06845"></a>06845   <span class="keywordflow">if</span> (isset($table) &amp;&amp; isset($schema[$table])) {
<a name="l06846"></a>06846     <span class="keywordflow">return</span> $schema[$table];
<a name="l06847"></a>06847   }
<a name="l06848"></a>06848   elseif (!empty($schema)) {
<a name="l06849"></a>06849     <span class="keywordflow">return</span> $schema;
<a name="l06850"></a>06850   }
<a name="l06851"></a>06851   <span class="keywordflow">return</span> array();
<a name="l06852"></a>06852 }
<a name="l06853"></a>06853 
<a name="l06867"></a><a class="code" href="group__schemaapi_gad4ce891e1e944b1d6eee7253448a0178.html#gad4ce891e1e944b1d6eee7253448a0178">06867</a> <span class="keyword">function</span> <a class="code" href="group__schemaapi_gad4ce891e1e944b1d6eee7253448a0178.html#gad4ce891e1e944b1d6eee7253448a0178" title="Fills in required default values for table definitions from hook_schema().">_drupal_schema_initialize</a>(&amp;$schema, $module, $remove_descriptions = TRUE) {
<a name="l06868"></a>06868   <span class="comment">// Set the name and module key for all tables.</span>
<a name="l06869"></a>06869   <span class="keywordflow">foreach</span> ($schema as $name =&gt; &amp;$table) {
<a name="l06870"></a>06870     <span class="keywordflow">if</span> (empty($table[<span class="stringliteral">&#39;module&#39;</span>])) {
<a name="l06871"></a>06871       $table[<span class="stringliteral">&#39;module&#39;</span>] = $module;
<a name="l06872"></a>06872     }
<a name="l06873"></a>06873     <span class="keywordflow">if</span> (!isset($table[<span class="stringliteral">&#39;name&#39;</span>])) {
<a name="l06874"></a>06874       $table[<span class="stringliteral">&#39;name&#39;</span>] = $name;
<a name="l06875"></a>06875     }
<a name="l06876"></a>06876     <span class="keywordflow">if</span> ($remove_descriptions) {
<a name="l06877"></a>06877       unset($table[<span class="stringliteral">&#39;description&#39;</span>]);
<a name="l06878"></a>06878       <span class="keywordflow">foreach</span> ($table[<span class="stringliteral">&#39;fields&#39;</span>] as &amp;$field) {
<a name="l06879"></a>06879         unset($field[<span class="stringliteral">&#39;description&#39;</span>]);
<a name="l06880"></a>06880       }
<a name="l06881"></a>06881     }
<a name="l06882"></a>06882   }
<a name="l06883"></a>06883 }
<a name="l06884"></a>06884 
<a name="l06897"></a><a class="code" href="group__schemaapi_gaacfcd6f676ee9062f0ba50a008a05443.html#gaacfcd6f676ee9062f0ba50a008a05443">06897</a> <span class="keyword">function</span> <a class="code" href="group__schemaapi_gaacfcd6f676ee9062f0ba50a008a05443.html#gaacfcd6f676ee9062f0ba50a008a05443" title="Retrieves a list of fields from a table schema.">drupal_schema_fields_sql</a>($table, $prefix = NULL) {
<a name="l06898"></a>06898   $schema = <a class="code" href="group__schemaapi_ga979670bd6bd2e34337ffc5f0810f2d71.html#ga979670bd6bd2e34337ffc5f0810f2d71" title="Gets the schema definition of a table, or the whole database schema.">drupal_get_schema</a>($table);
<a name="l06899"></a>06899   $fields = array_keys($schema[<span class="stringliteral">&#39;fields&#39;</span>]);
<a name="l06900"></a>06900   <span class="keywordflow">if</span> ($prefix) {
<a name="l06901"></a>06901     $columns = array();
<a name="l06902"></a>06902     <span class="keywordflow">foreach</span> ($fields as $field) {
<a name="l06903"></a>06903       $columns[] = <span class="stringliteral">&quot;$prefix.$field&quot;</span>;
<a name="l06904"></a>06904     }
<a name="l06905"></a>06905     <span class="keywordflow">return</span> $columns;
<a name="l06906"></a>06906   }
<a name="l06907"></a>06907   <span class="keywordflow">else</span> {
<a name="l06908"></a>06908     <span class="keywordflow">return</span> $fields;
<a name="l06909"></a>06909   }
<a name="l06910"></a>06910 }
<a name="l06911"></a>06911 
<a name="l06939"></a><a class="code" href="group__schemaapi_ga96f707de751a962bf21b6cb0cb4f2ae6.html#ga96f707de751a962bf21b6cb0cb4f2ae6">06939</a> <span class="keyword">function</span> <a class="code" href="group__schemaapi_ga96f707de751a962bf21b6cb0cb4f2ae6.html#ga96f707de751a962bf21b6cb0cb4f2ae6" title="Saves (inserts or updates) a record to the database based upon the schema.">drupal_write_record</a>($table, &amp;$record, $primary_keys = array()) {
<a name="l06940"></a>06940   <span class="comment">// Standardize $primary_keys to an array.</span>
<a name="l06941"></a>06941   <span class="keywordflow">if</span> (is_string($primary_keys)) {
<a name="l06942"></a>06942     $primary_keys = array($primary_keys);
<a name="l06943"></a>06943   }
<a name="l06944"></a>06944 
<a name="l06945"></a>06945   $schema = <a class="code" href="group__schemaapi_ga979670bd6bd2e34337ffc5f0810f2d71.html#ga979670bd6bd2e34337ffc5f0810f2d71" title="Gets the schema definition of a table, or the whole database schema.">drupal_get_schema</a>($table);
<a name="l06946"></a>06946   <span class="keywordflow">if</span> (empty($schema)) {
<a name="l06947"></a>06947     <span class="keywordflow">return</span> FALSE;
<a name="l06948"></a>06948   }
<a name="l06949"></a>06949 
<a name="l06950"></a>06950   $object = (object) $record;
<a name="l06951"></a>06951   $fields = array();
<a name="l06952"></a>06952 
<a name="l06953"></a>06953   <span class="comment">// Go through the schema to determine fields to write.</span>
<a name="l06954"></a>06954   <span class="keywordflow">foreach</span> ($schema[<span class="stringliteral">&#39;fields&#39;</span>] as $field =&gt; $info) {
<a name="l06955"></a>06955     <span class="keywordflow">if</span> ($info[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;serial&#39;</span>) {
<a name="l06956"></a>06956       <span class="comment">// Skip serial types if we are updating.</span>
<a name="l06957"></a>06957       <span class="keywordflow">if</span> (!empty($primary_keys)) {
<a name="l06958"></a>06958         <span class="keywordflow">continue</span>;
<a name="l06959"></a>06959       }
<a name="l06960"></a>06960       <span class="comment">// Track serial field so we can helpfully populate them after the query.</span>
<a name="l06961"></a>06961       <span class="comment">// NOTE: Each table should come with one serial field only.</span>
<a name="l06962"></a>06962       $serial = $field;
<a name="l06963"></a>06963     }
<a name="l06964"></a>06964 
<a name="l06965"></a>06965     <span class="comment">// Skip field if it is in $primary_keys as it is unnecessary to update a</span>
<a name="l06966"></a>06966     <span class="comment">// field to the value it is already set to.</span>
<a name="l06967"></a>06967     <span class="keywordflow">if</span> (in_array($field, $primary_keys)) {
<a name="l06968"></a>06968       <span class="keywordflow">continue</span>;
<a name="l06969"></a>06969     }
<a name="l06970"></a>06970 
<a name="l06971"></a>06971     <span class="keywordflow">if</span> (!property_exists($object, $field)) {
<a name="l06972"></a>06972       <span class="comment">// Skip fields that are not provided, default values are already known</span>
<a name="l06973"></a>06973       <span class="comment">// by the database.</span>
<a name="l06974"></a>06974       <span class="keywordflow">continue</span>;
<a name="l06975"></a>06975     }
<a name="l06976"></a>06976 
<a name="l06977"></a>06977     <span class="comment">// Build array of fields to update or insert.</span>
<a name="l06978"></a>06978     <span class="keywordflow">if</span> (empty($info[<span class="stringliteral">&#39;serialize&#39;</span>])) {
<a name="l06979"></a>06979       $fields[$field] = $object-&gt;$field;
<a name="l06980"></a>06980     }
<a name="l06981"></a>06981     <span class="keywordflow">else</span> {
<a name="l06982"></a>06982       $fields[$field] = serialize($object-&gt;$field);
<a name="l06983"></a>06983     }
<a name="l06984"></a>06984 
<a name="l06985"></a>06985     <span class="comment">// Type cast to proper datatype, except when the value is NULL and the</span>
<a name="l06986"></a>06986     <span class="comment">// column allows this.</span>
<a name="l06987"></a>06987     <span class="comment">//</span>
<a name="l06988"></a>06988     <span class="comment">// MySQL PDO silently casts e.g. FALSE and &#39;&#39; to 0 when inserting the value</span>
<a name="l06989"></a>06989     <span class="comment">// into an integer column, but PostgreSQL PDO does not. Also type cast NULL</span>
<a name="l06990"></a>06990     <span class="comment">// when the column does not allow this.</span>
<a name="l06991"></a>06991     <span class="keywordflow">if</span> (isset($object-&gt;$field) || !empty($info[<span class="stringliteral">&#39;not null&#39;</span>])) {
<a name="l06992"></a>06992       <span class="keywordflow">if</span> ($info[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;int&#39;</span> || $info[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;serial&#39;</span>) {
<a name="l06993"></a>06993         $fields[$field] = (int) $fields[$field];
<a name="l06994"></a>06994       }
<a name="l06995"></a>06995       elseif ($info[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;float&#39;</span>) {
<a name="l06996"></a>06996         $fields[$field] = (float) $fields[$field];
<a name="l06997"></a>06997       }
<a name="l06998"></a>06998       <span class="keywordflow">else</span> {
<a name="l06999"></a>06999         $fields[$field] = (string) $fields[$field];
<a name="l07000"></a>07000       }
<a name="l07001"></a>07001     }
<a name="l07002"></a>07002   }
<a name="l07003"></a>07003 
<a name="l07004"></a>07004   <span class="keywordflow">if</span> (empty($fields)) {
<a name="l07005"></a>07005     <span class="keywordflow">return</span>;
<a name="l07006"></a>07006   }
<a name="l07007"></a>07007 
<a name="l07008"></a>07008   <span class="comment">// Build the SQL.</span>
<a name="l07009"></a>07009   <span class="keywordflow">if</span> (empty($primary_keys)) {
<a name="l07010"></a>07010     <span class="comment">// We are doing an insert.</span>
<a name="l07011"></a>07011     $options = array(<span class="stringliteral">&#39;return&#39;</span> =&gt; <a class="code" href="classDatabase_a56dab08fbf70f81aaf6f55a71922f4ef.html#a56dab08fbf70f81aaf6f55a71922f4ef" title="Flag to indicate a query call should return the &quot;last insert id&quot;.">Database::RETURN_INSERT_ID</a>);
<a name="l07012"></a>07012     <span class="keywordflow">if</span> (isset($serial) &amp;&amp; isset($fields[$serial])) {
<a name="l07013"></a>07013       <span class="comment">// If the serial column has been explicitly set with an ID, then we don&#39;t</span>
<a name="l07014"></a>07014       <span class="comment">// require the database to return the last insert id.</span>
<a name="l07015"></a>07015       <span class="keywordflow">if</span> ($fields[$serial]) {
<a name="l07016"></a>07016         $options[<span class="stringliteral">&#39;return&#39;</span>] = <a class="code" href="classDatabase_a557879c7732a573ed395f9196afeb898.html#a557879c7732a573ed395f9196afeb898" title="Flag to indicate a query call should return the number of affected rows.">Database::RETURN_AFFECTED</a>;
<a name="l07017"></a>07017       }
<a name="l07018"></a>07018       <span class="comment">// If a serial column does exist with no value (i.e. 0) then remove it as</span>
<a name="l07019"></a>07019       <span class="comment">// the database will insert the correct value for us.</span>
<a name="l07020"></a>07020       <span class="keywordflow">else</span> {
<a name="l07021"></a>07021         unset($fields[$serial]);
<a name="l07022"></a>07022       }
<a name="l07023"></a>07023     }
<a name="l07024"></a>07024     $query = <a class="code" href="group__database_gaadfbffaf30ff5eb14f1bd88619351345.html#gaadfbffaf30ff5eb14f1bd88619351345" title="Returns a new InsertQuery object for the active database.">db_insert</a>($table, $options)-&gt;fields($fields);
<a name="l07025"></a>07025     $return = <a class="code" href="common_8inc_a7d54df6ca81759341e08f451d4f6c8cd.html#a7d54df6ca81759341e08f451d4f6c8cd" title="Return status for saving which involved creating a new item.">SAVED_NEW</a>;
<a name="l07026"></a>07026   }
<a name="l07027"></a>07027   <span class="keywordflow">else</span> {
<a name="l07028"></a>07028     $query = <a class="code" href="group__database_ga40967197ee5d6a23a5c5a77e627067fe.html#ga40967197ee5d6a23a5c5a77e627067fe" title="Returns a new UpdateQuery object for the active database.">db_update</a>($table)-&gt;fields($fields);
<a name="l07029"></a>07029     <span class="keywordflow">foreach</span> ($primary_keys as $key) {
<a name="l07030"></a>07030       $query-&gt;condition($key, $object-&gt;$key);
<a name="l07031"></a>07031     }
<a name="l07032"></a>07032     $return = <a class="code" href="common_8inc_a7daf0b68ef3b54562e9999ef017e28cb.html#a7daf0b68ef3b54562e9999ef017e28cb" title="Return status for saving which involved an update to an existing item.">SAVED_UPDATED</a>;
<a name="l07033"></a>07033   }
<a name="l07034"></a>07034 
<a name="l07035"></a>07035   <span class="comment">// Execute the SQL.</span>
<a name="l07036"></a>07036   <span class="keywordflow">if</span> ($query_return = $query-&gt;execute()) {
<a name="l07037"></a>07037     <span class="keywordflow">if</span> (isset($serial)) {
<a name="l07038"></a>07038       <span class="comment">// If the database was not told to return the last insert id, it will be</span>
<a name="l07039"></a>07039       <span class="comment">// because we already know it.</span>
<a name="l07040"></a>07040       <span class="keywordflow">if</span> (isset($options) &amp;&amp; $options[<span class="stringliteral">&#39;return&#39;</span>] != <a class="code" href="classDatabase_a56dab08fbf70f81aaf6f55a71922f4ef.html#a56dab08fbf70f81aaf6f55a71922f4ef" title="Flag to indicate a query call should return the &quot;last insert id&quot;.">Database::RETURN_INSERT_ID</a>) {
<a name="l07041"></a>07041         $object-&gt;$serial = $fields[$serial];
<a name="l07042"></a>07042       }
<a name="l07043"></a>07043       <span class="keywordflow">else</span> {
<a name="l07044"></a>07044         $object-&gt;$serial = $query_return;
<a name="l07045"></a>07045       }
<a name="l07046"></a>07046     }
<a name="l07047"></a>07047   }
<a name="l07048"></a>07048   <span class="comment">// If we have a single-field primary key but got no insert ID, the</span>
<a name="l07049"></a>07049   <span class="comment">// query failed. Note that we explicitly check for FALSE, because</span>
<a name="l07050"></a>07050   <span class="comment">// a valid update query which doesn&#39;t change any values will return</span>
<a name="l07051"></a>07051   <span class="comment">// zero (0) affected rows.</span>
<a name="l07052"></a>07052   elseif ($query_return === FALSE &amp;&amp; count($primary_keys) == 1) {
<a name="l07053"></a>07053     $return = FALSE;
<a name="l07054"></a>07054   }
<a name="l07055"></a>07055 
<a name="l07056"></a>07056   <span class="comment">// If we are inserting, populate empty fields with default values.</span>
<a name="l07057"></a>07057   <span class="keywordflow">if</span> (empty($primary_keys)) {
<a name="l07058"></a>07058     <span class="keywordflow">foreach</span> ($schema[<span class="stringliteral">&#39;fields&#39;</span>] as $field =&gt; $info) {
<a name="l07059"></a>07059       <span class="keywordflow">if</span> (isset($info[<span class="stringliteral">&#39;default&#39;</span>]) &amp;&amp; !property_exists($object, $field)) {
<a name="l07060"></a>07060         $object-&gt;$field = $info[<span class="stringliteral">&#39;default&#39;</span>];
<a name="l07061"></a>07061       }
<a name="l07062"></a>07062     }
<a name="l07063"></a>07063   }
<a name="l07064"></a>07064 
<a name="l07065"></a>07065   <span class="comment">// If we began with an array, convert back.</span>
<a name="l07066"></a>07066   <span class="keywordflow">if</span> (is_array($record)) {
<a name="l07067"></a>07067     $record = (array) $object;
<a name="l07068"></a>07068   }
<a name="l07069"></a>07069 
<a name="l07070"></a>07070   <span class="keywordflow">return</span> $return;
<a name="l07071"></a>07071 }
<a name="l07072"></a>07072 
<a name="l07112"></a><a class="code" href="common_8inc_a277955232059631211fcfde533ea89d6.html#a277955232059631211fcfde533ea89d6">07112</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a277955232059631211fcfde533ea89d6.html#a277955232059631211fcfde533ea89d6" title="End of &quot;addtogroup schemaapi&quot;.">drupal_parse_info_file</a>($filename) {
<a name="l07113"></a>07113   $info = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__, array());
<a name="l07114"></a>07114 
<a name="l07115"></a>07115   <span class="keywordflow">if</span> (!isset($info[$filename])) {
<a name="l07116"></a>07116     <span class="keywordflow">if</span> (!file_exists($filename)) {
<a name="l07117"></a>07117       $info[$filename] = array();
<a name="l07118"></a>07118     }
<a name="l07119"></a>07119     <span class="keywordflow">else</span> {
<a name="l07120"></a>07120       $data = file_get_contents($filename);
<a name="l07121"></a>07121       $info[$filename] = <a class="code" href="common_8inc_a21afcac6900bc25323023a53b9c3d100.html#a21afcac6900bc25323023a53b9c3d100" title="Parses data in Drupal&#39;s .info format.">drupal_parse_info_format</a>($data);
<a name="l07122"></a>07122     }
<a name="l07123"></a>07123   }
<a name="l07124"></a>07124   <span class="keywordflow">return</span> $info[$filename];
<a name="l07125"></a>07125 }
<a name="l07126"></a>07126 
<a name="l07164"></a><a class="code" href="common_8inc_a21afcac6900bc25323023a53b9c3d100.html#a21afcac6900bc25323023a53b9c3d100">07164</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a21afcac6900bc25323023a53b9c3d100.html#a21afcac6900bc25323023a53b9c3d100" title="Parses data in Drupal&#39;s .info format.">drupal_parse_info_format</a>($data) {
<a name="l07165"></a>07165   $info = array();
<a name="l07166"></a>07166   $constants = get_defined_constants();
<a name="l07167"></a>07167 
<a name="l07168"></a>07168   <span class="keywordflow">if</span> (preg_match_all(<span class="stringliteral">&#39;</span>
<a name="l07169"></a>07169 <span class="stringliteral">    @^\s*                           # Start at the beginning of a line, ignoring leading whitespace</span>
<a name="l07170"></a>07170 <span class="stringliteral">    ((?:</span>
<a name="l07171"></a>07171 <span class="stringliteral">      [^=;\[\]]|                    # Key names cannot contain equal signs, semi-colons or square brackets,</span>
<a name="l07172"></a>07172 <span class="stringliteral">      \[[^\[\]]*\]                  # unless they are balanced and not nested</span>
<a name="l07173"></a>07173 <span class="stringliteral">    )+?)</span>
<a name="l07174"></a>07174 <span class="stringliteral">    \s*=\s*                         # Key/value pairs are separated by equal signs (ignoring white-space)</span>
<a name="l07175"></a>07175 <span class="stringliteral">    (?:</span>
<a name="l07176"></a>07176 <span class="stringliteral">      (&quot;(?:[^&quot;]|(?&lt;=\\\\)&quot;)*&quot;)|     # Double-quoted string, which may contain slash-escaped quotes/slashes</span>
<a name="l07177"></a>07177 <span class="stringliteral">      (\&#39;(?:[^\&#39;]|(?&lt;=\\\\)\&#39;)*\&#39;)| # Single-quoted string, which may contain slash-escaped quotes/slashes</span>
<a name="l07178"></a>07178 <span class="stringliteral">      ([^\r\n]*?)                   # Non-quoted string</span>
<a name="l07179"></a>07179 <span class="stringliteral">    )\s*$                           # Stop at the next end of a line, ignoring trailing whitespace</span>
<a name="l07180"></a>07180 <span class="stringliteral">    @msx&#39;</span>, $data, $matches, PREG_SET_ORDER)) {
<a name="l07181"></a>07181     <span class="keywordflow">foreach</span> ($matches as $match) {
<a name="l07182"></a>07182       <span class="comment">// Fetch the key and value string.</span>
<a name="l07183"></a>07183       $i = 0;
<a name="l07184"></a>07184       <span class="keywordflow">foreach</span> (array(<span class="stringliteral">&#39;key&#39;</span>, <span class="stringliteral">&#39;value1&#39;</span>, <span class="stringliteral">&#39;value2&#39;</span>, <span class="stringliteral">&#39;value3&#39;</span>) as $var) {
<a name="l07185"></a>07185         $$var = isset($match[++$i]) ? $match[$i] : <span class="stringliteral">&#39;&#39;</span>;
<a name="l07186"></a>07186       }
<a name="l07187"></a>07187       $value = stripslashes(substr($value1, 1, -1)) . stripslashes(substr($value2, 1, -1)) . $value3;
<a name="l07188"></a>07188 
<a name="l07189"></a>07189       <span class="comment">// Parse array syntax.</span>
<a name="l07190"></a>07190       $keys = preg_split(<span class="stringliteral">&#39;/\]?\[/&#39;</span>, rtrim($key, <span class="charliteral">&#39;]&#39;</span>));
<a name="l07191"></a>07191       $last = array_pop($keys);
<a name="l07192"></a>07192       $parent = &amp;$info;
<a name="l07193"></a>07193 
<a name="l07194"></a>07194       <span class="comment">// Create nested arrays.</span>
<a name="l07195"></a>07195       <span class="keywordflow">foreach</span> ($keys as $key) {
<a name="l07196"></a>07196         <span class="keywordflow">if</span> ($key == <span class="stringliteral">&#39;&#39;</span>) {
<a name="l07197"></a>07197           $key = count($parent);
<a name="l07198"></a>07198         }
<a name="l07199"></a>07199         <span class="keywordflow">if</span> (!isset($parent[$key]) || !is_array($parent[$key])) {
<a name="l07200"></a>07200           $parent[$key] = array();
<a name="l07201"></a>07201         }
<a name="l07202"></a>07202         $parent = &amp;$parent[$key];
<a name="l07203"></a>07203       }
<a name="l07204"></a>07204 
<a name="l07205"></a>07205       <span class="comment">// Handle PHP constants.</span>
<a name="l07206"></a>07206       <span class="keywordflow">if</span> (isset($constants[$value])) {
<a name="l07207"></a>07207         $value = $constants[$value];
<a name="l07208"></a>07208       }
<a name="l07209"></a>07209 
<a name="l07210"></a>07210       <span class="comment">// Insert actual value.</span>
<a name="l07211"></a>07211       <span class="keywordflow">if</span> ($last == <span class="stringliteral">&#39;&#39;</span>) {
<a name="l07212"></a>07212         $last = count($parent);
<a name="l07213"></a>07213       }
<a name="l07214"></a>07214       $parent[$last] = $value;
<a name="l07215"></a>07215     }
<a name="l07216"></a>07216   }
<a name="l07217"></a>07217 
<a name="l07218"></a>07218   <span class="keywordflow">return</span> $info;
<a name="l07219"></a>07219 }
<a name="l07220"></a>07220 
<a name="l07231"></a><a class="code" href="group__logging__severity__levels_gafb5d4b58ec7e483153644c0f664e0ca4.html#gafb5d4b58ec7e483153644c0f664e0ca4">07231</a> <span class="keyword">function</span> <a class="code" href="group__logging__severity__levels_gafb5d4b58ec7e483153644c0f664e0ca4.html#gafb5d4b58ec7e483153644c0f664e0ca4" title="Returns a list of severity levels, as defined in RFC 3164.">watchdog_severity_levels</a>() {
<a name="l07232"></a>07232   <span class="keywordflow">return</span> array(
<a name="l07233"></a>07233     <a class="code" href="group__logging__severity__levels_ga467e941228edf3b033b5ef460e1bfcf7.html#ga467e941228edf3b033b5ef460e1bfcf7" title="Log message severity -- Emergency: system is unusable.">WATCHDOG_EMERGENCY</a> =&gt; <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;emergency&#39;</span>),
<a name="l07234"></a>07234     <a class="code" href="group__logging__severity__levels_ga9fdd40d55b14109f09f091f401f237c0.html#ga9fdd40d55b14109f09f091f401f237c0" title="Log message severity -- Alert: action must be taken immediately.">WATCHDOG_ALERT</a>     =&gt; <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;alert&#39;</span>),
<a name="l07235"></a>07235     <a class="code" href="group__logging__severity__levels_gab4129b98c8480bea3cbcd62083ae81e3.html#gab4129b98c8480bea3cbcd62083ae81e3" title="Log message severity -- Critical conditions.">WATCHDOG_CRITICAL</a>  =&gt; <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;critical&#39;</span>),
<a name="l07236"></a>07236     <a class="code" href="group__logging__severity__levels_ga174c9df2936096e11986fcf184d48576.html#ga174c9df2936096e11986fcf184d48576" title="Log message severity -- Error conditions.">WATCHDOG_ERROR</a>     =&gt; <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;error&#39;</span>),
<a name="l07237"></a>07237     <a class="code" href="group__logging__severity__levels_ga5361f835e10b39b553ee73c1b9414bf1.html#ga5361f835e10b39b553ee73c1b9414bf1" title="Log message severity -- Warning conditions.">WATCHDOG_WARNING</a>   =&gt; <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;warning&#39;</span>),
<a name="l07238"></a>07238     <a class="code" href="group__logging__severity__levels_ga757a33416683e8c44636a8799f60b477.html#ga757a33416683e8c44636a8799f60b477" title="Log message severity -- Normal but significant conditions.">WATCHDOG_NOTICE</a>    =&gt; <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;notice&#39;</span>),
<a name="l07239"></a>07239     <a class="code" href="group__logging__severity__levels_ga9629ff808fd20ce4abb297db5976af4d.html#ga9629ff808fd20ce4abb297db5976af4d" title="Log message severity -- Informational messages.">WATCHDOG_INFO</a>      =&gt; <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;info&#39;</span>),
<a name="l07240"></a>07240     <a class="code" href="group__logging__severity__levels_gaf672cd38d5654f8a4a12e32d9b9e749d.html#gaf672cd38d5654f8a4a12e32d9b9e749d" title="Log message severity -- Debug-level messages.">WATCHDOG_DEBUG</a>     =&gt; <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;debug&#39;</span>),
<a name="l07241"></a>07241   );
<a name="l07242"></a>07242 }
<a name="l07243"></a>07243 
<a name="l07244"></a>07244 
<a name="l07250"></a><a class="code" href="common_8inc_ae5bd302bab285bc819a70737f6121953.html#ae5bd302bab285bc819a70737f6121953">07250</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ae5bd302bab285bc819a70737f6121953.html#ae5bd302bab285bc819a70737f6121953" title="Explodes a string of tags into an array.">drupal_explode_tags</a>($tags) {
<a name="l07251"></a>07251   <span class="comment">// This regexp allows the following types of user input:</span>
<a name="l07252"></a>07252   <span class="comment">// this, &quot;somecompany, llc&quot;, &quot;and &quot;&quot;this&quot;&quot; w,o.rks&quot;, foo bar</span>
<a name="l07253"></a>07253   $regexp = <span class="stringliteral">&#39;%(?:^|,\ *)(&quot;(?&gt;[^&quot;]*)(?&gt;&quot;&quot;[^&quot;]* )*&quot;|(?: [^&quot;,]*))%x&#39;</span>;
<a name="l07254"></a>07254   preg_match_all($regexp, $tags, $matches);
<a name="l07255"></a>07255   $typed_tags = array_unique($matches[1]);
<a name="l07256"></a>07256 
<a name="l07257"></a>07257   $tags = array();
<a name="l07258"></a>07258   <span class="keywordflow">foreach</span> ($typed_tags as $tag) {
<a name="l07259"></a>07259     <span class="comment">// If a user has escaped a term (to demonstrate that it is a group,</span>
<a name="l07260"></a>07260     <span class="comment">// or includes a comma or quote character), we remove the escape</span>
<a name="l07261"></a>07261     <span class="comment">// formatting so to save the term into the database as the user intends.</span>
<a name="l07262"></a>07262     $tag = trim(str_replace(<span class="stringliteral">&#39;&quot;&quot;&#39;</span>, <span class="charliteral">&#39;&quot;&#39;</span>, preg_replace(<span class="stringliteral">&#39;/^&quot;(.*)&quot;$/&#39;</span>, <span class="charliteral">&#39;\1&#39;</span>, $tag)));
<a name="l07263"></a>07263     <span class="keywordflow">if</span> ($tag != <span class="stringliteral">&quot;&quot;</span>) {
<a name="l07264"></a>07264       $tags[] = $tag;
<a name="l07265"></a>07265     }
<a name="l07266"></a>07266   }
<a name="l07267"></a>07267 
<a name="l07268"></a>07268   <span class="keywordflow">return</span> $tags;
<a name="l07269"></a>07269 }
<a name="l07270"></a>07270 
<a name="l07276"></a><a class="code" href="common_8inc_a29df41fde25e9fcace627a628806c978.html#a29df41fde25e9fcace627a628806c978">07276</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a29df41fde25e9fcace627a628806c978.html#a29df41fde25e9fcace627a628806c978" title="Implodes an array of tags into a string.">drupal_implode_tags</a>($tags) {
<a name="l07277"></a>07277   $encoded_tags = array();
<a name="l07278"></a>07278   <span class="keywordflow">foreach</span> ($tags as $tag) {
<a name="l07279"></a>07279     <span class="comment">// Commas and quotes in tag names are special cases, so encode them.</span>
<a name="l07280"></a>07280     <span class="keywordflow">if</span> (strpos($tag, <span class="charliteral">&#39;,&#39;</span>) !== FALSE || strpos($tag, <span class="charliteral">&#39;&quot;&#39;</span>) !== FALSE) {
<a name="l07281"></a>07281       $tag = <span class="charliteral">&#39;&quot;&#39;</span> . str_replace(<span class="charliteral">&#39;&quot;&#39;</span>, <span class="stringliteral">&#39;&quot;&quot;&#39;</span>, $tag) . <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l07282"></a>07282     }
<a name="l07283"></a>07283 
<a name="l07284"></a>07284     $encoded_tags[] = $tag;
<a name="l07285"></a>07285   }
<a name="l07286"></a>07286   <span class="keywordflow">return</span> implode(<span class="stringliteral">&#39;, &#39;</span>, $encoded_tags);
<a name="l07287"></a>07287 }
<a name="l07288"></a>07288 
<a name="l07295"></a><a class="code" href="common_8inc_ac119432cefbdbb25647944d4ca3f82f8.html#ac119432cefbdbb25647944d4ca3f82f8">07295</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ac119432cefbdbb25647944d4ca3f82f8.html#ac119432cefbdbb25647944d4ca3f82f8" title="Flushes all cached data on the site.">drupal_flush_all_caches</a>() {
<a name="l07296"></a>07296   <span class="comment">// Change query-strings on css/js files to enforce reload for all users.</span>
<a name="l07297"></a>07297   <a class="code" href="common_8inc_aa53a3c794efc562f46a74688dabf27f6.html#aa53a3c794efc562f46a74688dabf27f6" title="Changes the dummy query string added to all CSS and JavaScript files.">_drupal_flush_css_js</a>();
<a name="l07298"></a>07298 
<a name="l07299"></a>07299   <a class="code" href="group__registry_ga63939dbdcf7950c97292f7d341f6d339.html#ga63939dbdcf7950c97292f7d341f6d339" title="Rescans all enabled modules and rebuilds the registry.">registry_rebuild</a>();
<a name="l07300"></a>07300   <a class="code" href="common_8inc_ae89dbd2b41a6623be2ed704d039a5c7c.html#ae89dbd2b41a6623be2ed704d039a5c7c" title="Deletes old cached CSS files.">drupal_clear_css_cache</a>();
<a name="l07301"></a>07301   <a class="code" href="common_8inc_ac05e083cb7cb02084601f8d2103b0405.html#ac05e083cb7cb02084601f8d2103b0405" title="Deletes old cached JavaScript files and variables.">drupal_clear_js_cache</a>();
<a name="l07302"></a>07302 
<a name="l07303"></a>07303   <span class="comment">// Rebuild the theme data. Note that the module data is rebuilt above, as</span>
<a name="l07304"></a>07304   <span class="comment">// part of registry_rebuild().</span>
<a name="l07305"></a>07305   system_rebuild_theme_data();
<a name="l07306"></a>07306   <a class="code" href="theme_8inc_a39fec3ccb5c90369be7b5df7961d47ed.html#a39fec3ccb5c90369be7b5df7961d47ed" title="Force the system to rebuild the theme registry; this should be called when modules are added to the s...">drupal_theme_rebuild</a>();
<a name="l07307"></a>07307 
<a name="l07308"></a>07308   <a class="code" href="common_8inc_a1905abb5de031d0030e680de4634fc66.html#a1905abb5de031d0030e680de4634fc66" title="Resets the cached information about entity types.">entity_info_cache_clear</a>();
<a name="l07309"></a>07309   node_types_rebuild();
<a name="l07310"></a>07310   <span class="comment">// node_menu() defines menu items based on node types so it needs to come</span>
<a name="l07311"></a>07311   <span class="comment">// after node types are rebuilt.</span>
<a name="l07312"></a>07312   <a class="code" href="group__menu_gaf36dcb9d5491ef5e7d2cf22c1f5c69f4.html#gaf36dcb9d5491ef5e7d2cf22c1f5c69f4" title="(Re)populate the database tables used by various menu functions.">menu_rebuild</a>();
<a name="l07313"></a>07313 
<a name="l07314"></a>07314   <span class="comment">// Synchronize to catch any actions that were added or removed.</span>
<a name="l07315"></a>07315   <a class="code" href="actions_8inc_a139190d8981f8e48be78b24d2adaab1c.html#a139190d8981f8e48be78b24d2adaab1c" title="Synchronizes actions that are provided by modules in hook_action_info().">actions_synchronize</a>();
<a name="l07316"></a>07316 
<a name="l07317"></a>07317   <span class="comment">// Don&#39;t clear cache_form - in-progress form submissions may break.</span>
<a name="l07318"></a>07318   <span class="comment">// Ordered so clearing the page cache will always be the last action.</span>
<a name="l07319"></a>07319   $core = array(<span class="stringliteral">&#39;cache&#39;</span>, <span class="stringliteral">&#39;cache_path&#39;</span>, <span class="stringliteral">&#39;cache_filter&#39;</span>, <span class="stringliteral">&#39;cache_bootstrap&#39;</span>, <span class="stringliteral">&#39;cache_page&#39;</span>);
<a name="l07320"></a>07320   $cache_tables = array_merge(<a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;flush_caches&#39;</span>), $core);
<a name="l07321"></a>07321   <span class="keywordflow">foreach</span> ($cache_tables as $table) {
<a name="l07322"></a>07322     <a class="code" href="cache_8inc_a409b34dd629640d791a11736a9de8125.html#a409b34dd629640d791a11736a9de8125" title="Expires data from the cache.">cache_clear_all</a>(<span class="charliteral">&#39;*&#39;</span>, $table, TRUE);
<a name="l07323"></a>07323   }
<a name="l07324"></a>07324 
<a name="l07325"></a>07325   <span class="comment">// Rebuild the bootstrap module list. We do this here so that developers</span>
<a name="l07326"></a>07326   <span class="comment">// can get new hook_boot() implementations registered without having to</span>
<a name="l07327"></a>07327   <span class="comment">// write a hook_update_N() function.</span>
<a name="l07328"></a>07328   _system_update_bootstrap_status();
<a name="l07329"></a>07329 }
<a name="l07330"></a>07330 
<a name="l07337"></a><a class="code" href="common_8inc_aa53a3c794efc562f46a74688dabf27f6.html#aa53a3c794efc562f46a74688dabf27f6">07337</a> <span class="keyword">function</span> <a class="code" href="common_8inc_aa53a3c794efc562f46a74688dabf27f6.html#aa53a3c794efc562f46a74688dabf27f6" title="Changes the dummy query string added to all CSS and JavaScript files.">_drupal_flush_css_js</a>() {
<a name="l07338"></a>07338   <span class="comment">// The timestamp is converted to base 36 in order to make it more compact.</span>
<a name="l07339"></a>07339   <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;css_js_query_string&#39;</span>, base_convert(<a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a>, 10, 36));
<a name="l07340"></a>07340 }
<a name="l07341"></a>07341 
<a name="l07357"></a><a class="code" href="common_8inc_a008ec6c4681fcb83701755c61daa8050.html#a008ec6c4681fcb83701755c61daa8050">07357</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a008ec6c4681fcb83701755c61daa8050.html#a008ec6c4681fcb83701755c61daa8050" title="Outputs debug information.">debug</a>($data, $label = NULL, $print_r = FALSE) {
<a name="l07358"></a>07358   <span class="comment">// Print $data contents to string.</span>
<a name="l07359"></a>07359   $string = <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>($print_r ? print_r($data, TRUE) : var_export($data, TRUE));
<a name="l07360"></a>07360 
<a name="l07361"></a>07361   <span class="comment">// Display values with pre-formatting to increase readability.</span>
<a name="l07362"></a>07362   $string = <span class="stringliteral">&#39;&lt;pre&gt;&#39;</span> . $string . <span class="stringliteral">&#39;&lt;/pre&gt;&#39;</span>;
<a name="l07363"></a>07363 
<a name="l07364"></a>07364   trigger_error(trim($label ? <span class="stringliteral">&quot;$label: $string&quot;</span> : $string));
<a name="l07365"></a>07365 }
<a name="l07366"></a>07366 
<a name="l07385"></a><a class="code" href="common_8inc_a4e06efa27b45d3aa8670a8553d0194d6.html#a4e06efa27b45d3aa8670a8553d0194d6">07385</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a4e06efa27b45d3aa8670a8553d0194d6.html#a4e06efa27b45d3aa8670a8553d0194d6" title="Parses a dependency for comparison by drupal_check_incompatibility().">drupal_parse_dependency</a>($dependency) {
<a name="l07386"></a>07386   <span class="comment">// We use named subpatterns and support every op that version_compare</span>
<a name="l07387"></a>07387   <span class="comment">// supports. Also, op is optional and defaults to equals.</span>
<a name="l07388"></a>07388   $p_op = <span class="stringliteral">&#39;(?P&lt;operation&gt;!=|==|=|&lt;|&lt;=|&gt;|&gt;=|&lt;&gt;)?&#39;</span>;
<a name="l07389"></a>07389   <span class="comment">// Core version is always optional: 7.x-2.x and 2.x is treated the same.</span>
<a name="l07390"></a>07390   $p_core = <span class="stringliteral">&#39;(?:&#39;</span> . preg_quote(<a class="code" href="bootstrap_8inc_a4f0dd177a6291b9d7fc1b5ae033b5eaf.html#a4f0dd177a6291b9d7fc1b5ae033b5eaf" title="Core API compatibility.">DRUPAL_CORE_COMPATIBILITY</a>) . <span class="stringliteral">&#39;-)?&#39;</span>;
<a name="l07391"></a>07391   $p_major = <span class="stringliteral">&#39;(?P&lt;major&gt;\d+)&#39;</span>;
<a name="l07392"></a>07392   <span class="comment">// By setting the minor version to x, branches can be matched.</span>
<a name="l07393"></a>07393   $p_minor = <span class="stringliteral">&#39;(?P&lt;minor&gt;(?:\d+|x)(?:-[A-Za-z]+\d+)?)&#39;</span>;
<a name="l07394"></a>07394   $value = array();
<a name="l07395"></a>07395   $parts = explode(<span class="charliteral">&#39;(&#39;</span>, $dependency, 2);
<a name="l07396"></a>07396   $value[<span class="stringliteral">&#39;name&#39;</span>] = trim($parts[0]);
<a name="l07397"></a>07397   <span class="keywordflow">if</span> (isset($parts[1])) {
<a name="l07398"></a>07398     $value[<span class="stringliteral">&#39;original_version&#39;</span>] = <span class="stringliteral">&#39; (&#39;</span> . $parts[1];
<a name="l07399"></a>07399     <span class="keywordflow">foreach</span> (explode(<span class="charliteral">&#39;,&#39;</span>, $parts[1]) as $version) {
<a name="l07400"></a>07400       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&quot;/^\s*$p_op\s*$p_core$p_major\.$p_minor/&quot;</span>, $version, $matches)) {
<a name="l07401"></a>07401         <a class="code" href="update_8php_a7c93a81c9b28ec2f78f33cdabda28c76.html#a7c93a81c9b28ec2f78f33cdabda28c76">$op</a> = !empty($matches[<span class="stringliteral">&#39;operation&#39;</span>]) ? $matches[<span class="stringliteral">&#39;operation&#39;</span>] : <span class="charliteral">&#39;=&#39;</span>;
<a name="l07402"></a>07402         <span class="keywordflow">if</span> ($matches[<span class="stringliteral">&#39;minor&#39;</span>] == <span class="charliteral">&#39;x&#39;</span>) {
<a name="l07403"></a>07403           <span class="comment">// Drupal considers &quot;2.x&quot; to mean any version that begins with</span>
<a name="l07404"></a>07404           <span class="comment">// &quot;2&quot; (e.g. 2.0, 2.9 are all &quot;2.x&quot;). PHP&#39;s version_compare(),</span>
<a name="l07405"></a>07405           <span class="comment">// on the other hand, treats &quot;x&quot; as a string; so to</span>
<a name="l07406"></a>07406           <span class="comment">// version_compare(), &quot;2.x&quot; is considered less than 2.0. This</span>
<a name="l07407"></a>07407           <span class="comment">// means that &gt;=2.x and &lt;2.x are handled by version_compare()</span>
<a name="l07408"></a>07408           <span class="comment">// as we need, but &gt; and &lt;= are not.</span>
<a name="l07409"></a>07409           <span class="keywordflow">if</span> (<a class="code" href="update_8php_a7c93a81c9b28ec2f78f33cdabda28c76.html#a7c93a81c9b28ec2f78f33cdabda28c76">$op</a> == <span class="charliteral">&#39;&gt;&#39;</span> || <a class="code" href="update_8php_a7c93a81c9b28ec2f78f33cdabda28c76.html#a7c93a81c9b28ec2f78f33cdabda28c76">$op</a> == <span class="stringliteral">&#39;&lt;=&#39;</span>) {
<a name="l07410"></a>07410             $matches[<span class="stringliteral">&#39;major&#39;</span>]++;
<a name="l07411"></a>07411           }
<a name="l07412"></a>07412           <span class="comment">// Equivalence can be checked by adding two restrictions.</span>
<a name="l07413"></a>07413           <span class="keywordflow">if</span> (<a class="code" href="update_8php_a7c93a81c9b28ec2f78f33cdabda28c76.html#a7c93a81c9b28ec2f78f33cdabda28c76">$op</a> == <span class="charliteral">&#39;=&#39;</span> || <a class="code" href="update_8php_a7c93a81c9b28ec2f78f33cdabda28c76.html#a7c93a81c9b28ec2f78f33cdabda28c76">$op</a> == <span class="stringliteral">&#39;==&#39;</span>) {
<a name="l07414"></a>07414             $value[<span class="stringliteral">&#39;versions&#39;</span>][] = array(<span class="stringliteral">&#39;op&#39;</span> =&gt; <span class="charliteral">&#39;&lt;&#39;</span>, <span class="stringliteral">&#39;version&#39;</span> =&gt; ($matches[<span class="stringliteral">&#39;major&#39;</span>] + 1) . <span class="stringliteral">&#39;.x&#39;</span>);
<a name="l07415"></a>07415             <a class="code" href="update_8php_a7c93a81c9b28ec2f78f33cdabda28c76.html#a7c93a81c9b28ec2f78f33cdabda28c76">$op</a> = <span class="stringliteral">&#39;&gt;=&#39;</span>;
<a name="l07416"></a>07416           }
<a name="l07417"></a>07417         }
<a name="l07418"></a>07418         $value[<span class="stringliteral">&#39;versions&#39;</span>][] = array(<span class="stringliteral">&#39;op&#39;</span> =&gt; <a class="code" href="update_8php_a7c93a81c9b28ec2f78f33cdabda28c76.html#a7c93a81c9b28ec2f78f33cdabda28c76">$op</a>, <span class="stringliteral">&#39;version&#39;</span> =&gt; $matches[<span class="stringliteral">&#39;major&#39;</span>] . <span class="charliteral">&#39;.&#39;</span> . $matches[<span class="stringliteral">&#39;minor&#39;</span>]);
<a name="l07419"></a>07419       }
<a name="l07420"></a>07420     }
<a name="l07421"></a>07421   }
<a name="l07422"></a>07422   <span class="keywordflow">return</span> $value;
<a name="l07423"></a>07423 }
<a name="l07424"></a>07424 
<a name="l07439"></a><a class="code" href="common_8inc_aa2a2d57500dc465711da5ac8e6afd406.html#aa2a2d57500dc465711da5ac8e6afd406">07439</a> <span class="keyword">function</span> <a class="code" href="common_8inc_aa2a2d57500dc465711da5ac8e6afd406.html#aa2a2d57500dc465711da5ac8e6afd406" title="Checks whether a version is compatible with a given dependency.">drupal_check_incompatibility</a>($v, $current_version) {
<a name="l07440"></a>07440   <span class="keywordflow">if</span> (!empty($v[<span class="stringliteral">&#39;versions&#39;</span>])) {
<a name="l07441"></a>07441     <span class="keywordflow">foreach</span> ($v[<span class="stringliteral">&#39;versions&#39;</span>] as $required_version) {
<a name="l07442"></a>07442       <span class="keywordflow">if</span> ((isset($required_version[<span class="stringliteral">&#39;op&#39;</span>]) &amp;&amp; !version_compare($current_version, $required_version[<span class="stringliteral">&#39;version&#39;</span>], $required_version[<span class="stringliteral">&#39;op&#39;</span>]))) {
<a name="l07443"></a>07443         <span class="keywordflow">return</span> $v[<span class="stringliteral">&#39;original_version&#39;</span>];
<a name="l07444"></a>07444       }
<a name="l07445"></a>07445     }
<a name="l07446"></a>07446   }
<a name="l07447"></a>07447 }
<a name="l07448"></a>07448 
<a name="l07459"></a><a class="code" href="common_8inc_a202e2a1b69e813ef9c48464efeca8ed3.html#a202e2a1b69e813ef9c48464efeca8ed3">07459</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a202e2a1b69e813ef9c48464efeca8ed3.html#a202e2a1b69e813ef9c48464efeca8ed3" title="Get the entity info array of an entity type.">entity_get_info</a>($entity_type = NULL) {
<a name="l07460"></a>07460   global $language;
<a name="l07461"></a>07461 
<a name="l07462"></a>07462   <span class="comment">// Use the advanced drupal_static() pattern, since this is called very often.</span>
<a name="l07463"></a>07463   <span class="keyword">static</span> $drupal_static_fast;
<a name="l07464"></a>07464   <span class="keywordflow">if</span> (!isset($drupal_static_fast)) {
<a name="l07465"></a>07465     $drupal_static_fast[<span class="stringliteral">&#39;entity_info&#39;</span>] = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__);
<a name="l07466"></a>07466   }
<a name="l07467"></a>07467   $entity_info = &amp;$drupal_static_fast[<span class="stringliteral">&#39;entity_info&#39;</span>];
<a name="l07468"></a>07468 
<a name="l07469"></a>07469   <span class="comment">// hook_entity_info() includes translated strings, so each language is cached</span>
<a name="l07470"></a>07470   <span class="comment">// separately.</span>
<a name="l07471"></a>07471   $langcode = $language-&gt;language;
<a name="l07472"></a>07472 
<a name="l07473"></a>07473   <span class="keywordflow">if</span> (empty($entity_info)) {
<a name="l07474"></a>07474     <span class="keywordflow">if</span> ($cache = <a class="code" href="cache_8inc_a9d873815c28909b61c3a6188b383f8a3.html#a9d873815c28909b61c3a6188b383f8a3" title="Returns data from the persistent cache.">cache_get</a>(<span class="stringliteral">&quot;entity_info:$langcode&quot;</span>)) {
<a name="l07475"></a>07475       $entity_info = $cache-&gt;data;
<a name="l07476"></a>07476     }
<a name="l07477"></a>07477     <span class="keywordflow">else</span> {
<a name="l07478"></a>07478       $entity_info = <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;entity_info&#39;</span>);
<a name="l07479"></a>07479       <span class="comment">// Merge in default values.</span>
<a name="l07480"></a>07480       <span class="keywordflow">foreach</span> ($entity_info as $name =&gt; $data) {
<a name="l07481"></a>07481         $entity_info[$name] += array(
<a name="l07482"></a>07482           <span class="stringliteral">&#39;fieldable&#39;</span> =&gt; FALSE,
<a name="l07483"></a>07483           <span class="stringliteral">&#39;controller class&#39;</span> =&gt; <span class="stringliteral">&#39;DrupalDefaultEntityController&#39;</span>,
<a name="l07484"></a>07484           <span class="stringliteral">&#39;static cache&#39;</span> =&gt; TRUE,
<a name="l07485"></a>07485           <span class="stringliteral">&#39;field cache&#39;</span> =&gt; TRUE,
<a name="l07486"></a>07486           <span class="stringliteral">&#39;load hook&#39;</span> =&gt; $name . <span class="stringliteral">&#39;_load&#39;</span>,
<a name="l07487"></a>07487           <span class="stringliteral">&#39;bundles&#39;</span> =&gt; array(),
<a name="l07488"></a>07488           <span class="stringliteral">&#39;view modes&#39;</span> =&gt; array(),
<a name="l07489"></a>07489           <span class="stringliteral">&#39;entity keys&#39;</span> =&gt; array(),
<a name="l07490"></a>07490           <span class="stringliteral">&#39;translation&#39;</span> =&gt; array(),
<a name="l07491"></a>07491         );
<a name="l07492"></a>07492         $entity_info[$name][<span class="stringliteral">&#39;entity keys&#39;</span>] += array(
<a name="l07493"></a>07493           <span class="stringliteral">&#39;revision&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l07494"></a>07494           <span class="stringliteral">&#39;bundle&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l07495"></a>07495         );
<a name="l07496"></a>07496         <span class="keywordflow">foreach</span> ($entity_info[$name][<span class="stringliteral">&#39;view modes&#39;</span>] as $view_mode =&gt; $view_mode_info) {
<a name="l07497"></a>07497           $entity_info[$name][<span class="stringliteral">&#39;view modes&#39;</span>][$view_mode] += array(
<a name="l07498"></a>07498             <span class="stringliteral">&#39;custom settings&#39;</span> =&gt; FALSE,
<a name="l07499"></a>07499           );
<a name="l07500"></a>07500         }
<a name="l07501"></a>07501         <span class="comment">// If no bundle key is provided, assume a single bundle, named after</span>
<a name="l07502"></a>07502         <span class="comment">// the entity type.</span>
<a name="l07503"></a>07503         <span class="keywordflow">if</span> (empty($entity_info[$name][<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;bundle&#39;</span>]) &amp;&amp; empty($entity_info[$name][<span class="stringliteral">&#39;bundles&#39;</span>])) {
<a name="l07504"></a>07504           $entity_info[$name][<span class="stringliteral">&#39;bundles&#39;</span>] = array($name =&gt; array(<span class="stringliteral">&#39;label&#39;</span> =&gt; $entity_info[$name][<span class="stringliteral">&#39;label&#39;</span>]));
<a name="l07505"></a>07505         }
<a name="l07506"></a>07506         <span class="comment">// Prepare entity schema fields SQL info for</span>
<a name="l07507"></a>07507         <span class="comment">// DrupalEntityControllerInterface::buildQuery().</span>
<a name="l07508"></a>07508         <span class="keywordflow">if</span> (isset($entity_info[$name][<span class="stringliteral">&#39;base table&#39;</span>])) {
<a name="l07509"></a>07509           $entity_info[$name][<span class="stringliteral">&#39;schema_fields_sql&#39;</span>][<span class="stringliteral">&#39;base table&#39;</span>] = <a class="code" href="group__schemaapi_gaacfcd6f676ee9062f0ba50a008a05443.html#gaacfcd6f676ee9062f0ba50a008a05443" title="Retrieves a list of fields from a table schema.">drupal_schema_fields_sql</a>($entity_info[$name][<span class="stringliteral">&#39;base table&#39;</span>]);
<a name="l07510"></a>07510           <span class="keywordflow">if</span> (isset($entity_info[$name][<span class="stringliteral">&#39;revision table&#39;</span>])) {
<a name="l07511"></a>07511             $entity_info[$name][<span class="stringliteral">&#39;schema_fields_sql&#39;</span>][<span class="stringliteral">&#39;revision table&#39;</span>] = <a class="code" href="group__schemaapi_gaacfcd6f676ee9062f0ba50a008a05443.html#gaacfcd6f676ee9062f0ba50a008a05443" title="Retrieves a list of fields from a table schema.">drupal_schema_fields_sql</a>($entity_info[$name][<span class="stringliteral">&#39;revision table&#39;</span>]);
<a name="l07512"></a>07512           }
<a name="l07513"></a>07513         }
<a name="l07514"></a>07514       }
<a name="l07515"></a>07515       <span class="comment">// Let other modules alter the entity info.</span>
<a name="l07516"></a>07516       <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;entity_info&#39;</span>, $entity_info);
<a name="l07517"></a>07517       <a class="code" href="cache_8inc_a48081f36334909f561ef4f538fa640d2.html#a48081f36334909f561ef4f538fa640d2" title="Stores data in the persistent cache.">cache_set</a>(<span class="stringliteral">&quot;entity_info:$langcode&quot;</span>, $entity_info);
<a name="l07518"></a>07518     }
<a name="l07519"></a>07519   }
<a name="l07520"></a>07520 
<a name="l07521"></a>07521   <span class="keywordflow">if</span> (empty($entity_type)) {
<a name="l07522"></a>07522     <span class="keywordflow">return</span> $entity_info;
<a name="l07523"></a>07523   }
<a name="l07524"></a>07524   elseif (isset($entity_info[$entity_type])) {
<a name="l07525"></a>07525     <span class="keywordflow">return</span> $entity_info[$entity_type];
<a name="l07526"></a>07526   }
<a name="l07527"></a>07527 }
<a name="l07528"></a>07528 
<a name="l07532"></a><a class="code" href="common_8inc_a1905abb5de031d0030e680de4634fc66.html#a1905abb5de031d0030e680de4634fc66">07532</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a1905abb5de031d0030e680de4634fc66.html#a1905abb5de031d0030e680de4634fc66" title="Resets the cached information about entity types.">entity_info_cache_clear</a>() {
<a name="l07533"></a>07533   <a class="code" href="group__schemaapi_ga714b5ed0b14c43b61eef0c895598c5c4.html#ga714b5ed0b14c43b61eef0c895598c5c4" title="Resets one or all centrally stored static variable(s).">drupal_static_reset</a>(<span class="stringliteral">&#39;entity_get_info&#39;</span>);
<a name="l07534"></a>07534   <span class="comment">// Clear all languages.</span>
<a name="l07535"></a>07535   <a class="code" href="cache_8inc_a409b34dd629640d791a11736a9de8125.html#a409b34dd629640d791a11736a9de8125" title="Expires data from the cache.">cache_clear_all</a>(<span class="stringliteral">&#39;entity_info:&#39;</span>, <span class="stringliteral">&#39;cache&#39;</span>, TRUE);
<a name="l07536"></a>07536 }
<a name="l07537"></a>07537 
<a name="l07552"></a><a class="code" href="common_8inc_ae8d0c984add0f9ff53a2a6dc4fb1ba58.html#ae8d0c984add0f9ff53a2a6dc4fb1ba58">07552</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ae8d0c984add0f9ff53a2a6dc4fb1ba58.html#ae8d0c984add0f9ff53a2a6dc4fb1ba58" title="Helper function to extract id, vid, and bundle name from an entity.">entity_extract_ids</a>($entity_type, $entity) {
<a name="l07553"></a>07553   $info = <a class="code" href="common_8inc_a202e2a1b69e813ef9c48464efeca8ed3.html#a202e2a1b69e813ef9c48464efeca8ed3" title="Get the entity info array of an entity type.">entity_get_info</a>($entity_type);
<a name="l07554"></a>07554 
<a name="l07555"></a>07555   <span class="comment">// Objects being created might not have id/vid yet.</span>
<a name="l07556"></a>07556   $id = isset($entity-&gt;{$info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>]}) ? $entity-&gt;{$info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>]} : NULL;
<a name="l07557"></a>07557   $vid = ($info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;revision&#39;</span>] &amp;&amp; isset($entity-&gt;{$info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;revision&#39;</span>]})) ? $entity-&gt;{$info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;revision&#39;</span>]} : NULL;
<a name="l07558"></a>07558 
<a name="l07559"></a>07559   <span class="keywordflow">if</span> (!empty($info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;bundle&#39;</span>])) {
<a name="l07560"></a>07560     <span class="comment">// Explicitly fail for malformed entities missing the bundle property.</span>
<a name="l07561"></a>07561     <span class="keywordflow">if</span> (!isset($entity-&gt;{$info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;bundle&#39;</span>]}) || $entity-&gt;{$info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;bundle&#39;</span>]} === <span class="stringliteral">&#39;&#39;</span>) {
<a name="l07562"></a>07562       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classEntityMalformedException.html" title="Exception thrown when a malformed entity is passed.">EntityMalformedException</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Missing bundle property on entity of type @entity_type.&#39;</span>, array(<span class="stringliteral">&#39;@entity_type&#39;</span> =&gt; $entity_type)));
<a name="l07563"></a>07563     }
<a name="l07564"></a>07564     $bundle = $entity-&gt;{$info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;bundle&#39;</span>]};
<a name="l07565"></a>07565   }
<a name="l07566"></a>07566   <span class="keywordflow">else</span> {
<a name="l07567"></a>07567     <span class="comment">// The entity type provides no bundle key: assume a single bundle, named</span>
<a name="l07568"></a>07568     <span class="comment">// after the entity type.</span>
<a name="l07569"></a>07569     $bundle = $entity_type;
<a name="l07570"></a>07570   }
<a name="l07571"></a>07571 
<a name="l07572"></a>07572   <span class="keywordflow">return</span> array($id, $vid, $bundle);
<a name="l07573"></a>07573 }
<a name="l07574"></a>07574 
<a name="l07591"></a><a class="code" href="common_8inc_af0b338fb292ad46545a3d35178a0155b.html#af0b338fb292ad46545a3d35178a0155b">07591</a> <span class="keyword">function</span> <a class="code" href="common_8inc_af0b338fb292ad46545a3d35178a0155b.html#af0b338fb292ad46545a3d35178a0155b" title="Helper function to assemble an object structure with initial ids.">entity_create_stub_entity</a>($entity_type, $ids) {
<a name="l07592"></a>07592   $entity = <span class="keyword">new</span> stdClass();
<a name="l07593"></a>07593   $info = <a class="code" href="common_8inc_a202e2a1b69e813ef9c48464efeca8ed3.html#a202e2a1b69e813ef9c48464efeca8ed3" title="Get the entity info array of an entity type.">entity_get_info</a>($entity_type);
<a name="l07594"></a>07594   $entity-&gt;{$info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;id&#39;</span>]} = $ids[0];
<a name="l07595"></a>07595   <span class="keywordflow">if</span> (!empty($info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;revision&#39;</span>]) &amp;&amp; isset($ids[1])) {
<a name="l07596"></a>07596     $entity-&gt;{$info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;revision&#39;</span>]} = $ids[1];
<a name="l07597"></a>07597   }
<a name="l07598"></a>07598   <span class="keywordflow">if</span> (!empty($info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;bundle&#39;</span>]) &amp;&amp; isset($ids[2])) {
<a name="l07599"></a>07599     $entity-&gt;{$info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;bundle&#39;</span>]} = $ids[2];
<a name="l07600"></a>07600   }
<a name="l07601"></a>07601   <span class="keywordflow">return</span> $entity;
<a name="l07602"></a>07602 }
<a name="l07603"></a>07603 
<a name="l07642"></a><a class="code" href="common_8inc_a78b89cf93f9710a68d02f86adccf1898.html#a78b89cf93f9710a68d02f86adccf1898">07642</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a78b89cf93f9710a68d02f86adccf1898.html#a78b89cf93f9710a68d02f86adccf1898" title="Load entities from the database.">entity_load</a>($entity_type, $ids = FALSE, $conditions = array(), $reset = FALSE) {
<a name="l07643"></a>07643   <span class="keywordflow">if</span> ($reset) {
<a name="l07644"></a>07644     <a class="code" href="common_8inc_ae99d85c4f3144d7211e312e293c3be70.html#ae99d85c4f3144d7211e312e293c3be70" title="Get the entity controller class for an entity type.">entity_get_controller</a>($entity_type)-&gt;resetCache();
<a name="l07645"></a>07645   }
<a name="l07646"></a>07646   <span class="keywordflow">return</span> <a class="code" href="common_8inc_ae99d85c4f3144d7211e312e293c3be70.html#ae99d85c4f3144d7211e312e293c3be70" title="Get the entity controller class for an entity type.">entity_get_controller</a>($entity_type)-&gt;load($ids, $conditions);
<a name="l07647"></a>07647 }
<a name="l07648"></a>07648 
<a name="l07665"></a><a class="code" href="common_8inc_ad6d77695e6a66026389a4a734202b253.html#ad6d77695e6a66026389a4a734202b253">07665</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ad6d77695e6a66026389a4a734202b253.html#ad6d77695e6a66026389a4a734202b253" title="Loads the unchanged, i.e.">entity_load_unchanged</a>($entity_type, $id) {
<a name="l07666"></a>07666   <a class="code" href="common_8inc_ae99d85c4f3144d7211e312e293c3be70.html#ae99d85c4f3144d7211e312e293c3be70" title="Get the entity controller class for an entity type.">entity_get_controller</a>($entity_type)-&gt;resetCache(array($id));
<a name="l07667"></a>07667   $result = <a class="code" href="common_8inc_ae99d85c4f3144d7211e312e293c3be70.html#ae99d85c4f3144d7211e312e293c3be70" title="Get the entity controller class for an entity type.">entity_get_controller</a>($entity_type)-&gt;load(array($id));
<a name="l07668"></a>07668   <span class="keywordflow">return</span> reset($result);
<a name="l07669"></a>07669 }
<a name="l07670"></a>07670 
<a name="l07674"></a><a class="code" href="common_8inc_ae99d85c4f3144d7211e312e293c3be70.html#ae99d85c4f3144d7211e312e293c3be70">07674</a> <span class="keyword">function</span> <a class="code" href="common_8inc_ae99d85c4f3144d7211e312e293c3be70.html#ae99d85c4f3144d7211e312e293c3be70" title="Get the entity controller class for an entity type.">entity_get_controller</a>($entity_type) {
<a name="l07675"></a>07675   $controllers = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__, array());
<a name="l07676"></a>07676   <span class="keywordflow">if</span> (!isset($controllers[$entity_type])) {
<a name="l07677"></a>07677     $type_info = <a class="code" href="common_8inc_a202e2a1b69e813ef9c48464efeca8ed3.html#a202e2a1b69e813ef9c48464efeca8ed3" title="Get the entity info array of an entity type.">entity_get_info</a>($entity_type);
<a name="l07678"></a>07678     $class = $type_info[<span class="stringliteral">&#39;controller class&#39;</span>];
<a name="l07679"></a>07679     $controllers[$entity_type] = <span class="keyword">new</span> $class($entity_type);
<a name="l07680"></a>07680   }
<a name="l07681"></a>07681   <span class="keywordflow">return</span> $controllers[$entity_type];
<a name="l07682"></a>07682 }
<a name="l07683"></a>07683 
<a name="l07707"></a><a class="code" href="common_8inc_a180628d308e46de0a76e7cdc0e65ce4d.html#a180628d308e46de0a76e7cdc0e65ce4d">07707</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a180628d308e46de0a76e7cdc0e65ce4d.html#a180628d308e46de0a76e7cdc0e65ce4d" title="Invoke hook_entity_prepare_view().">entity_prepare_view</a>($entity_type, $entities, $langcode = NULL) {
<a name="l07708"></a>07708   <span class="keywordflow">if</span> (!isset($langcode)) {
<a name="l07709"></a>07709     $langcode = $GLOBALS[<span class="stringliteral">&#39;language_content&#39;</span>]-&gt;language;
<a name="l07710"></a>07710   }
<a name="l07711"></a>07711 
<a name="l07712"></a>07712   <span class="comment">// To ensure hooks are only run once per entity, check for an</span>
<a name="l07713"></a>07713   <span class="comment">// entity_view_prepared flag and only process items without it.</span>
<a name="l07714"></a>07714   <span class="comment">// @todo: resolve this more generally for both entity and field level hooks.</span>
<a name="l07715"></a>07715   $prepare = array();
<a name="l07716"></a>07716   <span class="keywordflow">foreach</span> ($entities as $id =&gt; $entity) {
<a name="l07717"></a>07717     <span class="keywordflow">if</span> (empty($entity-&gt;entity_view_prepared)) {
<a name="l07718"></a>07718       <span class="comment">// Add this entity to the items to be prepared.</span>
<a name="l07719"></a>07719       $prepare[$id] = $entity;
<a name="l07720"></a>07720 
<a name="l07721"></a>07721       <span class="comment">// Mark this item as prepared.</span>
<a name="l07722"></a>07722       $entity-&gt;entity_view_prepared = TRUE;
<a name="l07723"></a>07723     }
<a name="l07724"></a>07724   }
<a name="l07725"></a>07725 
<a name="l07726"></a>07726   <span class="keywordflow">if</span> (!empty($prepare)) {
<a name="l07727"></a>07727     <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;entity_prepare_view&#39;</span>, $prepare, $entity_type, $langcode);
<a name="l07728"></a>07728   }
<a name="l07729"></a>07729 }
<a name="l07730"></a>07730 
<a name="l07743"></a><a class="code" href="common_8inc_a00f3b77a23f66be91c30ae42d8ea40cd.html#a00f3b77a23f66be91c30ae42d8ea40cd">07743</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a00f3b77a23f66be91c30ae42d8ea40cd.html#a00f3b77a23f66be91c30ae42d8ea40cd" title="Returns the uri elements of an entity.">entity_uri</a>($entity_type, $entity) {
<a name="l07744"></a>07744   $info = <a class="code" href="common_8inc_a202e2a1b69e813ef9c48464efeca8ed3.html#a202e2a1b69e813ef9c48464efeca8ed3" title="Get the entity info array of an entity type.">entity_get_info</a>($entity_type);
<a name="l07745"></a>07745   list($id, $vid, $bundle) = <a class="code" href="common_8inc_ae8d0c984add0f9ff53a2a6dc4fb1ba58.html#ae8d0c984add0f9ff53a2a6dc4fb1ba58" title="Helper function to extract id, vid, and bundle name from an entity.">entity_extract_ids</a>($entity_type, $entity);
<a name="l07746"></a>07746 
<a name="l07747"></a>07747   <span class="comment">// A bundle-specific callback takes precedence over the generic one for the</span>
<a name="l07748"></a>07748   <span class="comment">// entity type.</span>
<a name="l07749"></a>07749   <span class="keywordflow">if</span> (isset($info[<span class="stringliteral">&#39;bundles&#39;</span>][$bundle][<span class="stringliteral">&#39;uri callback&#39;</span>])) {
<a name="l07750"></a>07750     $uri_callback = $info[<span class="stringliteral">&#39;bundles&#39;</span>][$bundle][<span class="stringliteral">&#39;uri callback&#39;</span>];
<a name="l07751"></a>07751   }
<a name="l07752"></a>07752   elseif (isset($info[<span class="stringliteral">&#39;uri callback&#39;</span>])) {
<a name="l07753"></a>07753     $uri_callback = $info[<span class="stringliteral">&#39;uri callback&#39;</span>];
<a name="l07754"></a>07754   }
<a name="l07755"></a>07755   <span class="keywordflow">else</span> {
<a name="l07756"></a>07756     <span class="keywordflow">return</span> NULL;
<a name="l07757"></a>07757   }
<a name="l07758"></a>07758 
<a name="l07759"></a>07759   <span class="comment">// Invoke the callback to get the URI. If there is no callback, return NULL.</span>
<a name="l07760"></a>07760   <span class="keywordflow">if</span> (isset($uri_callback) &amp;&amp; function_exists($uri_callback)) {
<a name="l07761"></a>07761     $uri = $uri_callback($entity);
<a name="l07762"></a>07762     <span class="comment">// Pass the entity data to url() so that alter functions do not need to</span>
<a name="l07763"></a>07763     <span class="comment">// lookup this entity again.</span>
<a name="l07764"></a>07764     $uri[<span class="stringliteral">&#39;options&#39;</span>][<span class="stringliteral">&#39;entity_type&#39;</span>] = $entity_type;
<a name="l07765"></a>07765     $uri[<span class="stringliteral">&#39;options&#39;</span>][<span class="stringliteral">&#39;entity&#39;</span>] = $entity;
<a name="l07766"></a>07766     <span class="keywordflow">return</span> $uri;
<a name="l07767"></a>07767   }
<a name="l07768"></a>07768 }
<a name="l07769"></a>07769 
<a name="l07784"></a><a class="code" href="common_8inc_aa9868513964b440f8206571573b833b3.html#aa9868513964b440f8206571573b833b3">07784</a> <span class="keyword">function</span> <a class="code" href="common_8inc_aa9868513964b440f8206571573b833b3.html#aa9868513964b440f8206571573b833b3" title="Returns the label of an entity.">entity_label</a>($entity_type, $entity) {
<a name="l07785"></a>07785   $label = FALSE;
<a name="l07786"></a>07786   $info = <a class="code" href="common_8inc_a202e2a1b69e813ef9c48464efeca8ed3.html#a202e2a1b69e813ef9c48464efeca8ed3" title="Get the entity info array of an entity type.">entity_get_info</a>($entity_type);
<a name="l07787"></a>07787   <span class="keywordflow">if</span> (isset($info[<span class="stringliteral">&#39;label callback&#39;</span>]) &amp;&amp; function_exists($info[<span class="stringliteral">&#39;label callback&#39;</span>])) {
<a name="l07788"></a>07788     $label = $info[<span class="stringliteral">&#39;label callback&#39;</span>]($entity, $entity_type);
<a name="l07789"></a>07789   }
<a name="l07790"></a>07790   elseif (!empty($info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;label&#39;</span>]) &amp;&amp; isset($entity-&gt;{$info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;label&#39;</span>]})) {
<a name="l07791"></a>07791     $label = $entity-&gt;{$info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;label&#39;</span>]};
<a name="l07792"></a>07792   }
<a name="l07793"></a>07793 
<a name="l07794"></a>07794   <span class="keywordflow">return</span> $label;
<a name="l07795"></a>07795 }
<a name="l07796"></a>07796 
<a name="l07808"></a><a class="code" href="common_8inc_abd1bd4466071377d474040174c49f06b.html#abd1bd4466071377d474040174c49f06b">07808</a> <span class="keyword">function</span> <a class="code" href="common_8inc_abd1bd4466071377d474040174c49f06b.html#abd1bd4466071377d474040174c49f06b" title="Returns the language of an entity.">entity_language</a>($entity_type, $entity) {
<a name="l07809"></a>07809   $info = <a class="code" href="common_8inc_a202e2a1b69e813ef9c48464efeca8ed3.html#a202e2a1b69e813ef9c48464efeca8ed3" title="Get the entity info array of an entity type.">entity_get_info</a>($entity_type);
<a name="l07810"></a>07810 
<a name="l07811"></a>07811   <span class="comment">// Invoke the callback to get the language. If there is no callback, try to</span>
<a name="l07812"></a>07812   <span class="comment">// get it from a property of the entity, otherwise NULL.</span>
<a name="l07813"></a>07813   <span class="keywordflow">if</span> (isset($info[<span class="stringliteral">&#39;language callback&#39;</span>]) &amp;&amp; function_exists($info[<span class="stringliteral">&#39;language callback&#39;</span>])) {
<a name="l07814"></a>07814     $langcode = $info[<span class="stringliteral">&#39;language callback&#39;</span>]($entity_type, $entity);
<a name="l07815"></a>07815   }
<a name="l07816"></a>07816   elseif (!empty($info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;language&#39;</span>]) &amp;&amp; isset($entity-&gt;{$info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;language&#39;</span>]})) {
<a name="l07817"></a>07817     $langcode = $entity-&gt;{$info[<span class="stringliteral">&#39;entity keys&#39;</span>][<span class="stringliteral">&#39;language&#39;</span>]};
<a name="l07818"></a>07818   }
<a name="l07819"></a>07819   <span class="keywordflow">else</span> {
<a name="l07820"></a>07820     <span class="comment">// The value returned in D8 would be LANGUAGE_NONE, we cannot use it here to</span>
<a name="l07821"></a>07821     <span class="comment">// preserve backward compatibility. In fact this function has been</span>
<a name="l07822"></a>07822     <span class="comment">// introduced very late in the D7 life cycle, mainly as the proper default</span>
<a name="l07823"></a>07823     <span class="comment">// for field_attach_form(). By returning LANGUAGE_NONE when no language</span>
<a name="l07824"></a>07824     <span class="comment">// information is available, we would introduce a potentially BC-breaking</span>
<a name="l07825"></a>07825     <span class="comment">// API change, since field_attach_form() defaults to the default language</span>
<a name="l07826"></a>07826     <span class="comment">// instead of LANGUAGE_NONE. Moreover this allows us to distinguish between</span>
<a name="l07827"></a>07827     <span class="comment">// entities that have no language specified from ones that do not have</span>
<a name="l07828"></a>07828     <span class="comment">// language support at all.</span>
<a name="l07829"></a>07829     $langcode = NULL;
<a name="l07830"></a>07830   }
<a name="l07831"></a>07831 
<a name="l07832"></a>07832   <span class="keywordflow">return</span> $langcode;
<a name="l07833"></a>07833 }
<a name="l07834"></a>07834 
<a name="l07838"></a><a class="code" href="common_8inc_a730911cdea4f78ea5c6995afdbd266f9.html#a730911cdea4f78ea5c6995afdbd266f9">07838</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a730911cdea4f78ea5c6995afdbd266f9.html#a730911cdea4f78ea5c6995afdbd266f9" title="Helper function for attaching field API validation to entity forms.">entity_form_field_validate</a>($entity_type, $form, &amp;$form_state) {
<a name="l07839"></a>07839   <span class="comment">// All field attach API functions act on an entity object, but during form</span>
<a name="l07840"></a>07840   <span class="comment">// validation, we don&#39;t have one. $form_state contains the entity as it was</span>
<a name="l07841"></a>07841   <span class="comment">// prior to processing the current form submission, and we must not update it</span>
<a name="l07842"></a>07842   <span class="comment">// until we have fully validated the submitted input. Therefore, for</span>
<a name="l07843"></a>07843   <span class="comment">// validation, act on a pseudo entity created out of the form values.</span>
<a name="l07844"></a>07844   $pseudo_entity = (object) $form_state[<span class="stringliteral">&#39;values&#39;</span>];
<a name="l07845"></a>07845   field_attach_form_validate($entity_type, $pseudo_entity, $form, $form_state);
<a name="l07846"></a>07846 }
<a name="l07847"></a>07847 
<a name="l07869"></a><a class="code" href="common_8inc_a0aac8c55307d5f8bca09e44481bcfc9a.html#a0aac8c55307d5f8bca09e44481bcfc9a">07869</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a0aac8c55307d5f8bca09e44481bcfc9a.html#a0aac8c55307d5f8bca09e44481bcfc9a" title="Helper function for copying submitted values to entity properties for simple entity forms...">entity_form_submit_build_entity</a>($entity_type, $entity, $form, &amp;$form_state) {
<a name="l07870"></a>07870   $info = <a class="code" href="common_8inc_a202e2a1b69e813ef9c48464efeca8ed3.html#a202e2a1b69e813ef9c48464efeca8ed3" title="Get the entity info array of an entity type.">entity_get_info</a>($entity_type);
<a name="l07871"></a>07871   list(, , $bundle) = <a class="code" href="common_8inc_ae8d0c984add0f9ff53a2a6dc4fb1ba58.html#ae8d0c984add0f9ff53a2a6dc4fb1ba58" title="Helper function to extract id, vid, and bundle name from an entity.">entity_extract_ids</a>($entity_type, $entity);
<a name="l07872"></a>07872 
<a name="l07873"></a>07873   <span class="comment">// Copy top-level form values that are not for fields to entity properties,</span>
<a name="l07874"></a>07874   <span class="comment">// without changing existing entity properties that are not being edited by</span>
<a name="l07875"></a>07875   <span class="comment">// this form. Copying field values must be done using field_attach_submit().</span>
<a name="l07876"></a>07876   $values_excluding_fields = $info[<span class="stringliteral">&#39;fieldable&#39;</span>] ? array_diff_key($form_state[<span class="stringliteral">&#39;values&#39;</span>], field_info_instances($entity_type, $bundle)) : $form_state[<span class="stringliteral">&#39;values&#39;</span>];
<a name="l07877"></a>07877   <span class="keywordflow">foreach</span> ($values_excluding_fields as $key =&gt; $value) {
<a name="l07878"></a>07878     $entity-&gt;$key = $value;
<a name="l07879"></a>07879   }
<a name="l07880"></a>07880 
<a name="l07881"></a>07881   <span class="comment">// Invoke all specified builders for copying form values to entity properties.</span>
<a name="l07882"></a>07882   <span class="keywordflow">if</span> (isset($form[<span class="stringliteral">&#39;#entity_builders&#39;</span>])) {
<a name="l07883"></a>07883     <span class="keywordflow">foreach</span> ($form[<span class="stringliteral">&#39;#entity_builders&#39;</span>] as $function) {
<a name="l07884"></a>07884       $function($entity_type, $entity, $form, $form_state);
<a name="l07885"></a>07885     }
<a name="l07886"></a>07886   }
<a name="l07887"></a>07887 
<a name="l07888"></a>07888   <span class="comment">// Copy field values to the entity.</span>
<a name="l07889"></a>07889   <span class="keywordflow">if</span> ($info[<span class="stringliteral">&#39;fieldable&#39;</span>]) {
<a name="l07890"></a>07890     field_attach_submit($entity_type, $entity, $form, $form_state);
<a name="l07891"></a>07891   }
<a name="l07892"></a>07892 }
<a name="l07893"></a>07893 
<a name="l07922"></a><a class="code" href="common_8inc_a66953a56d54712147cc383c1adb08dc3.html#a66953a56d54712147cc383c1adb08dc3">07922</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a66953a56d54712147cc383c1adb08dc3.html#a66953a56d54712147cc383c1adb08dc3" title="Performs one or more XML-RPC request(s).">xmlrpc</a>($url, $args, $options = array()) {
<a name="l07923"></a>07923   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/xmlrpc.inc&#39;</span>;
<a name="l07924"></a>07924   <span class="keywordflow">return</span> <a class="code" href="xmlrpc_8inc_a75ed600c83fb9a27ae92f949b6812749.html#a75ed600c83fb9a27ae92f949b6812749" title="Performs one or more XML-RPC requests.">_xmlrpc</a>($url, $args, $options);
<a name="l07925"></a>07925 }
<a name="l07926"></a>07926 
<a name="l07933"></a><a class="code" href="common_8inc_a15bb26df893f7c8919ab8e4505085028.html#a15bb26df893f7c8919ab8e4505085028">07933</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a15bb26df893f7c8919ab8e4505085028.html#a15bb26df893f7c8919ab8e4505085028" title="Retrieves a list of all available archivers.">archiver_get_info</a>() {
<a name="l07934"></a>07934   $archiver_info = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__, array());
<a name="l07935"></a>07935 
<a name="l07936"></a>07936   <span class="keywordflow">if</span> (empty($archiver_info)) {
<a name="l07937"></a>07937     $cache = <a class="code" href="cache_8inc_a9d873815c28909b61c3a6188b383f8a3.html#a9d873815c28909b61c3a6188b383f8a3" title="Returns data from the persistent cache.">cache_get</a>(<span class="stringliteral">&#39;archiver_info&#39;</span>);
<a name="l07938"></a>07938     <span class="keywordflow">if</span> ($cache === FALSE) {
<a name="l07939"></a>07939       <span class="comment">// Rebuild the cache and save it.</span>
<a name="l07940"></a>07940       $archiver_info = <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;archiver_info&#39;</span>);
<a name="l07941"></a>07941       <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;archiver_info&#39;</span>, $archiver_info);
<a name="l07942"></a>07942       uasort($archiver_info, <span class="stringliteral">&#39;drupal_sort_weight&#39;</span>);
<a name="l07943"></a>07943       <a class="code" href="cache_8inc_a48081f36334909f561ef4f538fa640d2.html#a48081f36334909f561ef4f538fa640d2" title="Stores data in the persistent cache.">cache_set</a>(<span class="stringliteral">&#39;archiver_info&#39;</span>, $archiver_info);
<a name="l07944"></a>07944     }
<a name="l07945"></a>07945     <span class="keywordflow">else</span> {
<a name="l07946"></a>07946       $archiver_info = $cache-&gt;data;
<a name="l07947"></a>07947     }
<a name="l07948"></a>07948   }
<a name="l07949"></a>07949 
<a name="l07950"></a>07950   <span class="keywordflow">return</span> $archiver_info;
<a name="l07951"></a>07951 }
<a name="l07952"></a>07952 
<a name="l07960"></a><a class="code" href="common_8inc_a18a577f5ca64b7ba483fc312e15d4d30.html#a18a577f5ca64b7ba483fc312e15d4d30">07960</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a18a577f5ca64b7ba483fc312e15d4d30.html#a18a577f5ca64b7ba483fc312e15d4d30" title="Returns a string of supported archive extensions.">archiver_get_extensions</a>() {
<a name="l07961"></a>07961   $valid_extensions = array();
<a name="l07962"></a>07962   <span class="keywordflow">foreach</span> (<a class="code" href="common_8inc_a15bb26df893f7c8919ab8e4505085028.html#a15bb26df893f7c8919ab8e4505085028" title="Retrieves a list of all available archivers.">archiver_get_info</a>() as $archive) {
<a name="l07963"></a>07963     <span class="keywordflow">foreach</span> ($archive[<span class="stringliteral">&#39;extensions&#39;</span>] as $extension) {
<a name="l07964"></a>07964       <span class="keywordflow">foreach</span> (explode(<span class="charliteral">&#39;.&#39;</span>, $extension) as $part) {
<a name="l07965"></a>07965         <span class="keywordflow">if</span> (!in_array($part, $valid_extensions)) {
<a name="l07966"></a>07966           $valid_extensions[] = $part;
<a name="l07967"></a>07967         }
<a name="l07968"></a>07968       }
<a name="l07969"></a>07969     }
<a name="l07970"></a>07970   }
<a name="l07971"></a>07971   <span class="keywordflow">return</span> implode(<span class="charliteral">&#39; &#39;</span>, $valid_extensions);
<a name="l07972"></a>07972 }
<a name="l07973"></a>07973 
<a name="l07986"></a><a class="code" href="common_8inc_af2f29710c2fe37e69be6501bf833361b.html#af2f29710c2fe37e69be6501bf833361b">07986</a> <span class="keyword">function</span> <a class="code" href="common_8inc_af2f29710c2fe37e69be6501bf833361b.html#af2f29710c2fe37e69be6501bf833361b" title="Creates the appropriate archiver for the specified file.">archiver_get_archiver</a>($file) {
<a name="l07987"></a>07987   <span class="comment">// Archivers can only work on local paths</span>
<a name="l07988"></a>07988   $filepath = <a class="code" href="group__php__wrappers_gafaa5b186c9e78f53b39aae12633eea44.html#gafaa5b186c9e78f53b39aae12633eea44" title="Returns the absolute local filesystem path of a stream URI.">drupal_realpath</a>($file);
<a name="l07989"></a>07989   <span class="keywordflow">if</span> (!is_file($filepath)) {
<a name="l07990"></a>07990     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Archivers can only operate on local files: %file not supported&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $file)));
<a name="l07991"></a>07991   }
<a name="l07992"></a>07992   $archiver_info = <a class="code" href="common_8inc_a15bb26df893f7c8919ab8e4505085028.html#a15bb26df893f7c8919ab8e4505085028" title="Retrieves a list of all available archivers.">archiver_get_info</a>();
<a name="l07993"></a>07993 
<a name="l07994"></a>07994   <span class="keywordflow">foreach</span> ($archiver_info as $implementation) {
<a name="l07995"></a>07995     <span class="keywordflow">foreach</span> ($implementation[<span class="stringliteral">&#39;extensions&#39;</span>] as $extension) {
<a name="l07996"></a>07996       <span class="comment">// Because extensions may be multi-part, such as .tar.gz,</span>
<a name="l07997"></a>07997       <span class="comment">// we cannot use simpler approaches like substr() or pathinfo().</span>
<a name="l07998"></a>07998       <span class="comment">// This method isn&#39;t quite as clean but gets the job done.</span>
<a name="l07999"></a>07999       <span class="comment">// Also note that the file may not yet exist, so we cannot rely</span>
<a name="l08000"></a>08000       <span class="comment">// on fileinfo() or other disk-level utilities.</span>
<a name="l08001"></a>08001       <span class="keywordflow">if</span> (strrpos($filepath, <span class="charliteral">&#39;.&#39;</span> . $extension) === strlen($filepath) - strlen(<span class="charliteral">&#39;.&#39;</span> . $extension)) {
<a name="l08002"></a>08002         <span class="keywordflow">return</span> <span class="keyword">new</span> $implementation[<span class="stringliteral">&#39;class&#39;</span>]($filepath);
<a name="l08003"></a>08003       }
<a name="l08004"></a>08004     }
<a name="l08005"></a>08005   }
<a name="l08006"></a>08006 }
<a name="l08007"></a>08007 
<a name="l08021"></a><a class="code" href="common_8inc_a0fa53aa7b4cdefaccb5283da37ad75df.html#a0fa53aa7b4cdefaccb5283da37ad75df">08021</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a0fa53aa7b4cdefaccb5283da37ad75df.html#a0fa53aa7b4cdefaccb5283da37ad75df" title="Assembles the Drupal Updater registry.">drupal_get_updaters</a>() {
<a name="l08022"></a>08022   $updaters = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__);
<a name="l08023"></a>08023   <span class="keywordflow">if</span> (!isset($updaters)) {
<a name="l08024"></a>08024     $updaters = <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;updater_info&#39;</span>);
<a name="l08025"></a>08025     <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;updater_info&#39;</span>, $updaters);
<a name="l08026"></a>08026     uasort($updaters, <span class="stringliteral">&#39;drupal_sort_weight&#39;</span>);
<a name="l08027"></a>08027   }
<a name="l08028"></a>08028   <span class="keywordflow">return</span> $updaters;
<a name="l08029"></a>08029 }
<a name="l08030"></a>08030 
<a name="l08041"></a><a class="code" href="common_8inc_a9530d4fd3eee97770ebaaa5103d24bf4.html#a9530d4fd3eee97770ebaaa5103d24bf4">08041</a> <span class="keyword">function</span> <a class="code" href="common_8inc_a9530d4fd3eee97770ebaaa5103d24bf4.html#a9530d4fd3eee97770ebaaa5103d24bf4" title="Assembles the Drupal FileTransfer registry.">drupal_get_filetransfer_info</a>() {
<a name="l08042"></a>08042   $info = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__);
<a name="l08043"></a>08043   <span class="keywordflow">if</span> (!isset($info)) {
<a name="l08044"></a>08044     <span class="comment">// Since we have to manually set the &#39;file path&#39; default for each</span>
<a name="l08045"></a>08045     <span class="comment">// module separately, we can&#39;t use module_invoke_all().</span>
<a name="l08046"></a>08046     $info = array();
<a name="l08047"></a>08047     <span class="keywordflow">foreach</span> (<a class="code" href="group__hooks_ga9191200072f2a641829e9d3c2759561f.html#ga9191200072f2a641829e9d3c2759561f" title="Determine which modules are implementing a hook.">module_implements</a>(<span class="stringliteral">&#39;filetransfer_info&#39;</span>) as $module) {
<a name="l08048"></a>08048       $function = $module . <span class="stringliteral">&#39;_filetransfer_info&#39;</span>;
<a name="l08049"></a>08049       <span class="keywordflow">if</span> (function_exists($function)) {
<a name="l08050"></a>08050         $result = $function();
<a name="l08051"></a>08051         <span class="keywordflow">if</span> (isset($result) &amp;&amp; is_array($result)) {
<a name="l08052"></a>08052           <span class="keywordflow">foreach</span> ($result as &amp;$values) {
<a name="l08053"></a>08053             <span class="keywordflow">if</span> (empty($values[<span class="stringliteral">&#39;file path&#39;</span>])) {
<a name="l08054"></a>08054               $values[<span class="stringliteral">&#39;file path&#39;</span>] = <a class="code" href="common_8inc_ae3bbe8f97bf07bb0eaf4580c98f9bf94.html#ae3bbe8f97bf07bb0eaf4580c98f9bf94" title="Returns the path to a system item (module, theme, etc.).">drupal_get_path</a>(<span class="stringliteral">&#39;module&#39;</span>, $module);
<a name="l08055"></a>08055             }
<a name="l08056"></a>08056           }
<a name="l08057"></a>08057           $info = array_merge_recursive($info, $result);
<a name="l08058"></a>08058         }
<a name="l08059"></a>08059       }
<a name="l08060"></a>08060     }
<a name="l08061"></a>08061     <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;filetransfer_info&#39;</span>, $info);
<a name="l08062"></a>08062     uasort($info, <span class="stringliteral">&#39;drupal_sort_weight&#39;</span>);
<a name="l08063"></a>08063   }
<a name="l08064"></a>08064   <span class="keywordflow">return</span> $info;
<a name="l08065"></a>08065 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Thu Nov 22 2012 16:46:13 for Shopcart by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>

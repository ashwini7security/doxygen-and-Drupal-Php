<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Shopcart: includes/file.inc Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Shopcart
   &#160;<span id="projectnumber">version2.0</span>
   </div>
   <div id="projectbrief">Shoppingcart</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_5b89693129504707d608c5412e7b88d4.html">includes</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">file.inc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="file_8inc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00015"></a>00015 require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/stream_wrappers.inc&#39;</span>;
<a name="l00016"></a>00016 
<a name="l00041"></a><a class="code" href="group__file_ga851cbf30c0a6d31a1733590cf80c39e5.html#ga851cbf30c0a6d31a1733590cf80c39e5">00041</a> define(<span class="stringliteral">&#39;FILE_CREATE_DIRECTORY&#39;</span>, 1);
<a name="l00042"></a>00042 
<a name="l00046"></a><a class="code" href="group__file_ga30d56f1f9c1a4d832c411ef51d9b276d.html#ga30d56f1f9c1a4d832c411ef51d9b276d">00046</a> define(<span class="stringliteral">&#39;FILE_MODIFY_PERMISSIONS&#39;</span>, 2);
<a name="l00047"></a>00047 
<a name="l00051"></a><a class="code" href="group__file_ga5d6636d4ccd022885823b91f17a0f464.html#ga5d6636d4ccd022885823b91f17a0f464">00051</a> define(<span class="stringliteral">&#39;FILE_EXISTS_RENAME&#39;</span>, 0);
<a name="l00052"></a>00052 
<a name="l00056"></a><a class="code" href="group__file_ga54c3c90d9cb7857114326cb5114e7159.html#ga54c3c90d9cb7857114326cb5114e7159">00056</a> define(<span class="stringliteral">&#39;FILE_EXISTS_REPLACE&#39;</span>, 1);
<a name="l00057"></a>00057 
<a name="l00061"></a><a class="code" href="group__file_ga99e741faa66e03cdb8738b717be227fd.html#ga99e741faa66e03cdb8738b717be227fd">00061</a> define(<span class="stringliteral">&#39;FILE_EXISTS_ERROR&#39;</span>, 2);
<a name="l00062"></a>00062 
<a name="l00070"></a><a class="code" href="group__file_gaf208a7c7d7fd09276233583b22e4ee32.html#gaf208a7c7d7fd09276233583b22e4ee32">00070</a> define(<span class="stringliteral">&#39;FILE_STATUS_PERMANENT&#39;</span>, 1);
<a name="l00071"></a>00071 
<a name="l00123"></a><a class="code" href="group__file_ga0cd34cfd1bacb36b8ff82d01fb9a6f79.html#ga0cd34cfd1bacb36b8ff82d01fb9a6f79">00123</a> <span class="keyword">function</span> <a class="code" href="group__file_ga0cd34cfd1bacb36b8ff82d01fb9a6f79.html#ga0cd34cfd1bacb36b8ff82d01fb9a6f79" title="Provides Drupal stream wrapper registry.">file_get_stream_wrappers</a>($filter = <a class="code" href="stream__wrappers_8inc_aa396b3c5df01b437c006cf7ee9674f66.html#aa396b3c5df01b437c006cf7ee9674f66" title="Stream wrapper bit flags that are the basis for composite types.">STREAM_WRAPPERS_ALL</a>) {
<a name="l00124"></a>00124   $wrappers_storage = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__);
<a name="l00125"></a>00125 
<a name="l00126"></a>00126   <span class="keywordflow">if</span> (!isset($wrappers_storage)) {
<a name="l00127"></a>00127     $wrappers = <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;stream_wrappers&#39;</span>);
<a name="l00128"></a>00128     <span class="keywordflow">foreach</span> ($wrappers as $scheme =&gt; $info) {
<a name="l00129"></a>00129       <span class="comment">// Add defaults.</span>
<a name="l00130"></a>00130       $wrappers[$scheme] += array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <a class="code" href="stream__wrappers_8inc_a36f5ace0de0c330620586d4f92e9774d.html#a36f5ace0de0c330620586d4f92e9774d" title="Stream wrapper type flag -- the default when &#39;type&#39; is omitted from hook_stream_wrappers().">STREAM_WRAPPERS_NORMAL</a>);
<a name="l00131"></a>00131     }
<a name="l00132"></a>00132     <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;stream_wrappers&#39;</span>, $wrappers);
<a name="l00133"></a>00133     $existing = stream_get_wrappers();
<a name="l00134"></a>00134     <span class="keywordflow">foreach</span> ($wrappers as $scheme =&gt; $info) {
<a name="l00135"></a>00135       <span class="comment">// We only register classes that implement our interface.</span>
<a name="l00136"></a>00136       <span class="keywordflow">if</span> (in_array(<span class="stringliteral">&#39;DrupalStreamWrapperInterface&#39;</span>, class_implements($info[<span class="stringliteral">&#39;class&#39;</span>]), TRUE)) {
<a name="l00137"></a>00137         <span class="comment">// Record whether we are overriding an existing scheme.</span>
<a name="l00138"></a>00138         <span class="keywordflow">if</span> (in_array($scheme, $existing, TRUE)) {
<a name="l00139"></a>00139           $wrappers[$scheme][<span class="stringliteral">&#39;override&#39;</span>] = TRUE;
<a name="l00140"></a>00140           stream_wrapper_unregister($scheme);
<a name="l00141"></a>00141         }
<a name="l00142"></a>00142         <span class="keywordflow">else</span> {
<a name="l00143"></a>00143           $wrappers[$scheme][<span class="stringliteral">&#39;override&#39;</span>] = FALSE;
<a name="l00144"></a>00144         }
<a name="l00145"></a>00145         <span class="keywordflow">if</span> (($info[<span class="stringliteral">&#39;type&#39;</span>] &amp; <a class="code" href="stream__wrappers_8inc_a39ccf9b3cad23926ae87f5c5e9d9f05d.html#a39ccf9b3cad23926ae87f5c5e9d9f05d" title="Stream wrapper bit flag -- refers to a local file system location.">STREAM_WRAPPERS_LOCAL</a>) == STREAM_WRAPPERS_LOCAL) {
<a name="l00146"></a>00146           stream_wrapper_register($scheme, $info[<span class="stringliteral">&#39;class&#39;</span>]);
<a name="l00147"></a>00147         }
<a name="l00148"></a>00148         <span class="keywordflow">else</span> {
<a name="l00149"></a>00149           stream_wrapper_register($scheme, $info[<span class="stringliteral">&#39;class&#39;</span>], STREAM_IS_URL);
<a name="l00150"></a>00150         }
<a name="l00151"></a>00151       }
<a name="l00152"></a>00152       <span class="comment">// Pre-populate the static cache with the filters most typically used.</span>
<a name="l00153"></a>00153       $wrappers_storage[<a class="code" href="stream__wrappers_8inc_aa396b3c5df01b437c006cf7ee9674f66.html#aa396b3c5df01b437c006cf7ee9674f66" title="Stream wrapper bit flags that are the basis for composite types.">STREAM_WRAPPERS_ALL</a>][$scheme] = $wrappers[$scheme];
<a name="l00154"></a>00154       <span class="keywordflow">if</span> (($info[<span class="stringliteral">&#39;type&#39;</span>] &amp; <a class="code" href="stream__wrappers_8inc_af9258db142c2bc34a37fb4797367e30f.html#af9258db142c2bc34a37fb4797367e30f" title="Stream wrapper type flag -- visible, readable and writeable.">STREAM_WRAPPERS_WRITE_VISIBLE</a>) == STREAM_WRAPPERS_WRITE_VISIBLE) {
<a name="l00155"></a>00155         $wrappers_storage[<a class="code" href="stream__wrappers_8inc_af9258db142c2bc34a37fb4797367e30f.html#af9258db142c2bc34a37fb4797367e30f" title="Stream wrapper type flag -- visible, readable and writeable.">STREAM_WRAPPERS_WRITE_VISIBLE</a>][$scheme] = $wrappers[$scheme];
<a name="l00156"></a>00156       }
<a name="l00157"></a>00157     }
<a name="l00158"></a>00158   }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160   <span class="keywordflow">if</span> (!isset($wrappers_storage[$filter])) {
<a name="l00161"></a>00161     $wrappers_storage[$filter] = array();
<a name="l00162"></a>00162     <span class="keywordflow">foreach</span> ($wrappers_storage[<a class="code" href="stream__wrappers_8inc_aa396b3c5df01b437c006cf7ee9674f66.html#aa396b3c5df01b437c006cf7ee9674f66" title="Stream wrapper bit flags that are the basis for composite types.">STREAM_WRAPPERS_ALL</a>] as $scheme =&gt; $info) {
<a name="l00163"></a>00163       <span class="comment">// Bit-wise filter.</span>
<a name="l00164"></a>00164       <span class="keywordflow">if</span> (($info[<span class="stringliteral">&#39;type&#39;</span>] &amp; $filter) == $filter) {
<a name="l00165"></a>00165         $wrappers_storage[$filter][$scheme] = $info;
<a name="l00166"></a>00166       }
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168   }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170   <span class="keywordflow">return</span> $wrappers_storage[$filter];
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00182"></a><a class="code" href="group__file_gaa31faf56baba0315a1867e2c1cc2b842.html#gaa31faf56baba0315a1867e2c1cc2b842">00182</a> <span class="keyword">function</span> <a class="code" href="group__file_gaa31faf56baba0315a1867e2c1cc2b842.html#gaa31faf56baba0315a1867e2c1cc2b842" title="Returns the stream wrapper class name for a given scheme.">file_stream_wrapper_get_class</a>($scheme) {
<a name="l00183"></a>00183   $wrappers = <a class="code" href="group__file_ga0cd34cfd1bacb36b8ff82d01fb9a6f79.html#ga0cd34cfd1bacb36b8ff82d01fb9a6f79" title="Provides Drupal stream wrapper registry.">file_get_stream_wrappers</a>();
<a name="l00184"></a>00184   <span class="keywordflow">return</span> empty($wrappers[$scheme]) ? FALSE : $wrappers[$scheme][<span class="stringliteral">&#39;class&#39;</span>];
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00199"></a><a class="code" href="group__file_gaa98f967fe1033030e7e5262adda85463.html#gaa98f967fe1033030e7e5262adda85463">00199</a> <span class="keyword">function</span> <a class="code" href="group__file_gaa98f967fe1033030e7e5262adda85463.html#gaa98f967fe1033030e7e5262adda85463" title="Returns the scheme of a URI (e.g.">file_uri_scheme</a>($uri) {
<a name="l00200"></a>00200   $position = strpos($uri, <span class="stringliteral">&#39;://&#39;</span>);
<a name="l00201"></a>00201   <span class="keywordflow">return</span> $position ? substr($uri, 0, $position) : FALSE;
<a name="l00202"></a>00202 }
<a name="l00203"></a>00203 
<a name="l00218"></a><a class="code" href="group__file_ga12aebc3c6a9eb56d08511e7b968d0cef.html#ga12aebc3c6a9eb56d08511e7b968d0cef">00218</a> <span class="keyword">function</span> <a class="code" href="group__file_ga12aebc3c6a9eb56d08511e7b968d0cef.html#ga12aebc3c6a9eb56d08511e7b968d0cef" title="Checks that the scheme of a stream URI is valid.">file_stream_wrapper_valid_scheme</a>($scheme) {
<a name="l00219"></a>00219   <span class="comment">// Does the scheme have a registered handler that is callable?</span>
<a name="l00220"></a>00220   $class = <a class="code" href="group__file_gaa31faf56baba0315a1867e2c1cc2b842.html#gaa31faf56baba0315a1867e2c1cc2b842" title="Returns the stream wrapper class name for a given scheme.">file_stream_wrapper_get_class</a>($scheme);
<a name="l00221"></a>00221   <span class="keywordflow">if</span> (class_exists($class)) {
<a name="l00222"></a>00222     <span class="keywordflow">return</span> TRUE;
<a name="l00223"></a>00223   }
<a name="l00224"></a>00224   <span class="keywordflow">else</span> {
<a name="l00225"></a>00225     <span class="keywordflow">return</span> FALSE;
<a name="l00226"></a>00226   }
<a name="l00227"></a>00227 }
<a name="l00228"></a>00228 
<a name="l00229"></a>00229 
<a name="l00243"></a><a class="code" href="group__file_ga3137c530a505bcbaaeff3c4265f3f662.html#ga3137c530a505bcbaaeff3c4265f3f662">00243</a> <span class="keyword">function</span> <a class="code" href="group__file_ga3137c530a505bcbaaeff3c4265f3f662.html#ga3137c530a505bcbaaeff3c4265f3f662" title="Returns the part of a URI after the schema.">file_uri_target</a>($uri) {
<a name="l00244"></a>00244   $data = explode(<span class="stringliteral">&#39;://&#39;</span>, $uri, 2);
<a name="l00245"></a>00245 
<a name="l00246"></a>00246   <span class="comment">// Remove erroneous leading or trailing, forward-slashes and backslashes.</span>
<a name="l00247"></a>00247   <span class="keywordflow">return</span> count($data) == 2 ? trim($data[1], <span class="charliteral">&#39;\/&#39;</span>) : FALSE;
<a name="l00248"></a>00248 }
<a name="l00249"></a>00249 
<a name="l00256"></a><a class="code" href="group__file_ga360bf8899ace3c977d257510651a763d.html#ga360bf8899ace3c977d257510651a763d">00256</a> <span class="keyword">function</span> <a class="code" href="group__file_ga360bf8899ace3c977d257510651a763d.html#ga360bf8899ace3c977d257510651a763d" title="Gets the default file stream implementation.">file_default_scheme</a>() {
<a name="l00257"></a>00257   <span class="keywordflow">return</span> <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;file_default_scheme&#39;</span>, <span class="stringliteral">&#39;public&#39;</span>);
<a name="l00258"></a>00258 }
<a name="l00259"></a>00259 
<a name="l00275"></a><a class="code" href="group__file_gafd9a522999855ed89191e4e58bbbfeb3.html#gafd9a522999855ed89191e4e58bbbfeb3">00275</a> <span class="keyword">function</span> <a class="code" href="group__file_gafd9a522999855ed89191e4e58bbbfeb3.html#gafd9a522999855ed89191e4e58bbbfeb3" title="Normalizes a URI by making it syntactically correct.">file_stream_wrapper_uri_normalize</a>($uri) {
<a name="l00276"></a>00276   $scheme = <a class="code" href="group__file_gaa98f967fe1033030e7e5262adda85463.html#gaa98f967fe1033030e7e5262adda85463" title="Returns the scheme of a URI (e.g.">file_uri_scheme</a>($uri);
<a name="l00277"></a>00277 
<a name="l00278"></a>00278   <span class="keywordflow">if</span> ($scheme &amp;&amp; <a class="code" href="group__file_ga12aebc3c6a9eb56d08511e7b968d0cef.html#ga12aebc3c6a9eb56d08511e7b968d0cef" title="Checks that the scheme of a stream URI is valid.">file_stream_wrapper_valid_scheme</a>($scheme)) {
<a name="l00279"></a>00279     $target = <a class="code" href="group__file_ga3137c530a505bcbaaeff3c4265f3f662.html#ga3137c530a505bcbaaeff3c4265f3f662" title="Returns the part of a URI after the schema.">file_uri_target</a>($uri);
<a name="l00280"></a>00280 
<a name="l00281"></a>00281     <span class="keywordflow">if</span> ($target !== FALSE) {
<a name="l00282"></a>00282       $uri = $scheme . <span class="stringliteral">&#39;://&#39;</span> . $target;
<a name="l00283"></a>00283     }
<a name="l00284"></a>00284   }
<a name="l00285"></a>00285   <span class="keywordflow">else</span> {
<a name="l00286"></a>00286     <span class="comment">// The default scheme is file://</span>
<a name="l00287"></a>00287     $url = <span class="stringliteral">&#39;file://&#39;</span> . $uri;
<a name="l00288"></a>00288   }
<a name="l00289"></a>00289   <span class="keywordflow">return</span> $uri;
<a name="l00290"></a>00290 }
<a name="l00291"></a>00291 
<a name="l00307"></a><a class="code" href="group__file_ga2a693e908e5d4764c56f60b94070a635.html#ga2a693e908e5d4764c56f60b94070a635">00307</a> <span class="keyword">function</span> <a class="code" href="group__file_ga2a693e908e5d4764c56f60b94070a635.html#ga2a693e908e5d4764c56f60b94070a635" title="Returns a reference to the stream wrapper class responsible for a given URI.">file_stream_wrapper_get_instance_by_uri</a>($uri) {
<a name="l00308"></a>00308   $scheme = <a class="code" href="group__file_gaa98f967fe1033030e7e5262adda85463.html#gaa98f967fe1033030e7e5262adda85463" title="Returns the scheme of a URI (e.g.">file_uri_scheme</a>($uri);
<a name="l00309"></a>00309   $class = <a class="code" href="group__file_gaa31faf56baba0315a1867e2c1cc2b842.html#gaa31faf56baba0315a1867e2c1cc2b842" title="Returns the stream wrapper class name for a given scheme.">file_stream_wrapper_get_class</a>($scheme);
<a name="l00310"></a>00310   <span class="keywordflow">if</span> (class_exists($class)) {
<a name="l00311"></a>00311     $instance = <span class="keyword">new</span> $class();
<a name="l00312"></a>00312     $instance-&gt;setUri($uri);
<a name="l00313"></a>00313     <span class="keywordflow">return</span> $instance;
<a name="l00314"></a>00314   }
<a name="l00315"></a>00315   <span class="keywordflow">else</span> {
<a name="l00316"></a>00316     <span class="keywordflow">return</span> FALSE;
<a name="l00317"></a>00317   }
<a name="l00318"></a>00318 }
<a name="l00319"></a>00319 
<a name="l00340"></a><a class="code" href="group__file_ga6b037293e4cfecbabbd8db32191778a5.html#ga6b037293e4cfecbabbd8db32191778a5">00340</a> <span class="keyword">function</span> <a class="code" href="group__file_ga6b037293e4cfecbabbd8db32191778a5.html#ga6b037293e4cfecbabbd8db32191778a5" title="Returns a reference to the stream wrapper class responsible for a scheme.">file_stream_wrapper_get_instance_by_scheme</a>($scheme) {
<a name="l00341"></a>00341   $class = <a class="code" href="group__file_gaa31faf56baba0315a1867e2c1cc2b842.html#gaa31faf56baba0315a1867e2c1cc2b842" title="Returns the stream wrapper class name for a given scheme.">file_stream_wrapper_get_class</a>($scheme);
<a name="l00342"></a>00342   <span class="keywordflow">if</span> (class_exists($class)) {
<a name="l00343"></a>00343     $instance = <span class="keyword">new</span> $class();
<a name="l00344"></a>00344     $instance-&gt;setUri($scheme . <span class="stringliteral">&#39;://&#39;</span>);
<a name="l00345"></a>00345     <span class="keywordflow">return</span> $instance;
<a name="l00346"></a>00346   }
<a name="l00347"></a>00347   <span class="keywordflow">else</span> {
<a name="l00348"></a>00348     <span class="keywordflow">return</span> FALSE;
<a name="l00349"></a>00349   }
<a name="l00350"></a>00350 }
<a name="l00351"></a>00351 
<a name="l00376"></a><a class="code" href="group__file_gaee57f47d60bda90961a2e19d580d4908.html#gaee57f47d60bda90961a2e19d580d4908">00376</a> <span class="keyword">function</span> <a class="code" href="group__file_gaee57f47d60bda90961a2e19d580d4908.html#gaee57f47d60bda90961a2e19d580d4908" title="Creates a web-accessible URL for a stream to an external or local file.">file_create_url</a>($uri) {
<a name="l00377"></a>00377   <span class="comment">// Allow the URI to be altered, e.g. to serve a file from a CDN or static</span>
<a name="l00378"></a>00378   <span class="comment">// file server.</span>
<a name="l00379"></a>00379   <a class="code" href="module_8inc_a9badfa1d68b90764aa160aee0e58b4ef.html#a9badfa1d68b90764aa160aee0e58b4ef" title="Hands off alterable variables to type-specific *_alter implementations.">drupal_alter</a>(<span class="stringliteral">&#39;file_url&#39;</span>, $uri);
<a name="l00380"></a>00380 
<a name="l00381"></a>00381   $scheme = <a class="code" href="group__file_gaa98f967fe1033030e7e5262adda85463.html#gaa98f967fe1033030e7e5262adda85463" title="Returns the scheme of a URI (e.g.">file_uri_scheme</a>($uri);
<a name="l00382"></a>00382 
<a name="l00383"></a>00383   <span class="keywordflow">if</span> (!$scheme) {
<a name="l00384"></a>00384     <span class="comment">// Allow for:</span>
<a name="l00385"></a>00385     <span class="comment">// - root-relative URIs (e.g. /foo.jpg in http://example.com/foo.jpg)</span>
<a name="l00386"></a>00386     <span class="comment">// - protocol-relative URIs (e.g. //bar.jpg, which is expanded to</span>
<a name="l00387"></a>00387     <span class="comment">//   http://example.com/bar.jpg by the browser when viewing a page over</span>
<a name="l00388"></a>00388     <span class="comment">//   HTTP and to https://example.com/bar.jpg when viewing a HTTPS page)</span>
<a name="l00389"></a>00389     <span class="comment">// Both types of relative URIs are characterized by a leading slash, hence</span>
<a name="l00390"></a>00390     <span class="comment">// we can use a single check.</span>
<a name="l00391"></a>00391     <span class="keywordflow">if</span> (<a class="code" href="group__php__wrappers_gabe05f7e9107211f3ad82b564b1d7d598.html#gabe05f7e9107211f3ad82b564b1d7d598" title="Cut off a piece of a string based on character indices and counts.">drupal_substr</a>($uri, 0, 1) == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00392"></a>00392       <span class="keywordflow">return</span> $uri;
<a name="l00393"></a>00393     }
<a name="l00394"></a>00394     <span class="keywordflow">else</span> {
<a name="l00395"></a>00395       <span class="comment">// If this is not a properly formatted stream, then it is a shipped file.</span>
<a name="l00396"></a>00396       <span class="comment">// Therefore, return the urlencoded URI with the base URL prepended.</span>
<a name="l00397"></a>00397       <span class="keywordflow">return</span> $GLOBALS[<span class="stringliteral">&#39;base_url&#39;</span>] . <span class="charliteral">&#39;/&#39;</span> . <a class="code" href="group__http__handling_gab333a51385bd4e339c464943553a6670.html#gab333a51385bd4e339c464943553a6670" title="Encodes a Drupal path for use in a URL.">drupal_encode_path</a>($uri);
<a name="l00398"></a>00398     }
<a name="l00399"></a>00399   }
<a name="l00400"></a>00400   elseif ($scheme == <span class="stringliteral">&#39;http&#39;</span> || $scheme == <span class="stringliteral">&#39;https&#39;</span>) {
<a name="l00401"></a>00401     <span class="comment">// Check for http so that we don&#39;t have to implement getExternalUrl() for</span>
<a name="l00402"></a>00402     <span class="comment">// the http wrapper.</span>
<a name="l00403"></a>00403     <span class="keywordflow">return</span> $uri;
<a name="l00404"></a>00404   }
<a name="l00405"></a>00405   <span class="keywordflow">else</span> {
<a name="l00406"></a>00406     <span class="comment">// Attempt to return an external URL using the appropriate wrapper.</span>
<a name="l00407"></a>00407     <span class="keywordflow">if</span> ($wrapper = <a class="code" href="group__file_ga2a693e908e5d4764c56f60b94070a635.html#ga2a693e908e5d4764c56f60b94070a635" title="Returns a reference to the stream wrapper class responsible for a given URI.">file_stream_wrapper_get_instance_by_uri</a>($uri)) {
<a name="l00408"></a>00408       <span class="keywordflow">return</span> $wrapper-&gt;getExternalUrl();
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410     <span class="keywordflow">else</span> {
<a name="l00411"></a>00411       <span class="keywordflow">return</span> FALSE;
<a name="l00412"></a>00412     }
<a name="l00413"></a>00413   }
<a name="l00414"></a>00414 }
<a name="l00415"></a>00415 
<a name="l00434"></a><a class="code" href="group__file_ga738f89421a4f4c228676de817e5e485c.html#ga738f89421a4f4c228676de817e5e485c">00434</a> <span class="keyword">function</span> <a class="code" href="group__file_ga738f89421a4f4c228676de817e5e485c.html#ga738f89421a4f4c228676de817e5e485c" title="Checks that the directory exists and is writable.">file_prepare_directory</a>(&amp;$directory, $options = <a class="code" href="group__file_ga30d56f1f9c1a4d832c411ef51d9b276d.html#ga30d56f1f9c1a4d832c411ef51d9b276d" title="Flag used by file_prepare_directory() -- file permissions may be changed.">FILE_MODIFY_PERMISSIONS</a>) {
<a name="l00435"></a>00435   <span class="keywordflow">if</span> (!<a class="code" href="group__file_ga12aebc3c6a9eb56d08511e7b968d0cef.html#ga12aebc3c6a9eb56d08511e7b968d0cef" title="Checks that the scheme of a stream URI is valid.">file_stream_wrapper_valid_scheme</a>(<a class="code" href="group__file_gaa98f967fe1033030e7e5262adda85463.html#gaa98f967fe1033030e7e5262adda85463" title="Returns the scheme of a URI (e.g.">file_uri_scheme</a>($directory))) {
<a name="l00436"></a>00436     <span class="comment">// Only trim if we&#39;re not dealing with a stream.</span>
<a name="l00437"></a>00437     $directory = rtrim($directory, <span class="stringliteral">&#39;/\\&#39;</span>);
<a name="l00438"></a>00438   }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440   <span class="comment">// Check if directory exists.</span>
<a name="l00441"></a>00441   <span class="keywordflow">if</span> (!is_dir($directory)) {
<a name="l00442"></a>00442     <span class="comment">// Let mkdir() recursively create directories and use the default directory</span>
<a name="l00443"></a>00443     <span class="comment">// permissions.</span>
<a name="l00444"></a>00444     <span class="keywordflow">if</span> (($options &amp; <a class="code" href="group__file_ga851cbf30c0a6d31a1733590cf80c39e5.html#ga851cbf30c0a6d31a1733590cf80c39e5" title="Flag used by file_prepare_directory() -- create directory if not present.">FILE_CREATE_DIRECTORY</a>) &amp;&amp; @<a class="code" href="group__php__wrappers_ga0cd03adb94eea525f87fb061c9a33340.html#ga0cd03adb94eea525f87fb061c9a33340" title="Creates a directory using Drupal&#39;s default mode.">drupal_mkdir</a>($directory, NULL, TRUE)) {
<a name="l00445"></a>00445       <span class="keywordflow">return</span> <a class="code" href="group__php__wrappers_ga5fc93f1c4e81ea4f5b1b32775fca489c.html#ga5fc93f1c4e81ea4f5b1b32775fca489c" title="Sets the permissions on a file or directory.">drupal_chmod</a>($directory);
<a name="l00446"></a>00446     }
<a name="l00447"></a>00447     <span class="keywordflow">return</span> FALSE;
<a name="l00448"></a>00448   }
<a name="l00449"></a>00449   <span class="comment">// The directory exists, so check to see if it is writable.</span>
<a name="l00450"></a>00450   $writable = is_writable($directory);
<a name="l00451"></a>00451   <span class="keywordflow">if</span> (!$writable &amp;&amp; ($options &amp; <a class="code" href="group__file_ga30d56f1f9c1a4d832c411ef51d9b276d.html#ga30d56f1f9c1a4d832c411ef51d9b276d" title="Flag used by file_prepare_directory() -- file permissions may be changed.">FILE_MODIFY_PERMISSIONS</a>)) {
<a name="l00452"></a>00452     <span class="keywordflow">return</span> <a class="code" href="group__php__wrappers_ga5fc93f1c4e81ea4f5b1b32775fca489c.html#ga5fc93f1c4e81ea4f5b1b32775fca489c" title="Sets the permissions on a file or directory.">drupal_chmod</a>($directory);
<a name="l00453"></a>00453   }
<a name="l00454"></a>00454 
<a name="l00455"></a>00455   <span class="keywordflow">return</span> $writable;
<a name="l00456"></a>00456 }
<a name="l00457"></a>00457 
<a name="l00461"></a><a class="code" href="group__file_gabb0ecbecf4cff451bd30a4bbc3e2d57f.html#gabb0ecbecf4cff451bd30a4bbc3e2d57f">00461</a> <span class="keyword">function</span> <a class="code" href="group__file_gabb0ecbecf4cff451bd30a4bbc3e2d57f.html#gabb0ecbecf4cff451bd30a4bbc3e2d57f" title="Creates a .htaccess file in each Drupal files directory if it is missing.">file_ensure_htaccess</a>() {
<a name="l00462"></a>00462   <a class="code" href="group__file_gaf30766eaa4c080c8d61a9aa0cf89739b.html#gaf30766eaa4c080c8d61a9aa0cf89739b" title="Creates a .htaccess file in the given directory.">file_create_htaccess</a>(<span class="stringliteral">&#39;public://&#39;</span>, FALSE);
<a name="l00463"></a>00463   <span class="keywordflow">if</span> (<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;file_private_path&#39;</span>, FALSE)) {
<a name="l00464"></a>00464     <a class="code" href="group__file_gaf30766eaa4c080c8d61a9aa0cf89739b.html#gaf30766eaa4c080c8d61a9aa0cf89739b" title="Creates a .htaccess file in the given directory.">file_create_htaccess</a>(<span class="stringliteral">&#39;private://&#39;</span>, TRUE);
<a name="l00465"></a>00465   }
<a name="l00466"></a>00466   <a class="code" href="group__file_gaf30766eaa4c080c8d61a9aa0cf89739b.html#gaf30766eaa4c080c8d61a9aa0cf89739b" title="Creates a .htaccess file in the given directory.">file_create_htaccess</a>(<span class="stringliteral">&#39;temporary://&#39;</span>, TRUE);
<a name="l00467"></a>00467 }
<a name="l00468"></a>00468 
<a name="l00478"></a><a class="code" href="group__file_gaf30766eaa4c080c8d61a9aa0cf89739b.html#gaf30766eaa4c080c8d61a9aa0cf89739b">00478</a> <span class="keyword">function</span> <a class="code" href="group__file_gaf30766eaa4c080c8d61a9aa0cf89739b.html#gaf30766eaa4c080c8d61a9aa0cf89739b" title="Creates a .htaccess file in the given directory.">file_create_htaccess</a>($directory, $private = TRUE) {
<a name="l00479"></a>00479   <span class="keywordflow">if</span> (<a class="code" href="group__file_gaa98f967fe1033030e7e5262adda85463.html#gaa98f967fe1033030e7e5262adda85463" title="Returns the scheme of a URI (e.g.">file_uri_scheme</a>($directory)) {
<a name="l00480"></a>00480     $directory = <a class="code" href="group__file_gafd9a522999855ed89191e4e58bbbfeb3.html#gafd9a522999855ed89191e4e58bbbfeb3" title="Normalizes a URI by making it syntactically correct.">file_stream_wrapper_uri_normalize</a>($directory);
<a name="l00481"></a>00481   }
<a name="l00482"></a>00482   <span class="keywordflow">else</span> {
<a name="l00483"></a>00483     $directory = rtrim($directory, <span class="stringliteral">&#39;/\\&#39;</span>);
<a name="l00484"></a>00484   }
<a name="l00485"></a>00485   $htaccess_path =  $directory . <span class="stringliteral">&#39;/.htaccess&#39;</span>;
<a name="l00486"></a>00486 
<a name="l00487"></a>00487   <span class="keywordflow">if</span> (file_exists($htaccess_path)) {
<a name="l00488"></a>00488     <span class="comment">// Short circuit if the .htaccess file already exists.</span>
<a name="l00489"></a>00489     <span class="keywordflow">return</span>;
<a name="l00490"></a>00490   }
<a name="l00491"></a>00491 
<a name="l00492"></a>00492   <span class="keywordflow">if</span> ($private) {
<a name="l00493"></a>00493     <span class="comment">// Private .htaccess file.</span>
<a name="l00494"></a>00494     $htaccess_lines = <span class="stringliteral">&quot;SetHandler Drupal_Security_Do_Not_Remove_See_SA_2006_006\nDeny from all\nOptions None\nOptions +FollowSymLinks&quot;</span>;
<a name="l00495"></a>00495   }
<a name="l00496"></a>00496   <span class="keywordflow">else</span> {
<a name="l00497"></a>00497     <span class="comment">// Public .htaccess file.</span>
<a name="l00498"></a>00498     $htaccess_lines = <span class="stringliteral">&quot;SetHandler Drupal_Security_Do_Not_Remove_See_SA_2006_006\nOptions None\nOptions +FollowSymLinks&quot;</span>;
<a name="l00499"></a>00499   }
<a name="l00500"></a>00500 
<a name="l00501"></a>00501   <span class="comment">// Write the .htaccess file.</span>
<a name="l00502"></a>00502   <span class="keywordflow">if</span> (file_put_contents($htaccess_path, $htaccess_lines)) {
<a name="l00503"></a>00503     <a class="code" href="group__php__wrappers_ga5fc93f1c4e81ea4f5b1b32775fca489c.html#ga5fc93f1c4e81ea4f5b1b32775fca489c" title="Sets the permissions on a file or directory.">drupal_chmod</a>($htaccess_path, 0444);
<a name="l00504"></a>00504   }
<a name="l00505"></a>00505   <span class="keywordflow">else</span> {
<a name="l00506"></a>00506     $variables = array(<span class="stringliteral">&#39;%directory&#39;</span> =&gt; $directory, <span class="stringliteral">&#39;!htaccess&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;br /&gt;&#39;</span> . nl2br(<a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>($htaccess_lines)));
<a name="l00507"></a>00507     <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;security&#39;</span>, <span class="stringliteral">&quot;Security warning: Couldn&#39;t write .htaccess file. Please create a .htaccess file in your %directory directory which contains the following lines: &lt;code&gt;!htaccess&lt;/code&gt;&quot;</span>, $variables, <a class="code" href="group__logging__severity__levels_ga174c9df2936096e11986fcf184d48576.html#ga174c9df2936096e11986fcf184d48576" title="Log message severity -- Error conditions.">WATCHDOG_ERROR</a>);
<a name="l00508"></a>00508   }
<a name="l00509"></a>00509 }
<a name="l00510"></a>00510 
<a name="l00533"></a><a class="code" href="group__file_ga32afa29695b6da3f5d86cad18f063bfc.html#ga32afa29695b6da3f5d86cad18f063bfc">00533</a> <span class="keyword">function</span> <a class="code" href="group__file_ga32afa29695b6da3f5d86cad18f063bfc.html#ga32afa29695b6da3f5d86cad18f063bfc" title="Loads file objects from the database.">file_load_multiple</a>($fids = array(), $conditions = array()) {
<a name="l00534"></a>00534   <span class="keywordflow">return</span> <a class="code" href="common_8inc_a78b89cf93f9710a68d02f86adccf1898.html#a78b89cf93f9710a68d02f86adccf1898" title="Load entities from the database.">entity_load</a>(<span class="stringliteral">&#39;file&#39;</span>, $fids, $conditions);
<a name="l00535"></a>00535 }
<a name="l00536"></a>00536 
<a name="l00549"></a><a class="code" href="group__file_ga138bd2e393c743b41a642003eecbf98f.html#ga138bd2e393c743b41a642003eecbf98f">00549</a> <span class="keyword">function</span> <a class="code" href="group__file_ga138bd2e393c743b41a642003eecbf98f.html#ga138bd2e393c743b41a642003eecbf98f" title="Loads a single file object from the database.">file_load</a>($fid) {
<a name="l00550"></a>00550   $files = <a class="code" href="group__file_ga32afa29695b6da3f5d86cad18f063bfc.html#ga32afa29695b6da3f5d86cad18f063bfc" title="Loads file objects from the database.">file_load_multiple</a>(array($fid), array());
<a name="l00551"></a>00551   <span class="keywordflow">return</span> reset($files);
<a name="l00552"></a>00552 }
<a name="l00553"></a>00553 
<a name="l00568"></a><a class="code" href="group__file_ga80327cb23d8d384b827b2637cd8cc4ba.html#ga80327cb23d8d384b827b2637cd8cc4ba">00568</a> <span class="keyword">function</span> <a class="code" href="group__file_ga80327cb23d8d384b827b2637cd8cc4ba.html#ga80327cb23d8d384b827b2637cd8cc4ba" title="Saves a file object to the database.">file_save</a>(stdClass $file) {
<a name="l00569"></a>00569   $file-&gt;timestamp = <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a>;
<a name="l00570"></a>00570   $file-&gt;filesize = filesize($file-&gt;uri);
<a name="l00571"></a>00571 
<a name="l00572"></a>00572   <span class="comment">// Load the stored entity, if any.</span>
<a name="l00573"></a>00573   <span class="keywordflow">if</span> (!empty($file-&gt;fid) &amp;&amp; !isset($file-&gt;original)) {
<a name="l00574"></a>00574     $file-&gt;original = <a class="code" href="common_8inc_ad6d77695e6a66026389a4a734202b253.html#ad6d77695e6a66026389a4a734202b253" title="Loads the unchanged, i.e.">entity_load_unchanged</a>(<span class="stringliteral">&#39;file&#39;</span>, $file-&gt;fid);
<a name="l00575"></a>00575   }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577   <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;file_presave&#39;</span>, $file);
<a name="l00578"></a>00578   <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;entity_presave&#39;</span>, $file, <span class="stringliteral">&#39;file&#39;</span>);
<a name="l00579"></a>00579 
<a name="l00580"></a>00580   <span class="keywordflow">if</span> (empty($file-&gt;fid)) {
<a name="l00581"></a>00581     <a class="code" href="group__schemaapi_ga96f707de751a962bf21b6cb0cb4f2ae6.html#ga96f707de751a962bf21b6cb0cb4f2ae6" title="Saves (inserts or updates) a record to the database based upon the schema.">drupal_write_record</a>(<span class="stringliteral">&#39;file_managed&#39;</span>, $file);
<a name="l00582"></a>00582     <span class="comment">// Inform modules about the newly added file.</span>
<a name="l00583"></a>00583     <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;file_insert&#39;</span>, $file);
<a name="l00584"></a>00584     <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;entity_insert&#39;</span>, $file, <span class="stringliteral">&#39;file&#39;</span>);
<a name="l00585"></a>00585   }
<a name="l00586"></a>00586   <span class="keywordflow">else</span> {
<a name="l00587"></a>00587     <a class="code" href="group__schemaapi_ga96f707de751a962bf21b6cb0cb4f2ae6.html#ga96f707de751a962bf21b6cb0cb4f2ae6" title="Saves (inserts or updates) a record to the database based upon the schema.">drupal_write_record</a>(<span class="stringliteral">&#39;file_managed&#39;</span>, $file, <span class="stringliteral">&#39;fid&#39;</span>);
<a name="l00588"></a>00588     <span class="comment">// Inform modules that the file has been updated.</span>
<a name="l00589"></a>00589     <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;file_update&#39;</span>, $file);
<a name="l00590"></a>00590     <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;entity_update&#39;</span>, $file, <span class="stringliteral">&#39;file&#39;</span>);
<a name="l00591"></a>00591   }
<a name="l00592"></a>00592 
<a name="l00593"></a>00593   unset($file-&gt;original);
<a name="l00594"></a>00594   <span class="keywordflow">return</span> $file;
<a name="l00595"></a>00595 }
<a name="l00596"></a>00596 
<a name="l00611"></a><a class="code" href="group__file_ga6399c4096559ffbe81cfcb22db782bc4.html#ga6399c4096559ffbe81cfcb22db782bc4">00611</a> <span class="keyword">function</span> <a class="code" href="group__file_ga6399c4096559ffbe81cfcb22db782bc4.html#ga6399c4096559ffbe81cfcb22db782bc4" title="Determines where a file is used.">file_usage_list</a>(stdClass $file) {
<a name="l00612"></a>00612   $result = <a class="code" href="group__database_ga9e030cee657d64e3d8e524c65814cc9f.html#ga9e030cee657d64e3d8e524c65814cc9f" title="Returns a new SelectQuery object for the active database.">db_select</a>(<span class="stringliteral">&#39;file_usage&#39;</span>, <span class="charliteral">&#39;f&#39;</span>)
<a name="l00613"></a>00613     -&gt;fields(<span class="charliteral">&#39;f&#39;</span>, array(<span class="stringliteral">&#39;module&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>, <span class="stringliteral">&#39;id&#39;</span>, <span class="stringliteral">&#39;count&#39;</span>))
<a name="l00614"></a>00614     -&gt;condition(<span class="stringliteral">&#39;fid&#39;</span>, $file-&gt;fid)
<a name="l00615"></a>00615     -&gt;condition(<span class="stringliteral">&#39;count&#39;</span>, 0, <span class="charliteral">&#39;&gt;&#39;</span>)
<a name="l00616"></a>00616     -&gt;execute();
<a name="l00617"></a>00617   $references = array();
<a name="l00618"></a>00618   <span class="keywordflow">foreach</span> ($result as $usage) {
<a name="l00619"></a>00619     $references[$usage-&gt;module][$usage-&gt;type][$usage-&gt;id] = $usage-&gt;count;
<a name="l00620"></a>00620   }
<a name="l00621"></a>00621   <span class="keywordflow">return</span> $references;
<a name="l00622"></a>00622 }
<a name="l00623"></a>00623 
<a name="l00651"></a><a class="code" href="group__file_ga41a98960234fa8f802cfc1c4c769ae05.html#ga41a98960234fa8f802cfc1c4c769ae05">00651</a> <span class="keyword">function</span> <a class="code" href="group__file_ga41a98960234fa8f802cfc1c4c769ae05.html#ga41a98960234fa8f802cfc1c4c769ae05" title="Records that a module is using a file.">file_usage_add</a>(stdClass $file, $module, $type, $id, $count = 1) {
<a name="l00652"></a>00652   <a class="code" href="group__database_ga429c73a1bdc6dbb18c4a4a8a2235beaf.html#ga429c73a1bdc6dbb18c4a4a8a2235beaf" title="Returns a new MergeQuery object for the active database.">db_merge</a>(<span class="stringliteral">&#39;file_usage&#39;</span>)
<a name="l00653"></a>00653     -&gt;key(array(
<a name="l00654"></a>00654       <span class="stringliteral">&#39;fid&#39;</span> =&gt; $file-&gt;fid,
<a name="l00655"></a>00655       <span class="stringliteral">&#39;module&#39;</span> =&gt; $module,
<a name="l00656"></a>00656       <span class="stringliteral">&#39;type&#39;</span> =&gt; $type,
<a name="l00657"></a>00657       <span class="stringliteral">&#39;id&#39;</span> =&gt; $id,
<a name="l00658"></a>00658     ))
<a name="l00659"></a>00659     -&gt;fields(array(<span class="stringliteral">&#39;count&#39;</span> =&gt; $count))
<a name="l00660"></a>00660     -&gt;expression(<span class="stringliteral">&#39;count&#39;</span>, <span class="stringliteral">&#39;count + :count&#39;</span>, array(<span class="stringliteral">&#39;:count&#39;</span> =&gt; $count))
<a name="l00661"></a>00661     -&gt;execute();
<a name="l00662"></a>00662 }
<a name="l00663"></a>00663 
<a name="l00689"></a><a class="code" href="group__file_gaf8562c4494373ec51079bb0999a8ae3a.html#gaf8562c4494373ec51079bb0999a8ae3a">00689</a> <span class="keyword">function</span> <a class="code" href="group__file_gaf8562c4494373ec51079bb0999a8ae3a.html#gaf8562c4494373ec51079bb0999a8ae3a" title="Removes a record to indicate that a module is no longer using a file.">file_usage_delete</a>(stdClass $file, $module, $type = NULL, $id = NULL, $count = 1) {
<a name="l00690"></a>00690   <span class="comment">// Delete rows that have a exact or less value to prevent empty rows.</span>
<a name="l00691"></a>00691   $query = <a class="code" href="group__database_ga72f0ccecc0ba181de16c6e3451150f2c.html#ga72f0ccecc0ba181de16c6e3451150f2c" title="Returns a new DeleteQuery object for the active database.">db_delete</a>(<span class="stringliteral">&#39;file_usage&#39;</span>)
<a name="l00692"></a>00692     -&gt;condition(<span class="stringliteral">&#39;module&#39;</span>, $module)
<a name="l00693"></a>00693     -&gt;condition(<span class="stringliteral">&#39;fid&#39;</span>, $file-&gt;fid);
<a name="l00694"></a>00694   <span class="keywordflow">if</span> ($type &amp;&amp; $id) {
<a name="l00695"></a>00695     $query
<a name="l00696"></a>00696       -&gt;condition(<span class="stringliteral">&#39;type&#39;</span>, $type)
<a name="l00697"></a>00697       -&gt;condition(<span class="stringliteral">&#39;id&#39;</span>, $id);
<a name="l00698"></a>00698   }
<a name="l00699"></a>00699   <span class="keywordflow">if</span> ($count) {
<a name="l00700"></a>00700     $query-&gt;condition(<span class="stringliteral">&#39;count&#39;</span>, $count, <span class="stringliteral">&#39;&lt;=&#39;</span>);
<a name="l00701"></a>00701   }
<a name="l00702"></a>00702   $result = $query-&gt;execute();
<a name="l00703"></a>00703 
<a name="l00704"></a>00704   <span class="comment">// If the row has more than the specified count decrement it by that number.</span>
<a name="l00705"></a>00705   <span class="keywordflow">if</span> (!$result &amp;&amp; $count &gt; 0) {
<a name="l00706"></a>00706     $query = <a class="code" href="group__database_ga40967197ee5d6a23a5c5a77e627067fe.html#ga40967197ee5d6a23a5c5a77e627067fe" title="Returns a new UpdateQuery object for the active database.">db_update</a>(<span class="stringliteral">&#39;file_usage&#39;</span>)
<a name="l00707"></a>00707       -&gt;condition(<span class="stringliteral">&#39;module&#39;</span>, $module)
<a name="l00708"></a>00708       -&gt;condition(<span class="stringliteral">&#39;fid&#39;</span>, $file-&gt;fid);
<a name="l00709"></a>00709     <span class="keywordflow">if</span> ($type &amp;&amp; $id) {
<a name="l00710"></a>00710       $query
<a name="l00711"></a>00711         -&gt;condition(<span class="stringliteral">&#39;type&#39;</span>, $type)
<a name="l00712"></a>00712         -&gt;condition(<span class="stringliteral">&#39;id&#39;</span>, $id);
<a name="l00713"></a>00713     }
<a name="l00714"></a>00714     $query-&gt;expression(<span class="stringliteral">&#39;count&#39;</span>, <span class="stringliteral">&#39;count - :count&#39;</span>, array(<span class="stringliteral">&#39;:count&#39;</span> =&gt; $count));
<a name="l00715"></a>00715     $query-&gt;execute();
<a name="l00716"></a>00716   }
<a name="l00717"></a>00717 }
<a name="l00718"></a>00718 
<a name="l00754"></a><a class="code" href="group__file_gae49a2da7203ef43ae7adcf128d58d860.html#gae49a2da7203ef43ae7adcf128d58d860">00754</a> <span class="keyword">function</span> <a class="code" href="group__file_gae49a2da7203ef43ae7adcf128d58d860.html#gae49a2da7203ef43ae7adcf128d58d860" title="Copies a file to a new location and adds a file record to the database.">file_copy</a>(stdClass $source, $destination = NULL, $replace = <a class="code" href="group__file_ga5d6636d4ccd022885823b91f17a0f464.html#ga5d6636d4ccd022885823b91f17a0f464" title="Flag for dealing with existing files: Appends number until name is unique.">FILE_EXISTS_RENAME</a>) {
<a name="l00755"></a>00755   <span class="keywordflow">if</span> (!<a class="code" href="group__file_gad84d226f677dd5b6e53519026b7de67e.html#gad84d226f677dd5b6e53519026b7de67e" title="Determines whether the URI has a valid scheme for file API operations.">file_valid_uri</a>($destination)) {
<a name="l00756"></a>00756     <span class="keywordflow">if</span> (($realpath = <a class="code" href="group__php__wrappers_gafaa5b186c9e78f53b39aae12633eea44.html#gafaa5b186c9e78f53b39aae12633eea44" title="Returns the absolute local filesystem path of a stream URI.">drupal_realpath</a>($source-&gt;uri)) !== FALSE) {
<a name="l00757"></a>00757       <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;File %file (%realpath) could not be copied, because the destination %destination is invalid. This is often caused by improper use of file_copy() or a missing stream wrapper.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $source-&gt;uri, <span class="stringliteral">&#39;%realpath&#39;</span> =&gt; $realpath, <span class="stringliteral">&#39;%destination&#39;</span> =&gt; $destination));
<a name="l00758"></a>00758     }
<a name="l00759"></a>00759     <span class="keywordflow">else</span> {
<a name="l00760"></a>00760       <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;File %file could not be copied, because the destination %destination is invalid. This is often caused by improper use of file_copy() or a missing stream wrapper.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $source-&gt;uri, <span class="stringliteral">&#39;%destination&#39;</span> =&gt; $destination));
<a name="l00761"></a>00761     }
<a name="l00762"></a>00762     <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The specified file %file could not be copied, because the destination is invalid. More information is available in the system log.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $source-&gt;uri)), <span class="stringliteral">&#39;error&#39;</span>);
<a name="l00763"></a>00763     <span class="keywordflow">return</span> FALSE;
<a name="l00764"></a>00764   }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766   <span class="keywordflow">if</span> ($uri = <a class="code" href="group__file_ga19b0d88682d26b7e5d03cb22ac2af391.html#ga19b0d88682d26b7e5d03cb22ac2af391" title="Copies a file to a new location without invoking the file API.">file_unmanaged_copy</a>($source-&gt;uri, $destination, $replace)) {
<a name="l00767"></a>00767     $file = clone $source;
<a name="l00768"></a>00768     $file-&gt;fid = NULL;
<a name="l00769"></a>00769     $file-&gt;uri = $uri;
<a name="l00770"></a>00770     $file-&gt;filename = <a class="code" href="group__php__wrappers_ga0125d5e205f50be86146a8df58c2bc5f.html#ga0125d5e205f50be86146a8df58c2bc5f" title="Gets the filename from a given path.">drupal_basename</a>($uri);
<a name="l00771"></a>00771     <span class="comment">// If we are replacing an existing file re-use its database record.</span>
<a name="l00772"></a>00772     <span class="keywordflow">if</span> ($replace == <a class="code" href="group__file_ga54c3c90d9cb7857114326cb5114e7159.html#ga54c3c90d9cb7857114326cb5114e7159" title="Flag for dealing with existing files: Replace the existing file.">FILE_EXISTS_REPLACE</a>) {
<a name="l00773"></a>00773       $existing_files = <a class="code" href="group__file_ga32afa29695b6da3f5d86cad18f063bfc.html#ga32afa29695b6da3f5d86cad18f063bfc" title="Loads file objects from the database.">file_load_multiple</a>(array(), array(<span class="stringliteral">&#39;uri&#39;</span> =&gt; $uri));
<a name="l00774"></a>00774       <span class="keywordflow">if</span> (count($existing_files)) {
<a name="l00775"></a>00775         $existing = reset($existing_files);
<a name="l00776"></a>00776         $file-&gt;fid = $existing-&gt;fid;
<a name="l00777"></a>00777         $file-&gt;filename = $existing-&gt;filename;
<a name="l00778"></a>00778       }
<a name="l00779"></a>00779     }
<a name="l00780"></a>00780     <span class="comment">// If we are renaming around an existing file (rather than a directory),</span>
<a name="l00781"></a>00781     <span class="comment">// use its basename for the filename.</span>
<a name="l00782"></a>00782     elseif ($replace == <a class="code" href="group__file_ga5d6636d4ccd022885823b91f17a0f464.html#ga5d6636d4ccd022885823b91f17a0f464" title="Flag for dealing with existing files: Appends number until name is unique.">FILE_EXISTS_RENAME</a> &amp;&amp; is_file($destination)) {
<a name="l00783"></a>00783       $file-&gt;filename = <a class="code" href="group__php__wrappers_ga0125d5e205f50be86146a8df58c2bc5f.html#ga0125d5e205f50be86146a8df58c2bc5f" title="Gets the filename from a given path.">drupal_basename</a>($destination);
<a name="l00784"></a>00784     }
<a name="l00785"></a>00785 
<a name="l00786"></a>00786     $file = <a class="code" href="group__file_ga80327cb23d8d384b827b2637cd8cc4ba.html#ga80327cb23d8d384b827b2637cd8cc4ba" title="Saves a file object to the database.">file_save</a>($file);
<a name="l00787"></a>00787 
<a name="l00788"></a>00788     <span class="comment">// Inform modules that the file has been copied.</span>
<a name="l00789"></a>00789     <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;file_copy&#39;</span>, $file, $source);
<a name="l00790"></a>00790 
<a name="l00791"></a>00791     <span class="keywordflow">return</span> $file;
<a name="l00792"></a>00792   }
<a name="l00793"></a>00793   <span class="keywordflow">return</span> FALSE;
<a name="l00794"></a>00794 }
<a name="l00795"></a>00795 
<a name="l00809"></a><a class="code" href="group__file_gad84d226f677dd5b6e53519026b7de67e.html#gad84d226f677dd5b6e53519026b7de67e">00809</a> <span class="keyword">function</span> <a class="code" href="group__file_gad84d226f677dd5b6e53519026b7de67e.html#gad84d226f677dd5b6e53519026b7de67e" title="Determines whether the URI has a valid scheme for file API operations.">file_valid_uri</a>($uri) {
<a name="l00810"></a>00810   <span class="comment">// Assert that the URI has an allowed scheme. Barepaths are not allowed.</span>
<a name="l00811"></a>00811   $uri_scheme = <a class="code" href="group__file_gaa98f967fe1033030e7e5262adda85463.html#gaa98f967fe1033030e7e5262adda85463" title="Returns the scheme of a URI (e.g.">file_uri_scheme</a>($uri);
<a name="l00812"></a>00812   <span class="keywordflow">if</span> (empty($uri_scheme) || !<a class="code" href="group__file_ga12aebc3c6a9eb56d08511e7b968d0cef.html#ga12aebc3c6a9eb56d08511e7b968d0cef" title="Checks that the scheme of a stream URI is valid.">file_stream_wrapper_valid_scheme</a>($uri_scheme)) {
<a name="l00813"></a>00813     <span class="keywordflow">return</span> FALSE;
<a name="l00814"></a>00814   }
<a name="l00815"></a>00815   <span class="keywordflow">return</span> TRUE;
<a name="l00816"></a>00816 }
<a name="l00817"></a>00817 
<a name="l00852"></a><a class="code" href="group__file_ga19b0d88682d26b7e5d03cb22ac2af391.html#ga19b0d88682d26b7e5d03cb22ac2af391">00852</a> <span class="keyword">function</span> <a class="code" href="group__file_ga19b0d88682d26b7e5d03cb22ac2af391.html#ga19b0d88682d26b7e5d03cb22ac2af391" title="Copies a file to a new location without invoking the file API.">file_unmanaged_copy</a>($source, $destination = NULL, $replace = <a class="code" href="group__file_ga5d6636d4ccd022885823b91f17a0f464.html#ga5d6636d4ccd022885823b91f17a0f464" title="Flag for dealing with existing files: Appends number until name is unique.">FILE_EXISTS_RENAME</a>) {
<a name="l00853"></a>00853   $original_source = $source;
<a name="l00854"></a>00854   $original_destination = $destination;
<a name="l00855"></a>00855 
<a name="l00856"></a>00856   <span class="comment">// Assert that the source file actually exists.</span>
<a name="l00857"></a>00857   <span class="keywordflow">if</span> (!file_exists($source)) {
<a name="l00858"></a>00858     <span class="comment">// @todo Replace drupal_set_message() calls with exceptions instead.</span>
<a name="l00859"></a>00859     <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The specified file %file could not be copied, because no file by that name exists. Please check that you supplied the correct filename.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $original_source)), <span class="stringliteral">&#39;error&#39;</span>);
<a name="l00860"></a>00860     <span class="keywordflow">if</span> (($realpath = <a class="code" href="group__php__wrappers_gafaa5b186c9e78f53b39aae12633eea44.html#gafaa5b186c9e78f53b39aae12633eea44" title="Returns the absolute local filesystem path of a stream URI.">drupal_realpath</a>($original_source)) !== FALSE) {
<a name="l00861"></a>00861       <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;File %file (%realpath) could not be copied because it does not exist.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $original_source, <span class="stringliteral">&#39;%realpath&#39;</span> =&gt; $realpath));
<a name="l00862"></a>00862     }
<a name="l00863"></a>00863     <span class="keywordflow">else</span> {
<a name="l00864"></a>00864       <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;File %file could not be copied because it does not exist.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $original_source));
<a name="l00865"></a>00865     }
<a name="l00866"></a>00866     <span class="keywordflow">return</span> FALSE;
<a name="l00867"></a>00867   }
<a name="l00868"></a>00868 
<a name="l00869"></a>00869   <span class="comment">// Build a destination URI if necessary.</span>
<a name="l00870"></a>00870   <span class="keywordflow">if</span> (!isset($destination)) {
<a name="l00871"></a>00871     $destination = <a class="code" href="group__file_ga6855ddd89be373ff7ea584d2ec66ea9a.html#ga6855ddd89be373ff7ea584d2ec66ea9a" title="Constructs a URI to Drupal&#39;s default files location given a relative path.">file_build_uri</a>(<a class="code" href="group__php__wrappers_ga0125d5e205f50be86146a8df58c2bc5f.html#ga0125d5e205f50be86146a8df58c2bc5f" title="Gets the filename from a given path.">drupal_basename</a>($source));
<a name="l00872"></a>00872   }
<a name="l00873"></a>00873 
<a name="l00874"></a>00874 
<a name="l00875"></a>00875   <span class="comment">// Prepare the destination directory.</span>
<a name="l00876"></a>00876   <span class="keywordflow">if</span> (<a class="code" href="group__file_ga738f89421a4f4c228676de817e5e485c.html#ga738f89421a4f4c228676de817e5e485c" title="Checks that the directory exists and is writable.">file_prepare_directory</a>($destination)) {
<a name="l00877"></a>00877     <span class="comment">// The destination is already a directory, so append the source basename.</span>
<a name="l00878"></a>00878     $destination = <a class="code" href="group__file_gafd9a522999855ed89191e4e58bbbfeb3.html#gafd9a522999855ed89191e4e58bbbfeb3" title="Normalizes a URI by making it syntactically correct.">file_stream_wrapper_uri_normalize</a>($destination . <span class="charliteral">&#39;/&#39;</span> . <a class="code" href="group__php__wrappers_ga0125d5e205f50be86146a8df58c2bc5f.html#ga0125d5e205f50be86146a8df58c2bc5f" title="Gets the filename from a given path.">drupal_basename</a>($source));
<a name="l00879"></a>00879   }
<a name="l00880"></a>00880   <span class="keywordflow">else</span> {
<a name="l00881"></a>00881     <span class="comment">// Perhaps $destination is a dir/file?</span>
<a name="l00882"></a>00882     $dirname = <a class="code" href="group__php__wrappers_gad00418a5880c03f43e5eccfaa62863f6.html#gad00418a5880c03f43e5eccfaa62863f6" title="Gets the name of the directory from a given path.">drupal_dirname</a>($destination);
<a name="l00883"></a>00883     <span class="keywordflow">if</span> (!<a class="code" href="group__file_ga738f89421a4f4c228676de817e5e485c.html#ga738f89421a4f4c228676de817e5e485c" title="Checks that the directory exists and is writable.">file_prepare_directory</a>($dirname)) {
<a name="l00884"></a>00884       <span class="comment">// The destination is not valid.</span>
<a name="l00885"></a>00885       <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;File %file could not be copied, because the destination directory %destination is not configured correctly.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $original_source, <span class="stringliteral">&#39;%destination&#39;</span> =&gt; $dirname));
<a name="l00886"></a>00886       <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The specified file %file could not be copied, because the destination directory is not properly configured. This may be caused by a problem with file or directory permissions. More information is available in the system log.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $original_source)), <span class="stringliteral">&#39;error&#39;</span>);
<a name="l00887"></a>00887       <span class="keywordflow">return</span> FALSE;
<a name="l00888"></a>00888     }
<a name="l00889"></a>00889   }
<a name="l00890"></a>00890 
<a name="l00891"></a>00891   <span class="comment">// Determine whether we can perform this operation based on overwrite rules.</span>
<a name="l00892"></a>00892   $destination = <a class="code" href="group__file_ga3136d98d6189607e6cba12aaff55c66d.html#ga3136d98d6189607e6cba12aaff55c66d" title="Determines the destination path for a file.">file_destination</a>($destination, $replace);
<a name="l00893"></a>00893   <span class="keywordflow">if</span> ($destination === FALSE) {
<a name="l00894"></a>00894     <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The file %file could not be copied because a file by that name already exists in the destination directory.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $original_source)), <span class="stringliteral">&#39;error&#39;</span>);
<a name="l00895"></a>00895     <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;File %file could not be copied because a file by that name already exists in the destination directory (%directory)&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $original_source, <span class="stringliteral">&#39;%destination&#39;</span> =&gt; $destination));
<a name="l00896"></a>00896     <span class="keywordflow">return</span> FALSE;
<a name="l00897"></a>00897   }
<a name="l00898"></a>00898 
<a name="l00899"></a>00899   <span class="comment">// Assert that the source and destination filenames are not the same.</span>
<a name="l00900"></a>00900   $real_source = <a class="code" href="group__php__wrappers_gafaa5b186c9e78f53b39aae12633eea44.html#gafaa5b186c9e78f53b39aae12633eea44" title="Returns the absolute local filesystem path of a stream URI.">drupal_realpath</a>($source);
<a name="l00901"></a>00901   $real_destination = <a class="code" href="group__php__wrappers_gafaa5b186c9e78f53b39aae12633eea44.html#gafaa5b186c9e78f53b39aae12633eea44" title="Returns the absolute local filesystem path of a stream URI.">drupal_realpath</a>($destination);
<a name="l00902"></a>00902   <span class="keywordflow">if</span> ($source == $destination || ($real_source !== FALSE) &amp;&amp; ($real_source == $real_destination)) {
<a name="l00903"></a>00903     <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The specified file %file was not copied because it would overwrite itself.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $source)), <span class="stringliteral">&#39;error&#39;</span>);
<a name="l00904"></a>00904     <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;File %file could not be copied because it would overwrite itself.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $source));
<a name="l00905"></a>00905     <span class="keywordflow">return</span> FALSE;
<a name="l00906"></a>00906   }
<a name="l00907"></a>00907   <span class="comment">// Make sure the .htaccess files are present.</span>
<a name="l00908"></a>00908   <a class="code" href="group__file_gabb0ecbecf4cff451bd30a4bbc3e2d57f.html#gabb0ecbecf4cff451bd30a4bbc3e2d57f" title="Creates a .htaccess file in each Drupal files directory if it is missing.">file_ensure_htaccess</a>();
<a name="l00909"></a>00909   <span class="comment">// Perform the copy operation.</span>
<a name="l00910"></a>00910   <span class="keywordflow">if</span> (!@copy($source, $destination)) {
<a name="l00911"></a>00911     <span class="comment">// If the copy failed and realpaths exist, retry the operation using them</span>
<a name="l00912"></a>00912     <span class="comment">// instead.</span>
<a name="l00913"></a>00913     <span class="keywordflow">if</span> ($real_source === FALSE || $real_destination === FALSE || !@copy($real_source, $real_destination)) {
<a name="l00914"></a>00914       <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;The specified file %file could not be copied to %destination.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $source, <span class="stringliteral">&#39;%destination&#39;</span> =&gt; $destination), <a class="code" href="group__logging__severity__levels_ga174c9df2936096e11986fcf184d48576.html#ga174c9df2936096e11986fcf184d48576" title="Log message severity -- Error conditions.">WATCHDOG_ERROR</a>);
<a name="l00915"></a>00915       <span class="keywordflow">return</span> FALSE;
<a name="l00916"></a>00916     }
<a name="l00917"></a>00917   }
<a name="l00918"></a>00918 
<a name="l00919"></a>00919   <span class="comment">// Set the permissions on the new file.</span>
<a name="l00920"></a>00920   <a class="code" href="group__php__wrappers_ga5fc93f1c4e81ea4f5b1b32775fca489c.html#ga5fc93f1c4e81ea4f5b1b32775fca489c" title="Sets the permissions on a file or directory.">drupal_chmod</a>($destination);
<a name="l00921"></a>00921 
<a name="l00922"></a>00922   <span class="keywordflow">return</span> $destination;
<a name="l00923"></a>00923 }
<a name="l00924"></a>00924 
<a name="l00928"></a><a class="code" href="group__file_ga6855ddd89be373ff7ea584d2ec66ea9a.html#ga6855ddd89be373ff7ea584d2ec66ea9a">00928</a> <span class="keyword">function</span> <a class="code" href="group__file_ga6855ddd89be373ff7ea584d2ec66ea9a.html#ga6855ddd89be373ff7ea584d2ec66ea9a" title="Constructs a URI to Drupal&#39;s default files location given a relative path.">file_build_uri</a>($path) {
<a name="l00929"></a>00929   $uri = <a class="code" href="group__file_ga360bf8899ace3c977d257510651a763d.html#ga360bf8899ace3c977d257510651a763d" title="Gets the default file stream implementation.">file_default_scheme</a>() . <span class="stringliteral">&#39;://&#39;</span> . $path;
<a name="l00930"></a>00930   <span class="keywordflow">return</span> <a class="code" href="group__file_gafd9a522999855ed89191e4e58bbbfeb3.html#gafd9a522999855ed89191e4e58bbbfeb3" title="Normalizes a URI by making it syntactically correct.">file_stream_wrapper_uri_normalize</a>($uri);
<a name="l00931"></a>00931 }
<a name="l00932"></a>00932 
<a name="l00949"></a><a class="code" href="group__file_ga3136d98d6189607e6cba12aaff55c66d.html#ga3136d98d6189607e6cba12aaff55c66d">00949</a> <span class="keyword">function</span> <a class="code" href="group__file_ga3136d98d6189607e6cba12aaff55c66d.html#ga3136d98d6189607e6cba12aaff55c66d" title="Determines the destination path for a file.">file_destination</a>($destination, $replace) {
<a name="l00950"></a>00950   <span class="keywordflow">if</span> (file_exists($destination)) {
<a name="l00951"></a>00951     <span class="keywordflow">switch</span> ($replace) {
<a name="l00952"></a>00952       <span class="keywordflow">case</span> <a class="code" href="group__file_ga54c3c90d9cb7857114326cb5114e7159.html#ga54c3c90d9cb7857114326cb5114e7159" title="Flag for dealing with existing files: Replace the existing file.">FILE_EXISTS_REPLACE</a>:
<a name="l00953"></a>00953         <span class="comment">// Do nothing here, we want to overwrite the existing file.</span>
<a name="l00954"></a>00954         <span class="keywordflow">break</span>;
<a name="l00955"></a>00955 
<a name="l00956"></a>00956       <span class="keywordflow">case</span> <a class="code" href="group__file_ga5d6636d4ccd022885823b91f17a0f464.html#ga5d6636d4ccd022885823b91f17a0f464" title="Flag for dealing with existing files: Appends number until name is unique.">FILE_EXISTS_RENAME</a>:
<a name="l00957"></a>00957         $basename = <a class="code" href="group__php__wrappers_ga0125d5e205f50be86146a8df58c2bc5f.html#ga0125d5e205f50be86146a8df58c2bc5f" title="Gets the filename from a given path.">drupal_basename</a>($destination);
<a name="l00958"></a>00958         $directory = <a class="code" href="group__php__wrappers_gad00418a5880c03f43e5eccfaa62863f6.html#gad00418a5880c03f43e5eccfaa62863f6" title="Gets the name of the directory from a given path.">drupal_dirname</a>($destination);
<a name="l00959"></a>00959         $destination = <a class="code" href="group__file_ga057bbfa5f89c4e4c75f0030e6f1f3809.html#ga057bbfa5f89c4e4c75f0030e6f1f3809" title="Creates a full file path from a directory and filename.">file_create_filename</a>($basename, $directory);
<a name="l00960"></a>00960         <span class="keywordflow">break</span>;
<a name="l00961"></a>00961 
<a name="l00962"></a>00962       <span class="keywordflow">case</span> <a class="code" href="group__file_ga99e741faa66e03cdb8738b717be227fd.html#ga99e741faa66e03cdb8738b717be227fd" title="Flag for dealing with existing files: Do nothing and return FALSE.">FILE_EXISTS_ERROR</a>:
<a name="l00963"></a>00963         <span class="comment">// Error reporting handled by calling function.</span>
<a name="l00964"></a>00964         <span class="keywordflow">return</span> FALSE;
<a name="l00965"></a>00965     }
<a name="l00966"></a>00966   }
<a name="l00967"></a>00967   <span class="keywordflow">return</span> $destination;
<a name="l00968"></a>00968 }
<a name="l00969"></a>00969 
<a name="l01003"></a><a class="code" href="group__file_gad6f4eec44e0c32bf0cde6c602d5da38f.html#gad6f4eec44e0c32bf0cde6c602d5da38f">01003</a> <span class="keyword">function</span> <a class="code" href="group__file_gad6f4eec44e0c32bf0cde6c602d5da38f.html#gad6f4eec44e0c32bf0cde6c602d5da38f" title="Moves a file to a new location and update the file&#39;s database entry.">file_move</a>(stdClass $source, $destination = NULL, $replace = <a class="code" href="group__file_ga5d6636d4ccd022885823b91f17a0f464.html#ga5d6636d4ccd022885823b91f17a0f464" title="Flag for dealing with existing files: Appends number until name is unique.">FILE_EXISTS_RENAME</a>) {
<a name="l01004"></a>01004   <span class="keywordflow">if</span> (!<a class="code" href="group__file_gad84d226f677dd5b6e53519026b7de67e.html#gad84d226f677dd5b6e53519026b7de67e" title="Determines whether the URI has a valid scheme for file API operations.">file_valid_uri</a>($destination)) {
<a name="l01005"></a>01005     <span class="keywordflow">if</span> (($realpath = <a class="code" href="group__php__wrappers_gafaa5b186c9e78f53b39aae12633eea44.html#gafaa5b186c9e78f53b39aae12633eea44" title="Returns the absolute local filesystem path of a stream URI.">drupal_realpath</a>($source-&gt;uri)) !== FALSE) {
<a name="l01006"></a>01006       <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;File %file (%realpath) could not be moved, because the destination %destination is invalid. This may be caused by improper use of file_move() or a missing stream wrapper.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $source-&gt;uri, <span class="stringliteral">&#39;%realpath&#39;</span> =&gt; $realpath, <span class="stringliteral">&#39;%destination&#39;</span> =&gt; $destination));
<a name="l01007"></a>01007     }
<a name="l01008"></a>01008     <span class="keywordflow">else</span> {
<a name="l01009"></a>01009       <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;File %file could not be moved, because the destination %destination is invalid. This may be caused by improper use of file_move() or a missing stream wrapper.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $source-&gt;uri, <span class="stringliteral">&#39;%destination&#39;</span> =&gt; $destination));
<a name="l01010"></a>01010     }
<a name="l01011"></a>01011     <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The specified file %file could not be moved, because the destination is invalid. More information is available in the system log.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $source-&gt;uri)), <span class="stringliteral">&#39;error&#39;</span>);
<a name="l01012"></a>01012     <span class="keywordflow">return</span> FALSE;
<a name="l01013"></a>01013   }
<a name="l01014"></a>01014 
<a name="l01015"></a>01015   <span class="keywordflow">if</span> ($uri = <a class="code" href="group__file_ga3fd3a919ca321ec8c5bd1e4b069237a1.html#ga3fd3a919ca321ec8c5bd1e4b069237a1" title="Moves a file to a new location without database changes or hook invocation.">file_unmanaged_move</a>($source-&gt;uri, $destination, $replace)) {
<a name="l01016"></a>01016     $delete_source = FALSE;
<a name="l01017"></a>01017 
<a name="l01018"></a>01018     $file = clone $source;
<a name="l01019"></a>01019     $file-&gt;uri = $uri;
<a name="l01020"></a>01020     <span class="comment">// If we are replacing an existing file re-use its database record.</span>
<a name="l01021"></a>01021     <span class="keywordflow">if</span> ($replace == <a class="code" href="group__file_ga54c3c90d9cb7857114326cb5114e7159.html#ga54c3c90d9cb7857114326cb5114e7159" title="Flag for dealing with existing files: Replace the existing file.">FILE_EXISTS_REPLACE</a>) {
<a name="l01022"></a>01022       $existing_files = <a class="code" href="group__file_ga32afa29695b6da3f5d86cad18f063bfc.html#ga32afa29695b6da3f5d86cad18f063bfc" title="Loads file objects from the database.">file_load_multiple</a>(array(), array(<span class="stringliteral">&#39;uri&#39;</span> =&gt; $uri));
<a name="l01023"></a>01023       <span class="keywordflow">if</span> (count($existing_files)) {
<a name="l01024"></a>01024         $existing = reset($existing_files);
<a name="l01025"></a>01025         $delete_source = TRUE;
<a name="l01026"></a>01026         $file-&gt;fid = $existing-&gt;fid;
<a name="l01027"></a>01027       }
<a name="l01028"></a>01028     }
<a name="l01029"></a>01029     <span class="comment">// If we are renaming around an existing file (rather than a directory),</span>
<a name="l01030"></a>01030     <span class="comment">// use its basename for the filename.</span>
<a name="l01031"></a>01031     elseif ($replace == <a class="code" href="group__file_ga5d6636d4ccd022885823b91f17a0f464.html#ga5d6636d4ccd022885823b91f17a0f464" title="Flag for dealing with existing files: Appends number until name is unique.">FILE_EXISTS_RENAME</a> &amp;&amp; is_file($destination)) {
<a name="l01032"></a>01032       $file-&gt;filename = <a class="code" href="group__php__wrappers_ga0125d5e205f50be86146a8df58c2bc5f.html#ga0125d5e205f50be86146a8df58c2bc5f" title="Gets the filename from a given path.">drupal_basename</a>($destination);
<a name="l01033"></a>01033     }
<a name="l01034"></a>01034 
<a name="l01035"></a>01035     $file = <a class="code" href="group__file_ga80327cb23d8d384b827b2637cd8cc4ba.html#ga80327cb23d8d384b827b2637cd8cc4ba" title="Saves a file object to the database.">file_save</a>($file);
<a name="l01036"></a>01036 
<a name="l01037"></a>01037     <span class="comment">// Inform modules that the file has been moved.</span>
<a name="l01038"></a>01038     <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;file_move&#39;</span>, $file, $source);
<a name="l01039"></a>01039 
<a name="l01040"></a>01040     <span class="keywordflow">if</span> ($delete_source) {
<a name="l01041"></a>01041       <span class="comment">// Try a soft delete to remove original if it&#39;s not in use elsewhere.</span>
<a name="l01042"></a>01042       <a class="code" href="group__file_gac7503f0dcdea965d68e4a242e7760921.html#gac7503f0dcdea965d68e4a242e7760921" title="Deletes a file and its database record.">file_delete</a>($source);
<a name="l01043"></a>01043     }
<a name="l01044"></a>01044 
<a name="l01045"></a>01045     <span class="keywordflow">return</span> $file;
<a name="l01046"></a>01046   }
<a name="l01047"></a>01047   <span class="keywordflow">return</span> FALSE;
<a name="l01048"></a>01048 }
<a name="l01049"></a>01049 
<a name="l01071"></a><a class="code" href="group__file_ga3fd3a919ca321ec8c5bd1e4b069237a1.html#ga3fd3a919ca321ec8c5bd1e4b069237a1">01071</a> <span class="keyword">function</span> <a class="code" href="group__file_ga3fd3a919ca321ec8c5bd1e4b069237a1.html#ga3fd3a919ca321ec8c5bd1e4b069237a1" title="Moves a file to a new location without database changes or hook invocation.">file_unmanaged_move</a>($source, $destination = NULL, $replace = <a class="code" href="group__file_ga5d6636d4ccd022885823b91f17a0f464.html#ga5d6636d4ccd022885823b91f17a0f464" title="Flag for dealing with existing files: Appends number until name is unique.">FILE_EXISTS_RENAME</a>) {
<a name="l01072"></a>01072   $filepath = <a class="code" href="group__file_ga19b0d88682d26b7e5d03cb22ac2af391.html#ga19b0d88682d26b7e5d03cb22ac2af391" title="Copies a file to a new location without invoking the file API.">file_unmanaged_copy</a>($source, $destination, $replace);
<a name="l01073"></a>01073   <span class="keywordflow">if</span> ($filepath == FALSE || <a class="code" href="group__file_ga336a7e83da1397131e665d1c6e97fc83.html#ga336a7e83da1397131e665d1c6e97fc83" title="Deletes a file without database changes or hook invocations.">file_unmanaged_delete</a>($source) == FALSE) {
<a name="l01074"></a>01074     <span class="keywordflow">return</span> FALSE;
<a name="l01075"></a>01075   }
<a name="l01076"></a>01076   <span class="keywordflow">return</span> $filepath;
<a name="l01077"></a>01077 }
<a name="l01078"></a>01078 
<a name="l01111"></a><a class="code" href="group__file_gae5f97959982c78dfde2f806757c21368.html#gae5f97959982c78dfde2f806757c21368">01111</a> <span class="keyword">function</span> <a class="code" href="group__file_gae5f97959982c78dfde2f806757c21368.html#gae5f97959982c78dfde2f806757c21368" title="Modifies a filename as needed for security purposes.">file_munge_filename</a>($filename, $extensions, $alerts = TRUE) {
<a name="l01112"></a>01112   $original = $filename;
<a name="l01113"></a>01113 
<a name="l01114"></a>01114   <span class="comment">// Allow potentially insecure uploads for very savvy users and admin</span>
<a name="l01115"></a>01115   <span class="keywordflow">if</span> (!<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;allow_insecure_uploads&#39;</span>, 0)) {
<a name="l01116"></a>01116     $whitelist = array_unique(explode(<span class="charliteral">&#39; &#39;</span>, trim($extensions)));
<a name="l01117"></a>01117 
<a name="l01118"></a>01118     <span class="comment">// Split the filename up by periods. The first part becomes the basename</span>
<a name="l01119"></a>01119     <span class="comment">// the last part the final extension.</span>
<a name="l01120"></a>01120     $filename_parts = explode(<span class="charliteral">&#39;.&#39;</span>, $filename);
<a name="l01121"></a>01121     $new_filename = array_shift($filename_parts); <span class="comment">// Remove file basename.</span>
<a name="l01122"></a>01122     $final_extension = array_pop($filename_parts); <span class="comment">// Remove final extension.</span>
<a name="l01123"></a>01123 
<a name="l01124"></a>01124     <span class="comment">// Loop through the middle parts of the name and add an underscore to the</span>
<a name="l01125"></a>01125     <span class="comment">// end of each section that could be a file extension but isn&#39;t in the list</span>
<a name="l01126"></a>01126     <span class="comment">// of allowed extensions.</span>
<a name="l01127"></a>01127     <span class="keywordflow">foreach</span> ($filename_parts as $filename_part) {
<a name="l01128"></a>01128       $new_filename .= <span class="charliteral">&#39;.&#39;</span> . $filename_part;
<a name="l01129"></a>01129       <span class="keywordflow">if</span> (!in_array($filename_part, $whitelist) &amp;&amp; preg_match(<span class="stringliteral">&quot;/^[a-zA-Z]{2,5}\d?$/&quot;</span>, $filename_part)) {
<a name="l01130"></a>01130         $new_filename .= <span class="charliteral">&#39;_&#39;</span>;
<a name="l01131"></a>01131       }
<a name="l01132"></a>01132     }
<a name="l01133"></a>01133     $filename = $new_filename . <span class="charliteral">&#39;.&#39;</span> . $final_extension;
<a name="l01134"></a>01134 
<a name="l01135"></a>01135     <span class="keywordflow">if</span> ($alerts &amp;&amp; $original != $filename) {
<a name="l01136"></a>01136       <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;For security reasons, your upload has been renamed to %filename.&#39;</span>, array(<span class="stringliteral">&#39;%filename&#39;</span> =&gt; $filename)));
<a name="l01137"></a>01137     }
<a name="l01138"></a>01138   }
<a name="l01139"></a>01139 
<a name="l01140"></a>01140   <span class="keywordflow">return</span> $filename;
<a name="l01141"></a>01141 }
<a name="l01142"></a>01142 
<a name="l01152"></a><a class="code" href="group__file_gabda71018b91068bcd9fcd527a0493347.html#gabda71018b91068bcd9fcd527a0493347">01152</a> <span class="keyword">function</span> <a class="code" href="group__file_gabda71018b91068bcd9fcd527a0493347.html#gabda71018b91068bcd9fcd527a0493347" title="Undoes the effect of file_munge_filename().">file_unmunge_filename</a>($filename) {
<a name="l01153"></a>01153   <span class="keywordflow">return</span> str_replace(<span class="stringliteral">&#39;_.&#39;</span>, <span class="charliteral">&#39;.&#39;</span>, $filename);
<a name="l01154"></a>01154 }
<a name="l01155"></a>01155 
<a name="l01171"></a><a class="code" href="group__file_ga057bbfa5f89c4e4c75f0030e6f1f3809.html#ga057bbfa5f89c4e4c75f0030e6f1f3809">01171</a> <span class="keyword">function</span> <a class="code" href="group__file_ga057bbfa5f89c4e4c75f0030e6f1f3809.html#ga057bbfa5f89c4e4c75f0030e6f1f3809" title="Creates a full file path from a directory and filename.">file_create_filename</a>($basename, $directory) {
<a name="l01172"></a>01172   <span class="comment">// Strip control characters (ASCII value &lt; 32). Though these are allowed in</span>
<a name="l01173"></a>01173   <span class="comment">// some filesystems, not many applications handle them well.</span>
<a name="l01174"></a>01174   $basename = preg_replace(<span class="stringliteral">&#39;/[\x00-\x1F]/u&#39;</span>, <span class="charliteral">&#39;_&#39;</span>, $basename);
<a name="l01175"></a>01175   <span class="keywordflow">if</span> (substr(PHP_OS, 0, 3) == <span class="stringliteral">&#39;WIN&#39;</span>) {
<a name="l01176"></a>01176     <span class="comment">// These characters are not allowed in Windows filenames</span>
<a name="l01177"></a>01177     $basename = str_replace(array(<span class="charliteral">&#39;:&#39;</span>, <span class="charliteral">&#39;*&#39;</span>, <span class="charliteral">&#39;?&#39;</span>, <span class="charliteral">&#39;&quot;&#39;</span>, <span class="charliteral">&#39;&lt;&#39;</span>, <span class="charliteral">&#39;&gt;&#39;</span>, <span class="charliteral">&#39;|&#39;</span>), <span class="charliteral">&#39;_&#39;</span>, $basename);
<a name="l01178"></a>01178   }
<a name="l01179"></a>01179 
<a name="l01180"></a>01180   <span class="comment">// A URI or path may already have a trailing slash or look like &quot;public://&quot;.</span>
<a name="l01181"></a>01181   <span class="keywordflow">if</span> (substr($directory, -1) == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l01182"></a>01182     $separator = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01183"></a>01183   }
<a name="l01184"></a>01184   <span class="keywordflow">else</span> {
<a name="l01185"></a>01185     $separator = <span class="charliteral">&#39;/&#39;</span>;
<a name="l01186"></a>01186   }
<a name="l01187"></a>01187 
<a name="l01188"></a>01188   $destination = $directory . $separator . $basename;
<a name="l01189"></a>01189 
<a name="l01190"></a>01190   <span class="keywordflow">if</span> (file_exists($destination)) {
<a name="l01191"></a>01191     <span class="comment">// Destination file already exists, generate an alternative.</span>
<a name="l01192"></a>01192     $pos = strrpos($basename, <span class="charliteral">&#39;.&#39;</span>);
<a name="l01193"></a>01193     <span class="keywordflow">if</span> ($pos !== FALSE) {
<a name="l01194"></a>01194       $name = substr($basename, 0, $pos);
<a name="l01195"></a>01195       $ext = substr($basename, $pos);
<a name="l01196"></a>01196     }
<a name="l01197"></a>01197     <span class="keywordflow">else</span> {
<a name="l01198"></a>01198       $name = $basename;
<a name="l01199"></a>01199       $ext = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01200"></a>01200     }
<a name="l01201"></a>01201 
<a name="l01202"></a>01202     $counter = 0;
<a name="l01203"></a>01203     <span class="keywordflow">do</span> {
<a name="l01204"></a>01204       $destination = $directory . $separator . $name . <span class="charliteral">&#39;_&#39;</span> . $counter++ . $ext;
<a name="l01205"></a>01205     } <span class="keywordflow">while</span> (file_exists($destination));
<a name="l01206"></a>01206   }
<a name="l01207"></a>01207 
<a name="l01208"></a>01208   <span class="keywordflow">return</span> $destination;
<a name="l01209"></a>01209 }
<a name="l01210"></a>01210 
<a name="l01233"></a><a class="code" href="group__file_gac7503f0dcdea965d68e4a242e7760921.html#gac7503f0dcdea965d68e4a242e7760921">01233</a> <span class="keyword">function</span> <a class="code" href="group__file_gac7503f0dcdea965d68e4a242e7760921.html#gac7503f0dcdea965d68e4a242e7760921" title="Deletes a file and its database record.">file_delete</a>(stdClass $file, $force = FALSE) {
<a name="l01234"></a>01234   <span class="keywordflow">if</span> (!<a class="code" href="group__file_gad84d226f677dd5b6e53519026b7de67e.html#gad84d226f677dd5b6e53519026b7de67e" title="Determines whether the URI has a valid scheme for file API operations.">file_valid_uri</a>($file-&gt;uri)) {
<a name="l01235"></a>01235     <span class="keywordflow">if</span> (($realpath = <a class="code" href="group__php__wrappers_gafaa5b186c9e78f53b39aae12633eea44.html#gafaa5b186c9e78f53b39aae12633eea44" title="Returns the absolute local filesystem path of a stream URI.">drupal_realpath</a>($file-&gt;uri)) !== FALSE) {
<a name="l01236"></a>01236       <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;File %file (%realpath) could not be deleted because it is not a valid URI. This may be caused by improper use of file_delete() or a missing stream wrapper.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $file-&gt;uri, <span class="stringliteral">&#39;%realpath&#39;</span> =&gt; $realpath));
<a name="l01237"></a>01237     }
<a name="l01238"></a>01238     <span class="keywordflow">else</span> {
<a name="l01239"></a>01239       <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;File %file could not be deleted because it is not a valid URI. This may be caused by improper use of file_delete() or a missing stream wrapper.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $file-&gt;uri));
<a name="l01240"></a>01240     }
<a name="l01241"></a>01241     <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The specified file %file could not be deleted, because it is not a valid URI. More information is available in the system log.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $file-&gt;uri)), <span class="stringliteral">&#39;error&#39;</span>);
<a name="l01242"></a>01242     <span class="keywordflow">return</span> FALSE;
<a name="l01243"></a>01243   }
<a name="l01244"></a>01244 
<a name="l01245"></a>01245   <span class="comment">// If any module still has a usage entry in the file_usage table, the file</span>
<a name="l01246"></a>01246   <span class="comment">// will not be deleted, but file_delete() will return a populated array</span>
<a name="l01247"></a>01247   <span class="comment">// that tests as TRUE.</span>
<a name="l01248"></a>01248   <span class="keywordflow">if</span> (!$force &amp;&amp; ($references = <a class="code" href="group__file_ga6399c4096559ffbe81cfcb22db782bc4.html#ga6399c4096559ffbe81cfcb22db782bc4" title="Determines where a file is used.">file_usage_list</a>($file))) {
<a name="l01249"></a>01249     <span class="keywordflow">return</span> $references;
<a name="l01250"></a>01250   }
<a name="l01251"></a>01251 
<a name="l01252"></a>01252   <span class="comment">// Let other modules clean up any references to the deleted file.</span>
<a name="l01253"></a>01253   <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;file_delete&#39;</span>, $file);
<a name="l01254"></a>01254   <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;entity_delete&#39;</span>, $file, <span class="stringliteral">&#39;file&#39;</span>);
<a name="l01255"></a>01255 
<a name="l01256"></a>01256   <span class="comment">// Make sure the file is deleted before removing its row from the</span>
<a name="l01257"></a>01257   <span class="comment">// database, so UIs can still find the file in the database.</span>
<a name="l01258"></a>01258   <span class="keywordflow">if</span> (<a class="code" href="group__file_ga336a7e83da1397131e665d1c6e97fc83.html#ga336a7e83da1397131e665d1c6e97fc83" title="Deletes a file without database changes or hook invocations.">file_unmanaged_delete</a>($file-&gt;uri)) {
<a name="l01259"></a>01259     <a class="code" href="group__database_ga72f0ccecc0ba181de16c6e3451150f2c.html#ga72f0ccecc0ba181de16c6e3451150f2c" title="Returns a new DeleteQuery object for the active database.">db_delete</a>(<span class="stringliteral">&#39;file_managed&#39;</span>)-&gt;condition(<span class="stringliteral">&#39;fid&#39;</span>, $file-&gt;fid)-&gt;execute();
<a name="l01260"></a>01260     <a class="code" href="group__database_ga72f0ccecc0ba181de16c6e3451150f2c.html#ga72f0ccecc0ba181de16c6e3451150f2c" title="Returns a new DeleteQuery object for the active database.">db_delete</a>(<span class="stringliteral">&#39;file_usage&#39;</span>)-&gt;condition(<span class="stringliteral">&#39;fid&#39;</span>, $file-&gt;fid)-&gt;execute();
<a name="l01261"></a>01261     <span class="keywordflow">return</span> TRUE;
<a name="l01262"></a>01262   }
<a name="l01263"></a>01263   <span class="keywordflow">return</span> FALSE;
<a name="l01264"></a>01264 }
<a name="l01265"></a>01265 
<a name="l01282"></a><a class="code" href="group__file_ga336a7e83da1397131e665d1c6e97fc83.html#ga336a7e83da1397131e665d1c6e97fc83">01282</a> <span class="keyword">function</span> <a class="code" href="group__file_ga336a7e83da1397131e665d1c6e97fc83.html#ga336a7e83da1397131e665d1c6e97fc83" title="Deletes a file without database changes or hook invocations.">file_unmanaged_delete</a>($path) {
<a name="l01283"></a>01283   <span class="keywordflow">if</span> (is_dir($path)) {
<a name="l01284"></a>01284     <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;%path is a directory and cannot be removed using file_unmanaged_delete().&#39;</span>, array(<span class="stringliteral">&#39;%path&#39;</span> =&gt; $path), <a class="code" href="group__logging__severity__levels_ga174c9df2936096e11986fcf184d48576.html#ga174c9df2936096e11986fcf184d48576" title="Log message severity -- Error conditions.">WATCHDOG_ERROR</a>);
<a name="l01285"></a>01285     <span class="keywordflow">return</span> FALSE;
<a name="l01286"></a>01286   }
<a name="l01287"></a>01287   <span class="keywordflow">if</span> (is_file($path)) {
<a name="l01288"></a>01288     <span class="keywordflow">return</span> <a class="code" href="group__php__wrappers_ga533bc32da8860919d20d60ada655e494.html#ga533bc32da8860919d20d60ada655e494" title="Deletes a file.">drupal_unlink</a>($path);
<a name="l01289"></a>01289   }
<a name="l01290"></a>01290   <span class="comment">// Return TRUE for non-existent file, but log that nothing was actually</span>
<a name="l01291"></a>01291   <span class="comment">// deleted, as the current state is the intended result.</span>
<a name="l01292"></a>01292   <span class="keywordflow">if</span> (!file_exists($path)) {
<a name="l01293"></a>01293     <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;The file %path was not deleted, because it does not exist.&#39;</span>, array(<span class="stringliteral">&#39;%path&#39;</span> =&gt; $path), <a class="code" href="group__logging__severity__levels_ga757a33416683e8c44636a8799f60b477.html#ga757a33416683e8c44636a8799f60b477" title="Log message severity -- Normal but significant conditions.">WATCHDOG_NOTICE</a>);
<a name="l01294"></a>01294     <span class="keywordflow">return</span> TRUE;
<a name="l01295"></a>01295   }
<a name="l01296"></a>01296   <span class="comment">// We cannot handle anything other than files and directories. Log an error</span>
<a name="l01297"></a>01297   <span class="comment">// for everything else (sockets, symbolic links, etc).</span>
<a name="l01298"></a>01298   <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;The file %path is not of a recognized type so it was not deleted.&#39;</span>, array(<span class="stringliteral">&#39;%path&#39;</span> =&gt; $path), <a class="code" href="group__logging__severity__levels_ga174c9df2936096e11986fcf184d48576.html#ga174c9df2936096e11986fcf184d48576" title="Log message severity -- Error conditions.">WATCHDOG_ERROR</a>);
<a name="l01299"></a>01299   <span class="keywordflow">return</span> FALSE;
<a name="l01300"></a>01300 }
<a name="l01301"></a>01301 
<a name="l01323"></a><a class="code" href="group__file_gaf5c2cffaaf70f0f62a513f033d814899.html#gaf5c2cffaaf70f0f62a513f033d814899">01323</a> <span class="keyword">function</span> <a class="code" href="group__file_gaf5c2cffaaf70f0f62a513f033d814899.html#gaf5c2cffaaf70f0f62a513f033d814899" title="Deletes all files and directories in the specified filepath recursively.">file_unmanaged_delete_recursive</a>($path) {
<a name="l01324"></a>01324   <span class="keywordflow">if</span> (is_dir($path)) {
<a name="l01325"></a>01325     $dir = dir($path);
<a name="l01326"></a>01326     <span class="keywordflow">while</span> (($entry = $dir-&gt;read()) !== FALSE) {
<a name="l01327"></a>01327       <span class="keywordflow">if</span> ($entry == <span class="charliteral">&#39;.&#39;</span> || $entry == <span class="stringliteral">&#39;..&#39;</span>) {
<a name="l01328"></a>01328         <span class="keywordflow">continue</span>;
<a name="l01329"></a>01329       }
<a name="l01330"></a>01330       $entry_path = $path . <span class="charliteral">&#39;/&#39;</span> . $entry;
<a name="l01331"></a>01331       <a class="code" href="group__file_gaf5c2cffaaf70f0f62a513f033d814899.html#gaf5c2cffaaf70f0f62a513f033d814899" title="Deletes all files and directories in the specified filepath recursively.">file_unmanaged_delete_recursive</a>($entry_path);
<a name="l01332"></a>01332     }
<a name="l01333"></a>01333     $dir-&gt;close();
<a name="l01334"></a>01334 
<a name="l01335"></a>01335     <span class="keywordflow">return</span> <a class="code" href="group__php__wrappers_ga394629431629976febfae765abd63e48.html#ga394629431629976febfae765abd63e48" title="Removes a directory.">drupal_rmdir</a>($path);
<a name="l01336"></a>01336   }
<a name="l01337"></a>01337   <span class="keywordflow">return</span> <a class="code" href="group__file_ga336a7e83da1397131e665d1c6e97fc83.html#ga336a7e83da1397131e665d1c6e97fc83" title="Deletes a file without database changes or hook invocations.">file_unmanaged_delete</a>($path);
<a name="l01338"></a>01338 }
<a name="l01339"></a>01339 
<a name="l01353"></a><a class="code" href="group__file_gade600fbda0056f4aaea634e7178215b2.html#gade600fbda0056f4aaea634e7178215b2">01353</a> <span class="keyword">function</span> <a class="code" href="group__file_gade600fbda0056f4aaea634e7178215b2.html#gade600fbda0056f4aaea634e7178215b2" title="Determines total disk space used by a single user or the whole filesystem.">file_space_used</a>($uid = NULL, $status = <a class="code" href="group__file_gaf208a7c7d7fd09276233583b22e4ee32.html#gaf208a7c7d7fd09276233583b22e4ee32" title="Indicates that the file is permanent and should not be deleted.">FILE_STATUS_PERMANENT</a>) {
<a name="l01354"></a>01354   $query = <a class="code" href="group__database_ga9e030cee657d64e3d8e524c65814cc9f.html#ga9e030cee657d64e3d8e524c65814cc9f" title="Returns a new SelectQuery object for the active database.">db_select</a>(<span class="stringliteral">&#39;file_managed&#39;</span>, <span class="charliteral">&#39;f&#39;</span>);
<a name="l01355"></a>01355   $query-&gt;condition(<span class="stringliteral">&#39;f.status&#39;</span>, $status);
<a name="l01356"></a>01356   $query-&gt;addExpression(<span class="stringliteral">&#39;SUM(f.filesize)&#39;</span>, <span class="stringliteral">&#39;filesize&#39;</span>);
<a name="l01357"></a>01357   <span class="keywordflow">if</span> (isset($uid)) {
<a name="l01358"></a>01358     $query-&gt;condition(<span class="stringliteral">&#39;f.uid&#39;</span>, $uid);
<a name="l01359"></a>01359   }
<a name="l01360"></a>01360   <span class="keywordflow">return</span> $query-&gt;execute()-&gt;fetchField();
<a name="l01361"></a>01361 }
<a name="l01362"></a>01362 
<a name="l01402"></a><a class="code" href="group__file_gaec0ce0fef696b3d4f9e0809c84bd8f41.html#gaec0ce0fef696b3d4f9e0809c84bd8f41">01402</a> <span class="keyword">function</span> <a class="code" href="group__file_gaec0ce0fef696b3d4f9e0809c84bd8f41.html#gaec0ce0fef696b3d4f9e0809c84bd8f41" title="Saves a file upload to a new location.">file_save_upload</a>($source, $validators = array(), $destination = FALSE, $replace = <a class="code" href="group__file_ga5d6636d4ccd022885823b91f17a0f464.html#ga5d6636d4ccd022885823b91f17a0f464" title="Flag for dealing with existing files: Appends number until name is unique.">FILE_EXISTS_RENAME</a>) {
<a name="l01403"></a>01403   global $user;
<a name="l01404"></a>01404   <span class="keyword">static</span> $upload_cache;
<a name="l01405"></a>01405 
<a name="l01406"></a>01406   <span class="comment">// Return cached objects without processing since the file will have</span>
<a name="l01407"></a>01407   <span class="comment">// already been processed and the paths in _FILES will be invalid.</span>
<a name="l01408"></a>01408   <span class="keywordflow">if</span> (isset($upload_cache[$source])) {
<a name="l01409"></a>01409     <span class="keywordflow">return</span> $upload_cache[$source];
<a name="l01410"></a>01410   }
<a name="l01411"></a>01411 
<a name="l01412"></a>01412   <span class="comment">// Make sure there&#39;s an upload to process.</span>
<a name="l01413"></a>01413   <span class="keywordflow">if</span> (empty($_FILES[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>][$source])) {
<a name="l01414"></a>01414     <span class="keywordflow">return</span> NULL;
<a name="l01415"></a>01415   }
<a name="l01416"></a>01416 
<a name="l01417"></a>01417   <span class="comment">// Check for file upload errors and return FALSE if a lower level system</span>
<a name="l01418"></a>01418   <span class="comment">// error occurred. For a complete list of errors:</span>
<a name="l01419"></a>01419   <span class="comment">// See http://php.net/manual/en/features.file-upload.errors.php.</span>
<a name="l01420"></a>01420   <span class="keywordflow">switch</span> ($_FILES[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;error&#39;</span>][$source]) {
<a name="l01421"></a>01421     <span class="keywordflow">case</span> UPLOAD_ERR_INI_SIZE:
<a name="l01422"></a>01422     <span class="keywordflow">case</span> UPLOAD_ERR_FORM_SIZE:
<a name="l01423"></a>01423       <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The file %file could not be saved, because it exceeds %maxsize, the maximum allowed size for uploads.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $_FILES[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>][$source], <span class="stringliteral">&#39;%maxsize&#39;</span> =&gt; <a class="code" href="group__format_ga2a0075e7646fa2f399286272faa2956e.html#ga2a0075e7646fa2f399286272faa2956e" title="Generates a string representation for the given byte count.">format_size</a>(<a class="code" href="group__file_ga7cf25e6a2532a1d022ee1c655f895380.html#ga7cf25e6a2532a1d022ee1c655f895380" title="Determines the maximum file upload size by querying the PHP settings.">file_upload_max_size</a>()))), <span class="stringliteral">&#39;error&#39;</span>);
<a name="l01424"></a>01424       <span class="keywordflow">return</span> FALSE;
<a name="l01425"></a>01425 
<a name="l01426"></a>01426     <span class="keywordflow">case</span> UPLOAD_ERR_PARTIAL:
<a name="l01427"></a>01427     <span class="keywordflow">case</span> UPLOAD_ERR_NO_FILE:
<a name="l01428"></a>01428       <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The file %file could not be saved, because the upload did not complete.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $_FILES[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>][$source])), <span class="stringliteral">&#39;error&#39;</span>);
<a name="l01429"></a>01429       <span class="keywordflow">return</span> FALSE;
<a name="l01430"></a>01430 
<a name="l01431"></a>01431     <span class="keywordflow">case</span> UPLOAD_ERR_OK:
<a name="l01432"></a>01432       <span class="comment">// Final check that this is a valid upload, if it isn&#39;t, use the</span>
<a name="l01433"></a>01433       <span class="comment">// default error handler.</span>
<a name="l01434"></a>01434       <span class="keywordflow">if</span> (is_uploaded_file($_FILES[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;tmp_name&#39;</span>][$source])) {
<a name="l01435"></a>01435         <span class="keywordflow">break</span>;
<a name="l01436"></a>01436       }
<a name="l01437"></a>01437 
<a name="l01438"></a>01438     <span class="comment">// Unknown error</span>
<a name="l01439"></a>01439     <span class="keywordflow">default</span>:
<a name="l01440"></a>01440       <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The file %file could not be saved. An unknown error has occurred.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $_FILES[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>][$source])), <span class="stringliteral">&#39;error&#39;</span>);
<a name="l01441"></a>01441       <span class="keywordflow">return</span> FALSE;
<a name="l01442"></a>01442   }
<a name="l01443"></a>01443 
<a name="l01444"></a>01444   <span class="comment">// Begin building file object.</span>
<a name="l01445"></a>01445   $file = <span class="keyword">new</span> stdClass();
<a name="l01446"></a>01446   $file-&gt;uid      = $user-&gt;uid;
<a name="l01447"></a>01447   $file-&gt;status   = 0;
<a name="l01448"></a>01448   $file-&gt;filename = trim(<a class="code" href="group__php__wrappers_ga0125d5e205f50be86146a8df58c2bc5f.html#ga0125d5e205f50be86146a8df58c2bc5f" title="Gets the filename from a given path.">drupal_basename</a>($_FILES[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>][$source]), <span class="charliteral">&#39;.&#39;</span>);
<a name="l01449"></a>01449   $file-&gt;uri      = $_FILES[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;tmp_name&#39;</span>][$source];
<a name="l01450"></a>01450   $file-&gt;filemime = <a class="code" href="group__file_ga2f3c500f59ecd606e4022ed9d83a1dec.html#ga2f3c500f59ecd606e4022ed9d83a1dec" title="Determines an Internet Media Type or MIME type from a filename.">file_get_mimetype</a>($file-&gt;filename);
<a name="l01451"></a>01451   $file-&gt;filesize = $_FILES[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;size&#39;</span>][$source];
<a name="l01452"></a>01452 
<a name="l01453"></a>01453   $extensions = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01454"></a>01454   <span class="keywordflow">if</span> (isset($validators[<span class="stringliteral">&#39;file_validate_extensions&#39;</span>])) {
<a name="l01455"></a>01455     <span class="keywordflow">if</span> (isset($validators[<span class="stringliteral">&#39;file_validate_extensions&#39;</span>][0])) {
<a name="l01456"></a>01456       <span class="comment">// Build the list of non-munged extensions if the caller provided them.</span>
<a name="l01457"></a>01457       $extensions = $validators[<span class="stringliteral">&#39;file_validate_extensions&#39;</span>][0];
<a name="l01458"></a>01458     }
<a name="l01459"></a>01459     <span class="keywordflow">else</span> {
<a name="l01460"></a>01460       <span class="comment">// If &#39;file_validate_extensions&#39; is set and the list is empty then the</span>
<a name="l01461"></a>01461       <span class="comment">// caller wants to allow any extension. In this case we have to remove the</span>
<a name="l01462"></a>01462       <span class="comment">// validator or else it will reject all extensions.</span>
<a name="l01463"></a>01463       unset($validators[<span class="stringliteral">&#39;file_validate_extensions&#39;</span>]);
<a name="l01464"></a>01464     }
<a name="l01465"></a>01465   }
<a name="l01466"></a>01466   <span class="keywordflow">else</span> {
<a name="l01467"></a>01467     <span class="comment">// No validator was provided, so add one using the default list.</span>
<a name="l01468"></a>01468     <span class="comment">// Build a default non-munged safe list for file_munge_filename().</span>
<a name="l01469"></a>01469     $extensions = <span class="stringliteral">&#39;jpg jpeg gif png txt doc xls pdf ppt pps odt ods odp&#39;</span>;
<a name="l01470"></a>01470     $validators[<span class="stringliteral">&#39;file_validate_extensions&#39;</span>] = array();
<a name="l01471"></a>01471     $validators[<span class="stringliteral">&#39;file_validate_extensions&#39;</span>][0] = $extensions;
<a name="l01472"></a>01472   }
<a name="l01473"></a>01473 
<a name="l01474"></a>01474   <span class="keywordflow">if</span> (!empty($extensions)) {
<a name="l01475"></a>01475     <span class="comment">// Munge the filename to protect against possible malicious extension hiding</span>
<a name="l01476"></a>01476     <span class="comment">// within an unknown file type (ie: filename.html.foo).</span>
<a name="l01477"></a>01477     $file-&gt;filename = <a class="code" href="group__file_gae5f97959982c78dfde2f806757c21368.html#gae5f97959982c78dfde2f806757c21368" title="Modifies a filename as needed for security purposes.">file_munge_filename</a>($file-&gt;filename, $extensions);
<a name="l01478"></a>01478   }
<a name="l01479"></a>01479 
<a name="l01480"></a>01480   <span class="comment">// Rename potentially executable files, to help prevent exploits (i.e. will</span>
<a name="l01481"></a>01481   <span class="comment">// rename filename.php.foo and filename.php to filename.php.foo.txt and</span>
<a name="l01482"></a>01482   <span class="comment">// filename.php.txt, respectively). Don&#39;t rename if &#39;allow_insecure_uploads&#39;</span>
<a name="l01483"></a>01483   <span class="comment">// evaluates to TRUE.</span>
<a name="l01484"></a>01484   <span class="keywordflow">if</span> (!<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;allow_insecure_uploads&#39;</span>, 0) &amp;&amp; preg_match(<span class="stringliteral">&#39;/\.(php|pl|py|cgi|asp|js)(\.|$)/i&#39;</span>, $file-&gt;filename) &amp;&amp; (substr($file-&gt;filename, -4) != <span class="stringliteral">&#39;.txt&#39;</span>)) {
<a name="l01485"></a>01485     $file-&gt;filemime = <span class="stringliteral">&#39;text/plain&#39;</span>;
<a name="l01486"></a>01486     $file-&gt;uri .= <span class="stringliteral">&#39;.txt&#39;</span>;
<a name="l01487"></a>01487     $file-&gt;filename .= <span class="stringliteral">&#39;.txt&#39;</span>;
<a name="l01488"></a>01488     <span class="comment">// The .txt extension may not be in the allowed list of extensions. We have</span>
<a name="l01489"></a>01489     <span class="comment">// to add it here or else the file upload will fail.</span>
<a name="l01490"></a>01490     <span class="keywordflow">if</span> (!empty($extensions)) {
<a name="l01491"></a>01491       $validators[<span class="stringliteral">&#39;file_validate_extensions&#39;</span>][0] .= <span class="stringliteral">&#39; txt&#39;</span>;
<a name="l01492"></a>01492       <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;For security reasons, your upload has been renamed to %filename.&#39;</span>, array(<span class="stringliteral">&#39;%filename&#39;</span> =&gt; $file-&gt;filename)));
<a name="l01493"></a>01493     }
<a name="l01494"></a>01494   }
<a name="l01495"></a>01495 
<a name="l01496"></a>01496   <span class="comment">// If the destination is not provided, use the temporary directory.</span>
<a name="l01497"></a>01497   <span class="keywordflow">if</span> (empty($destination)) {
<a name="l01498"></a>01498     $destination = <span class="stringliteral">&#39;temporary://&#39;</span>;
<a name="l01499"></a>01499   }
<a name="l01500"></a>01500 
<a name="l01501"></a>01501   <span class="comment">// Assert that the destination contains a valid stream.</span>
<a name="l01502"></a>01502   $destination_scheme = <a class="code" href="group__file_gaa98f967fe1033030e7e5262adda85463.html#gaa98f967fe1033030e7e5262adda85463" title="Returns the scheme of a URI (e.g.">file_uri_scheme</a>($destination);
<a name="l01503"></a>01503   <span class="keywordflow">if</span> (!$destination_scheme || !<a class="code" href="group__file_ga12aebc3c6a9eb56d08511e7b968d0cef.html#ga12aebc3c6a9eb56d08511e7b968d0cef" title="Checks that the scheme of a stream URI is valid.">file_stream_wrapper_valid_scheme</a>($destination_scheme)) {
<a name="l01504"></a>01504     <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The file could not be uploaded, because the destination %destination is invalid.&#39;</span>, array(<span class="stringliteral">&#39;%destination&#39;</span> =&gt; $destination)), <span class="stringliteral">&#39;error&#39;</span>);
<a name="l01505"></a>01505     <span class="keywordflow">return</span> FALSE;
<a name="l01506"></a>01506   }
<a name="l01507"></a>01507 
<a name="l01508"></a>01508   $file-&gt;source = $source;
<a name="l01509"></a>01509   <span class="comment">// A URI may already have a trailing slash or look like &quot;public://&quot;.</span>
<a name="l01510"></a>01510   <span class="keywordflow">if</span> (substr($destination, -1) != <span class="charliteral">&#39;/&#39;</span>) {
<a name="l01511"></a>01511     $destination .= <span class="charliteral">&#39;/&#39;</span>;
<a name="l01512"></a>01512   }
<a name="l01513"></a>01513   $file-&gt;destination = <a class="code" href="group__file_ga3136d98d6189607e6cba12aaff55c66d.html#ga3136d98d6189607e6cba12aaff55c66d" title="Determines the destination path for a file.">file_destination</a>($destination . $file-&gt;filename, $replace);
<a name="l01514"></a>01514   <span class="comment">// If file_destination() returns FALSE then $replace == FILE_EXISTS_ERROR and</span>
<a name="l01515"></a>01515   <span class="comment">// there&#39;s an existing file so we need to bail.</span>
<a name="l01516"></a>01516   <span class="keywordflow">if</span> ($file-&gt;destination === FALSE) {
<a name="l01517"></a>01517     <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The file %source could not be uploaded because a file by that name already exists in the destination %directory.&#39;</span>, array(<span class="stringliteral">&#39;%source&#39;</span> =&gt; $source, <span class="stringliteral">&#39;%directory&#39;</span> =&gt; $destination)), <span class="stringliteral">&#39;error&#39;</span>);
<a name="l01518"></a>01518     <span class="keywordflow">return</span> FALSE;
<a name="l01519"></a>01519   }
<a name="l01520"></a>01520 
<a name="l01521"></a>01521   <span class="comment">// Add in our check of the the file name length.</span>
<a name="l01522"></a>01522   $validators[<span class="stringliteral">&#39;file_validate_name_length&#39;</span>] = array();
<a name="l01523"></a>01523 
<a name="l01524"></a>01524   <span class="comment">// Call the validation functions specified by this function&#39;s caller.</span>
<a name="l01525"></a>01525   $errors = <a class="code" href="group__file_ga9edf58fdc552d61247bbf8322c434abf.html#ga9edf58fdc552d61247bbf8322c434abf" title="Checks that a file meets the criteria specified by the validators.">file_validate</a>($file, $validators);
<a name="l01526"></a>01526 
<a name="l01527"></a>01527   <span class="comment">// Check for errors.</span>
<a name="l01528"></a>01528   <span class="keywordflow">if</span> (!empty($errors)) {
<a name="l01529"></a>01529     $message = <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The specified file %name could not be uploaded.&#39;</span>, array(<span class="stringliteral">&#39;%name&#39;</span> =&gt; $file-&gt;filename));
<a name="l01530"></a>01530     <span class="keywordflow">if</span> (count($errors) &gt; 1) {
<a name="l01531"></a>01531       $message .= <a class="code" href="theme_8inc_a7c25609a935874541a19657affd30fff.html#a7c25609a935874541a19657affd30fff" title="Generates themed output.">theme</a>(<span class="stringliteral">&#39;item_list&#39;</span>, array(<span class="stringliteral">&#39;items&#39;</span> =&gt; $errors));
<a name="l01532"></a>01532     }
<a name="l01533"></a>01533     <span class="keywordflow">else</span> {
<a name="l01534"></a>01534       $message .= <span class="charliteral">&#39; &#39;</span> . array_pop($errors);
<a name="l01535"></a>01535     }
<a name="l01536"></a>01536     <a class="code" href="group__form__api_ga6f4ecbec42e905390e521b393417f97f.html#ga6f4ecbec42e905390e521b393417f97f" title="Files an error against a form element.">form_set_error</a>($source, $message);
<a name="l01537"></a>01537     <span class="keywordflow">return</span> FALSE;
<a name="l01538"></a>01538   }
<a name="l01539"></a>01539 
<a name="l01540"></a>01540   <span class="comment">// Move uploaded files from PHP&#39;s upload_tmp_dir to Drupal&#39;s temporary</span>
<a name="l01541"></a>01541   <span class="comment">// directory. This overcomes open_basedir restrictions for future file</span>
<a name="l01542"></a>01542   <span class="comment">// operations.</span>
<a name="l01543"></a>01543   $file-&gt;uri = $file-&gt;destination;
<a name="l01544"></a>01544   <span class="keywordflow">if</span> (!<a class="code" href="group__php__wrappers_gad2a800badd2c93efbff2a2905507e685.html#gad2a800badd2c93efbff2a2905507e685" title="Moves an uploaded file to a new location.">drupal_move_uploaded_file</a>($_FILES[<span class="stringliteral">&#39;files&#39;</span>][<span class="stringliteral">&#39;tmp_name&#39;</span>][$source], $file-&gt;uri)) {
<a name="l01545"></a>01545     <a class="code" href="group__form__api_ga6f4ecbec42e905390e521b393417f97f.html#ga6f4ecbec42e905390e521b393417f97f" title="Files an error against a form element.">form_set_error</a>($source, <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;File upload error. Could not move uploaded file.&#39;</span>));
<a name="l01546"></a>01546     <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;Upload error. Could not move uploaded file %file to destination %destination.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $file-&gt;filename, <span class="stringliteral">&#39;%destination&#39;</span> =&gt; $file-&gt;uri));
<a name="l01547"></a>01547     <span class="keywordflow">return</span> FALSE;
<a name="l01548"></a>01548   }
<a name="l01549"></a>01549 
<a name="l01550"></a>01550   <span class="comment">// Set the permissions on the new file.</span>
<a name="l01551"></a>01551   <a class="code" href="group__php__wrappers_ga5fc93f1c4e81ea4f5b1b32775fca489c.html#ga5fc93f1c4e81ea4f5b1b32775fca489c" title="Sets the permissions on a file or directory.">drupal_chmod</a>($file-&gt;uri);
<a name="l01552"></a>01552 
<a name="l01553"></a>01553   <span class="comment">// If we are replacing an existing file re-use its database record.</span>
<a name="l01554"></a>01554   <span class="keywordflow">if</span> ($replace == <a class="code" href="group__file_ga54c3c90d9cb7857114326cb5114e7159.html#ga54c3c90d9cb7857114326cb5114e7159" title="Flag for dealing with existing files: Replace the existing file.">FILE_EXISTS_REPLACE</a>) {
<a name="l01555"></a>01555     $existing_files = <a class="code" href="group__file_ga32afa29695b6da3f5d86cad18f063bfc.html#ga32afa29695b6da3f5d86cad18f063bfc" title="Loads file objects from the database.">file_load_multiple</a>(array(), array(<span class="stringliteral">&#39;uri&#39;</span> =&gt; $file-&gt;uri));
<a name="l01556"></a>01556     <span class="keywordflow">if</span> (count($existing_files)) {
<a name="l01557"></a>01557       $existing = reset($existing_files);
<a name="l01558"></a>01558       $file-&gt;fid = $existing-&gt;fid;
<a name="l01559"></a>01559     }
<a name="l01560"></a>01560   }
<a name="l01561"></a>01561 
<a name="l01562"></a>01562   <span class="comment">// If we made it this far it&#39;s safe to record this file in the database.</span>
<a name="l01563"></a>01563   <span class="keywordflow">if</span> ($file = <a class="code" href="group__file_ga80327cb23d8d384b827b2637cd8cc4ba.html#ga80327cb23d8d384b827b2637cd8cc4ba" title="Saves a file object to the database.">file_save</a>($file)) {
<a name="l01564"></a>01564     <span class="comment">// Add file to the cache.</span>
<a name="l01565"></a>01565     $upload_cache[$source] = $file;
<a name="l01566"></a>01566     <span class="keywordflow">return</span> $file;
<a name="l01567"></a>01567   }
<a name="l01568"></a>01568   <span class="keywordflow">return</span> FALSE;
<a name="l01569"></a>01569 }
<a name="l01570"></a>01570 
<a name="l01591"></a><a class="code" href="group__php__wrappers_gad2a800badd2c93efbff2a2905507e685.html#gad2a800badd2c93efbff2a2905507e685">01591</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_gad2a800badd2c93efbff2a2905507e685.html#gad2a800badd2c93efbff2a2905507e685" title="Moves an uploaded file to a new location.">drupal_move_uploaded_file</a>($filename, $uri) {
<a name="l01592"></a>01592   $result = @move_uploaded_file($filename, $uri);
<a name="l01593"></a>01593   <span class="comment">// PHP&#39;s move_uploaded_file() does not properly support streams if safe_mode</span>
<a name="l01594"></a>01594   <span class="comment">// or open_basedir are enabled so if the move failed, try finding a real path</span>
<a name="l01595"></a>01595   <span class="comment">// and retry the move operation.</span>
<a name="l01596"></a>01596   <span class="keywordflow">if</span> (!$result) {
<a name="l01597"></a>01597     <span class="keywordflow">if</span> ($realpath = <a class="code" href="group__php__wrappers_gafaa5b186c9e78f53b39aae12633eea44.html#gafaa5b186c9e78f53b39aae12633eea44" title="Returns the absolute local filesystem path of a stream URI.">drupal_realpath</a>($uri)) {
<a name="l01598"></a>01598       $result = move_uploaded_file($filename, $realpath);
<a name="l01599"></a>01599     }
<a name="l01600"></a>01600     <span class="keywordflow">else</span> {
<a name="l01601"></a>01601       $result = move_uploaded_file($filename, $uri);
<a name="l01602"></a>01602     }
<a name="l01603"></a>01603   }
<a name="l01604"></a>01604 
<a name="l01605"></a>01605   <span class="keywordflow">return</span> $result;
<a name="l01606"></a>01606 }
<a name="l01607"></a>01607 
<a name="l01629"></a><a class="code" href="group__file_ga9edf58fdc552d61247bbf8322c434abf.html#ga9edf58fdc552d61247bbf8322c434abf">01629</a> <span class="keyword">function</span> <a class="code" href="group__file_ga9edf58fdc552d61247bbf8322c434abf.html#ga9edf58fdc552d61247bbf8322c434abf" title="Checks that a file meets the criteria specified by the validators.">file_validate</a>(stdClass &amp;$file, $validators = array()) {
<a name="l01630"></a>01630   <span class="comment">// Call the validation functions specified by this function&#39;s caller.</span>
<a name="l01631"></a>01631   $errors = array();
<a name="l01632"></a>01632   <span class="keywordflow">foreach</span> ($validators as $function =&gt; $args) {
<a name="l01633"></a>01633     <span class="keywordflow">if</span> (function_exists($function)) {
<a name="l01634"></a>01634       array_unshift($args, $file);
<a name="l01635"></a>01635       $errors = array_merge($errors, call_user_func_array($function, $args));
<a name="l01636"></a>01636     }
<a name="l01637"></a>01637   }
<a name="l01638"></a>01638 
<a name="l01639"></a>01639   <span class="comment">// Let other modules perform validation on the new file.</span>
<a name="l01640"></a>01640   <span class="keywordflow">return</span> array_merge($errors, <a class="code" href="group__hooks_gabedb5f566ef5faaa5768dd15125b111c.html#gabedb5f566ef5faaa5768dd15125b111c" title="Invoke a hook in all enabled modules that implement it.">module_invoke_all</a>(<span class="stringliteral">&#39;file_validate&#39;</span>, $file));
<a name="l01641"></a>01641 }
<a name="l01642"></a>01642 
<a name="l01652"></a><a class="code" href="group__file_gaca56a55a4d3ee635cddf38903c1ed367.html#gaca56a55a4d3ee635cddf38903c1ed367">01652</a> <span class="keyword">function</span> <a class="code" href="group__file_gaca56a55a4d3ee635cddf38903c1ed367.html#gaca56a55a4d3ee635cddf38903c1ed367" title="Checks for files with names longer than we can store in the database.">file_validate_name_length</a>(stdClass $file) {
<a name="l01653"></a>01653   $errors = array();
<a name="l01654"></a>01654 
<a name="l01655"></a>01655   <span class="keywordflow">if</span> (empty($file-&gt;filename)) {
<a name="l01656"></a>01656     $errors[] = <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&quot;The file&#39;s name is empty. Please give a name to the file.&quot;</span>);
<a name="l01657"></a>01657   }
<a name="l01658"></a>01658   <span class="keywordflow">if</span> (strlen($file-&gt;filename) &gt; 240) {
<a name="l01659"></a>01659     $errors[] = <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&quot;The file&#39;s name exceeds the 240 characters limit. Please rename the file and try again.&quot;</span>);
<a name="l01660"></a>01660   }
<a name="l01661"></a>01661   <span class="keywordflow">return</span> $errors;
<a name="l01662"></a>01662 }
<a name="l01663"></a>01663 
<a name="l01678"></a><a class="code" href="group__file_ga4036c6b78f904e5dd0273cf75eb474bb.html#ga4036c6b78f904e5dd0273cf75eb474bb">01678</a> <span class="keyword">function</span> <a class="code" href="group__file_ga4036c6b78f904e5dd0273cf75eb474bb.html#ga4036c6b78f904e5dd0273cf75eb474bb" title="Checks that the filename ends with an allowed extension.">file_validate_extensions</a>(stdClass $file, $extensions) {
<a name="l01679"></a>01679   $errors = array();
<a name="l01680"></a>01680 
<a name="l01681"></a>01681   $regex = <span class="stringliteral">&#39;/\.(&#39;</span> . preg_replace(<span class="stringliteral">&#39;/ +/&#39;</span>, <span class="charliteral">&#39;|&#39;</span>, preg_quote($extensions)) . <span class="stringliteral">&#39;)$/i&#39;</span>;
<a name="l01682"></a>01682   <span class="keywordflow">if</span> (!preg_match($regex, $file-&gt;filename)) {
<a name="l01683"></a>01683     $errors[] = <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Only files with the following extensions are allowed: %files-allowed.&#39;</span>, array(<span class="stringliteral">&#39;%files-allowed&#39;</span> =&gt; $extensions));
<a name="l01684"></a>01684   }
<a name="l01685"></a>01685   <span class="keywordflow">return</span> $errors;
<a name="l01686"></a>01686 }
<a name="l01687"></a>01687 
<a name="l01708"></a><a class="code" href="group__file_gad5dc623436b94f82d7a110adf8590915.html#gad5dc623436b94f82d7a110adf8590915">01708</a> <span class="keyword">function</span> <a class="code" href="group__file_gad5dc623436b94f82d7a110adf8590915.html#gad5dc623436b94f82d7a110adf8590915" title="Checks that the file&#39;s size is below certain limits.">file_validate_size</a>(stdClass $file, $file_limit = 0, $user_limit = 0) {
<a name="l01709"></a>01709   global $user;
<a name="l01710"></a>01710 
<a name="l01711"></a>01711   $errors = array();
<a name="l01712"></a>01712 
<a name="l01713"></a>01713   <span class="comment">// Bypass validation for uid  = 1.</span>
<a name="l01714"></a>01714   <span class="keywordflow">if</span> ($user-&gt;uid != 1) {
<a name="l01715"></a>01715     <span class="keywordflow">if</span> ($file_limit &amp;&amp; $file-&gt;filesize &gt; $file_limit) {
<a name="l01716"></a>01716       $errors[] = <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The file is %filesize exceeding the maximum file size of %maxsize.&#39;</span>, array(<span class="stringliteral">&#39;%filesize&#39;</span> =&gt; <a class="code" href="group__format_ga2a0075e7646fa2f399286272faa2956e.html#ga2a0075e7646fa2f399286272faa2956e" title="Generates a string representation for the given byte count.">format_size</a>($file-&gt;filesize), <span class="stringliteral">&#39;%maxsize&#39;</span> =&gt; <a class="code" href="group__format_ga2a0075e7646fa2f399286272faa2956e.html#ga2a0075e7646fa2f399286272faa2956e" title="Generates a string representation for the given byte count.">format_size</a>($file_limit)));
<a name="l01717"></a>01717     }
<a name="l01718"></a>01718 
<a name="l01719"></a>01719     <span class="comment">// Save a query by only calling file_space_used() when a limit is provided.</span>
<a name="l01720"></a>01720     <span class="keywordflow">if</span> ($user_limit &amp;&amp; (<a class="code" href="group__file_gade600fbda0056f4aaea634e7178215b2.html#gade600fbda0056f4aaea634e7178215b2" title="Determines total disk space used by a single user or the whole filesystem.">file_space_used</a>($user-&gt;uid) + $file-&gt;filesize) &gt; $user_limit) {
<a name="l01721"></a>01721       $errors[] = <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The file is %filesize which would exceed your disk quota of %quota.&#39;</span>, array(<span class="stringliteral">&#39;%filesize&#39;</span> =&gt; <a class="code" href="group__format_ga2a0075e7646fa2f399286272faa2956e.html#ga2a0075e7646fa2f399286272faa2956e" title="Generates a string representation for the given byte count.">format_size</a>($file-&gt;filesize), <span class="stringliteral">&#39;%quota&#39;</span> =&gt; <a class="code" href="group__format_ga2a0075e7646fa2f399286272faa2956e.html#ga2a0075e7646fa2f399286272faa2956e" title="Generates a string representation for the given byte count.">format_size</a>($user_limit)));
<a name="l01722"></a>01722     }
<a name="l01723"></a>01723   }
<a name="l01724"></a>01724   <span class="keywordflow">return</span> $errors;
<a name="l01725"></a>01725 }
<a name="l01726"></a>01726 
<a name="l01738"></a><a class="code" href="group__file_ga4cf6d97afe1580b23a14d96fede02d01.html#ga4cf6d97afe1580b23a14d96fede02d01">01738</a> <span class="keyword">function</span> <a class="code" href="group__file_ga4cf6d97afe1580b23a14d96fede02d01.html#ga4cf6d97afe1580b23a14d96fede02d01" title="Checks that the file is recognized by image_get_info() as an image.">file_validate_is_image</a>(stdClass $file) {
<a name="l01739"></a>01739   $errors = array();
<a name="l01740"></a>01740 
<a name="l01741"></a>01741   $info = <a class="code" href="group__image_ga7b2603b2b9d073cc4db9a6200aa9c2a4.html#ga7b2603b2b9d073cc4db9a6200aa9c2a4" title="Get details about an image.">image_get_info</a>($file-&gt;uri);
<a name="l01742"></a>01742   <span class="keywordflow">if</span> (!$info || empty($info[<span class="stringliteral">&#39;extension&#39;</span>])) {
<a name="l01743"></a>01743     $errors[] = <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;Only JPEG, PNG and GIF images are allowed.&#39;</span>);
<a name="l01744"></a>01744   }
<a name="l01745"></a>01745 
<a name="l01746"></a>01746   <span class="keywordflow">return</span> $errors;
<a name="l01747"></a>01747 }
<a name="l01748"></a>01748 
<a name="l01773"></a><a class="code" href="group__file_gaa90145fbf8065f644871c9d770e3cce4.html#gaa90145fbf8065f644871c9d770e3cce4">01773</a> <span class="keyword">function</span> <a class="code" href="group__file_gaa90145fbf8065f644871c9d770e3cce4.html#gaa90145fbf8065f644871c9d770e3cce4" title="Verifies that image dimensions are within the specified maximum and minimum.">file_validate_image_resolution</a>(stdClass $file, $maximum_dimensions = 0, $minimum_dimensions = 0) {
<a name="l01774"></a>01774   $errors = array();
<a name="l01775"></a>01775 
<a name="l01776"></a>01776   <span class="comment">// Check first that the file is an image.</span>
<a name="l01777"></a>01777   <span class="keywordflow">if</span> ($info = <a class="code" href="group__image_ga7b2603b2b9d073cc4db9a6200aa9c2a4.html#ga7b2603b2b9d073cc4db9a6200aa9c2a4" title="Get details about an image.">image_get_info</a>($file-&gt;uri)) {
<a name="l01778"></a>01778     <span class="keywordflow">if</span> ($maximum_dimensions) {
<a name="l01779"></a>01779       <span class="comment">// Check that it is smaller than the given dimensions.</span>
<a name="l01780"></a>01780       list($width, $height) = explode(<span class="charliteral">&#39;x&#39;</span>, $maximum_dimensions);
<a name="l01781"></a>01781       <span class="keywordflow">if</span> ($info[<span class="stringliteral">&#39;width&#39;</span>] &gt; $width || $info[<span class="stringliteral">&#39;height&#39;</span>] &gt; $height) {
<a name="l01782"></a>01782         <span class="comment">// Try to resize the image to fit the dimensions.</span>
<a name="l01783"></a>01783         <span class="keywordflow">if</span> ($image = <a class="code" href="group__image_ga96098e5b039dc3906a656fa889a04776.html#ga96098e5b039dc3906a656fa889a04776" title="Load an image file and return an image object.">image_load</a>($file-&gt;uri)) {
<a name="l01784"></a>01784           <a class="code" href="group__image_ga2eac147bb70d14d9439d6b0d54023ce3.html#ga2eac147bb70d14d9439d6b0d54023ce3" title="Scales an image while maintaining aspect ratio.">image_scale</a>($image, $width, $height);
<a name="l01785"></a>01785           <a class="code" href="group__image_ga134df2e4d035378b52e866618c164f3b.html#ga134df2e4d035378b52e866618c164f3b" title="Close the image and save the changes to a file.">image_save</a>($image);
<a name="l01786"></a>01786           $file-&gt;filesize = $image-&gt;info[<span class="stringliteral">&#39;file_size&#39;</span>];
<a name="l01787"></a>01787           <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The image was resized to fit within the maximum allowed dimensions of %dimensions pixels.&#39;</span>, array(<span class="stringliteral">&#39;%dimensions&#39;</span> =&gt; $maximum_dimensions)));
<a name="l01788"></a>01788         }
<a name="l01789"></a>01789         <span class="keywordflow">else</span> {
<a name="l01790"></a>01790           $errors[] = <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The image is too large; the maximum dimensions are %dimensions pixels.&#39;</span>, array(<span class="stringliteral">&#39;%dimensions&#39;</span> =&gt; $maximum_dimensions));
<a name="l01791"></a>01791         }
<a name="l01792"></a>01792       }
<a name="l01793"></a>01793     }
<a name="l01794"></a>01794 
<a name="l01795"></a>01795     <span class="keywordflow">if</span> ($minimum_dimensions) {
<a name="l01796"></a>01796       <span class="comment">// Check that it is larger than the given dimensions.</span>
<a name="l01797"></a>01797       list($width, $height) = explode(<span class="charliteral">&#39;x&#39;</span>, $minimum_dimensions);
<a name="l01798"></a>01798       <span class="keywordflow">if</span> ($info[<span class="stringliteral">&#39;width&#39;</span>] &lt; $width || $info[<span class="stringliteral">&#39;height&#39;</span>] &lt; $height) {
<a name="l01799"></a>01799         $errors[] = <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The image is too small; the minimum dimensions are %dimensions pixels.&#39;</span>, array(<span class="stringliteral">&#39;%dimensions&#39;</span> =&gt; $minimum_dimensions));
<a name="l01800"></a>01800       }
<a name="l01801"></a>01801     }
<a name="l01802"></a>01802   }
<a name="l01803"></a>01803 
<a name="l01804"></a>01804   <span class="keywordflow">return</span> $errors;
<a name="l01805"></a>01805 }
<a name="l01806"></a>01806 
<a name="l01830"></a><a class="code" href="group__file_ga7a01611c7c08b91876d93431207dd9b0.html#ga7a01611c7c08b91876d93431207dd9b0">01830</a> <span class="keyword">function</span> <a class="code" href="group__file_ga7a01611c7c08b91876d93431207dd9b0.html#ga7a01611c7c08b91876d93431207dd9b0" title="Saves a file to the specified destination and creates a database entry.">file_save_data</a>($data, $destination = NULL, $replace = <a class="code" href="group__file_ga5d6636d4ccd022885823b91f17a0f464.html#ga5d6636d4ccd022885823b91f17a0f464" title="Flag for dealing with existing files: Appends number until name is unique.">FILE_EXISTS_RENAME</a>) {
<a name="l01831"></a>01831   global $user;
<a name="l01832"></a>01832 
<a name="l01833"></a>01833   <span class="keywordflow">if</span> (empty($destination)) {
<a name="l01834"></a>01834     $destination = <a class="code" href="group__file_ga360bf8899ace3c977d257510651a763d.html#ga360bf8899ace3c977d257510651a763d" title="Gets the default file stream implementation.">file_default_scheme</a>() . <span class="stringliteral">&#39;://&#39;</span>;
<a name="l01835"></a>01835   }
<a name="l01836"></a>01836   <span class="keywordflow">if</span> (!<a class="code" href="group__file_gad84d226f677dd5b6e53519026b7de67e.html#gad84d226f677dd5b6e53519026b7de67e" title="Determines whether the URI has a valid scheme for file API operations.">file_valid_uri</a>($destination)) {
<a name="l01837"></a>01837     <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;The data could not be saved because the destination %destination is invalid. This may be caused by improper use of file_save_data() or a missing stream wrapper.&#39;</span>, array(<span class="stringliteral">&#39;%destination&#39;</span> =&gt; $destination));
<a name="l01838"></a>01838     <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The data could not be saved, because the destination is invalid. More information is available in the system log.&#39;</span>), <span class="stringliteral">&#39;error&#39;</span>);
<a name="l01839"></a>01839     <span class="keywordflow">return</span> FALSE;
<a name="l01840"></a>01840   }
<a name="l01841"></a>01841 
<a name="l01842"></a>01842   <span class="keywordflow">if</span> ($uri = <a class="code" href="group__file_gac2d047d4471ec93803f584cda01a557c.html#gac2d047d4471ec93803f584cda01a557c" title="Saves a string to the specified destination without invoking file API.">file_unmanaged_save_data</a>($data, $destination, $replace)) {
<a name="l01843"></a>01843     <span class="comment">// Create a file object.</span>
<a name="l01844"></a>01844     $file = <span class="keyword">new</span> stdClass();
<a name="l01845"></a>01845     $file-&gt;fid = NULL;
<a name="l01846"></a>01846     $file-&gt;uri = $uri;
<a name="l01847"></a>01847     $file-&gt;filename = <a class="code" href="group__php__wrappers_ga0125d5e205f50be86146a8df58c2bc5f.html#ga0125d5e205f50be86146a8df58c2bc5f" title="Gets the filename from a given path.">drupal_basename</a>($uri);
<a name="l01848"></a>01848     $file-&gt;filemime = <a class="code" href="group__file_ga2f3c500f59ecd606e4022ed9d83a1dec.html#ga2f3c500f59ecd606e4022ed9d83a1dec" title="Determines an Internet Media Type or MIME type from a filename.">file_get_mimetype</a>($file-&gt;uri);
<a name="l01849"></a>01849     $file-&gt;uid      = $user-&gt;uid;
<a name="l01850"></a>01850     $file-&gt;status   = <a class="code" href="group__file_gaf208a7c7d7fd09276233583b22e4ee32.html#gaf208a7c7d7fd09276233583b22e4ee32" title="Indicates that the file is permanent and should not be deleted.">FILE_STATUS_PERMANENT</a>;
<a name="l01851"></a>01851     <span class="comment">// If we are replacing an existing file re-use its database record.</span>
<a name="l01852"></a>01852     <span class="keywordflow">if</span> ($replace == <a class="code" href="group__file_ga54c3c90d9cb7857114326cb5114e7159.html#ga54c3c90d9cb7857114326cb5114e7159" title="Flag for dealing with existing files: Replace the existing file.">FILE_EXISTS_REPLACE</a>) {
<a name="l01853"></a>01853       $existing_files = <a class="code" href="group__file_ga32afa29695b6da3f5d86cad18f063bfc.html#ga32afa29695b6da3f5d86cad18f063bfc" title="Loads file objects from the database.">file_load_multiple</a>(array(), array(<span class="stringliteral">&#39;uri&#39;</span> =&gt; $uri));
<a name="l01854"></a>01854       <span class="keywordflow">if</span> (count($existing_files)) {
<a name="l01855"></a>01855         $existing = reset($existing_files);
<a name="l01856"></a>01856         $file-&gt;fid = $existing-&gt;fid;
<a name="l01857"></a>01857         $file-&gt;filename = $existing-&gt;filename;
<a name="l01858"></a>01858       }
<a name="l01859"></a>01859     }
<a name="l01860"></a>01860     <span class="comment">// If we are renaming around an existing file (rather than a directory),</span>
<a name="l01861"></a>01861     <span class="comment">// use its basename for the filename.</span>
<a name="l01862"></a>01862     elseif ($replace == <a class="code" href="group__file_ga5d6636d4ccd022885823b91f17a0f464.html#ga5d6636d4ccd022885823b91f17a0f464" title="Flag for dealing with existing files: Appends number until name is unique.">FILE_EXISTS_RENAME</a> &amp;&amp; is_file($destination)) {
<a name="l01863"></a>01863       $file-&gt;filename = <a class="code" href="group__php__wrappers_ga0125d5e205f50be86146a8df58c2bc5f.html#ga0125d5e205f50be86146a8df58c2bc5f" title="Gets the filename from a given path.">drupal_basename</a>($destination);
<a name="l01864"></a>01864     }
<a name="l01865"></a>01865 
<a name="l01866"></a>01866     <span class="keywordflow">return</span> <a class="code" href="group__file_ga80327cb23d8d384b827b2637cd8cc4ba.html#ga80327cb23d8d384b827b2637cd8cc4ba" title="Saves a file object to the database.">file_save</a>($file);
<a name="l01867"></a>01867   }
<a name="l01868"></a>01868   <span class="keywordflow">return</span> FALSE;
<a name="l01869"></a>01869 }
<a name="l01870"></a>01870 
<a name="l01897"></a><a class="code" href="group__file_gac2d047d4471ec93803f584cda01a557c.html#gac2d047d4471ec93803f584cda01a557c">01897</a> <span class="keyword">function</span> <a class="code" href="group__file_gac2d047d4471ec93803f584cda01a557c.html#gac2d047d4471ec93803f584cda01a557c" title="Saves a string to the specified destination without invoking file API.">file_unmanaged_save_data</a>($data, $destination = NULL, $replace = <a class="code" href="group__file_ga5d6636d4ccd022885823b91f17a0f464.html#ga5d6636d4ccd022885823b91f17a0f464" title="Flag for dealing with existing files: Appends number until name is unique.">FILE_EXISTS_RENAME</a>) {
<a name="l01898"></a>01898   <span class="comment">// Write the data to a temporary file.</span>
<a name="l01899"></a>01899   $temp_name = <a class="code" href="group__php__wrappers_ga47b9f13fc4bed06501c52d1808de1661.html#ga47b9f13fc4bed06501c52d1808de1661" title="Creates a file with a unique filename in the specified directory.">drupal_tempnam</a>(<span class="stringliteral">&#39;temporary://&#39;</span>, <span class="stringliteral">&#39;file&#39;</span>);
<a name="l01900"></a>01900   <span class="keywordflow">if</span> (file_put_contents($temp_name, $data) === FALSE) {
<a name="l01901"></a>01901     <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;The file could not be created.&#39;</span>), <span class="stringliteral">&#39;error&#39;</span>);
<a name="l01902"></a>01902     <span class="keywordflow">return</span> FALSE;
<a name="l01903"></a>01903   }
<a name="l01904"></a>01904 
<a name="l01905"></a>01905   <span class="comment">// Move the file to its final destination.</span>
<a name="l01906"></a>01906   <span class="keywordflow">return</span> <a class="code" href="group__file_ga3fd3a919ca321ec8c5bd1e4b069237a1.html#ga3fd3a919ca321ec8c5bd1e4b069237a1" title="Moves a file to a new location without database changes or hook invocation.">file_unmanaged_move</a>($temp_name, $destination, $replace);
<a name="l01907"></a>01907 }
<a name="l01908"></a>01908 
<a name="l01919"></a><a class="code" href="group__file_ga7b047ab67ab5bb3882d573d7e06ab485.html#ga7b047ab67ab5bb3882d573d7e06ab485">01919</a> <span class="keyword">function</span> <a class="code" href="group__file_ga7b047ab67ab5bb3882d573d7e06ab485.html#ga7b047ab67ab5bb3882d573d7e06ab485" title="Transfers a file to the client using HTTP.">file_transfer</a>($uri, $headers) {
<a name="l01920"></a>01920   <span class="keywordflow">if</span> (ob_get_level()) {
<a name="l01921"></a>01921     ob_end_clean();
<a name="l01922"></a>01922   }
<a name="l01923"></a>01923 
<a name="l01924"></a>01924   <span class="keywordflow">foreach</span> ($headers as $name =&gt; $value) {
<a name="l01925"></a>01925     <a class="code" href="bootstrap_8inc_ad4ff2b2cf5a2fb632c2c869bc1a5a70f.html#ad4ff2b2cf5a2fb632c2c869bc1a5a70f" title="Sets an HTTP response header for the current page.">drupal_add_http_header</a>($name, $value);
<a name="l01926"></a>01926   }
<a name="l01927"></a>01927   <a class="code" href="bootstrap_8inc_a903274a2d3421ae33eaa053b36ac9855.html#a903274a2d3421ae33eaa053b36ac9855" title="Sends the HTTP response headers that were previously set, adding defaults.">drupal_send_headers</a>();
<a name="l01928"></a>01928   $scheme = <a class="code" href="group__file_gaa98f967fe1033030e7e5262adda85463.html#gaa98f967fe1033030e7e5262adda85463" title="Returns the scheme of a URI (e.g.">file_uri_scheme</a>($uri);
<a name="l01929"></a>01929   <span class="comment">// Transfer file in 1024 byte chunks to save memory usage.</span>
<a name="l01930"></a>01930   <span class="keywordflow">if</span> ($scheme &amp;&amp; <a class="code" href="group__file_ga12aebc3c6a9eb56d08511e7b968d0cef.html#ga12aebc3c6a9eb56d08511e7b968d0cef" title="Checks that the scheme of a stream URI is valid.">file_stream_wrapper_valid_scheme</a>($scheme) &amp;&amp; $fd = fopen($uri, <span class="stringliteral">&#39;rb&#39;</span>)) {
<a name="l01931"></a>01931     <span class="keywordflow">while</span> (!feof($fd)) {
<a name="l01932"></a>01932       print fread($fd, 1024);
<a name="l01933"></a>01933     }
<a name="l01934"></a>01934     fclose($fd);
<a name="l01935"></a>01935   }
<a name="l01936"></a>01936   <span class="keywordflow">else</span> {
<a name="l01937"></a>01937     <a class="code" href="group__http__handling_ga52b08cd98e1756326c1bd5b56c39a884.html#ga52b08cd98e1756326c1bd5b56c39a884" title="Delivers a &quot;page not found&quot; error to the browser.">drupal_not_found</a>();
<a name="l01938"></a>01938   }
<a name="l01939"></a>01939   <a class="code" href="common_8inc_abe82fff35edd9a4da0d3fe4ef1a95614.html#abe82fff35edd9a4da0d3fe4ef1a95614" title="Performs end-of-request tasks.">drupal_exit</a>();
<a name="l01940"></a>01940 }
<a name="l01941"></a>01941 
<a name="l01954"></a><a class="code" href="group__file_ga91226299fab7e95a673f6461bbc19b02.html#ga91226299fab7e95a673f6461bbc19b02">01954</a> <span class="keyword">function</span> <a class="code" href="group__file_ga91226299fab7e95a673f6461bbc19b02.html#ga91226299fab7e95a673f6461bbc19b02" title="Menu handler for private file transfers.">file_download</a>() {
<a name="l01955"></a>01955   <span class="comment">// Merge remainder of arguments from GET[&#39;q&#39;], into relative file path.</span>
<a name="l01956"></a>01956   $args = func_get_args();
<a name="l01957"></a>01957   $scheme = array_shift($args);
<a name="l01958"></a>01958   $target = implode(<span class="charliteral">&#39;/&#39;</span>, $args);
<a name="l01959"></a>01959   $uri = $scheme . <span class="stringliteral">&#39;://&#39;</span> . $target;
<a name="l01960"></a>01960   <span class="keywordflow">if</span> (<a class="code" href="group__file_ga12aebc3c6a9eb56d08511e7b968d0cef.html#ga12aebc3c6a9eb56d08511e7b968d0cef" title="Checks that the scheme of a stream URI is valid.">file_stream_wrapper_valid_scheme</a>($scheme) &amp;&amp; file_exists($uri)) {
<a name="l01961"></a>01961     <span class="comment">// Let other modules provide headers and controls access to the file.</span>
<a name="l01962"></a>01962     <span class="comment">// module_invoke_all() uses array_merge_recursive() which merges header</span>
<a name="l01963"></a>01963     <span class="comment">// values into a new array. To avoid that and allow modules to override</span>
<a name="l01964"></a>01964     <span class="comment">// headers instead, use array_merge() to merge the returned arrays.</span>
<a name="l01965"></a>01965     $headers = array();
<a name="l01966"></a>01966     <span class="keywordflow">foreach</span> (<a class="code" href="group__hooks_ga9191200072f2a641829e9d3c2759561f.html#ga9191200072f2a641829e9d3c2759561f" title="Determine which modules are implementing a hook.">module_implements</a>(<span class="stringliteral">&#39;file_download&#39;</span>) as $module) {
<a name="l01967"></a>01967       $function = $module . <span class="stringliteral">&#39;_file_download&#39;</span>;
<a name="l01968"></a>01968       $result = $function($uri);
<a name="l01969"></a>01969       <span class="keywordflow">if</span> ($result == -1) {
<a name="l01970"></a>01970         <span class="comment">// Throw away the headers received so far.</span>
<a name="l01971"></a>01971         $headers = array();
<a name="l01972"></a>01972         <span class="keywordflow">break</span>;
<a name="l01973"></a>01973       }
<a name="l01974"></a>01974       <span class="keywordflow">if</span> (isset($result) &amp;&amp; is_array($result)) {
<a name="l01975"></a>01975         $headers = array_merge($headers, $result);
<a name="l01976"></a>01976       }
<a name="l01977"></a>01977     }
<a name="l01978"></a>01978     <span class="keywordflow">if</span> (count($headers)) {
<a name="l01979"></a>01979       <a class="code" href="group__file_ga7b047ab67ab5bb3882d573d7e06ab485.html#ga7b047ab67ab5bb3882d573d7e06ab485" title="Transfers a file to the client using HTTP.">file_transfer</a>($uri, $headers);
<a name="l01980"></a>01980     }
<a name="l01981"></a>01981     <a class="code" href="group__http__handling_ga0bbff371f9373002e71f2e1347fcf481.html#ga0bbff371f9373002e71f2e1347fcf481" title="Delivers an &quot;access denied&quot; error to the browser.">drupal_access_denied</a>();
<a name="l01982"></a>01982   }
<a name="l01983"></a>01983   <span class="keywordflow">else</span> {
<a name="l01984"></a>01984     <a class="code" href="group__http__handling_ga52b08cd98e1756326c1bd5b56c39a884.html#ga52b08cd98e1756326c1bd5b56c39a884" title="Delivers a &quot;page not found&quot; error to the browser.">drupal_not_found</a>();
<a name="l01985"></a>01985   }
<a name="l01986"></a>01986   <a class="code" href="common_8inc_abe82fff35edd9a4da0d3fe4ef1a95614.html#abe82fff35edd9a4da0d3fe4ef1a95614" title="Performs end-of-request tasks.">drupal_exit</a>();
<a name="l01987"></a>01987 }
<a name="l01988"></a>01988 
<a name="l01989"></a>01989 
<a name="l02023"></a><a class="code" href="group__file_ga363e988787ffa45bff69ff051eed0615.html#ga363e988787ffa45bff69ff051eed0615">02023</a> <span class="keyword">function</span> <a class="code" href="group__file_ga363e988787ffa45bff69ff051eed0615.html#ga363e988787ffa45bff69ff051eed0615" title="Finds all files that match a given mask in a given directory.">file_scan_directory</a>($dir, $mask, $options = array(), $depth = 0) {
<a name="l02024"></a>02024   <span class="comment">// Merge in defaults.</span>
<a name="l02025"></a>02025   $options += array(
<a name="l02026"></a>02026     <span class="stringliteral">&#39;nomask&#39;</span> =&gt; <span class="stringliteral">&#39;/(\.\.?|CVS)$/&#39;</span>,
<a name="l02027"></a>02027     <span class="stringliteral">&#39;callback&#39;</span> =&gt; 0,
<a name="l02028"></a>02028     <span class="stringliteral">&#39;recurse&#39;</span> =&gt; TRUE,
<a name="l02029"></a>02029     <span class="stringliteral">&#39;key&#39;</span> =&gt; <span class="stringliteral">&#39;uri&#39;</span>,
<a name="l02030"></a>02030     <span class="stringliteral">&#39;min_depth&#39;</span> =&gt; 0,
<a name="l02031"></a>02031   );
<a name="l02032"></a>02032 
<a name="l02033"></a>02033   $options[<span class="stringliteral">&#39;key&#39;</span>] = in_array($options[<span class="stringliteral">&#39;key&#39;</span>], array(<span class="stringliteral">&#39;uri&#39;</span>, <span class="stringliteral">&#39;filename&#39;</span>, <span class="stringliteral">&#39;name&#39;</span>)) ? $options[<span class="stringliteral">&#39;key&#39;</span>] : <span class="stringliteral">&#39;uri&#39;</span>;
<a name="l02034"></a>02034   $files = array();
<a name="l02035"></a>02035   <span class="keywordflow">if</span> (is_dir($dir) &amp;&amp; $handle = opendir($dir)) {
<a name="l02036"></a>02036     <span class="keywordflow">while</span> (FALSE !== ($filename = readdir($handle))) {
<a name="l02037"></a>02037       <span class="keywordflow">if</span> (!preg_match($options[<span class="stringliteral">&#39;nomask&#39;</span>], $filename) &amp;&amp; $filename[0] != <span class="charliteral">&#39;.&#39;</span>) {
<a name="l02038"></a>02038         $uri = <span class="stringliteral">&quot;$dir/$filename&quot;</span>;
<a name="l02039"></a>02039         $uri = <a class="code" href="group__file_gafd9a522999855ed89191e4e58bbbfeb3.html#gafd9a522999855ed89191e4e58bbbfeb3" title="Normalizes a URI by making it syntactically correct.">file_stream_wrapper_uri_normalize</a>($uri);
<a name="l02040"></a>02040         <span class="keywordflow">if</span> (is_dir($uri) &amp;&amp; $options[<span class="stringliteral">&#39;recurse&#39;</span>]) {
<a name="l02041"></a>02041           <span class="comment">// Give priority to files in this folder by merging them in after any subdirectory files.</span>
<a name="l02042"></a>02042           $files = array_merge(<a class="code" href="group__file_ga363e988787ffa45bff69ff051eed0615.html#ga363e988787ffa45bff69ff051eed0615" title="Finds all files that match a given mask in a given directory.">file_scan_directory</a>($uri, $mask, $options, $depth + 1), $files);
<a name="l02043"></a>02043         }
<a name="l02044"></a>02044         elseif ($depth &gt;= $options[<span class="stringliteral">&#39;min_depth&#39;</span>] &amp;&amp; preg_match($mask, $filename)) {
<a name="l02045"></a>02045           <span class="comment">// Always use this match over anything already set in $files with the</span>
<a name="l02046"></a>02046           <span class="comment">// same $$options[&#39;key&#39;].</span>
<a name="l02047"></a>02047           $file = <span class="keyword">new</span> stdClass();
<a name="l02048"></a>02048           $file-&gt;uri = $uri;
<a name="l02049"></a>02049           $file-&gt;filename = $filename;
<a name="l02050"></a>02050           $file-&gt;name = pathinfo($filename, PATHINFO_FILENAME);
<a name="l02051"></a>02051           $key = $options[<span class="stringliteral">&#39;key&#39;</span>];
<a name="l02052"></a>02052           $files[$file-&gt;$key] = $file;
<a name="l02053"></a>02053           <span class="keywordflow">if</span> ($options[<span class="stringliteral">&#39;callback&#39;</span>]) {
<a name="l02054"></a>02054             $options[<span class="stringliteral">&#39;callback&#39;</span>]($uri);
<a name="l02055"></a>02055           }
<a name="l02056"></a>02056         }
<a name="l02057"></a>02057       }
<a name="l02058"></a>02058     }
<a name="l02059"></a>02059 
<a name="l02060"></a>02060     closedir($handle);
<a name="l02061"></a>02061   }
<a name="l02062"></a>02062 
<a name="l02063"></a>02063   <span class="keywordflow">return</span> $files;
<a name="l02064"></a>02064 }
<a name="l02065"></a>02065 
<a name="l02073"></a><a class="code" href="group__file_ga7cf25e6a2532a1d022ee1c655f895380.html#ga7cf25e6a2532a1d022ee1c655f895380">02073</a> <span class="keyword">function</span> <a class="code" href="group__file_ga7cf25e6a2532a1d022ee1c655f895380.html#ga7cf25e6a2532a1d022ee1c655f895380" title="Determines the maximum file upload size by querying the PHP settings.">file_upload_max_size</a>() {
<a name="l02074"></a>02074   <span class="keyword">static</span> $max_size = -1;
<a name="l02075"></a>02075 
<a name="l02076"></a>02076   <span class="keywordflow">if</span> ($max_size &lt; 0) {
<a name="l02077"></a>02077     <span class="comment">// Start with post_max_size.</span>
<a name="l02078"></a>02078     $max_size = <a class="code" href="group__format_ga08382023ada29bae2a6a94f22196b066.html#ga08382023ada29bae2a6a94f22196b066" title="Parses a given byte count.">parse_size</a>(ini_get(<span class="stringliteral">&#39;post_max_size&#39;</span>));
<a name="l02079"></a>02079 
<a name="l02080"></a>02080     <span class="comment">// If upload_max_size is less, then reduce. Except if upload_max_size is</span>
<a name="l02081"></a>02081     <span class="comment">// zero, which indicates no limit.</span>
<a name="l02082"></a>02082     $upload_max = <a class="code" href="group__format_ga08382023ada29bae2a6a94f22196b066.html#ga08382023ada29bae2a6a94f22196b066" title="Parses a given byte count.">parse_size</a>(ini_get(<span class="stringliteral">&#39;upload_max_filesize&#39;</span>));
<a name="l02083"></a>02083     <span class="keywordflow">if</span> ($upload_max &gt; 0 &amp;&amp; $upload_max &lt; $max_size) {
<a name="l02084"></a>02084       $max_size = $upload_max;
<a name="l02085"></a>02085     }
<a name="l02086"></a>02086   }
<a name="l02087"></a>02087   <span class="keywordflow">return</span> $max_size;
<a name="l02088"></a>02088 }
<a name="l02089"></a>02089 
<a name="l02108"></a><a class="code" href="group__file_ga2f3c500f59ecd606e4022ed9d83a1dec.html#ga2f3c500f59ecd606e4022ed9d83a1dec">02108</a> <span class="keyword">function</span> <a class="code" href="group__file_ga2f3c500f59ecd606e4022ed9d83a1dec.html#ga2f3c500f59ecd606e4022ed9d83a1dec" title="Determines an Internet Media Type or MIME type from a filename.">file_get_mimetype</a>($uri, $mapping = NULL) {
<a name="l02109"></a>02109   <span class="keywordflow">if</span> ($wrapper = <a class="code" href="group__file_ga2a693e908e5d4764c56f60b94070a635.html#ga2a693e908e5d4764c56f60b94070a635" title="Returns a reference to the stream wrapper class responsible for a given URI.">file_stream_wrapper_get_instance_by_uri</a>($uri)) {
<a name="l02110"></a>02110     <span class="keywordflow">return</span> $wrapper-&gt;getMimeType($uri, $mapping);
<a name="l02111"></a>02111   }
<a name="l02112"></a>02112   <span class="keywordflow">else</span> {
<a name="l02113"></a>02113     <span class="comment">// getMimeType() is not implementation specific, so we can directly</span>
<a name="l02114"></a>02114     <span class="comment">// call it without an instance.</span>
<a name="l02115"></a>02115     <span class="keywordflow">return</span> <a class="code" href="classDrupalLocalStreamWrapper_ae6baa873a904204192636830d2bacaac.html#ae6baa873a904204192636830d2bacaac" title="Base implementation of getMimeType().">DrupalLocalStreamWrapper::getMimeType</a>($uri, $mapping);
<a name="l02116"></a>02116   }
<a name="l02117"></a>02117 }
<a name="l02118"></a>02118 
<a name="l02145"></a><a class="code" href="group__php__wrappers_ga5fc93f1c4e81ea4f5b1b32775fca489c.html#ga5fc93f1c4e81ea4f5b1b32775fca489c">02145</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_ga5fc93f1c4e81ea4f5b1b32775fca489c.html#ga5fc93f1c4e81ea4f5b1b32775fca489c" title="Sets the permissions on a file or directory.">drupal_chmod</a>($uri, $mode = NULL) {
<a name="l02146"></a>02146   <span class="keywordflow">if</span> (!isset($mode)) {
<a name="l02147"></a>02147     <span class="keywordflow">if</span> (is_dir($uri)) {
<a name="l02148"></a>02148       $mode = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;file_chmod_directory&#39;</span>, 0775);
<a name="l02149"></a>02149     }
<a name="l02150"></a>02150     <span class="keywordflow">else</span> {
<a name="l02151"></a>02151       $mode = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;file_chmod_file&#39;</span>, 0664);
<a name="l02152"></a>02152     }
<a name="l02153"></a>02153   }
<a name="l02154"></a>02154 
<a name="l02155"></a>02155   <span class="comment">// If this URI is a stream, pass it off to the appropriate stream wrapper.</span>
<a name="l02156"></a>02156   <span class="comment">// Otherwise, attempt PHP&#39;s chmod. This allows use of drupal_chmod even</span>
<a name="l02157"></a>02157   <span class="comment">// for unmanaged files outside of the stream wrapper interface.</span>
<a name="l02158"></a>02158   <span class="keywordflow">if</span> ($wrapper = <a class="code" href="group__file_ga2a693e908e5d4764c56f60b94070a635.html#ga2a693e908e5d4764c56f60b94070a635" title="Returns a reference to the stream wrapper class responsible for a given URI.">file_stream_wrapper_get_instance_by_uri</a>($uri)) {
<a name="l02159"></a>02159     <span class="keywordflow">if</span> ($wrapper-&gt;chmod($mode)) {
<a name="l02160"></a>02160       <span class="keywordflow">return</span> TRUE;
<a name="l02161"></a>02161     }
<a name="l02162"></a>02162   }
<a name="l02163"></a>02163   <span class="keywordflow">else</span> {
<a name="l02164"></a>02164     <span class="keywordflow">if</span> (@chmod($uri, $mode)) {
<a name="l02165"></a>02165       <span class="keywordflow">return</span> TRUE;
<a name="l02166"></a>02166     }
<a name="l02167"></a>02167   }
<a name="l02168"></a>02168 
<a name="l02169"></a>02169   <a class="code" href="bootstrap_8inc_acb7338e6740302727043d64e3ae1257b.html#acb7338e6740302727043d64e3ae1257b" title="Logs a system message.">watchdog</a>(<span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;The file permissions could not be set on %uri.&#39;</span>, array(<span class="stringliteral">&#39;%uri&#39;</span> =&gt; $uri), <a class="code" href="group__logging__severity__levels_ga174c9df2936096e11986fcf184d48576.html#ga174c9df2936096e11986fcf184d48576" title="Log message severity -- Error conditions.">WATCHDOG_ERROR</a>);
<a name="l02170"></a>02170   <span class="keywordflow">return</span> FALSE;
<a name="l02171"></a>02171 }
<a name="l02172"></a>02172 
<a name="l02190"></a><a class="code" href="group__php__wrappers_ga533bc32da8860919d20d60ada655e494.html#ga533bc32da8860919d20d60ada655e494">02190</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_ga533bc32da8860919d20d60ada655e494.html#ga533bc32da8860919d20d60ada655e494" title="Deletes a file.">drupal_unlink</a>($uri, $context = NULL) {
<a name="l02191"></a>02191   $scheme = <a class="code" href="group__file_gaa98f967fe1033030e7e5262adda85463.html#gaa98f967fe1033030e7e5262adda85463" title="Returns the scheme of a URI (e.g.">file_uri_scheme</a>($uri);
<a name="l02192"></a>02192   <span class="keywordflow">if</span> ((!$scheme || !<a class="code" href="group__file_ga12aebc3c6a9eb56d08511e7b968d0cef.html#ga12aebc3c6a9eb56d08511e7b968d0cef" title="Checks that the scheme of a stream URI is valid.">file_stream_wrapper_valid_scheme</a>($scheme)) &amp;&amp; (substr(PHP_OS, 0, 3) == <span class="stringliteral">&#39;WIN&#39;</span>)) {
<a name="l02193"></a>02193     chmod($uri, 0600);
<a name="l02194"></a>02194   }
<a name="l02195"></a>02195   <span class="keywordflow">if</span> ($context) {
<a name="l02196"></a>02196     <span class="keywordflow">return</span> unlink($uri, $context);
<a name="l02197"></a>02197   }
<a name="l02198"></a>02198   <span class="keywordflow">else</span> {
<a name="l02199"></a>02199     <span class="keywordflow">return</span> unlink($uri);
<a name="l02200"></a>02200   }
<a name="l02201"></a>02201 }
<a name="l02202"></a>02202 
<a name="l02232"></a><a class="code" href="group__php__wrappers_gafaa5b186c9e78f53b39aae12633eea44.html#gafaa5b186c9e78f53b39aae12633eea44">02232</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_gafaa5b186c9e78f53b39aae12633eea44.html#gafaa5b186c9e78f53b39aae12633eea44" title="Returns the absolute local filesystem path of a stream URI.">drupal_realpath</a>($uri) {
<a name="l02233"></a>02233   <span class="comment">// If this URI is a stream, pass it off to the appropriate stream wrapper.</span>
<a name="l02234"></a>02234   <span class="comment">// Otherwise, attempt PHP&#39;s realpath. This allows use of drupal_realpath even</span>
<a name="l02235"></a>02235   <span class="comment">// for unmanaged files outside of the stream wrapper interface.</span>
<a name="l02236"></a>02236   <span class="keywordflow">if</span> ($wrapper = <a class="code" href="group__file_ga2a693e908e5d4764c56f60b94070a635.html#ga2a693e908e5d4764c56f60b94070a635" title="Returns a reference to the stream wrapper class responsible for a given URI.">file_stream_wrapper_get_instance_by_uri</a>($uri)) {
<a name="l02237"></a>02237     <span class="keywordflow">return</span> $wrapper-&gt;realpath();
<a name="l02238"></a>02238   }
<a name="l02239"></a>02239   <span class="comment">// Check that the uri has a value. There is a bug in PHP 5.2 on *BSD systems</span>
<a name="l02240"></a>02240   <span class="comment">// that makes realpath not return FALSE as expected when passing an empty</span>
<a name="l02241"></a>02241   <span class="comment">// variable.</span>
<a name="l02242"></a>02242   <span class="comment">// @todo Remove when Drupal drops support for PHP 5.2.</span>
<a name="l02243"></a>02243   elseif (!empty($uri)) {
<a name="l02244"></a>02244     <span class="keywordflow">return</span> realpath($uri);
<a name="l02245"></a>02245   }
<a name="l02246"></a>02246   <span class="keywordflow">return</span> FALSE;
<a name="l02247"></a>02247 }
<a name="l02248"></a>02248 
<a name="l02268"></a><a class="code" href="group__php__wrappers_gad00418a5880c03f43e5eccfaa62863f6.html#gad00418a5880c03f43e5eccfaa62863f6">02268</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_gad00418a5880c03f43e5eccfaa62863f6.html#gad00418a5880c03f43e5eccfaa62863f6" title="Gets the name of the directory from a given path.">drupal_dirname</a>($uri) {
<a name="l02269"></a>02269   $scheme = <a class="code" href="group__file_gaa98f967fe1033030e7e5262adda85463.html#gaa98f967fe1033030e7e5262adda85463" title="Returns the scheme of a URI (e.g.">file_uri_scheme</a>($uri);
<a name="l02270"></a>02270 
<a name="l02271"></a>02271   <span class="keywordflow">if</span> ($scheme &amp;&amp; <a class="code" href="group__file_ga12aebc3c6a9eb56d08511e7b968d0cef.html#ga12aebc3c6a9eb56d08511e7b968d0cef" title="Checks that the scheme of a stream URI is valid.">file_stream_wrapper_valid_scheme</a>($scheme)) {
<a name="l02272"></a>02272     <span class="keywordflow">return</span> <a class="code" href="group__file_ga6b037293e4cfecbabbd8db32191778a5.html#ga6b037293e4cfecbabbd8db32191778a5" title="Returns a reference to the stream wrapper class responsible for a scheme.">file_stream_wrapper_get_instance_by_scheme</a>($scheme)-&gt;dirname($uri);
<a name="l02273"></a>02273   }
<a name="l02274"></a>02274   <span class="keywordflow">else</span> {
<a name="l02275"></a>02275     <span class="keywordflow">return</span> dirname($uri);
<a name="l02276"></a>02276   }
<a name="l02277"></a>02277 }
<a name="l02278"></a>02278 
<a name="l02290"></a><a class="code" href="group__php__wrappers_ga0125d5e205f50be86146a8df58c2bc5f.html#ga0125d5e205f50be86146a8df58c2bc5f">02290</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_ga0125d5e205f50be86146a8df58c2bc5f.html#ga0125d5e205f50be86146a8df58c2bc5f" title="Gets the filename from a given path.">drupal_basename</a>($uri, $suffix = NULL) {
<a name="l02291"></a>02291   $separators = <span class="charliteral">&#39;/&#39;</span>;
<a name="l02292"></a>02292   <span class="keywordflow">if</span> (DIRECTORY_SEPARATOR != <span class="charliteral">&#39;/&#39;</span>) {
<a name="l02293"></a>02293     <span class="comment">// For Windows OS add special separator.</span>
<a name="l02294"></a>02294     $separators .= DIRECTORY_SEPARATOR;
<a name="l02295"></a>02295   }
<a name="l02296"></a>02296   <span class="comment">// Remove right-most slashes when $uri points to directory.</span>
<a name="l02297"></a>02297   $uri = rtrim($uri, $separators);
<a name="l02298"></a>02298   <span class="comment">// Returns the trailing part of the $uri starting after one of the directory</span>
<a name="l02299"></a>02299   <span class="comment">// separators.</span>
<a name="l02300"></a>02300   $filename = preg_match(<span class="stringliteral">&#39;@[^&#39;</span> . preg_quote($separators, <span class="charliteral">&#39;@&#39;</span>) . <span class="stringliteral">&#39;]+$@&#39;</span>, $uri, $matches) ? $matches[0] : <span class="stringliteral">&#39;&#39;</span>;
<a name="l02301"></a>02301   <span class="comment">// Cuts off a suffix from the filename.</span>
<a name="l02302"></a>02302   <span class="keywordflow">if</span> ($suffix) {
<a name="l02303"></a>02303     $filename = preg_replace(<span class="charliteral">&#39;@&#39;</span> . preg_quote($suffix, <span class="charliteral">&#39;@&#39;</span>) . <span class="stringliteral">&#39;$@&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $filename);
<a name="l02304"></a>02304   }
<a name="l02305"></a>02305   <span class="keywordflow">return</span> $filename;
<a name="l02306"></a>02306 }
<a name="l02307"></a>02307 
<a name="l02332"></a><a class="code" href="group__php__wrappers_ga0cd03adb94eea525f87fb061c9a33340.html#ga0cd03adb94eea525f87fb061c9a33340">02332</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_ga0cd03adb94eea525f87fb061c9a33340.html#ga0cd03adb94eea525f87fb061c9a33340" title="Creates a directory using Drupal&#39;s default mode.">drupal_mkdir</a>($uri, $mode = NULL, $recursive = FALSE, $context = NULL) {
<a name="l02333"></a>02333   <span class="keywordflow">if</span> (!isset($mode)) {
<a name="l02334"></a>02334     $mode = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;file_chmod_directory&#39;</span>, 0775);
<a name="l02335"></a>02335   }
<a name="l02336"></a>02336 
<a name="l02337"></a>02337   <span class="keywordflow">if</span> (!isset($context)) {
<a name="l02338"></a>02338     <span class="keywordflow">return</span> mkdir($uri, $mode, $recursive);
<a name="l02339"></a>02339   }
<a name="l02340"></a>02340   <span class="keywordflow">else</span> {
<a name="l02341"></a>02341     <span class="keywordflow">return</span> mkdir($uri, $mode, $recursive, $context);
<a name="l02342"></a>02342   }
<a name="l02343"></a>02343 }
<a name="l02344"></a>02344 
<a name="l02362"></a><a class="code" href="group__php__wrappers_ga394629431629976febfae765abd63e48.html#ga394629431629976febfae765abd63e48">02362</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_ga394629431629976febfae765abd63e48.html#ga394629431629976febfae765abd63e48" title="Removes a directory.">drupal_rmdir</a>($uri, $context = NULL) {
<a name="l02363"></a>02363   $scheme = <a class="code" href="group__file_gaa98f967fe1033030e7e5262adda85463.html#gaa98f967fe1033030e7e5262adda85463" title="Returns the scheme of a URI (e.g.">file_uri_scheme</a>($uri);
<a name="l02364"></a>02364   <span class="keywordflow">if</span> ((!$scheme || !<a class="code" href="group__file_ga12aebc3c6a9eb56d08511e7b968d0cef.html#ga12aebc3c6a9eb56d08511e7b968d0cef" title="Checks that the scheme of a stream URI is valid.">file_stream_wrapper_valid_scheme</a>($scheme)) &amp;&amp; (substr(PHP_OS, 0, 3) == <span class="stringliteral">&#39;WIN&#39;</span>)) {
<a name="l02365"></a>02365     chmod($uri, 0700);
<a name="l02366"></a>02366   }
<a name="l02367"></a>02367   <span class="keywordflow">if</span> ($context) {
<a name="l02368"></a>02368     <span class="keywordflow">return</span> rmdir($uri, $context);
<a name="l02369"></a>02369   }
<a name="l02370"></a>02370   <span class="keywordflow">else</span> {
<a name="l02371"></a>02371     <span class="keywordflow">return</span> rmdir($uri);
<a name="l02372"></a>02372   }
<a name="l02373"></a>02373 }
<a name="l02374"></a>02374 
<a name="l02397"></a><a class="code" href="group__php__wrappers_ga47b9f13fc4bed06501c52d1808de1661.html#ga47b9f13fc4bed06501c52d1808de1661">02397</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_ga47b9f13fc4bed06501c52d1808de1661.html#ga47b9f13fc4bed06501c52d1808de1661" title="Creates a file with a unique filename in the specified directory.">drupal_tempnam</a>($directory, $prefix) {
<a name="l02398"></a>02398   $scheme = <a class="code" href="group__file_gaa98f967fe1033030e7e5262adda85463.html#gaa98f967fe1033030e7e5262adda85463" title="Returns the scheme of a URI (e.g.">file_uri_scheme</a>($directory);
<a name="l02399"></a>02399 
<a name="l02400"></a>02400   <span class="keywordflow">if</span> ($scheme &amp;&amp; <a class="code" href="group__file_ga12aebc3c6a9eb56d08511e7b968d0cef.html#ga12aebc3c6a9eb56d08511e7b968d0cef" title="Checks that the scheme of a stream URI is valid.">file_stream_wrapper_valid_scheme</a>($scheme)) {
<a name="l02401"></a>02401     $wrapper = <a class="code" href="group__file_ga6b037293e4cfecbabbd8db32191778a5.html#ga6b037293e4cfecbabbd8db32191778a5" title="Returns a reference to the stream wrapper class responsible for a scheme.">file_stream_wrapper_get_instance_by_scheme</a>($scheme);
<a name="l02402"></a>02402 
<a name="l02403"></a>02403     <span class="keywordflow">if</span> ($filename = tempnam($wrapper-&gt;getDirectoryPath(), $prefix)) {
<a name="l02404"></a>02404       <span class="keywordflow">return</span> $scheme . <span class="stringliteral">&#39;://&#39;</span> . <a class="code" href="group__php__wrappers_ga0125d5e205f50be86146a8df58c2bc5f.html#ga0125d5e205f50be86146a8df58c2bc5f" title="Gets the filename from a given path.">drupal_basename</a>($filename);
<a name="l02405"></a>02405     }
<a name="l02406"></a>02406     <span class="keywordflow">else</span> {
<a name="l02407"></a>02407       <span class="keywordflow">return</span> FALSE;
<a name="l02408"></a>02408     }
<a name="l02409"></a>02409   }
<a name="l02410"></a>02410   <span class="keywordflow">else</span> {
<a name="l02411"></a>02411     <span class="comment">// Handle as a normal tempnam() call.</span>
<a name="l02412"></a>02412     <span class="keywordflow">return</span> tempnam($directory, $prefix);
<a name="l02413"></a>02413   }
<a name="l02414"></a>02414 }
<a name="l02415"></a>02415 
<a name="l02419"></a><a class="code" href="group__file_ga250e5cfba54030ab1e5f031608860e42.html#ga250e5cfba54030ab1e5f031608860e42">02419</a> <span class="keyword">function</span> <a class="code" href="group__file_ga250e5cfba54030ab1e5f031608860e42.html#ga250e5cfba54030ab1e5f031608860e42" title="Gets the path of system-appropriate temporary directory.">file_directory_temp</a>() {
<a name="l02420"></a>02420   $temporary_directory = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;file_temporary_path&#39;</span>, NULL);
<a name="l02421"></a>02421 
<a name="l02422"></a>02422   <span class="keywordflow">if</span> (empty($temporary_directory)) {
<a name="l02423"></a>02423     $directories = array();
<a name="l02424"></a>02424 
<a name="l02425"></a>02425     <span class="comment">// Has PHP been set with an upload_tmp_dir?</span>
<a name="l02426"></a>02426     <span class="keywordflow">if</span> (ini_get(<span class="stringliteral">&#39;upload_tmp_dir&#39;</span>)) {
<a name="l02427"></a>02427       $directories[] = ini_get(<span class="stringliteral">&#39;upload_tmp_dir&#39;</span>);
<a name="l02428"></a>02428     }
<a name="l02429"></a>02429 
<a name="l02430"></a>02430     <span class="comment">// Operating system specific dirs.</span>
<a name="l02431"></a>02431     <span class="keywordflow">if</span> (substr(PHP_OS, 0, 3) == <span class="stringliteral">&#39;WIN&#39;</span>) {
<a name="l02432"></a>02432       $directories[] = <span class="stringliteral">&#39;c:\\windows\\temp&#39;</span>;
<a name="l02433"></a>02433       $directories[] = <span class="stringliteral">&#39;c:\\winnt\\temp&#39;</span>;
<a name="l02434"></a>02434     }
<a name="l02435"></a>02435     <span class="keywordflow">else</span> {
<a name="l02436"></a>02436       $directories[] = <span class="stringliteral">&#39;/tmp&#39;</span>;
<a name="l02437"></a>02437     }
<a name="l02438"></a>02438     <span class="comment">// PHP may be able to find an alternative tmp directory.</span>
<a name="l02439"></a>02439     <span class="comment">// This function exists in PHP 5 &gt;= 5.2.1, but Drupal</span>
<a name="l02440"></a>02440     <span class="comment">// requires PHP 5 &gt;= 5.2.0, so we check for it.</span>
<a name="l02441"></a>02441     <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;sys_get_temp_dir&#39;</span>)) {
<a name="l02442"></a>02442       $directories[] = sys_get_temp_dir();
<a name="l02443"></a>02443     }
<a name="l02444"></a>02444 
<a name="l02445"></a>02445     <span class="keywordflow">foreach</span> ($directories as $directory) {
<a name="l02446"></a>02446       <span class="keywordflow">if</span> (is_dir($directory) &amp;&amp; is_writable($directory)) {
<a name="l02447"></a>02447         $temporary_directory = $directory;
<a name="l02448"></a>02448         <span class="keywordflow">break</span>;
<a name="l02449"></a>02449       }
<a name="l02450"></a>02450     }
<a name="l02451"></a>02451 
<a name="l02452"></a>02452     <span class="keywordflow">if</span> (empty($temporary_directory)) {
<a name="l02453"></a>02453       <span class="comment">// If no directory has been found default to &#39;files/tmp&#39;.</span>
<a name="l02454"></a>02454       $temporary_directory = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;file_public_path&#39;</span>, <a class="code" href="bootstrap_8inc_acef612ef19c49f6259531f0bee5c26cc.html#acef612ef19c49f6259531f0bee5c26cc" title="Finds the appropriate configuration directory.">conf_path</a>() . <span class="stringliteral">&#39;/files&#39;</span>) . <span class="stringliteral">&#39;/tmp&#39;</span>;
<a name="l02455"></a>02455 
<a name="l02456"></a>02456       <span class="comment">// Windows accepts paths with either slash (/) or backslash (\), but will</span>
<a name="l02457"></a>02457       <span class="comment">// not accept a path which contains both a slash and a backslash. Since</span>
<a name="l02458"></a>02458       <span class="comment">// the &#39;file_public_path&#39; variable may have either format, we sanitize</span>
<a name="l02459"></a>02459       <span class="comment">// everything to use slash which is supported on all platforms.</span>
<a name="l02460"></a>02460       $temporary_directory = str_replace(<span class="charliteral">&#39;\\&#39;</span>, <span class="charliteral">&#39;/&#39;</span>, $temporary_directory);
<a name="l02461"></a>02461     }
<a name="l02462"></a>02462     <span class="comment">// Save the path of the discovered directory.</span>
<a name="l02463"></a>02463     <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;file_temporary_path&#39;</span>, $temporary_directory);
<a name="l02464"></a>02464   }
<a name="l02465"></a>02465 
<a name="l02466"></a>02466   <span class="keywordflow">return</span> $temporary_directory;
<a name="l02467"></a>02467 }
<a name="l02468"></a>02468 
<a name="l02478"></a><a class="code" href="group__file_ga33aed1fe449367d57b8f9a774a449f27.html#ga33aed1fe449367d57b8f9a774a449f27">02478</a> <span class="keyword">function</span> <a class="code" href="group__file_ga33aed1fe449367d57b8f9a774a449f27.html#ga33aed1fe449367d57b8f9a774a449f27" title="Examines a file object and returns appropriate content headers for download.">file_get_content_headers</a>($file) {
<a name="l02479"></a>02479   $name = <a class="code" href="unicode_8inc_a079be0dce19618c9dfe392741e6af083.html#a079be0dce19618c9dfe392741e6af083" title="Encodes MIME/HTTP header values that contain non-ASCII, UTF-8 encoded characters.">mime_header_encode</a>($file-&gt;filename);
<a name="l02480"></a>02480   $type = <a class="code" href="unicode_8inc_a079be0dce19618c9dfe392741e6af083.html#a079be0dce19618c9dfe392741e6af083" title="Encodes MIME/HTTP header values that contain non-ASCII, UTF-8 encoded characters.">mime_header_encode</a>($file-&gt;filemime);
<a name="l02481"></a>02481   <span class="comment">// Serve images, text, and flash content for display rather than download.</span>
<a name="l02482"></a>02482   $inline_types = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;file_inline_types&#39;</span>, array(<span class="stringliteral">&#39;^text/&#39;</span>, <span class="stringliteral">&#39;^image/&#39;</span>, <span class="stringliteral">&#39;flash$&#39;</span>));
<a name="l02483"></a>02483   $disposition = <span class="stringliteral">&#39;attachment&#39;</span>;
<a name="l02484"></a>02484   <span class="keywordflow">foreach</span> ($inline_types as $inline_type) {
<a name="l02485"></a>02485     <span class="comment">// Exclamation marks are used as delimiters to avoid escaping slashes.</span>
<a name="l02486"></a>02486     <span class="keywordflow">if</span> (preg_match(<span class="charliteral">&#39;!&#39;</span> . $inline_type . <span class="charliteral">&#39;!&#39;</span>, $file-&gt;filemime)) {
<a name="l02487"></a>02487       $disposition = <span class="stringliteral">&#39;inline&#39;</span>;
<a name="l02488"></a>02488     }
<a name="l02489"></a>02489   }
<a name="l02490"></a>02490 
<a name="l02491"></a>02491   <span class="keywordflow">return</span> array(
<a name="l02492"></a>02492     <span class="stringliteral">&#39;Content-Type&#39;</span> =&gt; $type . <span class="stringliteral">&#39;; name=&quot;&#39;</span> . $name . <span class="charliteral">&#39;&quot;&#39;</span>,
<a name="l02493"></a>02493     <span class="stringliteral">&#39;Content-Length&#39;</span> =&gt; $file-&gt;filesize,
<a name="l02494"></a>02494     <span class="stringliteral">&#39;Content-Disposition&#39;</span> =&gt; $disposition . <span class="stringliteral">&#39;; filename=&quot;&#39;</span> . $name . <span class="charliteral">&#39;&quot;&#39;</span>,
<a name="l02495"></a>02495     <span class="stringliteral">&#39;Cache-Control&#39;</span> =&gt; <span class="stringliteral">&#39;private&#39;</span>,
<a name="l02496"></a>02496   );
<a name="l02497"></a>02497 }
<a name="l02498"></a>02498 
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Thu Nov 22 2012 16:46:14 for Shopcart by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>

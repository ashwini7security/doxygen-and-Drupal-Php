<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Shopcart: includes/cache.inc Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Shopcart
   &#160;<span id="projectnumber">version2.0</span>
   </div>
   <div id="projectbrief">Shoppingcart</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_5b89693129504707d608c5412e7b88d4.html">includes</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">cache.inc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="cache_8inc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00022"></a><a class="code" href="cache_8inc_aebc44cd35cb38b264cf0b07a164ee1af.html#aebc44cd35cb38b264cf0b07a164ee1af">00022</a> <span class="keyword">function</span> <a class="code" href="cache_8inc_aebc44cd35cb38b264cf0b07a164ee1af.html#aebc44cd35cb38b264cf0b07a164ee1af" title="Gets the cache object for a cache bin.">_cache_get_object</a>($bin) {
<a name="l00023"></a>00023   <span class="comment">// We do not use drupal_static() here because we do not want to change the</span>
<a name="l00024"></a>00024   <span class="comment">// storage of a cache bin mid-request.</span>
<a name="l00025"></a>00025   <span class="keyword">static</span> $cache_objects;
<a name="l00026"></a>00026   <span class="keywordflow">if</span> (!isset($cache_objects[$bin])) {
<a name="l00027"></a>00027     $class = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;cache_class_&#39;</span> . $bin);
<a name="l00028"></a>00028     <span class="keywordflow">if</span> (!isset($class)) {
<a name="l00029"></a>00029       $class = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;cache_default_class&#39;</span>, <span class="stringliteral">&#39;DrupalDatabaseCache&#39;</span>);
<a name="l00030"></a>00030     }
<a name="l00031"></a>00031     $cache_objects[$bin] = <span class="keyword">new</span> $class($bin);
<a name="l00032"></a>00032   }
<a name="l00033"></a>00033   <span class="keywordflow">return</span> $cache_objects[$bin];
<a name="l00034"></a>00034 }
<a name="l00035"></a>00035 
<a name="l00055"></a><a class="code" href="cache_8inc_a9d873815c28909b61c3a6188b383f8a3.html#a9d873815c28909b61c3a6188b383f8a3">00055</a> <span class="keyword">function</span> <a class="code" href="cache_8inc_a9d873815c28909b61c3a6188b383f8a3.html#a9d873815c28909b61c3a6188b383f8a3" title="Returns data from the persistent cache.">cache_get</a>($cid, $bin = <span class="stringliteral">&#39;cache&#39;</span>) {
<a name="l00056"></a>00056   <span class="keywordflow">return</span> <a class="code" href="cache_8inc_aebc44cd35cb38b264cf0b07a164ee1af.html#aebc44cd35cb38b264cf0b07a164ee1af" title="Gets the cache object for a cache bin.">_cache_get_object</a>($bin)-&gt;get($cid);
<a name="l00057"></a>00057 }
<a name="l00058"></a>00058 
<a name="l00071"></a><a class="code" href="cache_8inc_a2c67628faec5b49aa0fdc987422540d4.html#a2c67628faec5b49aa0fdc987422540d4">00071</a> <span class="keyword">function</span> <a class="code" href="cache_8inc_a2c67628faec5b49aa0fdc987422540d4.html#a2c67628faec5b49aa0fdc987422540d4" title="Returns data from the persistent cache when given an array of cache IDs.">cache_get_multiple</a>(array &amp;$cids, $bin = <span class="stringliteral">&#39;cache&#39;</span>) {
<a name="l00072"></a>00072   <span class="keywordflow">return</span> <a class="code" href="cache_8inc_aebc44cd35cb38b264cf0b07a164ee1af.html#aebc44cd35cb38b264cf0b07a164ee1af" title="Gets the cache object for a cache bin.">_cache_get_object</a>($bin)-&gt;getMultiple($cids);
<a name="l00073"></a>00073 }
<a name="l00074"></a>00074 
<a name="l00146"></a><a class="code" href="cache_8inc_a48081f36334909f561ef4f538fa640d2.html#a48081f36334909f561ef4f538fa640d2">00146</a> <span class="keyword">function</span> <a class="code" href="cache_8inc_a48081f36334909f561ef4f538fa640d2.html#a48081f36334909f561ef4f538fa640d2" title="Stores data in the persistent cache.">cache_set</a>($cid, $data, $bin = <span class="stringliteral">&#39;cache&#39;</span>, $expire = <a class="code" href="bootstrap_8inc_ad987330fff5fa7c75800762ddedf300c.html#ad987330fff5fa7c75800762ddedf300c" title="Indicates that the item should never be removed unless explicitly selected.">CACHE_PERMANENT</a>) {
<a name="l00147"></a>00147   <span class="keywordflow">return</span> <a class="code" href="cache_8inc_aebc44cd35cb38b264cf0b07a164ee1af.html#aebc44cd35cb38b264cf0b07a164ee1af" title="Gets the cache object for a cache bin.">_cache_get_object</a>($bin)-&gt;set($cid, $data, $expire);
<a name="l00148"></a>00148 }
<a name="l00149"></a>00149 
<a name="l00166"></a><a class="code" href="cache_8inc_a409b34dd629640d791a11736a9de8125.html#a409b34dd629640d791a11736a9de8125">00166</a> <span class="keyword">function</span> <a class="code" href="cache_8inc_a409b34dd629640d791a11736a9de8125.html#a409b34dd629640d791a11736a9de8125" title="Expires data from the cache.">cache_clear_all</a>($cid = NULL, $bin = NULL, $wildcard = FALSE) {
<a name="l00167"></a>00167   <span class="keywordflow">if</span> (!isset($cid) &amp;&amp; !isset($bin)) {
<a name="l00168"></a>00168     <span class="comment">// Clear the block cache first, so stale data will</span>
<a name="l00169"></a>00169     <span class="comment">// not end up in the page cache.</span>
<a name="l00170"></a>00170     <span class="keywordflow">if</span> (<a class="code" href="module_8inc_a83bfe4eac372da50ff3eaf949b1b6ff8.html#a83bfe4eac372da50ff3eaf949b1b6ff8" title="Determine whether a given module exists.">module_exists</a>(<span class="stringliteral">&#39;block&#39;</span>)) {
<a name="l00171"></a>00171       <a class="code" href="cache_8inc_a409b34dd629640d791a11736a9de8125.html#a409b34dd629640d791a11736a9de8125" title="Expires data from the cache.">cache_clear_all</a>(NULL, <span class="stringliteral">&#39;cache_block&#39;</span>);
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173     <a class="code" href="cache_8inc_a409b34dd629640d791a11736a9de8125.html#a409b34dd629640d791a11736a9de8125" title="Expires data from the cache.">cache_clear_all</a>(NULL, <span class="stringliteral">&#39;cache_page&#39;</span>);
<a name="l00174"></a>00174     <span class="keywordflow">return</span>;
<a name="l00175"></a>00175   }
<a name="l00176"></a>00176   <span class="keywordflow">return</span> <a class="code" href="cache_8inc_aebc44cd35cb38b264cf0b07a164ee1af.html#aebc44cd35cb38b264cf0b07a164ee1af" title="Gets the cache object for a cache bin.">_cache_get_object</a>($bin)-&gt;clear($cid, $wildcard);
<a name="l00177"></a>00177 }
<a name="l00178"></a>00178 
<a name="l00191"></a><a class="code" href="cache_8inc_a859ec549c0cf60273cb094fa42a14604.html#a859ec549c0cf60273cb094fa42a14604">00191</a> <span class="keyword">function</span> <a class="code" href="cache_8inc_a859ec549c0cf60273cb094fa42a14604.html#a859ec549c0cf60273cb094fa42a14604" title="Checks if a cache bin is empty.">cache_is_empty</a>($bin) {
<a name="l00192"></a>00192   <span class="keywordflow">return</span> <a class="code" href="cache_8inc_aebc44cd35cb38b264cf0b07a164ee1af.html#aebc44cd35cb38b264cf0b07a164ee1af" title="Gets the cache object for a cache bin.">_cache_get_object</a>($bin)-&gt;isEmpty();
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00232"></a><a class="code" href="interfaceDrupalCacheInterface.html">00232</a> <span class="keyword">interface </span><a class="code" href="interfaceDrupalCacheInterface.html" title="Defines an interface for cache implementations.">DrupalCacheInterface</a> {
<a name="l00239"></a>00239   <span class="keyword">function</span> <a class="code" href="interfaceDrupalCacheInterface_aeb4a89ec36576d86c267fbc979c3baa8.html#aeb4a89ec36576d86c267fbc979c3baa8" title="Constructs a new cache interface.">__construct</a>($bin);
<a name="l00240"></a>00240 
<a name="l00253"></a>00253   <span class="keyword">function</span> <span class="keyword">get</span>($cid);
<a name="l00254"></a>00254 
<a name="l00266"></a>00266    <span class="keyword">function</span> <a class="code" href="interfaceDrupalCacheInterface_aee8c869921fff61654d12099237763dc.html#aee8c869921fff61654d12099237763dc" title="Returns data from the persistent cache when given an array of cache IDs.">getMultiple</a>(&amp;$cids);
<a name="l00267"></a>00267 
<a name="l00286"></a>00286   <span class="keyword">function</span> <span class="keyword">set</span>($cid, $data, $expire = <a class="code" href="bootstrap_8inc_ad987330fff5fa7c75800762ddedf300c.html#ad987330fff5fa7c75800762ddedf300c" title="Indicates that the item should never be removed unless explicitly selected.">CACHE_PERMANENT</a>);
<a name="l00287"></a>00287 
<a name="l00288"></a>00288 
<a name="l00303"></a>00303   <span class="keyword">function</span> <a class="code" href="interfaceDrupalCacheInterface_a5c8e341f653337185feff4ddc30c1b48.html#a5c8e341f653337185feff4ddc30c1b48" title="Expires data from the cache.">clear</a>($cid = NULL, $wildcard = FALSE);
<a name="l00304"></a>00304 
<a name="l00314"></a>00314   <span class="keyword">function</span> <a class="code" href="interfaceDrupalCacheInterface_a54fa3e2f8e11cbb551d5168c9f22c720.html#a54fa3e2f8e11cbb551d5168c9f22c720" title="Checks if a cache bin is empty.">isEmpty</a>();
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 
<a name="l00323"></a><a class="code" href="classDrupalDatabaseCache.html">00323</a> <span class="keyword">class </span><a class="code" href="classDrupalDatabaseCache.html" title="Defines a default cache implementation.">DrupalDatabaseCache</a> <span class="keyword">implements</span> <a class="code" href="interfaceDrupalCacheInterface.html" title="Defines an interface for cache implementations.">DrupalCacheInterface</a> {
<a name="l00324"></a><a class="code" href="classDrupalDatabaseCache_a23ff82a8fccd935ca0f443ce94317898.html#a23ff82a8fccd935ca0f443ce94317898">00324</a>   <span class="keyword">protected</span> <a class="code" href="classDrupalDatabaseCache_a23ff82a8fccd935ca0f443ce94317898.html#a23ff82a8fccd935ca0f443ce94317898">$bin</a>;
<a name="l00325"></a>00325 
<a name="l00329"></a><a class="code" href="classDrupalDatabaseCache_aacdbd5ca89efaaa78ab8d66fca003cc4.html#aacdbd5ca89efaaa78ab8d66fca003cc4">00329</a>   <span class="keyword">function</span> <a class="code" href="classDrupalDatabaseCache_aacdbd5ca89efaaa78ab8d66fca003cc4.html#aacdbd5ca89efaaa78ab8d66fca003cc4" title="Constructs a new DrupalDatabaseCache object.">__construct</a>(<a class="code" href="classDrupalDatabaseCache_a23ff82a8fccd935ca0f443ce94317898.html#a23ff82a8fccd935ca0f443ce94317898">$bin</a>) {
<a name="l00330"></a>00330     $this-&gt;bin = <a class="code" href="classDrupalDatabaseCache_a23ff82a8fccd935ca0f443ce94317898.html#a23ff82a8fccd935ca0f443ce94317898">$bin</a>;
<a name="l00331"></a>00331   }
<a name="l00332"></a>00332 
<a name="l00336"></a><a class="code" href="classDrupalDatabaseCache_a66a573f6f3e13198b1e95fdc4bd14f8e.html#a66a573f6f3e13198b1e95fdc4bd14f8e">00336</a>   <span class="keyword">function</span> <span class="keyword">get</span>($cid) {
<a name="l00337"></a>00337     $cids = array($cid);
<a name="l00338"></a>00338     $cache = $this-&gt;<a class="code" href="classDrupalDatabaseCache_ad9f421906b15c039f1842cf8c14e8768.html#ad9f421906b15c039f1842cf8c14e8768" title="Implements DrupalCacheInterface::getMultiple().">getMultiple</a>($cids);
<a name="l00339"></a>00339     <span class="keywordflow">return</span> reset($cache);
<a name="l00340"></a>00340   }
<a name="l00341"></a>00341 
<a name="l00345"></a><a class="code" href="classDrupalDatabaseCache_ad9f421906b15c039f1842cf8c14e8768.html#ad9f421906b15c039f1842cf8c14e8768">00345</a>   <span class="keyword">function</span> <a class="code" href="classDrupalDatabaseCache_ad9f421906b15c039f1842cf8c14e8768.html#ad9f421906b15c039f1842cf8c14e8768" title="Implements DrupalCacheInterface::getMultiple().">getMultiple</a>(&amp;$cids) {
<a name="l00346"></a>00346     <span class="keywordflow">try</span> {
<a name="l00347"></a>00347       <span class="comment">// Garbage collection necessary when enforcing a minimum cache lifetime.</span>
<a name="l00348"></a>00348       $this-&gt;<a class="code" href="classDrupalDatabaseCache_ab29683fb16e22bae9029912548ffa67b.html#ab29683fb16e22bae9029912548ffa67b" title="Garbage collection for get() and getMultiple().">garbageCollection</a>($this-&gt;bin);
<a name="l00349"></a>00349 
<a name="l00350"></a>00350       <span class="comment">// When serving cached pages, the overhead of using db_select() was found</span>
<a name="l00351"></a>00351       <span class="comment">// to add around 30% overhead to the request. Since $this-&gt;bin is a</span>
<a name="l00352"></a>00352       <span class="comment">// variable, this means the call to db_query() here uses a concatenated</span>
<a name="l00353"></a>00353       <span class="comment">// string. This is highly discouraged under any other circumstances, and</span>
<a name="l00354"></a>00354       <span class="comment">// is used here only due to the performance overhead we would incur</span>
<a name="l00355"></a>00355       <span class="comment">// otherwise. When serving an uncached page, the overhead of using</span>
<a name="l00356"></a>00356       <span class="comment">// db_select() is a much smaller proportion of the request.</span>
<a name="l00357"></a>00357       $result = <a class="code" href="group__database_gafa3b6cb2b2f61479cc63a4150c62da9b.html#gafa3b6cb2b2f61479cc63a4150c62da9b" title="The following utility functions are simply convenience wrappers.">db_query</a>(<span class="stringliteral">&#39;SELECT cid, data, created, expire, serialized FROM {&#39;</span> . <a class="code" href="group__database_ga3bc27db8c5946da0cab63d9b6314d48d.html#ga3bc27db8c5946da0cab63d9b6314d48d" title="Restricts a dynamic table name to safe characters.">db_escape_table</a>($this-&gt;bin) . <span class="stringliteral">&#39;} WHERE cid IN (:cids)&#39;</span>, array(<span class="stringliteral">&#39;:cids&#39;</span> =&gt; $cids));
<a name="l00358"></a>00358       $cache = array();
<a name="l00359"></a>00359       <span class="keywordflow">foreach</span> ($result as $item) {
<a name="l00360"></a>00360         $item = $this-&gt;<a class="code" href="classDrupalDatabaseCache_a63148b862b8b39426c50f45e1c7fe43d.html#a63148b862b8b39426c50f45e1c7fe43d" title="Prepares a cached item.">prepareItem</a>($item);
<a name="l00361"></a>00361         <span class="keywordflow">if</span> ($item) {
<a name="l00362"></a>00362           $cache[$item-&gt;cid] = $item;
<a name="l00363"></a>00363         }
<a name="l00364"></a>00364       }
<a name="l00365"></a>00365       $cids = array_diff($cids, array_keys($cache));
<a name="l00366"></a>00366       <span class="keywordflow">return</span> $cache;
<a name="l00367"></a>00367     }
<a name="l00368"></a>00368     <span class="keywordflow">catch</span> (<a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a> $e) {
<a name="l00369"></a>00369       <span class="comment">// If the database is never going to be available, cache requests should</span>
<a name="l00370"></a>00370       <span class="comment">// return FALSE in order to allow exception handling to occur.</span>
<a name="l00371"></a>00371       <span class="keywordflow">return</span> array();
<a name="l00372"></a>00372     }
<a name="l00373"></a>00373   }
<a name="l00374"></a>00374 
<a name="l00381"></a><a class="code" href="classDrupalDatabaseCache_ab29683fb16e22bae9029912548ffa67b.html#ab29683fb16e22bae9029912548ffa67b">00381</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classDrupalDatabaseCache_ab29683fb16e22bae9029912548ffa67b.html#ab29683fb16e22bae9029912548ffa67b" title="Garbage collection for get() and getMultiple().">garbageCollection</a>() {
<a name="l00382"></a>00382     $cache_lifetime = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;cache_lifetime&#39;</span>, 0);
<a name="l00383"></a>00383 
<a name="l00384"></a>00384     <span class="comment">// Clean-up the per-user cache expiration session data, so that the session</span>
<a name="l00385"></a>00385     <span class="comment">// handler can properly clean-up the session data for anonymous users.</span>
<a name="l00386"></a>00386     <span class="keywordflow">if</span> (isset($_SESSION[<span class="stringliteral">&#39;cache_expiration&#39;</span>])) {
<a name="l00387"></a>00387       $expire = <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a> - $cache_lifetime;
<a name="l00388"></a>00388       <span class="keywordflow">foreach</span> ($_SESSION[<span class="stringliteral">&#39;cache_expiration&#39;</span>] as <a class="code" href="classDrupalDatabaseCache_a23ff82a8fccd935ca0f443ce94317898.html#a23ff82a8fccd935ca0f443ce94317898">$bin</a> =&gt; $timestamp) {
<a name="l00389"></a>00389         <span class="keywordflow">if</span> ($timestamp &lt; $expire) {
<a name="l00390"></a>00390           unset($_SESSION[<span class="stringliteral">&#39;cache_expiration&#39;</span>][<a class="code" href="classDrupalDatabaseCache_a23ff82a8fccd935ca0f443ce94317898.html#a23ff82a8fccd935ca0f443ce94317898">$bin</a>]);
<a name="l00391"></a>00391         }
<a name="l00392"></a>00392       }
<a name="l00393"></a>00393       <span class="keywordflow">if</span> (!$_SESSION[<span class="stringliteral">&#39;cache_expiration&#39;</span>]) {
<a name="l00394"></a>00394         unset($_SESSION[<span class="stringliteral">&#39;cache_expiration&#39;</span>]);
<a name="l00395"></a>00395       }
<a name="l00396"></a>00396     }
<a name="l00397"></a>00397 
<a name="l00398"></a>00398     <span class="comment">// Garbage collection of temporary items is only necessary when enforcing</span>
<a name="l00399"></a>00399     <span class="comment">// a minimum cache lifetime.</span>
<a name="l00400"></a>00400     <span class="keywordflow">if</span> (!$cache_lifetime) {
<a name="l00401"></a>00401       <span class="keywordflow">return</span>;
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403     <span class="comment">// When cache lifetime is in force, avoid running garbage collection too</span>
<a name="l00404"></a>00404     <span class="comment">// often since this will remove temporary cache items indiscriminately.</span>
<a name="l00405"></a>00405     $cache_flush = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;cache_flush_&#39;</span> . $this-&gt;bin, 0);
<a name="l00406"></a>00406     <span class="keywordflow">if</span> ($cache_flush &amp;&amp; ($cache_flush + $cache_lifetime &lt;= <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a>)) {
<a name="l00407"></a>00407       <span class="comment">// Reset the variable immediately to prevent a meltdown in heavy load situations.</span>
<a name="l00408"></a>00408       <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;cache_flush_&#39;</span> . $this-&gt;bin, 0);
<a name="l00409"></a>00409       <span class="comment">// Time to flush old cache data</span>
<a name="l00410"></a>00410       <a class="code" href="group__database_ga72f0ccecc0ba181de16c6e3451150f2c.html#ga72f0ccecc0ba181de16c6e3451150f2c" title="Returns a new DeleteQuery object for the active database.">db_delete</a>($this-&gt;bin)
<a name="l00411"></a>00411         -&gt;condition(<span class="stringliteral">&#39;expire&#39;</span>, <a class="code" href="bootstrap_8inc_ad987330fff5fa7c75800762ddedf300c.html#ad987330fff5fa7c75800762ddedf300c" title="Indicates that the item should never be removed unless explicitly selected.">CACHE_PERMANENT</a>, <span class="stringliteral">&#39;&lt;&gt;&#39;</span>)
<a name="l00412"></a>00412         -&gt;condition(<span class="stringliteral">&#39;expire&#39;</span>, $cache_flush, <span class="stringliteral">&#39;&lt;=&#39;</span>)
<a name="l00413"></a>00413         -&gt;execute();
<a name="l00414"></a>00414     }
<a name="l00415"></a>00415   }
<a name="l00416"></a>00416 
<a name="l00430"></a><a class="code" href="classDrupalDatabaseCache_a63148b862b8b39426c50f45e1c7fe43d.html#a63148b862b8b39426c50f45e1c7fe43d">00430</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classDrupalDatabaseCache_a63148b862b8b39426c50f45e1c7fe43d.html#a63148b862b8b39426c50f45e1c7fe43d" title="Prepares a cached item.">prepareItem</a>($cache) {
<a name="l00431"></a>00431     global $user;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     <span class="keywordflow">if</span> (!isset($cache-&gt;data)) {
<a name="l00434"></a>00434       <span class="keywordflow">return</span> FALSE;
<a name="l00435"></a>00435     }
<a name="l00436"></a>00436     <span class="comment">// If the cached data is temporary and subject to a per-user minimum</span>
<a name="l00437"></a>00437     <span class="comment">// lifetime, compare the cache entry timestamp with the user session</span>
<a name="l00438"></a>00438     <span class="comment">// cache_expiration timestamp. If the cache entry is too old, ignore it.</span>
<a name="l00439"></a>00439     <span class="keywordflow">if</span> ($cache-&gt;expire != <a class="code" href="bootstrap_8inc_ad987330fff5fa7c75800762ddedf300c.html#ad987330fff5fa7c75800762ddedf300c" title="Indicates that the item should never be removed unless explicitly selected.">CACHE_PERMANENT</a> &amp;&amp; <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;cache_lifetime&#39;</span>, 0) &amp;&amp; isset($_SESSION[<span class="stringliteral">&#39;cache_expiration&#39;</span>][$this-&gt;bin]) &amp;&amp; $_SESSION[<span class="stringliteral">&#39;cache_expiration&#39;</span>][$this-&gt;bin] &gt; $cache-&gt;created) {
<a name="l00440"></a>00440       <span class="comment">// Ignore cache data that is too old and thus not valid for this user.</span>
<a name="l00441"></a>00441       <span class="keywordflow">return</span> FALSE;
<a name="l00442"></a>00442     }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     <span class="comment">// If the data is permanent or not subject to a minimum cache lifetime,</span>
<a name="l00445"></a>00445     <span class="comment">// unserialize and return the cached data.</span>
<a name="l00446"></a>00446     <span class="keywordflow">if</span> ($cache-&gt;serialized) {
<a name="l00447"></a>00447       $cache-&gt;data = unserialize($cache-&gt;data);
<a name="l00448"></a>00448     }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450     <span class="keywordflow">return</span> $cache;
<a name="l00451"></a>00451   }
<a name="l00452"></a>00452 
<a name="l00456"></a><a class="code" href="classDrupalDatabaseCache_a8262bd7a36ca026f6b8c31c30c0f722d.html#a8262bd7a36ca026f6b8c31c30c0f722d">00456</a>   <span class="keyword">function</span> <span class="keyword">set</span>($cid, $data, $expire = <a class="code" href="bootstrap_8inc_ad987330fff5fa7c75800762ddedf300c.html#ad987330fff5fa7c75800762ddedf300c" title="Indicates that the item should never be removed unless explicitly selected.">CACHE_PERMANENT</a>) {
<a name="l00457"></a>00457     $fields = array(
<a name="l00458"></a>00458       <span class="stringliteral">&#39;serialized&#39;</span> =&gt; 0,
<a name="l00459"></a>00459       <span class="stringliteral">&#39;created&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a>,
<a name="l00460"></a>00460       <span class="stringliteral">&#39;expire&#39;</span> =&gt; $expire,
<a name="l00461"></a>00461     );
<a name="l00462"></a>00462     <span class="keywordflow">if</span> (!is_string($data)) {
<a name="l00463"></a>00463       $fields[<span class="stringliteral">&#39;data&#39;</span>] = serialize($data);
<a name="l00464"></a>00464       $fields[<span class="stringliteral">&#39;serialized&#39;</span>] = 1;
<a name="l00465"></a>00465     }
<a name="l00466"></a>00466     <span class="keywordflow">else</span> {
<a name="l00467"></a>00467       $fields[<span class="stringliteral">&#39;data&#39;</span>] = $data;
<a name="l00468"></a>00468       $fields[<span class="stringliteral">&#39;serialized&#39;</span>] = 0;
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     <span class="keywordflow">try</span> {
<a name="l00472"></a>00472       <a class="code" href="group__database_ga429c73a1bdc6dbb18c4a4a8a2235beaf.html#ga429c73a1bdc6dbb18c4a4a8a2235beaf" title="Returns a new MergeQuery object for the active database.">db_merge</a>($this-&gt;bin)
<a name="l00473"></a>00473         -&gt;key(array(<span class="stringliteral">&#39;cid&#39;</span> =&gt; $cid))
<a name="l00474"></a>00474         -&gt;fields($fields)
<a name="l00475"></a>00475         -&gt;execute();
<a name="l00476"></a>00476     }
<a name="l00477"></a>00477     <span class="keywordflow">catch</span> (<a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a> $e) {
<a name="l00478"></a>00478       <span class="comment">// The database may not be available, so we&#39;ll ignore cache_set requests.</span>
<a name="l00479"></a>00479     }
<a name="l00480"></a>00480   }
<a name="l00481"></a>00481 
<a name="l00485"></a><a class="code" href="classDrupalDatabaseCache_a07b7a236787af4e11615f26dd98f51f7.html#a07b7a236787af4e11615f26dd98f51f7">00485</a>   <span class="keyword">function</span> <a class="code" href="classDrupalDatabaseCache_a07b7a236787af4e11615f26dd98f51f7.html#a07b7a236787af4e11615f26dd98f51f7" title="Implements DrupalCacheInterface::clear().">clear</a>($cid = NULL, $wildcard = FALSE) {
<a name="l00486"></a>00486     global $user;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="keywordflow">if</span> (empty($cid)) {
<a name="l00489"></a>00489       <span class="keywordflow">if</span> (<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;cache_lifetime&#39;</span>, 0)) {
<a name="l00490"></a>00490         <span class="comment">// We store the time in the current user&#39;s session. We then simulate</span>
<a name="l00491"></a>00491         <span class="comment">// that the cache was flushed for this user by not returning cached</span>
<a name="l00492"></a>00492         <span class="comment">// data that was cached before the timestamp.</span>
<a name="l00493"></a>00493         $_SESSION[<span class="stringliteral">&#39;cache_expiration&#39;</span>][$this-&gt;bin] = <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a>;
<a name="l00494"></a>00494 
<a name="l00495"></a>00495         $cache_flush = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;cache_flush_&#39;</span> . $this-&gt;bin, 0);
<a name="l00496"></a>00496         <span class="keywordflow">if</span> ($cache_flush == 0) {
<a name="l00497"></a>00497           <span class="comment">// This is the first request to clear the cache, start a timer.</span>
<a name="l00498"></a>00498           <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;cache_flush_&#39;</span> . $this-&gt;bin, <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a>);
<a name="l00499"></a>00499         }
<a name="l00500"></a>00500         elseif (<a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a> &gt; ($cache_flush + <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;cache_lifetime&#39;</span>, 0))) {
<a name="l00501"></a>00501           <span class="comment">// Clear the cache for everyone, cache_lifetime seconds have</span>
<a name="l00502"></a>00502           <span class="comment">// passed since the first request to clear the cache.</span>
<a name="l00503"></a>00503           <a class="code" href="group__database_ga72f0ccecc0ba181de16c6e3451150f2c.html#ga72f0ccecc0ba181de16c6e3451150f2c" title="Returns a new DeleteQuery object for the active database.">db_delete</a>($this-&gt;bin)
<a name="l00504"></a>00504             -&gt;condition(<span class="stringliteral">&#39;expire&#39;</span>, <a class="code" href="bootstrap_8inc_ad987330fff5fa7c75800762ddedf300c.html#ad987330fff5fa7c75800762ddedf300c" title="Indicates that the item should never be removed unless explicitly selected.">CACHE_PERMANENT</a>, <span class="stringliteral">&#39;&lt;&gt;&#39;</span>)
<a name="l00505"></a>00505             -&gt;condition(<span class="stringliteral">&#39;expire&#39;</span>, <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a>, <span class="charliteral">&#39;&lt;&#39;</span>)
<a name="l00506"></a>00506             -&gt;execute();
<a name="l00507"></a>00507           <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;cache_flush_&#39;</span> . $this-&gt;bin, 0);
<a name="l00508"></a>00508         }
<a name="l00509"></a>00509       }
<a name="l00510"></a>00510       <span class="keywordflow">else</span> {
<a name="l00511"></a>00511         <span class="comment">// No minimum cache lifetime, flush all temporary cache entries now.</span>
<a name="l00512"></a>00512         <a class="code" href="group__database_ga72f0ccecc0ba181de16c6e3451150f2c.html#ga72f0ccecc0ba181de16c6e3451150f2c" title="Returns a new DeleteQuery object for the active database.">db_delete</a>($this-&gt;bin)
<a name="l00513"></a>00513           -&gt;condition(<span class="stringliteral">&#39;expire&#39;</span>, <a class="code" href="bootstrap_8inc_ad987330fff5fa7c75800762ddedf300c.html#ad987330fff5fa7c75800762ddedf300c" title="Indicates that the item should never be removed unless explicitly selected.">CACHE_PERMANENT</a>, <span class="stringliteral">&#39;&lt;&gt;&#39;</span>)
<a name="l00514"></a>00514           -&gt;condition(<span class="stringliteral">&#39;expire&#39;</span>, <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a>, <span class="charliteral">&#39;&lt;&#39;</span>)
<a name="l00515"></a>00515           -&gt;execute();
<a name="l00516"></a>00516       }
<a name="l00517"></a>00517     }
<a name="l00518"></a>00518     <span class="keywordflow">else</span> {
<a name="l00519"></a>00519       <span class="keywordflow">if</span> ($wildcard) {
<a name="l00520"></a>00520         <span class="keywordflow">if</span> ($cid == <span class="charliteral">&#39;*&#39;</span>) {
<a name="l00521"></a>00521           <a class="code" href="group__database_gaf6b4b59f572821cfd043317b81eeb71e.html#gaf6b4b59f572821cfd043317b81eeb71e" title="Returns a new TruncateQuery object for the active database.">db_truncate</a>($this-&gt;bin)-&gt;execute();
<a name="l00522"></a>00522         }
<a name="l00523"></a>00523         <span class="keywordflow">else</span> {
<a name="l00524"></a>00524           <a class="code" href="group__database_ga72f0ccecc0ba181de16c6e3451150f2c.html#ga72f0ccecc0ba181de16c6e3451150f2c" title="Returns a new DeleteQuery object for the active database.">db_delete</a>($this-&gt;bin)
<a name="l00525"></a>00525             -&gt;condition(<span class="stringliteral">&#39;cid&#39;</span>, <a class="code" href="group__database_ga4e86622a079f0992dbb987e66320be7a.html#ga4e86622a079f0992dbb987e66320be7a" title="Escapes characters that work as wildcard characters in a LIKE pattern.">db_like</a>($cid) . <span class="charliteral">&#39;%&#39;</span>, <span class="stringliteral">&#39;LIKE&#39;</span>)
<a name="l00526"></a>00526             -&gt;execute();
<a name="l00527"></a>00527         }
<a name="l00528"></a>00528       }
<a name="l00529"></a>00529       elseif (is_array($cid)) {
<a name="l00530"></a>00530         <span class="comment">// Delete in chunks when a large array is passed.</span>
<a name="l00531"></a>00531         <span class="keywordflow">do</span> {
<a name="l00532"></a>00532           <a class="code" href="group__database_ga72f0ccecc0ba181de16c6e3451150f2c.html#ga72f0ccecc0ba181de16c6e3451150f2c" title="Returns a new DeleteQuery object for the active database.">db_delete</a>($this-&gt;bin)
<a name="l00533"></a>00533             -&gt;condition(<span class="stringliteral">&#39;cid&#39;</span>, array_splice($cid, 0, 1000), <span class="stringliteral">&#39;IN&#39;</span>)
<a name="l00534"></a>00534             -&gt;execute();
<a name="l00535"></a>00535         }
<a name="l00536"></a>00536         <span class="keywordflow">while</span> (count($cid));
<a name="l00537"></a>00537       }
<a name="l00538"></a>00538       <span class="keywordflow">else</span> {
<a name="l00539"></a>00539         <a class="code" href="group__database_ga72f0ccecc0ba181de16c6e3451150f2c.html#ga72f0ccecc0ba181de16c6e3451150f2c" title="Returns a new DeleteQuery object for the active database.">db_delete</a>($this-&gt;bin)
<a name="l00540"></a>00540           -&gt;condition(<span class="stringliteral">&#39;cid&#39;</span>, $cid)
<a name="l00541"></a>00541           -&gt;execute();
<a name="l00542"></a>00542       }
<a name="l00543"></a>00543     }
<a name="l00544"></a>00544   }
<a name="l00545"></a>00545 
<a name="l00549"></a><a class="code" href="classDrupalDatabaseCache_addc129b38e3ffdda5a55f2f453ea5619.html#addc129b38e3ffdda5a55f2f453ea5619">00549</a>   <span class="keyword">function</span> <a class="code" href="classDrupalDatabaseCache_addc129b38e3ffdda5a55f2f453ea5619.html#addc129b38e3ffdda5a55f2f453ea5619" title="Implements DrupalCacheInterface::isEmpty().">isEmpty</a>() {
<a name="l00550"></a>00550     $this-&gt;<a class="code" href="classDrupalDatabaseCache_ab29683fb16e22bae9029912548ffa67b.html#ab29683fb16e22bae9029912548ffa67b" title="Garbage collection for get() and getMultiple().">garbageCollection</a>();
<a name="l00551"></a>00551     $query = <a class="code" href="group__database_ga9e030cee657d64e3d8e524c65814cc9f.html#ga9e030cee657d64e3d8e524c65814cc9f" title="Returns a new SelectQuery object for the active database.">db_select</a>($this-&gt;bin);
<a name="l00552"></a>00552     $query-&gt;addExpression(<span class="charliteral">&#39;1&#39;</span>);
<a name="l00553"></a>00553     $result = $query-&gt;range(0, 1)
<a name="l00554"></a>00554       -&gt;execute()
<a name="l00555"></a>00555       -&gt;fetchField();
<a name="l00556"></a>00556     <span class="keywordflow">return</span> empty($result);
<a name="l00557"></a>00557   }
<a name="l00558"></a>00558 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Thu Nov 22 2012 16:46:13 for Shopcart by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>

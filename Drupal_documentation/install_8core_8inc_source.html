<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Shopcart: includes/install.core.inc Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Shopcart
   &#160;<span id="projectnumber">version2.0</span>
   </div>
   <div id="projectbrief">Shoppingcart</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_5b89693129504707d608c5412e7b88d4.html">includes</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">install.core.inc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="install_8core_8inc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00020"></a><a class="code" href="install_8core_8inc_a52d485a9e7b74dd6b159ee8569f44c1a.html#a52d485a9e7b74dd6b159ee8569f44c1a">00020</a> define(<span class="stringliteral">&#39;INSTALL_TASK_SKIP&#39;</span>, 1);
<a name="l00021"></a>00021 
<a name="l00028"></a><a class="code" href="install_8core_8inc_a5a0aee9d902a6b08a0b74a873d60c125.html#a5a0aee9d902a6b08a0b74a873d60c125">00028</a> define(<span class="stringliteral">&#39;INSTALL_TASK_RUN_IF_REACHED&#39;</span>, 2);
<a name="l00029"></a>00029 
<a name="l00042"></a><a class="code" href="install_8core_8inc_a66ef8f31ae036a8f204f18b60b88954e.html#a66ef8f31ae036a8f204f18b60b88954e">00042</a> define(<span class="stringliteral">&#39;INSTALL_TASK_RUN_IF_NOT_COMPLETED&#39;</span>, 3);
<a name="l00043"></a>00043 
<a name="l00066"></a><a class="code" href="install_8core_8inc_ae451893f8ee7ea51f1467cec82a51fad.html#ae451893f8ee7ea51f1467cec82a51fad">00066</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_ae451893f8ee7ea51f1467cec82a51fad.html#ae451893f8ee7ea51f1467cec82a51fad" title="Installs Drupal either interactively or via an array of passed-in settings.">install_drupal</a>($settings = array()) {
<a name="l00067"></a>00067   global $install_state;
<a name="l00068"></a>00068   <span class="comment">// Initialize the installation state with the settings that were passed in,</span>
<a name="l00069"></a>00069   <span class="comment">// as well as a boolean indicating whether or not this is an interactive</span>
<a name="l00070"></a>00070   <span class="comment">// installation.</span>
<a name="l00071"></a>00071   $interactive = empty($settings);
<a name="l00072"></a>00072   $install_state = $settings + array(<span class="stringliteral">&#39;interactive&#39;</span> =&gt; $interactive) + <a class="code" href="install_8core_8inc_ab52bef71652d133045e4182da84a33b8.html#ab52bef71652d133045e4182da84a33b8" title="Returns an array of default settings for the global installation state.">install_state_defaults</a>();
<a name="l00073"></a>00073   <span class="keywordflow">try</span> {
<a name="l00074"></a>00074     <span class="comment">// Begin the page request. This adds information about the current state of</span>
<a name="l00075"></a>00075     <span class="comment">// the Drupal installation to the passed-in array.</span>
<a name="l00076"></a>00076     <a class="code" href="install_8core_8inc_a4c7572aea2e36952bbd5e73e22eb66f8.html#a4c7572aea2e36952bbd5e73e22eb66f8" title="Begin an installation request, modifying the installation state as needed.">install_begin_request</a>($install_state);
<a name="l00077"></a>00077     <span class="comment">// Based on the installation state, run the remaining tasks for this page</span>
<a name="l00078"></a>00078     <span class="comment">// request, and collect any output.</span>
<a name="l00079"></a>00079     <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> = <a class="code" href="install_8core_8inc_a8ea31b06c1d5a973906d0e9b5cfa946e.html#a8ea31b06c1d5a973906d0e9b5cfa946e" title="Runs all tasks for the current installation request.">install_run_tasks</a>($install_state);
<a name="l00080"></a>00080   }
<a name="l00081"></a>00081   <span class="keywordflow">catch</span> (<a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a> $e) {
<a name="l00082"></a>00082     <span class="comment">// When an installation error occurs, either send the error to the web</span>
<a name="l00083"></a>00083     <span class="comment">// browser or pass on the exception so the calling script can use it.</span>
<a name="l00084"></a>00084     <span class="keywordflow">if</span> ($install_state[<span class="stringliteral">&#39;interactive&#39;</span>]) {
<a name="l00085"></a>00085       <a class="code" href="install_8core_8inc_aadf48482ac0487e79f48b346dc550806.html#aadf48482ac0487e79f48b346dc550806" title="Displays themed installer output and ends the page request.">install_display_output</a>($e-&gt;getMessage(), $install_state);
<a name="l00086"></a>00086     }
<a name="l00087"></a>00087     <span class="keywordflow">else</span> {
<a name="l00088"></a>00088       <span class="keywordflow">throw</span> $e;
<a name="l00089"></a>00089     }
<a name="l00090"></a>00090   }
<a name="l00091"></a>00091   <span class="comment">// All available tasks for this page request are now complete. Interactive</span>
<a name="l00092"></a>00092   <span class="comment">// installations can send output to the browser or redirect the user to the</span>
<a name="l00093"></a>00093   <span class="comment">// next page.</span>
<a name="l00094"></a>00094   <span class="keywordflow">if</span> ($install_state[<span class="stringliteral">&#39;interactive&#39;</span>]) {
<a name="l00095"></a>00095     <span class="keywordflow">if</span> ($install_state[<span class="stringliteral">&#39;parameters_changed&#39;</span>]) {
<a name="l00096"></a>00096       <span class="comment">// Redirect to the correct page if the URL parameters have changed.</span>
<a name="l00097"></a>00097       <a class="code" href="install_8inc_a8500b736c9651e3947265d35fc6ab920.html#a8500b736c9651e3947265d35fc6ab920" title="Send the user to a different installer page.">install_goto</a>(<a class="code" href="install_8core_8inc_a6653d055f5af1ec01fa9769b41f747b5.html#a6653d055f5af1ec01fa9769b41f747b5" title="Returns the URL that should be redirected to during an installation request.">install_redirect_url</a>($install_state));
<a name="l00098"></a>00098     }
<a name="l00099"></a>00099     elseif (isset(<a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>)) {
<a name="l00100"></a>00100       <span class="comment">// Display a page only if some output is available. Otherwise it is</span>
<a name="l00101"></a>00101       <span class="comment">// possible that we are printing a JSON page and theme output should</span>
<a name="l00102"></a>00102       <span class="comment">// not be shown.</span>
<a name="l00103"></a>00103       <a class="code" href="install_8core_8inc_aadf48482ac0487e79f48b346dc550806.html#aadf48482ac0487e79f48b346dc550806" title="Displays themed installer output and ends the page request.">install_display_output</a>(<a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>, $install_state);
<a name="l00104"></a>00104     }
<a name="l00105"></a>00105   }
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00126"></a><a class="code" href="install_8core_8inc_ab52bef71652d133045e4182da84a33b8.html#ab52bef71652d133045e4182da84a33b8">00126</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_ab52bef71652d133045e4182da84a33b8.html#ab52bef71652d133045e4182da84a33b8" title="Returns an array of default settings for the global installation state.">install_state_defaults</a>() {
<a name="l00127"></a>00127   $defaults = array(
<a name="l00128"></a>00128     <span class="comment">// The current task being processed.</span>
<a name="l00129"></a>00129     <span class="stringliteral">&#39;active_task&#39;</span> =&gt; NULL,
<a name="l00130"></a>00130     <span class="comment">// The last task that was completed during the previous installation</span>
<a name="l00131"></a>00131     <span class="comment">// request.</span>
<a name="l00132"></a>00132     <span class="stringliteral">&#39;completed_task&#39;</span> =&gt; NULL,
<a name="l00133"></a>00133     <span class="comment">// This becomes TRUE only when Drupal&#39;s system module is installed.</span>
<a name="l00134"></a>00134     <span class="stringliteral">&#39;database_tables_exist&#39;</span> =&gt; FALSE,
<a name="l00135"></a>00135     <span class="comment">// An array of forms to be programmatically submitted during the</span>
<a name="l00136"></a>00136     <span class="comment">// installation. The keys of each element indicate the name of the</span>
<a name="l00137"></a>00137     <span class="comment">// installation task that the form submission is for, and the values are</span>
<a name="l00138"></a>00138     <span class="comment">// used as the $form_state[&#39;values&#39;] array that is passed on to the form</span>
<a name="l00139"></a>00139     <span class="comment">// submission via drupal_form_submit().</span>
<a name="l00140"></a>00140     <span class="stringliteral">&#39;forms&#39;</span> =&gt; array(),
<a name="l00141"></a>00141     <span class="comment">// This becomes TRUE only at the end of the installation process, after</span>
<a name="l00142"></a>00142     <span class="comment">// all available tasks have been completed and Drupal is fully installed.</span>
<a name="l00143"></a>00143     <span class="comment">// It is used by the installer to store correct information in the database</span>
<a name="l00144"></a>00144     <span class="comment">// about the completed installation, as well as to inform theme functions</span>
<a name="l00145"></a>00145     <span class="comment">// that all tasks are finished (so that the task list can be displayed</span>
<a name="l00146"></a>00146     <span class="comment">// correctly).</span>
<a name="l00147"></a>00147     <span class="stringliteral">&#39;installation_finished&#39;</span> =&gt; FALSE,
<a name="l00148"></a>00148     <span class="comment">// Whether or not this installation is interactive. By default this will</span>
<a name="l00149"></a>00149     <span class="comment">// be set to FALSE if settings are passed in to install_drupal().</span>
<a name="l00150"></a>00150     <span class="stringliteral">&#39;interactive&#39;</span> =&gt; TRUE,
<a name="l00151"></a>00151     <span class="comment">// An array of available languages for the installation.</span>
<a name="l00152"></a>00152     <span class="stringliteral">&#39;locales&#39;</span> =&gt; array(),
<a name="l00153"></a>00153     <span class="comment">// An array of parameters for the installation, pre-populated by the URL</span>
<a name="l00154"></a>00154     <span class="comment">// or by the settings passed in to install_drupal(). This is primarily</span>
<a name="l00155"></a>00155     <span class="comment">// used to store &#39;profile&#39; (the name of the chosen installation profile)</span>
<a name="l00156"></a>00156     <span class="comment">// and &#39;locale&#39; (the name of the chosen installation language), since</span>
<a name="l00157"></a>00157     <span class="comment">// these settings need to persist from page request to page request before</span>
<a name="l00158"></a>00158     <span class="comment">// the database is available for storage.</span>
<a name="l00159"></a>00159     <span class="stringliteral">&#39;parameters&#39;</span> =&gt; array(),
<a name="l00160"></a>00160     <span class="comment">// Whether or not the parameters have changed during the current page</span>
<a name="l00161"></a>00161     <span class="comment">// request. For interactive installations, this will trigger a page</span>
<a name="l00162"></a>00162     <span class="comment">// redirect.</span>
<a name="l00163"></a>00163     <span class="stringliteral">&#39;parameters_changed&#39;</span> =&gt; FALSE,
<a name="l00164"></a>00164     <span class="comment">// An array of information about the chosen installation profile. This will</span>
<a name="l00165"></a>00165     <span class="comment">// be filled in based on the profile&#39;s .info file.</span>
<a name="l00166"></a>00166     <span class="stringliteral">&#39;profile_info&#39;</span> =&gt; array(),
<a name="l00167"></a>00167     <span class="comment">// An array of available installation profiles.</span>
<a name="l00168"></a>00168     <span class="stringliteral">&#39;profiles&#39;</span> =&gt; array(),
<a name="l00169"></a>00169     <span class="comment">// An array of server variables that will be substituted into the global</span>
<a name="l00170"></a>00170     <span class="comment">// $_SERVER array via drupal_override_server_variables(). Used by</span>
<a name="l00171"></a>00171     <span class="comment">// non-interactive installations only.</span>
<a name="l00172"></a>00172     <span class="stringliteral">&#39;server&#39;</span> =&gt; array(),
<a name="l00173"></a>00173     <span class="comment">// This becomes TRUE only when a valid database connection can be</span>
<a name="l00174"></a>00174     <span class="comment">// established.</span>
<a name="l00175"></a>00175     <span class="stringliteral">&#39;settings_verified&#39;</span> =&gt; FALSE,
<a name="l00176"></a>00176     <span class="comment">// Installation tasks can set this to TRUE to force the page request to</span>
<a name="l00177"></a>00177     <span class="comment">// end (even if there is no themable output), in the case of an interactive</span>
<a name="l00178"></a>00178     <span class="comment">// installation. This is needed only rarely; for example, it would be used</span>
<a name="l00179"></a>00179     <span class="comment">// by an installation task that prints JSON output rather than returning a</span>
<a name="l00180"></a>00180     <span class="comment">// themed page. The most common example of this is during batch processing,</span>
<a name="l00181"></a>00181     <span class="comment">// but the Drupal installer automatically takes care of setting this</span>
<a name="l00182"></a>00182     <span class="comment">// parameter properly in that case, so that individual installation tasks</span>
<a name="l00183"></a>00183     <span class="comment">// which implement the batch API do not need to set it themselves.</span>
<a name="l00184"></a>00184     <span class="stringliteral">&#39;stop_page_request&#39;</span> =&gt; FALSE,
<a name="l00185"></a>00185     <span class="comment">// Installation tasks can set this to TRUE to indicate that the task should</span>
<a name="l00186"></a>00186     <span class="comment">// be run again, even if it normally wouldn&#39;t be. This can be used, for</span>
<a name="l00187"></a>00187     <span class="comment">// example, if a single task needs to be spread out over multiple page</span>
<a name="l00188"></a>00188     <span class="comment">// requests, or if it needs to perform some validation before allowing</span>
<a name="l00189"></a>00189     <span class="comment">// itself to be marked complete. The most common examples of this are batch</span>
<a name="l00190"></a>00190     <span class="comment">// processing and form submissions, but the Drupal installer automatically</span>
<a name="l00191"></a>00191     <span class="comment">// takes care of setting this parameter properly in those cases, so that</span>
<a name="l00192"></a>00192     <span class="comment">// individual installation tasks which implement the batch API or form API</span>
<a name="l00193"></a>00193     <span class="comment">// do not need to set it themselves.</span>
<a name="l00194"></a>00194     <span class="stringliteral">&#39;task_not_complete&#39;</span> =&gt; FALSE,
<a name="l00195"></a>00195     <span class="comment">// A list of installation tasks which have already been performed during</span>
<a name="l00196"></a>00196     <span class="comment">// the current page request.</span>
<a name="l00197"></a>00197     <span class="stringliteral">&#39;tasks_performed&#39;</span> =&gt; array(),
<a name="l00198"></a>00198   );
<a name="l00199"></a>00199   <span class="keywordflow">return</span> $defaults;
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 
<a name="l00212"></a><a class="code" href="install_8core_8inc_a4c7572aea2e36952bbd5e73e22eb66f8.html#a4c7572aea2e36952bbd5e73e22eb66f8">00212</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a4c7572aea2e36952bbd5e73e22eb66f8.html#a4c7572aea2e36952bbd5e73e22eb66f8" title="Begin an installation request, modifying the installation state as needed.">install_begin_request</a>(&amp;$install_state) {
<a name="l00213"></a>00213   <span class="comment">// Add any installation parameters passed in via the URL.</span>
<a name="l00214"></a>00214   $install_state[<span class="stringliteral">&#39;parameters&#39;</span>] += $_GET;
<a name="l00215"></a>00215 
<a name="l00216"></a>00216   <span class="comment">// Validate certain core settings that are used throughout the installation.</span>
<a name="l00217"></a>00217   <span class="keywordflow">if</span> (!empty($install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>])) {
<a name="l00218"></a>00218     $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>] = preg_replace(<span class="stringliteral">&#39;/[^a-zA-Z_0-9]/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>]);
<a name="l00219"></a>00219   }
<a name="l00220"></a>00220   <span class="keywordflow">if</span> (!empty($install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;locale&#39;</span>])) {
<a name="l00221"></a>00221     $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;locale&#39;</span>] = preg_replace(<span class="stringliteral">&#39;/[^a-zA-Z_0-9\-]/&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;locale&#39;</span>]);
<a name="l00222"></a>00222   }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224   <span class="comment">// Allow command line scripts to override server variables used by Drupal.</span>
<a name="l00225"></a>00225   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/bootstrap.inc&#39;</span>;
<a name="l00226"></a>00226   <span class="keywordflow">if</span> (!$install_state[<span class="stringliteral">&#39;interactive&#39;</span>]) {
<a name="l00227"></a>00227     <a class="code" href="bootstrap_8inc_ae40262dd353ec3d0fada2e2d2d44a8ef.html#ae40262dd353ec3d0fada2e2d2d44a8ef" title="Sets appropriate server variables needed for command line scripts to work.">drupal_override_server_variables</a>($install_state[<span class="stringliteral">&#39;server&#39;</span>]);
<a name="l00228"></a>00228   }
<a name="l00229"></a>00229 
<a name="l00230"></a>00230   <span class="comment">// The user agent header is used to pass a database prefix in the request when</span>
<a name="l00231"></a>00231   <span class="comment">// running tests. However, for security reasons, it is imperative that no</span>
<a name="l00232"></a>00232   <span class="comment">// installation be permitted using such a prefix.</span>
<a name="l00233"></a>00233   <span class="keywordflow">if</span> (isset($_SERVER[<span class="stringliteral">&#39;HTTP_USER_AGENT&#39;</span>]) &amp;&amp; strpos($_SERVER[<span class="stringliteral">&#39;HTTP_USER_AGENT&#39;</span>], <span class="stringliteral">&quot;simpletest&quot;</span>) !== FALSE) {
<a name="l00234"></a>00234     header($_SERVER[<span class="stringliteral">&#39;SERVER_PROTOCOL&#39;</span>] . <span class="stringliteral">&#39; 403 Forbidden&#39;</span>);
<a name="l00235"></a>00235     exit;
<a name="l00236"></a>00236   }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238   <a class="code" href="bootstrap_8inc_a8dcad7737ed560086bcdd9998a020a93.html#a8dcad7737ed560086bcdd9998a020a93" title="Ensures Drupal is bootstrapped to the specified phase.">drupal_bootstrap</a>(<a class="code" href="bootstrap_8inc_ad71394314c3ad7cef54b5f566e3ec177.html#ad71394314c3ad7cef54b5f566e3ec177" title="End of &quot;defgroup logging_severity_levels&quot;.">DRUPAL_BOOTSTRAP_CONFIGURATION</a>);
<a name="l00239"></a>00239 
<a name="l00240"></a>00240   <span class="comment">// This must go after drupal_bootstrap(), which unsets globals!</span>
<a name="l00241"></a>00241   global <a class="code" href="authorize_8php_a10064a52f624358ea93475105245c4ac.html#a10064a52f624358ea93475105245c4ac">$conf</a>;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/modules/system/system.install&#39;</span>;
<a name="l00244"></a>00244   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/common.inc&#39;</span>;
<a name="l00245"></a>00245   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/file.inc&#39;</span>;
<a name="l00246"></a>00246   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/install.inc&#39;</span>;
<a name="l00247"></a>00247   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="charliteral">&#39;/&#39;</span> . <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;path_inc&#39;</span>, <span class="stringliteral">&#39;includes/path.inc&#39;</span>);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249   <span class="comment">// Load module basics (needed for hook invokes).</span>
<a name="l00250"></a>00250   include_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/module.inc&#39;</span>;
<a name="l00251"></a>00251   include_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/session.inc&#39;</span>;
<a name="l00252"></a>00252 
<a name="l00253"></a>00253   <span class="comment">// Set up $language, so t() caller functions will still work.</span>
<a name="l00254"></a>00254   <a class="code" href="bootstrap_8inc_a8abdce8019511ce4a74d3d9b48a93717.html#a8abdce8019511ce4a74d3d9b48a93717" title="Initializes all the defined language types.">drupal_language_initialize</a>();
<a name="l00255"></a>00255 
<a name="l00256"></a>00256   include_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/entity.inc&#39;</span>;
<a name="l00257"></a>00257   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/ajax.inc&#39;</span>;
<a name="l00258"></a>00258   <a class="code" href="authorize_8php_acf0330c113447a7ab0d77159f9370222.html#acf0330c113447a7ab0d77159f9370222">$module_list</a>[<span class="stringliteral">&#39;system&#39;</span>][<span class="stringliteral">&#39;filename&#39;</span>] = <span class="stringliteral">&#39;modules/system/system.module&#39;</span>;
<a name="l00259"></a>00259   <a class="code" href="authorize_8php_acf0330c113447a7ab0d77159f9370222.html#acf0330c113447a7ab0d77159f9370222">$module_list</a>[<span class="stringliteral">&#39;user&#39;</span>][<span class="stringliteral">&#39;filename&#39;</span>] = <span class="stringliteral">&#39;modules/user/user.module&#39;</span>;
<a name="l00260"></a>00260   <a class="code" href="module_8inc_ad4ef444bbb8e56724e12908cf9b6e1aa.html#ad4ef444bbb8e56724e12908cf9b6e1aa" title="Returns a list of currently active modules.">module_list</a>(TRUE, FALSE, FALSE, <a class="code" href="authorize_8php_acf0330c113447a7ab0d77159f9370222.html#acf0330c113447a7ab0d77159f9370222">$module_list</a>);
<a name="l00261"></a>00261   <a class="code" href="bootstrap_8inc_a13a2254228f213a980dc1f09886b8802.html#a13a2254228f213a980dc1f09886b8802" title="Includes a file with the provided type and name.">drupal_load</a>(<span class="stringliteral">&#39;module&#39;</span>, <span class="stringliteral">&#39;system&#39;</span>);
<a name="l00262"></a>00262   <a class="code" href="bootstrap_8inc_a13a2254228f213a980dc1f09886b8802.html#a13a2254228f213a980dc1f09886b8802" title="Includes a file with the provided type and name.">drupal_load</a>(<span class="stringliteral">&#39;module&#39;</span>, <span class="stringliteral">&#39;user&#39;</span>);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264   <span class="comment">// Load the cache infrastructure using a &quot;fake&quot; cache implementation that</span>
<a name="l00265"></a>00265   <span class="comment">// does not attempt to write to the database. We need this during the initial</span>
<a name="l00266"></a>00266   <span class="comment">// part of the installer because the database is not available yet. We</span>
<a name="l00267"></a>00267   <span class="comment">// continue to use it even when the database does become available, in order</span>
<a name="l00268"></a>00268   <span class="comment">// to preserve consistency between interactive and command-line installations</span>
<a name="l00269"></a>00269   <span class="comment">// (the latter complete in one page request and therefore are forced to</span>
<a name="l00270"></a>00270   <span class="comment">// continue using the cache implementation they started with) and also</span>
<a name="l00271"></a>00271   <span class="comment">// because any data put in the cache during the installer is inherently</span>
<a name="l00272"></a>00272   <span class="comment">// suspect, due to the fact that Drupal is not fully set up yet.</span>
<a name="l00273"></a>00273   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/cache.inc&#39;</span>;
<a name="l00274"></a>00274   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/cache-install.inc&#39;</span>;
<a name="l00275"></a>00275   $conf[<span class="stringliteral">&#39;cache_default_class&#39;</span>] = <span class="stringliteral">&#39;DrupalFakeCache&#39;</span>;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277   <span class="comment">// Prepare for themed output. We need to run this at the beginning of the</span>
<a name="l00278"></a>00278   <span class="comment">// page request to avoid a different theme accidentally getting set. (We also</span>
<a name="l00279"></a>00279   <span class="comment">// need to run it even in the case of command-line installations, to prevent</span>
<a name="l00280"></a>00280   <span class="comment">// any code in the installer that happens to initialize the theme system from</span>
<a name="l00281"></a>00281   <span class="comment">// accessing the database before it is set up yet.)</span>
<a name="l00282"></a>00282   <a class="code" href="bootstrap_8inc_a861d3f7c553fe62829f6c0f2e4fe89e6.html#a861d3f7c553fe62829f6c0f2e4fe89e6" title="Enables use of the theme system without requiring database access.">drupal_maintenance_theme</a>();
<a name="l00283"></a>00283 
<a name="l00284"></a>00284   <span class="comment">// Check existing settings.php.</span>
<a name="l00285"></a>00285   $install_state[<span class="stringliteral">&#39;settings_verified&#39;</span>] = <a class="code" href="install_8core_8inc_ab9be391a3ce3d42b0a75b2abe95b5232.html#ab9be391a3ce3d42b0a75b2abe95b5232" title="Verifies the existing settings in settings.php.">install_verify_settings</a>();
<a name="l00286"></a>00286 
<a name="l00287"></a>00287   <span class="keywordflow">if</span> ($install_state[<span class="stringliteral">&#39;settings_verified&#39;</span>]) {
<a name="l00288"></a>00288     <span class="comment">// Initialize the database system. Note that the connection</span>
<a name="l00289"></a>00289     <span class="comment">// won&#39;t be initialized until it is actually requested.</span>
<a name="l00290"></a>00290     require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/database/database.inc&#39;</span>;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     <span class="comment">// Verify the last completed task in the database, if there is one.</span>
<a name="l00293"></a>00293     $task = <a class="code" href="install_8core_8inc_a0c550ddc08ed7884ffdfc444c85d4a3a.html#a0c550ddc08ed7884ffdfc444c85d4a3a" title="Verify and return the last installation task that was completed.">install_verify_completed_task</a>();
<a name="l00294"></a>00294   }
<a name="l00295"></a>00295   <span class="keywordflow">else</span> {
<a name="l00296"></a>00296     $task = NULL;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     <span class="comment">// Do not install over a configured settings.php. Check the &#39;db_url&#39;</span>
<a name="l00299"></a>00299     <span class="comment">// variable in addition to &#39;databases&#39;, since previous versions of Drupal</span>
<a name="l00300"></a>00300     <span class="comment">// used that (and we do not want to allow installations on an existing site</span>
<a name="l00301"></a>00301     <span class="comment">// whose settings file has not yet been updated).</span>
<a name="l00302"></a>00302     <span class="keywordflow">if</span> (!empty($GLOBALS[<span class="stringliteral">&#39;databases&#39;</span>]) || !empty($GLOBALS[<span class="stringliteral">&#39;db_url&#39;</span>])) {
<a name="l00303"></a>00303       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a>(<a class="code" href="install_8core_8inc_a6469cc717a3ac52eece0537630addea4.html#a6469cc717a3ac52eece0537630addea4" title="Indicates that Drupal has already been installed.">install_already_done_error</a>());
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305   }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307   <span class="comment">// Modify the installation state as appropriate.</span>
<a name="l00308"></a>00308   $install_state[<span class="stringliteral">&#39;completed_task&#39;</span>] = $task;
<a name="l00309"></a>00309   $install_state[<span class="stringliteral">&#39;database_tables_exist&#39;</span>] = !empty($task);
<a name="l00310"></a>00310 }
<a name="l00311"></a>00311 
<a name="l00327"></a><a class="code" href="install_8core_8inc_a8ea31b06c1d5a973906d0e9b5cfa946e.html#a8ea31b06c1d5a973906d0e9b5cfa946e">00327</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a8ea31b06c1d5a973906d0e9b5cfa946e.html#a8ea31b06c1d5a973906d0e9b5cfa946e" title="Runs all tasks for the current installation request.">install_run_tasks</a>(&amp;$install_state) {
<a name="l00328"></a>00328   <span class="keywordflow">do</span> {
<a name="l00329"></a>00329     <span class="comment">// Obtain a list of tasks to perform. The list of tasks itself can be</span>
<a name="l00330"></a>00330     <span class="comment">// dynamic (e.g., some might be defined by the installation profile,</span>
<a name="l00331"></a>00331     <span class="comment">// which is not necessarily known until the earlier tasks have run),</span>
<a name="l00332"></a>00332     <span class="comment">// so we regenerate the remaining tasks based on the installation state,</span>
<a name="l00333"></a>00333     <span class="comment">// each time through the loop.</span>
<a name="l00334"></a>00334     $tasks_to_perform = <a class="code" href="install_8core_8inc_a02b255f3c91fa330972d77e41c0b26c4.html#a02b255f3c91fa330972d77e41c0b26c4" title="Returns a list of tasks to perform during the current installation request.">install_tasks_to_perform</a>($install_state);
<a name="l00335"></a>00335     <span class="comment">// Run the first task on the list.</span>
<a name="l00336"></a>00336     reset($tasks_to_perform);
<a name="l00337"></a>00337     $task_name = key($tasks_to_perform);
<a name="l00338"></a>00338     $task = array_shift($tasks_to_perform);
<a name="l00339"></a>00339     $install_state[<span class="stringliteral">&#39;active_task&#39;</span>] = $task_name;
<a name="l00340"></a>00340     $original_parameters = $install_state[<span class="stringliteral">&#39;parameters&#39;</span>];
<a name="l00341"></a>00341     <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> = <a class="code" href="install_8core_8inc_aed4e27f03b3779541b3ea5b00506f410.html#aed4e27f03b3779541b3ea5b00506f410" title="Runs an individual installation task.">install_run_task</a>($task, $install_state);
<a name="l00342"></a>00342     $install_state[<span class="stringliteral">&#39;parameters_changed&#39;</span>] = ($install_state[<span class="stringliteral">&#39;parameters&#39;</span>] != $original_parameters);
<a name="l00343"></a>00343     <span class="comment">// Store this task as having been performed during the current request,</span>
<a name="l00344"></a>00344     <span class="comment">// and save it to the database as completed, if we need to and if the</span>
<a name="l00345"></a>00345     <span class="comment">// database is in a state that allows us to do so. Also mark the</span>
<a name="l00346"></a>00346     <span class="comment">// installation as &#39;done&#39; when we have run out of tasks.</span>
<a name="l00347"></a>00347     <span class="keywordflow">if</span> (!$install_state[<span class="stringliteral">&#39;task_not_complete&#39;</span>]) {
<a name="l00348"></a>00348       $install_state[<span class="stringliteral">&#39;tasks_performed&#39;</span>][] = $task_name;
<a name="l00349"></a>00349       $install_state[<span class="stringliteral">&#39;installation_finished&#39;</span>] = empty($tasks_to_perform);
<a name="l00350"></a>00350       <span class="keywordflow">if</span> ($install_state[<span class="stringliteral">&#39;database_tables_exist&#39;</span>] &amp;&amp; ($task[<span class="stringliteral">&#39;run&#39;</span>] == <a class="code" href="install_8core_8inc_a66ef8f31ae036a8f204f18b60b88954e.html#a66ef8f31ae036a8f204f18b60b88954e" title="Global flag to indicate that a task should be run on each installation request that reaches it...">INSTALL_TASK_RUN_IF_NOT_COMPLETED</a> || $install_state[<span class="stringliteral">&#39;installation_finished&#39;</span>])) {
<a name="l00351"></a>00351         <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;install_task&#39;</span>, $install_state[<span class="stringliteral">&#39;installation_finished&#39;</span>] ? <span class="stringliteral">&#39;done&#39;</span> : $task_name);
<a name="l00352"></a>00352       }
<a name="l00353"></a>00353     }
<a name="l00354"></a>00354     <span class="comment">// Stop when there are no tasks left. In the case of an interactive</span>
<a name="l00355"></a>00355     <span class="comment">// installation, also stop if we have some output to send to the browser,</span>
<a name="l00356"></a>00356     <span class="comment">// the URL parameters have changed, or an end to the page request was</span>
<a name="l00357"></a>00357     <span class="comment">// specifically called for.</span>
<a name="l00358"></a>00358     $finished = empty($tasks_to_perform) || ($install_state[<span class="stringliteral">&#39;interactive&#39;</span>] &amp;&amp; (isset(<a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>) || $install_state[<span class="stringliteral">&#39;parameters_changed&#39;</span>] || $install_state[<span class="stringliteral">&#39;stop_page_request&#39;</span>]));
<a name="l00359"></a>00359   } <span class="keywordflow">while</span> (!$finished);
<a name="l00360"></a>00360   <span class="keywordflow">return</span> <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>;
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00375"></a><a class="code" href="install_8core_8inc_aed4e27f03b3779541b3ea5b00506f410.html#aed4e27f03b3779541b3ea5b00506f410">00375</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_aed4e27f03b3779541b3ea5b00506f410.html#aed4e27f03b3779541b3ea5b00506f410" title="Runs an individual installation task.">install_run_task</a>($task, &amp;$install_state) {
<a name="l00376"></a>00376   $function = $task[<span class="stringliteral">&#39;function&#39;</span>];
<a name="l00377"></a>00377 
<a name="l00378"></a>00378   <span class="keywordflow">if</span> ($task[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;form&#39;</span>) {
<a name="l00379"></a>00379     require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/form.inc&#39;</span>;
<a name="l00380"></a>00380     <span class="keywordflow">if</span> ($install_state[<span class="stringliteral">&#39;interactive&#39;</span>]) {
<a name="l00381"></a>00381       <span class="comment">// For interactive forms, build the form and ensure that it will not</span>
<a name="l00382"></a>00382       <span class="comment">// redirect, since the installer handles its own redirection only after</span>
<a name="l00383"></a>00383       <span class="comment">// marking the form submission task complete.</span>
<a name="l00384"></a>00384       $form_state = array(
<a name="l00385"></a>00385         <span class="comment">// We need to pass $install_state by reference in order for forms to</span>
<a name="l00386"></a>00386         <span class="comment">// modify it, since the form API will use it in call_user_func_array(),</span>
<a name="l00387"></a>00387         <span class="comment">// which requires that referenced variables be passed explicitly.</span>
<a name="l00388"></a>00388         <span class="stringliteral">&#39;build_info&#39;</span> =&gt; array(<span class="stringliteral">&#39;args&#39;</span> =&gt; array(&amp;$install_state)),
<a name="l00389"></a>00389         <span class="stringliteral">&#39;no_redirect&#39;</span> =&gt; TRUE,
<a name="l00390"></a>00390       );
<a name="l00391"></a>00391       $form = <a class="code" href="group__form__api_gabead4b3c089fd605421d371a0315c4d7.html#gabead4b3c089fd605421d371a0315c4d7" title="Builds and process a form based on a form id.">drupal_build_form</a>($function, $form_state);
<a name="l00392"></a>00392       <span class="comment">// If a successful form submission did not occur, the form needs to be</span>
<a name="l00393"></a>00393       <span class="comment">// rendered, which means the task is not complete yet.</span>
<a name="l00394"></a>00394       <span class="keywordflow">if</span> (empty($form_state[<span class="stringliteral">&#39;executed&#39;</span>])) {
<a name="l00395"></a>00395         $install_state[<span class="stringliteral">&#39;task_not_complete&#39;</span>] = TRUE;
<a name="l00396"></a>00396         <span class="keywordflow">return</span> <a class="code" href="common_8inc_a05798b44e8d6c496d4bee5cc32fa7851.html#a05798b44e8d6c496d4bee5cc32fa7851" title="Renders HTML given a structured array tree.">drupal_render</a>($form);
<a name="l00397"></a>00397       }
<a name="l00398"></a>00398       <span class="comment">// Otherwise, return nothing so the next task will run in the same</span>
<a name="l00399"></a>00399       <span class="comment">// request.</span>
<a name="l00400"></a>00400       <span class="keywordflow">return</span>;
<a name="l00401"></a>00401     }
<a name="l00402"></a>00402     <span class="keywordflow">else</span> {
<a name="l00403"></a>00403       <span class="comment">// For non-interactive forms, submit the form programmatically with the</span>
<a name="l00404"></a>00404       <span class="comment">// values taken from the installation state. Throw an exception if any</span>
<a name="l00405"></a>00405       <span class="comment">// errors were encountered.</span>
<a name="l00406"></a>00406       $form_state = array(
<a name="l00407"></a>00407         <span class="stringliteral">&#39;values&#39;</span> =&gt; !empty($install_state[<span class="stringliteral">&#39;forms&#39;</span>][$function]) ? $install_state[<span class="stringliteral">&#39;forms&#39;</span>][$function] : array(),
<a name="l00408"></a>00408         <span class="comment">// We need to pass $install_state by reference in order for forms to</span>
<a name="l00409"></a>00409         <span class="comment">// modify it, since the form API will use it in call_user_func_array(),</span>
<a name="l00410"></a>00410         <span class="comment">// which requires that referenced variables be passed explicitly.</span>
<a name="l00411"></a>00411         <span class="stringliteral">&#39;build_info&#39;</span> =&gt; array(<span class="stringliteral">&#39;args&#39;</span> =&gt; array(&amp;$install_state)),
<a name="l00412"></a>00412       );
<a name="l00413"></a>00413       <a class="code" href="group__form__api_ga4312d7fe0602f6359153fc62cba1ca24.html#ga4312d7fe0602f6359153fc62cba1ca24" title="Retrieves, populates, and processes a form.">drupal_form_submit</a>($function, $form_state);
<a name="l00414"></a>00414       $errors = <a class="code" href="group__form__api_ga158b3db5e88e96bf060c524cebcb8130.html#ga158b3db5e88e96bf060c524cebcb8130" title="Returns an associative array of all errors.">form_get_errors</a>();
<a name="l00415"></a>00415       <span class="keywordflow">if</span> (!empty($errors)) {
<a name="l00416"></a>00416         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a>(implode(<span class="stringliteral">&quot;\n&quot;</span>, $errors));
<a name="l00417"></a>00417       }
<a name="l00418"></a>00418     }
<a name="l00419"></a>00419   }
<a name="l00420"></a>00420 
<a name="l00421"></a>00421   elseif ($task[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;batch&#39;</span>) {
<a name="l00422"></a>00422     <span class="comment">// Start a new batch based on the task function, if one is not running</span>
<a name="l00423"></a>00423     <span class="comment">// already.</span>
<a name="l00424"></a>00424     $current_batch = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;install_current_batch&#39;</span>);
<a name="l00425"></a>00425     <span class="keywordflow">if</span> (!$install_state[<span class="stringliteral">&#39;interactive&#39;</span>] || !$current_batch) {
<a name="l00426"></a>00426       $batch = $function($install_state);
<a name="l00427"></a>00427       <span class="keywordflow">if</span> (empty($batch)) {
<a name="l00428"></a>00428         <span class="comment">// If the task did some processing and decided no batch was necessary,</span>
<a name="l00429"></a>00429         <span class="comment">// there is nothing more to do here.</span>
<a name="l00430"></a>00430         <span class="keywordflow">return</span>;
<a name="l00431"></a>00431       }
<a name="l00432"></a>00432       <a class="code" href="group__batch_ga9ff3f18b3bdd1d62ab7ac681a22a7170.html#ga9ff3f18b3bdd1d62ab7ac681a22a7170" title="Adds a new batch.">batch_set</a>($batch);
<a name="l00433"></a>00433       <span class="comment">// For interactive batches, we need to store the fact that this batch</span>
<a name="l00434"></a>00434       <span class="comment">// task is currently running. Otherwise, we need to make sure the batch</span>
<a name="l00435"></a>00435       <span class="comment">// will complete in one page request.</span>
<a name="l00436"></a>00436       <span class="keywordflow">if</span> ($install_state[<span class="stringliteral">&#39;interactive&#39;</span>]) {
<a name="l00437"></a>00437         <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;install_current_batch&#39;</span>, $function);
<a name="l00438"></a>00438       }
<a name="l00439"></a>00439       <span class="keywordflow">else</span> {
<a name="l00440"></a>00440         $batch =&amp; <a class="code" href="group__batch_ga971f5246c6e8e536d0b20529fb2e2638.html#ga971f5246c6e8e536d0b20529fb2e2638" title="Retrieves the current batch.">batch_get</a>();
<a name="l00441"></a>00441         $batch[<span class="stringliteral">&#39;progressive&#39;</span>] = FALSE;
<a name="l00442"></a>00442       }
<a name="l00443"></a>00443       <span class="comment">// Process the batch. For progressive batches, this will redirect.</span>
<a name="l00444"></a>00444       <span class="comment">// Otherwise, the batch will complete.</span>
<a name="l00445"></a>00445       <a class="code" href="group__batch_gab17f59692632a482cee4f65f27d082f7.html#gab17f59692632a482cee4f65f27d082f7" title="Processes the batch.">batch_process</a>(<a class="code" href="install_8core_8inc_a6653d055f5af1ec01fa9769b41f747b5.html#a6653d055f5af1ec01fa9769b41f747b5" title="Returns the URL that should be redirected to during an installation request.">install_redirect_url</a>($install_state), <a class="code" href="install_8core_8inc_a562ee3011859e71bb87c068340ce6dc6.html#a562ee3011859e71bb87c068340ce6dc6" title="Returns the complete URL redirected to during an installation request.">install_full_redirect_url</a>($install_state));
<a name="l00446"></a>00446     }
<a name="l00447"></a>00447     <span class="comment">// If we are in the middle of processing this batch, keep sending back</span>
<a name="l00448"></a>00448     <span class="comment">// any output from the batch process, until the task is complete.</span>
<a name="l00449"></a>00449     elseif ($current_batch == $function) {
<a name="l00450"></a>00450       include_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/batch.inc&#39;</span>;
<a name="l00451"></a>00451       <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> = <a class="code" href="batch_8inc_a5535c7cfeae572bda2c11f3e597a55b6.html#a5535c7cfeae572bda2c11f3e597a55b6" title="Renders the batch processing page based on the current state of the batch.">_batch_page</a>();
<a name="l00452"></a>00452       <span class="comment">// The task is complete when we try to access the batch page and receive</span>
<a name="l00453"></a>00453       <span class="comment">// FALSE in return, since this means we are at a URL where we are no</span>
<a name="l00454"></a>00454       <span class="comment">// longer requesting a batch ID.</span>
<a name="l00455"></a>00455       <span class="keywordflow">if</span> (<a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> === FALSE) {
<a name="l00456"></a>00456         <span class="comment">// Return nothing so the next task will run in the same request.</span>
<a name="l00457"></a>00457         <a class="code" href="bootstrap_8inc_a7850bff5f313f85335f418e6d87606b1.html#a7850bff5f313f85335f418e6d87606b1" title="Unsets a persistent variable.">variable_del</a>(<span class="stringliteral">&#39;install_current_batch&#39;</span>);
<a name="l00458"></a>00458         <span class="keywordflow">return</span>;
<a name="l00459"></a>00459       }
<a name="l00460"></a>00460       <span class="keywordflow">else</span> {
<a name="l00461"></a>00461         <span class="comment">// We need to force the page request to end if the task is not</span>
<a name="l00462"></a>00462         <span class="comment">// complete, since the batch API sometimes prints JSON output</span>
<a name="l00463"></a>00463         <span class="comment">// rather than returning a themed page.</span>
<a name="l00464"></a>00464         $install_state[<span class="stringliteral">&#39;task_not_complete&#39;</span>] = $install_state[<span class="stringliteral">&#39;stop_page_request&#39;</span>] = TRUE;
<a name="l00465"></a>00465         <span class="keywordflow">return</span> <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>;
<a name="l00466"></a>00466       }
<a name="l00467"></a>00467     }
<a name="l00468"></a>00468   }
<a name="l00469"></a>00469 
<a name="l00470"></a>00470   <span class="keywordflow">else</span> {
<a name="l00471"></a>00471     <span class="comment">// For normal tasks, just return the function result, whatever it is.</span>
<a name="l00472"></a>00472     <span class="keywordflow">return</span> $function($install_state);
<a name="l00473"></a>00473   }
<a name="l00474"></a>00474 }
<a name="l00475"></a>00475 
<a name="l00489"></a><a class="code" href="install_8core_8inc_a02b255f3c91fa330972d77e41c0b26c4.html#a02b255f3c91fa330972d77e41c0b26c4">00489</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a02b255f3c91fa330972d77e41c0b26c4.html#a02b255f3c91fa330972d77e41c0b26c4" title="Returns a list of tasks to perform during the current installation request.">install_tasks_to_perform</a>($install_state) {
<a name="l00490"></a>00490   <span class="comment">// Start with a list of all currently available tasks.</span>
<a name="l00491"></a>00491   $tasks = <a class="code" href="install_8core_8inc_a243570ad640fab913f1c14cc750d3194.html#a243570ad640fab913f1c14cc750d3194" title="Returns a list of all tasks the installer currently knows about.">install_tasks</a>($install_state);
<a name="l00492"></a>00492   <span class="keywordflow">foreach</span> ($tasks as $name =&gt; $task) {
<a name="l00493"></a>00493     <span class="comment">// Remove any tasks that were already performed or that never should run.</span>
<a name="l00494"></a>00494     <span class="comment">// Also, if we started this page request with an indication of the last</span>
<a name="l00495"></a>00495     <span class="comment">// task that was completed, skip that task and all those that come before</span>
<a name="l00496"></a>00496     <span class="comment">// it, unless they are marked as always needing to run.</span>
<a name="l00497"></a>00497     <span class="keywordflow">if</span> ($task[<span class="stringliteral">&#39;run&#39;</span>] == <a class="code" href="install_8core_8inc_a52d485a9e7b74dd6b159ee8569f44c1a.html#a52d485a9e7b74dd6b159ee8569f44c1a" title="Global flag to indicate that a task should not be run during the current installation request...">INSTALL_TASK_SKIP</a> || in_array($name, $install_state[<span class="stringliteral">&#39;tasks_performed&#39;</span>]) || (!empty($install_state[<span class="stringliteral">&#39;completed_task&#39;</span>]) &amp;&amp; empty($completed_task_found) &amp;&amp; $task[<span class="stringliteral">&#39;run&#39;</span>] != <a class="code" href="install_8core_8inc_a5a0aee9d902a6b08a0b74a873d60c125.html#a5a0aee9d902a6b08a0b74a873d60c125" title="Global flag to indicate that a task should be run on each installation request that reaches it...">INSTALL_TASK_RUN_IF_REACHED</a>)) {
<a name="l00498"></a>00498       unset($tasks[$name]);
<a name="l00499"></a>00499     }
<a name="l00500"></a>00500     <span class="keywordflow">if</span> (!empty($install_state[<span class="stringliteral">&#39;completed_task&#39;</span>]) &amp;&amp; $name == $install_state[<span class="stringliteral">&#39;completed_task&#39;</span>]) {
<a name="l00501"></a>00501       $completed_task_found = TRUE;
<a name="l00502"></a>00502     }
<a name="l00503"></a>00503   }
<a name="l00504"></a>00504   <span class="keywordflow">return</span> $tasks;
<a name="l00505"></a>00505 }
<a name="l00506"></a>00506 
<a name="l00522"></a><a class="code" href="install_8core_8inc_a243570ad640fab913f1c14cc750d3194.html#a243570ad640fab913f1c14cc750d3194">00522</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a243570ad640fab913f1c14cc750d3194.html#a243570ad640fab913f1c14cc750d3194" title="Returns a list of all tasks the installer currently knows about.">install_tasks</a>($install_state) {
<a name="l00523"></a>00523   <span class="comment">// Determine whether translation import tasks will need to be performed.</span>
<a name="l00524"></a>00524   $needs_translations = count($install_state[<span class="stringliteral">&#39;locales&#39;</span>]) &gt; 1 &amp;&amp; !empty($install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;locale&#39;</span>]) &amp;&amp; $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;locale&#39;</span>] != <span class="stringliteral">&#39;en&#39;</span>;
<a name="l00525"></a>00525 
<a name="l00526"></a>00526   <span class="comment">// Start with the core installation tasks that run before handing control</span>
<a name="l00527"></a>00527   <span class="comment">// to the install profile.</span>
<a name="l00528"></a>00528   $tasks = array(
<a name="l00529"></a>00529     <span class="stringliteral">&#39;install_select_profile&#39;</span> =&gt; array(
<a name="l00530"></a>00530       <span class="stringliteral">&#39;display_name&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Choose profile&#39;</span>),
<a name="l00531"></a>00531       <span class="stringliteral">&#39;display&#39;</span> =&gt; count($install_state[<span class="stringliteral">&#39;profiles&#39;</span>]) != 1,
<a name="l00532"></a>00532       <span class="stringliteral">&#39;run&#39;</span> =&gt; <a class="code" href="install_8core_8inc_a5a0aee9d902a6b08a0b74a873d60c125.html#a5a0aee9d902a6b08a0b74a873d60c125" title="Global flag to indicate that a task should be run on each installation request that reaches it...">INSTALL_TASK_RUN_IF_REACHED</a>,
<a name="l00533"></a>00533     ),
<a name="l00534"></a>00534     <span class="stringliteral">&#39;install_select_locale&#39;</span> =&gt; array(
<a name="l00535"></a>00535       <span class="stringliteral">&#39;display_name&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Choose language&#39;</span>),
<a name="l00536"></a>00536       <span class="stringliteral">&#39;run&#39;</span> =&gt; <a class="code" href="install_8core_8inc_a5a0aee9d902a6b08a0b74a873d60c125.html#a5a0aee9d902a6b08a0b74a873d60c125" title="Global flag to indicate that a task should be run on each installation request that reaches it...">INSTALL_TASK_RUN_IF_REACHED</a>,
<a name="l00537"></a>00537     ),
<a name="l00538"></a>00538     <span class="stringliteral">&#39;install_load_profile&#39;</span> =&gt; array(
<a name="l00539"></a>00539       <span class="stringliteral">&#39;run&#39;</span> =&gt; <a class="code" href="install_8core_8inc_a5a0aee9d902a6b08a0b74a873d60c125.html#a5a0aee9d902a6b08a0b74a873d60c125" title="Global flag to indicate that a task should be run on each installation request that reaches it...">INSTALL_TASK_RUN_IF_REACHED</a>,
<a name="l00540"></a>00540     ),
<a name="l00541"></a>00541     <span class="stringliteral">&#39;install_verify_requirements&#39;</span> =&gt; array(
<a name="l00542"></a>00542       <span class="stringliteral">&#39;display_name&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Verify requirements&#39;</span>),
<a name="l00543"></a>00543     ),
<a name="l00544"></a>00544     <span class="stringliteral">&#39;install_settings_form&#39;</span> =&gt; array(
<a name="l00545"></a>00545       <span class="stringliteral">&#39;display_name&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Set up database&#39;</span>),
<a name="l00546"></a>00546       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;form&#39;</span>,
<a name="l00547"></a>00547       <span class="stringliteral">&#39;run&#39;</span> =&gt; $install_state[<span class="stringliteral">&#39;settings_verified&#39;</span>] ? <a class="code" href="install_8core_8inc_a52d485a9e7b74dd6b159ee8569f44c1a.html#a52d485a9e7b74dd6b159ee8569f44c1a" title="Global flag to indicate that a task should not be run during the current installation request...">INSTALL_TASK_SKIP</a> : <a class="code" href="install_8core_8inc_a66ef8f31ae036a8f204f18b60b88954e.html#a66ef8f31ae036a8f204f18b60b88954e" title="Global flag to indicate that a task should be run on each installation request that reaches it...">INSTALL_TASK_RUN_IF_NOT_COMPLETED</a>,
<a name="l00548"></a>00548     ),
<a name="l00549"></a>00549     <span class="stringliteral">&#39;install_system_module&#39;</span> =&gt; array(
<a name="l00550"></a>00550     ),
<a name="l00551"></a>00551     <span class="stringliteral">&#39;install_bootstrap_full&#39;</span> =&gt; array(
<a name="l00552"></a>00552       <span class="stringliteral">&#39;run&#39;</span> =&gt; <a class="code" href="install_8core_8inc_a5a0aee9d902a6b08a0b74a873d60c125.html#a5a0aee9d902a6b08a0b74a873d60c125" title="Global flag to indicate that a task should be run on each installation request that reaches it...">INSTALL_TASK_RUN_IF_REACHED</a>,
<a name="l00553"></a>00553     ),
<a name="l00554"></a>00554     <span class="stringliteral">&#39;install_profile_modules&#39;</span> =&gt; array(
<a name="l00555"></a>00555       <span class="stringliteral">&#39;display_name&#39;</span> =&gt; count($install_state[<span class="stringliteral">&#39;profiles&#39;</span>]) == 1 ? <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Install site&#39;</span>) : <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Install profile&#39;</span>),
<a name="l00556"></a>00556       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;batch&#39;</span>,
<a name="l00557"></a>00557     ),
<a name="l00558"></a>00558     <span class="stringliteral">&#39;install_import_locales&#39;</span> =&gt; array(
<a name="l00559"></a>00559       <span class="stringliteral">&#39;display_name&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Set up translations&#39;</span>),
<a name="l00560"></a>00560       <span class="stringliteral">&#39;display&#39;</span> =&gt; $needs_translations,
<a name="l00561"></a>00561       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;batch&#39;</span>,
<a name="l00562"></a>00562       <span class="stringliteral">&#39;run&#39;</span> =&gt; $needs_translations ? INSTALL_TASK_RUN_IF_NOT_COMPLETED : <a class="code" href="install_8core_8inc_a52d485a9e7b74dd6b159ee8569f44c1a.html#a52d485a9e7b74dd6b159ee8569f44c1a" title="Global flag to indicate that a task should not be run during the current installation request...">INSTALL_TASK_SKIP</a>,
<a name="l00563"></a>00563     ),
<a name="l00564"></a>00564     <span class="stringliteral">&#39;install_configure_form&#39;</span> =&gt; array(
<a name="l00565"></a>00565       <span class="stringliteral">&#39;display_name&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Configure site&#39;</span>),
<a name="l00566"></a>00566       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;form&#39;</span>,
<a name="l00567"></a>00567     ),
<a name="l00568"></a>00568   );
<a name="l00569"></a>00569 
<a name="l00570"></a>00570   <span class="comment">// Now add any tasks defined by the installation profile.</span>
<a name="l00571"></a>00571   <span class="keywordflow">if</span> (!empty($install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>])) {
<a name="l00572"></a>00572     <span class="comment">// Load the profile install file, because it is not always loaded when</span>
<a name="l00573"></a>00573     <span class="comment">// hook_install_tasks() is invoked (e.g. batch processing).</span>
<a name="l00574"></a>00574     $profile_install_file = <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/profiles/&#39;</span> . $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>] . <span class="charliteral">&#39;/&#39;</span> . $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>] . <span class="stringliteral">&#39;.install&#39;</span>;
<a name="l00575"></a>00575     <span class="keywordflow">if</span> (file_exists($profile_install_file)) {
<a name="l00576"></a>00576       include_once $profile_install_file;
<a name="l00577"></a>00577     }
<a name="l00578"></a>00578     $function = $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>] . <span class="stringliteral">&#39;_install_tasks&#39;</span>;
<a name="l00579"></a>00579     <span class="keywordflow">if</span> (function_exists($function)) {
<a name="l00580"></a>00580       $result = $function($install_state);
<a name="l00581"></a>00581       <span class="keywordflow">if</span> (is_array($result)) {
<a name="l00582"></a>00582         $tasks += $result;
<a name="l00583"></a>00583       }
<a name="l00584"></a>00584     }
<a name="l00585"></a>00585   }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587   <span class="comment">// Finish by adding the remaining core tasks.</span>
<a name="l00588"></a>00588   $tasks += array(
<a name="l00589"></a>00589     <span class="stringliteral">&#39;install_import_locales_remaining&#39;</span> =&gt; array(
<a name="l00590"></a>00590       <span class="stringliteral">&#39;display_name&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Finish translations&#39;</span>),
<a name="l00591"></a>00591       <span class="stringliteral">&#39;display&#39;</span> =&gt; $needs_translations,
<a name="l00592"></a>00592       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;batch&#39;</span>,
<a name="l00593"></a>00593       <span class="stringliteral">&#39;run&#39;</span> =&gt; $needs_translations ? INSTALL_TASK_RUN_IF_NOT_COMPLETED : INSTALL_TASK_SKIP,
<a name="l00594"></a>00594     ),
<a name="l00595"></a>00595     <span class="stringliteral">&#39;install_finished&#39;</span> =&gt; array(
<a name="l00596"></a>00596       <span class="stringliteral">&#39;display_name&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Finished&#39;</span>),
<a name="l00597"></a>00597     ),
<a name="l00598"></a>00598   );
<a name="l00599"></a>00599 
<a name="l00600"></a>00600   <span class="comment">// Allow the installation profile to modify the full list of tasks.</span>
<a name="l00601"></a>00601   <span class="keywordflow">if</span> (!empty($install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>])) {
<a name="l00602"></a>00602     $profile_file = <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/profiles/&#39;</span> . $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>] . <span class="charliteral">&#39;/&#39;</span> . $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>] . <span class="stringliteral">&#39;.profile&#39;</span>;
<a name="l00603"></a>00603     <span class="keywordflow">if</span> (file_exists($profile_file)) {
<a name="l00604"></a>00604       include_once $profile_file;
<a name="l00605"></a>00605       $function = $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>] . <span class="stringliteral">&#39;_install_tasks_alter&#39;</span>;
<a name="l00606"></a>00606       <span class="keywordflow">if</span> (function_exists($function)) {
<a name="l00607"></a>00607         $function($tasks, $install_state);
<a name="l00608"></a>00608       }
<a name="l00609"></a>00609     }
<a name="l00610"></a>00610   }
<a name="l00611"></a>00611 
<a name="l00612"></a>00612   <span class="comment">// Fill in default parameters for each task before returning the list.</span>
<a name="l00613"></a>00613   <span class="keywordflow">foreach</span> ($tasks as $task_name =&gt; &amp;$task) {
<a name="l00614"></a>00614     $task += array(
<a name="l00615"></a>00615       <span class="stringliteral">&#39;display_name&#39;</span> =&gt; NULL,
<a name="l00616"></a>00616       <span class="stringliteral">&#39;display&#39;</span> =&gt; !empty($task[<span class="stringliteral">&#39;display_name&#39;</span>]),
<a name="l00617"></a>00617       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;normal&#39;</span>,
<a name="l00618"></a>00618       <span class="stringliteral">&#39;run&#39;</span> =&gt; INSTALL_TASK_RUN_IF_NOT_COMPLETED,
<a name="l00619"></a>00619       <span class="stringliteral">&#39;function&#39;</span> =&gt; $task_name,
<a name="l00620"></a>00620     );
<a name="l00621"></a>00621   }
<a name="l00622"></a>00622   <span class="keywordflow">return</span> $tasks;
<a name="l00623"></a>00623 }
<a name="l00624"></a>00624 
<a name="l00640"></a><a class="code" href="install_8core_8inc_ab265ac63af5ca0c96ab6278be25e6776.html#ab265ac63af5ca0c96ab6278be25e6776">00640</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_ab265ac63af5ca0c96ab6278be25e6776.html#ab265ac63af5ca0c96ab6278be25e6776" title="Returns a list of tasks that should be displayed to the end user.">install_tasks_to_display</a>($install_state) {
<a name="l00641"></a>00641   $displayed_tasks = array();
<a name="l00642"></a>00642   <span class="keywordflow">foreach</span> (<a class="code" href="install_8core_8inc_a243570ad640fab913f1c14cc750d3194.html#a243570ad640fab913f1c14cc750d3194" title="Returns a list of all tasks the installer currently knows about.">install_tasks</a>($install_state) as $name =&gt; $task) {
<a name="l00643"></a>00643     <span class="keywordflow">if</span> ($task[<span class="stringliteral">&#39;display&#39;</span>]) {
<a name="l00644"></a>00644       $displayed_tasks[$name] = $task[<span class="stringliteral">&#39;display_name&#39;</span>];
<a name="l00645"></a>00645     }
<a name="l00646"></a>00646   }
<a name="l00647"></a>00647   <span class="keywordflow">return</span> $displayed_tasks;
<a name="l00648"></a>00648 }
<a name="l00649"></a>00649 
<a name="l00663"></a><a class="code" href="install_8core_8inc_a6653d055f5af1ec01fa9769b41f747b5.html#a6653d055f5af1ec01fa9769b41f747b5">00663</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a6653d055f5af1ec01fa9769b41f747b5.html#a6653d055f5af1ec01fa9769b41f747b5" title="Returns the URL that should be redirected to during an installation request.">install_redirect_url</a>($install_state) {
<a name="l00664"></a>00664   <span class="keywordflow">return</span> <span class="stringliteral">&#39;install.php?&#39;</span> . <a class="code" href="group__php__wrappers_gada763092b76d70856870eb3afa2ad265.html#gada763092b76d70856870eb3afa2ad265" title="Parses an array into a valid, rawurlencoded query string.">drupal_http_build_query</a>($install_state[<span class="stringliteral">&#39;parameters&#39;</span>]);
<a name="l00665"></a>00665 }
<a name="l00666"></a>00666 
<a name="l00678"></a><a class="code" href="install_8core_8inc_a562ee3011859e71bb87c068340ce6dc6.html#a562ee3011859e71bb87c068340ce6dc6">00678</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a562ee3011859e71bb87c068340ce6dc6.html#a562ee3011859e71bb87c068340ce6dc6" title="Returns the complete URL redirected to during an installation request.">install_full_redirect_url</a>($install_state) {
<a name="l00679"></a>00679   global $base_url;
<a name="l00680"></a>00680   <span class="keywordflow">return</span> $base_url . <span class="charliteral">&#39;/&#39;</span> . <a class="code" href="install_8core_8inc_a6653d055f5af1ec01fa9769b41f747b5.html#a6653d055f5af1ec01fa9769b41f747b5" title="Returns the URL that should be redirected to during an installation request.">install_redirect_url</a>($install_state);
<a name="l00681"></a>00681 }
<a name="l00682"></a>00682 
<a name="l00695"></a><a class="code" href="install_8core_8inc_aadf48482ac0487e79f48b346dc550806.html#aadf48482ac0487e79f48b346dc550806">00695</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_aadf48482ac0487e79f48b346dc550806.html#aadf48482ac0487e79f48b346dc550806" title="Displays themed installer output and ends the page request.">install_display_output</a>(<a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>, $install_state) {
<a name="l00696"></a>00696   <a class="code" href="bootstrap_8inc_a05f3dc0377da7898b9cb53977c30cca6.html#a05f3dc0377da7898b9cb53977c30cca6" title="Sets HTTP headers in preparation for a page response.">drupal_page_header</a>();
<a name="l00697"></a>00697   <span class="comment">// Only show the task list if there is an active task; otherwise, the page</span>
<a name="l00698"></a>00698   <span class="comment">// request has ended before tasks have even been started, so there is nothing</span>
<a name="l00699"></a>00699   <span class="comment">// meaningful to show.</span>
<a name="l00700"></a>00700   <span class="keywordflow">if</span> (isset($install_state[<span class="stringliteral">&#39;active_task&#39;</span>])) {
<a name="l00701"></a>00701     <span class="comment">// Let the theming function know when every step of the installation has</span>
<a name="l00702"></a>00702     <span class="comment">// been completed.</span>
<a name="l00703"></a>00703     $active_task = $install_state[<span class="stringliteral">&#39;installation_finished&#39;</span>] ? NULL : $install_state[<span class="stringliteral">&#39;active_task&#39;</span>];
<a name="l00704"></a>00704     <a class="code" href="common_8inc_a868829276154d107ebf8a692a6ff7efa.html#a868829276154d107ebf8a692a6ff7efa" title="Adds content to a specified region.">drupal_add_region_content</a>(<span class="stringliteral">&#39;sidebar_first&#39;</span>, <a class="code" href="theme_8inc_a7c25609a935874541a19657affd30fff.html#a7c25609a935874541a19657affd30fff" title="Generates themed output.">theme</a>(<span class="stringliteral">&#39;task_list&#39;</span>, array(<span class="stringliteral">&#39;items&#39;</span> =&gt; <a class="code" href="install_8core_8inc_ab265ac63af5ca0c96ab6278be25e6776.html#ab265ac63af5ca0c96ab6278be25e6776" title="Returns a list of tasks that should be displayed to the end user.">install_tasks_to_display</a>($install_state), <span class="stringliteral">&#39;active&#39;</span> =&gt; $active_task)));
<a name="l00705"></a>00705   }
<a name="l00706"></a>00706   print <a class="code" href="theme_8inc_a7c25609a935874541a19657affd30fff.html#a7c25609a935874541a19657affd30fff" title="Generates themed output.">theme</a>(<span class="stringliteral">&#39;install_page&#39;</span>, array(<span class="stringliteral">&#39;content&#39;</span> =&gt; <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>));
<a name="l00707"></a>00707   exit;
<a name="l00708"></a>00708 }
<a name="l00709"></a>00709 
<a name="l00723"></a><a class="code" href="install_8core_8inc_a6cd2658e0f95bd0d5ce8942aa5884124.html#a6cd2658e0f95bd0d5ce8942aa5884124">00723</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a6cd2658e0f95bd0d5ce8942aa5884124.html#a6cd2658e0f95bd0d5ce8942aa5884124" title="Installation task; verify the requirements for installing Drupal.">install_verify_requirements</a>(&amp;$install_state) {
<a name="l00724"></a>00724   <span class="comment">// Check the installation requirements for Drupal and this profile.</span>
<a name="l00725"></a>00725   $requirements = <a class="code" href="install_8core_8inc_ae9175b59627ec291ef76fd241f74f33e.html#ae9175b59627ec291ef76fd241f74f33e" title="Checks installation requirements and reports any errors.">install_check_requirements</a>($install_state);
<a name="l00726"></a>00726 
<a name="l00727"></a>00727   <span class="comment">// Verify existence of all required modules.</span>
<a name="l00728"></a>00728   $requirements += <a class="code" href="install_8inc_aa29b37a58b07628a4fd9714c2f9817ab.html#aa29b37a58b07628a4fd9714c2f9817ab" title="Verify an install profile for installation.">drupal_verify_profile</a>($install_state);
<a name="l00729"></a>00729 
<a name="l00730"></a>00730   <span class="comment">// Check the severity of the requirements reported.</span>
<a name="l00731"></a>00731   $severity = <a class="code" href="install_8inc_aa9ea0f7df004333efbdd03025f5a9c94.html#aa9ea0f7df004333efbdd03025f5a9c94" title="Extract highest severity from requirements array.">drupal_requirements_severity</a>($requirements);
<a name="l00732"></a>00732 
<a name="l00733"></a>00733   <span class="comment">// If there are errors, always display them. If there are only warnings, skip</span>
<a name="l00734"></a>00734   <span class="comment">// them if the user has provided a URL parameter acknowledging the warnings</span>
<a name="l00735"></a>00735   <span class="comment">// and indicating a desire to continue anyway. See drupal_requirements_url().</span>
<a name="l00736"></a>00736   <span class="keywordflow">if</span> ($severity == <a class="code" href="install_8inc_aeddf02286107904721cb582bd430581d.html#aeddf02286107904721cb582bd430581d" title="Requirement severity -- Error condition; abort installation.">REQUIREMENT_ERROR</a> || ($severity == <a class="code" href="install_8inc_a2879fcef075548b2dceeeaa9571dcf8d.html#a2879fcef075548b2dceeeaa9571dcf8d" title="Requirement severity -- Warning condition; proceed but flag warning.">REQUIREMENT_WARNING</a> &amp;&amp; empty($install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;continue&#39;</span>]))) {
<a name="l00737"></a>00737     <span class="keywordflow">if</span> ($install_state[<span class="stringliteral">&#39;interactive&#39;</span>]) {
<a name="l00738"></a>00738       <a class="code" href="bootstrap_8inc_a1994d49eb621df71fe1306e13b7e4910.html#a1994d49eb621df71fe1306e13b7e4910" title="Sets the title of the current page.">drupal_set_title</a>(<a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Requirements problem&#39;</span>));
<a name="l00739"></a>00739       $status_report = <a class="code" href="theme_8inc_a7c25609a935874541a19657affd30fff.html#a7c25609a935874541a19657affd30fff" title="Generates themed output.">theme</a>(<span class="stringliteral">&#39;status_report&#39;</span>, array(<span class="stringliteral">&#39;requirements&#39;</span> =&gt; $requirements));
<a name="l00740"></a>00740       $status_report .= <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Check the error messages and &lt;a href=&quot;!url&quot;&gt;proceed with the installation&lt;/a&gt;.&#39;</span>, array(<span class="stringliteral">&#39;!url&#39;</span> =&gt; <a class="code" href="group__sanitization_gac024315b69035ef05c33674838707919.html#gac024315b69035ef05c33674838707919" title="Strips dangerous protocols from a URI and encodes it for output to HTML.">check_url</a>(<a class="code" href="install_8inc_aa26d690c87ca7a7a2aedd9cd4679274a.html#aa26d690c87ca7a7a2aedd9cd4679274a" title="Returns a URL for proceeding to the next page after a requirements problem.">drupal_requirements_url</a>($severity))));
<a name="l00741"></a>00741       <span class="keywordflow">return</span> $status_report;
<a name="l00742"></a>00742     }
<a name="l00743"></a>00743     <span class="keywordflow">else</span> {
<a name="l00744"></a>00744       <span class="comment">// Throw an exception showing any unmet requirements.</span>
<a name="l00745"></a>00745       $failures = array();
<a name="l00746"></a>00746       <span class="keywordflow">foreach</span> ($requirements as $requirement) {
<a name="l00747"></a>00747         <span class="comment">// Skip warnings altogether for non-interactive installations; these</span>
<a name="l00748"></a>00748         <span class="comment">// proceed in a single request so there is no good opportunity (and no</span>
<a name="l00749"></a>00749         <span class="comment">// good method) to warn the user anyway.</span>
<a name="l00750"></a>00750         <span class="keywordflow">if</span> (isset($requirement[<span class="stringliteral">&#39;severity&#39;</span>]) &amp;&amp; $requirement[<span class="stringliteral">&#39;severity&#39;</span>] == <a class="code" href="install_8inc_aeddf02286107904721cb582bd430581d.html#aeddf02286107904721cb582bd430581d" title="Requirement severity -- Error condition; abort installation.">REQUIREMENT_ERROR</a>) {
<a name="l00751"></a>00751           $failures[] = $requirement[<span class="stringliteral">&#39;title&#39;</span>] . <span class="stringliteral">&#39;: &#39;</span> . $requirement[<span class="stringliteral">&#39;value&#39;</span>] . <span class="stringliteral">&quot;\n\n&quot;</span> . $requirement[<span class="stringliteral">&#39;description&#39;</span>];
<a name="l00752"></a>00752         }
<a name="l00753"></a>00753       }
<a name="l00754"></a>00754       <span class="keywordflow">if</span> (!empty($failures)) {
<a name="l00755"></a>00755         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a>(implode(<span class="stringliteral">&quot;\n\n&quot;</span>, $failures));
<a name="l00756"></a>00756       }
<a name="l00757"></a>00757     }
<a name="l00758"></a>00758   }
<a name="l00759"></a>00759 }
<a name="l00760"></a>00760 
<a name="l00767"></a><a class="code" href="install_8core_8inc_a8aa087a6aedfb74d1ad361f2269dbd06.html#a8aa087a6aedfb74d1ad361f2269dbd06">00767</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a8aa087a6aedfb74d1ad361f2269dbd06.html#a8aa087a6aedfb74d1ad361f2269dbd06" title="Installation task; install the Drupal system module.">install_system_module</a>(&amp;$install_state) {
<a name="l00768"></a>00768   <span class="comment">// Install system.module.</span>
<a name="l00769"></a>00769   <a class="code" href="install_8inc_aab1545a3102caedc018c7d571d6ebf1b.html#aab1545a3102caedc018c7d571d6ebf1b" title="Callback to install the system module.">drupal_install_system</a>();
<a name="l00770"></a>00770 
<a name="l00771"></a>00771   <span class="comment">// Enable the user module so that sessions can be recorded during the</span>
<a name="l00772"></a>00772   <span class="comment">// upcoming bootstrap step.</span>
<a name="l00773"></a>00773   <a class="code" href="module_8inc_a4b2c9ea60d7c88595eaebfc4abd5f1bf.html#a4b2c9ea60d7c88595eaebfc4abd5f1bf" title="Enables or installs a given list of modules.">module_enable</a>(array(<span class="stringliteral">&#39;user&#39;</span>), FALSE);
<a name="l00774"></a>00774 
<a name="l00775"></a>00775   <span class="comment">// Save the list of other modules to install for the upcoming tasks.</span>
<a name="l00776"></a>00776   <span class="comment">// variable_set() can be used now that system.module is installed.</span>
<a name="l00777"></a>00777   $modules = $install_state[<span class="stringliteral">&#39;profile_info&#39;</span>][<span class="stringliteral">&#39;dependencies&#39;</span>];
<a name="l00778"></a>00778 
<a name="l00779"></a>00779   <span class="comment">// The install profile is also a module, which needs to be installed</span>
<a name="l00780"></a>00780   <span class="comment">// after all the dependencies have been installed.</span>
<a name="l00781"></a>00781   $modules[] = <a class="code" href="common_8inc_a4128f0023ccec2d1a9a40987f0131d83.html#a4128f0023ccec2d1a9a40987f0131d83" title="Gets the name of the currently active install profile.">drupal_get_profile</a>();
<a name="l00782"></a>00782 
<a name="l00783"></a>00783   <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;install_profile_modules&#39;</span>, array_diff($modules, array(<span class="stringliteral">&#39;system&#39;</span>)));
<a name="l00784"></a>00784   $install_state[<span class="stringliteral">&#39;database_tables_exist&#39;</span>] = TRUE;
<a name="l00785"></a>00785 }
<a name="l00786"></a>00786 
<a name="l00794"></a><a class="code" href="install_8core_8inc_a0c550ddc08ed7884ffdfc444c85d4a3a.html#a0c550ddc08ed7884ffdfc444c85d4a3a">00794</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a0c550ddc08ed7884ffdfc444c85d4a3a.html#a0c550ddc08ed7884ffdfc444c85d4a3a" title="Verify and return the last installation task that was completed.">install_verify_completed_task</a>() {
<a name="l00795"></a>00795   <span class="keywordflow">try</span> {
<a name="l00796"></a>00796     <span class="keywordflow">if</span> ($result = <a class="code" href="group__database_gafa3b6cb2b2f61479cc63a4150c62da9b.html#gafa3b6cb2b2f61479cc63a4150c62da9b" title="The following utility functions are simply convenience wrappers.">db_query</a>(<span class="stringliteral">&quot;SELECT value FROM {variable} WHERE name = :name&quot;</span>, array(<span class="stringliteral">&#39;name&#39;</span> =&gt; <span class="stringliteral">&#39;install_task&#39;</span>))) {
<a name="l00797"></a>00797       $task = unserialize($result-&gt;fetchField());
<a name="l00798"></a>00798     }
<a name="l00799"></a>00799   }
<a name="l00800"></a>00800   <span class="comment">// Do not trigger an error if the database query fails, since the database</span>
<a name="l00801"></a>00801   <span class="comment">// might not be set up yet.</span>
<a name="l00802"></a>00802   <span class="keywordflow">catch</span> (<a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a> $e) {
<a name="l00803"></a>00803   }
<a name="l00804"></a>00804   <span class="keywordflow">if</span> (isset($task)) {
<a name="l00805"></a>00805     <span class="keywordflow">if</span> ($task == <span class="stringliteral">&#39;done&#39;</span>) {
<a name="l00806"></a>00806       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a>(<a class="code" href="install_8core_8inc_a6469cc717a3ac52eece0537630addea4.html#a6469cc717a3ac52eece0537630addea4" title="Indicates that Drupal has already been installed.">install_already_done_error</a>());
<a name="l00807"></a>00807     }
<a name="l00808"></a>00808     <span class="keywordflow">return</span> $task;
<a name="l00809"></a>00809   }
<a name="l00810"></a>00810 }
<a name="l00811"></a>00811 
<a name="l00815"></a><a class="code" href="install_8core_8inc_ab9be391a3ce3d42b0a75b2abe95b5232.html#ab9be391a3ce3d42b0a75b2abe95b5232">00815</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_ab9be391a3ce3d42b0a75b2abe95b5232.html#ab9be391a3ce3d42b0a75b2abe95b5232" title="Verifies the existing settings in settings.php.">install_verify_settings</a>() {
<a name="l00816"></a>00816   global <a class="code" href="default_8settings_8php_a97cde67402a68697692531e8b067f86f.html#a97cde67402a68697692531e8b067f86f" title="Database settings:">$databases</a>;
<a name="l00817"></a>00817 
<a name="l00818"></a>00818   <span class="comment">// Verify existing settings (if any).</span>
<a name="l00819"></a>00819   <span class="keywordflow">if</span> (!empty($databases) &amp;&amp; <a class="code" href="install_8core_8inc_a05cc52656e3a172f087a5043eb00087a.html#a05cc52656e3a172f087a5043eb00087a" title="Verify PDO library.">install_verify_pdo</a>()) {
<a name="l00820"></a>00820     $database = $databases[<span class="stringliteral">&#39;default&#39;</span>][<span class="stringliteral">&#39;default&#39;</span>];
<a name="l00821"></a>00821     <a class="code" href="group__schemaapi_ga714b5ed0b14c43b61eef0c895598c5c4.html#ga714b5ed0b14c43b61eef0c895598c5c4" title="Resets one or all centrally stored static variable(s).">drupal_static_reset</a>(<span class="stringliteral">&#39;conf_path&#39;</span>);
<a name="l00822"></a>00822     $settings_file = <span class="stringliteral">&#39;./&#39;</span> . <a class="code" href="bootstrap_8inc_acef612ef19c49f6259531f0bee5c26cc.html#acef612ef19c49f6259531f0bee5c26cc" title="Finds the appropriate configuration directory.">conf_path</a>(FALSE) . <span class="stringliteral">&#39;/settings.php&#39;</span>;
<a name="l00823"></a>00823     $errors = <a class="code" href="install_8core_8inc_a695213046db5d896caef10f82da54b87.html#a695213046db5d896caef10f82da54b87" title="Checks a database connection and returns any errors.">install_database_errors</a>($database, $settings_file);
<a name="l00824"></a>00824     <span class="keywordflow">if</span> (empty($errors)) {
<a name="l00825"></a>00825       <span class="keywordflow">return</span> TRUE;
<a name="l00826"></a>00826     }
<a name="l00827"></a>00827   }
<a name="l00828"></a>00828   <span class="keywordflow">return</span> FALSE;
<a name="l00829"></a>00829 }
<a name="l00830"></a>00830 
<a name="l00834"></a><a class="code" href="install_8core_8inc_a05cc52656e3a172f087a5043eb00087a.html#a05cc52656e3a172f087a5043eb00087a">00834</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a05cc52656e3a172f087a5043eb00087a.html#a05cc52656e3a172f087a5043eb00087a" title="Verify PDO library.">install_verify_pdo</a>() {
<a name="l00835"></a>00835   <span class="comment">// PDO was moved to PHP core in 5.2.0, but the old extension (targeting 5.0</span>
<a name="l00836"></a>00836   <span class="comment">// and 5.1) is still available from PECL, and can still be built without</span>
<a name="l00837"></a>00837   <span class="comment">// errors. To verify that the correct version is in use, we check the</span>
<a name="l00838"></a>00838   <span class="comment">// PDO::ATTR_DEFAULT_FETCH_MODE constant, which is not available in the</span>
<a name="l00839"></a>00839   <span class="comment">// PECL extension.</span>
<a name="l00840"></a>00840   <span class="keywordflow">return</span> extension_loaded(<span class="stringliteral">&#39;pdo&#39;</span>) &amp;&amp; defined(<span class="stringliteral">&#39;PDO::ATTR_DEFAULT_FETCH_MODE&#39;</span>);
<a name="l00841"></a>00841 }
<a name="l00842"></a>00842 
<a name="l00854"></a><a class="code" href="install_8core_8inc_a4fe8554aa15e5b0b78a15400c2d37d28.html#a4fe8554aa15e5b0b78a15400c2d37d28">00854</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a4fe8554aa15e5b0b78a15400c2d37d28.html#a4fe8554aa15e5b0b78a15400c2d37d28" title="Installation task; define a form to configure and rewrite settings.php.">install_settings_form</a>($form, &amp;$form_state, &amp;$install_state) {
<a name="l00855"></a>00855   global <a class="code" href="default_8settings_8php_a97cde67402a68697692531e8b067f86f.html#a97cde67402a68697692531e8b067f86f" title="Database settings:">$databases</a>;
<a name="l00856"></a>00856   $profile = $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>];
<a name="l00857"></a>00857   $install_locale = $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;locale&#39;</span>];
<a name="l00858"></a>00858 
<a name="l00859"></a>00859   <a class="code" href="group__schemaapi_ga714b5ed0b14c43b61eef0c895598c5c4.html#ga714b5ed0b14c43b61eef0c895598c5c4" title="Resets one or all centrally stored static variable(s).">drupal_static_reset</a>(<span class="stringliteral">&#39;conf_path&#39;</span>);
<a name="l00860"></a>00860   $conf_path = <span class="stringliteral">&#39;./&#39;</span> . <a class="code" href="bootstrap_8inc_acef612ef19c49f6259531f0bee5c26cc.html#acef612ef19c49f6259531f0bee5c26cc" title="Finds the appropriate configuration directory.">conf_path</a>(FALSE);
<a name="l00861"></a>00861   $settings_file = $conf_path . <span class="stringliteral">&#39;/settings.php&#39;</span>;
<a name="l00862"></a>00862   $database = isset($databases[<span class="stringliteral">&#39;default&#39;</span>][<span class="stringliteral">&#39;default&#39;</span>]) ? $databases[<span class="stringliteral">&#39;default&#39;</span>][<span class="stringliteral">&#39;default&#39;</span>] : array();
<a name="l00863"></a>00863 
<a name="l00864"></a>00864   <a class="code" href="bootstrap_8inc_a1994d49eb621df71fe1306e13b7e4910.html#a1994d49eb621df71fe1306e13b7e4910" title="Sets the title of the current page.">drupal_set_title</a>(<a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Database configuration&#39;</span>));
<a name="l00865"></a>00865 
<a name="l00866"></a>00866   $drivers = <a class="code" href="install_8inc_acc31c9690e30c375bba969c4e5584c71.html#acc31c9690e30c375bba969c4e5584c71" title="Return all supported database installer objects that are compiled into PHP.">drupal_get_database_types</a>();
<a name="l00867"></a>00867   $drivers_keys = array_keys($drivers);
<a name="l00868"></a>00868 
<a name="l00869"></a>00869   $form[<span class="stringliteral">&#39;driver&#39;</span>] = array(
<a name="l00870"></a>00870     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;radios&#39;</span>,
<a name="l00871"></a>00871     <span class="stringliteral">&#39;#title&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Database type&#39;</span>),
<a name="l00872"></a>00872     <span class="stringliteral">&#39;#required&#39;</span> =&gt; TRUE,
<a name="l00873"></a>00873     <span class="stringliteral">&#39;#default_value&#39;</span> =&gt; !empty($database[<span class="stringliteral">&#39;driver&#39;</span>]) ? $database[<span class="stringliteral">&#39;driver&#39;</span>] : current($drivers_keys),
<a name="l00874"></a>00874     <span class="stringliteral">&#39;#description&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;The type of database your @drupal data will be stored in.&#39;</span>, array(<span class="stringliteral">&#39;@drupal&#39;</span> =&gt; <a class="code" href="install_8inc_a52c56958ff42269107b5a678e8d95ddc.html#a52c56958ff42269107b5a678e8d95ddc" title="Loads the install profile, extracting its defined distribution name.">drupal_install_profile_distribution_name</a>())),
<a name="l00875"></a>00875   );
<a name="l00876"></a>00876   <span class="keywordflow">if</span> (count($drivers) == 1) {
<a name="l00877"></a>00877     $form[<span class="stringliteral">&#39;driver&#39;</span>][<span class="stringliteral">&#39;#disabled&#39;</span>] = TRUE;
<a name="l00878"></a>00878     $form[<span class="stringliteral">&#39;driver&#39;</span>][<span class="stringliteral">&#39;#description&#39;</span>] .= <span class="charliteral">&#39; &#39;</span> . <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Your PHP configuration only supports a single database type, so it has been automatically selected.&#39;</span>);
<a name="l00879"></a>00879   }
<a name="l00880"></a>00880 
<a name="l00881"></a>00881   <span class="comment">// Add driver specific configuration options.</span>
<a name="l00882"></a>00882   <span class="keywordflow">foreach</span> ($drivers as $key =&gt; $driver) {
<a name="l00883"></a>00883     $form[<span class="stringliteral">&#39;driver&#39;</span>][<span class="stringliteral">&#39;#options&#39;</span>][$key] = $driver-&gt;name();
<a name="l00884"></a>00884 
<a name="l00885"></a>00885     $form[<span class="stringliteral">&#39;settings&#39;</span>][$key] = $driver-&gt;getFormOptions($database);
<a name="l00886"></a>00886     $form[<span class="stringliteral">&#39;settings&#39;</span>][$key][<span class="stringliteral">&#39;#prefix&#39;</span>] = <span class="stringliteral">&#39;&lt;h2 class=&quot;js-hide&quot;&gt;&#39;</span> . <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;@driver_name settings&#39;</span>, array(<span class="stringliteral">&#39;@driver_name&#39;</span> =&gt; $driver-&gt;name())) . <span class="stringliteral">&#39;&lt;/h2&gt;&#39;</span>;
<a name="l00887"></a>00887     $form[<span class="stringliteral">&#39;settings&#39;</span>][$key][<span class="stringliteral">&#39;#type&#39;</span>] = <span class="stringliteral">&#39;container&#39;</span>;
<a name="l00888"></a>00888     $form[<span class="stringliteral">&#39;settings&#39;</span>][$key][<span class="stringliteral">&#39;#tree&#39;</span>] = TRUE;
<a name="l00889"></a>00889     $form[<span class="stringliteral">&#39;settings&#39;</span>][$key][<span class="stringliteral">&#39;advanced_options&#39;</span>][<span class="stringliteral">&#39;#parents&#39;</span>] = array($key);
<a name="l00890"></a>00890     $form[<span class="stringliteral">&#39;settings&#39;</span>][$key][<span class="stringliteral">&#39;#states&#39;</span>] = array(
<a name="l00891"></a>00891       <span class="stringliteral">&#39;visible&#39;</span> =&gt; array(
<a name="l00892"></a>00892         <span class="stringliteral">&#39;:input[name=driver]&#39;</span> =&gt; array(<span class="stringliteral">&#39;value&#39;</span> =&gt; $key),
<a name="l00893"></a>00893       )
<a name="l00894"></a>00894     );
<a name="l00895"></a>00895   }
<a name="l00896"></a>00896 
<a name="l00897"></a>00897   $form[<span class="stringliteral">&#39;actions&#39;</span>] = array(<span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;actions&#39;</span>);
<a name="l00898"></a>00898   $form[<span class="stringliteral">&#39;actions&#39;</span>][<span class="stringliteral">&#39;save&#39;</span>] = array(
<a name="l00899"></a>00899     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;submit&#39;</span>,
<a name="l00900"></a>00900     <span class="stringliteral">&#39;#value&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Save and continue&#39;</span>),
<a name="l00901"></a>00901     <span class="stringliteral">&#39;#limit_validation_errors&#39;</span> =&gt; array(
<a name="l00902"></a>00902       array(<span class="stringliteral">&#39;driver&#39;</span>),
<a name="l00903"></a>00903       array(isset($form_state[<span class="stringliteral">&#39;input&#39;</span>][<span class="stringliteral">&#39;driver&#39;</span>]) ? $form_state[<span class="stringliteral">&#39;input&#39;</span>][<span class="stringliteral">&#39;driver&#39;</span>] : current($drivers_keys)),
<a name="l00904"></a>00904     ),
<a name="l00905"></a>00905     <span class="stringliteral">&#39;#submit&#39;</span> =&gt; array(<span class="stringliteral">&#39;install_settings_form_submit&#39;</span>),
<a name="l00906"></a>00906   );
<a name="l00907"></a>00907 
<a name="l00908"></a>00908   $form[<span class="stringliteral">&#39;errors&#39;</span>] = array();
<a name="l00909"></a>00909   $form[<span class="stringliteral">&#39;settings_file&#39;</span>] = array(<span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;value&#39;</span>, <span class="stringliteral">&#39;#value&#39;</span> =&gt; $settings_file);
<a name="l00910"></a>00910 
<a name="l00911"></a>00911   <span class="keywordflow">return</span> $form;
<a name="l00912"></a>00912 }
<a name="l00913"></a>00913 
<a name="l00917"></a><a class="code" href="install_8core_8inc_a81a30e13b22aa1ad8b0fa4b8f2f07c82.html#a81a30e13b22aa1ad8b0fa4b8f2f07c82">00917</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a81a30e13b22aa1ad8b0fa4b8f2f07c82.html#a81a30e13b22aa1ad8b0fa4b8f2f07c82" title="Form API validate for install_settings form.">install_settings_form_validate</a>($form, &amp;$form_state) {
<a name="l00918"></a>00918   $driver = $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;driver&#39;</span>];
<a name="l00919"></a>00919   $database = $form_state[<span class="stringliteral">&#39;values&#39;</span>][$driver];
<a name="l00920"></a>00920   $database[<span class="stringliteral">&#39;driver&#39;</span>] = $driver;
<a name="l00921"></a>00921 
<a name="l00922"></a>00922   <span class="comment">// TODO: remove when PIFR will be updated to use &#39;db_prefix&#39; instead of</span>
<a name="l00923"></a>00923   <span class="comment">// &#39;prefix&#39; in the database settings form.</span>
<a name="l00924"></a>00924   $database[<span class="stringliteral">&#39;prefix&#39;</span>] = $database[<span class="stringliteral">&#39;db_prefix&#39;</span>];
<a name="l00925"></a>00925   unset($database[<span class="stringliteral">&#39;db_prefix&#39;</span>]);
<a name="l00926"></a>00926 
<a name="l00927"></a>00927   $form_state[<span class="stringliteral">&#39;storage&#39;</span>][<span class="stringliteral">&#39;database&#39;</span>] = $database;
<a name="l00928"></a>00928   $errors = <a class="code" href="install_8core_8inc_a695213046db5d896caef10f82da54b87.html#a695213046db5d896caef10f82da54b87" title="Checks a database connection and returns any errors.">install_database_errors</a>($database, $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;settings_file&#39;</span>]);
<a name="l00929"></a>00929   <span class="keywordflow">foreach</span> ($errors as $name =&gt; $message) {
<a name="l00930"></a>00930     <a class="code" href="group__form__api_ga6f4ecbec42e905390e521b393417f97f.html#ga6f4ecbec42e905390e521b393417f97f" title="Files an error against a form element.">form_set_error</a>($name, $message);
<a name="l00931"></a>00931   }
<a name="l00932"></a>00932 }
<a name="l00933"></a>00933 
<a name="l00937"></a><a class="code" href="install_8core_8inc_a695213046db5d896caef10f82da54b87.html#a695213046db5d896caef10f82da54b87">00937</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a695213046db5d896caef10f82da54b87.html#a695213046db5d896caef10f82da54b87" title="Checks a database connection and returns any errors.">install_database_errors</a>($database, $settings_file) {
<a name="l00938"></a>00938   global <a class="code" href="default_8settings_8php_a97cde67402a68697692531e8b067f86f.html#a97cde67402a68697692531e8b067f86f" title="Database settings:">$databases</a>;
<a name="l00939"></a>00939   $errors = array();
<a name="l00940"></a>00940 
<a name="l00941"></a>00941   <span class="comment">// Check database type.</span>
<a name="l00942"></a>00942   $database_types = <a class="code" href="install_8inc_acc31c9690e30c375bba969c4e5584c71.html#acc31c9690e30c375bba969c4e5584c71" title="Return all supported database installer objects that are compiled into PHP.">drupal_get_database_types</a>();
<a name="l00943"></a>00943   $driver = $database[<span class="stringliteral">&#39;driver&#39;</span>];
<a name="l00944"></a>00944   <span class="keywordflow">if</span> (!isset($database_types[$driver])) {
<a name="l00945"></a>00945     $errors[<span class="stringliteral">&#39;driver&#39;</span>] = <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&quot;In your %settings_file file you have configured @drupal to use a %driver server, however your PHP installation currently does not support this database type.&quot;</span>, array(<span class="stringliteral">&#39;%settings_file&#39;</span> =&gt; $settings_file, <span class="stringliteral">&#39;@drupal&#39;</span> =&gt; <a class="code" href="install_8inc_a52c56958ff42269107b5a678e8d95ddc.html#a52c56958ff42269107b5a678e8d95ddc" title="Loads the install profile, extracting its defined distribution name.">drupal_install_profile_distribution_name</a>(), <span class="stringliteral">&#39;%driver&#39;</span> =&gt; $driver));
<a name="l00946"></a>00946   }
<a name="l00947"></a>00947   <span class="keywordflow">else</span> {
<a name="l00948"></a>00948     <span class="comment">// Run driver specific validation</span>
<a name="l00949"></a>00949     $errors += $database_types[$driver]-&gt;validateDatabaseSettings($database);
<a name="l00950"></a>00950 
<a name="l00951"></a>00951     <span class="comment">// Run tasks associated with the database type. Any errors are caught in the</span>
<a name="l00952"></a>00952     <span class="comment">// calling function.</span>
<a name="l00953"></a>00953     $databases[<span class="stringliteral">&#39;default&#39;</span>][<span class="stringliteral">&#39;default&#39;</span>] = $database;
<a name="l00954"></a>00954     <span class="comment">// Just changing the global doesn&#39;t get the new information processed.</span>
<a name="l00955"></a>00955     <span class="comment">// We tell tell the Database class to re-parse $databases.</span>
<a name="l00956"></a>00956     <a class="code" href="classDatabase_a65d7ffd8cc0b81ead0e2a6ca0836343c.html#a65d7ffd8cc0b81ead0e2a6ca0836343c" title="Process the configuration file for database information.">Database::parseConnectionInfo</a>();
<a name="l00957"></a>00957 
<a name="l00958"></a>00958     <span class="keywordflow">try</span> {
<a name="l00959"></a>00959       <a class="code" href="install_8inc_a57bfe6a3b39d6f931fe965a93e7eec83.html#a57bfe6a3b39d6f931fe965a93e7eec83" title="Ensures the environment for a Drupal database on a predefined connection.">db_run_tasks</a>($driver);
<a name="l00960"></a>00960     }
<a name="l00961"></a>00961     <span class="keywordflow">catch</span> (<a class="code" href="classDatabaseTaskException.html" title="Exception thrown if the database installer fails.">DatabaseTaskException</a> $e) {
<a name="l00962"></a>00962       <span class="comment">// These are generic errors, so we do not have any specific key of the</span>
<a name="l00963"></a>00963       <span class="comment">// database connection array to attach them to; therefore, we just put</span>
<a name="l00964"></a>00964       <span class="comment">// them in the error array with standard numeric keys.</span>
<a name="l00965"></a>00965       $errors[$driver . <span class="stringliteral">&#39;][0&#39;</span>] = $e-&gt;getMessage();
<a name="l00966"></a>00966     }
<a name="l00967"></a>00967   }
<a name="l00968"></a>00968   <span class="keywordflow">return</span> $errors;
<a name="l00969"></a>00969 }
<a name="l00970"></a>00970 
<a name="l00974"></a><a class="code" href="install_8core_8inc_abe061599cf0c6252388fc93366ebae27.html#abe061599cf0c6252388fc93366ebae27">00974</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_abe061599cf0c6252388fc93366ebae27.html#abe061599cf0c6252388fc93366ebae27" title="Form API submit for install_settings form.">install_settings_form_submit</a>($form, &amp;$form_state) {
<a name="l00975"></a>00975   global $install_state;
<a name="l00976"></a>00976 
<a name="l00977"></a>00977   <span class="comment">// Update global settings array and save.</span>
<a name="l00978"></a>00978   $settings[<span class="stringliteral">&#39;databases&#39;</span>] = array(
<a name="l00979"></a>00979     <span class="stringliteral">&#39;value&#39;</span>    =&gt; array(<span class="stringliteral">&#39;default&#39;</span> =&gt; array(<span class="stringliteral">&#39;default&#39;</span> =&gt; $form_state[<span class="stringliteral">&#39;storage&#39;</span>][<span class="stringliteral">&#39;database&#39;</span>])),
<a name="l00980"></a>00980     <span class="stringliteral">&#39;required&#39;</span> =&gt; TRUE,
<a name="l00981"></a>00981   );
<a name="l00982"></a>00982   $settings[<span class="stringliteral">&#39;drupal_hash_salt&#39;</span>] = array(
<a name="l00983"></a>00983     <span class="stringliteral">&#39;value&#39;</span>    =&gt; <a class="code" href="bootstrap_8inc_afaa1b21aee7b2e06ee3f868065fdbcc1.html#afaa1b21aee7b2e06ee3f868065fdbcc1" title="Calculates a base-64 encoded, URL-safe sha-256 hash.">drupal_hash_base64</a>(<a class="code" href="bootstrap_8inc_a6eb7796c83ea744f818faa2a02f19953.html#a6eb7796c83ea744f818faa2a02f19953" title="Returns a string of highly randomized bytes (over the full 8-bit range).">drupal_random_bytes</a>(55)),
<a name="l00984"></a>00984     <span class="stringliteral">&#39;required&#39;</span> =&gt; TRUE,
<a name="l00985"></a>00985   );
<a name="l00986"></a>00986   <a class="code" href="install_8inc_ad99864750a734251d0a39fffe620ff53.html#ad99864750a734251d0a39fffe620ff53" title="Replace values in settings.php with values in the submitted array.">drupal_rewrite_settings</a>($settings);
<a name="l00987"></a>00987   <span class="comment">// Indicate that the settings file has been verified, and check the database</span>
<a name="l00988"></a>00988   <span class="comment">// for the last completed task, now that we have a valid connection. This</span>
<a name="l00989"></a>00989   <span class="comment">// last step is important since we want to trigger an error if the new</span>
<a name="l00990"></a>00990   <span class="comment">// database already has Drupal installed.</span>
<a name="l00991"></a>00991   $install_state[<span class="stringliteral">&#39;settings_verified&#39;</span>] = TRUE;
<a name="l00992"></a>00992   $install_state[<span class="stringliteral">&#39;completed_task&#39;</span>] = <a class="code" href="install_8core_8inc_a0c550ddc08ed7884ffdfc444c85d4a3a.html#a0c550ddc08ed7884ffdfc444c85d4a3a" title="Verify and return the last installation task that was completed.">install_verify_completed_task</a>();
<a name="l00993"></a>00993 }
<a name="l00994"></a>00994 
<a name="l00998"></a><a class="code" href="install_8core_8inc_a0b98c0d4c34d20f6334cc0f609c65ac8.html#a0b98c0d4c34d20f6334cc0f609c65ac8">00998</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a0b98c0d4c34d20f6334cc0f609c65ac8.html#a0b98c0d4c34d20f6334cc0f609c65ac8" title="Finds all .profile files.">install_find_profiles</a>() {
<a name="l00999"></a>00999   <span class="keywordflow">return</span> <a class="code" href="group__file_ga363e988787ffa45bff69ff051eed0615.html#ga363e988787ffa45bff69ff051eed0615" title="Finds all files that match a given mask in a given directory.">file_scan_directory</a>(<span class="stringliteral">&#39;./profiles&#39;</span>, <span class="stringliteral">&#39;/\.profile$/&#39;</span>, array(<span class="stringliteral">&#39;key&#39;</span> =&gt; <span class="stringliteral">&#39;name&#39;</span>));
<a name="l01000"></a>01000 }
<a name="l01001"></a>01001 
<a name="l01015"></a><a class="code" href="install_8core_8inc_a4fdd2e2671bc0dd16717b898a7e25cbc.html#a4fdd2e2671bc0dd16717b898a7e25cbc">01015</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a4fdd2e2671bc0dd16717b898a7e25cbc.html#a4fdd2e2671bc0dd16717b898a7e25cbc" title="Installation task; select which profile to install.">install_select_profile</a>(&amp;$install_state) {
<a name="l01016"></a>01016   $install_state[<span class="stringliteral">&#39;profiles&#39;</span>] += <a class="code" href="install_8core_8inc_a0b98c0d4c34d20f6334cc0f609c65ac8.html#a0b98c0d4c34d20f6334cc0f609c65ac8" title="Finds all .profile files.">install_find_profiles</a>();
<a name="l01017"></a>01017   <span class="keywordflow">if</span> (empty($install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>])) {
<a name="l01018"></a>01018     <span class="comment">// Try to find a profile.</span>
<a name="l01019"></a>01019     $profile = <a class="code" href="install_8core_8inc_a50f553802d50cc291614aa584c6960b1.html#a50f553802d50cc291614aa584c6960b1" title="Helper function for automatically selecting an installation profile from a list or from a selection p...">_install_select_profile</a>($install_state[<span class="stringliteral">&#39;profiles&#39;</span>]);
<a name="l01020"></a>01020     <span class="keywordflow">if</span> (empty($profile)) {
<a name="l01021"></a>01021       <span class="comment">// We still don&#39;t have a profile, so display a form for selecting one.</span>
<a name="l01022"></a>01022       <span class="comment">// Only do this in the case of interactive installations, since this is</span>
<a name="l01023"></a>01023       <span class="comment">// not a real form with submit handlers (the database isn&#39;t even set up</span>
<a name="l01024"></a>01024       <span class="comment">// yet), rather just a convenience method for setting parameters in the</span>
<a name="l01025"></a>01025       <span class="comment">// URL.</span>
<a name="l01026"></a>01026       <span class="keywordflow">if</span> ($install_state[<span class="stringliteral">&#39;interactive&#39;</span>]) {
<a name="l01027"></a>01027         include_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/form.inc&#39;</span>;
<a name="l01028"></a>01028         <a class="code" href="bootstrap_8inc_a1994d49eb621df71fe1306e13b7e4910.html#a1994d49eb621df71fe1306e13b7e4910" title="Sets the title of the current page.">drupal_set_title</a>(<a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Select an installation profile&#39;</span>));
<a name="l01029"></a>01029         $form = <a class="code" href="group__form__api_ga720df81a837b06dfe19daf1c1eea3437.html#ga720df81a837b06dfe19daf1c1eea3437" title="Returns a renderable form array for a given form ID.">drupal_get_form</a>(<span class="stringliteral">&#39;install_select_profile_form&#39;</span>, $install_state[<span class="stringliteral">&#39;profiles&#39;</span>]);
<a name="l01030"></a>01030         <span class="keywordflow">return</span> <a class="code" href="common_8inc_a05798b44e8d6c496d4bee5cc32fa7851.html#a05798b44e8d6c496d4bee5cc32fa7851" title="Renders HTML given a structured array tree.">drupal_render</a>($form);
<a name="l01031"></a>01031       }
<a name="l01032"></a>01032       <span class="keywordflow">else</span> {
<a name="l01033"></a>01033         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a>(<a class="code" href="install_8core_8inc_a78dd97fe8667cff59641b2adc55436cf.html#a78dd97fe8667cff59641b2adc55436cf" title="Indicates that there are no profiles available.">install_no_profile_error</a>());
<a name="l01034"></a>01034       }
<a name="l01035"></a>01035     }
<a name="l01036"></a>01036     <span class="keywordflow">else</span> {
<a name="l01037"></a>01037       $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>] = $profile;
<a name="l01038"></a>01038     }
<a name="l01039"></a>01039   }
<a name="l01040"></a>01040 }
<a name="l01041"></a>01041 
<a name="l01046"></a><a class="code" href="install_8core_8inc_a50f553802d50cc291614aa584c6960b1.html#a50f553802d50cc291614aa584c6960b1">01046</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a50f553802d50cc291614aa584c6960b1.html#a50f553802d50cc291614aa584c6960b1" title="Helper function for automatically selecting an installation profile from a list or from a selection p...">_install_select_profile</a>($profiles) {
<a name="l01047"></a>01047   <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>($profiles) == 0) {
<a name="l01048"></a>01048     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a>(<a class="code" href="install_8core_8inc_a78dd97fe8667cff59641b2adc55436cf.html#a78dd97fe8667cff59641b2adc55436cf" title="Indicates that there are no profiles available.">install_no_profile_error</a>());
<a name="l01049"></a>01049   }
<a name="l01050"></a>01050   <span class="comment">// Don&#39;t need to choose profile if only one available.</span>
<a name="l01051"></a>01051   <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>($profiles) == 1) {
<a name="l01052"></a>01052     $profile = array_pop($profiles);
<a name="l01053"></a>01053     <span class="comment">// TODO: is this right?</span>
<a name="l01054"></a>01054     require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="charliteral">&#39;/&#39;</span> . $profile-&gt;uri;
<a name="l01055"></a>01055     <span class="keywordflow">return</span> $profile-&gt;name;
<a name="l01056"></a>01056   }
<a name="l01057"></a>01057   <span class="keywordflow">else</span> {
<a name="l01058"></a>01058     <span class="keywordflow">foreach</span> ($profiles as $profile) {
<a name="l01059"></a>01059       <span class="keywordflow">if</span> (!empty($_POST[<span class="stringliteral">&#39;profile&#39;</span>]) &amp;&amp; ($_POST[<span class="stringliteral">&#39;profile&#39;</span>] == $profile-&gt;name)) {
<a name="l01060"></a>01060         <span class="keywordflow">return</span> $profile-&gt;name;
<a name="l01061"></a>01061       }
<a name="l01062"></a>01062     }
<a name="l01063"></a>01063   }
<a name="l01064"></a>01064 }
<a name="l01065"></a>01065 
<a name="l01074"></a><a class="code" href="install_8core_8inc_a1ead61881194a861349f2c1c1e508752.html#a1ead61881194a861349f2c1c1e508752">01074</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a1ead61881194a861349f2c1c1e508752.html#a1ead61881194a861349f2c1c1e508752" title="Form API array definition for the profile selection form.">install_select_profile_form</a>($form, &amp;$form_state, $profile_files) {
<a name="l01075"></a>01075   $profiles = array();
<a name="l01076"></a>01076   $names = array();
<a name="l01077"></a>01077 
<a name="l01078"></a>01078   <span class="keywordflow">foreach</span> ($profile_files as $profile) {
<a name="l01079"></a>01079     <span class="comment">// TODO: is this right?</span>
<a name="l01080"></a>01080     include_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="charliteral">&#39;/&#39;</span> . $profile-&gt;uri;
<a name="l01081"></a>01081 
<a name="l01082"></a>01082     $details = <a class="code" href="install_8inc_ad035099993d5a0dc4bad7ce81264c88d.html#ad035099993d5a0dc4bad7ce81264c88d" title="Retrieve info about an install profile from its .info file.">install_profile_info</a>($profile-&gt;name);
<a name="l01083"></a>01083     <span class="comment">// Don&#39;t show hidden profiles. This is used by to hide the testing profile,</span>
<a name="l01084"></a>01084     <span class="comment">// which only exists to speed up test runs.</span>
<a name="l01085"></a>01085     <span class="keywordflow">if</span> ($details[<span class="stringliteral">&#39;hidden&#39;</span>] === TRUE) {
<a name="l01086"></a>01086       <span class="keywordflow">continue</span>;
<a name="l01087"></a>01087     }
<a name="l01088"></a>01088     $profiles[$profile-&gt;name] = $details;
<a name="l01089"></a>01089 
<a name="l01090"></a>01090     <span class="comment">// Determine the name of the profile; default to file name if defined name</span>
<a name="l01091"></a>01091     <span class="comment">// is unspecified.</span>
<a name="l01092"></a>01092     $name = isset($details[<span class="stringliteral">&#39;name&#39;</span>]) ? $details[<span class="stringliteral">&#39;name&#39;</span>] : $profile-&gt;name;
<a name="l01093"></a>01093     $names[$profile-&gt;name] = $name;
<a name="l01094"></a>01094   }
<a name="l01095"></a>01095 
<a name="l01096"></a>01096   <span class="comment">// Display radio buttons alphabetically by human-readable name, but always</span>
<a name="l01097"></a>01097   <span class="comment">// put the core profiles first (if they are present in the filesystem).</span>
<a name="l01098"></a>01098   natcasesort($names);
<a name="l01099"></a>01099   <span class="keywordflow">if</span> (isset($names[<span class="stringliteral">&#39;minimal&#39;</span>])) {
<a name="l01100"></a>01100     <span class="comment">// If the expert (&quot;Minimal&quot;) core profile is present, put it in front of</span>
<a name="l01101"></a>01101     <span class="comment">// any non-core profiles rather than including it with them alphabetically,</span>
<a name="l01102"></a>01102     <span class="comment">// since the other profiles might be intended to group together in a</span>
<a name="l01103"></a>01103     <span class="comment">// particular way.</span>
<a name="l01104"></a>01104     $names = array(<span class="stringliteral">&#39;minimal&#39;</span> =&gt; $names[<span class="stringliteral">&#39;minimal&#39;</span>]) + $names;
<a name="l01105"></a>01105   }
<a name="l01106"></a>01106   <span class="keywordflow">if</span> (isset($names[<span class="stringliteral">&#39;standard&#39;</span>])) {
<a name="l01107"></a>01107     <span class="comment">// If the default (&quot;Standard&quot;) core profile is present, put it at the very</span>
<a name="l01108"></a>01108     <span class="comment">// top of the list. This profile will have its radio button pre-selected,</span>
<a name="l01109"></a>01109     <span class="comment">// so we want it to always appear at the top.</span>
<a name="l01110"></a>01110     $names = array(<span class="stringliteral">&#39;standard&#39;</span> =&gt; $names[<span class="stringliteral">&#39;standard&#39;</span>]) + $names;
<a name="l01111"></a>01111   }
<a name="l01112"></a>01112 
<a name="l01113"></a>01113   <span class="keywordflow">foreach</span> ($names as $profile =&gt; $name) {
<a name="l01114"></a>01114     $form[<span class="stringliteral">&#39;profile&#39;</span>][$name] = array(
<a name="l01115"></a>01115       <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;radio&#39;</span>,
<a name="l01116"></a>01116       <span class="stringliteral">&#39;#value&#39;</span> =&gt; <span class="stringliteral">&#39;standard&#39;</span>,
<a name="l01117"></a>01117       <span class="stringliteral">&#39;#return_value&#39;</span> =&gt; $profile,
<a name="l01118"></a>01118       <span class="stringliteral">&#39;#title&#39;</span> =&gt; $name,
<a name="l01119"></a>01119       <span class="stringliteral">&#39;#description&#39;</span> =&gt; isset($profiles[$profile][<span class="stringliteral">&#39;description&#39;</span>]) ? $profiles[$profile][<span class="stringliteral">&#39;description&#39;</span>] : <span class="stringliteral">&#39;&#39;</span>,
<a name="l01120"></a>01120       <span class="stringliteral">&#39;#parents&#39;</span> =&gt; array(<span class="stringliteral">&#39;profile&#39;</span>),
<a name="l01121"></a>01121     );
<a name="l01122"></a>01122   }
<a name="l01123"></a>01123   $form[<span class="stringliteral">&#39;actions&#39;</span>] = array(<span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;actions&#39;</span>);
<a name="l01124"></a>01124   $form[<span class="stringliteral">&#39;actions&#39;</span>][<span class="stringliteral">&#39;submit&#39;</span>] =  array(
<a name="l01125"></a>01125     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;submit&#39;</span>,
<a name="l01126"></a>01126     <span class="stringliteral">&#39;#value&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Save and continue&#39;</span>),
<a name="l01127"></a>01127   );
<a name="l01128"></a>01128   <span class="keywordflow">return</span> $form;
<a name="l01129"></a>01129 }
<a name="l01130"></a>01130 
<a name="l01134"></a><a class="code" href="install_8core_8inc_a2a4848ecf0e42d2782a9b58857e6476b.html#a2a4848ecf0e42d2782a9b58857e6476b">01134</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a2a4848ecf0e42d2782a9b58857e6476b.html#a2a4848ecf0e42d2782a9b58857e6476b" title="Find all .po files for the current profile.">install_find_locales</a>($profilename) {
<a name="l01135"></a>01135   $locales = <a class="code" href="group__file_ga363e988787ffa45bff69ff051eed0615.html#ga363e988787ffa45bff69ff051eed0615" title="Finds all files that match a given mask in a given directory.">file_scan_directory</a>(<span class="stringliteral">&#39;./profiles/&#39;</span> . $profilename . <span class="stringliteral">&#39;/translations&#39;</span>, <span class="stringliteral">&#39;/\.po$/&#39;</span>, array(<span class="stringliteral">&#39;recurse&#39;</span> =&gt; FALSE));
<a name="l01136"></a>01136   array_unshift($locales, (<span class="keywordtype">object</span>) array(<span class="stringliteral">&#39;name&#39;</span> =&gt; <span class="stringliteral">&#39;en&#39;</span>));
<a name="l01137"></a>01137   <span class="keywordflow">foreach</span> ($locales as $key =&gt; $locale) {
<a name="l01138"></a>01138     <span class="comment">// The locale (file name) might be drupal-7.2.cs.po instead of cs.po.</span>
<a name="l01139"></a>01139     $locales[$key]-&gt;langcode = preg_replace(<span class="stringliteral">&#39;!^(.+\.)?([^\.]+)$!&#39;</span>, <span class="charliteral">&#39;\2&#39;</span>, $locale-&gt;name);
<a name="l01140"></a>01140     <span class="comment">// Language codes cannot exceed 12 characters to fit into the {languages}</span>
<a name="l01141"></a>01141     <span class="comment">// table.</span>
<a name="l01142"></a>01142     <span class="keywordflow">if</span> (strlen($locales[$key]-&gt;langcode) &gt; 12) {
<a name="l01143"></a>01143       unset($locales[$key]);
<a name="l01144"></a>01144     }
<a name="l01145"></a>01145   }
<a name="l01146"></a>01146   <span class="keywordflow">return</span> $locales;
<a name="l01147"></a>01147 }
<a name="l01148"></a>01148 
<a name="l01163"></a><a class="code" href="install_8core_8inc_accf7b9346a3fc1ac88bb8787addc41f5.html#accf7b9346a3fc1ac88bb8787addc41f5">01163</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_accf7b9346a3fc1ac88bb8787addc41f5.html#accf7b9346a3fc1ac88bb8787addc41f5" title="Installation task; select which locale to use for the current profile.">install_select_locale</a>(&amp;$install_state) {
<a name="l01164"></a>01164   <span class="comment">// Find all available locales.</span>
<a name="l01165"></a>01165   $profilename = $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>];
<a name="l01166"></a>01166   $locales = <a class="code" href="install_8core_8inc_a2a4848ecf0e42d2782a9b58857e6476b.html#a2a4848ecf0e42d2782a9b58857e6476b" title="Find all .po files for the current profile.">install_find_locales</a>($profilename);
<a name="l01167"></a>01167   $install_state[<span class="stringliteral">&#39;locales&#39;</span>] += $locales;
<a name="l01168"></a>01168 
<a name="l01169"></a>01169   <span class="keywordflow">if</span> (!empty($_POST[<span class="stringliteral">&#39;locale&#39;</span>])) {
<a name="l01170"></a>01170     <span class="keywordflow">foreach</span> ($locales as $locale) {
<a name="l01171"></a>01171       <span class="keywordflow">if</span> ($_POST[<span class="stringliteral">&#39;locale&#39;</span>] == $locale-&gt;langcode) {
<a name="l01172"></a>01172         $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;locale&#39;</span>] = $locale-&gt;langcode;
<a name="l01173"></a>01173         <span class="keywordflow">return</span>;
<a name="l01174"></a>01174       }
<a name="l01175"></a>01175     }
<a name="l01176"></a>01176   }
<a name="l01177"></a>01177 
<a name="l01178"></a>01178   <span class="keywordflow">if</span> (empty($install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;locale&#39;</span>])) {
<a name="l01179"></a>01179     <span class="comment">// If only the built-in (English) language is available, and we are</span>
<a name="l01180"></a>01180     <span class="comment">// performing an interactive installation, inform the user that the</span>
<a name="l01181"></a>01181     <span class="comment">// installer can be localized. Otherwise we assume the user knows what he</span>
<a name="l01182"></a>01182     <span class="comment">// is doing.</span>
<a name="l01183"></a>01183     <span class="keywordflow">if</span> (count($locales) == 1) {
<a name="l01184"></a>01184       <span class="keywordflow">if</span> ($install_state[<span class="stringliteral">&#39;interactive&#39;</span>]) {
<a name="l01185"></a>01185         <a class="code" href="bootstrap_8inc_a1994d49eb621df71fe1306e13b7e4910.html#a1994d49eb621df71fe1306e13b7e4910" title="Sets the title of the current page.">drupal_set_title</a>(<a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Choose language&#39;</span>));
<a name="l01186"></a>01186         <span class="keywordflow">if</span> (!empty($install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;localize&#39;</span>])) {
<a name="l01187"></a>01187           <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> = <span class="stringliteral">&#39;&lt;p&gt;Follow these steps to translate Drupal into your language:&lt;/p&gt;&#39;</span>;
<a name="l01188"></a>01188           <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39;&lt;ol&gt;&#39;</span>;
<a name="l01189"></a>01189           <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39;&lt;li&gt;Download a translation from the &lt;a href=&quot;http://localize.drupal.org/download&quot; target=&quot;_blank&quot;&gt;translation server&lt;/a&gt;.&lt;/li&gt;&#39;</span>;
<a name="l01190"></a>01190           <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39;&lt;li&gt;Place it into the following directory:</span>
<a name="l01191"></a>01191 <span class="stringliteral">&lt;pre&gt;</span>
<a name="l01192"></a>01192 <span class="stringliteral">/profiles/&#39;</span> . $profilename . <span class="stringliteral">&#39;/translations/</span>
<a name="l01193"></a>01193 <span class="stringliteral">&lt;/pre&gt;&lt;/li&gt;&#39;</span>;
<a name="l01194"></a>01194           <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39;&lt;/ol&gt;&#39;</span>;
<a name="l01195"></a>01195           <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39;&lt;p&gt;For more information on installing Drupal in different languages, visit the &lt;a href=&quot;http://drupal.org/localize&quot; target=&quot;_blank&quot;&gt;drupal.org handbook page&lt;/a&gt;.&lt;/p&gt;&#39;</span>;
<a name="l01196"></a>01196           <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39;&lt;p&gt;How should the installation continue?&lt;/p&gt;&#39;</span>;
<a name="l01197"></a>01197           <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39;&lt;ul&gt;&#39;</span>;
<a name="l01198"></a>01198           <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39;&lt;li&gt;&lt;a href=&quot;install.php?profile=&#39;</span> . $profilename . <span class="stringliteral">&#39;&quot;&gt;Reload the language selection page after adding translations&lt;/a&gt;&lt;/li&gt;&#39;</span>;
<a name="l01199"></a>01199           <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39;&lt;li&gt;&lt;a href=&quot;install.php?profile=&#39;</span> . $profilename . <span class="stringliteral">&#39;&amp;amp;locale=en&quot;&gt;Continue installation in English&lt;/a&gt;&lt;/li&gt;&#39;</span>;
<a name="l01200"></a>01200           <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39;&lt;/ul&gt;&#39;</span>;
<a name="l01201"></a>01201         }
<a name="l01202"></a>01202         <span class="keywordflow">else</span> {
<a name="l01203"></a>01203           include_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/form.inc&#39;</span>;
<a name="l01204"></a>01204           $elements = <a class="code" href="group__form__api_ga720df81a837b06dfe19daf1c1eea3437.html#ga720df81a837b06dfe19daf1c1eea3437" title="Returns a renderable form array for a given form ID.">drupal_get_form</a>(<span class="stringliteral">&#39;install_select_locale_form&#39;</span>, $locales, $profilename);
<a name="l01205"></a>01205           <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> = <a class="code" href="common_8inc_a05798b44e8d6c496d4bee5cc32fa7851.html#a05798b44e8d6c496d4bee5cc32fa7851" title="Renders HTML given a structured array tree.">drupal_render</a>($elements);
<a name="l01206"></a>01206         }
<a name="l01207"></a>01207         <span class="keywordflow">return</span> <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>;
<a name="l01208"></a>01208       }
<a name="l01209"></a>01209       <span class="comment">// One language, but not an interactive installation. Assume the user</span>
<a name="l01210"></a>01210       <span class="comment">// knows what he is doing.</span>
<a name="l01211"></a>01211       $locale = current($locales);
<a name="l01212"></a>01212       $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;locale&#39;</span>] = $locale-&gt;name;
<a name="l01213"></a>01213       <span class="keywordflow">return</span>;
<a name="l01214"></a>01214     }
<a name="l01215"></a>01215     <span class="keywordflow">else</span> {
<a name="l01216"></a>01216       <span class="comment">// Allow profile to pre-select the language, skipping the selection.</span>
<a name="l01217"></a>01217       $function = $profilename . <span class="stringliteral">&#39;_profile_details&#39;</span>;
<a name="l01218"></a>01218       <span class="keywordflow">if</span> (function_exists($function)) {
<a name="l01219"></a>01219         $details = $function();
<a name="l01220"></a>01220         <span class="keywordflow">if</span> (isset($details[<span class="stringliteral">&#39;language&#39;</span>])) {
<a name="l01221"></a>01221           <span class="keywordflow">foreach</span> ($locales as $locale) {
<a name="l01222"></a>01222             <span class="keywordflow">if</span> ($details[<span class="stringliteral">&#39;language&#39;</span>] == $locale-&gt;name) {
<a name="l01223"></a>01223               $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;locale&#39;</span>] = $locale-&gt;name;
<a name="l01224"></a>01224               <span class="keywordflow">return</span>;
<a name="l01225"></a>01225             }
<a name="l01226"></a>01226           }
<a name="l01227"></a>01227         }
<a name="l01228"></a>01228       }
<a name="l01229"></a>01229 
<a name="l01230"></a>01230       <span class="comment">// We still don&#39;t have a locale, so display a form for selecting one.</span>
<a name="l01231"></a>01231       <span class="comment">// Only do this in the case of interactive installations, since this is</span>
<a name="l01232"></a>01232       <span class="comment">// not a real form with submit handlers (the database isn&#39;t even set up</span>
<a name="l01233"></a>01233       <span class="comment">// yet), rather just a convenience method for setting parameters in the</span>
<a name="l01234"></a>01234       <span class="comment">// URL.</span>
<a name="l01235"></a>01235       <span class="keywordflow">if</span> ($install_state[<span class="stringliteral">&#39;interactive&#39;</span>]) {
<a name="l01236"></a>01236         <a class="code" href="bootstrap_8inc_a1994d49eb621df71fe1306e13b7e4910.html#a1994d49eb621df71fe1306e13b7e4910" title="Sets the title of the current page.">drupal_set_title</a>(<a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Choose language&#39;</span>));
<a name="l01237"></a>01237         include_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/form.inc&#39;</span>;
<a name="l01238"></a>01238         $elements = <a class="code" href="group__form__api_ga720df81a837b06dfe19daf1c1eea3437.html#ga720df81a837b06dfe19daf1c1eea3437" title="Returns a renderable form array for a given form ID.">drupal_get_form</a>(<span class="stringliteral">&#39;install_select_locale_form&#39;</span>, $locales, $profilename);
<a name="l01239"></a>01239         <span class="keywordflow">return</span> <a class="code" href="common_8inc_a05798b44e8d6c496d4bee5cc32fa7851.html#a05798b44e8d6c496d4bee5cc32fa7851" title="Renders HTML given a structured array tree.">drupal_render</a>($elements);
<a name="l01240"></a>01240       }
<a name="l01241"></a>01241       <span class="keywordflow">else</span> {
<a name="l01242"></a>01242         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a>(<a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Sorry, you must select a language to continue the installation.&#39;</span>));
<a name="l01243"></a>01243       }
<a name="l01244"></a>01244     }
<a name="l01245"></a>01245   }
<a name="l01246"></a>01246 }
<a name="l01247"></a>01247 
<a name="l01251"></a><a class="code" href="install_8core_8inc_a7c540506932fb00783972b742787ddeb.html#a7c540506932fb00783972b742787ddeb">01251</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a7c540506932fb00783972b742787ddeb.html#a7c540506932fb00783972b742787ddeb" title="Form API array definition for language selection.">install_select_locale_form</a>($form, &amp;$form_state, $locales, $profilename) {
<a name="l01252"></a>01252   include_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/iso.inc&#39;</span>;
<a name="l01253"></a>01253   $languages = <a class="code" href="group__locale-api-predefined_gafac9d59fd436286a3f3738140ce96e82.html#gafac9d59fd436286a3f3738140ce96e82" title="Some of the common languages with their English and native names.">_locale_get_predefined_list</a>();
<a name="l01254"></a>01254   <span class="keywordflow">foreach</span> ($locales as $locale) {
<a name="l01255"></a>01255     $name = $locale-&gt;langcode;
<a name="l01256"></a>01256     <span class="keywordflow">if</span> (isset($languages[$name])) {
<a name="l01257"></a>01257       $name = $languages[$name][0] . (isset($languages[$name][1]) ? <span class="charliteral">&#39; &#39;</span> . <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;(@language)&#39;</span>, array(<span class="stringliteral">&#39;@language&#39;</span> =&gt; $languages[$name][1])) : <span class="stringliteral">&#39;&#39;</span>);
<a name="l01258"></a>01258     }
<a name="l01259"></a>01259     $form[<span class="stringliteral">&#39;locale&#39;</span>][$locale-&gt;langcode] = array(
<a name="l01260"></a>01260       <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;radio&#39;</span>,
<a name="l01261"></a>01261       <span class="stringliteral">&#39;#return_value&#39;</span> =&gt; $locale-&gt;langcode,
<a name="l01262"></a>01262       <span class="stringliteral">&#39;#default_value&#39;</span> =&gt; $locale-&gt;langcode == <span class="stringliteral">&#39;en&#39;</span> ? <span class="stringliteral">&#39;en&#39;</span> : <span class="stringliteral">&#39;&#39;</span>,
<a name="l01263"></a>01263       <span class="stringliteral">&#39;#title&#39;</span> =&gt; $name . ($locale-&gt;langcode == <span class="stringliteral">&#39;en&#39;</span> ? <span class="charliteral">&#39; &#39;</span> . <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;(built-in)&#39;</span>) : <span class="stringliteral">&#39;&#39;</span>),
<a name="l01264"></a>01264       <span class="stringliteral">&#39;#parents&#39;</span> =&gt; array(<span class="stringliteral">&#39;locale&#39;</span>)
<a name="l01265"></a>01265     );
<a name="l01266"></a>01266   }
<a name="l01267"></a>01267   <span class="keywordflow">if</span> (count($locales) == 1) {
<a name="l01268"></a>01268     $form[<span class="stringliteral">&#39;help&#39;</span>] = array(
<a name="l01269"></a>01269       <span class="stringliteral">&#39;#markup&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;p&gt;&lt;a href=&quot;install.php?profile=&#39;</span> . $profilename . <span class="stringliteral">&#39;&amp;amp;localize=true&quot;&gt;&#39;</span> . <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Learn how to install Drupal in other languages&#39;</span>) . <span class="stringliteral">&#39;&lt;/a&gt;&lt;/p&gt;&#39;</span>,
<a name="l01270"></a>01270     );
<a name="l01271"></a>01271   }
<a name="l01272"></a>01272   $form[<span class="stringliteral">&#39;actions&#39;</span>] = array(<span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;actions&#39;</span>);
<a name="l01273"></a>01273   $form[<span class="stringliteral">&#39;actions&#39;</span>][<span class="stringliteral">&#39;submit&#39;</span>] =  array(
<a name="l01274"></a>01274     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;submit&#39;</span>,
<a name="l01275"></a>01275     <span class="stringliteral">&#39;#value&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Save and continue&#39;</span>),
<a name="l01276"></a>01276   );
<a name="l01277"></a>01277   <span class="keywordflow">return</span> $form;
<a name="l01278"></a>01278 }
<a name="l01279"></a>01279 
<a name="l01283"></a><a class="code" href="install_8core_8inc_a78dd97fe8667cff59641b2adc55436cf.html#a78dd97fe8667cff59641b2adc55436cf">01283</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a78dd97fe8667cff59641b2adc55436cf.html#a78dd97fe8667cff59641b2adc55436cf" title="Indicates that there are no profiles available.">install_no_profile_error</a>() {
<a name="l01284"></a>01284   <a class="code" href="bootstrap_8inc_a1994d49eb621df71fe1306e13b7e4910.html#a1994d49eb621df71fe1306e13b7e4910" title="Sets the title of the current page.">drupal_set_title</a>(<a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;No profiles available&#39;</span>));
<a name="l01285"></a>01285   <span class="keywordflow">return</span> <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;We were unable to find any installation profiles. Installation profiles tell us what modules to enable and what schema to install in the database. A profile is necessary to continue with the installation process.&#39;</span>);
<a name="l01286"></a>01286 }
<a name="l01287"></a>01287 
<a name="l01291"></a><a class="code" href="install_8core_8inc_a6469cc717a3ac52eece0537630addea4.html#a6469cc717a3ac52eece0537630addea4">01291</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a6469cc717a3ac52eece0537630addea4.html#a6469cc717a3ac52eece0537630addea4" title="Indicates that Drupal has already been installed.">install_already_done_error</a>() {
<a name="l01292"></a>01292   global $base_url;
<a name="l01293"></a>01293 
<a name="l01294"></a>01294   <a class="code" href="bootstrap_8inc_a1994d49eb621df71fe1306e13b7e4910.html#a1994d49eb621df71fe1306e13b7e4910" title="Sets the title of the current page.">drupal_set_title</a>(<a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Drupal already installed&#39;</span>));
<a name="l01295"></a>01295   <span class="keywordflow">return</span> <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;&lt;ul&gt;&lt;li&gt;To start over, you must empty your existing database.&lt;/li&gt;&lt;li&gt;To install to a different database, edit the appropriate &lt;em&gt;settings.php&lt;/em&gt; file in the &lt;em&gt;sites&lt;/em&gt; folder.&lt;/li&gt;&lt;li&gt;To upgrade an existing installation, proceed to the &lt;a href=&quot;@base-url/update.php&quot;&gt;update script&lt;/a&gt;.&lt;/li&gt;&lt;li&gt;View your &lt;a href=&quot;@base-url&quot;&gt;existing site&lt;/a&gt;.&lt;/li&gt;&lt;/ul&gt;&#39;</span>, array(<span class="stringliteral">&#39;@base-url&#39;</span> =&gt; $base_url));
<a name="l01296"></a>01296 }
<a name="l01297"></a>01297 
<a name="l01306"></a><a class="code" href="install_8core_8inc_a8ef7587c3c0812d35629396360b3797e.html#a8ef7587c3c0812d35629396360b3797e">01306</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a8ef7587c3c0812d35629396360b3797e.html#a8ef7587c3c0812d35629396360b3797e" title="Installation task; load information about the chosen profile.">install_load_profile</a>(&amp;$install_state) {
<a name="l01307"></a>01307   $profile_file = <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/profiles/&#39;</span> . $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>] . <span class="charliteral">&#39;/&#39;</span> . $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>] . <span class="stringliteral">&#39;.profile&#39;</span>;
<a name="l01308"></a>01308   <span class="keywordflow">if</span> (file_exists($profile_file)) {
<a name="l01309"></a>01309     include_once $profile_file;
<a name="l01310"></a>01310     $install_state[<span class="stringliteral">&#39;profile_info&#39;</span>] = <a class="code" href="install_8inc_ad035099993d5a0dc4bad7ce81264c88d.html#ad035099993d5a0dc4bad7ce81264c88d" title="Retrieve info about an install profile from its .info file.">install_profile_info</a>($install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>], $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;locale&#39;</span>]);
<a name="l01311"></a>01311   }
<a name="l01312"></a>01312   <span class="keywordflow">else</span> {
<a name="l01313"></a>01313     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a>(<a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Sorry, the profile you have chosen cannot be loaded.&#39;</span>));
<a name="l01314"></a>01314   }
<a name="l01315"></a>01315 }
<a name="l01316"></a>01316 
<a name="l01323"></a><a class="code" href="install_8core_8inc_ad5fe84024130a1d93d0238d0c3d2cfb5.html#ad5fe84024130a1d93d0238d0c3d2cfb5">01323</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_ad5fe84024130a1d93d0238d0c3d2cfb5.html#ad5fe84024130a1d93d0238d0c3d2cfb5" title="Installation task; perform a full bootstrap of Drupal.">install_bootstrap_full</a>(&amp;$install_state) {
<a name="l01324"></a>01324   <a class="code" href="bootstrap_8inc_a8dcad7737ed560086bcdd9998a020a93.html#a8dcad7737ed560086bcdd9998a020a93" title="Ensures Drupal is bootstrapped to the specified phase.">drupal_bootstrap</a>(<a class="code" href="bootstrap_8inc_a2c8ac509af1924cf2fa7420a22e1b048.html#a2c8ac509af1924cf2fa7420a22e1b048" title="Final bootstrap phase: Drupal is fully loaded; validate and fix input data.">DRUPAL_BOOTSTRAP_FULL</a>);
<a name="l01325"></a>01325 }
<a name="l01326"></a>01326 
<a name="l01336"></a><a class="code" href="install_8core_8inc_ab10e46f9de8a36a5f53c209781d24528.html#ab10e46f9de8a36a5f53c209781d24528">01336</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_ab10e46f9de8a36a5f53c209781d24528.html#ab10e46f9de8a36a5f53c209781d24528" title="Installation task; install required modules via a batch process.">install_profile_modules</a>(&amp;$install_state) {
<a name="l01337"></a>01337   $modules = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;install_profile_modules&#39;</span>, array());
<a name="l01338"></a>01338   $files = system_rebuild_module_data();
<a name="l01339"></a>01339   <a class="code" href="bootstrap_8inc_a7850bff5f313f85335f418e6d87606b1.html#a7850bff5f313f85335f418e6d87606b1" title="Unsets a persistent variable.">variable_del</a>(<span class="stringliteral">&#39;install_profile_modules&#39;</span>);
<a name="l01340"></a>01340 
<a name="l01341"></a>01341   <span class="comment">// Always install required modules first. Respect the dependencies between</span>
<a name="l01342"></a>01342   <span class="comment">// the modules.</span>
<a name="l01343"></a>01343   $required = array();
<a name="l01344"></a>01344   $non_required = array();
<a name="l01345"></a>01345   <span class="comment">// Although the profile module is marked as required, it needs to go after</span>
<a name="l01346"></a>01346   <span class="comment">// every dependency, including non-required ones. So clear its required</span>
<a name="l01347"></a>01347   <span class="comment">// flag for now to allow it to install late.</span>
<a name="l01348"></a>01348   $files[$install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>]]-&gt;info[<span class="stringliteral">&#39;required&#39;</span>] = FALSE;
<a name="l01349"></a>01349   <span class="comment">// Add modules that other modules depend on.</span>
<a name="l01350"></a>01350   <span class="keywordflow">foreach</span> ($modules as $module) {
<a name="l01351"></a>01351     <span class="keywordflow">if</span> ($files[$module]-&gt;requires) {
<a name="l01352"></a>01352       $modules = array_merge($modules, array_keys($files[$module]-&gt;requires));
<a name="l01353"></a>01353     }
<a name="l01354"></a>01354   }
<a name="l01355"></a>01355   $modules = array_unique($modules);
<a name="l01356"></a>01356   <span class="keywordflow">foreach</span> ($modules as $module) {
<a name="l01357"></a>01357     <span class="keywordflow">if</span> (!empty($files[$module]-&gt;info[<span class="stringliteral">&#39;required&#39;</span>])) {
<a name="l01358"></a>01358       $required[$module] = $files[$module]-&gt;sort;
<a name="l01359"></a>01359     }
<a name="l01360"></a>01360     <span class="keywordflow">else</span> {
<a name="l01361"></a>01361       $non_required[$module] = $files[$module]-&gt;sort;
<a name="l01362"></a>01362     }
<a name="l01363"></a>01363   }
<a name="l01364"></a>01364   arsort($required);
<a name="l01365"></a>01365   arsort($non_required);
<a name="l01366"></a>01366 
<a name="l01367"></a>01367   $operations = array();
<a name="l01368"></a>01368   <span class="keywordflow">foreach</span> ($required + $non_required as $module =&gt; $weight) {
<a name="l01369"></a>01369     $operations[] = array(<span class="stringliteral">&#39;_install_module_batch&#39;</span>, array($module, $files[$module]-&gt;info[<span class="stringliteral">&#39;name&#39;</span>]));
<a name="l01370"></a>01370   }
<a name="l01371"></a>01371   $batch = array(
<a name="l01372"></a>01372     <span class="stringliteral">&#39;operations&#39;</span> =&gt; $operations,
<a name="l01373"></a>01373     <span class="stringliteral">&#39;title&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Installing @drupal&#39;</span>, array(<span class="stringliteral">&#39;@drupal&#39;</span> =&gt; <a class="code" href="install_8inc_a52c56958ff42269107b5a678e8d95ddc.html#a52c56958ff42269107b5a678e8d95ddc" title="Loads the install profile, extracting its defined distribution name.">drupal_install_profile_distribution_name</a>())),
<a name="l01374"></a>01374     <span class="stringliteral">&#39;error_message&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;The installation has encountered an error.&#39;</span>),
<a name="l01375"></a>01375     <span class="stringliteral">&#39;finished&#39;</span> =&gt; <span class="stringliteral">&#39;_install_profile_modules_finished&#39;</span>,
<a name="l01376"></a>01376   );
<a name="l01377"></a>01377   <span class="keywordflow">return</span> $batch;
<a name="l01378"></a>01378 }
<a name="l01379"></a>01379 
<a name="l01389"></a><a class="code" href="install_8core_8inc_a8736de2cc75cff24bc4b070668526dde.html#a8736de2cc75cff24bc4b070668526dde">01389</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a8736de2cc75cff24bc4b070668526dde.html#a8736de2cc75cff24bc4b070668526dde" title="Installation task; import languages via a batch process.">install_import_locales</a>(&amp;$install_state) {
<a name="l01390"></a>01390   include_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/locale.inc&#39;</span>;
<a name="l01391"></a>01391   $install_locale = $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;locale&#39;</span>];
<a name="l01392"></a>01392 
<a name="l01393"></a>01393   include_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/iso.inc&#39;</span>;
<a name="l01394"></a>01394   $predefined = <a class="code" href="group__locale-api-predefined_gafac9d59fd436286a3f3738140ce96e82.html#gafac9d59fd436286a3f3738140ce96e82" title="Some of the common languages with their English and native names.">_locale_get_predefined_list</a>();
<a name="l01395"></a>01395   <span class="keywordflow">if</span> (!isset($predefined[$install_locale])) {
<a name="l01396"></a>01396     <span class="comment">// Drupal does not know about this language, so we prefill its values with</span>
<a name="l01397"></a>01397     <span class="comment">// our best guess. The user will be able to edit afterwards.</span>
<a name="l01398"></a>01398     <a class="code" href="group__locale-api-add_ga9fc28b9f10f5aaa7cb733dc0145018a2.html#ga9fc28b9f10f5aaa7cb733dc0145018a2" title="API function to add a language.">locale_add_language</a>($install_locale, $install_locale, $install_locale, <a class="code" href="bootstrap_8inc_a8790965df4de009fe8bdcf17f6a5c738.html#a8790965df4de009fe8bdcf17f6a5c738" title="Language written left to right.">LANGUAGE_LTR</a>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, TRUE, TRUE);
<a name="l01399"></a>01399   }
<a name="l01400"></a>01400   <span class="keywordflow">else</span> {
<a name="l01401"></a>01401     <span class="comment">// A known predefined language, details will be filled in properly.</span>
<a name="l01402"></a>01402     <a class="code" href="group__locale-api-add_ga9fc28b9f10f5aaa7cb733dc0145018a2.html#ga9fc28b9f10f5aaa7cb733dc0145018a2" title="API function to add a language.">locale_add_language</a>($install_locale, NULL, NULL, NULL, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, TRUE, TRUE);
<a name="l01403"></a>01403   }
<a name="l01404"></a>01404 
<a name="l01405"></a>01405   <span class="comment">// Collect files to import for this language.</span>
<a name="l01406"></a>01406   $batch = <a class="code" href="group__locale-autoimport_ga2c34cb914394a45fb4e94561bfc26b71.html#ga2c34cb914394a45fb4e94561bfc26b71" title="Prepare a batch to import translations for all enabled modules in a given language.">locale_batch_by_language</a>($install_locale, NULL);
<a name="l01407"></a>01407   <span class="keywordflow">if</span> (!empty($batch)) {
<a name="l01408"></a>01408     <span class="comment">// Remember components we cover in this batch set.</span>
<a name="l01409"></a>01409     <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;install_locale_batch_components&#39;</span>, $batch[<span class="stringliteral">&#39;#components&#39;</span>]);
<a name="l01410"></a>01410     <span class="keywordflow">return</span> $batch;
<a name="l01411"></a>01411   }
<a name="l01412"></a>01412 }
<a name="l01413"></a>01413 
<a name="l01425"></a><a class="code" href="install_8core_8inc_a38e5d79d667dbc48f40ca4238d6d161b.html#a38e5d79d667dbc48f40ca4238d6d161b">01425</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a38e5d79d667dbc48f40ca4238d6d161b.html#a38e5d79d667dbc48f40ca4238d6d161b" title="Installation task; configure settings for the new site.">install_configure_form</a>($form, &amp;$form_state, &amp;$install_state) {
<a name="l01426"></a>01426   <a class="code" href="bootstrap_8inc_a1994d49eb621df71fe1306e13b7e4910.html#a1994d49eb621df71fe1306e13b7e4910" title="Sets the title of the current page.">drupal_set_title</a>(<a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Configure site&#39;</span>));
<a name="l01427"></a>01427 
<a name="l01428"></a>01428   <span class="comment">// Warn about settings.php permissions risk</span>
<a name="l01429"></a>01429   $settings_dir = <a class="code" href="bootstrap_8inc_acef612ef19c49f6259531f0bee5c26cc.html#acef612ef19c49f6259531f0bee5c26cc" title="Finds the appropriate configuration directory.">conf_path</a>();
<a name="l01430"></a>01430   $settings_file = $settings_dir . <span class="stringliteral">&#39;/settings.php&#39;</span>;
<a name="l01431"></a>01431   <span class="comment">// Check that $_POST is empty so we only show this message when the form is</span>
<a name="l01432"></a>01432   <span class="comment">// first displayed, not on the next page after it is submitted. (We do not</span>
<a name="l01433"></a>01433   <span class="comment">// want to repeat it multiple times because it is a general warning that is</span>
<a name="l01434"></a>01434   <span class="comment">// not related to the rest of the installation process; it would also be</span>
<a name="l01435"></a>01435   <span class="comment">// especially out of place on the last page of the installer, where it would</span>
<a name="l01436"></a>01436   <span class="comment">// distract from the message that the Drupal installation has completed</span>
<a name="l01437"></a>01437   <span class="comment">// successfully.)</span>
<a name="l01438"></a>01438   <span class="keywordflow">if</span> (empty($_POST) &amp;&amp; (!<a class="code" href="install_8inc_a604165f37803cd10ac32534e3f8796ed.html#a604165f37803cd10ac32534e3f8796ed" title="Verify the state of the specified file.">drupal_verify_install_file</a>(<a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="charliteral">&#39;/&#39;</span> . $settings_file, <a class="code" href="install_8inc_ae627ec3bb64949659adbc8cac5ae063e.html#ae627ec3bb64949659adbc8cac5ae063e" title="File permission check -- File exists.">FILE_EXIST</a>|<a class="code" href="install_8inc_a5a3ab6bb8b0df419dff1d9c741e5ca56.html#a5a3ab6bb8b0df419dff1d9c741e5ca56" title="File permission check -- File is readable.">FILE_READABLE</a>|<a class="code" href="install_8inc_a01939e1b55bf40d1ac3556eded13a353.html#a01939e1b55bf40d1ac3556eded13a353" title="File permission check -- File is not writable.">FILE_NOT_WRITABLE</a>) || !<a class="code" href="install_8inc_a604165f37803cd10ac32534e3f8796ed.html#a604165f37803cd10ac32534e3f8796ed" title="Verify the state of the specified file.">drupal_verify_install_file</a>(<a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="charliteral">&#39;/&#39;</span> . $settings_dir, <a class="code" href="install_8inc_a01939e1b55bf40d1ac3556eded13a353.html#a01939e1b55bf40d1ac3556eded13a353" title="File permission check -- File is not writable.">FILE_NOT_WRITABLE</a>, <span class="stringliteral">&#39;dir&#39;</span>))) {
<a name="l01439"></a>01439     <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>(<a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;All necessary changes to %dir and %file have been made, so you should remove write permissions to them now in order to avoid security risks. If you are unsure how to do so, consult the &lt;a href=&quot;@handbook_url&quot;&gt;online handbook&lt;/a&gt;.&#39;</span>, array(<span class="stringliteral">&#39;%dir&#39;</span> =&gt; $settings_dir, <span class="stringliteral">&#39;%file&#39;</span> =&gt; $settings_file, <span class="stringliteral">&#39;@handbook_url&#39;</span> =&gt; <span class="stringliteral">&#39;http://drupal.org/server-permissions&#39;</span>)), <span class="stringliteral">&#39;warning&#39;</span>);
<a name="l01440"></a>01440   }
<a name="l01441"></a>01441 
<a name="l01442"></a>01442   <a class="code" href="common_8inc_a623370a2c3c2de0390dab078d17dca02.html#a623370a2c3c2de0390dab078d17dca02" title="Adds a JavaScript file, setting, or inline code to the page.">drupal_add_js</a>(<a class="code" href="common_8inc_ae3bbe8f97bf07bb0eaf4580c98f9bf94.html#ae3bbe8f97bf07bb0eaf4580c98f9bf94" title="Returns the path to a system item (module, theme, etc.).">drupal_get_path</a>(<span class="stringliteral">&#39;module&#39;</span>, <span class="stringliteral">&#39;system&#39;</span>) . <span class="stringliteral">&#39;/system.js&#39;</span>);
<a name="l01443"></a>01443   <span class="comment">// Add JavaScript time zone detection.</span>
<a name="l01444"></a>01444   <a class="code" href="common_8inc_a623370a2c3c2de0390dab078d17dca02.html#a623370a2c3c2de0390dab078d17dca02" title="Adds a JavaScript file, setting, or inline code to the page.">drupal_add_js</a>(<span class="stringliteral">&#39;misc/timezone.js&#39;</span>);
<a name="l01445"></a>01445   <span class="comment">// We add these strings as settings because JavaScript translation does not</span>
<a name="l01446"></a>01446   <span class="comment">// work on install time.</span>
<a name="l01447"></a>01447   <a class="code" href="common_8inc_a623370a2c3c2de0390dab078d17dca02.html#a623370a2c3c2de0390dab078d17dca02" title="Adds a JavaScript file, setting, or inline code to the page.">drupal_add_js</a>(array(<span class="stringliteral">&#39;copyFieldValue&#39;</span> =&gt; array(<span class="stringliteral">&#39;edit-site-mail&#39;</span> =&gt; array(<span class="stringliteral">&#39;edit-account-mail&#39;</span>))), <span class="stringliteral">&#39;setting&#39;</span>);
<a name="l01448"></a>01448   <a class="code" href="common_8inc_a623370a2c3c2de0390dab078d17dca02.html#a623370a2c3c2de0390dab078d17dca02" title="Adds a JavaScript file, setting, or inline code to the page.">drupal_add_js</a>(<span class="stringliteral">&#39;jQuery(function () { Drupal.cleanURLsInstallCheck(); });&#39;</span>, <span class="stringliteral">&#39;inline&#39;</span>);
<a name="l01449"></a>01449   <span class="comment">// Add JS to show / hide the &#39;Email administrator about site updates&#39; elements</span>
<a name="l01450"></a>01450   <a class="code" href="common_8inc_a623370a2c3c2de0390dab078d17dca02.html#a623370a2c3c2de0390dab078d17dca02" title="Adds a JavaScript file, setting, or inline code to the page.">drupal_add_js</a>(<span class="stringliteral">&#39;jQuery(function () { Drupal.hideEmailAdministratorCheckbox() });&#39;</span>, <span class="stringliteral">&#39;inline&#39;</span>);
<a name="l01451"></a>01451   <span class="comment">// Build menu to allow clean URL check.</span>
<a name="l01452"></a>01452   <a class="code" href="group__menu_gaf36dcb9d5491ef5e7d2cf22c1f5c69f4.html#gaf36dcb9d5491ef5e7d2cf22c1f5c69f4" title="(Re)populate the database tables used by various menu functions.">menu_rebuild</a>();
<a name="l01453"></a>01453 
<a name="l01454"></a>01454   <span class="comment">// Cache a fully-built schema. This is necessary for any invocation of</span>
<a name="l01455"></a>01455   <span class="comment">// index.php because: (1) setting cache table entries requires schema</span>
<a name="l01456"></a>01456   <span class="comment">// information, (2) that occurs during bootstrap before any module are</span>
<a name="l01457"></a>01457   <span class="comment">// loaded, so (3) if there is no cached schema, drupal_get_schema() will</span>
<a name="l01458"></a>01458   <span class="comment">// try to generate one but with no loaded modules will return nothing.</span>
<a name="l01459"></a>01459   <span class="comment">//</span>
<a name="l01460"></a>01460   <span class="comment">// This logically could be done during the &#39;install_finished&#39; task, but the</span>
<a name="l01461"></a>01461   <span class="comment">// clean URL check requires it now.</span>
<a name="l01462"></a>01462   <a class="code" href="group__schemaapi_ga979670bd6bd2e34337ffc5f0810f2d71.html#ga979670bd6bd2e34337ffc5f0810f2d71" title="Gets the schema definition of a table, or the whole database schema.">drupal_get_schema</a>(NULL, TRUE);
<a name="l01463"></a>01463 
<a name="l01464"></a>01464   <span class="comment">// Return the form.</span>
<a name="l01465"></a>01465   <span class="keywordflow">return</span> <a class="code" href="install_8core_8inc_a21b381d33cf055bce4286d99dafad24b.html#a21b381d33cf055bce4286d99dafad24b" title="Forms API array definition for site configuration.">_install_configure_form</a>($form, $form_state, $install_state);
<a name="l01466"></a>01466 }
<a name="l01467"></a>01467 
<a name="l01477"></a><a class="code" href="install_8core_8inc_a6a48bc00f0f8e3026dd09286f93b46aa.html#a6a48bc00f0f8e3026dd09286f93b46aa">01477</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a6a48bc00f0f8e3026dd09286f93b46aa.html#a6a48bc00f0f8e3026dd09286f93b46aa" title="Installation task; import remaining languages via a batch process.">install_import_locales_remaining</a>(&amp;$install_state) {
<a name="l01478"></a>01478   include_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/locale.inc&#39;</span>;
<a name="l01479"></a>01479   <span class="comment">// Collect files to import for this language. Skip components already covered</span>
<a name="l01480"></a>01480   <span class="comment">// in the initial batch set.</span>
<a name="l01481"></a>01481   $install_locale = $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;locale&#39;</span>];
<a name="l01482"></a>01482   $batch = <a class="code" href="group__locale-autoimport_ga2c34cb914394a45fb4e94561bfc26b71.html#ga2c34cb914394a45fb4e94561bfc26b71" title="Prepare a batch to import translations for all enabled modules in a given language.">locale_batch_by_language</a>($install_locale, NULL, <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;install_locale_batch_components&#39;</span>, array()));
<a name="l01483"></a>01483   <span class="comment">// Remove temporary variable.</span>
<a name="l01484"></a>01484   <a class="code" href="bootstrap_8inc_a7850bff5f313f85335f418e6d87606b1.html#a7850bff5f313f85335f418e6d87606b1" title="Unsets a persistent variable.">variable_del</a>(<span class="stringliteral">&#39;install_locale_batch_components&#39;</span>);
<a name="l01485"></a>01485   <span class="keywordflow">return</span> $batch;
<a name="l01486"></a>01486 }
<a name="l01487"></a>01487 
<a name="l01497"></a><a class="code" href="install_8core_8inc_abd023c5f3e8348d02d2667ed5648a0fb.html#abd023c5f3e8348d02d2667ed5648a0fb">01497</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_abd023c5f3e8348d02d2667ed5648a0fb.html#abd023c5f3e8348d02d2667ed5648a0fb" title="Installation task; perform final steps and display a &#39;finished&#39; page.">install_finished</a>(&amp;$install_state) {
<a name="l01498"></a>01498   <a class="code" href="bootstrap_8inc_a1994d49eb621df71fe1306e13b7e4910.html#a1994d49eb621df71fe1306e13b7e4910" title="Sets the title of the current page.">drupal_set_title</a>(<a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;@drupal installation complete&#39;</span>, array(<span class="stringliteral">&#39;@drupal&#39;</span> =&gt; <a class="code" href="install_8inc_a52c56958ff42269107b5a678e8d95ddc.html#a52c56958ff42269107b5a678e8d95ddc" title="Loads the install profile, extracting its defined distribution name.">drupal_install_profile_distribution_name</a>())), <a class="code" href="bootstrap_8inc_a90c8d2e0e3b0f4acce7e88c8c60ddbca.html#a90c8d2e0e3b0f4acce7e88c8c60ddbca" title="Flag for drupal_set_title(); text has already been sanitized.">PASS_THROUGH</a>);
<a name="l01499"></a>01499   $messages = <a class="code" href="bootstrap_8inc_ad9223d86c7b08b1288274ce211d9bfa6.html#ad9223d86c7b08b1288274ce211d9bfa6" title="Sets a message to display to the user.">drupal_set_message</a>();
<a name="l01500"></a>01500   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> = <span class="stringliteral">&#39;&lt;p&gt;&#39;</span> . <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Congratulations, you installed @drupal!&#39;</span>, array(<span class="stringliteral">&#39;@drupal&#39;</span> =&gt; <a class="code" href="install_8inc_a52c56958ff42269107b5a678e8d95ddc.html#a52c56958ff42269107b5a678e8d95ddc" title="Loads the install profile, extracting its defined distribution name.">drupal_install_profile_distribution_name</a>())) . <span class="stringliteral">&#39;&lt;/p&gt;&#39;</span>;
<a name="l01501"></a>01501   <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a> .= <span class="stringliteral">&#39;&lt;p&gt;&#39;</span> . (isset($messages[<span class="stringliteral">&#39;error&#39;</span>]) ? <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Review the messages above before visiting &lt;a href=&quot;@url&quot;&gt;your new site&lt;/a&gt;.&#39;</span>, array(<span class="stringliteral">&#39;@url&#39;</span> =&gt; <a class="code" href="common_8inc_a43b2a0594431556db49df980801d8807.html#a43b2a0594431556db49df980801d8807" title="End of &quot;defgroup format&quot;.">url</a>(<span class="stringliteral">&#39;&#39;</span>))) : <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;&lt;a href=&quot;@url&quot;&gt;Visit your new site&lt;/a&gt;.&#39;</span>, array(<span class="stringliteral">&#39;@url&#39;</span> =&gt; <a class="code" href="common_8inc_a43b2a0594431556db49df980801d8807.html#a43b2a0594431556db49df980801d8807" title="End of &quot;defgroup format&quot;.">url</a>(<span class="stringliteral">&#39;&#39;</span>)))) . <span class="stringliteral">&#39;&lt;/p&gt;&#39;</span>;
<a name="l01502"></a>01502 
<a name="l01503"></a>01503   <span class="comment">// Flush all caches to ensure that any full bootstraps during the installer</span>
<a name="l01504"></a>01504   <span class="comment">// do not leave stale cached data, and that any content types or other items</span>
<a name="l01505"></a>01505   <span class="comment">// registered by the install profile are registered correctly.</span>
<a name="l01506"></a>01506   <a class="code" href="common_8inc_ac119432cefbdbb25647944d4ca3f82f8.html#ac119432cefbdbb25647944d4ca3f82f8" title="Flushes all cached data on the site.">drupal_flush_all_caches</a>();
<a name="l01507"></a>01507 
<a name="l01508"></a>01508   <span class="comment">// Remember the profile which was used.</span>
<a name="l01509"></a>01509   <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;install_profile&#39;</span>, <a class="code" href="common_8inc_a4128f0023ccec2d1a9a40987f0131d83.html#a4128f0023ccec2d1a9a40987f0131d83" title="Gets the name of the currently active install profile.">drupal_get_profile</a>());
<a name="l01510"></a>01510 
<a name="l01511"></a>01511   <span class="comment">// Install profiles are always loaded last</span>
<a name="l01512"></a>01512   <a class="code" href="group__database_ga40967197ee5d6a23a5c5a77e627067fe.html#ga40967197ee5d6a23a5c5a77e627067fe" title="Returns a new UpdateQuery object for the active database.">db_update</a>(<span class="stringliteral">&#39;system&#39;</span>)
<a name="l01513"></a>01513     -&gt;fields(array(<span class="stringliteral">&#39;weight&#39;</span> =&gt; 1000))
<a name="l01514"></a>01514     -&gt;condition(<span class="stringliteral">&#39;type&#39;</span>, <span class="stringliteral">&#39;module&#39;</span>)
<a name="l01515"></a>01515     -&gt;condition(<span class="stringliteral">&#39;name&#39;</span>, <a class="code" href="common_8inc_a4128f0023ccec2d1a9a40987f0131d83.html#a4128f0023ccec2d1a9a40987f0131d83" title="Gets the name of the currently active install profile.">drupal_get_profile</a>())
<a name="l01516"></a>01516     -&gt;execute();
<a name="l01517"></a>01517 
<a name="l01518"></a>01518   <span class="comment">// Cache a fully-built schema.</span>
<a name="l01519"></a>01519   <a class="code" href="group__schemaapi_ga979670bd6bd2e34337ffc5f0810f2d71.html#ga979670bd6bd2e34337ffc5f0810f2d71" title="Gets the schema definition of a table, or the whole database schema.">drupal_get_schema</a>(NULL, TRUE);
<a name="l01520"></a>01520 
<a name="l01521"></a>01521   <span class="comment">// Run cron to populate update status tables (if available) so that users</span>
<a name="l01522"></a>01522   <span class="comment">// will be warned if they&#39;ve installed an out of date Drupal version.</span>
<a name="l01523"></a>01523   <span class="comment">// Will also trigger indexing of profile-supplied content or feeds.</span>
<a name="l01524"></a>01524   <a class="code" href="common_8inc_a1d4a4362b30215023a7120b627a9fd4f.html#a1d4a4362b30215023a7120b627a9fd4f" title="Executes a cron run when called.">drupal_cron_run</a>();
<a name="l01525"></a>01525 
<a name="l01526"></a>01526   <span class="keywordflow">return</span> <a class="code" href="authorize_8php_a73004ce9cd673c1bfafd1dc351134797.html#a73004ce9cd673c1bfafd1dc351134797">$output</a>;
<a name="l01527"></a>01527 }
<a name="l01528"></a>01528 
<a name="l01532"></a><a class="code" href="install_8core_8inc_aa0dfff943ef80d5bfad2f0be5c4cff19.html#aa0dfff943ef80d5bfad2f0be5c4cff19">01532</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_aa0dfff943ef80d5bfad2f0be5c4cff19.html#aa0dfff943ef80d5bfad2f0be5c4cff19" title="Batch callback for batch installation of modules.">_install_module_batch</a>($module, $module_name, &amp;$context) {
<a name="l01533"></a>01533   <span class="comment">// Install and enable the module right away, so that the module will be</span>
<a name="l01534"></a>01534   <span class="comment">// loaded by drupal_bootstrap in subsequent batch requests, and other</span>
<a name="l01535"></a>01535   <span class="comment">// modules possibly depending on it can safely perform their installation</span>
<a name="l01536"></a>01536   <span class="comment">// steps.</span>
<a name="l01537"></a>01537   <a class="code" href="module_8inc_a4b2c9ea60d7c88595eaebfc4abd5f1bf.html#a4b2c9ea60d7c88595eaebfc4abd5f1bf" title="Enables or installs a given list of modules.">module_enable</a>(array($module), FALSE);
<a name="l01538"></a>01538   $context[<span class="stringliteral">&#39;results&#39;</span>][] = $module;
<a name="l01539"></a>01539   $context[<span class="stringliteral">&#39;message&#39;</span>] = <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Installed %module module.&#39;</span>, array(<span class="stringliteral">&#39;%module&#39;</span> =&gt; $module_name));
<a name="l01540"></a>01540 }
<a name="l01541"></a>01541 
<a name="l01545"></a><a class="code" href="install_8core_8inc_aa345da0dac456ba24a1551a9ce3ce4dc.html#aa345da0dac456ba24a1551a9ce3ce4dc">01545</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_aa345da0dac456ba24a1551a9ce3ce4dc.html#aa345da0dac456ba24a1551a9ce3ce4dc" title="&#39;Finished&#39; callback for module installation batch.">_install_profile_modules_finished</a>($success, $results, $operations) {
<a name="l01546"></a>01546   <span class="comment">// Flush all caches to complete the module installation process. Subsequent</span>
<a name="l01547"></a>01547   <span class="comment">// installation tasks will now have full access to the profile&#39;s modules.</span>
<a name="l01548"></a>01548   <a class="code" href="common_8inc_ac119432cefbdbb25647944d4ca3f82f8.html#ac119432cefbdbb25647944d4ca3f82f8" title="Flushes all cached data on the site.">drupal_flush_all_caches</a>();
<a name="l01549"></a>01549 }
<a name="l01550"></a>01550 
<a name="l01554"></a><a class="code" href="install_8core_8inc_ae9175b59627ec291ef76fd241f74f33e.html#ae9175b59627ec291ef76fd241f74f33e">01554</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_ae9175b59627ec291ef76fd241f74f33e.html#ae9175b59627ec291ef76fd241f74f33e" title="Checks installation requirements and reports any errors.">install_check_requirements</a>($install_state) {
<a name="l01555"></a>01555   $profile = $install_state[<span class="stringliteral">&#39;parameters&#39;</span>][<span class="stringliteral">&#39;profile&#39;</span>];
<a name="l01556"></a>01556 
<a name="l01557"></a>01557   <span class="comment">// Check the profile requirements.</span>
<a name="l01558"></a>01558   $requirements = <a class="code" href="install_8inc_a836bd8c91fc428e6d7c5bc6306dc6f5c.html#a836bd8c91fc428e6d7c5bc6306dc6f5c" title="Check an install profile&#39;s requirements.">drupal_check_profile</a>($profile);
<a name="l01559"></a>01559 
<a name="l01560"></a>01560   <span class="comment">// If Drupal is not set up already, we need to create a settings file.</span>
<a name="l01561"></a>01561   <span class="keywordflow">if</span> (!$install_state[<span class="stringliteral">&#39;settings_verified&#39;</span>]) {
<a name="l01562"></a>01562     $writable = FALSE;
<a name="l01563"></a>01563     $conf_path = <span class="stringliteral">&#39;./&#39;</span> . <a class="code" href="bootstrap_8inc_acef612ef19c49f6259531f0bee5c26cc.html#acef612ef19c49f6259531f0bee5c26cc" title="Finds the appropriate configuration directory.">conf_path</a>(FALSE, TRUE);
<a name="l01564"></a>01564     $settings_file = $conf_path . <span class="stringliteral">&#39;/settings.php&#39;</span>;
<a name="l01565"></a>01565     $default_settings_file = <span class="stringliteral">&#39;./sites/default/default.settings.php&#39;</span>;
<a name="l01566"></a>01566     $file = $conf_path;
<a name="l01567"></a>01567     $exists = FALSE;
<a name="l01568"></a>01568     <span class="comment">// Verify that the directory exists.</span>
<a name="l01569"></a>01569     <span class="keywordflow">if</span> (<a class="code" href="install_8inc_a604165f37803cd10ac32534e3f8796ed.html#a604165f37803cd10ac32534e3f8796ed" title="Verify the state of the specified file.">drupal_verify_install_file</a>($conf_path, <a class="code" href="install_8inc_ae627ec3bb64949659adbc8cac5ae063e.html#ae627ec3bb64949659adbc8cac5ae063e" title="File permission check -- File exists.">FILE_EXIST</a>, <span class="stringliteral">&#39;dir&#39;</span>)) {
<a name="l01570"></a>01570       <span class="comment">// Check if a settings.php file already exists.</span>
<a name="l01571"></a>01571       $file = $settings_file;
<a name="l01572"></a>01572       <span class="keywordflow">if</span> (<a class="code" href="install_8inc_a604165f37803cd10ac32534e3f8796ed.html#a604165f37803cd10ac32534e3f8796ed" title="Verify the state of the specified file.">drupal_verify_install_file</a>($settings_file, <a class="code" href="install_8inc_ae627ec3bb64949659adbc8cac5ae063e.html#ae627ec3bb64949659adbc8cac5ae063e" title="File permission check -- File exists.">FILE_EXIST</a>)) {
<a name="l01573"></a>01573         <span class="comment">// If it does, make sure it is writable.</span>
<a name="l01574"></a>01574         $writable = <a class="code" href="install_8inc_a604165f37803cd10ac32534e3f8796ed.html#a604165f37803cd10ac32534e3f8796ed" title="Verify the state of the specified file.">drupal_verify_install_file</a>($settings_file, <a class="code" href="install_8inc_a5a3ab6bb8b0df419dff1d9c741e5ca56.html#a5a3ab6bb8b0df419dff1d9c741e5ca56" title="File permission check -- File is readable.">FILE_READABLE</a>|<a class="code" href="install_8inc_a18edb581d332bd2fe379104a39e3b1a2.html#a18edb581d332bd2fe379104a39e3b1a2" title="File permission check -- File is writable.">FILE_WRITABLE</a>);
<a name="l01575"></a>01575         $exists = TRUE;
<a name="l01576"></a>01576       }
<a name="l01577"></a>01577     }
<a name="l01578"></a>01578 
<a name="l01579"></a>01579     <span class="comment">// If default.settings.php does not exist, or is not readable, throw an</span>
<a name="l01580"></a>01580     <span class="comment">// error.</span>
<a name="l01581"></a>01581     <span class="keywordflow">if</span> (!<a class="code" href="install_8inc_a604165f37803cd10ac32534e3f8796ed.html#a604165f37803cd10ac32534e3f8796ed" title="Verify the state of the specified file.">drupal_verify_install_file</a>($default_settings_file, <a class="code" href="install_8inc_ae627ec3bb64949659adbc8cac5ae063e.html#ae627ec3bb64949659adbc8cac5ae063e" title="File permission check -- File exists.">FILE_EXIST</a>|<a class="code" href="install_8inc_a5a3ab6bb8b0df419dff1d9c741e5ca56.html#a5a3ab6bb8b0df419dff1d9c741e5ca56" title="File permission check -- File is readable.">FILE_READABLE</a>)) {
<a name="l01582"></a>01582       $requirements[<span class="stringliteral">&#39;default settings file exists&#39;</span>] = array(
<a name="l01583"></a>01583         <span class="stringliteral">&#39;title&#39;</span>       =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Default settings file&#39;</span>),
<a name="l01584"></a>01584         <span class="stringliteral">&#39;value&#39;</span>       =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;The default settings file does not exist.&#39;</span>),
<a name="l01585"></a>01585         <span class="stringliteral">&#39;severity&#39;</span>    =&gt; <a class="code" href="install_8inc_aeddf02286107904721cb582bd430581d.html#aeddf02286107904721cb582bd430581d" title="Requirement severity -- Error condition; abort installation.">REQUIREMENT_ERROR</a>,
<a name="l01586"></a>01586         <span class="stringliteral">&#39;description&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;The @drupal installer requires that the %default-file file not be modified in any way from the original download.&#39;</span>, array(<span class="stringliteral">&#39;@drupal&#39;</span> =&gt; <a class="code" href="install_8inc_a52c56958ff42269107b5a678e8d95ddc.html#a52c56958ff42269107b5a678e8d95ddc" title="Loads the install profile, extracting its defined distribution name.">drupal_install_profile_distribution_name</a>(), <span class="stringliteral">&#39;%default-file&#39;</span> =&gt; $default_settings_file)),
<a name="l01587"></a>01587       );
<a name="l01588"></a>01588     }
<a name="l01589"></a>01589     <span class="comment">// Otherwise, if settings.php does not exist yet, we can try to copy</span>
<a name="l01590"></a>01590     <span class="comment">// default.settings.php to create it.</span>
<a name="l01591"></a>01591     elseif (!$exists) {
<a name="l01592"></a>01592       $copied = <a class="code" href="install_8inc_a604165f37803cd10ac32534e3f8796ed.html#a604165f37803cd10ac32534e3f8796ed" title="Verify the state of the specified file.">drupal_verify_install_file</a>($conf_path, <a class="code" href="install_8inc_ae627ec3bb64949659adbc8cac5ae063e.html#ae627ec3bb64949659adbc8cac5ae063e" title="File permission check -- File exists.">FILE_EXIST</a>|<a class="code" href="install_8inc_a18edb581d332bd2fe379104a39e3b1a2.html#a18edb581d332bd2fe379104a39e3b1a2" title="File permission check -- File is writable.">FILE_WRITABLE</a>, <span class="stringliteral">&#39;dir&#39;</span>) &amp;&amp; @copy($default_settings_file, $settings_file);
<a name="l01593"></a>01593       <span class="keywordflow">if</span> ($copied) {
<a name="l01594"></a>01594         <span class="comment">// If the new settings file has the same owner as default.settings.php,</span>
<a name="l01595"></a>01595         <span class="comment">// this means default.settings.php is owned by the webserver user.</span>
<a name="l01596"></a>01596         <span class="comment">// This is an inherent security weakness because it allows a malicious</span>
<a name="l01597"></a>01597         <span class="comment">// webserver process to append arbitrary PHP code and then execute it.</span>
<a name="l01598"></a>01598         <span class="comment">// However, it is also a common configuration on shared hosting, and</span>
<a name="l01599"></a>01599         <span class="comment">// there is nothing Drupal can do to prevent it. In this situation,</span>
<a name="l01600"></a>01600         <span class="comment">// having settings.php also owned by the webserver does not introduce</span>
<a name="l01601"></a>01601         <span class="comment">// any additional security risk, so we keep the file in place.</span>
<a name="l01602"></a>01602         <span class="keywordflow">if</span> (fileowner($default_settings_file) === fileowner($settings_file)) {
<a name="l01603"></a>01603           $writable = <a class="code" href="install_8inc_a604165f37803cd10ac32534e3f8796ed.html#a604165f37803cd10ac32534e3f8796ed" title="Verify the state of the specified file.">drupal_verify_install_file</a>($settings_file, <a class="code" href="install_8inc_a5a3ab6bb8b0df419dff1d9c741e5ca56.html#a5a3ab6bb8b0df419dff1d9c741e5ca56" title="File permission check -- File is readable.">FILE_READABLE</a>|<a class="code" href="install_8inc_a18edb581d332bd2fe379104a39e3b1a2.html#a18edb581d332bd2fe379104a39e3b1a2" title="File permission check -- File is writable.">FILE_WRITABLE</a>);
<a name="l01604"></a>01604           $exists = TRUE;
<a name="l01605"></a>01605         }
<a name="l01606"></a>01606         <span class="comment">// If settings.php and default.settings.php have different owners, this</span>
<a name="l01607"></a>01607         <span class="comment">// probably means the server is set up &quot;securely&quot; (with the webserver</span>
<a name="l01608"></a>01608         <span class="comment">// running as its own user, distinct from the user who owns all the</span>
<a name="l01609"></a>01609         <span class="comment">// Drupal PHP files), although with either a group or world writable</span>
<a name="l01610"></a>01610         <span class="comment">// sites directory. Keeping settings.php owned by the webserver would</span>
<a name="l01611"></a>01611         <span class="comment">// therefore introduce a security risk. It would also cause a usability</span>
<a name="l01612"></a>01612         <span class="comment">// problem, since site owners who do not have root access to the file</span>
<a name="l01613"></a>01613         <span class="comment">// system would be unable to edit their settings file later on. We</span>
<a name="l01614"></a>01614         <span class="comment">// therefore must delete the file we just created and force the</span>
<a name="l01615"></a>01615         <span class="comment">// administrator to log on to the server and create it manually.</span>
<a name="l01616"></a>01616         <span class="keywordflow">else</span> {
<a name="l01617"></a>01617           $deleted = @<a class="code" href="group__php__wrappers_ga533bc32da8860919d20d60ada655e494.html#ga533bc32da8860919d20d60ada655e494" title="Deletes a file.">drupal_unlink</a>($settings_file);
<a name="l01618"></a>01618           <span class="comment">// We expect deleting the file to be successful (since we just</span>
<a name="l01619"></a>01619           <span class="comment">// created it ourselves above), but if it fails somehow, we set a</span>
<a name="l01620"></a>01620           <span class="comment">// variable so we can display a one-time error message to the</span>
<a name="l01621"></a>01621           <span class="comment">// administrator at the bottom of the requirements list. We also try</span>
<a name="l01622"></a>01622           <span class="comment">// to make the file writable, to eliminate any conflicting error</span>
<a name="l01623"></a>01623           <span class="comment">// messages in the requirements list.</span>
<a name="l01624"></a>01624           $exists = !$deleted;
<a name="l01625"></a>01625           <span class="keywordflow">if</span> ($exists) {
<a name="l01626"></a>01626             $settings_file_ownership_error = TRUE;
<a name="l01627"></a>01627             $writable = <a class="code" href="install_8inc_a604165f37803cd10ac32534e3f8796ed.html#a604165f37803cd10ac32534e3f8796ed" title="Verify the state of the specified file.">drupal_verify_install_file</a>($settings_file, <a class="code" href="install_8inc_a5a3ab6bb8b0df419dff1d9c741e5ca56.html#a5a3ab6bb8b0df419dff1d9c741e5ca56" title="File permission check -- File is readable.">FILE_READABLE</a>|<a class="code" href="install_8inc_a18edb581d332bd2fe379104a39e3b1a2.html#a18edb581d332bd2fe379104a39e3b1a2" title="File permission check -- File is writable.">FILE_WRITABLE</a>);
<a name="l01628"></a>01628           }
<a name="l01629"></a>01629         }
<a name="l01630"></a>01630       }
<a name="l01631"></a>01631     }
<a name="l01632"></a>01632 
<a name="l01633"></a>01633     <span class="comment">// If settings.php does not exist, throw an error.</span>
<a name="l01634"></a>01634     <span class="keywordflow">if</span> (!$exists) {
<a name="l01635"></a>01635       $requirements[<span class="stringliteral">&#39;settings file exists&#39;</span>] = array(
<a name="l01636"></a>01636         <span class="stringliteral">&#39;title&#39;</span>       =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Settings file&#39;</span>),
<a name="l01637"></a>01637         <span class="stringliteral">&#39;value&#39;</span>       =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;The settings file does not exist.&#39;</span>),
<a name="l01638"></a>01638         <span class="stringliteral">&#39;severity&#39;</span>    =&gt; <a class="code" href="install_8inc_aeddf02286107904721cb582bd430581d.html#aeddf02286107904721cb582bd430581d" title="Requirement severity -- Error condition; abort installation.">REQUIREMENT_ERROR</a>,
<a name="l01639"></a>01639         <span class="stringliteral">&#39;description&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;The @drupal installer requires that you create a settings file as part of the installation process. Copy the %default_file file to %file. More details about installing Drupal are available in &lt;a href=&quot;@install_txt&quot;&gt;INSTALL.txt&lt;/a&gt;.&#39;</span>, array(<span class="stringliteral">&#39;@drupal&#39;</span> =&gt; <a class="code" href="install_8inc_a52c56958ff42269107b5a678e8d95ddc.html#a52c56958ff42269107b5a678e8d95ddc" title="Loads the install profile, extracting its defined distribution name.">drupal_install_profile_distribution_name</a>(), <span class="stringliteral">&#39;%file&#39;</span> =&gt; $file, <span class="stringliteral">&#39;%default_file&#39;</span> =&gt; $default_settings_file, <span class="stringliteral">&#39;@install_txt&#39;</span> =&gt; <a class="code" href="common_8inc_ae227697e9c239f09fd7e36f71afde771.html#ae227697e9c239f09fd7e36f71afde771" title="Returns the base URL path (i.e., directory) of the Drupal installation.">base_path</a>() . <span class="stringliteral">&#39;INSTALL.txt&#39;</span>)),
<a name="l01640"></a>01640       );
<a name="l01641"></a>01641     }
<a name="l01642"></a>01642     <span class="keywordflow">else</span> {
<a name="l01643"></a>01643       $requirements[<span class="stringliteral">&#39;settings file exists&#39;</span>] = array(
<a name="l01644"></a>01644         <span class="stringliteral">&#39;title&#39;</span>       =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Settings file&#39;</span>),
<a name="l01645"></a>01645         <span class="stringliteral">&#39;value&#39;</span>       =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;The %file file exists.&#39;</span>, array(<span class="stringliteral">&#39;%file&#39;</span> =&gt; $file)),
<a name="l01646"></a>01646       );
<a name="l01647"></a>01647       <span class="comment">// If settings.php is not writable, throw an error.</span>
<a name="l01648"></a>01648       <span class="keywordflow">if</span> (!$writable) {
<a name="l01649"></a>01649         $requirements[<span class="stringliteral">&#39;settings file writable&#39;</span>] = array(
<a name="l01650"></a>01650           <span class="stringliteral">&#39;title&#39;</span>       =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Settings file&#39;</span>),
<a name="l01651"></a>01651           <span class="stringliteral">&#39;value&#39;</span>       =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;The settings file is not writable.&#39;</span>),
<a name="l01652"></a>01652           <span class="stringliteral">&#39;severity&#39;</span>    =&gt; <a class="code" href="install_8inc_aeddf02286107904721cb582bd430581d.html#aeddf02286107904721cb582bd430581d" title="Requirement severity -- Error condition; abort installation.">REQUIREMENT_ERROR</a>,
<a name="l01653"></a>01653           <span class="stringliteral">&#39;description&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;The @drupal installer requires write permissions to %file during the installation process. If you are unsure how to grant file permissions, consult the &lt;a href=&quot;@handbook_url&quot;&gt;online handbook&lt;/a&gt;.&#39;</span>, array(<span class="stringliteral">&#39;@drupal&#39;</span> =&gt; <a class="code" href="install_8inc_a52c56958ff42269107b5a678e8d95ddc.html#a52c56958ff42269107b5a678e8d95ddc" title="Loads the install profile, extracting its defined distribution name.">drupal_install_profile_distribution_name</a>(), <span class="stringliteral">&#39;%file&#39;</span> =&gt; $file, <span class="stringliteral">&#39;@handbook_url&#39;</span> =&gt; <span class="stringliteral">&#39;http://drupal.org/server-permissions&#39;</span>)),
<a name="l01654"></a>01654         );
<a name="l01655"></a>01655       }
<a name="l01656"></a>01656       <span class="keywordflow">else</span> {
<a name="l01657"></a>01657         $requirements[<span class="stringliteral">&#39;settings file&#39;</span>] = array(
<a name="l01658"></a>01658           <span class="stringliteral">&#39;title&#39;</span>       =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Settings file&#39;</span>),
<a name="l01659"></a>01659           <span class="stringliteral">&#39;value&#39;</span>       =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;The settings file is writable.&#39;</span>),
<a name="l01660"></a>01660         );
<a name="l01661"></a>01661       }
<a name="l01662"></a>01662       <span class="keywordflow">if</span> (!empty($settings_file_ownership_error)) {
<a name="l01663"></a>01663         $requirements[<span class="stringliteral">&#39;settings file ownership&#39;</span>] = array(
<a name="l01664"></a>01664           <span class="stringliteral">&#39;title&#39;</span>       =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Settings file&#39;</span>),
<a name="l01665"></a>01665           <span class="stringliteral">&#39;value&#39;</span>       =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;The settings file is owned by the web server.&#39;</span>),
<a name="l01666"></a>01666           <span class="stringliteral">&#39;severity&#39;</span>    =&gt; <a class="code" href="install_8inc_aeddf02286107904721cb582bd430581d.html#aeddf02286107904721cb582bd430581d" title="Requirement severity -- Error condition; abort installation.">REQUIREMENT_ERROR</a>,
<a name="l01667"></a>01667           <span class="stringliteral">&#39;description&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;The @drupal installer failed to create a settings file with proper file ownership. Log on to your web server, remove the existing %file file, and create a new one by copying the %default_file file to %file. More details about installing Drupal are available in &lt;a href=&quot;@install_txt&quot;&gt;INSTALL.txt&lt;/a&gt;. If you have problems with the file permissions on your server, consult the &lt;a href=&quot;@handbook_url&quot;&gt;online handbook&lt;/a&gt;.&#39;</span>, array(<span class="stringliteral">&#39;@drupal&#39;</span> =&gt; <a class="code" href="install_8inc_a52c56958ff42269107b5a678e8d95ddc.html#a52c56958ff42269107b5a678e8d95ddc" title="Loads the install profile, extracting its defined distribution name.">drupal_install_profile_distribution_name</a>(), <span class="stringliteral">&#39;%file&#39;</span> =&gt; $file, <span class="stringliteral">&#39;%default_file&#39;</span> =&gt; $default_settings_file, <span class="stringliteral">&#39;@install_txt&#39;</span> =&gt; <a class="code" href="common_8inc_ae227697e9c239f09fd7e36f71afde771.html#ae227697e9c239f09fd7e36f71afde771" title="Returns the base URL path (i.e., directory) of the Drupal installation.">base_path</a>() . <span class="stringliteral">&#39;INSTALL.txt&#39;</span>, <span class="stringliteral">&#39;@handbook_url&#39;</span> =&gt; <span class="stringliteral">&#39;http://drupal.org/server-permissions&#39;</span>)),
<a name="l01668"></a>01668         );
<a name="l01669"></a>01669       }
<a name="l01670"></a>01670     }
<a name="l01671"></a>01671   }
<a name="l01672"></a>01672   <span class="keywordflow">return</span> $requirements;
<a name="l01673"></a>01673 }
<a name="l01674"></a>01674 
<a name="l01678"></a><a class="code" href="install_8core_8inc_a21b381d33cf055bce4286d99dafad24b.html#a21b381d33cf055bce4286d99dafad24b">01678</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a21b381d33cf055bce4286d99dafad24b.html#a21b381d33cf055bce4286d99dafad24b" title="Forms API array definition for site configuration.">_install_configure_form</a>($form, &amp;$form_state, &amp;$install_state) {
<a name="l01679"></a>01679   include_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/locale.inc&#39;</span>;
<a name="l01680"></a>01680 
<a name="l01681"></a>01681   $form[<span class="stringliteral">&#39;site_information&#39;</span>] = array(
<a name="l01682"></a>01682     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;fieldset&#39;</span>,
<a name="l01683"></a>01683     <span class="stringliteral">&#39;#title&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Site information&#39;</span>),
<a name="l01684"></a>01684     <span class="stringliteral">&#39;#collapsible&#39;</span> =&gt; FALSE,
<a name="l01685"></a>01685   );
<a name="l01686"></a>01686   $form[<span class="stringliteral">&#39;site_information&#39;</span>][<span class="stringliteral">&#39;site_name&#39;</span>] = array(
<a name="l01687"></a>01687     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;textfield&#39;</span>,
<a name="l01688"></a>01688     <span class="stringliteral">&#39;#title&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Site name&#39;</span>),
<a name="l01689"></a>01689     <span class="stringliteral">&#39;#required&#39;</span> =&gt; TRUE,
<a name="l01690"></a>01690     <span class="stringliteral">&#39;#weight&#39;</span> =&gt; -20,
<a name="l01691"></a>01691   );
<a name="l01692"></a>01692   $form[<span class="stringliteral">&#39;site_information&#39;</span>][<span class="stringliteral">&#39;site_mail&#39;</span>] = array(
<a name="l01693"></a>01693     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;textfield&#39;</span>,
<a name="l01694"></a>01694     <span class="stringliteral">&#39;#title&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Site e-mail address&#39;</span>),
<a name="l01695"></a>01695     <span class="stringliteral">&#39;#default_value&#39;</span> =&gt; ini_get(<span class="stringliteral">&#39;sendmail_from&#39;</span>),
<a name="l01696"></a>01696     <span class="stringliteral">&#39;#description&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&quot;Automated e-mails, such as registration information, will be sent from this address. Use an address ending in your site&#39;s domain to help prevent these e-mails from being flagged as spam.&quot;</span>),
<a name="l01697"></a>01697     <span class="stringliteral">&#39;#required&#39;</span> =&gt; TRUE,
<a name="l01698"></a>01698     <span class="stringliteral">&#39;#weight&#39;</span> =&gt; -15,
<a name="l01699"></a>01699   );
<a name="l01700"></a>01700   $form[<span class="stringliteral">&#39;admin_account&#39;</span>] = array(
<a name="l01701"></a>01701     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;fieldset&#39;</span>,
<a name="l01702"></a>01702     <span class="stringliteral">&#39;#title&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Site maintenance account&#39;</span>),
<a name="l01703"></a>01703     <span class="stringliteral">&#39;#collapsible&#39;</span> =&gt; FALSE,
<a name="l01704"></a>01704   );
<a name="l01705"></a>01705 
<a name="l01706"></a>01706   $form[<span class="stringliteral">&#39;admin_account&#39;</span>][<span class="stringliteral">&#39;account&#39;</span>][<span class="stringliteral">&#39;#tree&#39;</span>] = TRUE;
<a name="l01707"></a>01707   $form[<span class="stringliteral">&#39;admin_account&#39;</span>][<span class="stringliteral">&#39;account&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>] = array(<span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;textfield&#39;</span>,
<a name="l01708"></a>01708     <span class="stringliteral">&#39;#title&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Username&#39;</span>),
<a name="l01709"></a>01709     <span class="stringliteral">&#39;#maxlength&#39;</span> =&gt; USERNAME_MAX_LENGTH,
<a name="l01710"></a>01710     <span class="stringliteral">&#39;#description&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Spaces are allowed; punctuation is not allowed except for periods, hyphens, and underscores.&#39;</span>),
<a name="l01711"></a>01711     <span class="stringliteral">&#39;#required&#39;</span> =&gt; TRUE,
<a name="l01712"></a>01712     <span class="stringliteral">&#39;#weight&#39;</span> =&gt; -10,
<a name="l01713"></a>01713     <span class="stringliteral">&#39;#attributes&#39;</span> =&gt; array(<span class="stringliteral">&#39;class&#39;</span> =&gt; array(<span class="stringliteral">&#39;username&#39;</span>)),
<a name="l01714"></a>01714   );
<a name="l01715"></a>01715 
<a name="l01716"></a>01716   $form[<span class="stringliteral">&#39;admin_account&#39;</span>][<span class="stringliteral">&#39;account&#39;</span>][<span class="stringliteral">&#39;mail&#39;</span>] = array(<span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;textfield&#39;</span>,
<a name="l01717"></a>01717     <span class="stringliteral">&#39;#title&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;E-mail address&#39;</span>),
<a name="l01718"></a>01718     <span class="stringliteral">&#39;#maxlength&#39;</span> =&gt; EMAIL_MAX_LENGTH,
<a name="l01719"></a>01719     <span class="stringliteral">&#39;#required&#39;</span> =&gt; TRUE,
<a name="l01720"></a>01720     <span class="stringliteral">&#39;#weight&#39;</span> =&gt; -5,
<a name="l01721"></a>01721   );
<a name="l01722"></a>01722   $form[<span class="stringliteral">&#39;admin_account&#39;</span>][<span class="stringliteral">&#39;account&#39;</span>][<span class="stringliteral">&#39;pass&#39;</span>] = array(
<a name="l01723"></a>01723     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;password_confirm&#39;</span>,
<a name="l01724"></a>01724     <span class="stringliteral">&#39;#required&#39;</span> =&gt; TRUE,
<a name="l01725"></a>01725     <span class="stringliteral">&#39;#size&#39;</span> =&gt; 25,
<a name="l01726"></a>01726     <span class="stringliteral">&#39;#weight&#39;</span> =&gt; 0,
<a name="l01727"></a>01727   );
<a name="l01728"></a>01728 
<a name="l01729"></a>01729   $form[<span class="stringliteral">&#39;server_settings&#39;</span>] = array(
<a name="l01730"></a>01730     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;fieldset&#39;</span>,
<a name="l01731"></a>01731     <span class="stringliteral">&#39;#title&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Server settings&#39;</span>),
<a name="l01732"></a>01732     <span class="stringliteral">&#39;#collapsible&#39;</span> =&gt; FALSE,
<a name="l01733"></a>01733   );
<a name="l01734"></a>01734 
<a name="l01735"></a>01735   $countries = <a class="code" href="locale_8inc_a53c04ad515e4f3eace3532fcdbedb834.html#a53c04ad515e4f3eace3532fcdbedb834" title="End of &quot;locale-autoimport&quot;.">country_get_list</a>();
<a name="l01736"></a>01736   $form[<span class="stringliteral">&#39;server_settings&#39;</span>][<span class="stringliteral">&#39;site_default_country&#39;</span>] = array(
<a name="l01737"></a>01737     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;select&#39;</span>,
<a name="l01738"></a>01738     <span class="stringliteral">&#39;#title&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Default country&#39;</span>),
<a name="l01739"></a>01739     <span class="stringliteral">&#39;#empty_value&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l01740"></a>01740     <span class="stringliteral">&#39;#default_value&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;site_default_country&#39;</span>, NULL),
<a name="l01741"></a>01741     <span class="stringliteral">&#39;#options&#39;</span> =&gt; $countries,
<a name="l01742"></a>01742     <span class="stringliteral">&#39;#description&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Select the default country for the site.&#39;</span>),
<a name="l01743"></a>01743     <span class="stringliteral">&#39;#weight&#39;</span> =&gt; 0,
<a name="l01744"></a>01744   );
<a name="l01745"></a>01745 
<a name="l01746"></a>01746   $form[<span class="stringliteral">&#39;server_settings&#39;</span>][<span class="stringliteral">&#39;date_default_timezone&#39;</span>] = array(
<a name="l01747"></a>01747     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;select&#39;</span>,
<a name="l01748"></a>01748     <span class="stringliteral">&#39;#title&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Default time zone&#39;</span>),
<a name="l01749"></a>01749     <span class="stringliteral">&#39;#default_value&#39;</span> =&gt; date_default_timezone_get(),
<a name="l01750"></a>01750     <span class="stringliteral">&#39;#options&#39;</span> =&gt; system_time_zones(),
<a name="l01751"></a>01751     <span class="stringliteral">&#39;#description&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;By default, dates in this site will be displayed in the chosen time zone.&#39;</span>),
<a name="l01752"></a>01752     <span class="stringliteral">&#39;#weight&#39;</span> =&gt; 5,
<a name="l01753"></a>01753     <span class="stringliteral">&#39;#attributes&#39;</span> =&gt; array(<span class="stringliteral">&#39;class&#39;</span> =&gt; array(<span class="stringliteral">&#39;timezone-detect&#39;</span>)),
<a name="l01754"></a>01754   );
<a name="l01755"></a>01755 
<a name="l01756"></a>01756   $form[<span class="stringliteral">&#39;server_settings&#39;</span>][<span class="stringliteral">&#39;clean_url&#39;</span>] = array(
<a name="l01757"></a>01757     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;hidden&#39;</span>,
<a name="l01758"></a>01758     <span class="stringliteral">&#39;#default_value&#39;</span> =&gt; 0,
<a name="l01759"></a>01759     <span class="stringliteral">&#39;#attributes&#39;</span> =&gt; array(<span class="stringliteral">&#39;id&#39;</span> =&gt; <span class="stringliteral">&#39;edit-clean-url&#39;</span>, <span class="stringliteral">&#39;class&#39;</span> =&gt; array(<span class="stringliteral">&#39;install&#39;</span>)),
<a name="l01760"></a>01760   );
<a name="l01761"></a>01761 
<a name="l01762"></a>01762   $form[<span class="stringliteral">&#39;update_notifications&#39;</span>] = array(
<a name="l01763"></a>01763     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;fieldset&#39;</span>,
<a name="l01764"></a>01764     <span class="stringliteral">&#39;#title&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Update notifications&#39;</span>),
<a name="l01765"></a>01765     <span class="stringliteral">&#39;#collapsible&#39;</span> =&gt; FALSE,
<a name="l01766"></a>01766   );
<a name="l01767"></a>01767   $form[<span class="stringliteral">&#39;update_notifications&#39;</span>][<span class="stringliteral">&#39;update_status_module&#39;</span>] = array(
<a name="l01768"></a>01768     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;checkboxes&#39;</span>,
<a name="l01769"></a>01769     <span class="stringliteral">&#39;#options&#39;</span> =&gt; array(
<a name="l01770"></a>01770       1 =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Check for updates automatically&#39;</span>),
<a name="l01771"></a>01771       2 =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Receive e-mail notifications&#39;</span>),
<a name="l01772"></a>01772     ),
<a name="l01773"></a>01773     <span class="stringliteral">&#39;#default_value&#39;</span> =&gt; array(1, 2),
<a name="l01774"></a>01774     <span class="stringliteral">&#39;#description&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;The system will notify you when updates and important security releases are available for installed components. Anonymous information about your site is sent to &lt;a href=&quot;@drupal&quot;&gt;Drupal.org&lt;/a&gt;.&#39;</span>, array(<span class="stringliteral">&#39;@drupal&#39;</span> =&gt; <span class="stringliteral">&#39;http://drupal.org&#39;</span>)),
<a name="l01775"></a>01775     <span class="stringliteral">&#39;#weight&#39;</span> =&gt; 15,
<a name="l01776"></a>01776   );
<a name="l01777"></a>01777 
<a name="l01778"></a>01778   $form[<span class="stringliteral">&#39;actions&#39;</span>] = array(<span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;actions&#39;</span>);
<a name="l01779"></a>01779   $form[<span class="stringliteral">&#39;actions&#39;</span>][<span class="stringliteral">&#39;submit&#39;</span>] = array(
<a name="l01780"></a>01780     <span class="stringliteral">&#39;#type&#39;</span> =&gt; <span class="stringliteral">&#39;submit&#39;</span>,
<a name="l01781"></a>01781     <span class="stringliteral">&#39;#value&#39;</span> =&gt; <a class="code" href="group__sanitization_gabc78d1b88aa8081093abbbf71a516c7c.html#gabc78d1b88aa8081093abbbf71a516c7c" title="Functional equivalent of t(), used when some systems are not available.">st</a>(<span class="stringliteral">&#39;Save and continue&#39;</span>),
<a name="l01782"></a>01782     <span class="stringliteral">&#39;#weight&#39;</span> =&gt; 15,
<a name="l01783"></a>01783   );
<a name="l01784"></a>01784 
<a name="l01785"></a>01785   <span class="keywordflow">return</span> $form;
<a name="l01786"></a>01786 }
<a name="l01787"></a>01787 
<a name="l01791"></a><a class="code" href="install_8core_8inc_a6b3794048999c91eed0b6a7633a8e8f3.html#a6b3794048999c91eed0b6a7633a8e8f3">01791</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_a6b3794048999c91eed0b6a7633a8e8f3.html#a6b3794048999c91eed0b6a7633a8e8f3" title="Forms API validate for the site configuration form.">install_configure_form_validate</a>($form, &amp;$form_state) {
<a name="l01792"></a>01792   <span class="keywordflow">if</span> ($error = user_validate_name($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;account&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>])) {
<a name="l01793"></a>01793     <a class="code" href="group__form__api_ga0e6b470194005ad3ff2fbf45f671dfa9.html#ga0e6b470194005ad3ff2fbf45f671dfa9" title="Flags an element as having an error.">form_error</a>($form[<span class="stringliteral">&#39;admin_account&#39;</span>][<span class="stringliteral">&#39;account&#39;</span>][<span class="stringliteral">&#39;name&#39;</span>], $error);
<a name="l01794"></a>01794   }
<a name="l01795"></a>01795   <span class="keywordflow">if</span> ($error = user_validate_mail($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;account&#39;</span>][<span class="stringliteral">&#39;mail&#39;</span>])) {
<a name="l01796"></a>01796     <a class="code" href="group__form__api_ga0e6b470194005ad3ff2fbf45f671dfa9.html#ga0e6b470194005ad3ff2fbf45f671dfa9" title="Flags an element as having an error.">form_error</a>($form[<span class="stringliteral">&#39;admin_account&#39;</span>][<span class="stringliteral">&#39;account&#39;</span>][<span class="stringliteral">&#39;mail&#39;</span>], $error);
<a name="l01797"></a>01797   }
<a name="l01798"></a>01798   <span class="keywordflow">if</span> ($error = user_validate_mail($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;site_mail&#39;</span>])) {
<a name="l01799"></a>01799     <a class="code" href="group__form__api_ga0e6b470194005ad3ff2fbf45f671dfa9.html#ga0e6b470194005ad3ff2fbf45f671dfa9" title="Flags an element as having an error.">form_error</a>($form[<span class="stringliteral">&#39;site_information&#39;</span>][<span class="stringliteral">&#39;site_mail&#39;</span>], $error);
<a name="l01800"></a>01800   }
<a name="l01801"></a>01801 }
<a name="l01802"></a>01802 
<a name="l01806"></a><a class="code" href="install_8core_8inc_ac4774b453669916d9ffbb619b4bf9717.html#ac4774b453669916d9ffbb619b4bf9717">01806</a> <span class="keyword">function</span> <a class="code" href="install_8core_8inc_ac4774b453669916d9ffbb619b4bf9717.html#ac4774b453669916d9ffbb619b4bf9717" title="Forms API submit for the site configuration form.">install_configure_form_submit</a>($form, &amp;$form_state) {
<a name="l01807"></a>01807   global $user;
<a name="l01808"></a>01808 
<a name="l01809"></a>01809   <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;site_name&#39;</span>, $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;site_name&#39;</span>]);
<a name="l01810"></a>01810   <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;site_mail&#39;</span>, $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;site_mail&#39;</span>]);
<a name="l01811"></a>01811   <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;date_default_timezone&#39;</span>, $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;date_default_timezone&#39;</span>]);
<a name="l01812"></a>01812   <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;site_default_country&#39;</span>, $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;site_default_country&#39;</span>]);
<a name="l01813"></a>01813 
<a name="l01814"></a>01814   <span class="comment">// Enable update.module if this option was selected.</span>
<a name="l01815"></a>01815   <span class="keywordflow">if</span> ($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;update_status_module&#39;</span>][1]) {
<a name="l01816"></a>01816     <a class="code" href="module_8inc_a4b2c9ea60d7c88595eaebfc4abd5f1bf.html#a4b2c9ea60d7c88595eaebfc4abd5f1bf" title="Enables or installs a given list of modules.">module_enable</a>(array(<span class="stringliteral">&#39;update&#39;</span>), FALSE);
<a name="l01817"></a>01817 
<a name="l01818"></a>01818     <span class="comment">// Add the site maintenance account&#39;s email address to the list of</span>
<a name="l01819"></a>01819     <span class="comment">// addresses to be notified when updates are available, if selected.</span>
<a name="l01820"></a>01820     <span class="keywordflow">if</span> ($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;update_status_module&#39;</span>][2]) {
<a name="l01821"></a>01821       <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;update_notify_emails&#39;</span>, array($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;account&#39;</span>][<span class="stringliteral">&#39;mail&#39;</span>]));
<a name="l01822"></a>01822     }
<a name="l01823"></a>01823   }
<a name="l01824"></a>01824 
<a name="l01825"></a>01825   <span class="comment">// We precreated user 1 with placeholder values. Let&#39;s save the real values.</span>
<a name="l01826"></a>01826   $account = user_load(1);
<a name="l01827"></a>01827   $merge_data = array(<span class="stringliteral">&#39;init&#39;</span> =&gt; $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;account&#39;</span>][<span class="stringliteral">&#39;mail&#39;</span>], <span class="stringliteral">&#39;roles&#39;</span> =&gt; !empty($account-&gt;roles) ? $account-&gt;roles : array(), <span class="stringliteral">&#39;status&#39;</span> =&gt; 1, <span class="stringliteral">&#39;timezone&#39;</span> =&gt; $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;date_default_timezone&#39;</span>]);
<a name="l01828"></a>01828   user_save($account, array_merge($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;account&#39;</span>], $merge_data));
<a name="l01829"></a>01829   <span class="comment">// Load global $user and perform final login tasks.</span>
<a name="l01830"></a>01830   $user = user_load(1);
<a name="l01831"></a>01831   user_login_finalize();
<a name="l01832"></a>01832 
<a name="l01833"></a>01833   <span class="keywordflow">if</span> (isset($form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;clean_url&#39;</span>])) {
<a name="l01834"></a>01834     <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;clean_url&#39;</span>, $form_state[<span class="stringliteral">&#39;values&#39;</span>][<span class="stringliteral">&#39;clean_url&#39;</span>]);
<a name="l01835"></a>01835   }
<a name="l01836"></a>01836 
<a name="l01837"></a>01837   <span class="comment">// Record when this install ran.</span>
<a name="l01838"></a>01838   <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;install_time&#39;</span>, $_SERVER[<span class="stringliteral">&#39;REQUEST_TIME&#39;</span>]);
<a name="l01839"></a>01839 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Thu Nov 22 2012 16:46:14 for Shopcart by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>

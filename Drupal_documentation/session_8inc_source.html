<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Shopcart: includes/session.inc Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Shopcart
   &#160;<span id="projectnumber">version2.0</span>
   </div>
   <div id="projectbrief">Shoppingcart</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_5b89693129504707d608c5412e7b88d4.html">includes</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">session.inc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="session_8inc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00031"></a><a class="code" href="session_8inc_ac8852f85f169dfbee885d44239a6048c.html#ac8852f85f169dfbee885d44239a6048c">00031</a> <span class="keyword">function</span> <a class="code" href="session_8inc_ac8852f85f169dfbee885d44239a6048c.html#ac8852f85f169dfbee885d44239a6048c" title="Session handler assigned by session_set_save_handler().">_drupal_session_open</a>() {
<a name="l00032"></a>00032   <span class="keywordflow">return</span> TRUE;
<a name="l00033"></a>00033 }
<a name="l00034"></a>00034 
<a name="l00047"></a><a class="code" href="session_8inc_a442fb2eb576d761183c100cdd1c078fd.html#a442fb2eb576d761183c100cdd1c078fd">00047</a> <span class="keyword">function</span> <a class="code" href="session_8inc_a442fb2eb576d761183c100cdd1c078fd.html#a442fb2eb576d761183c100cdd1c078fd" title="Session handler assigned by session_set_save_handler().">_drupal_session_close</a>() {
<a name="l00048"></a>00048   <span class="keywordflow">return</span> TRUE;
<a name="l00049"></a>00049 }
<a name="l00050"></a>00050 
<a name="l00070"></a><a class="code" href="session_8inc_aeb991b6399401804bd0072e5ee6e4741.html#aeb991b6399401804bd0072e5ee6e4741">00070</a> <span class="keyword">function</span> <a class="code" href="session_8inc_aeb991b6399401804bd0072e5ee6e4741.html#aeb991b6399401804bd0072e5ee6e4741" title="Reads an entire session from the database (internal use only).">_drupal_session_read</a>($sid) {
<a name="l00071"></a>00071   global $user, $is_https;
<a name="l00072"></a>00072 
<a name="l00073"></a>00073   <span class="comment">// Write and Close handlers are called after destructing objects</span>
<a name="l00074"></a>00074   <span class="comment">// since PHP 5.0.5.</span>
<a name="l00075"></a>00075   <span class="comment">// Thus destructors can use sessions but session handler can&#39;t use objects.</span>
<a name="l00076"></a>00076   <span class="comment">// So we are moving session closure before destructing objects.</span>
<a name="l00077"></a>00077   <a class="code" href="group__php__wrappers_gac7eaf11b49995f7f539f5c830a65b34f.html#gac7eaf11b49995f7f539f5c830a65b34f" title="Registers a function for execution on shutdown.">drupal_register_shutdown_function</a>(<span class="stringliteral">&#39;session_write_close&#39;</span>);
<a name="l00078"></a>00078 
<a name="l00079"></a>00079   <span class="comment">// Handle the case of first time visitors and clients that don&#39;t store</span>
<a name="l00080"></a>00080   <span class="comment">// cookies (eg. web crawlers).</span>
<a name="l00081"></a>00081   $insecure_session_name = substr(session_name(), 1);
<a name="l00082"></a>00082   <span class="keywordflow">if</span> (!isset($_COOKIE[session_name()]) &amp;&amp; !isset($_COOKIE[$insecure_session_name])) {
<a name="l00083"></a>00083     $user = <a class="code" href="bootstrap_8inc_a9ad783f833f89bccb8ca03e960e3d33d.html#a9ad783f833f89bccb8ca03e960e3d33d" title="Generates a default anonymous $user object.">drupal_anonymous_user</a>();
<a name="l00084"></a>00084     <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00085"></a>00085   }
<a name="l00086"></a>00086 
<a name="l00087"></a>00087   <span class="comment">// Otherwise, if the session is still active, we have a record of the</span>
<a name="l00088"></a>00088   <span class="comment">// client&#39;s session in the database. If it&#39;s HTTPS then we are either have</span>
<a name="l00089"></a>00089   <span class="comment">// a HTTPS session or we are about to log in so we check the sessions table</span>
<a name="l00090"></a>00090   <span class="comment">// for an anonymous session with the non-HTTPS-only cookie.</span>
<a name="l00091"></a>00091   <span class="keywordflow">if</span> ($is_https) {
<a name="l00092"></a>00092     $user = <a class="code" href="group__database_gafa3b6cb2b2f61479cc63a4150c62da9b.html#gafa3b6cb2b2f61479cc63a4150c62da9b" title="The following utility functions are simply convenience wrappers.">db_query</a>(<span class="stringliteral">&quot;SELECT u.*, s.* FROM {users} u INNER JOIN {sessions} s ON u.uid = s.uid WHERE s.ssid = :ssid&quot;</span>, array(<span class="stringliteral">&#39;:ssid&#39;</span> =&gt; $sid))-&gt;fetchObject();
<a name="l00093"></a>00093     <span class="keywordflow">if</span> (!$user) {
<a name="l00094"></a>00094       <span class="keywordflow">if</span> (isset($_COOKIE[$insecure_session_name])) {
<a name="l00095"></a>00095         $user = <a class="code" href="group__database_gafa3b6cb2b2f61479cc63a4150c62da9b.html#gafa3b6cb2b2f61479cc63a4150c62da9b" title="The following utility functions are simply convenience wrappers.">db_query</a>(<span class="stringliteral">&quot;SELECT u.*, s.* FROM {users} u INNER JOIN {sessions} s ON u.uid = s.uid WHERE s.sid = :sid AND s.uid = 0&quot;</span>, array(
<a name="l00096"></a>00096         <span class="stringliteral">&#39;:sid&#39;</span> =&gt; $_COOKIE[$insecure_session_name]))
<a name="l00097"></a>00097         -&gt;fetchObject();
<a name="l00098"></a>00098       }
<a name="l00099"></a>00099     }
<a name="l00100"></a>00100   }
<a name="l00101"></a>00101   <span class="keywordflow">else</span> {
<a name="l00102"></a>00102     $user = <a class="code" href="group__database_gafa3b6cb2b2f61479cc63a4150c62da9b.html#gafa3b6cb2b2f61479cc63a4150c62da9b" title="The following utility functions are simply convenience wrappers.">db_query</a>(<span class="stringliteral">&quot;SELECT u.*, s.* FROM {users} u INNER JOIN {sessions} s ON u.uid = s.uid WHERE s.sid = :sid&quot;</span>, array(<span class="stringliteral">&#39;:sid&#39;</span> =&gt; $sid))-&gt;fetchObject();
<a name="l00103"></a>00103   }
<a name="l00104"></a>00104 
<a name="l00105"></a>00105   <span class="comment">// We found the client&#39;s session record and they are an authenticated,</span>
<a name="l00106"></a>00106   <span class="comment">// active user.</span>
<a name="l00107"></a>00107   <span class="keywordflow">if</span> ($user &amp;&amp; $user-&gt;uid &gt; 0 &amp;&amp; $user-&gt;status == 1) {
<a name="l00108"></a>00108     <span class="comment">// This is done to unserialize the data member of $user.</span>
<a name="l00109"></a>00109     $user-&gt;data = unserialize($user-&gt;data);
<a name="l00110"></a>00110 
<a name="l00111"></a>00111     <span class="comment">// Add roles element to $user.</span>
<a name="l00112"></a>00112     $user-&gt;roles = array();
<a name="l00113"></a>00113     $user-&gt;roles[<a class="code" href="bootstrap_8inc_ac2d2d9cd4c8559510f9baa997525373e.html#ac2d2d9cd4c8559510f9baa997525373e" title="Role ID for authenticated users; should match what&#39;s in the &quot;role&quot; table.">DRUPAL_AUTHENTICATED_RID</a>] = <span class="stringliteral">&#39;authenticated user&#39;</span>;
<a name="l00114"></a>00114     $user-&gt;roles += <a class="code" href="group__database_gafa3b6cb2b2f61479cc63a4150c62da9b.html#gafa3b6cb2b2f61479cc63a4150c62da9b" title="The following utility functions are simply convenience wrappers.">db_query</a>(<span class="stringliteral">&quot;SELECT r.rid, r.name FROM {role} r INNER JOIN {users_roles} ur ON ur.rid = r.rid WHERE ur.uid = :uid&quot;</span>, array(<span class="stringliteral">&#39;:uid&#39;</span> =&gt; $user-&gt;uid))-&gt;fetchAllKeyed(0, 1);
<a name="l00115"></a>00115   }
<a name="l00116"></a>00116   elseif ($user) {
<a name="l00117"></a>00117     <span class="comment">// The user is anonymous or blocked. Only preserve two fields from the</span>
<a name="l00118"></a>00118     <span class="comment">// {sessions} table.</span>
<a name="l00119"></a>00119     $account = <a class="code" href="bootstrap_8inc_a9ad783f833f89bccb8ca03e960e3d33d.html#a9ad783f833f89bccb8ca03e960e3d33d" title="Generates a default anonymous $user object.">drupal_anonymous_user</a>();
<a name="l00120"></a>00120     $account-&gt;session = $user-&gt;session;
<a name="l00121"></a>00121     $account-&gt;timestamp = $user-&gt;timestamp;
<a name="l00122"></a>00122     $user = $account;
<a name="l00123"></a>00123   }
<a name="l00124"></a>00124   <span class="keywordflow">else</span> {
<a name="l00125"></a>00125     <span class="comment">// The session has expired.</span>
<a name="l00126"></a>00126     $user = <a class="code" href="bootstrap_8inc_a9ad783f833f89bccb8ca03e960e3d33d.html#a9ad783f833f89bccb8ca03e960e3d33d" title="Generates a default anonymous $user object.">drupal_anonymous_user</a>();
<a name="l00127"></a>00127     $user-&gt;session = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00128"></a>00128   }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130   <span class="comment">// Store the session that was read for comparison in _drupal_session_write().</span>
<a name="l00131"></a>00131   $last_read = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(<span class="stringliteral">&#39;drupal_session_last_read&#39;</span>);
<a name="l00132"></a>00132   $last_read = array(
<a name="l00133"></a>00133     <span class="stringliteral">&#39;sid&#39;</span> =&gt; $sid,
<a name="l00134"></a>00134     <span class="stringliteral">&#39;value&#39;</span> =&gt; $user-&gt;session,
<a name="l00135"></a>00135   );
<a name="l00136"></a>00136 
<a name="l00137"></a>00137   <span class="keywordflow">return</span> $user-&gt;session;
<a name="l00138"></a>00138 }
<a name="l00139"></a>00139 
<a name="l00158"></a><a class="code" href="session_8inc_a4c7b4bd789e8a27c6c7078cb1a32f8f9.html#a4c7b4bd789e8a27c6c7078cb1a32f8f9">00158</a> <span class="keyword">function</span> <a class="code" href="session_8inc_a4c7b4bd789e8a27c6c7078cb1a32f8f9.html#a4c7b4bd789e8a27c6c7078cb1a32f8f9" title="Writes an entire session to the database (internal use only).">_drupal_session_write</a>($sid, $value) {
<a name="l00159"></a>00159   global $user, $is_https;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161   <span class="comment">// The exception handler is not active at this point, so we need to do it</span>
<a name="l00162"></a>00162   <span class="comment">// manually.</span>
<a name="l00163"></a>00163   <span class="keywordflow">try</span> {
<a name="l00164"></a>00164     <span class="keywordflow">if</span> (!<a class="code" href="session_8inc_a2e1c6443b96a7018027383ca39585ce7.html#a2e1c6443b96a7018027383ca39585ce7" title="Determines whether to save session data of the current request.">drupal_save_session</a>()) {
<a name="l00165"></a>00165       <span class="comment">// We don&#39;t have anything to do if we are not allowed to save the session.</span>
<a name="l00166"></a>00166       <span class="keywordflow">return</span>;
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     <span class="comment">// Check whether $_SESSION has been changed in this request.</span>
<a name="l00170"></a>00170     $last_read = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(<span class="stringliteral">&#39;drupal_session_last_read&#39;</span>);
<a name="l00171"></a>00171     $is_changed = !isset($last_read) || $last_read[<span class="stringliteral">&#39;sid&#39;</span>] != $sid || $last_read[<span class="stringliteral">&#39;value&#39;</span>] !== $value;
<a name="l00172"></a>00172 
<a name="l00173"></a>00173     <span class="comment">// For performance reasons, do not update the sessions table, unless</span>
<a name="l00174"></a>00174     <span class="comment">// $_SESSION has changed or more than 180 has passed since the last update.</span>
<a name="l00175"></a>00175     <span class="keywordflow">if</span> ($is_changed || !isset($user-&gt;timestamp) || <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a> - $user-&gt;timestamp &gt; <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;session_write_interval&#39;</span>, 180)) {
<a name="l00176"></a>00176       <span class="comment">// Either ssid or sid or both will be added from $key below.</span>
<a name="l00177"></a>00177       $fields = array(
<a name="l00178"></a>00178         <span class="stringliteral">&#39;uid&#39;</span> =&gt; $user-&gt;uid,
<a name="l00179"></a>00179         <span class="stringliteral">&#39;cache&#39;</span> =&gt; isset($user-&gt;cache) ? $user-&gt;cache : 0,
<a name="l00180"></a>00180         <span class="stringliteral">&#39;hostname&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_aec2f772317b4fb79cc696412c2e455c3.html#aec2f772317b4fb79cc696412c2e455c3" title="Returns the IP address of the client machine.">ip_address</a>(),
<a name="l00181"></a>00181         <span class="stringliteral">&#39;session&#39;</span> =&gt; $value,
<a name="l00182"></a>00182         <span class="stringliteral">&#39;timestamp&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a>,
<a name="l00183"></a>00183       );
<a name="l00184"></a>00184 
<a name="l00185"></a>00185       <span class="comment">// Use the session ID as &#39;sid&#39; and an empty string as &#39;ssid&#39; by default.</span>
<a name="l00186"></a>00186       <span class="comment">// _drupal_session_read() does not allow empty strings so that&#39;s a safe</span>
<a name="l00187"></a>00187       <span class="comment">// default.</span>
<a name="l00188"></a>00188       $key = array(<span class="stringliteral">&#39;sid&#39;</span> =&gt; $sid, <span class="stringliteral">&#39;ssid&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>);
<a name="l00189"></a>00189       <span class="comment">// On HTTPS connections, use the session ID as both &#39;sid&#39; and &#39;ssid&#39;.</span>
<a name="l00190"></a>00190       <span class="keywordflow">if</span> ($is_https) {
<a name="l00191"></a>00191         $key[<span class="stringliteral">&#39;ssid&#39;</span>] = $sid;
<a name="l00192"></a>00192         <span class="comment">// The &quot;secure pages&quot; setting allows a site to simultaneously use both</span>
<a name="l00193"></a>00193         <span class="comment">// secure and insecure session cookies. If enabled and both cookies are</span>
<a name="l00194"></a>00194         <span class="comment">// presented then use both keys.</span>
<a name="l00195"></a>00195         <span class="keywordflow">if</span> (<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;https&#39;</span>, FALSE)) {
<a name="l00196"></a>00196           $insecure_session_name = substr(session_name(), 1);
<a name="l00197"></a>00197           <span class="keywordflow">if</span> (isset($_COOKIE[$insecure_session_name])) {
<a name="l00198"></a>00198             $key[<span class="stringliteral">&#39;sid&#39;</span>] = $_COOKIE[$insecure_session_name];
<a name="l00199"></a>00199           }
<a name="l00200"></a>00200         }
<a name="l00201"></a>00201       }
<a name="l00202"></a>00202       elseif (<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;https&#39;</span>, FALSE)) {
<a name="l00203"></a>00203         unset($key[<span class="stringliteral">&#39;ssid&#39;</span>]);
<a name="l00204"></a>00204       }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206       <a class="code" href="group__database_ga429c73a1bdc6dbb18c4a4a8a2235beaf.html#ga429c73a1bdc6dbb18c4a4a8a2235beaf" title="Returns a new MergeQuery object for the active database.">db_merge</a>(<span class="stringliteral">&#39;sessions&#39;</span>)
<a name="l00207"></a>00207         -&gt;key($key)
<a name="l00208"></a>00208         -&gt;fields($fields)
<a name="l00209"></a>00209         -&gt;execute();
<a name="l00210"></a>00210     }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     <span class="comment">// Likewise, do not update access time more than once per 180 seconds.</span>
<a name="l00213"></a>00213     <span class="keywordflow">if</span> ($user-&gt;uid &amp;&amp; <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a> - $user-&gt;access &gt; <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;session_write_interval&#39;</span>, 180)) {
<a name="l00214"></a>00214       <a class="code" href="group__database_ga40967197ee5d6a23a5c5a77e627067fe.html#ga40967197ee5d6a23a5c5a77e627067fe" title="Returns a new UpdateQuery object for the active database.">db_update</a>(<span class="stringliteral">&#39;users&#39;</span>)
<a name="l00215"></a>00215         -&gt;fields(array(
<a name="l00216"></a>00216           <span class="stringliteral">&#39;access&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a>
<a name="l00217"></a>00217         ))
<a name="l00218"></a>00218         -&gt;condition(<span class="stringliteral">&#39;uid&#39;</span>, $user-&gt;uid)
<a name="l00219"></a>00219         -&gt;execute();
<a name="l00220"></a>00220     }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     <span class="keywordflow">return</span> TRUE;
<a name="l00223"></a>00223   }
<a name="l00224"></a>00224   <span class="keywordflow">catch</span> (<a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a> $exception) {
<a name="l00225"></a>00225     require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/errors.inc&#39;</span>;
<a name="l00226"></a>00226     <span class="comment">// If we are displaying errors, then do so with no possibility of a further</span>
<a name="l00227"></a>00227     <span class="comment">// uncaught exception being thrown.</span>
<a name="l00228"></a>00228     <span class="keywordflow">if</span> (<a class="code" href="errors_8inc_a84844a457938107e0ff1a1e5393feb8e.html#a84844a457938107e0ff1a1e5393feb8e" title="Determines whether an error should be displayed.">error_displayable</a>()) {
<a name="l00229"></a>00229       print <span class="stringliteral">&#39;&lt;h1&gt;Uncaught exception thrown in session handler.&lt;/h1&gt;&#39;</span>;
<a name="l00230"></a>00230       print <span class="stringliteral">&#39;&lt;p&gt;&#39;</span> . <a class="code" href="errors_8inc_a1f8bd68a322e820f9bed014cb6a9f1de.html#a1f8bd68a322e820f9bed014cb6a9f1de" title="Renders an exception error message without further exceptions.">_drupal_render_exception_safe</a>($exception) . <span class="stringliteral">&#39;&lt;/p&gt;&lt;hr /&gt;&#39;</span>;
<a name="l00231"></a>00231     }
<a name="l00232"></a>00232     <span class="keywordflow">return</span> FALSE;
<a name="l00233"></a>00233   }
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00239"></a><a class="code" href="session_8inc_a1ddf625160ae9e448b25ea74f9fa58d0.html#a1ddf625160ae9e448b25ea74f9fa58d0">00239</a> <span class="keyword">function</span> <a class="code" href="session_8inc_a1ddf625160ae9e448b25ea74f9fa58d0.html#a1ddf625160ae9e448b25ea74f9fa58d0" title="Initializes the session handler, starting a session if needed.">drupal_session_initialize</a>() {
<a name="l00240"></a>00240   global $user, $is_https;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242   session_set_save_handler(<span class="stringliteral">&#39;_drupal_session_open&#39;</span>, <span class="stringliteral">&#39;_drupal_session_close&#39;</span>, <span class="stringliteral">&#39;_drupal_session_read&#39;</span>, <span class="stringliteral">&#39;_drupal_session_write&#39;</span>, <span class="stringliteral">&#39;_drupal_session_destroy&#39;</span>, <span class="stringliteral">&#39;_drupal_session_garbage_collection&#39;</span>);
<a name="l00243"></a>00243 
<a name="l00244"></a>00244   <span class="comment">// We use !empty() in the following check to ensure that blank session IDs</span>
<a name="l00245"></a>00245   <span class="comment">// are not valid.</span>
<a name="l00246"></a>00246   <span class="keywordflow">if</span> (!empty($_COOKIE[session_name()]) || ($is_https &amp;&amp; <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;https&#39;</span>, FALSE) &amp;&amp; !empty($_COOKIE[substr(session_name(), 1)]))) {
<a name="l00247"></a>00247     <span class="comment">// If a session cookie exists, initialize the session. Otherwise the</span>
<a name="l00248"></a>00248     <span class="comment">// session is only started on demand in drupal_session_commit(), making</span>
<a name="l00249"></a>00249     <span class="comment">// anonymous users not use a session cookie unless something is stored in</span>
<a name="l00250"></a>00250     <span class="comment">// $_SESSION. This allows HTTP proxies to cache anonymous pageviews.</span>
<a name="l00251"></a>00251     <a class="code" href="group__php__wrappers_gaef664546ab6308e639e0d6f6b363ae57.html#gaef664546ab6308e639e0d6f6b363ae57" title="Forcefully starts a session, preserving already set session data.">drupal_session_start</a>();
<a name="l00252"></a>00252     <span class="keywordflow">if</span> (!empty($user-&gt;uid) || !empty($_SESSION)) {
<a name="l00253"></a>00253       <a class="code" href="bootstrap_8inc_a7972b6ea362a180e975d1d531a18996a.html#a7972b6ea362a180e975d1d531a18996a" title="Determines the cacheability of the current page.">drupal_page_is_cacheable</a>(FALSE);
<a name="l00254"></a>00254     }
<a name="l00255"></a>00255   }
<a name="l00256"></a>00256   <span class="keywordflow">else</span> {
<a name="l00257"></a>00257     <span class="comment">// Set a session identifier for this request. This is necessary because</span>
<a name="l00258"></a>00258     <span class="comment">// we lazily start sessions at the end of this request, and some</span>
<a name="l00259"></a>00259     <span class="comment">// processes (like drupal_get_token()) needs to know the future</span>
<a name="l00260"></a>00260     <span class="comment">// session ID in advance.</span>
<a name="l00261"></a>00261     $GLOBALS[<span class="stringliteral">&#39;lazy_session&#39;</span>] = TRUE;
<a name="l00262"></a>00262     $user = <a class="code" href="bootstrap_8inc_a9ad783f833f89bccb8ca03e960e3d33d.html#a9ad783f833f89bccb8ca03e960e3d33d" title="Generates a default anonymous $user object.">drupal_anonymous_user</a>();
<a name="l00263"></a>00263     <span class="comment">// Less random sessions (which are much faster to generate) are used for</span>
<a name="l00264"></a>00264     <span class="comment">// anonymous users than are generated in drupal_session_regenerate() when</span>
<a name="l00265"></a>00265     <span class="comment">// a user becomes authenticated.</span>
<a name="l00266"></a>00266     session_id(<a class="code" href="bootstrap_8inc_afaa1b21aee7b2e06ee3f868065fdbcc1.html#afaa1b21aee7b2e06ee3f868065fdbcc1" title="Calculates a base-64 encoded, URL-safe sha-256 hash.">drupal_hash_base64</a>(uniqid(mt_rand(), TRUE)));
<a name="l00267"></a>00267     <span class="keywordflow">if</span> ($is_https &amp;&amp; <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;https&#39;</span>, FALSE)) {
<a name="l00268"></a>00268       $insecure_session_name = substr(session_name(), 1);
<a name="l00269"></a>00269       $session_id = <a class="code" href="bootstrap_8inc_afaa1b21aee7b2e06ee3f868065fdbcc1.html#afaa1b21aee7b2e06ee3f868065fdbcc1" title="Calculates a base-64 encoded, URL-safe sha-256 hash.">drupal_hash_base64</a>(uniqid(mt_rand(), TRUE));
<a name="l00270"></a>00270       $_COOKIE[$insecure_session_name] = $session_id;
<a name="l00271"></a>00271     }
<a name="l00272"></a>00272   }
<a name="l00273"></a>00273   date_default_timezone_set(<a class="code" href="bootstrap_8inc_aab3e512ebe00778d1f7fe97db22b4d9d.html#aab3e512ebe00778d1f7fe97db22b4d9d" title="Returns the time zone of the current user.">drupal_get_user_timezone</a>());
<a name="l00274"></a>00274 }
<a name="l00275"></a>00275 
<a name="l00281"></a><a class="code" href="group__php__wrappers_gaef664546ab6308e639e0d6f6b363ae57.html#gaef664546ab6308e639e0d6f6b363ae57">00281</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_gaef664546ab6308e639e0d6f6b363ae57.html#gaef664546ab6308e639e0d6f6b363ae57" title="Forcefully starts a session, preserving already set session data.">drupal_session_start</a>() {
<a name="l00282"></a>00282   <span class="comment">// Command line clients do not support cookies nor sessions.</span>
<a name="l00283"></a>00283   <span class="keywordflow">if</span> (!<a class="code" href="session_8inc_a4de15350e0f9d1786d59da6ea7ea7171.html#a4de15350e0f9d1786d59da6ea7ea7171" title="Returns whether a session has been started.">drupal_session_started</a>() &amp;&amp; !<a class="code" href="group__schemaapi_gac880b82ae302f9d15c64d264a269d1f4.html#gac880b82ae302f9d15c64d264a269d1f4" title="Detects whether the current script is running in a command-line environment.">drupal_is_cli</a>()) {
<a name="l00284"></a>00284     <span class="comment">// Save current session data before starting it, as PHP will destroy it.</span>
<a name="l00285"></a>00285     $session_data = isset($_SESSION) ? $_SESSION : NULL;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287     session_start();
<a name="l00288"></a>00288     <a class="code" href="session_8inc_a4de15350e0f9d1786d59da6ea7ea7171.html#a4de15350e0f9d1786d59da6ea7ea7171" title="Returns whether a session has been started.">drupal_session_started</a>(TRUE);
<a name="l00289"></a>00289 
<a name="l00290"></a>00290     <span class="comment">// Restore session data.</span>
<a name="l00291"></a>00291     <span class="keywordflow">if</span> (!empty($session_data)) {
<a name="l00292"></a>00292       $_SESSION += $session_data;
<a name="l00293"></a>00293     }
<a name="l00294"></a>00294   }
<a name="l00295"></a>00295 }
<a name="l00296"></a>00296 
<a name="l00302"></a><a class="code" href="session_8inc_ad6c0ee8cae83649ccfbc7f2eef268377.html#ad6c0ee8cae83649ccfbc7f2eef268377">00302</a> <span class="keyword">function</span> <a class="code" href="session_8inc_ad6c0ee8cae83649ccfbc7f2eef268377.html#ad6c0ee8cae83649ccfbc7f2eef268377" title="Commits the current session, if necessary.">drupal_session_commit</a>() {
<a name="l00303"></a>00303   global $user, $is_https;
<a name="l00304"></a>00304 
<a name="l00305"></a>00305   <span class="keywordflow">if</span> (!<a class="code" href="session_8inc_a2e1c6443b96a7018027383ca39585ce7.html#a2e1c6443b96a7018027383ca39585ce7" title="Determines whether to save session data of the current request.">drupal_save_session</a>()) {
<a name="l00306"></a>00306     <span class="comment">// We don&#39;t have anything to do if we are not allowed to save the session.</span>
<a name="l00307"></a>00307     <span class="keywordflow">return</span>;
<a name="l00308"></a>00308   }
<a name="l00309"></a>00309 
<a name="l00310"></a>00310   <span class="keywordflow">if</span> (empty($user-&gt;uid) &amp;&amp; empty($_SESSION)) {
<a name="l00311"></a>00311     <span class="comment">// There is no session data to store, destroy the session if it was</span>
<a name="l00312"></a>00312     <span class="comment">// previously started.</span>
<a name="l00313"></a>00313     <span class="keywordflow">if</span> (<a class="code" href="session_8inc_a4de15350e0f9d1786d59da6ea7ea7171.html#a4de15350e0f9d1786d59da6ea7ea7171" title="Returns whether a session has been started.">drupal_session_started</a>()) {
<a name="l00314"></a>00314       session_destroy();
<a name="l00315"></a>00315     }
<a name="l00316"></a>00316   }
<a name="l00317"></a>00317   <span class="keywordflow">else</span> {
<a name="l00318"></a>00318     <span class="comment">// There is session data to store. Start the session if it is not already</span>
<a name="l00319"></a>00319     <span class="comment">// started.</span>
<a name="l00320"></a>00320     <span class="keywordflow">if</span> (!<a class="code" href="session_8inc_a4de15350e0f9d1786d59da6ea7ea7171.html#a4de15350e0f9d1786d59da6ea7ea7171" title="Returns whether a session has been started.">drupal_session_started</a>()) {
<a name="l00321"></a>00321       <a class="code" href="group__php__wrappers_gaef664546ab6308e639e0d6f6b363ae57.html#gaef664546ab6308e639e0d6f6b363ae57" title="Forcefully starts a session, preserving already set session data.">drupal_session_start</a>();
<a name="l00322"></a>00322       <span class="keywordflow">if</span> ($is_https &amp;&amp; <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;https&#39;</span>, FALSE)) {
<a name="l00323"></a>00323         $insecure_session_name = substr(session_name(), 1);
<a name="l00324"></a>00324         $params = session_get_cookie_params();
<a name="l00325"></a>00325         $expire = $params[<span class="stringliteral">&#39;lifetime&#39;</span>] ? <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a> + $params[<span class="stringliteral">&#39;lifetime&#39;</span>] : 0;
<a name="l00326"></a>00326         setcookie($insecure_session_name, $_COOKIE[$insecure_session_name], $expire, $params[<span class="stringliteral">&#39;path&#39;</span>], $params[<span class="stringliteral">&#39;domain&#39;</span>], FALSE, $params[<span class="stringliteral">&#39;httponly&#39;</span>]);
<a name="l00327"></a>00327       }
<a name="l00328"></a>00328     }
<a name="l00329"></a>00329     <span class="comment">// Write the session data.</span>
<a name="l00330"></a>00330     session_write_close();
<a name="l00331"></a>00331   }
<a name="l00332"></a>00332 }
<a name="l00333"></a>00333 
<a name="l00337"></a><a class="code" href="session_8inc_a4de15350e0f9d1786d59da6ea7ea7171.html#a4de15350e0f9d1786d59da6ea7ea7171">00337</a> <span class="keyword">function</span> <a class="code" href="session_8inc_a4de15350e0f9d1786d59da6ea7ea7171.html#a4de15350e0f9d1786d59da6ea7ea7171" title="Returns whether a session has been started.">drupal_session_started</a>($set = NULL) {
<a name="l00338"></a>00338   <span class="keyword">static</span> $session_started = FALSE;
<a name="l00339"></a>00339   <span class="keywordflow">if</span> (isset($set)) {
<a name="l00340"></a>00340     $session_started = $set;
<a name="l00341"></a>00341   }
<a name="l00342"></a>00342   <span class="keywordflow">return</span> $session_started &amp;&amp; session_id();
<a name="l00343"></a>00343 }
<a name="l00344"></a>00344 
<a name="l00350"></a><a class="code" href="group__php__wrappers_ga144f983d31722d56cef8cdf259d2f68f.html#ga144f983d31722d56cef8cdf259d2f68f">00350</a> <span class="keyword">function</span> <a class="code" href="group__php__wrappers_ga144f983d31722d56cef8cdf259d2f68f.html#ga144f983d31722d56cef8cdf259d2f68f" title="Called when an anonymous user becomes authenticated or vice-versa.">drupal_session_regenerate</a>() {
<a name="l00351"></a>00351   global $user, $is_https;
<a name="l00352"></a>00352   <span class="keywordflow">if</span> ($is_https &amp;&amp; <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;https&#39;</span>, FALSE)) {
<a name="l00353"></a>00353     $insecure_session_name = substr(session_name(), 1);
<a name="l00354"></a>00354     <span class="keywordflow">if</span> (!isset($GLOBALS[<span class="stringliteral">&#39;lazy_session&#39;</span>]) &amp;&amp; isset($_COOKIE[$insecure_session_name])) {
<a name="l00355"></a>00355       $old_insecure_session_id = $_COOKIE[$insecure_session_name];
<a name="l00356"></a>00356     }
<a name="l00357"></a>00357     $params = session_get_cookie_params();
<a name="l00358"></a>00358     $session_id = <a class="code" href="bootstrap_8inc_afaa1b21aee7b2e06ee3f868065fdbcc1.html#afaa1b21aee7b2e06ee3f868065fdbcc1" title="Calculates a base-64 encoded, URL-safe sha-256 hash.">drupal_hash_base64</a>(uniqid(mt_rand(), TRUE) . <a class="code" href="bootstrap_8inc_a6eb7796c83ea744f818faa2a02f19953.html#a6eb7796c83ea744f818faa2a02f19953" title="Returns a string of highly randomized bytes (over the full 8-bit range).">drupal_random_bytes</a>(55));
<a name="l00359"></a>00359     <span class="comment">// If a session cookie lifetime is set, the session will expire</span>
<a name="l00360"></a>00360     <span class="comment">// $params[&#39;lifetime&#39;] seconds from the current request. If it is not set,</span>
<a name="l00361"></a>00361     <span class="comment">// it will expire when the browser is closed.</span>
<a name="l00362"></a>00362     $expire = $params[<span class="stringliteral">&#39;lifetime&#39;</span>] ? <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a> + $params[<span class="stringliteral">&#39;lifetime&#39;</span>] : 0;
<a name="l00363"></a>00363     setcookie($insecure_session_name, $session_id, $expire, $params[<span class="stringliteral">&#39;path&#39;</span>], $params[<span class="stringliteral">&#39;domain&#39;</span>], FALSE, $params[<span class="stringliteral">&#39;httponly&#39;</span>]);
<a name="l00364"></a>00364     $_COOKIE[$insecure_session_name] = $session_id;
<a name="l00365"></a>00365   }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367   <span class="keywordflow">if</span> (<a class="code" href="session_8inc_a4de15350e0f9d1786d59da6ea7ea7171.html#a4de15350e0f9d1786d59da6ea7ea7171" title="Returns whether a session has been started.">drupal_session_started</a>()) {
<a name="l00368"></a>00368     $old_session_id = session_id();
<a name="l00369"></a>00369   }
<a name="l00370"></a>00370   session_id(<a class="code" href="bootstrap_8inc_afaa1b21aee7b2e06ee3f868065fdbcc1.html#afaa1b21aee7b2e06ee3f868065fdbcc1" title="Calculates a base-64 encoded, URL-safe sha-256 hash.">drupal_hash_base64</a>(uniqid(mt_rand(), TRUE) . <a class="code" href="bootstrap_8inc_a6eb7796c83ea744f818faa2a02f19953.html#a6eb7796c83ea744f818faa2a02f19953" title="Returns a string of highly randomized bytes (over the full 8-bit range).">drupal_random_bytes</a>(55)));
<a name="l00371"></a>00371 
<a name="l00372"></a>00372   <span class="keywordflow">if</span> (isset($old_session_id)) {
<a name="l00373"></a>00373     $params = session_get_cookie_params();
<a name="l00374"></a>00374     $expire = $params[<span class="stringliteral">&#39;lifetime&#39;</span>] ? <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a> + $params[<span class="stringliteral">&#39;lifetime&#39;</span>] : 0;
<a name="l00375"></a>00375     setcookie(session_name(), session_id(), $expire, $params[<span class="stringliteral">&#39;path&#39;</span>], $params[<span class="stringliteral">&#39;domain&#39;</span>], $params[<span class="stringliteral">&#39;secure&#39;</span>], $params[<span class="stringliteral">&#39;httponly&#39;</span>]);
<a name="l00376"></a>00376     $fields = array(<span class="stringliteral">&#39;sid&#39;</span> =&gt; session_id());
<a name="l00377"></a>00377     <span class="keywordflow">if</span> ($is_https) {
<a name="l00378"></a>00378       $fields[<span class="stringliteral">&#39;ssid&#39;</span>] = session_id();
<a name="l00379"></a>00379       <span class="comment">// If the &quot;secure pages&quot; setting is enabled, use the newly-created</span>
<a name="l00380"></a>00380       <span class="comment">// insecure session identifier as the regenerated sid.</span>
<a name="l00381"></a>00381       <span class="keywordflow">if</span> (<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;https&#39;</span>, FALSE)) {
<a name="l00382"></a>00382         $fields[<span class="stringliteral">&#39;sid&#39;</span>] = $session_id;
<a name="l00383"></a>00383       }
<a name="l00384"></a>00384     }
<a name="l00385"></a>00385     <a class="code" href="group__database_ga40967197ee5d6a23a5c5a77e627067fe.html#ga40967197ee5d6a23a5c5a77e627067fe" title="Returns a new UpdateQuery object for the active database.">db_update</a>(<span class="stringliteral">&#39;sessions&#39;</span>)
<a name="l00386"></a>00386       -&gt;fields($fields)
<a name="l00387"></a>00387       -&gt;condition($is_https ? <span class="stringliteral">&#39;ssid&#39;</span> : <span class="stringliteral">&#39;sid&#39;</span>, $old_session_id)
<a name="l00388"></a>00388       -&gt;execute();
<a name="l00389"></a>00389   }
<a name="l00390"></a>00390   elseif (isset($old_insecure_session_id)) {
<a name="l00391"></a>00391     <span class="comment">// If logging in to the secure site, and there was no active session on the</span>
<a name="l00392"></a>00392     <span class="comment">// secure site but a session was active on the insecure site, update the</span>
<a name="l00393"></a>00393     <span class="comment">// insecure session with the new session identifiers.</span>
<a name="l00394"></a>00394     <a class="code" href="group__database_ga40967197ee5d6a23a5c5a77e627067fe.html#ga40967197ee5d6a23a5c5a77e627067fe" title="Returns a new UpdateQuery object for the active database.">db_update</a>(<span class="stringliteral">&#39;sessions&#39;</span>)
<a name="l00395"></a>00395       -&gt;fields(array(<span class="stringliteral">&#39;sid&#39;</span> =&gt; $session_id, <span class="stringliteral">&#39;ssid&#39;</span> =&gt; session_id()))
<a name="l00396"></a>00396       -&gt;condition(<span class="stringliteral">&#39;sid&#39;</span>, $old_insecure_session_id)
<a name="l00397"></a>00397       -&gt;execute();
<a name="l00398"></a>00398   }
<a name="l00399"></a>00399   <span class="keywordflow">else</span> {
<a name="l00400"></a>00400     <span class="comment">// Start the session when it doesn&#39;t exist yet.</span>
<a name="l00401"></a>00401     <span class="comment">// Preserve the logged in user, as it will be reset to anonymous</span>
<a name="l00402"></a>00402     <span class="comment">// by _drupal_session_read.</span>
<a name="l00403"></a>00403     $account = $user;
<a name="l00404"></a>00404     <a class="code" href="group__php__wrappers_gaef664546ab6308e639e0d6f6b363ae57.html#gaef664546ab6308e639e0d6f6b363ae57" title="Forcefully starts a session, preserving already set session data.">drupal_session_start</a>();
<a name="l00405"></a>00405     $user = $account;
<a name="l00406"></a>00406   }
<a name="l00407"></a>00407   date_default_timezone_set(<a class="code" href="bootstrap_8inc_aab3e512ebe00778d1f7fe97db22b4d9d.html#aab3e512ebe00778d1f7fe97db22b4d9d" title="Returns the time zone of the current user.">drupal_get_user_timezone</a>());
<a name="l00408"></a>00408 }
<a name="l00409"></a>00409 
<a name="l00418"></a><a class="code" href="session_8inc_af8a3df8c027292c59745d5ce00025480.html#af8a3df8c027292c59745d5ce00025480">00418</a> <span class="keyword">function</span> <a class="code" href="session_8inc_af8a3df8c027292c59745d5ce00025480.html#af8a3df8c027292c59745d5ce00025480" title="Session handler assigned by session_set_save_handler().">_drupal_session_destroy</a>($sid) {
<a name="l00419"></a>00419   global $user, $is_https;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421   <span class="comment">// Delete session data.</span>
<a name="l00422"></a>00422   <a class="code" href="group__database_ga72f0ccecc0ba181de16c6e3451150f2c.html#ga72f0ccecc0ba181de16c6e3451150f2c" title="Returns a new DeleteQuery object for the active database.">db_delete</a>(<span class="stringliteral">&#39;sessions&#39;</span>)
<a name="l00423"></a>00423     -&gt;condition($is_https ? <span class="stringliteral">&#39;ssid&#39;</span> : <span class="stringliteral">&#39;sid&#39;</span>, $sid)
<a name="l00424"></a>00424     -&gt;execute();
<a name="l00425"></a>00425 
<a name="l00426"></a>00426   <span class="comment">// Reset $_SESSION and $user to prevent a new session from being started</span>
<a name="l00427"></a>00427   <span class="comment">// in drupal_session_commit().</span>
<a name="l00428"></a>00428   $_SESSION = array();
<a name="l00429"></a>00429   $user = <a class="code" href="bootstrap_8inc_a9ad783f833f89bccb8ca03e960e3d33d.html#a9ad783f833f89bccb8ca03e960e3d33d" title="Generates a default anonymous $user object.">drupal_anonymous_user</a>();
<a name="l00430"></a>00430 
<a name="l00431"></a>00431   <span class="comment">// Unset the session cookies.</span>
<a name="l00432"></a>00432   <a class="code" href="session_8inc_a8e37ac914709ebe5fd2a90a05ef9d07d.html#a8e37ac914709ebe5fd2a90a05ef9d07d" title="Deletes the session cookie.">_drupal_session_delete_cookie</a>(session_name());
<a name="l00433"></a>00433   <span class="keywordflow">if</span> ($is_https) {
<a name="l00434"></a>00434     <a class="code" href="session_8inc_a8e37ac914709ebe5fd2a90a05ef9d07d.html#a8e37ac914709ebe5fd2a90a05ef9d07d" title="Deletes the session cookie.">_drupal_session_delete_cookie</a>(substr(session_name(), 1), FALSE);
<a name="l00435"></a>00435   }
<a name="l00436"></a>00436   elseif (<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;https&#39;</span>, FALSE)) {
<a name="l00437"></a>00437     <a class="code" href="session_8inc_a8e37ac914709ebe5fd2a90a05ef9d07d.html#a8e37ac914709ebe5fd2a90a05ef9d07d" title="Deletes the session cookie.">_drupal_session_delete_cookie</a>(<span class="charliteral">&#39;S&#39;</span> . session_name(), TRUE);
<a name="l00438"></a>00438   }
<a name="l00439"></a>00439 }
<a name="l00440"></a>00440 
<a name="l00449"></a><a class="code" href="session_8inc_a8e37ac914709ebe5fd2a90a05ef9d07d.html#a8e37ac914709ebe5fd2a90a05ef9d07d">00449</a> <span class="keyword">function</span> <a class="code" href="session_8inc_a8e37ac914709ebe5fd2a90a05ef9d07d.html#a8e37ac914709ebe5fd2a90a05ef9d07d" title="Deletes the session cookie.">_drupal_session_delete_cookie</a>($name, $secure = NULL) {
<a name="l00450"></a>00450   global $is_https;
<a name="l00451"></a>00451   <span class="keywordflow">if</span> (isset($_COOKIE[$name]) || (!$is_https &amp;&amp; $secure === TRUE)) {
<a name="l00452"></a>00452     $params = session_get_cookie_params();
<a name="l00453"></a>00453     <span class="keywordflow">if</span> ($secure !== NULL) {
<a name="l00454"></a>00454       $params[<span class="stringliteral">&#39;secure&#39;</span>] = $secure;
<a name="l00455"></a>00455     }
<a name="l00456"></a>00456     setcookie($name, <span class="stringliteral">&#39;&#39;</span>, <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a> - 3600, $params[<span class="stringliteral">&#39;path&#39;</span>], $params[<span class="stringliteral">&#39;domain&#39;</span>], $params[<span class="stringliteral">&#39;secure&#39;</span>], $params[<span class="stringliteral">&#39;httponly&#39;</span>]);
<a name="l00457"></a>00457     unset($_COOKIE[$name]);
<a name="l00458"></a>00458   }
<a name="l00459"></a>00459 }
<a name="l00460"></a>00460 
<a name="l00467"></a><a class="code" href="session_8inc_a5ac41504673ec444e5e2d1aa1dc231f8.html#a5ac41504673ec444e5e2d1aa1dc231f8">00467</a> <span class="keyword">function</span> <a class="code" href="session_8inc_a5ac41504673ec444e5e2d1aa1dc231f8.html#a5ac41504673ec444e5e2d1aa1dc231f8" title="Ends a specific user&#39;s session(s).">drupal_session_destroy_uid</a>($uid) {
<a name="l00468"></a>00468   <a class="code" href="group__database_ga72f0ccecc0ba181de16c6e3451150f2c.html#ga72f0ccecc0ba181de16c6e3451150f2c" title="Returns a new DeleteQuery object for the active database.">db_delete</a>(<span class="stringliteral">&#39;sessions&#39;</span>)
<a name="l00469"></a>00469     -&gt;condition(<span class="stringliteral">&#39;uid&#39;</span>, $uid)
<a name="l00470"></a>00470     -&gt;execute();
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00482"></a><a class="code" href="session_8inc_a27392dffc0efaa15d678b516379eec99.html#a27392dffc0efaa15d678b516379eec99">00482</a> <span class="keyword">function</span> <a class="code" href="session_8inc_a27392dffc0efaa15d678b516379eec99.html#a27392dffc0efaa15d678b516379eec99" title="Session handler assigned by session_set_save_handler().">_drupal_session_garbage_collection</a>($lifetime) {
<a name="l00483"></a>00483   <span class="comment">// Be sure to adjust &#39;php_value session.gc_maxlifetime&#39; to a large enough</span>
<a name="l00484"></a>00484   <span class="comment">// value. For example, if you want user sessions to stay in your database</span>
<a name="l00485"></a>00485   <span class="comment">// for three weeks before deleting them, you need to set gc_maxlifetime</span>
<a name="l00486"></a>00486   <span class="comment">// to &#39;1814400&#39;. At that value, only after a user doesn&#39;t log in after</span>
<a name="l00487"></a>00487   <span class="comment">// three weeks (1814400 seconds) will his/her session be removed.</span>
<a name="l00488"></a>00488   <a class="code" href="group__database_ga72f0ccecc0ba181de16c6e3451150f2c.html#ga72f0ccecc0ba181de16c6e3451150f2c" title="Returns a new DeleteQuery object for the active database.">db_delete</a>(<span class="stringliteral">&#39;sessions&#39;</span>)
<a name="l00489"></a>00489     -&gt;condition(<span class="stringliteral">&#39;timestamp&#39;</span>, <a class="code" href="bootstrap_8inc_a08bcd0b03e31c17fb7d58786bef2b7f4.html#a08bcd0b03e31c17fb7d58786bef2b7f4" title="Time of the current request in seconds elapsed since the Unix Epoch.">REQUEST_TIME</a> - $lifetime, <span class="charliteral">&#39;&lt;&#39;</span>)
<a name="l00490"></a>00490     -&gt;execute();
<a name="l00491"></a>00491   <span class="keywordflow">return</span> TRUE;
<a name="l00492"></a>00492 }
<a name="l00493"></a>00493 
<a name="l00509"></a><a class="code" href="session_8inc_a2e1c6443b96a7018027383ca39585ce7.html#a2e1c6443b96a7018027383ca39585ce7">00509</a> <span class="keyword">function</span> <a class="code" href="session_8inc_a2e1c6443b96a7018027383ca39585ce7.html#a2e1c6443b96a7018027383ca39585ce7" title="Determines whether to save session data of the current request.">drupal_save_session</a>($status = NULL) {
<a name="l00510"></a>00510   $save_session = &amp;<a class="code" href="group__schemaapi_ga498392997d598f196f35805de85d8b21.html#ga498392997d598f196f35805de85d8b21" title="End of &quot;addtogroup registry&quot;.">drupal_static</a>(__FUNCTION__, TRUE);
<a name="l00511"></a>00511   <span class="keywordflow">if</span> (isset($status)) {
<a name="l00512"></a>00512     $save_session = $status;
<a name="l00513"></a>00513   }
<a name="l00514"></a>00514   <span class="keywordflow">return</span> $save_session;
<a name="l00515"></a>00515 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Thu Nov 22 2012 16:46:14 for Shopcart by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>

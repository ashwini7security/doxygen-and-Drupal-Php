<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Shopcart: includes/update.inc Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Shopcart
   &#160;<span id="projectnumber">version2.0</span>
   </div>
   <div id="projectbrief">Shoppingcart</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_5b89693129504707d608c5412e7b88d4.html">includes</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">update.inc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="update_8inc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00019"></a><a class="code" href="update_8inc_acba191c88d6f0e38bec3a5f873f57108.html#acba191c88d6f0e38bec3a5f873f57108">00019</a> define(<span class="stringliteral">&#39;REQUIRED_D6_SCHEMA_VERSION&#39;</span>, <span class="stringliteral">&#39;6055&#39;</span>);
<a name="l00020"></a>00020 
<a name="l00024"></a><a class="code" href="update_8inc_ab86cb0f00b89fc52f7f6294be9a1e33c.html#ab86cb0f00b89fc52f7f6294be9a1e33c">00024</a> <span class="keyword">function</span> <a class="code" href="update_8inc_ab86cb0f00b89fc52f7f6294be9a1e33c.html#ab86cb0f00b89fc52f7f6294be9a1e33c" title="Disable any items in the {system} table that are not core compatible.">update_fix_compatibility</a>() {
<a name="l00025"></a>00025   $incompatible = array();
<a name="l00026"></a>00026   $result = <a class="code" href="group__database_gafa3b6cb2b2f61479cc63a4150c62da9b.html#gafa3b6cb2b2f61479cc63a4150c62da9b" title="The following utility functions are simply convenience wrappers.">db_query</a>(<span class="stringliteral">&quot;SELECT name, type, status FROM {system} WHERE status = 1 AND type IN (&#39;module&#39;,&#39;theme&#39;)&quot;</span>);
<a name="l00027"></a>00027   <span class="keywordflow">foreach</span> ($result as $row) {
<a name="l00028"></a>00028     <span class="keywordflow">if</span> (<a class="code" href="update_8inc_a39592132a77fd791c44a8d6faf362cb0.html#a39592132a77fd791c44a8d6faf362cb0" title="Helper function to test compatibility of a module or theme.">update_check_incompatibility</a>($row-&gt;name, $row-&gt;type)) {
<a name="l00029"></a>00029       $incompatible[] = $row-&gt;name;
<a name="l00030"></a>00030     }
<a name="l00031"></a>00031   }
<a name="l00032"></a>00032   <span class="keywordflow">if</span> (!empty($incompatible)) {
<a name="l00033"></a>00033     <a class="code" href="group__database_ga40967197ee5d6a23a5c5a77e627067fe.html#ga40967197ee5d6a23a5c5a77e627067fe" title="Returns a new UpdateQuery object for the active database.">db_update</a>(<span class="stringliteral">&#39;system&#39;</span>)
<a name="l00034"></a>00034       -&gt;fields(array(<span class="stringliteral">&#39;status&#39;</span> =&gt; 0))
<a name="l00035"></a>00035       -&gt;condition(<span class="stringliteral">&#39;name&#39;</span>, $incompatible, <span class="stringliteral">&#39;IN&#39;</span>)
<a name="l00036"></a>00036       -&gt;execute();
<a name="l00037"></a>00037   }
<a name="l00038"></a>00038 }
<a name="l00039"></a>00039 
<a name="l00043"></a><a class="code" href="update_8inc_a39592132a77fd791c44a8d6faf362cb0.html#a39592132a77fd791c44a8d6faf362cb0">00043</a> <span class="keyword">function</span> <a class="code" href="update_8inc_a39592132a77fd791c44a8d6faf362cb0.html#a39592132a77fd791c44a8d6faf362cb0" title="Helper function to test compatibility of a module or theme.">update_check_incompatibility</a>($name, $type = <span class="stringliteral">&#39;module&#39;</span>) {
<a name="l00044"></a>00044   <span class="keyword">static</span> $themes, $modules;
<a name="l00045"></a>00045 
<a name="l00046"></a>00046   <span class="comment">// Store values of expensive functions for future use.</span>
<a name="l00047"></a>00047   <span class="keywordflow">if</span> (empty($themes) || empty($modules)) {
<a name="l00048"></a>00048     <span class="comment">// We need to do a full rebuild here to make sure the database reflects any</span>
<a name="l00049"></a>00049     <span class="comment">// code changes that were made in the filesystem before the update script</span>
<a name="l00050"></a>00050     <span class="comment">// was initiated.</span>
<a name="l00051"></a>00051     $themes = system_rebuild_theme_data();
<a name="l00052"></a>00052     $modules = system_rebuild_module_data();
<a name="l00053"></a>00053   }
<a name="l00054"></a>00054 
<a name="l00055"></a>00055   <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;module&#39;</span> &amp;&amp; isset($modules[$name])) {
<a name="l00056"></a>00056     $file = $modules[$name];
<a name="l00057"></a>00057   }
<a name="l00058"></a>00058   elseif ($type == <span class="stringliteral">&#39;theme&#39;</span> &amp;&amp; isset($themes[$name])) {
<a name="l00059"></a>00059     $file = $themes[$name];
<a name="l00060"></a>00060   }
<a name="l00061"></a>00061   <span class="keywordflow">if</span> (!isset($file)
<a name="l00062"></a>00062       || !isset($file-&gt;info[<span class="stringliteral">&#39;core&#39;</span>])
<a name="l00063"></a>00063       || $file-&gt;info[<span class="stringliteral">&#39;core&#39;</span>] != <a class="code" href="bootstrap_8inc_a4f0dd177a6291b9d7fc1b5ae033b5eaf.html#a4f0dd177a6291b9d7fc1b5ae033b5eaf" title="Core API compatibility.">DRUPAL_CORE_COMPATIBILITY</a>
<a name="l00064"></a>00064       || version_compare(phpversion(), $file-&gt;info[<span class="stringliteral">&#39;php&#39;</span>]) &lt; 0) {
<a name="l00065"></a>00065     <span class="keywordflow">return</span> TRUE;
<a name="l00066"></a>00066   }
<a name="l00067"></a>00067   <span class="keywordflow">return</span> FALSE;
<a name="l00068"></a>00068 }
<a name="l00069"></a>00069 
<a name="l00081"></a><a class="code" href="update_8inc_ae3ce2c866dce2d33c363b57136a2ba84.html#ae3ce2c866dce2d33c363b57136a2ba84">00081</a> <span class="keyword">function</span> <a class="code" href="update_8inc_ae3ce2c866dce2d33c363b57136a2ba84.html#ae3ce2c866dce2d33c363b57136a2ba84" title="Performs extra steps required to bootstrap when using a Drupal 6 database.">update_prepare_d7_bootstrap</a>() {
<a name="l00082"></a>00082   <span class="comment">// Allow the bootstrap to proceed even if a Drupal 6 settings.php file is</span>
<a name="l00083"></a>00083   <span class="comment">// still being used.</span>
<a name="l00084"></a>00084   include_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/install.inc&#39;</span>;
<a name="l00085"></a>00085   <a class="code" href="bootstrap_8inc_a8dcad7737ed560086bcdd9998a020a93.html#a8dcad7737ed560086bcdd9998a020a93" title="Ensures Drupal is bootstrapped to the specified phase.">drupal_bootstrap</a>(<a class="code" href="bootstrap_8inc_ad71394314c3ad7cef54b5f566e3ec177.html#ad71394314c3ad7cef54b5f566e3ec177" title="End of &quot;defgroup logging_severity_levels&quot;.">DRUPAL_BOOTSTRAP_CONFIGURATION</a>);
<a name="l00086"></a>00086   global <a class="code" href="default_8settings_8php_a97cde67402a68697692531e8b067f86f.html#a97cde67402a68697692531e8b067f86f" title="Database settings:">$databases</a>, $db_url, $db_prefix, $update_rewrite_settings;
<a name="l00087"></a>00087   <span class="keywordflow">if</span> (empty($databases) &amp;&amp; !empty($db_url)) {
<a name="l00088"></a>00088     $databases = <a class="code" href="update_8inc_a39f4938dea0ce704d1e426243cec11ec.html#a39f4938dea0ce704d1e426243cec11ec" title="Parse pre-Drupal 7 database connection URLs and return D7 compatible array.">update_parse_db_url</a>($db_url, $db_prefix);
<a name="l00089"></a>00089     <span class="comment">// Record the fact that the settings.php file will need to be rewritten.</span>
<a name="l00090"></a>00090     $update_rewrite_settings = TRUE;
<a name="l00091"></a>00091     $settings_file = <a class="code" href="bootstrap_8inc_acef612ef19c49f6259531f0bee5c26cc.html#acef612ef19c49f6259531f0bee5c26cc" title="Finds the appropriate configuration directory.">conf_path</a>() . <span class="stringliteral">&#39;/settings.php&#39;</span>;
<a name="l00092"></a>00092     $writable = <a class="code" href="install_8inc_a604165f37803cd10ac32534e3f8796ed.html#a604165f37803cd10ac32534e3f8796ed" title="Verify the state of the specified file.">drupal_verify_install_file</a>($settings_file, <a class="code" href="install_8inc_ae627ec3bb64949659adbc8cac5ae063e.html#ae627ec3bb64949659adbc8cac5ae063e" title="File permission check -- File exists.">FILE_EXIST</a>|<a class="code" href="install_8inc_a5a3ab6bb8b0df419dff1d9c741e5ca56.html#a5a3ab6bb8b0df419dff1d9c741e5ca56" title="File permission check -- File is readable.">FILE_READABLE</a>|<a class="code" href="install_8inc_a18edb581d332bd2fe379104a39e3b1a2.html#a18edb581d332bd2fe379104a39e3b1a2" title="File permission check -- File is writable.">FILE_WRITABLE</a>);
<a name="l00093"></a>00093     $requirements = array(
<a name="l00094"></a>00094       <span class="stringliteral">&#39;settings file&#39;</span> =&gt; array(
<a name="l00095"></a>00095         <span class="stringliteral">&#39;title&#39;</span> =&gt; <span class="stringliteral">&#39;Settings file&#39;</span>,
<a name="l00096"></a>00096         <span class="stringliteral">&#39;value&#39;</span> =&gt; $writable ? <span class="stringliteral">&#39;The settings file is writable.&#39;</span> : <span class="stringliteral">&#39;The settings file is not writable.&#39;</span>,
<a name="l00097"></a>00097         <span class="stringliteral">&#39;severity&#39;</span> =&gt; $writable ? <a class="code" href="install_8inc_add48d60abb0dc390c50bf824f1751cc2.html#add48d60abb0dc390c50bf824f1751cc2" title="Requirement severity -- Requirement successfully met.">REQUIREMENT_OK</a> : <a class="code" href="install_8inc_aeddf02286107904721cb582bd430581d.html#aeddf02286107904721cb582bd430581d" title="Requirement severity -- Error condition; abort installation.">REQUIREMENT_ERROR</a>,
<a name="l00098"></a>00098         <span class="stringliteral">&#39;description&#39;</span> =&gt; $writable ? <span class="stringliteral">&#39;&#39;</span> : <span class="stringliteral">&#39;Drupal requires write permissions to &lt;em&gt;&#39;</span> . $settings_file . <span class="stringliteral">&#39;&lt;/em&gt; during the update process. If you are unsure how to grant file permissions, consult the &lt;a href=&quot;http://drupal.org/server-permissions&quot;&gt;online handbook&lt;/a&gt;.&#39;</span>,
<a name="l00099"></a>00099       ),
<a name="l00100"></a>00100     );
<a name="l00101"></a>00101     <a class="code" href="update_8php_a0c14cba656eed6f94996df5798223b9a.html#a0c14cba656eed6f94996df5798223b9a" title="Returns (and optionally stores) extra requirements that only apply during particular parts of the upd...">update_extra_requirements</a>($requirements);
<a name="l00102"></a>00102   }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104   <span class="comment">// The new {blocked_ips} table is used in Drupal 7 to store a list of</span>
<a name="l00105"></a>00105   <span class="comment">// banned IP addresses. If this table doesn&#39;t exist then we are still</span>
<a name="l00106"></a>00106   <span class="comment">// running on a Drupal 6 database, so we suppress the unavoidable errors</span>
<a name="l00107"></a>00107   <span class="comment">// that occur by creating a static list.</span>
<a name="l00108"></a>00108   $GLOBALS[<span class="stringliteral">&#39;conf&#39;</span>][<span class="stringliteral">&#39;blocked_ips&#39;</span>] = array();
<a name="l00109"></a>00109 
<a name="l00110"></a>00110   <span class="comment">// Check that PDO is available and that the correct PDO database driver is</span>
<a name="l00111"></a>00111   <span class="comment">// loaded. Bootstrapping to DRUPAL_BOOTSTRAP_DATABASE will result in a fatal</span>
<a name="l00112"></a>00112   <span class="comment">// error otherwise.</span>
<a name="l00113"></a>00113   $message = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00114"></a>00114   $pdo_link = <span class="stringliteral">&#39;http://drupal.org/requirements/pdo&#39;</span>;
<a name="l00115"></a>00115   <span class="comment">// Check that PDO is loaded.</span>
<a name="l00116"></a>00116   <span class="keywordflow">if</span> (!extension_loaded(<span class="stringliteral">&#39;pdo&#39;</span>)) {
<a name="l00117"></a>00117     $message = <span class="stringliteral">&#39;&lt;h2&gt;PDO is required!&lt;/h2&gt;&lt;p&gt;Drupal 7 requires PHP &#39;</span> . <a class="code" href="bootstrap_8inc_a370c52d1679da96064df124c55f16ea8.html#a370c52d1679da96064df124c55f16ea8" title="Minimum supported version of PHP.">DRUPAL_MINIMUM_PHP</a> . <span class="stringliteral">&#39; or higher with the PHP Data Objects (PDO) extension enabled.&lt;/p&gt;&#39;</span>;
<a name="l00118"></a>00118   }
<a name="l00119"></a>00119   <span class="comment">// The PDO::ATTR_DEFAULT_FETCH_MODE constant is not available in the PECL</span>
<a name="l00120"></a>00120   <span class="comment">// version of PDO.</span>
<a name="l00121"></a>00121   elseif (!defined(<span class="stringliteral">&#39;PDO::ATTR_DEFAULT_FETCH_MODE&#39;</span>)) {
<a name="l00122"></a>00122     $message = <span class="stringliteral">&#39;&lt;h2&gt;The wrong version of PDO is installed!&lt;/h2&gt;&lt;p&gt;Drupal 7 requires the PHP Data Objects (PDO) extension from PHP core to be enabled. This system has the older PECL version installed.&#39;</span>;
<a name="l00123"></a>00123     $pdo_link = <span class="stringliteral">&#39;http://drupal.org/requirements/pdo#pecl&#39;</span>;
<a name="l00124"></a>00124   }
<a name="l00125"></a>00125   <span class="comment">// Check that the correct driver is loaded for the database being updated.</span>
<a name="l00126"></a>00126   <span class="comment">// If we have no driver information (for example, if someone tried to create</span>
<a name="l00127"></a>00127   <span class="comment">// the Drupal 7 $databases array themselves but did not do it correctly),</span>
<a name="l00128"></a>00128   <span class="comment">// this message will be confusing, so do not perform the check; instead, just</span>
<a name="l00129"></a>00129   <span class="comment">// let the database connection fail in the code that follows.</span>
<a name="l00130"></a>00130   elseif (isset($databases[<span class="stringliteral">&#39;default&#39;</span>][<span class="stringliteral">&#39;default&#39;</span>][<span class="stringliteral">&#39;driver&#39;</span>]) &amp;&amp; !in_array($databases[<span class="stringliteral">&#39;default&#39;</span>][<span class="stringliteral">&#39;default&#39;</span>][<span class="stringliteral">&#39;driver&#39;</span>], PDO::getAvailableDrivers())) {
<a name="l00131"></a>00131     $message = <span class="stringliteral">&#39;&lt;h2&gt;A PDO database driver is required!&lt;/h2&gt;&lt;p&gt;You need to enable the PDO_&#39;</span> . strtoupper($databases[<span class="stringliteral">&#39;default&#39;</span>][<span class="stringliteral">&#39;default&#39;</span>][<span class="stringliteral">&#39;driver&#39;</span>]) . <span class="stringliteral">&#39; database driver for PHP &#39;</span> . <a class="code" href="bootstrap_8inc_a370c52d1679da96064df124c55f16ea8.html#a370c52d1679da96064df124c55f16ea8" title="Minimum supported version of PHP.">DRUPAL_MINIMUM_PHP</a> . <span class="stringliteral">&#39; or higher so that Drupal 7 can access the database.&lt;/p&gt;&#39;</span>;
<a name="l00132"></a>00132   }
<a name="l00133"></a>00133   <span class="keywordflow">if</span> ($message) {
<a name="l00134"></a>00134     print $message . <span class="stringliteral">&#39;&lt;p&gt;See the &lt;a href=&quot;&#39;</span> . $pdo_link . <span class="stringliteral">&#39;&quot;&gt;system requirements page&lt;/a&gt; for more information.&lt;/p&gt;&#39;</span>;
<a name="l00135"></a>00135     exit();
<a name="l00136"></a>00136   }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138   <span class="comment">// Allow the database system to work even if the registry has not been</span>
<a name="l00139"></a>00139   <span class="comment">// created yet.</span>
<a name="l00140"></a>00140   <a class="code" href="bootstrap_8inc_a8dcad7737ed560086bcdd9998a020a93.html#a8dcad7737ed560086bcdd9998a020a93" title="Ensures Drupal is bootstrapped to the specified phase.">drupal_bootstrap</a>(<a class="code" href="bootstrap_8inc_a693d842eaaf448b1e6c37cc4ef068e3a.html#a693d842eaaf448b1e6c37cc4ef068e3a" title="Third bootstrap phase: initialize database layer.">DRUPAL_BOOTSTRAP_DATABASE</a>);
<a name="l00141"></a>00141 
<a name="l00142"></a>00142   <span class="comment">// If the site has not updated to Drupal 7 yet, check to make sure that it is</span>
<a name="l00143"></a>00143   <span class="comment">// running an up-to-date version of Drupal 6 before proceeding. Note this has</span>
<a name="l00144"></a>00144   <span class="comment">// to happen AFTER the database bootstraps because of</span>
<a name="l00145"></a>00145   <span class="comment">// drupal_get_installed_schema_version().</span>
<a name="l00146"></a>00146   $system_schema = <a class="code" href="install_8inc_a7702ece36adbef6e165e6f9c2bde5953.html#a7702ece36adbef6e165e6f9c2bde5953" title="Returns the currently installed schema version for a module.">drupal_get_installed_schema_version</a>(<span class="stringliteral">&#39;system&#39;</span>);
<a name="l00147"></a>00147   <span class="keywordflow">if</span> ($system_schema &lt; 7000) {
<a name="l00148"></a>00148     $has_required_schema = $system_schema &gt;= <a class="code" href="update_8inc_acba191c88d6f0e38bec3a5f873f57108.html#acba191c88d6f0e38bec3a5f873f57108" title="Minimum schema version of Drupal 6 required for upgrade to Drupal 7.">REQUIRED_D6_SCHEMA_VERSION</a>;
<a name="l00149"></a>00149     $requirements = array(
<a name="l00150"></a>00150       <span class="stringliteral">&#39;drupal 6 version&#39;</span> =&gt; array(
<a name="l00151"></a>00151         <span class="stringliteral">&#39;title&#39;</span> =&gt; <span class="stringliteral">&#39;Drupal 6 version&#39;</span>,
<a name="l00152"></a>00152         <span class="stringliteral">&#39;value&#39;</span> =&gt; $has_required_schema ? <span class="stringliteral">&#39;You are running a current version of Drupal 6.&#39;</span> : <span class="stringliteral">&#39;You are not running a current version of Drupal 6&#39;</span>,
<a name="l00153"></a>00153         <span class="stringliteral">&#39;severity&#39;</span> =&gt; $has_required_schema ? <a class="code" href="install_8inc_add48d60abb0dc390c50bf824f1751cc2.html#add48d60abb0dc390c50bf824f1751cc2" title="Requirement severity -- Requirement successfully met.">REQUIREMENT_OK</a> : <a class="code" href="install_8inc_aeddf02286107904721cb582bd430581d.html#aeddf02286107904721cb582bd430581d" title="Requirement severity -- Error condition; abort installation.">REQUIREMENT_ERROR</a>,
<a name="l00154"></a>00154         <span class="stringliteral">&#39;description&#39;</span> =&gt; $has_required_schema ? <span class="stringliteral">&#39;&#39;</span> : <span class="stringliteral">&#39;Please update your Drupal 6 installation to the most recent version before attempting to upgrade to Drupal 7&#39;</span>,
<a name="l00155"></a>00155       ),
<a name="l00156"></a>00156     );
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     <span class="comment">// Make sure that the database environment is properly set up.</span>
<a name="l00159"></a>00159     <span class="keywordflow">try</span> {
<a name="l00160"></a>00160       <a class="code" href="install_8inc_a57bfe6a3b39d6f931fe965a93e7eec83.html#a57bfe6a3b39d6f931fe965a93e7eec83" title="Ensures the environment for a Drupal database on a predefined connection.">db_run_tasks</a>(<a class="code" href="group__database_gabf958ef859f66154f7fd705eda7a06af.html#gabf958ef859f66154f7fd705eda7a06af" title="Retrieves the name of the currently active database driver.">db_driver</a>());
<a name="l00161"></a>00161     }
<a name="l00162"></a>00162     <span class="keywordflow">catch</span> (<a class="code" href="classDatabaseTaskException.html" title="Exception thrown if the database installer fails.">DatabaseTaskException</a> $e) {
<a name="l00163"></a>00163       $requirements[<span class="stringliteral">&#39;database tasks&#39;</span>] = array(
<a name="l00164"></a>00164         <span class="stringliteral">&#39;title&#39;</span> =&gt; <span class="stringliteral">&#39;Database environment&#39;</span>,
<a name="l00165"></a>00165         <span class="stringliteral">&#39;value&#39;</span> =&gt; <span class="stringliteral">&#39;There is a problem with your database environment&#39;</span>,
<a name="l00166"></a>00166         <span class="stringliteral">&#39;severity&#39;</span> =&gt; REQUIREMENT_ERROR,
<a name="l00167"></a>00167         <span class="stringliteral">&#39;description&#39;</span> =&gt; $e-&gt;getMessage(),
<a name="l00168"></a>00168       );
<a name="l00169"></a>00169     }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     <a class="code" href="update_8php_a0c14cba656eed6f94996df5798223b9a.html#a0c14cba656eed6f94996df5798223b9a" title="Returns (and optionally stores) extra requirements that only apply during particular parts of the upd...">update_extra_requirements</a>($requirements);
<a name="l00172"></a>00172 
<a name="l00173"></a>00173     <span class="comment">// Allow a D6 session to work, since the upgrade has not been performed yet.</span>
<a name="l00174"></a>00174     $d6_session_name = <a class="code" href="update_8inc_a1e41248922d100f2412b8471c05c59be.html#a1e41248922d100f2412b8471c05c59be" title="Constructs a session name compatible with a D6 environment.">update_get_d6_session_name</a>();
<a name="l00175"></a>00175     <span class="keywordflow">if</span> (!empty($_COOKIE[$d6_session_name])) {
<a name="l00176"></a>00176       <span class="comment">// Set the current sid to the one found in the D6 cookie.</span>
<a name="l00177"></a>00177       $sid = $_COOKIE[$d6_session_name];
<a name="l00178"></a>00178       $_COOKIE[session_name()] = $sid;
<a name="l00179"></a>00179       session_id($sid);
<a name="l00180"></a>00180     }
<a name="l00181"></a>00181 
<a name="l00182"></a>00182     <span class="comment">// Upgrading from D6 to D7.{0,1,2,3,4,8,...} is different than upgrading</span>
<a name="l00183"></a>00183     <span class="comment">// from D6 to D7.{5,6,7} which should be considered broken. To be able to</span>
<a name="l00184"></a>00184     <span class="comment">// properly handle this difference in node_update_7012 we need to keep track</span>
<a name="l00185"></a>00185     <span class="comment">// of whether a D6 &gt; D7 upgrade or a D7 &gt; D7 update is running.</span>
<a name="l00186"></a>00186     <span class="comment">// Since variable_set() is not available here, the D6 status is being saved</span>
<a name="l00187"></a>00187     <span class="comment">// in a local variable to be able to store it later.</span>
<a name="l00188"></a>00188     $update_d6 = TRUE;
<a name="l00189"></a>00189   }
<a name="l00190"></a>00190 
<a name="l00191"></a>00191   <span class="comment">// Create the registry tables.</span>
<a name="l00192"></a>00192   <span class="keywordflow">if</span> (!<a class="code" href="group__schemaapi_ga78809300cee80db034832825aed55b70.html#ga78809300cee80db034832825aed55b70" title="Checks if a table exists.">db_table_exists</a>(<span class="stringliteral">&#39;registry&#39;</span>)) {
<a name="l00193"></a>00193     $schema[<span class="stringliteral">&#39;registry&#39;</span>] = array(
<a name="l00194"></a>00194       <span class="stringliteral">&#39;fields&#39;</span> =&gt; array(
<a name="l00195"></a>00195         <span class="stringliteral">&#39;name&#39;</span>   =&gt; array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>),
<a name="l00196"></a>00196         <span class="stringliteral">&#39;type&#39;</span>   =&gt; array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 9, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>),
<a name="l00197"></a>00197         <span class="stringliteral">&#39;filename&#39;</span>   =&gt; array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>),
<a name="l00198"></a>00198         <span class="stringliteral">&#39;module&#39;</span>   =&gt; array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>),
<a name="l00199"></a>00199         <span class="stringliteral">&#39;weight&#39;</span>   =&gt; array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;int&#39;</span>, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; 0),
<a name="l00200"></a>00200       ),
<a name="l00201"></a>00201       <span class="stringliteral">&#39;primary key&#39;</span> =&gt; array(<span class="stringliteral">&#39;name&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>),
<a name="l00202"></a>00202       <span class="stringliteral">&#39;indexes&#39;</span> =&gt; array(
<a name="l00203"></a>00203         <span class="stringliteral">&#39;hook&#39;</span> =&gt; array(<span class="stringliteral">&#39;type&#39;</span>, <span class="stringliteral">&#39;weight&#39;</span>, <span class="stringliteral">&#39;module&#39;</span>),
<a name="l00204"></a>00204       ),
<a name="l00205"></a>00205     );
<a name="l00206"></a>00206     <a class="code" href="group__schemaapi_gaf3a8307693d6b28374665c72531b429f.html#gaf3a8307693d6b28374665c72531b429f" title="Creates a new table from a Drupal table definition.">db_create_table</a>(<span class="stringliteral">&#39;registry&#39;</span>, $schema[<span class="stringliteral">&#39;registry&#39;</span>]);
<a name="l00207"></a>00207   }
<a name="l00208"></a>00208   <span class="keywordflow">if</span> (!<a class="code" href="group__schemaapi_ga78809300cee80db034832825aed55b70.html#ga78809300cee80db034832825aed55b70" title="Checks if a table exists.">db_table_exists</a>(<span class="stringliteral">&#39;registry_file&#39;</span>)) {
<a name="l00209"></a>00209     $schema[<span class="stringliteral">&#39;registry_file&#39;</span>] = array(
<a name="l00210"></a>00210       <span class="stringliteral">&#39;fields&#39;</span> =&gt; array(
<a name="l00211"></a>00211         <span class="stringliteral">&#39;filename&#39;</span>   =&gt; array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE),
<a name="l00212"></a>00212         <span class="stringliteral">&#39;hash&#39;</span>   =&gt; array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 64, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE),
<a name="l00213"></a>00213       ),
<a name="l00214"></a>00214       <span class="stringliteral">&#39;primary key&#39;</span> =&gt; array(<span class="stringliteral">&#39;filename&#39;</span>),
<a name="l00215"></a>00215     );
<a name="l00216"></a>00216     <a class="code" href="group__schemaapi_gaf3a8307693d6b28374665c72531b429f.html#gaf3a8307693d6b28374665c72531b429f" title="Creates a new table from a Drupal table definition.">db_create_table</a>(<span class="stringliteral">&#39;registry_file&#39;</span>, $schema[<span class="stringliteral">&#39;registry_file&#39;</span>]);
<a name="l00217"></a>00217   }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219   <span class="comment">// Older versions of Drupal 6 do not include the semaphore table, which is</span>
<a name="l00220"></a>00220   <span class="comment">// required to bootstrap, so we add it now so that we can bootstrap and</span>
<a name="l00221"></a>00221   <span class="comment">// provide a reasonable error message.</span>
<a name="l00222"></a>00222   <span class="keywordflow">if</span> (!<a class="code" href="group__schemaapi_ga78809300cee80db034832825aed55b70.html#ga78809300cee80db034832825aed55b70" title="Checks if a table exists.">db_table_exists</a>(<span class="stringliteral">&#39;semaphore&#39;</span>)) {
<a name="l00223"></a>00223     $semaphore = array(
<a name="l00224"></a>00224       <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Table for holding semaphores, locks, flags, etc. that cannot be stored as Drupal variables since they must not be cached.&#39;</span>,
<a name="l00225"></a>00225       <span class="stringliteral">&#39;fields&#39;</span> =&gt; array(
<a name="l00226"></a>00226         <span class="stringliteral">&#39;name&#39;</span> =&gt; array(
<a name="l00227"></a>00227           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Primary Key: Unique name.&#39;</span>,
<a name="l00228"></a>00228           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>,
<a name="l00229"></a>00229           <span class="stringliteral">&#39;length&#39;</span> =&gt; 255,
<a name="l00230"></a>00230           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00231"></a>00231           <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>
<a name="l00232"></a>00232         ),
<a name="l00233"></a>00233         <span class="stringliteral">&#39;value&#39;</span> =&gt; array(
<a name="l00234"></a>00234           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;A value for the semaphore.&#39;</span>,
<a name="l00235"></a>00235           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>,
<a name="l00236"></a>00236           <span class="stringliteral">&#39;length&#39;</span> =&gt; 255,
<a name="l00237"></a>00237           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00238"></a>00238           <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>
<a name="l00239"></a>00239         ),
<a name="l00240"></a>00240         <span class="stringliteral">&#39;expire&#39;</span> =&gt; array(
<a name="l00241"></a>00241           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;A Unix timestamp with microseconds indicating when the semaphore should expire.&#39;</span>,
<a name="l00242"></a>00242           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;float&#39;</span>,
<a name="l00243"></a>00243           <span class="stringliteral">&#39;size&#39;</span> =&gt; <span class="stringliteral">&#39;big&#39;</span>,
<a name="l00244"></a>00244           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE
<a name="l00245"></a>00245         ),
<a name="l00246"></a>00246       ),
<a name="l00247"></a>00247       <span class="stringliteral">&#39;indexes&#39;</span> =&gt; array(
<a name="l00248"></a>00248         <span class="stringliteral">&#39;value&#39;</span> =&gt; array(<span class="stringliteral">&#39;value&#39;</span>),
<a name="l00249"></a>00249         <span class="stringliteral">&#39;expire&#39;</span> =&gt; array(<span class="stringliteral">&#39;expire&#39;</span>),
<a name="l00250"></a>00250       ),
<a name="l00251"></a>00251       <span class="stringliteral">&#39;primary key&#39;</span> =&gt; array(<span class="stringliteral">&#39;name&#39;</span>),
<a name="l00252"></a>00252     );
<a name="l00253"></a>00253     <a class="code" href="group__schemaapi_gaf3a8307693d6b28374665c72531b429f.html#gaf3a8307693d6b28374665c72531b429f" title="Creates a new table from a Drupal table definition.">db_create_table</a>(<span class="stringliteral">&#39;semaphore&#39;</span>, $semaphore);
<a name="l00254"></a>00254   }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256   <span class="comment">// The new cache_bootstrap bin is required to bootstrap to</span>
<a name="l00257"></a>00257   <span class="comment">// DRUPAL_BOOTSTRAP_SESSION, so create it here rather than in</span>
<a name="l00258"></a>00258   <span class="comment">// update_fix_d7_requirements().</span>
<a name="l00259"></a>00259   <span class="keywordflow">if</span> (!<a class="code" href="group__schemaapi_ga78809300cee80db034832825aed55b70.html#ga78809300cee80db034832825aed55b70" title="Checks if a table exists.">db_table_exists</a>(<span class="stringliteral">&#39;cache_bootstrap&#39;</span>)) {
<a name="l00260"></a>00260     $cache_bootstrap = array(
<a name="l00261"></a>00261       <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Cache table for data required to bootstrap Drupal, may be routed to a shared memory cache.&#39;</span>,
<a name="l00262"></a>00262       <span class="stringliteral">&#39;fields&#39;</span> =&gt; array(
<a name="l00263"></a>00263         <span class="stringliteral">&#39;cid&#39;</span> =&gt; array(
<a name="l00264"></a>00264           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Primary Key: Unique cache ID.&#39;</span>,
<a name="l00265"></a>00265           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>,
<a name="l00266"></a>00266           <span class="stringliteral">&#39;length&#39;</span> =&gt; 255,
<a name="l00267"></a>00267           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00268"></a>00268           <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00269"></a>00269         ),
<a name="l00270"></a>00270         <span class="stringliteral">&#39;data&#39;</span> =&gt; array(
<a name="l00271"></a>00271           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;A collection of data to cache.&#39;</span>,
<a name="l00272"></a>00272           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;blob&#39;</span>,
<a name="l00273"></a>00273           <span class="stringliteral">&#39;not null&#39;</span> =&gt; FALSE,
<a name="l00274"></a>00274           <span class="stringliteral">&#39;size&#39;</span> =&gt; <span class="stringliteral">&#39;big&#39;</span>,
<a name="l00275"></a>00275         ),
<a name="l00276"></a>00276         <span class="stringliteral">&#39;expire&#39;</span> =&gt; array(
<a name="l00277"></a>00277           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;A Unix timestamp indicating when the cache entry should expire, or 0 for never.&#39;</span>,
<a name="l00278"></a>00278           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;int&#39;</span>,
<a name="l00279"></a>00279           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00280"></a>00280           <span class="stringliteral">&#39;default&#39;</span> =&gt; 0,
<a name="l00281"></a>00281         ),
<a name="l00282"></a>00282         <span class="stringliteral">&#39;created&#39;</span> =&gt; array(
<a name="l00283"></a>00283           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;A Unix timestamp indicating when the cache entry was created.&#39;</span>,
<a name="l00284"></a>00284           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;int&#39;</span>,
<a name="l00285"></a>00285           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00286"></a>00286           <span class="stringliteral">&#39;default&#39;</span> =&gt; 0,
<a name="l00287"></a>00287         ),
<a name="l00288"></a>00288         <span class="stringliteral">&#39;serialized&#39;</span> =&gt; array(
<a name="l00289"></a>00289           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;A flag to indicate whether content is serialized (1) or not (0).&#39;</span>,
<a name="l00290"></a>00290           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;int&#39;</span>,
<a name="l00291"></a>00291           <span class="stringliteral">&#39;size&#39;</span> =&gt; <span class="stringliteral">&#39;small&#39;</span>,
<a name="l00292"></a>00292           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00293"></a>00293           <span class="stringliteral">&#39;default&#39;</span> =&gt; 0,
<a name="l00294"></a>00294         ),
<a name="l00295"></a>00295       ),
<a name="l00296"></a>00296       <span class="stringliteral">&#39;indexes&#39;</span> =&gt; array(
<a name="l00297"></a>00297         <span class="stringliteral">&#39;expire&#39;</span> =&gt; array(<span class="stringliteral">&#39;expire&#39;</span>),
<a name="l00298"></a>00298       ),
<a name="l00299"></a>00299       <span class="stringliteral">&#39;primary key&#39;</span> =&gt; array(<span class="stringliteral">&#39;cid&#39;</span>),
<a name="l00300"></a>00300     );
<a name="l00301"></a>00301     <a class="code" href="group__schemaapi_gaf3a8307693d6b28374665c72531b429f.html#gaf3a8307693d6b28374665c72531b429f" title="Creates a new table from a Drupal table definition.">db_create_table</a>(<span class="stringliteral">&#39;cache_bootstrap&#39;</span>, $cache_bootstrap);
<a name="l00302"></a>00302   }
<a name="l00303"></a>00303 
<a name="l00304"></a>00304   <span class="comment">// Set a valid timezone for 6 -&gt; 7 upgrade process.</span>
<a name="l00305"></a>00305   <a class="code" href="bootstrap_8inc_a8dcad7737ed560086bcdd9998a020a93.html#a8dcad7737ed560086bcdd9998a020a93" title="Ensures Drupal is bootstrapped to the specified phase.">drupal_bootstrap</a>(<a class="code" href="bootstrap_8inc_a83083de674fde28341c7b833b9397390.html#a83083de674fde28341c7b833b9397390" title="Fourth bootstrap phase: initialize the variable system.">DRUPAL_BOOTSTRAP_VARIABLES</a>);
<a name="l00306"></a>00306   $timezone_offset = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;date_default_timezone&#39;</span>, 0);
<a name="l00307"></a>00307   <span class="keywordflow">if</span> (is_numeric($timezone_offset)) {
<a name="l00308"></a>00308     <span class="comment">// Save the original offset.</span>
<a name="l00309"></a>00309     <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;date_temporary_timezone&#39;</span>, $timezone_offset);
<a name="l00310"></a>00310     <span class="comment">// Set the timezone for this request only.</span>
<a name="l00311"></a>00311     $GLOBALS[<span class="stringliteral">&#39;conf&#39;</span>][<span class="stringliteral">&#39;date_default_timezone&#39;</span>] = <span class="stringliteral">&#39;UTC&#39;</span>;
<a name="l00312"></a>00312   }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314   <span class="comment">// This allows update functions to tell if an upgrade from D6 is running.</span>
<a name="l00315"></a>00315   <span class="keywordflow">if</span> (!empty($update_d6)) {
<a name="l00316"></a>00316     <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;update_d6&#39;</span>, TRUE);
<a name="l00317"></a>00317   }
<a name="l00318"></a>00318 }
<a name="l00319"></a>00319 
<a name="l00355"></a><a class="code" href="update_8inc_a349ad25ac5547fbb44556538758988a2.html#a349ad25ac5547fbb44556538758988a2">00355</a> <span class="keyword">function</span> <a class="code" href="update_8inc_a349ad25ac5547fbb44556538758988a2.html#a349ad25ac5547fbb44556538758988a2" title="A helper function that modules can use to assist with the transformation from numeric block deltas to...">update_fix_d7_block_deltas</a>(&amp;$sandbox, $renamed_deltas, $moved_deltas) {
<a name="l00356"></a>00356   <span class="comment">// Loop through each block and make changes to the block tables.</span>
<a name="l00357"></a>00357   <span class="comment">// Only run this the first time through the batch update.</span>
<a name="l00358"></a>00358   <span class="keywordflow">if</span> (!isset($sandbox[<span class="stringliteral">&#39;progress&#39;</span>])) {
<a name="l00359"></a>00359     <span class="comment">// Determine whether to use the old or new block table names.</span>
<a name="l00360"></a>00360     $block_tables = <a class="code" href="group__schemaapi_ga78809300cee80db034832825aed55b70.html#ga78809300cee80db034832825aed55b70" title="Checks if a table exists.">db_table_exists</a>(<span class="stringliteral">&#39;blocks&#39;</span>) ? array(<span class="stringliteral">&#39;blocks&#39;</span>, <span class="stringliteral">&#39;blocks_roles&#39;</span>) : array(<span class="stringliteral">&#39;block&#39;</span>, <span class="stringliteral">&#39;block_role&#39;</span>);
<a name="l00361"></a>00361     <span class="keywordflow">foreach</span> ($block_tables as $table) {
<a name="l00362"></a>00362       <span class="keywordflow">foreach</span> ($renamed_deltas as $module =&gt; $deltas) {
<a name="l00363"></a>00363         <span class="keywordflow">foreach</span> ($deltas as $old_delta =&gt; $new_delta) {
<a name="l00364"></a>00364           <span class="comment">// Only do the update if the old block actually exists.</span>
<a name="l00365"></a>00365           $block_exists = <a class="code" href="group__database_gafa3b6cb2b2f61479cc63a4150c62da9b.html#gafa3b6cb2b2f61479cc63a4150c62da9b" title="The following utility functions are simply convenience wrappers.">db_query</a>(<span class="stringliteral">&quot;SELECT COUNT(*) FROM {&quot;</span> . $table . <span class="stringliteral">&quot;} WHERE module = :module AND delta = :delta&quot;</span>, array(
<a name="l00366"></a>00366               <span class="stringliteral">&#39;:module&#39;</span> =&gt; $module,
<a name="l00367"></a>00367               <span class="stringliteral">&#39;:delta&#39;</span> =&gt; $old_delta,
<a name="l00368"></a>00368             ))
<a name="l00369"></a>00369             -&gt;fetchField();
<a name="l00370"></a>00370           <span class="keywordflow">if</span> ($block_exists) {
<a name="l00371"></a>00371             <span class="comment">// Delete any existing blocks with the new module+delta.</span>
<a name="l00372"></a>00372             <a class="code" href="group__database_ga72f0ccecc0ba181de16c6e3451150f2c.html#ga72f0ccecc0ba181de16c6e3451150f2c" title="Returns a new DeleteQuery object for the active database.">db_delete</a>($table)
<a name="l00373"></a>00373               -&gt;condition(<span class="stringliteral">&#39;module&#39;</span>, $module)
<a name="l00374"></a>00374               -&gt;condition(<span class="stringliteral">&#39;delta&#39;</span>, $new_delta)
<a name="l00375"></a>00375               -&gt;execute();
<a name="l00376"></a>00376             <span class="comment">// Rename the old block to the new module+delta.</span>
<a name="l00377"></a>00377             <a class="code" href="group__database_ga40967197ee5d6a23a5c5a77e627067fe.html#ga40967197ee5d6a23a5c5a77e627067fe" title="Returns a new UpdateQuery object for the active database.">db_update</a>($table)
<a name="l00378"></a>00378               -&gt;fields(array(<span class="stringliteral">&#39;delta&#39;</span> =&gt; $new_delta))
<a name="l00379"></a>00379               -&gt;condition(<span class="stringliteral">&#39;module&#39;</span>, $module)
<a name="l00380"></a>00380               -&gt;condition(<span class="stringliteral">&#39;delta&#39;</span>, $old_delta)
<a name="l00381"></a>00381               -&gt;execute();
<a name="l00382"></a>00382           }
<a name="l00383"></a>00383         }
<a name="l00384"></a>00384       }
<a name="l00385"></a>00385       <span class="keywordflow">foreach</span> ($moved_deltas as $old_module =&gt; $deltas) {
<a name="l00386"></a>00386         <span class="keywordflow">foreach</span> ($deltas as $delta =&gt; $new_module) {
<a name="l00387"></a>00387           <span class="comment">// Only do the update if the old block actually exists.</span>
<a name="l00388"></a>00388           $block_exists = <a class="code" href="group__database_gafa3b6cb2b2f61479cc63a4150c62da9b.html#gafa3b6cb2b2f61479cc63a4150c62da9b" title="The following utility functions are simply convenience wrappers.">db_query</a>(<span class="stringliteral">&quot;SELECT COUNT(*) FROM {&quot;</span> . $table . <span class="stringliteral">&quot;} WHERE module = :module AND delta = :delta&quot;</span>, array(
<a name="l00389"></a>00389               <span class="stringliteral">&#39;:module&#39;</span> =&gt; $old_module,
<a name="l00390"></a>00390               <span class="stringliteral">&#39;:delta&#39;</span> =&gt; $delta,
<a name="l00391"></a>00391             ))
<a name="l00392"></a>00392             -&gt;fetchField();
<a name="l00393"></a>00393           <span class="keywordflow">if</span> ($block_exists) {
<a name="l00394"></a>00394             <span class="comment">// Delete any existing blocks with the new module+delta.</span>
<a name="l00395"></a>00395             <a class="code" href="group__database_ga72f0ccecc0ba181de16c6e3451150f2c.html#ga72f0ccecc0ba181de16c6e3451150f2c" title="Returns a new DeleteQuery object for the active database.">db_delete</a>($table)
<a name="l00396"></a>00396               -&gt;condition(<span class="stringliteral">&#39;module&#39;</span>, $new_module)
<a name="l00397"></a>00397               -&gt;condition(<span class="stringliteral">&#39;delta&#39;</span>, $delta)
<a name="l00398"></a>00398               -&gt;execute();
<a name="l00399"></a>00399             <span class="comment">// Rename the old block to the new module+delta.</span>
<a name="l00400"></a>00400             <a class="code" href="group__database_ga40967197ee5d6a23a5c5a77e627067fe.html#ga40967197ee5d6a23a5c5a77e627067fe" title="Returns a new UpdateQuery object for the active database.">db_update</a>($table)
<a name="l00401"></a>00401               -&gt;fields(array(<span class="stringliteral">&#39;module&#39;</span> =&gt; $new_module))
<a name="l00402"></a>00402               -&gt;condition(<span class="stringliteral">&#39;module&#39;</span>, $old_module)
<a name="l00403"></a>00403               -&gt;condition(<span class="stringliteral">&#39;delta&#39;</span>, $delta)
<a name="l00404"></a>00404               -&gt;execute();
<a name="l00405"></a>00405           }
<a name="l00406"></a>00406         }
<a name="l00407"></a>00407       }
<a name="l00408"></a>00408     }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410     <span class="comment">// Initialize batch update information.</span>
<a name="l00411"></a>00411     $sandbox[<span class="stringliteral">&#39;progress&#39;</span>] = 0;
<a name="l00412"></a>00412     $sandbox[<span class="stringliteral">&#39;last_user_processed&#39;</span>] = -1;
<a name="l00413"></a>00413     $sandbox[<span class="stringliteral">&#39;max&#39;</span>] = <a class="code" href="group__database_gafa3b6cb2b2f61479cc63a4150c62da9b.html#gafa3b6cb2b2f61479cc63a4150c62da9b" title="The following utility functions are simply convenience wrappers.">db_query</a>(<span class="stringliteral">&quot;SELECT COUNT(*) FROM {users} WHERE data LIKE :block&quot;</span>, array(
<a name="l00414"></a>00414         <span class="stringliteral">&#39;:block&#39;</span> =&gt; <span class="charliteral">&#39;%&#39;</span> . <a class="code" href="group__database_ga4e86622a079f0992dbb987e66320be7a.html#ga4e86622a079f0992dbb987e66320be7a" title="Escapes characters that work as wildcard characters in a LIKE pattern.">db_like</a>(serialize(<span class="stringliteral">&#39;block&#39;</span>)) . <span class="charliteral">&#39;%&#39;</span>,
<a name="l00415"></a>00415       ))
<a name="l00416"></a>00416       -&gt;fetchField();
<a name="l00417"></a>00417   }
<a name="l00418"></a>00418   <span class="comment">// Now do the batch update of the user-specific block visibility settings.</span>
<a name="l00419"></a>00419   $limit = 100;
<a name="l00420"></a>00420   $result = <a class="code" href="group__database_ga9e030cee657d64e3d8e524c65814cc9f.html#ga9e030cee657d64e3d8e524c65814cc9f" title="Returns a new SelectQuery object for the active database.">db_select</a>(<span class="stringliteral">&#39;users&#39;</span>, <span class="charliteral">&#39;u&#39;</span>)
<a name="l00421"></a>00421     -&gt;fields(<span class="charliteral">&#39;u&#39;</span>, array(<span class="stringliteral">&#39;uid&#39;</span>, <span class="stringliteral">&#39;data&#39;</span>))
<a name="l00422"></a>00422     -&gt;condition(<span class="stringliteral">&#39;uid&#39;</span>, $sandbox[<span class="stringliteral">&#39;last_user_processed&#39;</span>], <span class="charliteral">&#39;&gt;&#39;</span>)
<a name="l00423"></a>00423     -&gt;condition(<span class="stringliteral">&#39;data&#39;</span>, <span class="charliteral">&#39;%&#39;</span> . <a class="code" href="group__database_ga4e86622a079f0992dbb987e66320be7a.html#ga4e86622a079f0992dbb987e66320be7a" title="Escapes characters that work as wildcard characters in a LIKE pattern.">db_like</a>(serialize(<span class="stringliteral">&#39;block&#39;</span>)) . <span class="charliteral">&#39;%&#39;</span>, <span class="stringliteral">&#39;LIKE&#39;</span>)
<a name="l00424"></a>00424     -&gt;orderBy(<span class="stringliteral">&#39;uid&#39;</span>, <span class="stringliteral">&#39;ASC&#39;</span>)
<a name="l00425"></a>00425     -&gt;range(0, $limit)
<a name="l00426"></a>00426     -&gt;execute();
<a name="l00427"></a>00427   <span class="keywordflow">foreach</span> ($result as $row) {
<a name="l00428"></a>00428     $data = unserialize($row-&gt;data);
<a name="l00429"></a>00429     $user_needs_update = FALSE;
<a name="l00430"></a>00430     <span class="keywordflow">foreach</span> ($renamed_deltas as $module =&gt; $deltas) {
<a name="l00431"></a>00431       <span class="keywordflow">foreach</span> ($deltas as $old_delta =&gt; $new_delta) {
<a name="l00432"></a>00432         <span class="keywordflow">if</span> (isset($data[<span class="stringliteral">&#39;block&#39;</span>][$module][$old_delta])) {
<a name="l00433"></a>00433           <span class="comment">// Transfer the old block visibility settings to the newly-renamed</span>
<a name="l00434"></a>00434           <span class="comment">// block, and mark this user for a database update.</span>
<a name="l00435"></a>00435           $data[<span class="stringliteral">&#39;block&#39;</span>][$module][$new_delta] = $data[<span class="stringliteral">&#39;block&#39;</span>][$module][$old_delta];
<a name="l00436"></a>00436           unset($data[<span class="stringliteral">&#39;block&#39;</span>][$module][$old_delta]);
<a name="l00437"></a>00437           $user_needs_update = TRUE;
<a name="l00438"></a>00438         }
<a name="l00439"></a>00439       }
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441     <span class="keywordflow">foreach</span> ($moved_deltas as $old_module =&gt; $deltas) {
<a name="l00442"></a>00442       <span class="keywordflow">foreach</span> ($deltas as $delta =&gt; $new_module) {
<a name="l00443"></a>00443         <span class="keywordflow">if</span> (isset($data[<span class="stringliteral">&#39;block&#39;</span>][$old_module][$delta])) {
<a name="l00444"></a>00444           <span class="comment">// Transfer the old block visibility settings to the moved</span>
<a name="l00445"></a>00445           <span class="comment">// block, and mark this user for a database update.</span>
<a name="l00446"></a>00446           $data[<span class="stringliteral">&#39;block&#39;</span>][$new_module][$delta] = $data[<span class="stringliteral">&#39;block&#39;</span>][$old_module][$delta];
<a name="l00447"></a>00447           unset($data[<span class="stringliteral">&#39;block&#39;</span>][$old_module][$delta]);
<a name="l00448"></a>00448           $user_needs_update = TRUE;
<a name="l00449"></a>00449         }
<a name="l00450"></a>00450       }
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452     <span class="comment">// Update the current user.</span>
<a name="l00453"></a>00453     <span class="keywordflow">if</span> ($user_needs_update) {
<a name="l00454"></a>00454       <a class="code" href="group__database_ga40967197ee5d6a23a5c5a77e627067fe.html#ga40967197ee5d6a23a5c5a77e627067fe" title="Returns a new UpdateQuery object for the active database.">db_update</a>(<span class="stringliteral">&#39;users&#39;</span>)
<a name="l00455"></a>00455         -&gt;fields(array(<span class="stringliteral">&#39;data&#39;</span> =&gt; serialize($data)))
<a name="l00456"></a>00456         -&gt;condition(<span class="stringliteral">&#39;uid&#39;</span>, $row-&gt;uid)
<a name="l00457"></a>00457         -&gt;execute();
<a name="l00458"></a>00458     }
<a name="l00459"></a>00459     <span class="comment">// Update our progress information for the batch update.</span>
<a name="l00460"></a>00460     $sandbox[<span class="stringliteral">&#39;progress&#39;</span>]++;
<a name="l00461"></a>00461     $sandbox[<span class="stringliteral">&#39;last_user_processed&#39;</span>] = $row-&gt;uid;
<a name="l00462"></a>00462   }
<a name="l00463"></a>00463   <span class="comment">// Indicate our current progress to the batch update system.</span>
<a name="l00464"></a>00464   <span class="keywordflow">if</span> ($sandbox[<span class="stringliteral">&#39;progress&#39;</span>] &lt; $sandbox[<span class="stringliteral">&#39;max&#39;</span>]) {
<a name="l00465"></a>00465     $sandbox[<span class="stringliteral">&#39;#finished&#39;</span>] = $sandbox[<span class="stringliteral">&#39;progress&#39;</span>] / $sandbox[<span class="stringliteral">&#39;max&#39;</span>];
<a name="l00466"></a>00466   }
<a name="l00467"></a>00467 }
<a name="l00468"></a>00468 
<a name="l00478"></a><a class="code" href="update_8inc_a00697f7fb179855f3c3fa65105abee94.html#a00697f7fb179855f3c3fa65105abee94">00478</a> <span class="keyword">function</span> <a class="code" href="update_8inc_a00697f7fb179855f3c3fa65105abee94.html#a00697f7fb179855f3c3fa65105abee94" title="Perform Drupal 6.x to 7.x updates that are required for update.php to function properly.">update_fix_d7_requirements</a>() {
<a name="l00479"></a>00479   global <a class="code" href="authorize_8php_a10064a52f624358ea93475105245c4ac.html#a10064a52f624358ea93475105245c4ac">$conf</a>;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481   <span class="comment">// Rewrite the settings.php file if necessary, see</span>
<a name="l00482"></a>00482   <span class="comment">// update_prepare_d7_bootstrap().</span>
<a name="l00483"></a>00483   global $update_rewrite_settings, $db_url, $db_prefix;
<a name="l00484"></a>00484   <span class="keywordflow">if</span> (!empty($update_rewrite_settings)) {
<a name="l00485"></a>00485     <a class="code" href="default_8settings_8php_a97cde67402a68697692531e8b067f86f.html#a97cde67402a68697692531e8b067f86f" title="Database settings:">$databases</a> = <a class="code" href="update_8inc_a39f4938dea0ce704d1e426243cec11ec.html#a39f4938dea0ce704d1e426243cec11ec" title="Parse pre-Drupal 7 database connection URLs and return D7 compatible array.">update_parse_db_url</a>($db_url, $db_prefix);
<a name="l00486"></a>00486     $salt = <a class="code" href="bootstrap_8inc_afaa1b21aee7b2e06ee3f868065fdbcc1.html#afaa1b21aee7b2e06ee3f868065fdbcc1" title="Calculates a base-64 encoded, URL-safe sha-256 hash.">drupal_hash_base64</a>(<a class="code" href="bootstrap_8inc_a6eb7796c83ea744f818faa2a02f19953.html#a6eb7796c83ea744f818faa2a02f19953" title="Returns a string of highly randomized bytes (over the full 8-bit range).">drupal_random_bytes</a>(55));
<a name="l00487"></a>00487     file_put_contents(<a class="code" href="bootstrap_8inc_acef612ef19c49f6259531f0bee5c26cc.html#acef612ef19c49f6259531f0bee5c26cc" title="Finds the appropriate configuration directory.">conf_path</a>() . <span class="stringliteral">&#39;/settings.php&#39;</span>, <span class="stringliteral">&quot;\n&quot;</span> . <span class="stringliteral">&#39;$databases = &#39;</span> . var_export(<a class="code" href="default_8settings_8php_a97cde67402a68697692531e8b067f86f.html#a97cde67402a68697692531e8b067f86f" title="Database settings:">$databases</a>, TRUE) . <span class="stringliteral">&quot;;\n\$drupal_hash_salt = &#39;$salt&#39;;&quot;</span>, FILE_APPEND);
<a name="l00488"></a>00488   }
<a name="l00489"></a>00489   <span class="keywordflow">if</span> (<a class="code" href="install_8inc_a7702ece36adbef6e165e6f9c2bde5953.html#a7702ece36adbef6e165e6f9c2bde5953" title="Returns the currently installed schema version for a module.">drupal_get_installed_schema_version</a>(<span class="stringliteral">&#39;system&#39;</span>) &lt; 7000 &amp;&amp; !<a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;update_d7_requirements&#39;</span>, FALSE)) {
<a name="l00490"></a>00490     <span class="comment">// Change 6.x system table field values to 7.x equivalent.</span>
<a name="l00491"></a>00491     <span class="comment">// Change field values.</span>
<a name="l00492"></a>00492     <a class="code" href="group__schemaapi_ga9e0a4211eb8137e187d5f3f4fa716cea.html#ga9e0a4211eb8137e187d5f3f4fa716cea" title="Changes a field definition.">db_change_field</a>(<span class="stringliteral">&#39;system&#39;</span>, <span class="stringliteral">&#39;schema_version&#39;</span>, <span class="stringliteral">&#39;schema_version&#39;</span>, array(
<a name="l00493"></a>00493      <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;int&#39;</span>,
<a name="l00494"></a>00494      <span class="stringliteral">&#39;size&#39;</span> =&gt; <span class="stringliteral">&#39;small&#39;</span>,
<a name="l00495"></a>00495      <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00496"></a>00496      <span class="stringliteral">&#39;default&#39;</span> =&gt; -1)
<a name="l00497"></a>00497     );
<a name="l00498"></a>00498     <a class="code" href="group__schemaapi_ga9e0a4211eb8137e187d5f3f4fa716cea.html#ga9e0a4211eb8137e187d5f3f4fa716cea" title="Changes a field definition.">db_change_field</a>(<span class="stringliteral">&#39;system&#39;</span>, <span class="stringliteral">&#39;status&#39;</span>, <span class="stringliteral">&#39;status&#39;</span>, array(
<a name="l00499"></a>00499       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;int&#39;</span>, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; 0));
<a name="l00500"></a>00500     <a class="code" href="group__schemaapi_ga9e0a4211eb8137e187d5f3f4fa716cea.html#ga9e0a4211eb8137e187d5f3f4fa716cea" title="Changes a field definition.">db_change_field</a>(<span class="stringliteral">&#39;system&#39;</span>, <span class="stringliteral">&#39;weight&#39;</span>, <span class="stringliteral">&#39;weight&#39;</span>, array(
<a name="l00501"></a>00501       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;int&#39;</span>, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; 0));
<a name="l00502"></a>00502     <a class="code" href="group__schemaapi_ga9e0a4211eb8137e187d5f3f4fa716cea.html#ga9e0a4211eb8137e187d5f3f4fa716cea" title="Changes a field definition.">db_change_field</a>(<span class="stringliteral">&#39;system&#39;</span>, <span class="stringliteral">&#39;bootstrap&#39;</span>, <span class="stringliteral">&#39;bootstrap&#39;</span>, array(
<a name="l00503"></a>00503       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;int&#39;</span>, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; 0));
<a name="l00504"></a>00504     <span class="comment">// Drop and recreate 6.x indexes.</span>
<a name="l00505"></a>00505     <a class="code" href="group__schemaapi_gaa59d447eb4a7b25350fb7404f9a70ec0.html#gaa59d447eb4a7b25350fb7404f9a70ec0" title="Drops an index.">db_drop_index</a>(<span class="stringliteral">&#39;system&#39;</span>, <span class="stringliteral">&#39;bootstrap&#39;</span>);
<a name="l00506"></a>00506     <a class="code" href="group__schemaapi_gafb7153a65df9b5a0877a602cde86a0cc.html#gafb7153a65df9b5a0877a602cde86a0cc" title="Adds an index.">db_add_index</a>(<span class="stringliteral">&#39;system&#39;</span>, <span class="stringliteral">&#39;bootstrap&#39;</span>, array(
<a name="l00507"></a>00507       <span class="stringliteral">&#39;status&#39;</span>, <span class="stringliteral">&#39;bootstrap&#39;</span>, array(<span class="stringliteral">&#39;type&#39;</span>, 12), <span class="stringliteral">&#39;weight&#39;</span>, <span class="stringliteral">&#39;name&#39;</span>));
<a name="l00508"></a>00508 
<a name="l00509"></a>00509     <a class="code" href="group__schemaapi_gaa59d447eb4a7b25350fb7404f9a70ec0.html#gaa59d447eb4a7b25350fb7404f9a70ec0" title="Drops an index.">db_drop_index</a>(<span class="stringliteral">&#39;system&#39;</span> ,<span class="stringliteral">&#39;modules&#39;</span>);
<a name="l00510"></a>00510     <a class="code" href="group__schemaapi_gafb7153a65df9b5a0877a602cde86a0cc.html#gafb7153a65df9b5a0877a602cde86a0cc" title="Adds an index.">db_add_index</a>(<span class="stringliteral">&#39;system&#39;</span>, <span class="stringliteral">&#39;modules&#39;</span>, array(array(
<a name="l00511"></a>00511       <span class="stringliteral">&#39;type&#39;</span>, 12), <span class="stringliteral">&#39;status&#39;</span>, <span class="stringliteral">&#39;weight&#39;</span>, <span class="stringliteral">&#39;name&#39;</span>));
<a name="l00512"></a>00512 
<a name="l00513"></a>00513     <a class="code" href="group__schemaapi_gaa59d447eb4a7b25350fb7404f9a70ec0.html#gaa59d447eb4a7b25350fb7404f9a70ec0" title="Drops an index.">db_drop_index</a>(<span class="stringliteral">&#39;system&#39;</span>, <span class="stringliteral">&#39;type_name&#39;</span>);
<a name="l00514"></a>00514     <a class="code" href="group__schemaapi_gafb7153a65df9b5a0877a602cde86a0cc.html#gafb7153a65df9b5a0877a602cde86a0cc" title="Adds an index.">db_add_index</a>(<span class="stringliteral">&#39;system&#39;</span>, <span class="stringliteral">&#39;type_name&#39;</span>, array(array(<span class="stringliteral">&#39;type&#39;</span>, 12), <span class="stringliteral">&#39;name&#39;</span>));
<a name="l00515"></a>00515     <span class="comment">// Add 7.x indexes.</span>
<a name="l00516"></a>00516     <a class="code" href="group__schemaapi_gafb7153a65df9b5a0877a602cde86a0cc.html#gafb7153a65df9b5a0877a602cde86a0cc" title="Adds an index.">db_add_index</a>(<span class="stringliteral">&#39;system&#39;</span>, <span class="stringliteral">&#39;system_list&#39;</span>, array(<span class="stringliteral">&#39;weight&#39;</span>, <span class="stringliteral">&#39;name&#39;</span>));
<a name="l00517"></a>00517 
<a name="l00518"></a>00518     <span class="comment">// Add the cache_path table.</span>
<a name="l00519"></a>00519     <span class="keywordflow">if</span> (<a class="code" href="group__schemaapi_ga78809300cee80db034832825aed55b70.html#ga78809300cee80db034832825aed55b70" title="Checks if a table exists.">db_table_exists</a>(<span class="stringliteral">&#39;cache_path&#39;</span>)) {
<a name="l00520"></a>00520       <a class="code" href="group__schemaapi_ga5d744ae7a6fe2c9eaa1c7bd350a071d3.html#ga5d744ae7a6fe2c9eaa1c7bd350a071d3" title="Drops a table.">db_drop_table</a>(<span class="stringliteral">&#39;cache_path&#39;</span>);
<a name="l00521"></a>00521     }
<a name="l00522"></a>00522     require_once(<span class="stringliteral">&#39;./modules/system/system.install&#39;</span>);
<a name="l00523"></a>00523     $schema[<span class="stringliteral">&#39;cache_path&#39;</span>] = system_schema_cache_7054();
<a name="l00524"></a>00524     $schema[<span class="stringliteral">&#39;cache_path&#39;</span>][<span class="stringliteral">&#39;description&#39;</span>] = <span class="stringliteral">&#39;Cache table used for path alias lookups.&#39;</span>;
<a name="l00525"></a>00525     <a class="code" href="group__schemaapi_gaf3a8307693d6b28374665c72531b429f.html#gaf3a8307693d6b28374665c72531b429f" title="Creates a new table from a Drupal table definition.">db_create_table</a>(<span class="stringliteral">&#39;cache_path&#39;</span>, $schema[<span class="stringliteral">&#39;cache_path&#39;</span>]);
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <span class="comment">// system_update_7042() renames columns, but these are needed to bootstrap.</span>
<a name="l00528"></a>00528     <span class="comment">// Add empty columns for now.</span>
<a name="l00529"></a>00529     <a class="code" href="group__schemaapi_ga10bc9c435dd6d36c112d7ec179840cff.html#ga10bc9c435dd6d36c112d7ec179840cff" title="Adds a new field to a table.">db_add_field</a>(<span class="stringliteral">&#39;url_alias&#39;</span>, <span class="stringliteral">&#39;source&#39;</span>, array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>));
<a name="l00530"></a>00530     <a class="code" href="group__schemaapi_ga10bc9c435dd6d36c112d7ec179840cff.html#ga10bc9c435dd6d36c112d7ec179840cff" title="Adds a new field to a table.">db_add_field</a>(<span class="stringliteral">&#39;url_alias&#39;</span>, <span class="stringliteral">&#39;alias&#39;</span>, array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>));
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <span class="comment">// Add new columns to {menu_router}.</span>
<a name="l00533"></a>00533     <a class="code" href="group__schemaapi_ga10bc9c435dd6d36c112d7ec179840cff.html#ga10bc9c435dd6d36c112d7ec179840cff" title="Adds a new field to a table.">db_add_field</a>(<span class="stringliteral">&#39;menu_router&#39;</span>, <span class="stringliteral">&#39;delivery_callback&#39;</span>, array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>));
<a name="l00534"></a>00534     <a class="code" href="group__schemaapi_ga10bc9c435dd6d36c112d7ec179840cff.html#ga10bc9c435dd6d36c112d7ec179840cff" title="Adds a new field to a table.">db_add_field</a>(<span class="stringliteral">&#39;menu_router&#39;</span>, <span class="stringliteral">&#39;context&#39;</span>, array(
<a name="l00535"></a>00535       <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Only for local tasks (tabs) - the context of a local task to control its placement.&#39;</span>,
<a name="l00536"></a>00536       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;int&#39;</span>,
<a name="l00537"></a>00537       <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00538"></a>00538       <span class="stringliteral">&#39;default&#39;</span> =&gt; 0,
<a name="l00539"></a>00539     ));
<a name="l00540"></a>00540     <a class="code" href="group__schemaapi_gaa59d447eb4a7b25350fb7404f9a70ec0.html#gaa59d447eb4a7b25350fb7404f9a70ec0" title="Drops an index.">db_drop_index</a>(<span class="stringliteral">&#39;menu_router&#39;</span>, <span class="stringliteral">&#39;tab_parent&#39;</span>);
<a name="l00541"></a>00541     <a class="code" href="group__schemaapi_gafb7153a65df9b5a0877a602cde86a0cc.html#gafb7153a65df9b5a0877a602cde86a0cc" title="Adds an index.">db_add_index</a>(<span class="stringliteral">&#39;menu_router&#39;</span>, <span class="stringliteral">&#39;tab_parent&#39;</span>, array(array(<span class="stringliteral">&#39;tab_parent&#39;</span>, 64), <span class="stringliteral">&#39;weight&#39;</span>, <span class="stringliteral">&#39;title&#39;</span>));
<a name="l00542"></a>00542     <a class="code" href="group__schemaapi_ga10bc9c435dd6d36c112d7ec179840cff.html#ga10bc9c435dd6d36c112d7ec179840cff" title="Adds a new field to a table.">db_add_field</a>(<span class="stringliteral">&#39;menu_router&#39;</span>, <span class="stringliteral">&#39;theme_callback&#39;</span>, array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>));
<a name="l00543"></a>00543     <a class="code" href="group__schemaapi_ga10bc9c435dd6d36c112d7ec179840cff.html#ga10bc9c435dd6d36c112d7ec179840cff" title="Adds a new field to a table.">db_add_field</a>(<span class="stringliteral">&#39;menu_router&#39;</span>, <span class="stringliteral">&#39;theme_arguments&#39;</span>, array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>));
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     <span class="comment">// Add the role_permission table.</span>
<a name="l00546"></a>00546     $schema[<span class="stringliteral">&#39;role_permission&#39;</span>] = array(
<a name="l00547"></a>00547       <span class="stringliteral">&#39;fields&#39;</span> =&gt; array(
<a name="l00548"></a>00548         <span class="stringliteral">&#39;rid&#39;</span> =&gt; array(
<a name="l00549"></a>00549         <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;int&#39;</span>,
<a name="l00550"></a>00550         <span class="stringliteral">&#39;unsigned&#39;</span> =&gt; TRUE,
<a name="l00551"></a>00551         <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00552"></a>00552       ),
<a name="l00553"></a>00553       <span class="stringliteral">&#39;permission&#39;</span> =&gt; array(
<a name="l00554"></a>00554         <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>,
<a name="l00555"></a>00555         <span class="stringliteral">&#39;length&#39;</span> =&gt; 128,
<a name="l00556"></a>00556         <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00557"></a>00557         <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00558"></a>00558       ),
<a name="l00559"></a>00559     ),
<a name="l00560"></a>00560     <span class="stringliteral">&#39;primary key&#39;</span> =&gt; array(<span class="stringliteral">&#39;rid&#39;</span>, <span class="stringliteral">&#39;permission&#39;</span>),
<a name="l00561"></a>00561     <span class="stringliteral">&#39;indexes&#39;</span> =&gt; array(
<a name="l00562"></a>00562       <span class="stringliteral">&#39;permission&#39;</span> =&gt; array(<span class="stringliteral">&#39;permission&#39;</span>),
<a name="l00563"></a>00563       ),
<a name="l00564"></a>00564     );
<a name="l00565"></a>00565     <a class="code" href="group__schemaapi_gaf3a8307693d6b28374665c72531b429f.html#gaf3a8307693d6b28374665c72531b429f" title="Creates a new table from a Drupal table definition.">db_create_table</a>(<span class="stringliteral">&#39;role_permission&#39;</span>, $schema[<span class="stringliteral">&#39;role_permission&#39;</span>]);
<a name="l00566"></a>00566 
<a name="l00567"></a>00567     <span class="comment">// Drops and recreates semaphore value index.</span>
<a name="l00568"></a>00568     <a class="code" href="group__schemaapi_gaa59d447eb4a7b25350fb7404f9a70ec0.html#gaa59d447eb4a7b25350fb7404f9a70ec0" title="Drops an index.">db_drop_index</a>(<span class="stringliteral">&#39;semaphore&#39;</span>, <span class="stringliteral">&#39;value&#39;</span>);
<a name="l00569"></a>00569     <a class="code" href="group__schemaapi_gafb7153a65df9b5a0877a602cde86a0cc.html#gafb7153a65df9b5a0877a602cde86a0cc" title="Adds an index.">db_add_index</a>(<span class="stringliteral">&#39;semaphore&#39;</span>, <span class="stringliteral">&#39;value&#39;</span>, array(<span class="stringliteral">&#39;value&#39;</span>));
<a name="l00570"></a>00570 
<a name="l00571"></a>00571     $schema[<span class="stringliteral">&#39;date_format_type&#39;</span>] = array(
<a name="l00572"></a>00572       <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Stores configured date format types.&#39;</span>,
<a name="l00573"></a>00573       <span class="stringliteral">&#39;fields&#39;</span> =&gt; array(
<a name="l00574"></a>00574         <span class="stringliteral">&#39;type&#39;</span> =&gt; array(
<a name="l00575"></a>00575           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;The date format type, e.g. medium.&#39;</span>,
<a name="l00576"></a>00576           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>,
<a name="l00577"></a>00577           <span class="stringliteral">&#39;length&#39;</span> =&gt; 64,
<a name="l00578"></a>00578           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00579"></a>00579         ),
<a name="l00580"></a>00580         <span class="stringliteral">&#39;title&#39;</span> =&gt; array(
<a name="l00581"></a>00581           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;The human readable name of the format type.&#39;</span>,
<a name="l00582"></a>00582           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>,
<a name="l00583"></a>00583           <span class="stringliteral">&#39;length&#39;</span> =&gt; 255,
<a name="l00584"></a>00584           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00585"></a>00585         ),
<a name="l00586"></a>00586         <span class="stringliteral">&#39;locked&#39;</span> =&gt; array(
<a name="l00587"></a>00587           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Whether or not this is a system provided format.&#39;</span>,
<a name="l00588"></a>00588           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;int&#39;</span>,
<a name="l00589"></a>00589           <span class="stringliteral">&#39;size&#39;</span> =&gt; <span class="stringliteral">&#39;tiny&#39;</span>,
<a name="l00590"></a>00590           <span class="stringliteral">&#39;default&#39;</span> =&gt; 0,
<a name="l00591"></a>00591           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00592"></a>00592         ),
<a name="l00593"></a>00593       ),
<a name="l00594"></a>00594       <span class="stringliteral">&#39;primary key&#39;</span> =&gt; array(<span class="stringliteral">&#39;type&#39;</span>),
<a name="l00595"></a>00595     );
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     $schema[<span class="stringliteral">&#39;date_formats&#39;</span>] = array(
<a name="l00598"></a>00598       <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Stores configured date formats.&#39;</span>,
<a name="l00599"></a>00599       <span class="stringliteral">&#39;fields&#39;</span> =&gt; array(
<a name="l00600"></a>00600         <span class="stringliteral">&#39;dfid&#39;</span> =&gt; array(
<a name="l00601"></a>00601           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;The date format identifier.&#39;</span>,
<a name="l00602"></a>00602           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;serial&#39;</span>,
<a name="l00603"></a>00603           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00604"></a>00604           <span class="stringliteral">&#39;unsigned&#39;</span> =&gt; TRUE,
<a name="l00605"></a>00605         ),
<a name="l00606"></a>00606         <span class="stringliteral">&#39;format&#39;</span> =&gt; array(
<a name="l00607"></a>00607           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;The date format string.&#39;</span>,
<a name="l00608"></a>00608           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>,
<a name="l00609"></a>00609           <span class="stringliteral">&#39;length&#39;</span> =&gt; 100,
<a name="l00610"></a>00610           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00611"></a>00611         ),
<a name="l00612"></a>00612         <span class="stringliteral">&#39;type&#39;</span> =&gt; array(
<a name="l00613"></a>00613           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;The date format type, e.g. medium.&#39;</span>,
<a name="l00614"></a>00614           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>,
<a name="l00615"></a>00615           <span class="stringliteral">&#39;length&#39;</span> =&gt; 64,
<a name="l00616"></a>00616           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00617"></a>00617         ),
<a name="l00618"></a>00618         <span class="stringliteral">&#39;locked&#39;</span> =&gt; array(
<a name="l00619"></a>00619           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Whether or not this format can be modified.&#39;</span>,
<a name="l00620"></a>00620           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;int&#39;</span>,
<a name="l00621"></a>00621           <span class="stringliteral">&#39;size&#39;</span> =&gt; <span class="stringliteral">&#39;tiny&#39;</span>,
<a name="l00622"></a>00622           <span class="stringliteral">&#39;default&#39;</span> =&gt; 0,
<a name="l00623"></a>00623           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00624"></a>00624         ),
<a name="l00625"></a>00625       ),
<a name="l00626"></a>00626       <span class="stringliteral">&#39;primary key&#39;</span> =&gt; array(<span class="stringliteral">&#39;dfid&#39;</span>),
<a name="l00627"></a>00627       <span class="stringliteral">&#39;unique keys&#39;</span> =&gt; array(<span class="stringliteral">&#39;formats&#39;</span> =&gt; array(<span class="stringliteral">&#39;format&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>)),
<a name="l00628"></a>00628     );
<a name="l00629"></a>00629 
<a name="l00630"></a>00630     $schema[<span class="stringliteral">&#39;date_format_locale&#39;</span>] = array(
<a name="l00631"></a>00631       <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Stores configured date formats for each locale.&#39;</span>,
<a name="l00632"></a>00632       <span class="stringliteral">&#39;fields&#39;</span> =&gt; array(
<a name="l00633"></a>00633         <span class="stringliteral">&#39;format&#39;</span> =&gt; array(
<a name="l00634"></a>00634           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;The date format string.&#39;</span>,
<a name="l00635"></a>00635           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>,
<a name="l00636"></a>00636           <span class="stringliteral">&#39;length&#39;</span> =&gt; 100,
<a name="l00637"></a>00637           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00638"></a>00638         ),
<a name="l00639"></a>00639         <span class="stringliteral">&#39;type&#39;</span> =&gt; array(
<a name="l00640"></a>00640           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;The date format type, e.g. medium.&#39;</span>,
<a name="l00641"></a>00641           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>,
<a name="l00642"></a>00642           <span class="stringliteral">&#39;length&#39;</span> =&gt; 64,
<a name="l00643"></a>00643           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00644"></a>00644         ),
<a name="l00645"></a>00645         <span class="stringliteral">&#39;language&#39;</span> =&gt; array(
<a name="l00646"></a>00646           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;A {languages}.language for this format to be used with.&#39;</span>,
<a name="l00647"></a>00647           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>,
<a name="l00648"></a>00648           <span class="stringliteral">&#39;length&#39;</span> =&gt; 12,
<a name="l00649"></a>00649           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00650"></a>00650         ),
<a name="l00651"></a>00651       ),
<a name="l00652"></a>00652       <span class="stringliteral">&#39;primary key&#39;</span> =&gt; array(<span class="stringliteral">&#39;type&#39;</span>, <span class="stringliteral">&#39;language&#39;</span>),
<a name="l00653"></a>00653     );
<a name="l00654"></a>00654 
<a name="l00655"></a>00655     <a class="code" href="group__schemaapi_gaf3a8307693d6b28374665c72531b429f.html#gaf3a8307693d6b28374665c72531b429f" title="Creates a new table from a Drupal table definition.">db_create_table</a>(<span class="stringliteral">&#39;date_format_type&#39;</span>, $schema[<span class="stringliteral">&#39;date_format_type&#39;</span>]);
<a name="l00656"></a>00656     <span class="comment">// Sites that have the Drupal 6 Date module installed already have the</span>
<a name="l00657"></a>00657     <span class="comment">// following tables.</span>
<a name="l00658"></a>00658     <span class="keywordflow">if</span> (<a class="code" href="group__schemaapi_ga78809300cee80db034832825aed55b70.html#ga78809300cee80db034832825aed55b70" title="Checks if a table exists.">db_table_exists</a>(<span class="stringliteral">&#39;date_formats&#39;</span>)) {
<a name="l00659"></a>00659       <a class="code" href="group__schemaapi_ga629fe4d738f4caeb9d8c8acc2cc4d05b.html#ga629fe4d738f4caeb9d8c8acc2cc4d05b" title="Renames a table.">db_rename_table</a>(<span class="stringliteral">&#39;date_formats&#39;</span>, <span class="stringliteral">&#39;d6_date_formats&#39;</span>);
<a name="l00660"></a>00660     }
<a name="l00661"></a>00661     <a class="code" href="group__schemaapi_gaf3a8307693d6b28374665c72531b429f.html#gaf3a8307693d6b28374665c72531b429f" title="Creates a new table from a Drupal table definition.">db_create_table</a>(<span class="stringliteral">&#39;date_formats&#39;</span>, $schema[<span class="stringliteral">&#39;date_formats&#39;</span>]);
<a name="l00662"></a>00662     <span class="keywordflow">if</span> (<a class="code" href="group__schemaapi_ga78809300cee80db034832825aed55b70.html#ga78809300cee80db034832825aed55b70" title="Checks if a table exists.">db_table_exists</a>(<span class="stringliteral">&#39;date_format_locale&#39;</span>)) {
<a name="l00663"></a>00663       <a class="code" href="group__schemaapi_ga629fe4d738f4caeb9d8c8acc2cc4d05b.html#ga629fe4d738f4caeb9d8c8acc2cc4d05b" title="Renames a table.">db_rename_table</a>(<span class="stringliteral">&#39;date_format_locale&#39;</span>, <span class="stringliteral">&#39;d6_date_format_locale&#39;</span>);
<a name="l00664"></a>00664     }
<a name="l00665"></a>00665     <a class="code" href="group__schemaapi_gaf3a8307693d6b28374665c72531b429f.html#gaf3a8307693d6b28374665c72531b429f" title="Creates a new table from a Drupal table definition.">db_create_table</a>(<span class="stringliteral">&#39;date_format_locale&#39;</span>, $schema[<span class="stringliteral">&#39;date_format_locale&#39;</span>]);
<a name="l00666"></a>00666 
<a name="l00667"></a>00667     <span class="comment">// Add the queue table.</span>
<a name="l00668"></a>00668     $schema[<span class="stringliteral">&#39;queue&#39;</span>] = array(
<a name="l00669"></a>00669       <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Stores items in queues.&#39;</span>,
<a name="l00670"></a>00670       <span class="stringliteral">&#39;fields&#39;</span> =&gt; array(
<a name="l00671"></a>00671         <span class="stringliteral">&#39;item_id&#39;</span> =&gt; array(
<a name="l00672"></a>00672           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;serial&#39;</span>,
<a name="l00673"></a>00673           <span class="stringliteral">&#39;unsigned&#39;</span> =&gt; TRUE,
<a name="l00674"></a>00674           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00675"></a>00675           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Primary Key: Unique item ID.&#39;</span>,
<a name="l00676"></a>00676         ),
<a name="l00677"></a>00677         <span class="stringliteral">&#39;name&#39;</span> =&gt; array(
<a name="l00678"></a>00678           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>,
<a name="l00679"></a>00679           <span class="stringliteral">&#39;length&#39;</span> =&gt; 255,
<a name="l00680"></a>00680           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00681"></a>00681           <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00682"></a>00682           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;The queue name.&#39;</span>,
<a name="l00683"></a>00683         ),
<a name="l00684"></a>00684         <span class="stringliteral">&#39;data&#39;</span> =&gt; array(
<a name="l00685"></a>00685           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;blob&#39;</span>,
<a name="l00686"></a>00686           <span class="stringliteral">&#39;not null&#39;</span> =&gt; FALSE,
<a name="l00687"></a>00687           <span class="stringliteral">&#39;size&#39;</span> =&gt; <span class="stringliteral">&#39;big&#39;</span>,
<a name="l00688"></a>00688           <span class="stringliteral">&#39;serialize&#39;</span> =&gt; TRUE,
<a name="l00689"></a>00689           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;The arbitrary data for the item.&#39;</span>,
<a name="l00690"></a>00690         ),
<a name="l00691"></a>00691         <span class="stringliteral">&#39;expire&#39;</span> =&gt; array(
<a name="l00692"></a>00692           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;int&#39;</span>,
<a name="l00693"></a>00693           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00694"></a>00694           <span class="stringliteral">&#39;default&#39;</span> =&gt; 0,
<a name="l00695"></a>00695           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Timestamp when the claim lease expires on the item.&#39;</span>,
<a name="l00696"></a>00696         ),
<a name="l00697"></a>00697         <span class="stringliteral">&#39;created&#39;</span> =&gt; array(
<a name="l00698"></a>00698           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;int&#39;</span>,
<a name="l00699"></a>00699           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00700"></a>00700           <span class="stringliteral">&#39;default&#39;</span> =&gt; 0,
<a name="l00701"></a>00701           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Timestamp when the item was created.&#39;</span>,
<a name="l00702"></a>00702         ),
<a name="l00703"></a>00703       ),
<a name="l00704"></a>00704       <span class="stringliteral">&#39;primary key&#39;</span> =&gt; array(<span class="stringliteral">&#39;item_id&#39;</span>),
<a name="l00705"></a>00705       <span class="stringliteral">&#39;indexes&#39;</span> =&gt; array(
<a name="l00706"></a>00706         <span class="stringliteral">&#39;name_created&#39;</span> =&gt; array(<span class="stringliteral">&#39;name&#39;</span>, <span class="stringliteral">&#39;created&#39;</span>),
<a name="l00707"></a>00707         <span class="stringliteral">&#39;expire&#39;</span> =&gt; array(<span class="stringliteral">&#39;expire&#39;</span>),
<a name="l00708"></a>00708       ),
<a name="l00709"></a>00709     );
<a name="l00710"></a>00710     <span class="comment">// Check for queue table that may remain from D5 or D6, if found</span>
<a name="l00711"></a>00711     <span class="comment">//drop it.</span>
<a name="l00712"></a>00712     <span class="keywordflow">if</span> (<a class="code" href="group__schemaapi_ga78809300cee80db034832825aed55b70.html#ga78809300cee80db034832825aed55b70" title="Checks if a table exists.">db_table_exists</a>(<span class="stringliteral">&#39;queue&#39;</span>)) {
<a name="l00713"></a>00713       <a class="code" href="group__schemaapi_ga5d744ae7a6fe2c9eaa1c7bd350a071d3.html#ga5d744ae7a6fe2c9eaa1c7bd350a071d3" title="Drops a table.">db_drop_table</a>(<span class="stringliteral">&#39;queue&#39;</span>);
<a name="l00714"></a>00714     }
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     <a class="code" href="group__schemaapi_gaf3a8307693d6b28374665c72531b429f.html#gaf3a8307693d6b28374665c72531b429f" title="Creates a new table from a Drupal table definition.">db_create_table</a>(<span class="stringliteral">&#39;queue&#39;</span>, $schema[<span class="stringliteral">&#39;queue&#39;</span>]);
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     <span class="comment">// Create the sequences table.</span>
<a name="l00719"></a>00719     $schema[<span class="stringliteral">&#39;sequences&#39;</span>] = array(
<a name="l00720"></a>00720       <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;Stores IDs.&#39;</span>,
<a name="l00721"></a>00721       <span class="stringliteral">&#39;fields&#39;</span> =&gt; array(
<a name="l00722"></a>00722         <span class="stringliteral">&#39;value&#39;</span> =&gt; array(
<a name="l00723"></a>00723           <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;The value of the sequence.&#39;</span>,
<a name="l00724"></a>00724           <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;serial&#39;</span>,
<a name="l00725"></a>00725           <span class="stringliteral">&#39;unsigned&#39;</span> =&gt; TRUE,
<a name="l00726"></a>00726           <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE,
<a name="l00727"></a>00727         ),
<a name="l00728"></a>00728        ),
<a name="l00729"></a>00729       <span class="stringliteral">&#39;primary key&#39;</span> =&gt; array(<span class="stringliteral">&#39;value&#39;</span>),
<a name="l00730"></a>00730     );
<a name="l00731"></a>00731     <span class="comment">// Check for sequences table that may remain from D5 or D6, if found</span>
<a name="l00732"></a>00732     <span class="comment">//drop it.</span>
<a name="l00733"></a>00733     <span class="keywordflow">if</span> (<a class="code" href="group__schemaapi_ga78809300cee80db034832825aed55b70.html#ga78809300cee80db034832825aed55b70" title="Checks if a table exists.">db_table_exists</a>(<span class="stringliteral">&#39;sequences&#39;</span>)) {
<a name="l00734"></a>00734       <a class="code" href="group__schemaapi_ga5d744ae7a6fe2c9eaa1c7bd350a071d3.html#ga5d744ae7a6fe2c9eaa1c7bd350a071d3" title="Drops a table.">db_drop_table</a>(<span class="stringliteral">&#39;sequences&#39;</span>);
<a name="l00735"></a>00735     }
<a name="l00736"></a>00736     <a class="code" href="group__schemaapi_gaf3a8307693d6b28374665c72531b429f.html#gaf3a8307693d6b28374665c72531b429f" title="Creates a new table from a Drupal table definition.">db_create_table</a>(<span class="stringliteral">&#39;sequences&#39;</span>, $schema[<span class="stringliteral">&#39;sequences&#39;</span>]);
<a name="l00737"></a>00737     <span class="comment">// Initialize the table with the maximum current increment of the tables</span>
<a name="l00738"></a>00738     <span class="comment">// that will rely on it for their ids.</span>
<a name="l00739"></a>00739     $max_aid = <a class="code" href="group__database_gafa3b6cb2b2f61479cc63a4150c62da9b.html#gafa3b6cb2b2f61479cc63a4150c62da9b" title="The following utility functions are simply convenience wrappers.">db_query</a>(<span class="stringliteral">&#39;SELECT MAX(aid) FROM {actions_aid}&#39;</span>)-&gt;fetchField();
<a name="l00740"></a>00740     $max_uid = <a class="code" href="group__database_gafa3b6cb2b2f61479cc63a4150c62da9b.html#gafa3b6cb2b2f61479cc63a4150c62da9b" title="The following utility functions are simply convenience wrappers.">db_query</a>(<span class="stringliteral">&#39;SELECT MAX(uid) FROM {users}&#39;</span>)-&gt;fetchField();
<a name="l00741"></a>00741     $max_batch_id = <a class="code" href="group__database_gafa3b6cb2b2f61479cc63a4150c62da9b.html#gafa3b6cb2b2f61479cc63a4150c62da9b" title="The following utility functions are simply convenience wrappers.">db_query</a>(<span class="stringliteral">&#39;SELECT MAX(bid) FROM {batch}&#39;</span>)-&gt;fetchField();
<a name="l00742"></a>00742     <a class="code" href="group__database_gaadfbffaf30ff5eb14f1bd88619351345.html#gaadfbffaf30ff5eb14f1bd88619351345" title="Returns a new InsertQuery object for the active database.">db_insert</a>(<span class="stringliteral">&#39;sequences&#39;</span>)-&gt;fields(array(<span class="stringliteral">&#39;value&#39;</span> =&gt; max($max_aid, $max_uid, $max_batch_id)))-&gt;execute();
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     <span class="comment">// Add column for locale context.</span>
<a name="l00745"></a>00745     <span class="keywordflow">if</span> (<a class="code" href="group__schemaapi_ga78809300cee80db034832825aed55b70.html#ga78809300cee80db034832825aed55b70" title="Checks if a table exists.">db_table_exists</a>(<span class="stringliteral">&#39;locales_source&#39;</span>)) {
<a name="l00746"></a>00746       <a class="code" href="group__schemaapi_ga10bc9c435dd6d36c112d7ec179840cff.html#ga10bc9c435dd6d36c112d7ec179840cff" title="Adds a new field to a table.">db_add_field</a>(<span class="stringliteral">&#39;locales_source&#39;</span>, <span class="stringliteral">&#39;context&#39;</span>, array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;The context this string applies to.&#39;</span>));
<a name="l00747"></a>00747     }
<a name="l00748"></a>00748 
<a name="l00749"></a>00749     <span class="comment">// Rename &#39;site_offline_message&#39; variable to &#39;maintenance_mode_message&#39;</span>
<a name="l00750"></a>00750     <span class="comment">// and &#39;site_offline&#39; variable to &#39;maintenance_mode&#39;.</span>
<a name="l00751"></a>00751     <span class="comment">// Old variable is removed in update for system.module, see</span>
<a name="l00752"></a>00752     <span class="comment">// system_update_7072().</span>
<a name="l00753"></a>00753     <span class="keywordflow">if</span> ($message = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;site_offline_message&#39;</span>, NULL)) {
<a name="l00754"></a>00754       <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;maintenance_mode_message&#39;</span>, $message);
<a name="l00755"></a>00755     }
<a name="l00756"></a>00756     <span class="comment">// Old variable is removed in update for system.module, see</span>
<a name="l00757"></a>00757     <span class="comment">// system_update_7069().</span>
<a name="l00758"></a>00758     $site_offline = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;site_offline&#39;</span>, -1);
<a name="l00759"></a>00759     <span class="keywordflow">if</span> ($site_offline != -1) {
<a name="l00760"></a>00760       <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;maintenance_mode&#39;</span>, $site_offline);
<a name="l00761"></a>00761     }
<a name="l00762"></a>00762 
<a name="l00763"></a>00763     <span class="comment">// Add ssid column and index.</span>
<a name="l00764"></a>00764     <a class="code" href="group__schemaapi_ga10bc9c435dd6d36c112d7ec179840cff.html#ga10bc9c435dd6d36c112d7ec179840cff" title="Adds a new field to a table.">db_add_field</a>(<span class="stringliteral">&#39;sessions&#39;</span>, <span class="stringliteral">&#39;ssid&#39;</span>, array(<span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&quot;Secure session ID. The value is generated by Drupal&#39;s session handlers.&quot;</span>, <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 128, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>));
<a name="l00765"></a>00765     <a class="code" href="group__schemaapi_gafb7153a65df9b5a0877a602cde86a0cc.html#gafb7153a65df9b5a0877a602cde86a0cc" title="Adds an index.">db_add_index</a>(<span class="stringliteral">&#39;sessions&#39;</span>, <span class="stringliteral">&#39;ssid&#39;</span>, array(<span class="stringliteral">&#39;ssid&#39;</span>));
<a name="l00766"></a>00766     <span class="comment">// Drop existing primary key.</span>
<a name="l00767"></a>00767     <a class="code" href="group__schemaapi_ga733a41de3d8b74798a8cf3c87ae33715.html#ga733a41de3d8b74798a8cf3c87ae33715" title="Drops the primary key of a database table.">db_drop_primary_key</a>(<span class="stringliteral">&#39;sessions&#39;</span>);
<a name="l00768"></a>00768     <span class="comment">// Add new primary key.</span>
<a name="l00769"></a>00769     <a class="code" href="group__schemaapi_ga666b117ebedc9b50dacf193c6ba4dcf8.html#ga666b117ebedc9b50dacf193c6ba4dcf8" title="Adds a primary key to a database table.">db_add_primary_key</a>(<span class="stringliteral">&#39;sessions&#39;</span>, array(<span class="stringliteral">&#39;sid&#39;</span>, <span class="stringliteral">&#39;ssid&#39;</span>));
<a name="l00770"></a>00770 
<a name="l00771"></a>00771     <span class="comment">// Allow longer javascript file names.</span>
<a name="l00772"></a>00772     <span class="keywordflow">if</span> (<a class="code" href="group__schemaapi_ga78809300cee80db034832825aed55b70.html#ga78809300cee80db034832825aed55b70" title="Checks if a table exists.">db_table_exists</a>(<span class="stringliteral">&#39;languages&#39;</span>)) {
<a name="l00773"></a>00773       <a class="code" href="group__schemaapi_ga9e0a4211eb8137e187d5f3f4fa716cea.html#ga9e0a4211eb8137e187d5f3f4fa716cea" title="Changes a field definition.">db_change_field</a>(<span class="stringliteral">&#39;languages&#39;</span>, <span class="stringliteral">&#39;javascript&#39;</span>, <span class="stringliteral">&#39;javascript&#39;</span>, array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 64, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>));
<a name="l00774"></a>00774     }
<a name="l00775"></a>00775 
<a name="l00776"></a>00776     <span class="comment">// Rename action description to label.</span>
<a name="l00777"></a>00777     <a class="code" href="group__schemaapi_ga9e0a4211eb8137e187d5f3f4fa716cea.html#ga9e0a4211eb8137e187d5f3f4fa716cea" title="Changes a field definition.">db_change_field</a>(<span class="stringliteral">&#39;actions&#39;</span>, <span class="stringliteral">&#39;description&#39;</span>, <span class="stringliteral">&#39;label&#39;</span>, array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;varchar&#39;</span>, <span class="stringliteral">&#39;length&#39;</span> =&gt; 255, <span class="stringliteral">&#39;not null&#39;</span> =&gt; TRUE, <span class="stringliteral">&#39;default&#39;</span> =&gt; <span class="charliteral">&#39;0&#39;</span>));
<a name="l00778"></a>00778 
<a name="l00779"></a>00779     <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;update_d7_requirements&#39;</span>, TRUE);
<a name="l00780"></a>00780   }
<a name="l00781"></a>00781 
<a name="l00782"></a>00782   <a class="code" href="update_8inc_a4c65cc44fc9d615c6f69ac8ecb57bf5a.html#a4c65cc44fc9d615c6f69ac8ecb57bf5a" title="Register the currently installed profile in the system table.">update_fix_d7_install_profile</a>();
<a name="l00783"></a>00783 }
<a name="l00784"></a>00784 
<a name="l00795"></a><a class="code" href="update_8inc_a4c65cc44fc9d615c6f69ac8ecb57bf5a.html#a4c65cc44fc9d615c6f69ac8ecb57bf5a">00795</a> <span class="keyword">function</span> <a class="code" href="update_8inc_a4c65cc44fc9d615c6f69ac8ecb57bf5a.html#a4c65cc44fc9d615c6f69ac8ecb57bf5a" title="Register the currently installed profile in the system table.">update_fix_d7_install_profile</a>() {
<a name="l00796"></a>00796   $profile = <a class="code" href="common_8inc_a4128f0023ccec2d1a9a40987f0131d83.html#a4128f0023ccec2d1a9a40987f0131d83" title="Gets the name of the currently active install profile.">drupal_get_profile</a>();
<a name="l00797"></a>00797 
<a name="l00798"></a>00798   $results = <a class="code" href="group__database_ga9e030cee657d64e3d8e524c65814cc9f.html#ga9e030cee657d64e3d8e524c65814cc9f" title="Returns a new SelectQuery object for the active database.">db_select</a>(<span class="stringliteral">&#39;system&#39;</span>, <span class="charliteral">&#39;s&#39;</span>)
<a name="l00799"></a>00799     -&gt;fields(<span class="charliteral">&#39;s&#39;</span>, array(<span class="stringliteral">&#39;name&#39;</span>, <span class="stringliteral">&#39;schema_version&#39;</span>))
<a name="l00800"></a>00800     -&gt;condition(<span class="stringliteral">&#39;name&#39;</span>, $profile)
<a name="l00801"></a>00801     -&gt;condition(<span class="stringliteral">&#39;type&#39;</span>, <span class="stringliteral">&#39;module&#39;</span>)
<a name="l00802"></a>00802     -&gt;execute()
<a name="l00803"></a>00803     -&gt;fetchAll();
<a name="l00804"></a>00804 
<a name="l00805"></a>00805   <span class="keywordflow">if</span> (empty($results)) {
<a name="l00806"></a>00806     $filename = <span class="stringliteral">&#39;profiles/&#39;</span> . $profile . <span class="charliteral">&#39;/&#39;</span> . $profile . <span class="stringliteral">&#39;.profile&#39;</span>;
<a name="l00807"></a>00807 
<a name="l00808"></a>00808     <span class="comment">// Read profile info file</span>
<a name="l00809"></a>00809     $info = <a class="code" href="common_8inc_a277955232059631211fcfde533ea89d6.html#a277955232059631211fcfde533ea89d6" title="End of &quot;addtogroup schemaapi&quot;.">drupal_parse_info_file</a>(dirname($filename) . <span class="charliteral">&#39;/&#39;</span> . $profile . <span class="stringliteral">&#39;.info&#39;</span>);
<a name="l00810"></a>00810 
<a name="l00811"></a>00811     <span class="comment">// Merge in defaults.</span>
<a name="l00812"></a>00812     $info = $info + array(
<a name="l00813"></a>00813       <span class="stringliteral">&#39;dependencies&#39;</span> =&gt; array(),
<a name="l00814"></a>00814       <span class="stringliteral">&#39;description&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00815"></a>00815       <span class="stringliteral">&#39;package&#39;</span> =&gt; <span class="stringliteral">&#39;Other&#39;</span>,
<a name="l00816"></a>00816       <span class="stringliteral">&#39;version&#39;</span> =&gt; NULL,
<a name="l00817"></a>00817       <span class="stringliteral">&#39;php&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a370c52d1679da96064df124c55f16ea8.html#a370c52d1679da96064df124c55f16ea8" title="Minimum supported version of PHP.">DRUPAL_MINIMUM_PHP</a>,
<a name="l00818"></a>00818       <span class="stringliteral">&#39;files&#39;</span> =&gt; array(),
<a name="l00819"></a>00819     );
<a name="l00820"></a>00820 
<a name="l00821"></a>00821     $values = array(
<a name="l00822"></a>00822       <span class="stringliteral">&#39;filename&#39;</span> =&gt; $filename,
<a name="l00823"></a>00823       <span class="stringliteral">&#39;name&#39;</span> =&gt; $profile,
<a name="l00824"></a>00824       <span class="stringliteral">&#39;info&#39;</span> =&gt; serialize($info),
<a name="l00825"></a>00825       <span class="stringliteral">&#39;schema_version&#39;</span> =&gt; 0,
<a name="l00826"></a>00826       <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;module&#39;</span>,
<a name="l00827"></a>00827       <span class="stringliteral">&#39;status&#39;</span> =&gt; 1,
<a name="l00828"></a>00828       <span class="stringliteral">&#39;owner&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00829"></a>00829     );
<a name="l00830"></a>00830 
<a name="l00831"></a>00831     <span class="comment">// Install profile hooks are always executed last by the module system</span>
<a name="l00832"></a>00832     $values[<span class="stringliteral">&#39;weight&#39;</span>] = 1000;
<a name="l00833"></a>00833 
<a name="l00834"></a>00834     <span class="comment">// Initializing the system table entry for the install profile</span>
<a name="l00835"></a>00835     <a class="code" href="group__database_gaadfbffaf30ff5eb14f1bd88619351345.html#gaadfbffaf30ff5eb14f1bd88619351345" title="Returns a new InsertQuery object for the active database.">db_insert</a>(<span class="stringliteral">&#39;system&#39;</span>)
<a name="l00836"></a>00836       -&gt;fields(array_keys($values))
<a name="l00837"></a>00837       -&gt;values($values)
<a name="l00838"></a>00838       -&gt;execute();
<a name="l00839"></a>00839 
<a name="l00840"></a>00840     <span class="comment">// Reset the cached schema version.</span>
<a name="l00841"></a>00841     <a class="code" href="install_8inc_a7702ece36adbef6e165e6f9c2bde5953.html#a7702ece36adbef6e165e6f9c2bde5953" title="Returns the currently installed schema version for a module.">drupal_get_installed_schema_version</a>($profile, TRUE);
<a name="l00842"></a>00842 
<a name="l00843"></a>00843     <span class="comment">// Load the updates again to make sure the install profile updates are loaded</span>
<a name="l00844"></a>00844     <a class="code" href="install_8inc_a0c6d0aed425d08e6001378191d6bc1d9.html#a0c6d0aed425d08e6001378191d6bc1d9" title="Initialize the update system by loading all installed module&#39;s .install files.">drupal_load_updates</a>();
<a name="l00845"></a>00845   }
<a name="l00846"></a>00846 }
<a name="l00847"></a>00847 
<a name="l00854"></a><a class="code" href="update_8inc_a39f4938dea0ce704d1e426243cec11ec.html#a39f4938dea0ce704d1e426243cec11ec">00854</a> <span class="keyword">function</span> <a class="code" href="update_8inc_a39f4938dea0ce704d1e426243cec11ec.html#a39f4938dea0ce704d1e426243cec11ec" title="Parse pre-Drupal 7 database connection URLs and return D7 compatible array.">update_parse_db_url</a>($db_url, $db_prefix) {
<a name="l00855"></a>00855   <a class="code" href="default_8settings_8php_a97cde67402a68697692531e8b067f86f.html#a97cde67402a68697692531e8b067f86f" title="Database settings:">$databases</a> = array();
<a name="l00856"></a>00856   <span class="keywordflow">if</span> (!is_array($db_url)) {
<a name="l00857"></a>00857     $db_url = array(<span class="stringliteral">&#39;default&#39;</span> =&gt; $db_url);
<a name="l00858"></a>00858   }
<a name="l00859"></a>00859   <span class="keywordflow">foreach</span> ($db_url as $database =&gt; $url) {
<a name="l00860"></a>00860     $url = parse_url($url);
<a name="l00861"></a>00861     <a class="code" href="default_8settings_8php_a97cde67402a68697692531e8b067f86f.html#a97cde67402a68697692531e8b067f86f" title="Database settings:">$databases</a>[$database][<span class="stringliteral">&#39;default&#39;</span>] = array(
<a name="l00862"></a>00862       <span class="comment">// MySQLi uses the mysql driver.</span>
<a name="l00863"></a>00863       <span class="stringliteral">&#39;driver&#39;</span> =&gt; $url[<span class="stringliteral">&#39;scheme&#39;</span>] == <span class="stringliteral">&#39;mysqli&#39;</span> ? <span class="stringliteral">&#39;mysql&#39;</span> : $url[<span class="stringliteral">&#39;scheme&#39;</span>],
<a name="l00864"></a>00864       <span class="comment">// Remove the leading slash to get the database name.</span>
<a name="l00865"></a>00865       <span class="stringliteral">&#39;database&#39;</span> =&gt; substr(urldecode($url[<span class="stringliteral">&#39;path&#39;</span>]), 1),
<a name="l00866"></a>00866       <span class="stringliteral">&#39;username&#39;</span> =&gt; urldecode($url[<span class="stringliteral">&#39;user&#39;</span>]),
<a name="l00867"></a>00867       <span class="stringliteral">&#39;password&#39;</span> =&gt; isset($url[<span class="stringliteral">&#39;pass&#39;</span>]) ? urldecode($url[<span class="stringliteral">&#39;pass&#39;</span>]) : <span class="stringliteral">&#39;&#39;</span>,
<a name="l00868"></a>00868       <span class="stringliteral">&#39;host&#39;</span> =&gt; urldecode($url[<span class="stringliteral">&#39;host&#39;</span>]),
<a name="l00869"></a>00869       <span class="stringliteral">&#39;port&#39;</span> =&gt; isset($url[<span class="stringliteral">&#39;port&#39;</span>]) ? urldecode($url[<span class="stringliteral">&#39;port&#39;</span>]) : <span class="stringliteral">&#39;&#39;</span>,
<a name="l00870"></a>00870     );
<a name="l00871"></a>00871     <span class="keywordflow">if</span> (isset($db_prefix)) {
<a name="l00872"></a>00872       <a class="code" href="default_8settings_8php_a97cde67402a68697692531e8b067f86f.html#a97cde67402a68697692531e8b067f86f" title="Database settings:">$databases</a>[$database][<span class="stringliteral">&#39;default&#39;</span>][<span class="stringliteral">&#39;prefix&#39;</span>] = $db_prefix;
<a name="l00873"></a>00873     }
<a name="l00874"></a>00874   }
<a name="l00875"></a>00875   <span class="keywordflow">return</span> <a class="code" href="default_8settings_8php_a97cde67402a68697692531e8b067f86f.html#a97cde67402a68697692531e8b067f86f" title="Database settings:">$databases</a>;
<a name="l00876"></a>00876 }
<a name="l00877"></a>00877 
<a name="l00886"></a><a class="code" href="update_8inc_a1e41248922d100f2412b8471c05c59be.html#a1e41248922d100f2412b8471c05c59be">00886</a> <span class="keyword">function</span> <a class="code" href="update_8inc_a1e41248922d100f2412b8471c05c59be.html#a1e41248922d100f2412b8471c05c59be" title="Constructs a session name compatible with a D6 environment.">update_get_d6_session_name</a>() {
<a name="l00887"></a>00887   global $base_url, $cookie_domain;
<a name="l00888"></a>00888   $cookie_secure = ini_get(<span class="stringliteral">&#39;session.cookie_secure&#39;</span>);
<a name="l00889"></a>00889 
<a name="l00890"></a>00890   <span class="comment">// If a custom cookie domain is set in settings.php, that variable forms</span>
<a name="l00891"></a>00891   <span class="comment">// the basis of the session name. Re-compute the D7 hashing method to find</span>
<a name="l00892"></a>00892   <span class="comment">// out if $cookie_domain was used as the session name.</span>
<a name="l00893"></a>00893   <span class="keywordflow">if</span> (($cookie_secure ? <span class="stringliteral">&#39;SSESS&#39;</span> : <span class="stringliteral">&#39;SESS&#39;</span>) . substr(hash(<span class="stringliteral">&#39;sha256&#39;</span>, $cookie_domain), 0, 32) == session_name()) {
<a name="l00894"></a>00894     $session_name = $cookie_domain;
<a name="l00895"></a>00895   }
<a name="l00896"></a>00896   <span class="keywordflow">else</span> {
<a name="l00897"></a>00897     <span class="comment">// Otherwise use $base_url as session name, without the protocol</span>
<a name="l00898"></a>00898     <span class="comment">// to use the same session identifiers across http and https.</span>
<a name="l00899"></a>00899     list( , $session_name) = explode(<span class="stringliteral">&#39;://&#39;</span>, $base_url, 2);
<a name="l00900"></a>00900   }
<a name="l00901"></a>00901 
<a name="l00902"></a>00902   <span class="keywordflow">if</span> ($cookie_secure) {
<a name="l00903"></a>00903     $session_name .= <span class="stringliteral">&#39;SSL&#39;</span>;
<a name="l00904"></a>00904   }
<a name="l00905"></a>00905 
<a name="l00906"></a>00906   <span class="keywordflow">return</span> <span class="stringliteral">&#39;SESS&#39;</span> . md5($session_name);
<a name="l00907"></a>00907 }
<a name="l00908"></a>00908 
<a name="l00950"></a><a class="code" href="update_8inc_ac46854f64e50a81361ed8816b8f0ce7e.html#ac46854f64e50a81361ed8816b8f0ce7e">00950</a> <span class="keyword">function</span> <a class="code" href="update_8inc_ac46854f64e50a81361ed8816b8f0ce7e.html#ac46854f64e50a81361ed8816b8f0ce7e" title="Perform one update and store the results for display on finished page.">update_do_one</a>($module, $number, $dependency_map, &amp;$context) {
<a name="l00951"></a>00951   $function = $module . <span class="stringliteral">&#39;_update_&#39;</span> . $number;
<a name="l00952"></a>00952 
<a name="l00953"></a>00953   <span class="comment">// If this update was aborted in a previous step, or has a dependency that</span>
<a name="l00954"></a>00954   <span class="comment">// was aborted in a previous step, go no further.</span>
<a name="l00955"></a>00955   <span class="keywordflow">if</span> (!empty($context[<span class="stringliteral">&#39;results&#39;</span>][<span class="stringliteral">&#39;#abort&#39;</span>]) &amp;&amp; array_intersect($context[<span class="stringliteral">&#39;results&#39;</span>][<span class="stringliteral">&#39;#abort&#39;</span>], array_merge($dependency_map, array($function)))) {
<a name="l00956"></a>00956     <span class="keywordflow">return</span>;
<a name="l00957"></a>00957   }
<a name="l00958"></a>00958 
<a name="l00959"></a>00959   $ret = array();
<a name="l00960"></a>00960   <span class="keywordflow">if</span> (function_exists($function)) {
<a name="l00961"></a>00961     <span class="keywordflow">try</span> {
<a name="l00962"></a>00962       $ret[<span class="stringliteral">&#39;results&#39;</span>][<span class="stringliteral">&#39;query&#39;</span>] = $function($context[<span class="stringliteral">&#39;sandbox&#39;</span>]);
<a name="l00963"></a>00963       $ret[<span class="stringliteral">&#39;results&#39;</span>][<span class="stringliteral">&#39;success&#39;</span>] = TRUE;
<a name="l00964"></a>00964     }
<a name="l00965"></a>00965     <span class="comment">// @TODO We may want to do different error handling for different</span>
<a name="l00966"></a>00966     <span class="comment">// exception types, but for now we&#39;ll just log the exception and</span>
<a name="l00967"></a>00967     <span class="comment">// return the message for printing.</span>
<a name="l00968"></a>00968     <span class="keywordflow">catch</span> (<a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a> $e) {
<a name="l00969"></a>00969       <a class="code" href="bootstrap_8inc_aba38f35647efce6b4099dc59131e216b.html#aba38f35647efce6b4099dc59131e216b" title="Logs an exception.">watchdog_exception</a>(<span class="stringliteral">&#39;update&#39;</span>, $e);
<a name="l00970"></a>00970 
<a name="l00971"></a>00971       require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/errors.inc&#39;</span>;
<a name="l00972"></a>00972       $variables = <a class="code" href="errors_8inc_ace892832385b7832c106f55f8896060d.html#ace892832385b7832c106f55f8896060d" title="Decodes an exception and retrieves the correct caller.">_drupal_decode_exception</a>($e);
<a name="l00973"></a>00973       <span class="comment">// The exception message is run through check_plain() by _drupal_decode_exception().</span>
<a name="l00974"></a>00974       $ret[<span class="stringliteral">&#39;#abort&#39;</span>] = array(<span class="stringliteral">&#39;success&#39;</span> =&gt; FALSE, <span class="stringliteral">&#39;query&#39;</span> =&gt; <a class="code" href="bootstrap_8inc_a1be9937b04ff350b23d01fddef1e031a.html#a1be9937b04ff350b23d01fddef1e031a" title="Replaces placeholders with sanitized values in a string.">t</a>(<span class="stringliteral">&#39;%type: !message in %function (line %line of %file).&#39;</span>, $variables));
<a name="l00975"></a>00975     }
<a name="l00976"></a>00976   }
<a name="l00977"></a>00977 
<a name="l00978"></a>00978   <span class="keywordflow">if</span> (isset($context[<span class="stringliteral">&#39;sandbox&#39;</span>][<span class="stringliteral">&#39;#finished&#39;</span>])) {
<a name="l00979"></a>00979     $context[<span class="stringliteral">&#39;finished&#39;</span>] = $context[<span class="stringliteral">&#39;sandbox&#39;</span>][<span class="stringliteral">&#39;#finished&#39;</span>];
<a name="l00980"></a>00980     unset($context[<span class="stringliteral">&#39;sandbox&#39;</span>][<span class="stringliteral">&#39;#finished&#39;</span>]);
<a name="l00981"></a>00981   }
<a name="l00982"></a>00982 
<a name="l00983"></a>00983   <span class="keywordflow">if</span> (!isset($context[<span class="stringliteral">&#39;results&#39;</span>][$module])) {
<a name="l00984"></a>00984     $context[<span class="stringliteral">&#39;results&#39;</span>][$module] = array();
<a name="l00985"></a>00985   }
<a name="l00986"></a>00986   <span class="keywordflow">if</span> (!isset($context[<span class="stringliteral">&#39;results&#39;</span>][$module][$number])) {
<a name="l00987"></a>00987     $context[<span class="stringliteral">&#39;results&#39;</span>][$module][$number] = array();
<a name="l00988"></a>00988   }
<a name="l00989"></a>00989   $context[<span class="stringliteral">&#39;results&#39;</span>][$module][$number] = array_merge($context[<span class="stringliteral">&#39;results&#39;</span>][$module][$number], $ret);
<a name="l00990"></a>00990 
<a name="l00991"></a>00991   <span class="keywordflow">if</span> (!empty($ret[<span class="stringliteral">&#39;#abort&#39;</span>])) {
<a name="l00992"></a>00992     <span class="comment">// Record this function in the list of updates that were aborted.</span>
<a name="l00993"></a>00993     $context[<span class="stringliteral">&#39;results&#39;</span>][<span class="stringliteral">&#39;#abort&#39;</span>][] = $function;
<a name="l00994"></a>00994   }
<a name="l00995"></a>00995 
<a name="l00996"></a>00996   <span class="comment">// Record the schema update if it was completed successfully.</span>
<a name="l00997"></a>00997   <span class="keywordflow">if</span> ($context[<span class="stringliteral">&#39;finished&#39;</span>] == 1 &amp;&amp; empty($ret[<span class="stringliteral">&#39;#abort&#39;</span>])) {
<a name="l00998"></a>00998     <a class="code" href="install_8inc_a2bc19b43e5872bf61c359839ccaec97b.html#a2bc19b43e5872bf61c359839ccaec97b" title="Update the installed version information for a module.">drupal_set_installed_schema_version</a>($module, $number);
<a name="l00999"></a>00999   }
<a name="l01000"></a>01000 
<a name="l01001"></a>01001   $context[<span class="stringliteral">&#39;message&#39;</span>] = <span class="stringliteral">&#39;Updating &#39;</span> . <a class="code" href="group__sanitization_ga76fc67a30fd8d75ddd80565e6e65a13d.html#ga76fc67a30fd8d75ddd80565e6e65a13d" title="Encodes special characters in a plain-text string for display as HTML.">check_plain</a>($module) . <span class="stringliteral">&#39; module&#39;</span>;
<a name="l01002"></a>01002 }
<a name="l01003"></a>01003 
<a name="l01007"></a><a class="code" href="classDrupalUpdateException.html">01007</a> <span class="keyword">class </span><a class="code" href="classDrupalUpdateException.html">DrupalUpdateException</a> <span class="keyword">extends</span> <a class="code" href="classException.html" title="to throw error if a module update fails.">Exception</a> { }
<a name="l01008"></a>01008 
<a name="l01031"></a><a class="code" href="update_8inc_aa4dd3d84e553f6bf25ad19608152d5b7.html#aa4dd3d84e553f6bf25ad19608152d5b7">01031</a> <span class="keyword">function</span> <a class="code" href="update_8inc_aa4dd3d84e553f6bf25ad19608152d5b7.html#aa4dd3d84e553f6bf25ad19608152d5b7" title="Start the database update batch process.">update_batch</a>($start, $redirect = NULL, $url = NULL, $batch = array(), $redirect_callback = <span class="stringliteral">&#39;drupal_goto&#39;</span>) {
<a name="l01032"></a>01032   <span class="comment">// During the update, bring the site offline so that schema changes do not</span>
<a name="l01033"></a>01033   <span class="comment">// affect visiting users.</span>
<a name="l01034"></a>01034   $_SESSION[<span class="stringliteral">&#39;maintenance_mode&#39;</span>] = <a class="code" href="bootstrap_8inc_a1be2160d5e5a1a9b9a0c90944c4f5252.html#a1be2160d5e5a1a9b9a0c90944c4f5252" title="Returns a persistent variable.">variable_get</a>(<span class="stringliteral">&#39;maintenance_mode&#39;</span>, FALSE);
<a name="l01035"></a>01035   <span class="keywordflow">if</span> ($_SESSION[<span class="stringliteral">&#39;maintenance_mode&#39;</span>] == FALSE) {
<a name="l01036"></a>01036     <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;maintenance_mode&#39;</span>, TRUE);
<a name="l01037"></a>01037   }
<a name="l01038"></a>01038 
<a name="l01039"></a>01039   <span class="comment">// Resolve any update dependencies to determine the actual updates that will</span>
<a name="l01040"></a>01040   <span class="comment">// be run and the order they will be run in.</span>
<a name="l01041"></a>01041   $updates = <a class="code" href="update_8inc_aa931d6cdddc2e9e0ec96d240523056e9.html#aa931d6cdddc2e9e0ec96d240523056e9" title="Resolves dependencies in a set of module updates, and orders them correctly.">update_resolve_dependencies</a>($start);
<a name="l01042"></a>01042 
<a name="l01043"></a>01043   <span class="comment">// Store the dependencies for each update function in an array which the</span>
<a name="l01044"></a>01044   <span class="comment">// batch API can pass in to the batch operation each time it is called. (We</span>
<a name="l01045"></a>01045   <span class="comment">// do not store the entire update dependency array here because it is</span>
<a name="l01046"></a>01046   <span class="comment">// potentially very large.)</span>
<a name="l01047"></a>01047   $dependency_map = array();
<a name="l01048"></a>01048   <span class="keywordflow">foreach</span> ($updates as $function =&gt; $update) {
<a name="l01049"></a>01049     $dependency_map[$function] = !empty($update[<span class="stringliteral">&#39;reverse_paths&#39;</span>]) ? array_keys($update[<span class="stringliteral">&#39;reverse_paths&#39;</span>]) : array();
<a name="l01050"></a>01050   }
<a name="l01051"></a>01051 
<a name="l01052"></a>01052   $operations = array();
<a name="l01053"></a>01053   <span class="keywordflow">foreach</span> ($updates as $update) {
<a name="l01054"></a>01054     <span class="keywordflow">if</span> ($update[<span class="stringliteral">&#39;allowed&#39;</span>]) {
<a name="l01055"></a>01055       <span class="comment">// Set the installed version of each module so updates will start at the</span>
<a name="l01056"></a>01056       <span class="comment">// correct place. (The updates are already sorted, so we can simply base</span>
<a name="l01057"></a>01057       <span class="comment">// this on the first one we come across in the above foreach loop.)</span>
<a name="l01058"></a>01058       <span class="keywordflow">if</span> (isset($start[$update[<span class="stringliteral">&#39;module&#39;</span>]])) {
<a name="l01059"></a>01059         <a class="code" href="install_8inc_a2bc19b43e5872bf61c359839ccaec97b.html#a2bc19b43e5872bf61c359839ccaec97b" title="Update the installed version information for a module.">drupal_set_installed_schema_version</a>($update[<span class="stringliteral">&#39;module&#39;</span>], $update[<span class="stringliteral">&#39;number&#39;</span>] - 1);
<a name="l01060"></a>01060         unset($start[$update[<span class="stringliteral">&#39;module&#39;</span>]]);
<a name="l01061"></a>01061       }
<a name="l01062"></a>01062       <span class="comment">// Add this update function to the batch.</span>
<a name="l01063"></a>01063       $function = $update[<span class="stringliteral">&#39;module&#39;</span>] . <span class="stringliteral">&#39;_update_&#39;</span> . $update[<span class="stringliteral">&#39;number&#39;</span>];
<a name="l01064"></a>01064       $operations[] = array(<span class="stringliteral">&#39;update_do_one&#39;</span>, array($update[<span class="stringliteral">&#39;module&#39;</span>], $update[<span class="stringliteral">&#39;number&#39;</span>], $dependency_map[$function]));
<a name="l01065"></a>01065     }
<a name="l01066"></a>01066   }
<a name="l01067"></a>01067   $batch[<span class="stringliteral">&#39;operations&#39;</span>] = $operations;
<a name="l01068"></a>01068   $batch += array(
<a name="l01069"></a>01069     <span class="stringliteral">&#39;title&#39;</span> =&gt; <span class="stringliteral">&#39;Updating&#39;</span>,
<a name="l01070"></a>01070     <span class="stringliteral">&#39;init_message&#39;</span> =&gt; <span class="stringliteral">&#39;Starting updates&#39;</span>,
<a name="l01071"></a>01071     <span class="stringliteral">&#39;error_message&#39;</span> =&gt; <span class="stringliteral">&#39;An unrecoverable error has occurred. You can find the error message below. It is advised to copy it to the clipboard for reference.&#39;</span>,
<a name="l01072"></a>01072     <span class="stringliteral">&#39;finished&#39;</span> =&gt; <span class="stringliteral">&#39;update_finished&#39;</span>,
<a name="l01073"></a>01073     <span class="stringliteral">&#39;file&#39;</span> =&gt; <span class="stringliteral">&#39;includes/update.inc&#39;</span>,
<a name="l01074"></a>01074   );
<a name="l01075"></a>01075   <a class="code" href="group__batch_ga9ff3f18b3bdd1d62ab7ac681a22a7170.html#ga9ff3f18b3bdd1d62ab7ac681a22a7170" title="Adds a new batch.">batch_set</a>($batch);
<a name="l01076"></a>01076   <a class="code" href="group__batch_gab17f59692632a482cee4f65f27d082f7.html#gab17f59692632a482cee4f65f27d082f7" title="Processes the batch.">batch_process</a>($redirect, $url, $redirect_callback);
<a name="l01077"></a>01077 }
<a name="l01078"></a>01078 
<a name="l01096"></a><a class="code" href="update_8inc_a80f7fdd8ca66ebda4959b9429fc343f3.html#a80f7fdd8ca66ebda4959b9429fc343f3">01096</a> <span class="keyword">function</span> <a class="code" href="update_8inc_a80f7fdd8ca66ebda4959b9429fc343f3.html#a80f7fdd8ca66ebda4959b9429fc343f3" title="Finish the update process and store results for eventual display.">update_finished</a>($success, $results, $operations) {
<a name="l01097"></a>01097   <span class="comment">// Remove the D6 upgrade flag variable so that subsequent update runs do not</span>
<a name="l01098"></a>01098   <span class="comment">// get the wrong context.</span>
<a name="l01099"></a>01099   <a class="code" href="bootstrap_8inc_a7850bff5f313f85335f418e6d87606b1.html#a7850bff5f313f85335f418e6d87606b1" title="Unsets a persistent variable.">variable_del</a>(<span class="stringliteral">&#39;update_d6&#39;</span>);
<a name="l01100"></a>01100 
<a name="l01101"></a>01101   <span class="comment">// Clear the caches in case the data has been updated.</span>
<a name="l01102"></a>01102   <a class="code" href="common_8inc_ac119432cefbdbb25647944d4ca3f82f8.html#ac119432cefbdbb25647944d4ca3f82f8" title="Flushes all cached data on the site.">drupal_flush_all_caches</a>();
<a name="l01103"></a>01103 
<a name="l01104"></a>01104   $_SESSION[<span class="stringliteral">&#39;update_results&#39;</span>] = $results;
<a name="l01105"></a>01105   $_SESSION[<span class="stringliteral">&#39;update_success&#39;</span>] = $success;
<a name="l01106"></a>01106   $_SESSION[<span class="stringliteral">&#39;updates_remaining&#39;</span>] = $operations;
<a name="l01107"></a>01107 
<a name="l01108"></a>01108   <span class="comment">// Now that the update is done, we can put the site back online if it was</span>
<a name="l01109"></a>01109   <span class="comment">// previously in maintenance mode.</span>
<a name="l01110"></a>01110   <span class="keywordflow">if</span> (isset($_SESSION[<span class="stringliteral">&#39;maintenance_mode&#39;</span>]) &amp;&amp; $_SESSION[<span class="stringliteral">&#39;maintenance_mode&#39;</span>] == FALSE) {
<a name="l01111"></a>01111     <a class="code" href="bootstrap_8inc_a9859faa6fcd56ca6048be93dace95999.html#a9859faa6fcd56ca6048be93dace95999" title="Sets a persistent variable.">variable_set</a>(<span class="stringliteral">&#39;maintenance_mode&#39;</span>, FALSE);
<a name="l01112"></a>01112     unset($_SESSION[<span class="stringliteral">&#39;maintenance_mode&#39;</span>]);
<a name="l01113"></a>01113   }
<a name="l01114"></a>01114 }
<a name="l01115"></a>01115 
<a name="l01134"></a><a class="code" href="update_8inc_ae95fb5ec58e85fd5c10c56345fd7cabe.html#ae95fb5ec58e85fd5c10c56345fd7cabe">01134</a> <span class="keyword">function</span> <a class="code" href="update_8inc_ae95fb5ec58e85fd5c10c56345fd7cabe.html#ae95fb5ec58e85fd5c10c56345fd7cabe" title="Return a list of all the pending database updates.">update_get_update_list</a>() {
<a name="l01135"></a>01135   <span class="comment">// Make sure that the system module is first in the list of updates.</span>
<a name="l01136"></a>01136   $ret = array(<span class="stringliteral">&#39;system&#39;</span> =&gt; array());
<a name="l01137"></a>01137 
<a name="l01138"></a>01138   $modules = <a class="code" href="install_8inc_a7702ece36adbef6e165e6f9c2bde5953.html#a7702ece36adbef6e165e6f9c2bde5953" title="Returns the currently installed schema version for a module.">drupal_get_installed_schema_version</a>(NULL, FALSE, TRUE);
<a name="l01139"></a>01139   <span class="keywordflow">foreach</span> ($modules as $module =&gt; $schema_version) {
<a name="l01140"></a>01140     <span class="comment">// Skip uninstalled and incompatible modules.</span>
<a name="l01141"></a>01141     <span class="keywordflow">if</span> ($schema_version == <a class="code" href="install_8inc_ab2f11b038ed6a537bfdd257be863075f.html#ab2f11b038ed6a537bfdd257be863075f" title="Indicates that a module has not been installed yet.">SCHEMA_UNINSTALLED</a> || <a class="code" href="update_8inc_a39592132a77fd791c44a8d6faf362cb0.html#a39592132a77fd791c44a8d6faf362cb0" title="Helper function to test compatibility of a module or theme.">update_check_incompatibility</a>($module)) {
<a name="l01142"></a>01142       <span class="keywordflow">continue</span>;
<a name="l01143"></a>01143     }
<a name="l01144"></a>01144     <span class="comment">// Otherwise, get the list of updates defined by this module.</span>
<a name="l01145"></a>01145     $updates = <a class="code" href="install_8inc_a1e68a61662f821bde8606568fda7bf58.html#a1e68a61662f821bde8606568fda7bf58" title="Returns an array of available schema versions for a module.">drupal_get_schema_versions</a>($module);
<a name="l01146"></a>01146     <span class="keywordflow">if</span> ($updates !== FALSE) {
<a name="l01147"></a>01147       <span class="comment">// module_invoke returns NULL for nonexisting hooks, so if no updates</span>
<a name="l01148"></a>01148       <span class="comment">// are removed, it will == 0.</span>
<a name="l01149"></a>01149       $last_removed = <a class="code" href="group__hooks_ga7547905cff161d057f9e71088ec67f05.html#ga7547905cff161d057f9e71088ec67f05" title="Invoke a hook in a particular module.">module_invoke</a>($module, <span class="stringliteral">&#39;update_last_removed&#39;</span>);
<a name="l01150"></a>01150       <span class="keywordflow">if</span> ($schema_version &lt; $last_removed) {
<a name="l01151"></a>01151         $ret[$module][<span class="stringliteral">&#39;warning&#39;</span>] = <span class="stringliteral">&#39;&lt;em&gt;&#39;</span> . $module . <span class="stringliteral">&#39;&lt;/em&gt; module can not be updated. Its schema version is &#39;</span> . $schema_version . <span class="stringliteral">&#39;. Updates up to and including &#39;</span> . $last_removed . <span class="stringliteral">&#39; have been removed in this release. In order to update &lt;em&gt;&#39;</span> . $module . <span class="stringliteral">&#39;&lt;/em&gt; module, you will first &lt;a href=&quot;http://drupal.org/upgrade&quot;&gt;need to upgrade&lt;/a&gt; to the last version in which these updates were available.&#39;</span>;
<a name="l01152"></a>01152         <span class="keywordflow">continue</span>;
<a name="l01153"></a>01153       }
<a name="l01154"></a>01154 
<a name="l01155"></a>01155       $updates = <a class="code" href="common_8inc_a72b55fe42aa726cc506660138abd3307.html#a72b55fe42aa726cc506660138abd3307" title="Forms an associative array from a linear array.">drupal_map_assoc</a>($updates);
<a name="l01156"></a>01156       <span class="keywordflow">foreach</span> (array_keys($updates) as $update) {
<a name="l01157"></a>01157         <span class="keywordflow">if</span> ($update &gt; $schema_version) {
<a name="l01158"></a>01158           <span class="comment">// The description for an update comes from its Doxygen.</span>
<a name="l01159"></a>01159           $func = <span class="keyword">new</span> ReflectionFunction($module . <span class="stringliteral">&#39;_update_&#39;</span> . $update);
<a name="l01160"></a>01160           $description = str_replace(array(<span class="stringliteral">&quot;\n&quot;</span>, <span class="charliteral">&#39;*&#39;</span>, <span class="charliteral">&#39;/&#39;</span>), <span class="stringliteral">&#39;&#39;</span>, $func-&gt;getDocComment());
<a name="l01161"></a>01161           $ret[$module][<span class="stringliteral">&#39;pending&#39;</span>][$update] = <span class="stringliteral">&quot;$update - $description&quot;</span>;
<a name="l01162"></a>01162           <span class="keywordflow">if</span> (!isset($ret[$module][<span class="stringliteral">&#39;start&#39;</span>])) {
<a name="l01163"></a>01163             $ret[$module][<span class="stringliteral">&#39;start&#39;</span>] = $update;
<a name="l01164"></a>01164           }
<a name="l01165"></a>01165         }
<a name="l01166"></a>01166       }
<a name="l01167"></a>01167       <span class="keywordflow">if</span> (!isset($ret[$module][<span class="stringliteral">&#39;start&#39;</span>]) &amp;&amp; isset($ret[$module][<span class="stringliteral">&#39;pending&#39;</span>])) {
<a name="l01168"></a>01168         $ret[$module][<span class="stringliteral">&#39;start&#39;</span>] = $schema_version;
<a name="l01169"></a>01169       }
<a name="l01170"></a>01170     }
<a name="l01171"></a>01171   }
<a name="l01172"></a>01172 
<a name="l01173"></a>01173   <span class="keywordflow">if</span> (empty($ret[<span class="stringliteral">&#39;system&#39;</span>])) {
<a name="l01174"></a>01174     unset($ret[<span class="stringliteral">&#39;system&#39;</span>]);
<a name="l01175"></a>01175   }
<a name="l01176"></a>01176   <span class="keywordflow">return</span> $ret;
<a name="l01177"></a>01177 }
<a name="l01178"></a>01178 
<a name="l01219"></a><a class="code" href="update_8inc_aa931d6cdddc2e9e0ec96d240523056e9.html#aa931d6cdddc2e9e0ec96d240523056e9">01219</a> <span class="keyword">function</span> <a class="code" href="update_8inc_aa931d6cdddc2e9e0ec96d240523056e9.html#aa931d6cdddc2e9e0ec96d240523056e9" title="Resolves dependencies in a set of module updates, and orders them correctly.">update_resolve_dependencies</a>($starting_updates) {
<a name="l01220"></a>01220   <span class="comment">// Obtain a dependency graph for the requested update functions.</span>
<a name="l01221"></a>01221   $update_functions = <a class="code" href="update_8inc_ad268e1662e1d06a85f3d51dfec9955b2.html#ad268e1662e1d06a85f3d51dfec9955b2" title="Returns an organized list of update functions for a set of modules.">update_get_update_function_list</a>($starting_updates);
<a name="l01222"></a>01222   $graph = <a class="code" href="update_8inc_aafca47c65645d8463d85a3fa7884c220.html#aafca47c65645d8463d85a3fa7884c220" title="Constructs a graph which encodes the dependencies between module updates.">update_build_dependency_graph</a>($update_functions);
<a name="l01223"></a>01223 
<a name="l01224"></a>01224   <span class="comment">// Perform the depth-first search and sort the results.</span>
<a name="l01225"></a>01225   require_once <a class="code" href="authorize_8php_a21cf187d162beffb1fbc5a1d1098f4f9.html#a21cf187d162beffb1fbc5a1d1098f4f9" title="Root directory of Drupal installation.">DRUPAL_ROOT</a> . <span class="stringliteral">&#39;/includes/graph.inc&#39;</span>;
<a name="l01226"></a>01226   <a class="code" href="graph_8inc_ab1e9257090d35212bd3dd3eba7706471.html#ab1e9257090d35212bd3dd3eba7706471" title="Performs a depth-first search and sort on a directed acyclic graph.">drupal_depth_first_search</a>($graph);
<a name="l01227"></a>01227   uasort($graph, <span class="stringliteral">&#39;drupal_sort_weight&#39;</span>);
<a name="l01228"></a>01228 
<a name="l01229"></a>01229   <span class="keywordflow">foreach</span> ($graph as $function =&gt; &amp;$data) {
<a name="l01230"></a>01230     $module = $data[<span class="stringliteral">&#39;module&#39;</span>];
<a name="l01231"></a>01231     $number = $data[<span class="stringliteral">&#39;number&#39;</span>];
<a name="l01232"></a>01232     <span class="comment">// If the update function is missing and has not yet been performed, mark</span>
<a name="l01233"></a>01233     <span class="comment">// it and everything that ultimately depends on it as disallowed.</span>
<a name="l01234"></a>01234     <span class="keywordflow">if</span> (<a class="code" href="update_8inc_ab41c0d635b6a220d269146f778a6a245.html#ab41c0d635b6a220d269146f778a6a245" title="Determines if a module update is missing or unavailable.">update_is_missing</a>($module, $number, $update_functions) &amp;&amp; !<a class="code" href="update_8inc_a6ccab16044efda416011fc20367d9344.html#a6ccab16044efda416011fc20367d9344" title="Determines if a module update has already been performed.">update_already_performed</a>($module, $number)) {
<a name="l01235"></a>01235       $data[<span class="stringliteral">&#39;allowed&#39;</span>] = FALSE;
<a name="l01236"></a>01236       <span class="keywordflow">foreach</span> (array_keys($data[<span class="stringliteral">&#39;paths&#39;</span>]) as $dependent) {
<a name="l01237"></a>01237         $graph[$dependent][<span class="stringliteral">&#39;allowed&#39;</span>] = FALSE;
<a name="l01238"></a>01238         $graph[$dependent][<span class="stringliteral">&#39;missing_dependencies&#39;</span>][] = $function;
<a name="l01239"></a>01239       }
<a name="l01240"></a>01240     }
<a name="l01241"></a>01241     elseif (!isset($data[<span class="stringliteral">&#39;allowed&#39;</span>])) {
<a name="l01242"></a>01242       $data[<span class="stringliteral">&#39;allowed&#39;</span>] = TRUE;
<a name="l01243"></a>01243       $data[<span class="stringliteral">&#39;missing_dependencies&#39;</span>] = array();
<a name="l01244"></a>01244     }
<a name="l01245"></a>01245     <span class="comment">// Now that we have finished processing this function, remove it from the</span>
<a name="l01246"></a>01246     <span class="comment">// graph if it was not part of the original list. This ensures that we</span>
<a name="l01247"></a>01247     <span class="comment">// never try to run any updates that were not specifically requested.</span>
<a name="l01248"></a>01248     <span class="keywordflow">if</span> (!isset($update_functions[$module][$number])) {
<a name="l01249"></a>01249       unset($graph[$function]);
<a name="l01250"></a>01250     }
<a name="l01251"></a>01251   }
<a name="l01252"></a>01252 
<a name="l01253"></a>01253   <span class="keywordflow">return</span> $graph;
<a name="l01254"></a>01254 }
<a name="l01255"></a>01255 
<a name="l01272"></a><a class="code" href="update_8inc_ad268e1662e1d06a85f3d51dfec9955b2.html#ad268e1662e1d06a85f3d51dfec9955b2">01272</a> <span class="keyword">function</span> <a class="code" href="update_8inc_ad268e1662e1d06a85f3d51dfec9955b2.html#ad268e1662e1d06a85f3d51dfec9955b2" title="Returns an organized list of update functions for a set of modules.">update_get_update_function_list</a>($starting_updates) {
<a name="l01273"></a>01273   <span class="comment">// Go through each module and find all updates that we need (including the</span>
<a name="l01274"></a>01274   <span class="comment">// first update that was requested and any updates that run after it).</span>
<a name="l01275"></a>01275   $update_functions = array();
<a name="l01276"></a>01276   <span class="keywordflow">foreach</span> ($starting_updates as $module =&gt; $version) {
<a name="l01277"></a>01277     $update_functions[$module] = array();
<a name="l01278"></a>01278     $updates = <a class="code" href="install_8inc_a1e68a61662f821bde8606568fda7bf58.html#a1e68a61662f821bde8606568fda7bf58" title="Returns an array of available schema versions for a module.">drupal_get_schema_versions</a>($module);
<a name="l01279"></a>01279     <span class="keywordflow">if</span> ($updates !== FALSE) {
<a name="l01280"></a>01280       $max_version = max($updates);
<a name="l01281"></a>01281       <span class="keywordflow">if</span> ($version &lt;= $max_version) {
<a name="l01282"></a>01282         <span class="keywordflow">foreach</span> ($updates as $update) {
<a name="l01283"></a>01283           <span class="keywordflow">if</span> ($update &gt;= $version) {
<a name="l01284"></a>01284             $update_functions[$module][$update] = $module . <span class="stringliteral">&#39;_update_&#39;</span> . $update;
<a name="l01285"></a>01285           }
<a name="l01286"></a>01286         }
<a name="l01287"></a>01287       }
<a name="l01288"></a>01288     }
<a name="l01289"></a>01289   }
<a name="l01290"></a>01290   <span class="keywordflow">return</span> $update_functions;
<a name="l01291"></a>01291 }
<a name="l01292"></a>01292 
<a name="l01335"></a><a class="code" href="update_8inc_aafca47c65645d8463d85a3fa7884c220.html#aafca47c65645d8463d85a3fa7884c220">01335</a> <span class="keyword">function</span> <a class="code" href="update_8inc_aafca47c65645d8463d85a3fa7884c220.html#aafca47c65645d8463d85a3fa7884c220" title="Constructs a graph which encodes the dependencies between module updates.">update_build_dependency_graph</a>($update_functions) {
<a name="l01336"></a>01336   <span class="comment">// Initialize an array that will define a directed graph representing the</span>
<a name="l01337"></a>01337   <span class="comment">// dependencies between update functions.</span>
<a name="l01338"></a>01338   $graph = array();
<a name="l01339"></a>01339 
<a name="l01340"></a>01340   <span class="comment">// Go through each update function and build an initial list of dependencies.</span>
<a name="l01341"></a>01341   <span class="keywordflow">foreach</span> ($update_functions as $module =&gt; $functions) {
<a name="l01342"></a>01342     $previous_function = NULL;
<a name="l01343"></a>01343     <span class="keywordflow">foreach</span> ($functions as $number =&gt; $function) {
<a name="l01344"></a>01344       <span class="comment">// Add an edge to the directed graph representing the fact that each</span>
<a name="l01345"></a>01345       <span class="comment">// update function in a given module must run after the update that</span>
<a name="l01346"></a>01346       <span class="comment">// numerically precedes it.</span>
<a name="l01347"></a>01347       <span class="keywordflow">if</span> ($previous_function) {
<a name="l01348"></a>01348         $graph[$previous_function][<span class="stringliteral">&#39;edges&#39;</span>][$function] = TRUE;
<a name="l01349"></a>01349       }
<a name="l01350"></a>01350       $previous_function = $function;
<a name="l01351"></a>01351 
<a name="l01352"></a>01352       <span class="comment">// Define the module and update number associated with this function.</span>
<a name="l01353"></a>01353       $graph[$function][<span class="stringliteral">&#39;module&#39;</span>] = $module;
<a name="l01354"></a>01354       $graph[$function][<span class="stringliteral">&#39;number&#39;</span>] = $number;
<a name="l01355"></a>01355     }
<a name="l01356"></a>01356   }
<a name="l01357"></a>01357 
<a name="l01358"></a>01358   <span class="comment">// Now add any explicit update dependencies declared by modules.</span>
<a name="l01359"></a>01359   $update_dependencies = <a class="code" href="update_8inc_af82e7fa9b13df713eb110a4e782b0e69.html#af82e7fa9b13df713eb110a4e782b0e69" title="Invoke hook_update_dependencies() in all installed modules.">update_retrieve_dependencies</a>();
<a name="l01360"></a>01360   <span class="keywordflow">foreach</span> ($graph as $function =&gt; $data) {
<a name="l01361"></a>01361     <span class="keywordflow">if</span> (!empty($update_dependencies[$data[<span class="stringliteral">&#39;module&#39;</span>]][$data[<span class="stringliteral">&#39;number&#39;</span>]])) {
<a name="l01362"></a>01362       <span class="keywordflow">foreach</span> ($update_dependencies[$data[<span class="stringliteral">&#39;module&#39;</span>]][$data[<span class="stringliteral">&#39;number&#39;</span>]] as $module =&gt; $number) {
<a name="l01363"></a>01363         $dependency = $module . <span class="stringliteral">&#39;_update_&#39;</span> . $number;
<a name="l01364"></a>01364         $graph[$dependency][<span class="stringliteral">&#39;edges&#39;</span>][$function] = TRUE;
<a name="l01365"></a>01365         $graph[$dependency][<span class="stringliteral">&#39;module&#39;</span>] = $module;
<a name="l01366"></a>01366         $graph[$dependency][<span class="stringliteral">&#39;number&#39;</span>] = $number;
<a name="l01367"></a>01367       }
<a name="l01368"></a>01368     }
<a name="l01369"></a>01369   }
<a name="l01370"></a>01370 
<a name="l01371"></a>01371   <span class="keywordflow">return</span> $graph;
<a name="l01372"></a>01372 }
<a name="l01373"></a>01373 
<a name="l01390"></a><a class="code" href="update_8inc_ab41c0d635b6a220d269146f778a6a245.html#ab41c0d635b6a220d269146f778a6a245">01390</a> <span class="keyword">function</span> <a class="code" href="update_8inc_ab41c0d635b6a220d269146f778a6a245.html#ab41c0d635b6a220d269146f778a6a245" title="Determines if a module update is missing or unavailable.">update_is_missing</a>($module, $number, $update_functions) {
<a name="l01391"></a>01391   <span class="keywordflow">return</span> !isset($update_functions[$module][$number]) || !function_exists($update_functions[$module][$number]);
<a name="l01392"></a>01392 }
<a name="l01393"></a>01393 
<a name="l01406"></a><a class="code" href="update_8inc_a6ccab16044efda416011fc20367d9344.html#a6ccab16044efda416011fc20367d9344">01406</a> <span class="keyword">function</span> <a class="code" href="update_8inc_a6ccab16044efda416011fc20367d9344.html#a6ccab16044efda416011fc20367d9344" title="Determines if a module update has already been performed.">update_already_performed</a>($module, $number) {
<a name="l01407"></a>01407   <span class="keywordflow">return</span> $number &lt;= <a class="code" href="install_8inc_a7702ece36adbef6e165e6f9c2bde5953.html#a7702ece36adbef6e165e6f9c2bde5953" title="Returns the currently installed schema version for a module.">drupal_get_installed_schema_version</a>($module);
<a name="l01408"></a>01408 }
<a name="l01409"></a>01409 
<a name="l01425"></a><a class="code" href="update_8inc_af82e7fa9b13df713eb110a4e782b0e69.html#af82e7fa9b13df713eb110a4e782b0e69">01425</a> <span class="keyword">function</span> <a class="code" href="update_8inc_af82e7fa9b13df713eb110a4e782b0e69.html#af82e7fa9b13df713eb110a4e782b0e69" title="Invoke hook_update_dependencies() in all installed modules.">update_retrieve_dependencies</a>() {
<a name="l01426"></a>01426   $return = array();
<a name="l01427"></a>01427   <span class="comment">// Get a list of installed modules, arranged so that we invoke their hooks in</span>
<a name="l01428"></a>01428   <span class="comment">// the same order that module_invoke_all() does.</span>
<a name="l01429"></a>01429   $modules = <a class="code" href="group__database_gafa3b6cb2b2f61479cc63a4150c62da9b.html#gafa3b6cb2b2f61479cc63a4150c62da9b" title="The following utility functions are simply convenience wrappers.">db_query</a>(<span class="stringliteral">&quot;SELECT name FROM {system} WHERE type = &#39;module&#39; AND schema_version &lt;&gt; :schema ORDER BY weight ASC, name ASC&quot;</span>, array(<span class="stringliteral">&#39;:schema&#39;</span> =&gt; <a class="code" href="install_8inc_ab2f11b038ed6a537bfdd257be863075f.html#ab2f11b038ed6a537bfdd257be863075f" title="Indicates that a module has not been installed yet.">SCHEMA_UNINSTALLED</a>))-&gt;fetchCol();
<a name="l01430"></a>01430   <span class="keywordflow">foreach</span> ($modules as $module) {
<a name="l01431"></a>01431     $function = $module . <span class="stringliteral">&#39;_update_dependencies&#39;</span>;
<a name="l01432"></a>01432     <span class="keywordflow">if</span> (function_exists($function)) {
<a name="l01433"></a>01433       $result = $function();
<a name="l01434"></a>01434       <span class="comment">// Each implementation of hook_update_dependencies() returns a</span>
<a name="l01435"></a>01435       <span class="comment">// multidimensional, associative array containing some keys that</span>
<a name="l01436"></a>01436       <span class="comment">// represent module names (which are strings) and other keys that</span>
<a name="l01437"></a>01437       <span class="comment">// represent update function numbers (which are integers). We cannot use</span>
<a name="l01438"></a>01438       <span class="comment">// array_merge_recursive() to properly merge these results, since it</span>
<a name="l01439"></a>01439       <span class="comment">// treats strings and integers differently. Therefore, we have to</span>
<a name="l01440"></a>01440       <span class="comment">// explicitly loop through the expected array structure here and perform</span>
<a name="l01441"></a>01441       <span class="comment">// the merge manually.</span>
<a name="l01442"></a>01442       <span class="keywordflow">if</span> (isset($result) &amp;&amp; is_array($result)) {
<a name="l01443"></a>01443         <span class="keywordflow">foreach</span> ($result as $module =&gt; $module_data) {
<a name="l01444"></a>01444           <span class="keywordflow">foreach</span> ($module_data as $update =&gt; $update_data) {
<a name="l01445"></a>01445             <span class="keywordflow">foreach</span> ($update_data as $module_dependency =&gt; $update_dependency) {
<a name="l01446"></a>01446               <span class="comment">// If there are redundant dependencies declared for the same</span>
<a name="l01447"></a>01447               <span class="comment">// update function (so that it is declared to depend on more than</span>
<a name="l01448"></a>01448               <span class="comment">// one update from a particular module), record the dependency on</span>
<a name="l01449"></a>01449               <span class="comment">// the highest numbered update here, since that automatically</span>
<a name="l01450"></a>01450               <span class="comment">// implies the previous ones. For example, if one module&#39;s</span>
<a name="l01451"></a>01451               <span class="comment">// implementation of hook_update_dependencies() required this</span>
<a name="l01452"></a>01452               <span class="comment">// ordering:</span>
<a name="l01453"></a>01453               <span class="comment">//</span>
<a name="l01454"></a>01454               <span class="comment">// system_update_7001 ---&gt; user_update_7000</span>
<a name="l01455"></a>01455               <span class="comment">//</span>
<a name="l01456"></a>01456               <span class="comment">// but another module&#39;s implementation of the hook required this</span>
<a name="l01457"></a>01457               <span class="comment">// one:</span>
<a name="l01458"></a>01458               <span class="comment">//</span>
<a name="l01459"></a>01459               <span class="comment">// system_update_7002 ---&gt; user_update_7000</span>
<a name="l01460"></a>01460               <span class="comment">//</span>
<a name="l01461"></a>01461               <span class="comment">// we record the second one, since system_update_7001() is always</span>
<a name="l01462"></a>01462               <span class="comment">// guaranteed to run before system_update_7002() anyway (within</span>
<a name="l01463"></a>01463               <span class="comment">// an individual module, updates are always run in numerical</span>
<a name="l01464"></a>01464               <span class="comment">// order).</span>
<a name="l01465"></a>01465               <span class="keywordflow">if</span> (!isset($return[$module][$update][$module_dependency]) || $update_dependency &gt; $return[$module][$update][$module_dependency]) {
<a name="l01466"></a>01466                 $return[$module][$update][$module_dependency] = $update_dependency;
<a name="l01467"></a>01467               }
<a name="l01468"></a>01468             }
<a name="l01469"></a>01469           }
<a name="l01470"></a>01470         }
<a name="l01471"></a>01471       }
<a name="l01472"></a>01472     }
<a name="l01473"></a>01473   }
<a name="l01474"></a>01474 
<a name="l01475"></a>01475   <span class="keywordflow">return</span> $return;
<a name="l01476"></a>01476 }
<a name="l01477"></a>01477 
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Thu Nov 22 2012 16:46:14 for Shopcart by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
